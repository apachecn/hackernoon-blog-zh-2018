<html>
<head>
<title>Securing your network connections using OpenVPN</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用OpenVPN保护您的网络连接</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/securing-your-network-connections-using-openvpn-a7ba22dc443e?source=collection_archive---------5-----------------------#2018-01-03">https://medium.com/hackernoon/securing-your-network-connections-using-openvpn-a7ba22dc443e?source=collection_archive---------5-----------------------#2018-01-03</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="1f89" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">本文摘自我的曼宁书第十章，</em> <a class="ae jq" href="https://www.manning.com/books/linux-in-action?a_aid=bootstrap-it&amp;a_bid=4ca15fc9" rel="noopener ugc nofollow" target="_blank"> <em class="jp"> Linux在行动</em> </a> <em class="jp">。除了这本书，你还可以通过</em> <a class="ae jq" href="https://www.manning.com/livevideo/linux-in-motion?a_aid=bootstrap-it&amp;a_bid=0c56986f&amp;chan=motion1" rel="noopener ugc nofollow" target="_blank"> <em class="jp">学习Linux in Motion</em></a><em class="jp">——这是一门混合课程，由两个多小时的视频和大约40%的Linux in Action文本组成。</em></p><p id="1cb4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">他们告诉我们，我们生活在一个超移动的世界。我不知道:我很少离开我的家庭办公室。但是当然，我只能享受家庭办公室的舒适，因为我可能需要的所有服务器资源都可以远程获得。</p><p id="b7b5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">显然我不是一个人。几乎每个工作涉及IT的人都会不时地从远程位置访问他们的专业工具。鉴于您访问这些远程位置所通过的公共网络本质上是不安全的，您将需要小心控制这些连接。</p><p id="548c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">网站加密是为了确保您的远程客户端使用的数据能够可靠地传输，并且不会被潜伏在连接网络上的任何人看到。与此形成鲜明对比的是，VPN侧重于确保远程客户端使用的数据能够可靠地传输，并且不会被潜伏在连接网络上的任何人看到。你看出区别了吗？我也不知道。</p><p id="9bfc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">事实上，有各种各样的技术致力于保护网络通信，深度防御的原则告诉我们，你不应该只依赖一种技术。在这里，您将了解如何为您的远程活动添加新的保护层。具体来说，使用加密来构建虚拟专用网络(VPN)隧道，以允许安全和不可见的远程连接。</p><h2 id="8b1e" class="jr js hu bd jt ju jv jw jx jy jz ka kb jc kc kd ke jg kf kg kh jk ki kj kk kl dt translated">构建OpenVPN隧道</h2><p id="7520" class="pw-post-body-paragraph ir is hu it b iu km iw ix iy kn ja jb jc ko je jf jg kp ji jj jk kq jm jn jo hn dt translated">我的<a class="ae jq" href="https://www.manning.com/books/linux-in-action?a_aid=bootstrap-it&amp;a_bid=4ca15fc9" rel="noopener ugc nofollow" target="_blank"> Linux in Action book </a>讲了很多关于加密的内容。SSH和SCP可以保护通过远程连接传输的数据(第3章)，文件加密可以保护静态数据(第8章)，TLS/SSL证书可以保护在网站和客户端浏览器之间传输的数据(第9章)。但是有时您的需求要求保护更广泛的连接，因为有时您有不同种类的工作要做。</p><p id="f850" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">F'rinstance？您团队中的一些成员需要在路上使用公共WiFi热点工作。假设随机的WiFi接入点是安全的，这肯定是不明智的，但您的员工确实需要一种连接公司资源的方法。虚拟专用网拯救世界。</p><p id="5819" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正确设计的VPN隧道可以在远程客户端和服务器之间提供直接连接，在不安全的网络中传输数据时隐藏数据。但那又怎样？您已经看到了许多使用加密实现这一功能的工具。VPN的真正价值在于，一旦你打开了隧道，就有可能连接远程网络，就好像它们都在本地一样。在某种程度上，你在避开那个危险的咖啡店热点。</p><p id="d032" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用这样一个扩展的网络，管理员可以在他们的服务器上完成他们的工作，无论他们可能碰巧在哪里。但更重要的是，正如您在图中所看到的，一个资源分布在多个分支机构的公司可以让所有需要它们的团队都可以看到和访问它们……无论他们在哪里。</p><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="fe ff kr"><img src="../Images/728104657acba8540c5ba720887d13c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G4AiguIz4CU9i4Kzk0yz8w.png"/></div></div><figcaption class="ld le fg fe ff lf lg bd b be z ek">Tunnel connecting remote private connections through a public network</figcaption></figure><p id="62cc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">仅仅是隧道的存在并不能保证安全。但是许多加密标准中的一个可以被整合到设计中，使事情变得更好。使用开源OpenVPN包构建的隧道使用了您已经在其他地方看到的相同的TLS/SSL加密。OpenVPN不是隧道传输的唯一选择，但它是最著名的选择之一，它被广泛认为比使用IPsec加密的第二层隧道协议更快，也更安全。</p><p id="d2ed" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了让您的团队能够在旅途中或多个校园之间安全地相互连接，您将构建一个OpenVPN服务器，以允许共享应用程序和访问服务器的本地网络环境。要使其工作，启动两个虚拟机或容器就足够了。一个扮演服务器/主机的角色，另一个扮演客户端的角色。</p><p id="eed3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">建立一个VPN需要很多步骤，所以花一些时间来思考一下它是如何工作的大概是值得的。</p><h2 id="8c67" class="jr js hu bd jt ju jv jw jx jy jz ka kb jc kc kd ke jg kf kg kh jk ki kj kk kl dt translated">配置OpenVPN服务器</h2><p id="6bb0" class="pw-post-body-paragraph ir is hu it b iu km iw ix iy kn ja jb jc ko je jf jg kp ji jj jk kq jm jn jo hn dt translated">在开始之前，这里有一个有用的提示。如果您打算自己完成这个过程——我强烈建议您这样做——您可能会发现自己在桌面上打开了多个终端窗口，每个窗口都登录到不同的机器。请相信我:在某些时候，您会在错误的窗口中输入命令，从而完全搞乱您的环境。</p><p id="e694" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以使用hostname命令将命令行上显示的计算机名称更改为可以直观地提醒您所处位置的名称。完成后，您需要退出服务器并再次登录以使新设置生效。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="aa56" class="jr js hu li b fv lm ln l lo lp">ubuntu@ubuntu:~# hostname OpenVPN-Server<br/>ubuntu@ubuntu:~$ exit <br/>&lt;Host Workstation&gt;$ ssh ubuntu@10.0.3.134<br/>ubuntu@OpenVPN-Server:~# </span></pre><p id="18ec" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">按照这种方法为您正在使用的每台机器分配适当的名称，应该有助于您跟踪您的位置。</p><h2 id="1532" class="jr js hu bd jt ju jv jw jx jy jz ka kb jc kc kd ke jg kf kg kh jk ki kj kk kl dt translated">为OpenVPN准备您的服务器</h2><p id="f964" class="pw-post-body-paragraph ir is hu it b iu km iw ix iy kn ja jb jc ko je jf jg kp ji jj jk kq jm jn jo hn dt translated">在您的服务器上安装openvpn需要两个包:OpenVPN和管理加密密钥生成过程的easy-rsa。如有必要，CentOS用户应该首先按照第2章中的方法安装epel-release存储库。为了提供一种简单的方法来测试对服务器应用程序的访问，您还可以安装Apache web server(Apache 2 for Ubuntu and httpd on CentOS)。</p><p id="4118" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当你设置你的服务器时，你最好做正确的事情，激活一个防火墙来阻止除了22 (SSH)和1194(默认的OpenVPN端口)之外的所有端口。这个例子说明了在Ubuntu的ufw上的工作方式，但是我相信你还记得第九章CentOS的firewalld。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="258e" class="jr js hu li b fv lm ln l lo lp"># ufw enable<br/># ufw allow 22<br/># ufw allow 1194</span></pre><p id="6187" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要允许服务器上网络接口之间的内部路由，您需要在/etc/sysctl.conf文件中取消对单行(net.ipv4.ip_forward=1)的注释。这将允许远程客户端在连接后根据需要进行重定向。要加载新设置，请运行sysctl -p。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="9b18" class="jr js hu li b fv lm ln l lo lp"># nano /etc/sysctl.conf<br/># sysctl -p</span></pre><p id="fd24" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">服务器环境现在已经设置好了，但是在您准备好打开开关之前还有一段路要走。</p><h2 id="0401" class="jr js hu bd jt ju jv jw jx jy jz ka kb jc kc kd ke jg kf kg kh jk ki kj kk kl dt translated">生成加密密钥</h2><p id="08cf" class="pw-post-body-paragraph ir is hu it b iu km iw ix iy kn ja jb jc ko je jf jg kp ji jj jk kq jm jn jo hn dt translated">当你安装OpenVPN时，会自动创建一个/etc/openvpn/目录，但是现在还没有全部完成。然而，openvpn和easy-rsa包都附带了样本模板文件，您可以将其用作配置的基础。要启动认证过程，请将easy-rsa模板目录从/usr/share/复制到/etc/openvpn/中，然后切换到新的easy-rsa/目录。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="4c48" class="jr js hu li b fv lm ln l lo lp"># cp -r /usr/share/easy-rsa/ /etc/openvpn<br/>$ cd /etc/openvpn/easy-rsa</span></pre><p id="eee0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您将使用的第一个文件简单地称为vars，它包含easy-rsa在生成其密钥时将使用的环境变量。您将需要编辑该文件，用您自己的值替换已经存在的示例默认值。下面是我的文件的样子:</p><p id="8e85" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">/etc/openvpn/easy-rsa/vars文件的关键摘录:</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="734a" class="jr js hu li b fv lm ln l lo lp">export KEY_COUNTRY=”CA”<br/>export KEY_PROVINCE=”ON”<br/>export KEY_CITY=”Toronto”<br/>export KEY_ORG=”Bootstrap IT”<br/>export KEY_EMAIL=”<a class="ae jq" href="mailto:info@bootstrap-it.com" rel="noopener ugc nofollow" target="_blank">info@bootstrap-it.com</a>”<br/>export KEY_OU=”IT”</span></pre><p id="ee57" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行vars文件将把它的值传递给shell环境，在那里它们将被合并到新键的内容中。完成后，该脚本将鼓励您运行clean-all脚本来删除/etc/openvpn/easy-rsa/keys/目录中的任何现有内容。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="a96c" class="jr js hu li b fv lm ln l lo lp">$ cd /etc/openvpn/easy-rsa/<br/># . ./vars <br/>NOTE: If you run ./clean-all, I will be doing a rm -rf on /etc/openvpn/easy-rsa/keys</span></pre><p id="f93a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">很自然，您的下一步将是运行clean-all脚本…然后是build-ca，它将使用pkitool脚本来创建您的根证书。您将被要求确认var提供的识别设置。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="fa45" class="jr js hu li b fv lm ln l lo lp"># ./clean-all<br/># ./build-ca<br/>Generating a 2048 bit RSA private key</span></pre><p id="f01d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，build-key-server脚本将询问您相同的确认问题来生成密钥对，因为它使用相同的pkitool脚本和新的根证书。这些键将根据您传递的参数来命名，除非您在这台机器上运行多个VPN，否则通常是server，如本例所示。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="a87f" class="jr js hu li b fv lm ln l lo lp"># ./build-key-server server<br/>[…]<br/>Certificate is to be certified until Aug 15 23:52:34 2027 GMT (3650 days)<br/>Sign the certificate? [y/n]:y<br/>1 out of 1 certificate requests certified, commit? [y/n]y<br/>Write out database with 1 new entries<br/>Data Base Updated</span></pre><p id="3f97" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">OpenVPN将使用Diffie-Hellman算法(通过运行build-dh)生成的参数来协商新连接的身份验证。这里将要创建的文件不需要保密，但必须是使用build-dh脚本针对当前活动的RSA密钥生成的。如果您将来创建新的RSA密钥，您还需要更新Diffie-Hellman文件。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="b10e" class="jr js hu li b fv lm ln l lo lp"># build-dh</span></pre><p id="4705" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您的服务器端密钥现在将被写入/etc/openvpn/easy-rsa/keys/目录，但是openvpn不知道这一点。默认情况下，OpenVPN会在/etc/openvpn/中查找它们，所以复制它们。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="eb26" class="jr js hu li b fv lm ln l lo lp"># cp /etc/openvpn/easy-rsa/keys/server* /etc/openvpn<br/># cp /etc/openvpn/easy-rsa/keys/dh2048.pem /etc/openvpn<br/># cp /etc/openvpn/easy-rsa/keys/ca.crt /etc/openvpn</span></pre><h2 id="81a8" class="jr js hu bd jt ju jv jw jx jy jz ka kb jc kc kd ke jg kf kg kh jk ki kj kk kl dt translated">准备客户端加密密钥</h2><p id="6a5d" class="pw-post-body-paragraph ir is hu it b iu km iw ix iy kn ja jb jc ko je jf jg kp ji jj jk kq jm jn jo hn dt translated">正如您已经看到的，TLS加密使用匹配的密钥对，一个安装在服务器上，另一个安装在远程客户端上。这意味着您将需要客户端密钥，而我们的老朋友pkitool正好可以做一些。这个示例仍然在/etc/openvpn/easy-rsa/目录中运行，它将client作为参数传递，以生成名为client.crt和client.key的文件。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="ba4a" class="jr js hu li b fv lm ln l lo lp"># ./pkitool client</span></pre><p id="a686" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这两个客户机文件，以及仍然在keys/目录中的原始ca.crt文件，现在必须安全地传输到您的客户机。由于他们的所有权和权限，这可能有点复杂。最简单的方法是在PC桌面上运行的终端中手动复制源文件的内容(只复制这些内容)(突出显示文本，右键单击文本，然后从菜单中选择复制)，然后将其粘贴到在登录到客户端的第二个终端中创建的同名新文件中。</p><p id="0e6f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是任何人都可以剪切和粘贴。相反，要像管理员一样思考——特别是因为你并不总是能够访问可以剪切和粘贴的GUI。相反，将文件复制到用户的主目录(以便远程scp操作可以访问它们),然后使用chown将文件的所有权从超级用户更改为普通的非超级用户，以便远程scp操作可以工作。确保你的文件现在都已经整理好了，并且很舒适…稍后你会把它们移到客户那里。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="5272" class="jr js hu li b fv lm ln l lo lp"># cp /etc/openvpn/easy-rsa/keys/client.key /home/ubuntu/<br/># cp /etc/openvpn/easy-rsa/keys/ca.crt /home/ubuntu/<br/># cp /etc/openvpn/easy-rsa/keys/client.crt /home/ubuntu/<br/># chown ubuntu:ubuntu /home/ubuntu/client.key<br/># chown ubuntu:ubuntu /home/ubuntu/client.crt<br/># chown ubuntu:ubuntu /home/ubuntu/ca.crt</span></pre><p id="3bce" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">准备好全套加密密钥后，您需要告诉您的服务器您想要如何构建VPN。这是使用server.conf文件完成的。</p><h2 id="8262" class="jr js hu bd jt ju jv jw jx jy jz ka kb jc kc kd ke jg kf kg kh jk ki kj kk kl dt translated">配置server.conf文件</h2><p id="06f1" class="pw-post-body-paragraph ir is hu it b iu km iw ix iy kn ja jb jc ko je jf jg kp ji jj jk kq jm jn jo hn dt translated">您怎么知道server.conf文件应该是什么样子的呢？嗯，还记得您从/usr/share/复制的easy-rsa目录模板吗？嗯，有更多的好东西从那里来。OpenVPN安装留下了一个压缩的模板配置文件，您可以将它复制到/etc/openvpn/中。</p><p id="7cb0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将利用模板被压缩的事实向您介绍一个有用的工具:zcat。您已经知道如何用cat将文件的文本内容打印到屏幕上，但是如果文件是用gzip压缩的呢？当然，您总是可以解压缩文件，然后cat会很乐意打印它，但是这需要一两步。相反，正如您可能已经猜到的那样，您可以使用zcat将解压缩后的文本一次性加载到内存中。在我们的例子中，不是将它打印到屏幕上，而是将文本重定向到一个名为server.conf的新文件中。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="041a" class="jr js hu li b fv lm ln l lo lp"># zcat \<br/> /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz<br/> &gt; /etc/openvpn/server.conf<br/>$ cd /etc/openvpn</span></pre><p id="1d28" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">抛开文件附带的大量有用的文档，下面是完成编辑后的样子。注意，分号(；)告诉OpenVPN _not_读取并执行后面的行。</p><p id="2223" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">/etc/openvpn/server.conf文件中的活动设置:</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="64e2" class="jr js hu li b fv lm ln l lo lp"><br/>port 1194<br/># TCP or UDP server?<br/>proto tcp<br/>;proto udp<br/>;dev tap<br/>dev tun<br/>ca ca.crt<br/>cert server.crt<br/>key server.key # This file should be kept secret<br/>dh dh2048.pem<br/>server 10.8.0.0 255.255.255.0<br/>ifconfig-pool-persist ipp.txt<br/>push “route 10.0.3.0 255.255.255.0”<br/>keepalive 10 120<br/>comp-lzo<br/>port-share localhost 80 <br/>user nobody <br/>group nogroup<br/>persist-key<br/>persist-tun<br/>status openvpn-status.log<br/>log openvpn.log <br/>;log-append openvpn.log<br/>verb 3 </span></pre><p id="48d8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们一次解决其中的一些问题。</p><ul class=""><li id="12fa" class="lq lr hu it b iu iv iy iz jc ls jg lt jk lu jo lv lw lx ly dt translated">默认情况下，OpenVPN通过端口1194工作。你可以改变这一点——也许是为了进一步模糊你的活动，或者避免与其他活动隧道的冲突。但是，因为它要求客户端之间的协调最少，所以1194通常是您的最佳选择。</li><li id="16c9" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">OpenVPN可以使用传输控制协议(TCP)或用户数据报协议(UDP)进行数据传输。TCP可能会慢一点，但它更可靠，更容易与运行在隧道两端的应用程序相处。</li><li id="3206" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">当您想要创建一个更简单、更高效的IP隧道来传输数据内容而不是其他内容时，您可以指定dev tun。另一方面，如果您需要通过创建一个以太网桥来连接多个网络接口(以及它们所代表的网络),那么您必须选择dev tap。如果你不知道这是什么意思，就去找tun。</li><li id="f0b4" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">接下来的四行向OpenVPN传递您之前创建的三个服务器认证文件和dh2048参数文件的名称。</li><li id="9465" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">服务器线路设置子网范围和网络掩码，当客户端登录时，将使用这些子网范围和网络掩码为客户端分配IP地址。</li><li id="231f" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">可选的推送“路由10.0.3.0 255.255.255.0”设置将允许远程客户端访问服务器“后面”的私有子网。要做到这一点，还需要对服务器本身进行网络配置，以确保私有子网知道OpenVPN子网(10.8.0.0)。</li><li id="8022" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">端口共享localhost 80允许从端口1194进入的客户端流量被重新路由到侦听端口80的本地web服务器。这在我们的例子中很有用，因为我们将使用一个web服务器来测试我们的VPN。这仅在proto设置为tcp时有效。</li><li id="52fb" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">应该通过删除分号来启用用户nobody和组nogroup行。强制远程客户端以nobody和nogroup的身份工作可以确保它们在服务器上的会话没有特权。</li><li id="059f" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">log将当前日志条目设置为每次OpenVPN启动时覆盖旧条目，而log-append将新条目追加到现有日志文件中。openvpn.log本身将被写入/etc/openvpn/目录。</li></ul><p id="711a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，将客户端到客户端添加到配置文件中也是非常常见的，这样除了OpenVPN服务器之外，多个客户端将能够看到彼此。</p><p id="dbea" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦您对自己的配置感到满意，就可以启动OpenVPN服务器了。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="6fa3" class="jr js hu li b fv lm ln l lo lp"># systemctl start openvpn</span></pre><p id="def1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行ip addr来列出您的服务器的网络接口，现在应该包括对名为tun0的新接口的引用。这将由OpenVPN创建，供传入客户端使用。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="2283" class="jr js hu li b fv lm ln l lo lp">$ ip addr<br/>[…]<br/>4: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc […]<br/> link/none <br/> inet 10.8.0.1 peer 10.8.0.2/32 scope global tun0<br/> valid_lft forever preferred_lft forever</span></pre><p id="54c7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可能需要重新启动服务器，然后一切才能正常运行。下一站:客户端计算机。</p><h2 id="353f" class="jr js hu bd jt ju jv jw jx jy jz ka kb jc kc kd ke jg kf kg kh jk ki kj kk kl dt translated">配置OpenVPN客户端</h2><p id="38c3" class="pw-post-body-paragraph ir is hu it b iu km iw ix iy kn ja jb jc ko je jf jg kp ji jj jk kq jm jn jo hn dt translated">传统上，隧道至少有两端(否则我们更喜欢称之为洞穴)。在服务器上正确配置OpenVPN可以引导流量在该端进出隧道。但是你也需要一些运行在客户端的软件。</p><blockquote class="me mf mg"><p id="4d9b" class="ir is jp it b iu iv iw ix iy iz ja jb mh jd je jf mi jh ji jj mj jl jm jn jo hn dt translated">在这一节中，我将重点介绍如何手动配置一台Linux计算机作为OpenVPN客户端。但这并不是您想要使用服务的唯一方式。OpenVPN本身维护可以在Windows或Mac台式机/笔记本电脑，或者Android和iOS智能手机和平板电脑上安装和使用的客户端应用程序。详情见<a class="ae jq" href="https://openvpn.net" rel="noopener ugc nofollow" target="_blank">https://openvpn.net</a>网站。</p></blockquote><p id="4168" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">OpenVPN包需要安装在客户机上，就像它安装在服务器上一样——尽管这里不需要easy-rsa，因为您将使用的密钥已经存在。您需要将client.conf模板文件复制到安装刚刚创建的/etc/openvpn/目录中。这一次，由于某种原因，文件不会被压缩，所以一个普通的cp就可以很好地完成这项工作。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="7183" class="jr js hu li b fv lm ln l lo lp"># apt install openvpn<br/># cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf \<br/> /etc/openvpn/</span></pre><p id="3cbe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">client.conf文件中的大多数设置非常明显:它们需要与服务器使用的值相匹配。正如您在下面的示例文件中看到的，一个独特的地址是remote 192.168.1.23 1194，它将客户端指向服务器的IP地址。同样，确保您使用您的服务器的实际地址。您还应该强制您的客户端验证服务器证书的真实性，以防止可能的中间人攻击。一种方法是添加remote-cert-tls服务器行。</p><p id="f237" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">VPN客户端的/etc/openvpn/client.conf文件中的活动设置:</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="5869" class="jr js hu li b fv lm ln l lo lp">client <br/>;dev tap<br/>dev tun<br/>proto tcp<br/>remote 192.168.1.23 1194 <br/>resolv-retry infinite<br/>nobind<br/>user nobody<br/>group nogroup<br/>persist-key<br/>persist-tun<br/>ca ca.crt<br/>cert client.crt<br/>key client.key<br/>comp-lzo<br/>verb 3<br/>remote-cert-tls server </span></pre><p id="135d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，您可以移动到/etc/openvpn/目录，并从服务器获取这些认证密钥。显然，您将使用服务器的实际IP地址或域名来代替示例中的地址或域名。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="7361" class="jr js hu li b fv lm ln l lo lp">$ cd /etc/openvpn<br/># scp ubuntu@192.168.1.23:/home/ubuntu/ca.crt . <br/># scp ubuntu@192.168.1.23:/home/ubuntu/client.crt .<br/># scp ubuntu@192.168.1.23:/home/ubuntu/client.key .</span></pre><p id="d7a0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在客户机上启动OpenVPN之前，不会有什么令人兴奋的事情发生。因为您需要传递几个参数，所以您将从命令行触发。— tls-client告诉OpenVPN，当— config指向您的配置文件时，您将充当客户端并通过tls加密进行连接。</p><pre class="ks kt ku kv fq lh li lj lk aw ll dt"><span id="10be" class="jr js hu li b fv lm ln l lo lp"># openvpn — tls-client — config /etc/openvpn/client.conf</span></pre><p id="9ef8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">仔细阅读命令输出，确保连接正确。如果第一次出现问题，可能是由于服务器和客户机配置文件之间的设置不匹配，或者可能是网络连接/防火墙问题。以下是一些故障排除步骤:</p><ul class=""><li id="82f6" class="lq lr hu it b iu iv iy iz jc ls jg lt jk lu jo lv lw lx ly dt translated">仔细阅读客户机上OpenVPN操作的输出——它通常会包含有价值的提示，告诉你它不能做什么以及为什么不能做。</li><li id="36b0" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">检查服务器上/etc/openvpn/目录下的openvpn.log和openvpn-status.log文件中是否有与错误相关的消息。</li><li id="8004" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">在服务器和客户端的系统日志中检查OpenVPN相关的和及时的消息(journalctl -ce将打印出满屏的最新条目)。</li><li id="6f57" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">确认你在服务器和客户端之间有一个活动的网络连接(详见第14章)。</li></ul><p id="20de" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">本文摘自我的</em> <a class="ae jq" href="https://www.manning.com/books/linux-in-action?a_aid=bootstrap-it&amp;a_bid=4ca15fc9" rel="noopener ugc nofollow" target="_blank"> <em class="jp">曼宁《Linux在行动》一书</em> </a> <em class="jp">。还有更多有趣的东西</em> <a class="ae jq" href="https://bootstrap-it.com/index.php/books/" rel="noopener ugc nofollow" target="_blank"> <em class="jp">这来自</em> </a> <em class="jp">，</em>包括一个叫做<a class="ae jq" href="https://www.manning.com/livevideo/linux-in-motion?a_aid=bootstrap-it&amp;a_bid=0c56986f&amp;chan=motion1" rel="noopener ugc nofollow" target="_blank"> Linux in Motion </a>的混合课程，它由两个多小时的视频和大约40%的Linux in Action文本组成。<em class="jp">谁知道呢……你可能也会喜欢我的</em> <a class="ae jq" href="https://www.manning.com/books/learn-amazon-web-services-in-a-month-of-lunches?a_aid=bootstrap-it&amp;amp;a_bid=1c1b5e27" rel="noopener ugc nofollow" target="_blank"> <em class="jp">在一个月的午餐中学习亚马逊网络服务</em> </a> <em class="jp">。</em></p></div></div>    
</body>
</html>