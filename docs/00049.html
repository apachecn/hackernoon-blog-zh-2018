<html>
<head>
<title>Do As I Say, Not As I Do: Get Your EC2 Instance Name Without Breaking Your Infrastructure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">照我说的做，不要照我做的做:在不破坏基础设施的情况下获得EC2实例名</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/do-as-i-say-not-as-i-do-get-your-ec2-instance-name-without-breaking-your-infrastructure-1da4a0963af0?source=collection_archive---------9-----------------------#2018-01-03">https://medium.com/hackernoon/do-as-i-say-not-as-i-do-get-your-ec2-instance-name-without-breaking-your-infrastructure-1da4a0963af0?source=collection_archive---------9-----------------------#2018-01-03</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div class="fe ff hs"><img src="../Images/575421441f509a32a5f34152ae6b7473.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*7zbh4xoxgD8UneyVo65UOg.jpeg"/></div></figure><div class=""/><div class=""><h2 id="e688" class="pw-subtitle-paragraph iy ia ib bd b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp ek translated">包含Python代码片段的分步指南</h2></div><p id="bcd8" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">我第一次尝试将EC2实例名记录到<a class="ae km" href="http://pagerduty.com" rel="noopener ugc nofollow" target="_blank">page duty</a>和<a class="ae km" href="http://airbrake.io" rel="noopener ugc nofollow" target="_blank"> Airbrake </a>时，破坏了我们的大部分基础设施。我没有考虑到未发布的AWS速率限制，当意外的大量错误导致我的代码达到这些速率限制时，当错误在我们的异常记录器中抛出时，不充分的错误处理导致了无限循环。</p><p id="c1f4" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">我希望这个教程可以让你少一些我的头疼。我将带您了解如何使用<code class="eh kn ko kp kq b">boto3</code> Python客户端从EC2实例中访问正在运行的EC2实例的名称，在此过程中，我将包括一些警告和陷阱，帮助您避免我犯的一些错误。</p><h1 id="6d3c" class="kr ks ib bd kt ku kv kw kx ky kz la lb jh lc ji ld jk le jl lf jn lg jo lh li dt translated">先决条件</h1><ul class=""><li id="5b20" class="lj lk ib js b jt ll jw lm jz ln kd lo kh lp kl lq lr ls lt dt translated"><a class="ae km" href="http://boto3.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> Boto3 </a>。本教程假设您熟悉使用AWS的boto3 Python客户端，并且您已经按照AWS的说明配置了您的AWS凭证。</li><li id="f82b" class="lj lk ib js b jt lu jw lv jz lw kd lx kh ly kl lq lr ls lt dt translated"><a class="ae km" href="http://docs.python-requests.org/en/master/" rel="noopener ugc nofollow" target="_blank">请求</a>，一个Python HTTP库。</li></ul><h1 id="a911" class="kr ks ib bd kt ku kv kw kx ky kz la lb jh lc ji ld jk le jl lf jn lg jo lh li dt translated">获取实例Id和区域</h1><p id="3100" class="pw-post-body-paragraph jq jr ib js b jt ll jc jv jw lm jf jy jz lz kb kc kd ma kf kg kh mb kj kk kl hn dt translated">关于实例的大部分信息可以通过<a class="ae km" href="http://boto3.readthedocs.io/en/latest/reference/services/ec2.html#instance" rel="noopener ugc nofollow" target="_blank"> boto3实例资源</a>获得。为了创建资源，我们首先需要检索实例id和实例区域。</p><p id="c6ba" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">AWS通过url <code class="eh kn ko kp kq b">http://169.254.169.254</code>提供<a class="ae km" href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html" rel="noopener ugc nofollow" target="_blank">实例元数据和用户数据</a>，您可以从任何正在运行的EC2实例请求这些数据。我们尤其对<a class="ae km" href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-identity-documents.html" rel="noopener ugc nofollow" target="_blank">实例身份文档</a>感兴趣，该文档可在<code class="eh kn ko kp kq b">http://169.254.169.254/latest/dynamic/instance-identity/document</code>获得。</p><pre class="mc md me mf fq mg kq mh mi aw mj dt"><span id="dd53" class="mk ks ib kq b fv ml mm l mn mo">import requests</span><span id="df3e" class="mk ks ib kq b fv mp mm l mn mo">r = requests.get("http://169.254.169.254/latest/dynamic/instance-identity/document")<br/>response_json = r.json()<br/>region = response_json.get('region')<br/>instance_id = response_json.get('instanceId')</span></pre><p id="7393" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">如果您不熟悉<code class="eh kn ko kp kq b">requests</code>库，我建议您查看<a class="ae km" href="http://docs.python-requests.org/en/master/user/quickstart/#response-status-codes" rel="noopener ugc nofollow" target="_blank">响应状态代码</a>，尤其是<code class="eh kn ko kp kq b">raise_for_status</code>函数，作为错误处理的起点。</p><h1 id="9427" class="kr ks ib bd kt ku kv kw kx ky kz la lb jh lc ji ld jk le jl lf jn lg jo lh li dt translated">获取实例资源</h1><p id="7893" class="pw-post-body-paragraph jq jr ib js b jt ll jc jv jw lm jf jy jz lz kb kc kd ma kf kg kh mb kj kk kl hn dt translated">然后我们可以使用实例id和区域来检索<a class="ae km" href="http://boto3.readthedocs.io/en/latest/reference/services/ec2.html#instance" rel="noopener ugc nofollow" target="_blank"> boto3实例资源</a>。</p><pre class="mc md me mf fq mg kq mh mi aw mj dt"><span id="ba74" class="mk ks ib kq b fv ml mm l mn mo">import boto3</span><span id="7dfe" class="mk ks ib kq b fv mp mm l mn mo">ec2 = boto3.resource('ec2', region_name=region)<br/>instance = ec2.Instance(instance_id)</span></pre><blockquote class="mq mr ms"><p id="c254" class="jq jr mt js b jt ju jc jv jw jx jf jy mu ka kb kc mv ke kf kg mw ki kj kk kl hn dt translated">在将<code class="eh kn ko kp kq b">region</code>和<code class="eh kn ko kp kq b">instance_id</code>传递给<code class="eh kn ko kp kq b">boto3</code>之前验证它们</p></blockquote><p id="cab4" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated"><a class="ae km" href="http://botocore.readthedocs.io/en/latest/client_upgrades.html#error-handling" rel="noopener ugc nofollow" target="_blank"> boto3错误处理</a>的第一步是捕捉<code class="eh kn ko kp kq b">ClientError</code>和<code class="eh kn ko kp kq b">BotoCoreError</code>，两者都在<code class="eh kn ko kp kq b">botocore.exceptions</code>包中。</p><p id="e0e0" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">根据我的经验，<code class="eh kn ko kp kq b">boto3</code>客户端对无效或<code class="eh kn ko kp kq b">None</code>区域或实例id的错误处理非常混乱。除了上面提到的错误，任一字段中的<code class="eh kn ko kp kq b">None</code>值都会引发Python内置的<code class="eh kn ko kp kq b">ValueError</code>。如果<code class="eh kn ko kp kq b">region &amp;&amp; instance_id</code>为假，我建议您不要尝试使用<code class="eh kn ko kp kq b">boto3</code>客户端。</p><h1 id="e6d7" class="kr ks ib bd kt ku kv kw kx ky kz la lb jh lc ji ld jk le jl lf jn lg jo lh li dt translated">得到名字</h1><p id="ea08" class="pw-post-body-paragraph jq jr ib js b jt ll jc jv jw lm jf jy jz lz kb kc kd ma kf kg kh mb kj kk kl hn dt translated">实例的“名称”实际上是带有关键字“名称”的实例标记。您可以从实例资源中检索标签，并过滤<code class="eh kn ko kp kq b">Name</code>标签。</p><pre class="mc md me mf fq mg kq mh mi aw mj dt"><span id="fc24" class="mk ks ib kq b fv ml mm l mn mo">tags = instance.tags or []<br/>names = [tag.get('Value') for tag in tags if tag.get('Key') == 'Name']<br/>name = names[0] if names else None</span></pre><blockquote class="mq mr ms"><p id="51a3" class="jq jr mt js b jt ju jc jv jw jx jf jy mu ka kb kc mv ke kf kg mw ki kj kk kl hn dt translated">因为属性是延迟加载的，所以一些无效的实例id会在这里抛出错误</p></blockquote><p id="6430" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">根据<a class="ae km" href="http://boto3.readthedocs.io/en/latest/guide/resources.html#identifiers-attributes-intro" rel="noopener ugc nofollow" target="_blank"> boto3文档</a>，资源属性是延迟加载的，这意味着第一次访问属性时会进行第一次API调用。这意味着，虽然在创建<code class="eh kn ko kp kq b">ec2.Instance</code>资源时会验证<code class="eh kn ko kp kq b">None</code>或空字符串，但在第一次调用<code class="eh kn ko kp kq b">DescribeInstances</code>时，会验证类型正确但值错误的非空字符串id。为了解决这一问题，您需要尝试捕捉上一节中的<code class="eh kn ko kp kq b">botocore.exceptions</code>异常。</p><h1 id="ceab" class="kr ks ib bd kt ku kv kw kx ky kz la lb jh lc ji ld jk le jl lf jn lg jo lh li dt translated">抓住你了。</h1><p id="e47b" class="pw-post-body-paragraph jq jr ib js b jt ll jc jv jw lm jf jy jz lz kb kc kd ma kf kg kh mb kj kk kl hn dt translated">从<em class="mt">AWS</em>开放指南的<a class="ae km" href="https://github.com/open-guides/og-aws#ec2-gotchas-and-limitations" rel="noopener ugc nofollow" target="_blank"> EC2章节中了解到的问题和限制</a>:</p><blockquote class="mq mr ms"><p id="159a" class="jq jr mt js b jt ju jc jv jw jx jf jy mu ka kb kc mv ke kf kg mw ki kj kk kl hn dt translated">❗if ec2 API本身是您的基础设施的一个关键依赖项(例如，用于自动服务器替换、自定义扩展算法等)。)并且您正在大规模运行或进行许多EC2 API调用，请确保您了解它们何时可能会失败(对它的调用是有速率限制的，并且这些限制不会公布，并且可能会更改)，并针对这种可能性进行编码和测试。</p></blockquote><p id="184b" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated"><code class="eh kn ko kp kq b">boto3</code>客户端通过<code class="eh kn ko kp kq b">DescribeInstances</code> API调用加载关于实例的信息。例如，如果您每次记录错误时都调用这个API来检索实例名，那么您很容易就达到了<code class="eh kn ko kp kq b">DescribeInstances</code>速率限制。</p><p id="020f" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">除了上面提到的错误处理之外，您将希望合并对<a class="ae km" href="https://hackernoon.com/tagged/aws" rel="noopener ugc nofollow" target="_blank"> AWS </a> API的调用，以避免触及未发布的AWS速率限制。我们的解决方案是在API服务器的<a class="ae km" href="https://hackernoon.com/tagged/startup" rel="noopener ugc nofollow" target="_blank">启动</a>时获取一次实例名，并将结果缓存在一个全局数据结构中。我们不再每次需要记录错误时都调用EC2 API，而是在向机器部署新代码时只调用一次。</p><h1 id="728d" class="kr ks ib bd kt ku kv kw kx ky kz la lb jh lc ji ld jk le jl lf jn lg jo lh li dt translated">把它们放在一起</h1><p id="993b" class="pw-post-body-paragraph jq jr ib js b jt ll jc jv jw lm jf jy jz lz kb kc kd ma kf kg kh mb kj kk kl hn dt translated">下面是一个最终的<code class="eh kn ko kp kq b">get_instance_name</code>函数的例子。</p><figure class="mc md me mf fq hw"><div class="bz el l di"><div class="mx my l"/></div></figure><figure class="mc md me mf fq hw"><div class="bz el l di"><div class="mz my l"/></div></figure></div></div>    
</body>
</html>