<html>
<head>
<title>RSA and ECDSA hybrid Nginx setup with LetsEncrypt certificates generated through Docker image</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">RSA和ECDSA混合Nginx设置，通过Docker映像生成LetsEncrypt证书</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/rsa-and-ecdsa-hybrid-nginx-setup-with-letsencrypt-certificates-ee422695d7d3?source=collection_archive---------4-----------------------#2018-01-05">https://medium.com/hackernoon/rsa-and-ecdsa-hybrid-nginx-setup-with-letsencrypt-certificates-ee422695d7d3?source=collection_archive---------4-----------------------#2018-01-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="df79" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">RSA与ECC的比较。使用包装在Docker映像中的certbot和acme.sh客户端颁发LetsEncrypt证书。Nginx设置</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/a01ce16c81f6bc5c2e62f91da68b1fe6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ku7A6thaKWkyrbVJaun4gA.png"/></div></div></figure><h1 id="23c9" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">目录</h1><ul class=""><li id="63db" class="kn ko hu kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">RSA与ECC的比较。为什么你可能需要ECDSA证书？</li><li id="8369" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">如何使用<code class="eh lk ll lm ln b">openssl</code>生成RSA和EC密钥/CSR？</li><li id="e6d5" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">什么是<a class="ae lo" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> LetsEncrypt CA </a>？如何自动发布免费的域验证证书？</li><li id="342d" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">如何在仍然使用<a class="ae lo" href="https://certbot.eff.org/" rel="noopener ugc nofollow" target="_blank"> certbot </a>和<a class="ae lo" href="https://github.com/Neilpang/acme.sh" rel="noopener ugc nofollow" target="_blank"> acme.sh </a>客户端的情况下，通过<a class="ae lo" href="https://github.com/samoshkin/docker-letsencrypt-certgen" rel="noopener ugc nofollow" target="_blank"> Docker镜像</a>生成RSA和/或ECDSA证书？</li><li id="6fd3" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">如何为混合RSA/ECDSA设置配置和测试Nginx？</li></ul><h1 id="53f0" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">RSA与ECC的比较</h1><p id="a04b" class="pw-post-body-paragraph lp lq hu kp b kq kr iv lr ks kt iy ls ku lt lu lv kw lw lx ly ky lz ma mb la hn dt translated">RSA是最流行的公钥密码算法。带有RSA密钥的证书是黄金标准，是当前互联网PKI <a class="ae lo" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank">安全</a>的代表。这是一项久经考验的老技术，从安全角度来看非常重要。椭圆曲线加密是当前RSA标准上公钥加密的替代方法。</p><p id="dd52" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">RSA算法可以用于加密和数字签名，而ECC只能用于签名。</p><p id="cb06" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">密钥的安全性取决于它的大小和算法。有些算法比其他算法更容易被破解。破解RSA密钥需要分解两个大数的乘积。破解一个ECC密钥需要找到椭圆曲线上点之间的离散对数，目前还没有实现这一点的进展。</p><p id="cbbc" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">对于相同的安全级别，算法需要不同的密钥大小。ECC可以使用较小的密钥大小。以下是密钥大小比较表:</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="8935" class="ml jw hu ln b fv mm mn l mo mp">+----------------------+-----------------+--------------------+<br/>| Symmetric Key length |  RSA key length |   ECC key length   | <br/>+----------------------+---------- ------+--------------------+<br/>| 80                   | 1024            | 160                |<br/>| 112                  | 2048            | 224                |<br/>| 128                  | 3072            | 256                |<br/>| 192                  | 7680            | 384                |<br/>| 256                  | 15360           | 512                |<br/>+----------------------+-----------------+--------------------+</span></pre><p id="42d9" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">例如，256位ECC密钥相当于RSA 3072位密钥，提供128位安全性:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mq"><img src="../Images/02cad69bba16029981e8319370561fc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7GRqUP7Qys-U5VrQmkXUxw.png"/></div></div></figure><p id="7d9c" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">较小的密钥在生成签名时计算量较小，因为数学运算涉及的数字较小。然而，尽管ECC在签名生成方面更快，但在签名验证方面却比RSA慢。让我们使用openssl作为基准测试工具来衡量这一点:</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="bf51" class="ml jw hu ln b fv mm mn l mo mp">$ openssl speed ecdsap256 rsa2048</span><span id="417b" class="ml jw hu ln b fv mr mn l mo mp">                          sign/s     verify/s<br/>rsa 2048 bits             679.0      23489.0<br/>256 bit ecdsa (nistp256)  15581.9    6211.7</span></pre><p id="db76" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">更小的ECC公钥意味着更小的证书大小——传递的数据更少，下载更快，TLS握手更快<a class="ae lo" href="https://scotthelme.co.uk/ecdsa-certificates/" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="bfb7" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">如果您想要更高的安全性，RSA就不能很好地扩展，您必须以远快于ECDSA曲线大小的速度增加RSA模数大小。1024位RSA密钥已经过时，2048是当前的标准大小。如果你需要走得更远，你会停滞不前。第一，如果CA不提供4096位RSA keychain，那么用2048 RSA中介来签署自己的4096位RSA密钥是没有意义的。其次，请注意，RSA私钥每翻倍一次，TLS握手性能就会降低大约6到7倍。所以，如果你需要更多的安全性，选择ECC。</p><p id="6acb" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">虽然ECC有一些好处，但也有一些缺点。该技术不像RSA那样成熟和成熟。还有一个兼容性问题，不过它似乎可以在大多数操作系统和现代浏览器上使用。查看这些资源了解<a class="ae lo" href="https://support.globalsign.com/customer/portal/articles/1995283-ecc-compatibility" rel="noopener ugc nofollow" target="_blank"> ECC兼容性详情</a>。</p><p id="6d5f" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">那里有很多椭圆曲线。最受欢迎和主要浏览器支持的是P-256、P-384、P-521、x25519。虽然P-256和P-384是<a class="ae lo" href="https://en.wikipedia.org/wiki/NSA_Suite_B_Cryptography" rel="noopener ugc nofollow" target="_blank"> NIST的套件B </a>算法的一部分，但P-521和x25519不是。谷歌Chrome已经<a class="ae lo" href="https://code.google.com/p/chromium/issues/detail?id=478225" rel="noopener ugc nofollow" target="_blank">不再支持P-521曲线</a>，<a class="ae lo" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1128792" rel="noopener ugc nofollow" target="_blank">NSS/火狐也是如此。为了最大化与现有浏览器和服务器的互操作性，坚持P-256 <code class="eh lk ll lm ln b">prime256v1</code>和P-384 <code class="eh lk ll lm ln b">secp384r1</code>曲线。</a></p><p id="08d1" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">要查看所有可用ECC曲线列表，OpenSSL库支持:</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="01a0" class="ml jw hu ln b fv mm mn l mo mp">openssl ecparam -list_curves</span></pre><p id="c8d1" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">要查看浏览器支持的曲线，请使用<a class="ae lo" href="https://www.ssllabs.com/ssltest/viewMyClient.html" rel="noopener ugc nofollow" target="_blank"> SSL Labs客户端测试</a>。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff ms"><img src="../Images/108a97bf23b16ecf09d6cf3f6041a769.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mdtivS5WAsYwrW585yBECg.png"/></div></div></figure><p id="c4fb" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">总之，ECDSA证书的优点和缺点:</p><ul class=""><li id="5372" class="kn ko hu kp b kq mc ks md ku mt kw mu ky mv la lb lc ld le dt translated">(+)更小的密钥和证书大小，<a class="ae lo" href="https://scotthelme.co.uk/ecdsa-certificates/" rel="noopener ugc nofollow" target="_blank">更快的TLS握手</a></li><li id="7016" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">(+) <a class="ae lo" href="https://securitypitfalls.wordpress.com/2014/10/06/rsa-and-ecdsa-performance/" rel="noopener ugc nofollow" target="_blank">更好的性能</a>从服务器的角度来看，需要更少的CPU和内存</li><li id="bb9a" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">(+)算法更强，更难破解</li><li id="15f4" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">(+)在您需要更多安全性时可以更好地扩展</li><li id="0278" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">(-)与RSA相比，ECC相对较新，不如RSA成熟且久经考验</li><li id="0a9e" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">(-)缺乏兼容性，缺乏广泛支持。</li><li id="9f79" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">(-) ECC生成签名的速度更快，但是签名验证的计算量更大，速度比RSA慢</li></ul><p id="7077" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">你不需要在RSA和ECC之间做出唯一的选择。您可以设置混合配置，首先提供ECDSA证书，然后为不支持的客户端提供RSA证书。</p><h1 id="7c77" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">使用openssl生成RSA和ECC密钥/CSR</h1><p id="1c57" class="pw-post-body-paragraph lp lq hu kp b kq kr iv lr ks kt iy ls ku lt lu lv kw lw lx ly ky lz ma mb la hn dt translated">通常，在向CA发送颁发证书的请求之前，您需要生成私钥和CSR(证书签名请求)。使用<code class="eh lk ll lm ln b">openssl</code>工具非常简单。</p><p id="fca1" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">生成给定长度的RSA密钥:</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="5f6e" class="ml jw hu ln b fv mm mn l mo mp">openssl genrsa -out example.key 2048</span></pre><p id="ad49" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">用给定曲线生成EC键:</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="ac2b" class="ml jw hu ln b fv mm mn l mo mp">openssl ecparam -genkey -name secp384r1 | openssl ec -out ec.key</span></pre><p id="16a3" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">使用给定的主题信息从现有私钥生成CSR:</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="2bc0" class="ml jw hu ln b fv mm mn l mo mp">openssl req -new  -key example.key -out example.csr -subj "/CN=example.com" -sha256</span></pre><p id="c484" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">或者，您可以在一个命令中同时创建密钥和CSR:</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="4fb5" class="ml jw hu ln b fv mm mn l mo mp">openssl req -nodes -newkey rsa:2048 -keyout example.key -out example.csr -sha256</span></pre><h1 id="3e94" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">LetsEncrypt CA</h1><p id="f975" class="pw-post-body-paragraph lp lq hu kp b kq kr iv lr ks kt iy ls ku lt lu lv kw lw lx ly ky lz ma mb la hn dt translated">如果你想试验ECDSA和RSA证书，最好的选择是使用<a class="ae lo" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> LetsEncrypt认证中心</a>，它允许自动生成免费的域验证证书。</p><p id="fc73" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">为了获得证书，您需要证明域的所有权。</p><p id="dec6" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">通常，此过程需要手动操作:生成一个私钥和一个CSR(证书签名请求),其中包含相关的主题信息和通用名称，向CA发送CSR，最后使用选定的质询方法证明域的所有权:</p><ul class=""><li id="aa16" class="kn ko hu kp b kq mc ks md ku mt kw mu ky mv la lb lc ld le dt translated"><strong class="kp hv">邮箱</strong>；CA发送带有验证链接的电子邮件，其中一个地址是admin@example.com。您需要按照链接完成验证。</li><li id="ce99" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated"><strong class="kp hv">http；</strong>你需要下载一个带有特制令牌的文件，然后将其上传到你的域名根文件夹，这样就可以在http://example.com/.well-known/pki-validation URI<a class="ae lo" href="http://example.com/.well-known/pki-validation" rel="noopener ugc nofollow" target="_blank">访问该文件</a></li><li id="43c8" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated"><strong class="kp hv">DNS；</strong>您必须在您的域名的DNS配置中创建一个特殊的CNAME记录</li></ul><p id="8748" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">LetsEncrypt通过使用一个能够与ACME协议对话的客户端来自动化这个过程。客户端通常运行在您的web主机上，并与LetsEncrypt CA或其他ACME兼容的服务器通信。客户端从服务器接收唯一的令牌，从中生成密钥，启动一个独立的web服务器监听端口80，并在特殊的URI提供密钥，如<a class="ae lo" href="http://example.com/.well-known/acme-challenge" rel="noopener ugc nofollow" target="_blank">http://example.com/.well-known/acme-challenge</a>。在DNS质询方法的情况下，客户端可以根据DNS服务器/提供商自动将CNAME记录添加到您的DNS配置中。然后，LetsEncrypt CA向您的域发出HTTP或DNS请求，以检索从令牌派生的密钥。成功的响应证明了域的所有权，CA颁发请求的证书。</p><p id="e119" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">您不需要自己生成私钥和CSR，这是由web主机上的客户端软件处理的。请注意，私钥不会在CA服务器上生成/泄露，而是专门存储在您的web主机上。客户端通常通过客户端提供一些方法来调整一些设置，如密钥长度、主题替换名称，或者如果您需要进一步定制，您可以提供自定义CSR以获得更多的灵活性和控制。</p><p id="e274" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">注意，Lets Encrypt的证书有效期只有90天。这是为了鼓励用户自动执行证书颁发和续订过程。</p><h2 id="99e1" class="ml jw hu bd jx mw mx my kb mz na nb kf ku nc nd kh kw ne nf kj ky ng nh kl ni dt translated">速率限制和临时服务器</h2><p id="a657" class="pw-post-body-paragraph lp lq hu kp b kq kr iv lr ks kt iy ls ku lt lu lv kw lw lx ly ky lz ma mb la hn dt translated">请注意，LetsEncrypt CA生产服务器设置了严格的<a class="ae lo" href="https://letsencrypt.org/docs/rate-limits/" rel="noopener ugc nofollow" target="_blank">速率限制</a>:</p><ul class=""><li id="54f8" class="kn ko hu kp b kq mc ks md ku mt kw mu ky mv la lb lc ld le dt translated">每个注册域的证书(每周20个)</li><li id="6529" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">每个证书最多100个备选名称</li><li id="7aa2" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">重复证书限制为每周5个证书</li></ul><p id="0992" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">当你在尝试和试验的时候，你很可能会遇到后一种情况，所以最好使用LetsEncrypt<a class="ae lo" href="https://letsencrypt.org/docs/staging-environment/" rel="noopener ugc nofollow" target="_blank">staging environment</a>，限制要宽松得多。</p><p id="4e16" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">临时环境中间证书("<a class="ae lo" href="https://letsencrypt.org/certs/fakeleintermediatex1.pem" rel="noopener ugc nofollow" target="_blank">假LE中间X1 </a>")是由浏览器/客户端信任存储中不存在的根证书颁发的，因此您可能希望在测试时添加<a class="ae lo" href="https://letsencrypt.org/certs/fakelerootx1.pem" rel="noopener ugc nofollow" target="_blank">"假LE根X1" </a>作为受信任的根证书。</p><h1 id="2d4f" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">使用Docker映像生成LetsEncrypt证书</h1><p id="87bc" class="pw-post-body-paragraph lp lq hu kp b kq kr iv lr ks kt iy ls ku lt lu lv kw lw lx ly ky lz ma mb la hn dt translated">ACME客户端有多种:<a class="ae lo" href="https://certbot.eff.org/" rel="noopener ugc nofollow" target="_blank"> certbot </a>、<a class="ae lo" href="https://github.com/Neilpang/acme.sh" rel="noopener ugc nofollow" target="_blank"> acme.sh </a>、<a class="ae lo" href="https://github.com/xenolf/lego" rel="noopener ugc nofollow" target="_blank"> lego </a>和<a class="ae lo" href="https://letsencrypt.org/docs/client-options/" rel="noopener ugc nofollow" target="_blank">其他</a>。我在这里不打算深入客户细节——无论如何，医生会解释得更好。</p><p id="52bc" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">就我个人而言，我发现更容易、更快速地完成工作的方法是通过一些Docker映像发布证书。这是给懒人和那些不想花太多时间用LetsEncrypt挖掘和解析文档的人的。</p><p id="038c" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">我准备了一个:<a class="ae lo" href="https://hub.docker.com/r/asamoshkin/letsencrypt-certgen/" rel="noopener ugc nofollow" target="_blank">Docker Hub上的asamoshkin/letsencrypt-certgen</a>和<a class="ae lo" href="https://github.com/samoshkin/docker-letsencrypt-certgen" rel="noopener ugc nofollow" target="_blank"> Github链接</a>。这个Docker映像提供了一个简单的入口点来从LetsEncrypt CA获取和管理SSL证书。它封装了两个流行的ACME客户端:<a class="ae lo" href="https://certbot.eff.org/" rel="noopener ugc nofollow" target="_blank"> certbot </a>和<a class="ae lo" href="https://github.com/Neilpang/acme.sh" rel="noopener ugc nofollow" target="_blank"> acme.sh </a>，分别用于获取RSA和/或ECDSA证书。我们两者都需要，因为certbot不能颁发ECDSA证书(更准确地说，只能通过自定义CSR，但这样您就失去了更新、撤销和进一步管理此类证书的能力)。</p><p id="0746" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">以下是为单个域颁发ECDSA (prime256v1曲线)和RSA (2048)证书的示例<code class="eh lk ll lm ln b">foobbz.site</code></p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="d72e" class="ml jw hu ln b fv mm mn l mo mp">docker run \<br/>  -v /var/ssl:/var/ssl \<br/>  -p 80:80 \<br/>  -e DOMAINS=foobbz.site \<br/>  --rm \<br/>  asamoshkin/letsencrypt-certgen issue</span></pre><p id="b353" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">要求是在服务器上运行这个映像，为您想要获取证书的域进行配置(您的DNS A记录指向该域)。服务器的端口80应该由防火墙打开，这样LetsEncrypt CA服务器可以执行验证质询。</p><p id="5ff5" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">一旦完成，证书、密钥和相关文件就存储在<code class="eh lk ll lm ln b">/var/ssl/$domain_common_name</code>路径下，在一个<code class="eh lk ll lm ln b">/var/ssl</code>卷上，这个卷是你以前装入容器的。</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="c390" class="ml jw hu ln b fv mm mn l mo mp"># tree /var/ssl<br/><br/>/var/ssl<br/>└── foobbz.site<br/>    ├── certs<br/>    │   ├── cert.ecc.pem<br/>    │   ├── cert.rsa.pem<br/>    │   ├── chain.ecc.pem<br/>    │   ├── chain.rsa.pem<br/>    │   ├── fullchain.ecc.pem<br/>    │   └── fullchain.rsa.pem<br/>    └── private<br/>        ├── privkey.ecc.pem<br/>        └── privkey.rsa.pem</span></pre><p id="f3ee" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">所有文件都以PEM格式编码:</p><ul class=""><li id="babe" class="kn ko hu kp b kq mc ks md ku mt kw mu ky mv la lb lc ld le dt translated"><code class="eh lk ll lm ln b">cert.rsa.pem</code>、<code class="eh lk ll lm ln b">cert.ecc.pem</code> -生成的证书(RSA或ECDSA)</li><li id="5dc9" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated"><code class="eh lk ll lm ln b">chain.[type].pem</code> -中间CA证书链(如假LE Intermediate X1)</li><li id="e001" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated"><code class="eh lk ll lm ln b">fullchain.[type].pem</code> -与任何中间CA证书捆绑的证书。这适用于Nginx指令<code class="eh lk ll lm ln b">ssl_certificate</code>，它需要一个bundle，而不是leaf证书。</li><li id="67d8" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated"><code class="eh lk ll lm ln b">privkey.[type].pem</code> -私钥文件</li></ul><p id="9155" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">您并不局限于单个域的单个证书。您可以为多个域颁发多个证书，或者使用SAN(x . 509 subject alternative names extension)为多个域颁发一个证书。您可以选择仅使用自定义密钥长度或椭圆曲线生成ECDSA或RSA证书。</p><p id="cfda" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">首先，准备一个包含域列表的文件。每行代表要颁发的单个证书。每行中的第一个名称是常用名称，而后面以逗号分隔的名称是证书备用名称(SAN)。</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="ca8b" class="ml jw hu ln b fv mm mn l mo mp"># cat /root/domains.txt<br/><br/>foobbz.site,www.foobbz.site,web.foobbz.site<br/>foobbz2.site,www.foobbz.site</span></pre><p id="e7e1" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">运行一个命令，仅为<code class="eh lk ll lm ln b">foobbz.site</code>和<code class="eh lk ll lm ln b">foobbz2.site</code>域颁发两个ECD sa“secp 384 r 1”证书(无RSA证书):</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="f7fb" class="ml jw hu ln b fv mm mn l mo mp">docker run \<br/>  -v /var/ssl:/var/ssl \<br/>  -v /root/domains.txt:/etc/domains.txt \<br/>  -p 80:80 \<br/>  -e RSA_ENABLED=0 \<br/>  -e ECDSA_KEY_LENGTH=ec-384 \<br/>  -e DOMAINS=/etc/domains.txt \<br/>  --rm \<br/>  asamoshkin/letsencrypt-certgen issue</span></pre><p id="8cc0" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">该映像的主要用例是触发一个一次性命令来颁发证书，但您也可以通过使用同一映像续订、撤销或删除证书来进一步管理它们。</p><p id="d2d6" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">您可以在构建时、Nginx/Apache启动之前的运行时使用这个映像，或者通过从cron作业运行它来定期更新证书。这个想法是LetsEncrypt的东西被封装在一个容器中，你不需要污染你的Nginx/Apache容器。</p><p id="8599" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">更完整的功能列表:</p><ul class=""><li id="5391" class="kn ko hu kp b kq mc ks md ku mt kw mu ky mv la lb lc ld le dt translated">自动颁发和管理LetsEncrypt SSL证书</li><li id="399f" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">为1生成DV证书..n域，支持多域SAN(主题别名)证书</li><li id="d64a" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">使用可配置的密钥参数生成RSA和/或ECDSA证书:RSA密钥长度(2048，3072，4096)和EC密钥的椭圆曲线(prime256v1，secp384r1)</li><li id="59d7" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">选择DV挑战验证方法:独立或webroot</li><li id="1886" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">在证书即将过期时续订证书或强制续订</li><li id="e070" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">通过联系LetsEncrypt CA吊销证书</li><li id="8203" class="kn ko hu kp b kq lf ks lg ku lh kw li ky lj la lb lc ld le dt translated">使用LetsEncrypt临时服务器或生产服务器</li></ul><p id="3167" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">更多细节和例子，请查看Github上的<a class="ae lo" href="https://github.com/samoshkin/docker-letsencrypt-certgen" rel="noopener ugc nofollow" target="_blank">samoshkin/docker-letsencrypt-certgen</a>。你也可以查看源代码，了解如何使用<a class="ae lo" href="https://certbot.eff.org/" rel="noopener ugc nofollow" target="_blank"> certbot </a>和<a class="ae lo" href="https://github.com/Neilpang/acme.sh" rel="noopener ugc nofollow" target="_blank"> acme.sh </a>客户端。</p><p id="0408" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">还有一张<a class="ae lo" href="https://zerossl.com/" rel="noopener ugc nofollow" target="_blank">ZeroSSL</a>T10】docker图片值得一查。</p><h1 id="36c2" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">混合RSA/ECDSA设置的Nginx配置</h1><p id="fdb2" class="pw-post-body-paragraph lp lq hu kp b kq kr iv lr ks kt iy ls ku lt lu lv kw lw lx ly ky lz ma mb la hn dt translated">生成证书后，就该配置web服务器了。Nginx允许混合并行RSA和ECDSA证书，并将根据商定的密码套件在TLS握手期间提供一个或另一个证书。</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="3609" class="ml jw hu ln b fv mm mn l mo mp">server {<br/>  listen 443 ssl default_server<em class="nj">;<br/>  </em>server_name foobbz.site www.foobbz.site<em class="nj">;</em></span><span id="7630" class="ml jw hu ln b fv mr mn l mo mp"><em class="nj">  # RSA certificates<br/>  </em>ssl_certificate /var/ssl/foobbz.site/certs/fullchain.rsa.pem<em class="nj">;</em>        <br/>  ssl_certificate_key /var/ssl/foobbz.site/private/privkey.rsa.pem<em class="nj">;</em></span><span id="e3f2" class="ml jw hu ln b fv mr mn l mo mp"><em class="nj">  # ECDSA certificates<br/>  </em>ssl_certificate /var/ssl/foobbz.site/certs/fullchain.ecc.pem<em class="nj">;</em>        <br/>  ssl_certificate_key /var/ssl/foobbz.site/private/privkey.ecc.pem<em class="nj">;<br/>  <br/>  # Other directives<br/>}</em></span></pre><p id="7923" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">您还需要通过正确排序您的密码套件，告诉Nginx优先使用ECDSA而不是RSA进行身份验证(请注意，首先使用“ECDSA”的套件，然后是“aRSA”的套件):</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="ade7" class="ml jw hu ln b fv mm mn l mo mp">ssl_prefer_server_ciphers on;<br/>ssl_ciphers "EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH:DHE+AESGCM:DHE:!RSA!aNULL:!eNULL:!LOW:!RC4:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS:!CAMELLIA:!SEED";</span></pre><p id="a439" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">就这样，现在启动您的Nginx，让我们使用openssl作为TLS客户端并提取证书来测试我们的配置。或者您可以使用<a class="ae lo" href="https://www.ssllabs.com/ssltest/" rel="noopener ugc nofollow" target="_blank"> Qualys SSL Labs服务器测试</a>来查看证书。</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="58e4" class="ml jw hu ln b fv mm mn l mo mp">$ openssl s_client -host foobbz.site -port 443 -cipher ECDHE-ECDSA-AES128-GCM-SHA256 2&gt;&amp;1 &lt; /dev/null | sed -n '/-----BEGIN/,/-----END/p' | openssl x509 -noout -text</span></pre><p id="d89b" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">查看公钥，我们可以确保提供ECDSA证书。</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="c11d" class="ml jw hu ln b fv mm mn l mo mp">Subject Public Key Info:<br/>  Public Key Algorithm: id-ecPublicKey<br/>    Public-Key: (256 bit)<br/>    pub:<br/>      04:47:ee:86:9f:c9:5a:81:16:89:38:f7:5b:9d:ba:<br/>      6b:8b:d2:aa:8e:1e:54:67:f7:f1:44:84:5f:10:df:<br/>      7f:df:16:f4:2f:d6:c1:78:b8:71:68:e9:ee:78:82:<br/>      fc:2e:ae:96:e9:a3:b7:26:c0:ed:41:39:2a:48:f9:<br/>      0f:28:10:4e:15<br/>    ASN1 OID: prime256v1<br/>    NIST CURVE: P-256</span></pre><p id="93cb" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">注意，叶子ECDSA证书仍然由LetsEncrypt的RSA证书链签名(让我们加密权威X3，DST根CA X3)。LetsEncrypt不使用专用的EC证书签名来构建完整的EC链。</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="3d1d" class="ml jw hu ln b fv mm mn l mo mp">0 s:/CN=foobbz.site<br/> i:/C=US/O=Let’s Encrypt/CN=Let’s Encrypt Authority X3<br/> 1 s:/C=US/O=Let’s Encrypt/CN=Let’s Encrypt Authority X3<br/> i:/O=Digital Signature Trust Co./CN=DST Root CA X3</span></pre><p id="2ff3" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">现在，让我们使用另一个密码套件(ECDHE-RSA-AES128-GCM-SHA256)来测试RSA配置。</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="4ec0" class="ml jw hu ln b fv mm mn l mo mp">openssl s_client -host foobbz.site -port 443 -cipher ECDHE-RSA-AES128-GCM-SHA256 2&gt;&amp;1 &lt; /dev/null | sed -n '/-----BEGIN/,/-----END/p' | openssl x509 -noout -text</span></pre><p id="869b" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">我们得到2048位RSA公钥。顺便说一下，注意它们之间的长度差异。</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="6c94" class="ml jw hu ln b fv mm mn l mo mp">Subject Public Key Info:<br/>  Public Key Algorithm: rsaEncryption<br/>    Public-Key: (2048 bit)<br/>      Modulus:<br/>        00:ea:cb:5e:22:dd:93:fe:63:21:c4:bd:b9:07:78:<br/>        fc:ef:66:38:7a:19:bf:68:58:39:16:86:ee:f6:2c:<br/>        18:68:9c:32:c0:5b:a4:76:e8:e0:40:0e:6d:29:7c:<br/>        bc:04:67:b4:1b:05:e8:72:53:24:dc:4f:a6:3d:48:<br/>        41:2e:83:99:fa:13:20:88:b8:e5:5d:34:57:01:c6:<br/>        eb:fc:c1:67:e8:e4:ec:58:2c:a2:ce:51:ea:99:c0:<br/>        bb:de:61:8a:40:76:80:50:48:25:c6:7f:0e:a4:a6:<br/>        61:e7:25:67:b1:74:ee:1f:f1:75:e8:76:a0:c5:5d:<br/>        9c:40:48:8b:d3:95:e1:27:d2:d6:ca:14:e4:39:ac:<br/>        4d:0d:35:23:89:db:4b:ef:60:84:0b:4d:15:76:0e:<br/>        3c:f5:52:1c:20:ce:d8:03:25:22:7a:37:84:fb:d2:<br/>        1b:00:ff:31:69:55:65:7d:42:d1:31:99:0c:d6:29:<br/>        41:36:06:bf:0d:ab:31:1a:e6:b0:6a:76:67:2c:7b:<br/>        c0:5b:34:55:49:e2:4c:d9:e4:40:99:1c:c1:1d:6a:<br/>        88:c1:53:af:ee:ab:b5:2e:e6:76:ff:1c:33:e2:ca:<br/>        7e:d7:93:e6:23:df:cd:78:a6:39:f4:04:a2:44:d0:<br/>        a6:cc:f1:51:2f:5d:dc:5e:ea:ff:57:d7:f1:82:d4:<br/>        48:11<br/>      Exponent: 65537 (0x10001)</span></pre><p id="f1c9" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">所以，就这样了。感谢你阅读这篇文章。</p><h1 id="d54d" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">编辑#1</h1><p id="aec0" class="pw-post-body-paragraph lp lq hu kp b kq kr iv lr ks kt iy ls ku lt lu lv kw lw lx ly ky lz ma mb la hn dt translated"><a class="ae lo" href="https://www.reddit.com/r/devops/comments/7oeohq/docker_image_to_generate_renew_revoke_rsa_andor/dsa7rkc/" rel="noopener ugc nofollow" target="_blank"> Reddit用户wuunderbar指出</a>Docker容器没有足够的熵来生成关键素材。我知道的一个解决方案是将主机上的<code class="eh lk ll lm ln b">/dev/urandom</code>安装到容器的<code class="eh lk ll lm ln b">/dev/random</code>中。看到这个<a class="ae lo" href="https://stackoverflow.com/questions/26021181/not-enough-entropy-to-support-dev-random-in-docker-containers-running-in-boot2d/26024403#26024403" rel="noopener ugc nofollow" target="_blank"> StackOverflow回答</a>。</p><pre class="jk jl jm jn fq mh ln mi mj aw mk dt"><span id="d44b" class="ml jw hu ln b fv mm mn l mo mp">docker run -v /dev/urandom:/dev/random ...</span></pre><h1 id="898b" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">资源</h1><p id="f6a8" class="pw-post-body-paragraph lp lq hu kp b kq kr iv lr ks kt iy ls ku lt lu lv kw lw lx ly ky lz ma mb la hn dt translated">asamoshkin/letsencrypt-certgen—码头枢纽—<a class="ae lo" href="https://hub.docker.com/r/asamoshkin/letsencrypt-certgen/" rel="noopener ugc nofollow" target="_blank">https://hub.docker.com/r/asamoshkin/letsencrypt-certgen/</a></p><p id="8803" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">samoshkin/docker-LetsEncrypt-certgen:使用certbot和acme.sh客户端以自动化方式从LetsEncrypt CA生成、续订和撤销RSA和/或ECDSA SSL证书—<a class="ae lo" href="https://github.com/samoshkin/docker-letsencrypt-certgen" rel="noopener ugc nofollow" target="_blank">https://github.com/samoshkin/docker-letsencrypt-certgen</a></p><p id="39d0" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">椭圆曲线加密(ECC证书)| DigiCert.com—<a class="ae lo" href="https://www.digicert.com/ecc.htm" rel="noopener ugc nofollow" target="_blank">https://www.digicert.com/ecc.htm</a></p><p id="3243" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">ECC—<a class="ae lo" href="https://support.globalsign.com/customer/portal/articles/1994347-ecc" rel="noopener ugc nofollow" target="_blank">https://support . globalsign . com/customer/portal/articles/1994 347-ECC</a></p><p id="10f0" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">ECC兼容性—<a class="ae lo" href="https://support.globalsign.com/customer/portal/articles/1995283-ecc-compatibility" rel="noopener ugc nofollow" target="_blank">https://support . globalsign . com/customer/portal/articles/1995 283-ECC兼容性</a></p><p id="0622" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">ECDSA:更好的互联网的数字签名算法—<a class="ae lo" href="https://blog.cloudflare.com/ecdsa-the-digital-signature-algorithm-of-a-better-internet/" rel="noopener ugc nofollow" target="_blank">https://blog . cloud flare . com/ECD sa-The-digital-signature-algorithm-of-a-better-internet/</a></p><p id="70dc" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">让我们加密—免费SSL/TLS证书—<a class="ae lo" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">https://letsencrypt.org/</a></p><p id="f871" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">https://certbot.eff.org/</p><p id="f74b" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">ZeroSSL:免费SSL—【https://zerossl.com/ T2】</p><p id="ce0f" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">Neilpang/acme.sh:实现acme客户端协议的纯Unix shell脚本—【https://github.com/Neilpang/acme.sh】T4</p><p id="2ebf" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">RSA和ECDSA性能| securitypitfalls—<a class="ae lo" href="https://securitypitfalls.wordpress.com/2014/10/06/rsa-and-ecdsa-performance/" rel="noopener ugc nofollow" target="_blank">https://securitypitfalls . WordPress . com/2014/10/06/RSA-and-ECD sa-performance/</a></p><p id="ec45" class="pw-post-body-paragraph lp lq hu kp b kq mc iv lr ks md iy ls ku me lu lv kw mf lx ly ky mg ma mb la hn dt translated">测试ECDSA证书—<a class="ae lo" href="https://scotthelme.co.uk/ecdsa-certificates/" rel="noopener ugc nofollow" target="_blank">https://scotthelme.co.uk/ecdsa-certificates/</a></p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nk nl l"/></div></figure></div></div>    
</body>
</html>