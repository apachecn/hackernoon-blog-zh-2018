<html>
<head>
<title>How To: Invoke lambda functions through WSO2 API Manager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何:通过WSO2 API管理器调用lambda函数</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-invoke-lambda-functions-through-wso2-api-manager-5a04e8178803?source=collection_archive---------18-----------------------#2018-01-05">https://medium.com/hackernoon/how-to-invoke-lambda-functions-through-wso2-api-manager-5a04e8178803?source=collection_archive---------18-----------------------#2018-01-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="9cb4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最近，AWS lambda在云计算领域引起了不小的轰动。它从开发人员手中接过了管理基础设施的重担。现在你只需要担心你的代码，你可以把你的代码放到一组lambda函数中，然后你就可以开始了。与AWS EC2实例不同，AWS lambda是一个事件驱动的系统，它只对应用程序运行的时间收费。因此，这是实现云后端的一种既经济又简单的方式。</p><p id="bbed" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在传统的API管理中，API的调用是如何发生的，您有一个后端服务器，它监听任何传入的请求，API管理层将向该后端服务器发送请求。然后，一旦后端服务器完成计算，它将发出一个响应，该响应将被API管理层接收，并在必要的处理后提供给客户。然而，在AWS lambda的情况下，没有后端服务器监听传入的请求，它是一个基于事件的系统。那么我们如何从WSO2 API管理器中调用lambda函数呢？在下面的小节中，我将解释两种可以用来从WSO2 API管理器调用AWS lambda函数的方法。</p><p id="3a49" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，我们需要创建一个AWS帐户，创建必要的lambda函数，并获得调用这些函数的凭证。要完成这些初步步骤，请遵循AWS lambda上的<a class="ae jp" href="https://docs.aws.amazon.com/lambda/latest/dg/getting-started.html" rel="noopener ugc nofollow" target="_blank">入门指南</a>。</p><p id="f82d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">完成初步设置后，通过API Manager调用lambda函数的第一个方法是运行一个简单的nodejs应用程序来调用lambda函数。您可以传递配置参数，如地区、访问密钥id、密钥等。连同有效负载一起发送到nodejs应用程序。然后nodejs应用程序将使用“aws-sdk”库调用lambda函数并提供响应。请参见下面的流程图。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/bf7dc46a86e68c63fe5a22390949603a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*kvDLWpYourY_A_YirHkl2w.png"/></div></figure><p id="2926" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这种方法中，不需要对API管理器进行任何更改。与传统的API管理一样，API管理器将请求路由到nodejs端点，然后nodejs将调用lambda函数并发回响应。请参考[1]中可用于调用aws-lambda函数的nodejs应用程序的示例实现。部署nodejs应用程序后，您可以将想要向其发送数据的资源的url作为API的端点放入nodejs应用程序中。</p><p id="fb59" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您的大多数服务都运行在AWS上，并且您不介意获得一个新的EC2实例来运行nodejs应用程序，那么这个方法适合您。因为它更容易实现和管理，因为没有对API管理层进行任何配置更改。然而，话虽如此，这并不适合所有人。您可能不愿意为了运行nodejs应用程序来调用lambda函数而支付额外的费用来购买EC2实例。</p><p id="7237" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因为WSO2产品是高度可定制的，所以我们仍然有适合您的解决方案。您可以做的是，我们可以使用WSO2 API管理器中的类中介来调用lambda函数，而不是使用单独的nodejs实例来调用lambda函数。我不会在本文中详细讨论如何编写类中介，因为这不在本文的范围之内。然而，我将尝试在另一篇文章中讨论这个主题。无论如何，在这种情况下，我们可以在API管理器的序列中使用自定义中介，并从配置中禁用端点。我特别提到从配置中禁用端点，因为默认情况下，API Manager不允许您在没有指定生产和沙盒端点的情况下使用swagger UI发布API。你可以做的是在UI中给出一些虚拟URL，然后在synapse配置中注释掉它们。此外，为了得到响应，您必须在序列的末尾放置一个响应中介，否则它不会返回响应。请参见下图，了解该场景中架构的直观概述。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jy"><img src="../Images/79ce36325321ed0b7fb5e923e7f70b23.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*ucaFQnPaYgniRfOHbBpgwA.png"/></div><figcaption class="jz ka fg fe ff kb kc bd b be z ek">API Manager uses Class Mediator to invoke aws-lambda using aws-sdk</figcaption></figure><p id="bc35" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在编写这个定制中介时，您必须记住的一点是，您必须将aws-sdk java库和依赖项的匹配版本打包到最终的包中。否则，您可能会遇到aws-sdk试图使用WSO2产品包中不兼容的依赖版本的问题。打包完成后，您可以将osgi包放到产品包的dropins文件夹中，这样它就可以正常工作了。请参考[2]中可用于从WSO2 API管理器调用lambda函数的类中介器的示例实现。通过这个类中介调用lambda函数的API的示例API定义如下所示。请注意，类属性中使用的值都是虚拟值。</p><pre class="jr js jt ju fq kd ke kf kg aw kh dt"><span id="60b5" class="ki kj hu ke b fv kk kl l km kn">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;api ae jp" href="http://ws.apache.org/ns/synapse" rel="noopener ugc nofollow" target="_blank"&gt;http://ws.apache.org/ns/synapse"<br/>     name="admin--test"<br/>     context="/test/v1.0.0"<br/>     version="v1.0.0"<br/>     version-type="context"&gt;<br/> &lt;resource methods="POST" url-mapping="/test" faultSequence="fault"&gt;<br/>      &lt;inSequence&gt;<br/>         &lt;property name="api.ut.backendRequestTime"<br/>                   expression="get-property('SYSTEM_TIME')"/&gt;                       </span><span id="afe7" class="ki kj hu ke b fv ko kl l km kn">         &lt;class name="org.wso2.awsmediator.AWSClassMediator"&gt;<br/>             &lt;property name="region" value="region"/&gt;<br/>             &lt;property name="functionName" value="function_name"/&gt;<br/>             &lt;property name="accessKey" value="accesskey-value" /&gt;<br/>             &lt;property name="secretKey" value="secret-key" /&gt;<br/>             &lt;property name="maxConnections" value="1200"/&gt;<br/>         &lt;/class&gt;<br/>         &lt;respond/&gt;<br/>      &lt;/inSequence&gt;<br/>      &lt;outSequence&gt;<br/>         &lt;class name="org.wso2.carbon.apimgt.gateway.handlers.analytics.APIMgtResponseHandler"/&gt;<br/>         &lt;send/&gt;<br/>      &lt;/outSequence&gt;<br/> &lt;/resource&gt;<br/>   &lt;handlers&gt;<br/>      &lt;handler class="org.wso2.carbon.apimgt.gateway.handlers.common.APIMgtLatencyStatsHandler"/&gt;<br/>      &lt;handler class="org.wso2.carbon.apimgt.gateway.handlers.security.CORSRequestHandler"&gt;<br/>         &lt;property name="apiImplementationType" value="ENDPOINT"/&gt;<br/>      &lt;/handler&gt;<br/>      &lt;handler class="org.wso2.carbon.apimgt.gateway.handlers.security.APIAuthenticationHandler"/&gt;<br/>      &lt;handler class="org.wso2.carbon.apimgt.gateway.handlers.throttling.ThrottleHandler"/&gt;<br/>      &lt;handler class="org.wso2.carbon.apimgt.gateway.handlers.analytics.APIMgtUsageHandler"/&gt;<br/>      &lt;handler class="org.wso2.carbon.apimgt.gateway.handlers.analytics.APIMgtGoogleAnalyticsTrackingHandler"&gt;<br/>         &lt;property name="configKey" value="gov:/apimgt/statistics/ga-config.xml"/&gt;<br/>      &lt;/handler&gt;<br/>      &lt;handler class="org.wso2.carbon.apimgt.gateway.handlers.ext.APIManagerExtensionHandler"/&gt;<br/>   &lt;/handlers&gt;<br/>&lt;/api&gt;</span></pre><p id="56f1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我希望这篇文章有助于理解如何使用lambda函数作为WSO2 API管理器中API的后端。如果有任何问题，或者在试用时遇到任何问题，请在评论区发表。我会尽快回答所有的问题。如果你认为这篇文章是有帮助的，别忘了为它鼓掌，那会让其他人更容易找到它:)。</p><p id="993f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">[1]<a class="ae jp" href="https://github.com/hashanbn/nodejs_lambda" rel="noopener ugc nofollow" target="_blank">https://github.com/hashanbn/nodejs_lambda</a></p><p id="6de0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">[2]<a class="ae jp" href="https://github.com/hashanbn/AWSLambdaClassMediatorWSO2" rel="noopener ugc nofollow" target="_blank">https://github.com/hashanbn/AWSLambdaClassMediatorWSO2</a></p></div></div>    
</body>
</html>