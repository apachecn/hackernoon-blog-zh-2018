<html>
<head>
<title>Get on the Good Foot with MicroPython on the ESP32</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在ESP32上使用MicroPython取得成功</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/get-on-the-good-foot-with-micropython-on-the-esp32-decdd32c4720?source=collection_archive---------7-----------------------#2018-01-09">https://medium.com/hackernoon/get-on-the-good-foot-with-micropython-on-the-esp32-decdd32c4720?source=collection_archive---------7-----------------------#2018-01-09</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/6f2092a81ce68c1fd4589ae5dee664ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vkc1qoy5SKcJLx09OQ6ARA.jpeg"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Photo by <a class="ae ih" href="https://unsplash.com/photos/VawUHVxUvJ4?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Regina Valetova</a> on <a class="ae ih" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><div class=""/><p id="604b" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我将向您展示如何在<a class="ae ih" href="https://en.wikipedia.org/wiki/ESP32" rel="noopener ugc nofollow" target="_blank"> Espressif ESP32 </a>开发板上开始使用<a class="ae ih" href="http://micropython.org/" rel="noopener ugc nofollow" target="_blank"> MicroPython </a>。在本教程的第一部分<em class="kf">中，我将向你展示如何:</em></p><ul class=""><li id="54ea" class="kg kh ik jj b jk jl jo jp js ki jw kj ka kk ke kl km kn ko dt translated">在ESP32上使用<a class="ae ih" href="https://hackernoon.com/tagged/micropython" rel="noopener ugc nofollow" target="_blank"> MicroPython </a>开始运行</li><li id="d5e8" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke kl km kn ko dt translated">连接到WiFi</li><li id="3e04" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke kl km kn ko dt translated">将脚本上传到公告板</li><li id="4b8d" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke kl km kn ko dt translated">读取环境温度(每个人都喜欢这样，对吗？)</li></ul><blockquote class="ku kv kw"><p id="70df" class="jh ji kf jj b jk jl jm jn jo jp jq jr kx jt ju jv ky jx jy jz kz kb kc kd ke hn dt translated">在本教程接下来的第二部分中，我将展示如何发布您用<a class="ae ih" href="https://en.wikipedia.org/wiki/Mqtt" rel="noopener ugc nofollow" target="_blank"> MQTT </a>收集的数据。</p></blockquote><p id="9333" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">本指南期望您具备:</p><ul class=""><li id="9792" class="kg kh ik jj b jk jl jo jp js ki jw kj ka kk ke kl km kn ko dt translated">…熟悉命令行</li><li id="0645" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke kl km kn ko dt translated">…与开发板(如Arduino)接口的基本经验</li><li id="eeab" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke kl km kn ko dt translated">…对用<a class="ae ih" href="https://en.wikipedia.org/wiki/Python_(programming_language)" rel="noopener ugc nofollow" target="_blank"> Python </a>编程的基本理解</li></ul><p id="bb64" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果我掩盖了一些我不应该掩盖的东西，请<a class="ae ih" href="mailto:boneskull@boneskull.com" rel="noopener ugc nofollow" target="_blank">告诉我</a>！</p><p id="49c2" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在我们开始之前，你需要一些东西。</p><h1 id="92cd" class="la lb ik bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">物品清单</h1><p id="395b" class="pw-post-body-paragraph jh ji ik jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">你需要以下几类东西。</p><h1 id="c358" class="la lb ik bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">五金器具</h1><figure class="me mf mg mh fq hw fe ff paragraph-image"><div class="fe ff md"><img src="../Images/29a33a71273e51e013fbf2efa603dded.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*9ndSWj_2ZPZDVG5N.jpg"/></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Not necessarily <em class="mi">this</em> stuff, but same idea. Photo by <a class="ae ih" href="https://flic.kr/p/7b3Bqb" rel="noopener ugc nofollow" target="_blank">Alexandra Cárdenas</a></figcaption></figure><ul class=""><li id="b985" class="kg kh ik jj b jk jl jo jp js ki jw kj ka kk ke kl km kn ko dt translated">一(1)个ESP32开发板，如<a class="ae ih" href="https://www.sparkfun.com/products/13907" rel="noopener ugc nofollow" target="_blank"> SparkFun ESP32 Thing </a>(任何类型均可；都大致相同)</li><li id="69cd" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke kl km kn ko dt translated">TO-92包装中的一(1)个<a class="ae ih" href="https://www.maximintegrated.com/en/products/analog/sensors-and-sensor-interface/DS18B20.html" rel="noopener ugc nofollow" target="_blank"> DS18B20 </a>数字温度计(<a class="ae ih" href="https://cdn.sparkfun.com/datasheets/Sensors/Temp/DS18B20.pdf" rel="noopener ugc nofollow" target="_blank">数据表</a></li><li id="8ee6" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke kl km kn ko dt translated">一(1)个4.7kꭥ电阻器</li><li id="549c" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke kl km kn ko dt translated">四(4)根<a class="ae ih" href="https://en.wikipedia.org/wiki/Jump_wire" rel="noopener ugc nofollow" target="_blank">跳线</a></li><li id="42ca" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke kl km kn ko dt translated">一(1)个400点或更大的试验板</li><li id="310e" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke kl km kn ko dt translated">一(1)根USB微型B电缆</li></ul><p id="28ff" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><em class="kf">如果您需要在开发板上焊接接头引脚:</em>这样做。</p><p id="1227" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><em class="kf">如果你有一个DS18B20“分线板”:</em>这些通常有内置电阻，所以你不需要它。然而，你<em class="kf">将</em>需要找出哪个是哪个。</p><h1 id="a0b1" class="la lb ik bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">软件</h1><p id="6fea" class="pw-post-body-paragraph jh ji ik jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">你需要下载并安装一些软件。其中一些你可能已经安装了。其他的东西可能需要升级。本指南假设你没有千斤顶深蹲。</p><blockquote class="ku kv kw"><p id="48a0" class="jh ji kf jj b jk jl jm jn jo jp jq jr kx jt ju jv ky jx jy jz kz kb kc kd ke hn dt translated">我很抱歉我没有太多的信息给Windows用户！然而，我向你保证，这一切都不是不可能的。</p></blockquote><h2 id="dec4" class="mj lb ik bd lc mk ml mm lg mn mo mp lk js mq mr lo jw ms mt ls ka mu mv lw mw dt translated">VCP司机</h2><p id="bb6a" class="pw-post-body-paragraph jh ji ik jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">如果您运行的是macOS或Windows，您可能需要下载并安装一个虚拟COM端口(VCP)驱动程序，如果您还没有这样做的话。通常，这些板上的USB转串行芯片是一个<a class="ae ih" href="https://www.silabs.com/products/development-tools/software/usb-to-uart-bridge-vcp-drivers" rel="noopener ugc nofollow" target="_blank"> CP210x </a>或<a class="ae ih" href="http://www.ftdichip.com/Drivers/VCP.htm" rel="noopener ugc nofollow" target="_blank">ft 232 rl</a>；查看特定主板的数据手册，或者看看USB端口附近的ic。</p><blockquote class="ku kv kw"><p id="c422" class="jh ji kf jj b jk jl jm jn jo jp jq jr kx jt ju jv ky jx jy jz kz kb kc kd ke hn dt translated">较新的Linux内核支持这些内置芯片，因此不需要安装驱动程序。</p></blockquote><p id="59f8" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">下面是我的一个ESP32开发板上的CP2104示例:</p><figure class="me mf mg mh fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mx"><img src="../Images/1663f40f8402ca101142e9c937097b59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CcAcAv5eFSKdgvLu.jpg"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">A SiLabs CP2104. Thanks, macro lens!</figcaption></figure><p id="17a4" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">要断言驱动程序正在工作，请将您的开发板插入您的计算机。如果你在Linux上，检查<code class="eh my mz na nb b">/dev/ttyUSB0</code>:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="5f49" class="mj lb ik nb b fv ng nh l ni nj">$ ls -l /dev/ttyUSB0<br/>crw-rw---- 1 root dialout 188, 0 Dec 19 17:04 /dev/ttyUSB0</span></pre><p id="415e" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">或者macOS上的<code class="eh my mz na nb b">/dev/tty.SLAB_USBtoUART</code>:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="8ff6" class="mj lb ik nb b fv ng nh l ni nj">$ ls -l /dev/tty.SLAB_USBtoUART<br/>crw-rw-rw-  1 root  wheel   21,  20 Dec 19 17:10 /dev/tty.SLAB_USBtoUART</span></pre><h2 id="7a60" class="mj lb ik bd lc mk ml mm lg mn mo mp lk js mq mr lo jw ms mt ls ka mu mv lw mw dt translated">串行终端</h2><p id="9d51" class="pw-post-body-paragraph jh ji ik jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">一个免费的、跨平台的GUI终端是CoolTerm。Linux的macOS用户可以在命令行中使用<code class="eh my mz na nb b">screen</code>而不受影响。更多专门构建的解决方案包括Python 3附带的<code class="eh my mz na nb b">miniterm</code>，可以通过<code class="eh my mz na nb b">python3 -m serial.tools.miniterm</code>和<code class="eh my mz na nb b">minicom</code>启动。</p><h2 id="0542" class="mj lb ik bd lc mk ml mm lg mn mo mp lk js mq mr lo jw ms mt ls ka mu mv lw mw dt translated">Python等。</h2><p id="48dd" class="pw-post-body-paragraph jh ji ik jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">您还需要:</p><ul class=""><li id="c878" class="kg kh ik jj b jk jl jo jp js ki jw kj ka kk ke kl km kn ko dt translated">python 3.6 . x版</li><li id="63c6" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke kl km kn ko dt translated">对于额外的库，<a class="ae ih" href="https://github.com/micropython/micropython-lib" rel="noopener ugc nofollow" target="_blank">micropython/micropython-lib</a>(<code class="eh my mz na nb b">git clone <a class="ae ih" href="https://github.com/micropython/micropython-lib)" rel="noopener ugc nofollow" target="_blank">https://github.com/micropython/micropython-lib</a></code><a class="ae ih" href="https://github.com/micropython/micropython-lib)" rel="noopener ugc nofollow" target="_blank">)</a>的克隆或归档</li></ul><p id="d5b0" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">根据Python的安装情况，安装方式会有所不同:</p><ul class=""><li id="0e49" class="kg kh ik jj b jk jl jo jp js ki jw kj ka kk ke kl km kn ko dt translated">为了刷新电路板，<a class="ae ih" href="https://pypi.python.org/pypi/esptool/2.2" rel="noopener ugc nofollow" target="_blank"> esptool </a>(版本2.2或更新版本)</li><li id="6f1b" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke kl km kn ko dt translated">管理板上的文件，<a class="ae ih" href="https://pypi.python.org/pypi/adafruit-ampy/1.0.3" rel="noopener ugc nofollow" target="_blank"> adafruit-ampy </a></li></ul><p id="5280" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">你可以试试<code class="eh my mz na nb b">pip3 install esptool adafruit-ampy</code>。这在装有自制软件的macOS上对我有效；YMMV。如果不使用自制软件，你可能需要在前面加上<code class="eh my mz na nb b">sudo</code>。</p><h2 id="d137" class="mj lb ik bd lc mk ml mm lg mn mo mp lk js mq mr lo jw ms mt ls ka mu mv lw mw dt translated">MicroPython固件</h2><p id="4a85" class="pw-post-body-paragraph jh ji ik jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">最后，你需要为ESP32 下载最新的MicroPython固件。</p><p id="c780" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在我们的工具已经准备好了，我们可以开始用MicroPython刷新ESP32板了。</p><h1 id="070d" class="la lb ik bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">闪烁的MicroPython &amp;第一步</h1><p id="65a9" class="pw-post-body-paragraph jh ji ik jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">除非MicroPython已经<em class="kf">安装在您的ESP32上</em>，否则您将希望通过USB将其连接到您的计算机，并擦除其闪存:</p><blockquote class="ku kv kw"><p id="8556" class="jh ji kf jj b jk jl jm jn jo jp jq jr kx jt ju jv ky jx jy jz kz kb kc kd ke hn dt translated">在下面的例子中，用适合您系统的设备或COM端口替换<code class="eh my mz na nb b">/dev/tty.SLAB_USBtoUART</code>。</p></blockquote><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="afb2" class="mj lb ik nb b fv ng nh l ni nj">$ esptool.py --chip esp32 -p /dev/tty.SLAB_USBtoUART erase_flash<br/>esptool.py v2.2<br/>Connecting........___<br/>Chip is ESP32D0WDQ6 (revision 1)<br/>Uploading stub...<br/>Running stub...<br/>Stub running...<br/>Erasing flash (this may take a while)...<br/>Chip erase completed successfully in 4.6s<br/>Hard resetting...</span></pre><p id="f83d" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在，我们可以用之前下载的<a class="ae ih" href="https://micropython.org/download/#esp32" rel="noopener ugc nofollow" target="_blank">固件</a>来刷新它:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="df99" class="mj lb ik nb b fv ng nh l ni nj">$ esptool.py --chip esp32 -p /dev/tty.SLAB_USBtoUART write_flash \<br/>  -z 0x1000 ~/Downloads/esp32-20171219-v1.9.2-445-g84035f0f.bin<br/>esptool.py v2.2<br/>Connecting........_<br/>Chip is ESP32D0WDQ6 (revision 1)<br/>Uploading stub...<br/>Running stub...<br/>Stub running...<br/>Configuring flash size...<br/>Auto-detected Flash size: 4MB<br/>Compressed 936288 bytes to 587495...<br/>Wrote 936288 bytes (587495 compressed) at 0x00001000 in 51.7 seconds (effective 144.8 kbit/s)...<br/>Hash of data verified.</span><span id="79bb" class="mj lb ik nb b fv nk nh l ni nj">Leaving...<br/>Hard resetting...</span></pre><blockquote class="ku kv kw"><p id="8a2e" class="jh ji kf jj b jk jl jm jn jo jp jq jr kx jt ju jv ky jx jy jz kz kb kc kd ke hn dt translated">如果你感到危险，你可以通过使用<code class="eh my mz na nb b">--baud</code>选项来增加闪烁时的波特率。</p></blockquote><p id="7517" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果这行得通，您应该能够通过打开端口进入MicroPython REPL:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="3eac" class="mj lb ik nb b fv ng nh l ni nj"># 115200 is the baud rate at which the REPL communicates<br/>$ screen /dev/tty.SLAB_USBtoUART 115200</span><span id="3b14" class="mj lb ik nb b fv nk nh l ni nj">&gt;&gt;&gt;</span></pre><p id="c4c4" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">恭喜你，<code class="eh my mz na nb b">&gt;&gt;&gt;</code>是你的REPL提示。这类似于普通的Python REPL(例如，不带参数地运行<code class="eh my mz na nb b">python3</code>)。试试<code class="eh my mz na nb b">help()</code>功能:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="4a7b" class="mj lb ik nb b fv ng nh l ni nj">&gt;&gt;&gt; help()<br/>Welcome to MicroPython on the ESP32!</span><span id="8cf4" class="mj lb ik nb b fv nk nh l ni nj">For generic online docs please visit http://docs.micropython.org/</span><span id="a84d" class="mj lb ik nb b fv nk nh l ni nj">For access to the hardware use the 'machine' module:</span><span id="29e7" class="mj lb ik nb b fv nk nh l ni nj">import machine<br/>pin12 = machine.Pin(12, machine.Pin.OUT)<br/>pin12.value(1)<br/>pin13 = machine.Pin(13, machine.Pin.IN, machine.Pin.PULL_UP)<br/>print(pin13.value())<br/>i2c = machine.I2C(scl=machine.Pin(21), sda=machine.Pin(22))<br/>i2c.scan()<br/>i2c.writeto(addr, b'1234')<br/>i2c.readfrom(addr, 4)</span><span id="19f2" class="mj lb ik nb b fv nk nh l ni nj">Basic WiFi configuration:</span><span id="9334" class="mj lb ik nb b fv nk nh l ni nj">import network<br/>sta_if = network.WLAN(network.STA_IF); sta_if.active(True)<br/>sta_if.scan()                             # Scan for available access points<br/>sta_if.connect("&lt;AP_name&gt;", "&lt;password&gt;") # Connect to an AP<br/>sta_if.isconnected()                      # Check for successful connection</span><span id="bd18" class="mj lb ik nb b fv nk nh l ni nj">Control commands:<br/>  CTRL-A        -- on a blank line, enter raw REPL mode<br/>  CTRL-B        -- on a blank line, enter normal REPL mode<br/>  CTRL-C        -- interrupt a running program<br/>  CTRL-D        -- on a blank line, do a soft reset of the board<br/>  CTRL-E        -- on a blank line, enter paste mode</span><span id="b841" class="mj lb ik nb b fv nk nh l ni nj">For further help on a specific object, type help(obj)<br/>For a list of available modules, type help('modules')</span></pre><p id="60a5" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果你以前没在单片机上见过这个:<em class="kf">我知道</em>，疯了吧？</p><p id="2be5" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您可以在“基本WiFi配置”中键入命令进行连接。您将会看到大量来自ESP32的调试信息(您将会看到，这是可以取消的):</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="6655" class="mj lb ik nb b fv ng nh l ni nj">&gt;&gt;&gt; import network<br/>&gt;&gt;&gt; sta_if = network.WLAN(network.STA_IF)<br/>I (323563) wifi: wifi firmware version: 111e74d<br/>I (323563) wifi: config NVS flash: enabled<br/>I (323563) wifi: config nano formating: disabled<br/>I (323563) system_api: Base MAC address is not set, read default base MAC address from BLK0 of EFUSE<br/>I (323573) system_api: Base MAC address is not set, read default base MAC address from BLK0 of EFUSE<br/>I (323593) wifi: Init dynamic tx buffer num: 32<br/>I (323593) wifi: Init data frame dynamic rx buffer num: 64<br/>I (323593) wifi: Init management frame dynamic rx buffer num: 64<br/>I (323603) wifi: wifi driver task: 3ffe1584, prio:23, stack:4096<br/>I (323603) wifi: Init static rx buffer num: 10<br/>I (323613) wifi: Init dynamic rx buffer num: 0<br/>I (323613) wifi: Init rx ampdu len mblock:7<br/>I (323623) wifi: Init lldesc rx ampdu entry mblock:4<br/>I (323623) wifi: wifi power manager task: 0x3ffe84b0 prio: 21 stack: 2560<br/>W (323633) phy_init: failed to load RF calibration data (0x1102), falling back to full calibration<br/>I (323793) phy: phy_version: 362.0, 61e8d92, Sep  8 2017, 18:48:11, 0, 2<br/>I (323803) wifi: mode : null<br/>&gt;&gt;&gt; sta_if.active(True)<br/>I (328553) wifi: mode : sta (30:ae:a4:27:d4:88)<br/>I (328553) wifi: STA_START<br/>True<br/>&gt;&gt;&gt; sta_if.scan()<br/>I (389423) network: event 1<br/>[(b'SON OF ZOLTAR', b"`\xe3'\xcf\xf4\xf5", 1, -57, 4, False), (b'CenturyLink6105', b'`1\x97%\xd9t', 1, -96, 4, False)]<br/>&gt;&gt;&gt; sta_if.connect('SON OF ZOLTAR', '&lt;REDACTED&gt;')<br/>&gt;&gt;&gt; I (689573) wifi: n:1 0, o:1 0, ap:255 255, sta:1 0, prof:1<br/>I (690133) wifi: state: init -&gt; auth (b0)<br/>I (690133) wifi: state: auth -&gt; assoc (0)<br/>I (690143) wifi: state: assoc -&gt; run (10)<br/>I (690163) wifi: connected with SON OF ZOLTAR, channel 1<br/>I (690173) network: event 4<br/>I (691723) event: sta ip: 10.0.0.26, mask: 255.255.255.0, gw: 10.0.0.1<br/>I (691723) network: GOT_IP<br/>I (693143) wifi: pm start, type:0</span><span id="7e0b" class="mj lb ik nb b fv nk nh l ni nj">&gt;&gt;&gt; sta_if.isconnected()<br/>True</span></pre><p id="70cd" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">很酷吧。</p><p id="8c87" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在我们知道我们可以连接到WiFi，让主板每次通电时都进行连接。</p><h1 id="ccaa" class="la lb ik bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">创建MicroPython模块</h1><p id="2aad" class="pw-post-body-paragraph jh ji ik jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">为了在启动时执行任务，MicroPython希望您将代码放在名为<code class="eh my mz na nb b">boot.py</code>的文件中，这是一个MicroPython模块。</p><p id="a894" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">让我们用从MicroPython ESP8266文档的<a class="ae ih" href="http://docs.micropython.org/en/latest/esp8266/esp8266/tutorial/network_basics.html" rel="noopener ugc nofollow" target="_blank">修改的代码创建<code class="eh my mz na nb b">boot.py</code>，替换指定的位置:</a></p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="d332" class="mj lb ik nb b fv ng nh l ni nj">def connect():<br/>    import network<br/>    sta_if = network.WLAN(network.STA_IF)<br/>    if not sta_if.isconnected():<br/>        print('connecting to network...')<br/>        sta_if.active(True)<br/>        sta_if.connect('&lt;YOUR WIFI SSID&gt;', '&lt;YOUR WIFI PASS&gt;')<br/>        while not sta_if.isconnected():<br/>            pass<br/>    print('network config:', sta_if.ifconfig())</span></pre><p id="caff" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们还可以创建一个函数来禁用调试输出。附加到<code class="eh my mz na nb b">boot.py</code>:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="09b0" class="mj lb ik nb b fv ng nh l ni nj">def no_debug():<br/>    import esp<br/>    # this can be run from the REPL as well<br/>    esp.osdebug(None)</span></pre><p id="15bc" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这些函数将在引导时由<em class="kf">定义</em>，但不会自动调用。让我们在让它们自动执行之前测试它们。</p><p id="c00d" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">为此，我们可以上传<code class="eh my mz na nb b">boot.py</code>。您需要关闭与串行端口的连接。如果你使用<code class="eh my mz na nb b">screen</code>，输入<code class="eh my mz na nb b">Ctrl-A Ctrl-\</code>，然后<code class="eh my mz na nb b">y</code>确认；否则断开连接或退出您的终端程序。</p><h1 id="e905" class="la lb ik bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">上传MicroPython模块</h1><p id="70ac" class="pw-post-body-paragraph jh ji ik jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">虽然有其他方法可以做到这一点，但我发现对ESP32来说最直接的方法是使用<a class="ae ih" href="https://github.com/adafruit/ampy" rel="noopener ugc nofollow" target="_blank"> ampy </a>，这是一个由<a class="ae ih" href="https://adafruit.org/" rel="noopener ugc nofollow" target="_blank"> Adafruit </a>开发的通用工具。这是它能做的:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="b46e" class="mj lb ik nb b fv ng nh l ni nj">$ ampy --help</span><span id="90b5" class="mj lb ik nb b fv nk nh l ni nj">Usage: ampy [OPTIONS] COMMAND [ARGS]...</span><span id="3227" class="mj lb ik nb b fv nk nh l ni nj">  ampy - Adafruit MicroPython Tool</span><span id="b807" class="mj lb ik nb b fv nk nh l ni nj">  Ampy is a tool to control MicroPython boards over a serial<br/>  connection.  Using ampy you can manipulate files on the board's<br/>  internal filesystem and even run scripts.</span><span id="67a1" class="mj lb ik nb b fv nk nh l ni nj">Options:<br/>  -p, --port PORT  Name of serial port for connected board.  Can<br/>                   optionally specify with AMPY_PORT environemnt<br/>                   variable.  [required]<br/>  -b, --baud BAUD  Baud rate for the serial connection (default<br/>                   115200).  Can optionally specify with AMPY_BAUD<br/>                   environment variable.<br/>  --version        Show the version and exit.<br/>  --help           Show this message and exit.</span><span id="a909" class="mj lb ik nb b fv nk nh l ni nj">Commands:<br/>  get    Retrieve a file from the board.<br/>  ls     List contents of a directory on the board.<br/>  mkdir  Create a directory on the board.<br/>  put    Put a file or folder and its contents on the...<br/>  reset  Perform soft reset/reboot of the board.<br/>  rm     Remove a file from the board.<br/>  rmdir  Forcefully remove a folder and all its...<br/>  run    Run a script and print its output.</span></pre><p id="9e60" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">MicroPython将文件(脚本或任何合适的东西)存储在一个非常基本的文件系统中。默认情况下，空的<code class="eh my mz na nb b">boot.py</code>应该已经存在。要列出主板上的文件，请执行:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="6f4a" class="mj lb ik nb b fv ng nh l ni nj">$ ampy -p /dev/tty.SLAB_USBtoUART ls<br/>boot.py</span></pre><p id="6b2a" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">使用<code class="eh my mz na nb b">get</code>命令将文件内容回显到您的shell(如果您愿意，可以通过管道传输到文件):</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="71ff" class="mj lb ik nb b fv ng nh l ni nj">$ ampy -p /dev/tty.SLAB_USBtoUART get boot.py<br/># This file is executed on every boot (including wake-boot from deepsleep)</span></pre><p id="bcc7" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们可以用自己的<code class="eh my mz na nb b">boot.py</code>覆盖它:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="4acc" class="mj lb ik nb b fv ng nh l ni nj">$ ampy -p /dev/tty.SLAB_USBtoUART put boot.py</span></pre><p id="3cc8" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">并检索它以查看它是否覆盖了默认的<code class="eh my mz na nb b">boot.py</code>:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="2f50" class="mj lb ik nb b fv ng nh l ni nj">$ ampy -p /dev/tty.SLAB_USBtoUART get boot.py<br/>def connect():<br/>    import network<br/>    sta_if = network.WLAN(network.STA_IF)<br/>    if not sta_if.isconnected():<br/>        print('connecting to network...')<br/>        sta_if.active(True)<br/>        sta_if.connect('&lt;YOUR WIFI SSID&gt;', '&lt;YOUR WIFI PASS&gt;')<br/>        while not sta_if.isconnected():<br/>            pass<br/>    print('network config:', sta_if.ifconfig())</span><span id="133f" class="mj lb ik nb b fv nk nh l ni nj">def no_debug():<br/>    import esp<br/>    # this can be run from the REPL as well<br/>    esp.osdebug(None)</span></pre><p id="f28c" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">成功！这就是用<code class="eh my mz na nb b">ampy</code>上传文件的要领。你也可以上传整个文件夹，我们稍后会看到。</p><p id="7207" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">从这里，我们可以再次打开REPL，并运行我们的代码。不需要重启主板！</p><h1 id="7e90" class="la lb ik bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">运行MicroPython模块</h1><p id="91c9" class="pw-post-body-paragraph jh ji ik jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated"><strong class="jj il">在下面的例子中，为了便于复制&amp;粘贴，我将从REPL的代码运行中删除命令提示符(</strong> <code class="eh my mz na nb b"><strong class="jj il">&gt;&gt;&gt;</strong></code> <strong class="jj il">)。</strong></p><p id="b349" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">重新连接到REPL。</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="2b33" class="mj lb ik nb b fv ng nh l ni nj">$ screen /dev/tty.SLAB_USBtoUART 115200</span></pre><p id="75b3" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">首先，我们将断开WiFi连接:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="e2dd" class="mj lb ik nb b fv ng nh l ni nj">import network<br/>sta_if = network.WLAN(network.STA_IF)<br/>sta_if.disconnect()</span></pre><p id="800d" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">调试输出如下:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="ca6c" class="mj lb ik nb b fv ng nh l ni nj">I (3299583) wifi: state: run -&gt; init (0)<br/>I (3299583) wifi: n:1 0, o:1 0, ap:255 255, sta:1 0, prof:1<br/>I (3299583) wifi: pm stop, total sleep time: 0/-1688526567<br/>I (3299583) wifi: STA_DISCONNECTED, reason:8</span></pre><p id="5933" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">然后，我们可以<code class="eh my mz na nb b">import</code>这个<code class="eh my mz na nb b">boot</code>模块。这将使我们的<code class="eh my mz na nb b">connect</code>和<code class="eh my mz na nb b">no_debug</code>功能可用。</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="19ae" class="mj lb ik nb b fv ng nh l ni nj">import boot<br/>connect()</span></pre><p id="e245" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">输出:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="4f4f" class="mj lb ik nb b fv ng nh l ni nj">connecting to network...<br/>I (87841) wifi: n:1 0, o:1 0, ap:255 255, sta:1 0, prof:1<br/>I (88401) wifi: state: init -&gt; auth (b0)<br/>I (88401) wifi: state: auth -&gt; assoc (0)<br/>I (88411) wifi: state: assoc -&gt; run (10)<br/>I (88441) wifi: connected with SON OF ZOLTAR, channel 1<br/>I (88441) network: event 4<br/>I (90081) event: sta ip: 10.0.0.26, mask: 255.255.255.0, gw: 10.0.0.1<br/>I (90081) network: GOT_IP<br/>network config: ('10.0.0.26', '255.255.255.0', '10.0.0.1', '10.0.0.1')<br/>I (91411) wifi: pm start, type:0</span></pre><p id="554b" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">超级棒。让我们安静下来，再试一次:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="b598" class="mj lb ik nb b fv ng nh l ni nj">no_debug()<br/>sta_if.disconnect()<br/>connect()</span></pre><p id="0a36" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">输出:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="b740" class="mj lb ik nb b fv ng nh l ni nj">connecting to network...<br/>network config: ('10.0.0.26', '255.255.255.0', '10.0.0.1', '10.0.0.1')</span></pre><p id="c110" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">LGTM。</p><blockquote class="ku kv kw"><p id="b34d" class="jh ji kf jj b jk jl jm jn jo jp jq jr kx jt ju jv ky jx jy jz kz kb kc kd ke hn dt translated">上述IP地址取决于您的本地网络配置，可能会有所不同。</p></blockquote><p id="eb5a" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">从端口断开(如果使用<code class="eh my mz na nb b">screen</code> : <code class="eh my mz na nb b">Ctrl-A Ctrl-\</code>，<code class="eh my mz na nb b">y</code>)，并将这些行附加到<code class="eh my mz na nb b">boot.py</code>:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="dc68" class="mj lb ik nb b fv ng nh l ni nj">no_debug()<br/>connect()</span></pre><p id="1c89" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">通过<code class="eh my mz na nb b">ampy put boot.py</code>再次上传，将会覆盖现有的<code class="eh my mz na nb b">boot.py</code>。硬重置(“按下按钮”)或重启主板。重新连接到REPL，并执行<code class="eh my mz na nb b">connect()</code>以断言连通性:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="a30a" class="mj lb ik nb b fv ng nh l ni nj">connect()</span></pre><p id="8f0c" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">输出:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="07db" class="mj lb ik nb b fv ng nh l ni nj">network config: ('10.0.0.26', '255.255.255.0', '10.0.0.1', '10.0.0.1')</span></pre><p id="05bb" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">你会注意到“连接到网络…”没有打印到控制台；如果已经连接，<code class="eh my mz na nb b">connect()</code>功能打印配置并返回。如果您已经做到这一步，那么您的主板在启动时成功连接到Wifi。干得好！</p><p id="d79c" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们现在还有两个项目要核对，除非你忘了我们要做什么:</p><ol class=""><li id="3000" class="kg kh ik jj b jk jl jo jp js ki jw kj ka kk ke nl km kn ko dt translated">我们需要每隔一段时间读取环境温度。</li><li id="0640" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke nl km kn ko dt translated">我们需要将这些信息发布给一个MQTT代理。</li></ol><p id="5467" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">接下来，我们将剔除温度读数。</p><h1 id="dc3c" class="la lb ik bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">MicroPython中的温度读数</h1><p id="8781" class="pw-post-body-paragraph jh ji ik jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">当我们编写代码时，我们可以使用REPL来进行实验。</p><p id="92b5" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我用的是这里的例子<a class="ae ih" href="https://docs.micropython.org/en/latest/esp8266/esp8266/tutorial/onewire.html#controlling-1-wire-devices" rel="noopener ugc nofollow" target="_blank"/>。您需要导入三(3)个模块，<code class="eh my mz na nb b">machine</code>、<code class="eh my mz na nb b">onewire</code>和<code class="eh my mz na nb b">ds18x20</code>(注意<code class="eh my mz na nb b">x</code>):</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="a6bd" class="mj lb ik nb b fv ng nh l ni nj">import machine, onewire, ds18x20</span></pre><p id="14b0" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我已经将我的传感器连接到我的ESP32上的第12针。你的试验板应该看起来像这样:</p><figure class="me mf mg mh fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nm"><img src="../Images/fa194907a353e8729a0ad9f3e73301d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*u1fSZyHh7yfIg8Oe.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Example breadboard wiring for ESP32 dev board and DS18B20</figcaption></figure><p id="7b42" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">为了读取温度，我们将创建一个类似<a class="ae ih" href="https://en.wikipedia.org/wiki/Matryoshka_doll" rel="noopener ugc nofollow" target="_blank">套娃</a>的对象，方法是将一个<code class="eh my mz na nb b">Pin</code>实例传递给一个<code class="eh my mz na nb b">OneWire</code>构造函数(阅读关于<a class="ae ih" href="https://en.wikipedia.org/wiki/1-Wire" rel="noopener ugc nofollow" target="_blank">单线</a>的内容)并最终传递给一个<code class="eh my mz na nb b">DS18X20</code>构造函数:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="0bb5" class="mj lb ik nb b fv ng nh l ni nj">pin = machine.Pin(12)<br/>wire = onewire.OneWire(pin)<br/>ds = ds18x20.DS18X20(wire)</span></pre><blockquote class="ku kv kw"><p id="428c" class="jh ji kf jj b jk jl jm jn jo jp jq jr kx jt ju jv ky jx jy jz kz kb kc kd ke hn dt translated">请注意，如果以下命令的输出是一个空列表(<code class="eh my mz na nb b">[]</code>)，则无法找到传感器。检查你的线路！</p></blockquote><p id="b40d" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在，我们可以让<code class="eh my mz na nb b">ds</code>扫描连接的设备，并返回它们的地址:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="0543" class="mj lb ik nb b fv ng nh l ni nj">ds.scan()</span></pre><p id="93c1" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">输出:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="a645" class="mj lb ik nb b fv ng nh l ni nj">[bytearray(b'(\xee3\x0c"\x15\x004')]</span></pre><p id="3429" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><code class="eh my mz na nb b">ds.scan()</code>以<code class="eh my mz na nb b">bytearray</code>格式返回设备地址的<code class="eh my mz na nb b">list</code>。你的可能看起来略有不同。因为我们只有一个，所以我们可以将它的地址保存到一个变量中。为了读取温度数据，我们通过<code class="eh my mz na nb b">ds.convert_temp()</code>告诉1线总线复位，暂停750毫秒(如果你正在粘贴这个):</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="6fa4" class="mj lb ik nb b fv ng nh l ni nj">import time<br/>addr = ds.scan().pop()<br/>ds.convert_temp()<br/>time.sleep_ms(750)<br/>temp = ds.read_temp(addr)<br/>temp</span></pre><p id="f3dd" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">输出:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="a025" class="mj lb ik nb b fv ng nh l ni nj">19.875</span></pre><p id="6996" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这个读数是摄氏度。如果你和我一样，你不会说摄氏，所以也许你想把它转换成华氏:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="7304" class="mj lb ik nb b fv ng nh l ni nj">(temp * 1.8) + 32</span></pre><p id="9155" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">输出:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="8600" class="mj lb ik nb b fv ng nh l ni nj">67.775</span></pre><p id="4264" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">…这正是我所期望的！</p><p id="5538" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">让我们利用我们所做的创建一个新文件，<code class="eh my mz na nb b">temperature.py</code>:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="f4b8" class="mj lb ik nb b fv ng nh l ni nj">import time<br/>from machine import Pin<br/>from onewire import OneWire<br/>from ds18x20 import DS18X20<br/></span><span id="1730" class="mj lb ik nb b fv nk nh l ni nj">class TemperatureSensor:<br/>    """<br/>    Represents a Temperature sensor<br/>    """<br/>    def __init__(self, pin):<br/>        """<br/>        Finds address of single DS18B20 on bus specified by `pin`<br/>        :param pin: 1-Wire bus pin<br/>        :type pin: int<br/>        """<br/>        self.ds = DS18X20(OneWire(Pin(pin)))<br/>        addrs = self.ds.scan()<br/>        if not addrs:<br/>            raise Exception('no DS18B20 found at bus on pin %d' % pin)<br/>        # save what should be the only address found<br/>        self.addr = addrs.pop()</span><span id="8a23" class="mj lb ik nb b fv nk nh l ni nj">    def read_temp(self, fahrenheit=True):<br/>        """<br/>        Reads temperature from a single DS18X20<br/>        :param fahrenheit: Whether or not to return value in Fahrenheit<br/>        :type fahrenheit: bool<br/>        :return: Temperature<br/>        :rtype: float<br/>        """<br/>        self.ds.convert_temp()<br/>        time.sleep_ms(750)<br/>        temp = self.ds.read_temp(self.addr)<br/>        if fahrenheit:<br/>            return self.c_to_f(temp)<br/>        return temp</span><span id="22ed" class="mj lb ik nb b fv nk nh l ni nj">    @staticmethod<br/>    def c_to_f(c):<br/>        """<br/>        Converts Celsius to Fahrenheit<br/>        :param c: Temperature in Celsius<br/>        :type c: float<br/>        :return: Temperature in Fahrenheit<br/>        :rtype: float<br/>        """<br/>        return (c * 1.8) + 32</span></pre><p id="8a6c" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">断开与REPL的连接。通过<code class="eh my mz na nb b">ampy</code>上传<code class="eh my mz na nb b">temperature.py</code>:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="37d5" class="mj lb ik nb b fv ng nh l ni nj">$ ampy -p /dev/tty.SLAB_USBtoUART put temperature.py</span></pre><p id="da01" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">然后我们可以再次打开我们的REPL，并尝试它:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="e8a8" class="mj lb ik nb b fv ng nh l ni nj">from temperature import TemperatureSensor<br/>t = TemperatureSensor(12)<br/>t.read_temp() # use t.read_temp(False) to return Celsius</span></pre><p id="fe7e" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">似乎变暖了一点。输出:</p><pre class="me mf mg mh fq nc nb nd ne aw nf dt"><span id="4749" class="mj lb ik nb b fv ng nh l ni nj">68.7875</span></pre><p id="36f6" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">干得好！</p><h1 id="9c94" class="la lb ik bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">第一部分的结论(1)</h1><p id="0608" class="pw-post-body-paragraph jh ji ik jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">在本教程的第一部分，我们学习了如何:</p><ol class=""><li id="02ef" class="kg kh ik jj b jk jl jo jp js ki jw kj ka kk ke nl km kn ko dt translated">使用MicroPython刷新ESP32开发板</li><li id="9eca" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke nl km kn ko dt translated">使用MicroPython的REPL进行实验</li><li id="3b13" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke nl km kn ko dt translated">将ESP32连接到WiFi</li><li id="64db" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke nl km kn ko dt translated">上传和执行MicroPython脚本</li><li id="ade8" class="kg kh ik jj b jk kp jo kq js kr jw ks ka kt ke nl km kn ko dt translated">用单线DS18B20传感器读取温度</li></ol><p id="add2" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在本教程接下来的第二部分中，我们将了解MQTT，如何将我们的温度数据发布到MQTT代理，以及如何与基于MQTT的云“物联网平台”进行交互。</p><p id="fefc" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><em class="kf">本文</em> <a class="ae ih" href="https://boneskull.com/micropython-on-esp32-part-1/" rel="noopener ugc nofollow" target="_blank"> <em class="kf">原载</em></a><em class="kf">2018年1月8日</em><a class="ae ih" href="https://boneskull.com" rel="noopener ugc nofollow" target="_blank"><em class="kf">【boneskull.com】</em></a><em class="kf">。</em></p><figure class="me mf mg mh fq hw"><div class="bz el l di"><div class="nn no l"/></div></figure></div></div>    
</body>
</html>