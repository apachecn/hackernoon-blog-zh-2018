<html>
<head>
<title>DIY Prisma, Fast Style Transfer app — with CoreML and TensorFlow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DIY Prisma，快速风格转换应用程序—使用CoreML和TensorFlow</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/diy-prisma-fast-style-transfer-app-with-coreml-and-tensorflow-817c3b90dacd?source=collection_archive---------6-----------------------#2018-01-13">https://medium.com/hackernoon/diy-prisma-fast-style-transfer-app-with-coreml-and-tensorflow-817c3b90dacd?source=collection_archive---------6-----------------------#2018-01-13</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/a461e6b10f6d6eb1adc5a7393b5219b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3pT4W5JZphTdJtEzpXZtDQ.jpeg"/></div></div></figure><p id="9b66" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用CoreML、快速风格转换和TensorFlow创建一个类似Prisma的iOS应用程序。</p><h2 id="857f" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">目录:</h2><ul class=""><li id="1187" class="kw kx hu je b jf ky jj kz jn la jr lb jv lc jz ld le lf lg dt translated">介绍和设置</li><li id="e32d" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">初步步骤</li><li id="19b1" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">CoreML转换</li><li id="8eef" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">iOS应用程序</li></ul><h1 id="559b" class="lm kc hu bd kd ln lo lp kh lq lr ls kl lt lu lv ko lw lx ly kr lz ma mb ku mc dt translated">介绍</h1><p id="ba19" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn md jp jq jr me jt ju jv mf jx jy jz hn dt translated">本教程的基础来自<a class="ae mg" href="https://blog.prismalabs.ai/diy-prisma-app-with-coreml-6b4994cc99e1" rel="noopener ugc nofollow" target="_blank"> Prisma Lab的博客</a>和他们的PyTorch方法。但是，我们将对模型使用TensorFlow，特别是Logan Engstrom的<a class="ae mg" href="https://github.com/lengstrom/fast-style-transfer" rel="noopener ugc nofollow" target="_blank">快速风格转移</a>，这是一个<a class="ae mg" href="https://medium.mybridge.co/30-amazing-machine-learning-projects-for-the-past-year-v-2018-b853b8621ac7" rel="noopener ugc nofollow" target="_blank"> MyBridge Top 30 (#7) </a>。</p><p id="f5c1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">本教程的结果将是一个可以使用CoreML运行TensorFlow模型的<a class="ae mg" href="https://hackernoon.com/tagged/ios" rel="noopener ugc nofollow" target="_blank"> iOS </a>应用程序。<a class="ae mg" href="https://github.com/mdramos/fast-style-transfer-coreml" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv">这里是GitHub repo</strong></a><strong class="je hv"/>—这也包含了对fst &amp; tf-coreml的所有调整和添加。</p><p id="61f3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">是什么让这成为可能？</p><ul class=""><li id="607f" class="kw kx hu je b jf jg jj jk jn mh jr mi jv mj jz ld le lf lg dt translated"><a class="ae mg" href="http://cs.stanford.edu/people/jcjohns/eccv16/" rel="noopener ugc nofollow" target="_blank">斯坦福研究公司</a></li><li id="2198" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae mg" href="https://github.com/lengstrom/fast-style-transfer" rel="noopener ugc nofollow" target="_blank">快速风格转换</a></li><li id="50b0" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae mg" href="https://developer.apple.com/documentation/coreml" rel="noopener ugc nofollow" target="_blank">苹果的CoreML</a><em class="ka">*不支持TensorFlow </em></li><li id="8198" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae mg" href="https://www.tensorflow.org/mobile/tflite/" rel="noopener ugc nofollow" target="_blank"> Google发布tensor flow Lite</a><em class="ka">*不支持CoreML </em></li><li id="1357" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae mg" href="https://developers.googleblog.com/2017/12/announcing-core-ml-support.html" rel="noopener ugc nofollow" target="_blank">谷歌发布CoreML支持</a><em class="ka">*不提供全面支持</em></li><li id="9b12" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">我们做了一些调整，拼凑出一个解决方案</li></ul><h1 id="ff5b" class="lm kc hu bd kd ln lo lp kh lq lr ls kl lt lu lv ko lw lx ly kr lz ma mb ku mc dt translated">设置</h1><p id="4d7a" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn md jp jq jr me jt ju jv mf jx jy jz hn dt translated"><strong class="je hv">模型:</strong>我们将使用fst的预训练模型，定制模型也可以(你需要做一些小的调整，我会注意到的)。<a class="ae mg" href="https://drive.google.com/drive/folders/0B9jhaT37ydSyRk9UX0wwX3BpMzQ?usp=sharing" rel="noopener ugc nofollow" target="_blank">下载预先训练好的模型。</a></p><p id="41d7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">快速风格转换:</strong><a class="ae mg" href="https://github.com/lengstrom/fast-style-transfer" rel="noopener ugc nofollow" target="_blank">https://github.com/lengstrom/fast-style-transfer</a><em class="ka">*如果需要，克隆并运行设置</em></p><p id="4fdd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv"> TensorFlow: </strong>使用fst，我使用TensorFlow 1.0.0取得了最大的成功，而使用tf-corml，你需要1.1.0或更高版本<em class="ka">*本教程不需要使用GPU</em></p><p id="1801" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">【https://github.com/tf-coreml/tf-coreml】<em class="ka">*安装说明</em></p><p id="0e03" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">iOS:</strong>11<strong class="je hv">T13】Xcode:</strong>9<br/>T16】Python:2.7</p><h1 id="6073" class="lm kc hu bd kd ln lo lp kh lq lr ls kl lt lu lv ko lw lx ly kr lz ma mb ku mc dt translated">初步步骤</h1><p id="f629" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn md jp jq jr me jt ju jv mf jx jy jz hn dt translated">我们需要做一些准备工作，因为快速风格转移更多的是一个研究实现，而不是为重用和生产而做的(没有命名约定或输出图)。</p><p id="f54a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">步骤1: </strong>第一步是为我们的图找出输出节点的名称；未明确设置时，TensorFlow会自动生成此值。我们可以通过在evaluate.py脚本中打印net来获得它。</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="66d2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">之后，我们可以运行脚本来查看打印输出。我在这里使用的是预先训练好的模型<em class="ka">波</em>。如果你使用定制模型，检查点参数只需要是你的元文件和输入文件所在的目录。</p><pre class="mk ml mm mn fq mq mr ms mt aw mu dt"><span id="db72" class="kb kc hu mr b fv mv mw l mx my">$ python evaluate.py --checkpoint wave.ckpt --in-path inputs/ --out-path outputs/ </span><span id="0103" class="kb kc hu mr b fv mz mw l mx my">&gt; Tensor(“add_37:0”, shape=(20, 720, 884, 3), dtype=float32, device=/device:GPU:0)</span></pre><p id="57fb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这里唯一重要的数据是输出节点名，即<strong class="je hv"> add_37 </strong>。这是有意义的，因为网络中最后一个未命名的操作符是加法。</p><p id="d098" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">第二步:</strong>我们需要对evaluate.py再做一些补充，这样就可以把图形保存到磁盘上了。请注意，如果您使用自己的模型，您将需要添加代码来满足检查点目录条件，而不是单个检查点文件。</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="d69c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">第三步:</strong>现在我们在一个模型上运行evaluate.py，我们将保存我们的图形文件。* <em class="ka">在训练模型时，我们可能会使用大于1的批处理大小以及GPU，但是CoreML只接受输入大小为1的图形，以及CPU优化—请注意要调整的evaluate命令。</em></p><pre class="mk ml mm mn fq mq mr ms mt aw mu dt"><span id="1e4c" class="kb kc hu mr b fv mv mw l mx my">$ python evaluate.py --checkpoint wave/wave.ckpt --in-path inputs/ --out-path outputs/ --device “/cpu:0” --batch-size 1</span></pre><p id="dda5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">太棒了，这创建了output_graph.pb &amp;我们可以继续进行CoreML转换了。</p><h1 id="3d57" class="lm kc hu bd kd ln lo lp kh lq lr ls kl lt lu lv ko lw lx ly kr lz ma mb ku mc dt translated">CoreML转换</h1><p id="583e" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn md jp jq jr me jt ju jv mf jx jy jz hn dt translated">感谢<a class="ae mg" href="https://hackernoon.com/tagged/google" rel="noopener ugc nofollow" target="_blank"> google </a>，现在有了一个TensorFlow到CoreML的转换器:<a class="ae mg" href="https://github.com/tf-coreml/tf-coreml" rel="noopener ugc nofollow" target="_blank">https://github.com/tf-coreml/tf-coreml</a>。这很棒，但是实现是新的，缺少一些核心的tf操作，比如<em class="ka"> power。</em></p><p id="46dc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">第一步:</strong>我们的模型如果不增加对<em class="ka"> power、</em>的支持就不会转换，但幸运的是苹果的<a class="ae mg" href="https://apple.github.io/coremltools/generated/coremltools.models.neural_network.html?highlight=add_unary#coremltools.models.neural_network.NeuralNetworkBuilder.add_unary" rel="noopener ugc nofollow" target="_blank"> coremltools提供了支持power的一元转换</a>。我们需要将这段代码添加到TensorFlow的实现中。以下是你需要添加的3个文件的要点。</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="b0c0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">步骤2: </strong>创建并运行转换脚本</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><pre class="mk ml mm mn fq mq mr ms mt aw mu dt"><span id="df32" class="kb kc hu mr b fv mv mw l mx my">$ python convert.py</span></pre><figure class="mk ml mm mn fq iv fe ff paragraph-image"><div class="fe ff na"><img src="../Images/caab29f776499efc7338bc2d0a78de48.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*_Ezdp_IRuhVOq8LfFXedHQ.png"/></div></figure><p id="661c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">实际的CoreML转换器不提供从模型输出图像的功能。图像由NumPy数组(多维数组)表示，这是实际的输出，并在Swift中编译成非标准类型的多数组。我在网上搜索帮助，找到了一些评估CoreML输出的图形的代码，然后遍历它，将输出类型转换成图像。</p><p id="e8b3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">步骤3: </strong>在上面输出的模型(my_model.mlmodel)上创建并运行输出转换脚本。</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><pre class="mk ml mm mn fq mq mr ms mt aw mu dt"><span id="81f7" class="kb kc hu mr b fv mv mw l mx my">$ python output.py</span></pre><p id="0c8c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">还有…..🎉💥🤙 …..我们有一个工作的CoreML模型。* <em class="ka">我在输出脚本中将它的名称改为“wave ”,图像大小也与评估输入相对应。</em></p><figure class="mk ml mm mn fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nb"><img src="../Images/5ea70e011fe132c83f9e9f4718fd41c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9fpbWBb_nUYnZirf077H8A.png"/></div></div></figure><h1 id="3989" class="lm kc hu bd kd ln lo lp kh lq lr ls kl lt lu lv ko lw lx ly kr lz ma mb ku mc dt translated">iOS应用程序</h1><p id="1401" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn md jp jq jr me jt ju jv mf jx jy jz hn dt translated">与其说这是一个iOS教程，不如说你会想与我的回购工作。这里我只涉及重要的细节。</p><p id="fc64" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">步骤1: </strong>将模型导入到您的Xcode项目中。确保将它们添加到目标中。</p><p id="6be1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">步骤2: </strong>导入后，您将能够实例化模型，如下所示:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="025b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">第三步:</strong>为模型输入参数创建一个类，这个类是MLFeatureProvider。<em class="ka"> *img_placeholder是评估脚本</em>中定义的输入</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="5e48" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">第四步:现在我们可以在代码中调用这个模型了。</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="0f71" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">最终:</strong>app剩下的只是设置和图像处理。没什么新的或者和CoreML直接相关的，这里就不赘述了。此时，您将会很好地理解所有东西是如何组合在一起的，并且应该能够进一步创新。我认为fst的图表还有改进的余地。我们应该能够剔除过度设计的操作，让iOS上的风格转换更快。但是现在一切都很好。</p><figure class="mk ml mm mn fq iv fe ff paragraph-image"><div class="fe ff nc"><img src="../Images/e7845202d0e5d1449437dcb58fca0923.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*cFnS6dqFLGlVwHXybpbXMg.png"/></div></figure><p id="7d32" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt">✌️🤙</p><blockquote class="nd"><p id="8f2d" class="ne nf hu bd ng nh ni nj nk nl nm jz ek translated">跟我来</p></blockquote><figure class="nn no np nq nr iv"><div class="bz el l di"><div class="ns mp l"/></div></figure></div></div>    
</body>
</html>