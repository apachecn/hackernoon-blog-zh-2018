<html>
<head>
<title>Migrating your Node.js REST API to Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Node.js REST API迁移到无服务器</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/migrating-your-node-js-rest-api-to-serverless-d2a170e0856c?source=collection_archive---------9-----------------------#2018-01-15">https://medium.com/hackernoon/migrating-your-node-js-rest-api-to-serverless-d2a170e0856c?source=collection_archive---------9-----------------------#2018-01-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/8d5716738001f3933945645aeae4a7e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5UL0AphTuLNdlLnVsd-7Nw.jpeg"/></div></div></figure><div class=""/><p id="b6e8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我已经涉足了相当一部分无服务器的黑暗艺术。深入探讨没有专用服务器或您可以称之为自己的实例的各种利弊。即使严格来说他们不是。他们只是在漂浮在<em class="ka">云端</em>的某个秘密服务器农场里。</p><p id="21bf" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">许多用例让云提供商处理服务器管理、扩展和运行时间是有意义的。你是一个开发人员，为什么你需要用命令行来弄脏你的手。恶，终端！如何再次退出Vim？<em class="ka">*颤抖* </em></p><p id="25b9" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">相信我，学习新事物并不容易。我绝不是一个高于平均水平的开发者。学习是困难的，即使你是一个开发者，并且习惯于学习新事物。将您的思维模式转变为使用无服务器架构是一项不小的壮举。以下是我对慢慢开始的看法。我将向您展示如何使用您已经熟悉的代码，并将其应用于无服务器环境。</p><p id="f427" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你有一个应用程序在生产，你可以大幅削减成本。由于使用无服务器架构的自动伸缩特性，您可以放心，它将始终为访问您的API的所有用户提供服务。所以，如果你成功了，并且成为了Tech Crunch的主角，用户的涌入不会破坏你所有的服务器，让你的用户无所事事。双关语。</p><h1 id="db8a" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">从服务器到无服务器</h1><p id="078e" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">我们的目标是利用现有的Express API，对其稍加编辑，通过无服务器框架部署到AWS。我希望你已经有了一个AWS帐户，并且已经在你的机器上安装了无服务器框架。如果没有，请检查<a class="ae le" href="https://hackernoon.com/a-crash-course-on-serverless-with-node-js-632b37d58b44" rel="noopener ugc nofollow" target="_blank">这个</a>并按照步骤设置无服务器框架的安装。否则，如果你更喜欢屏幕投射，<a class="ae le" href="https://www.packtpub.com/web-development/serverless-javascript-example-video" rel="noopener ugc nofollow" target="_blank">这里有</a>一个课程，我通过视频解释它。</p><h2 id="a6b6" class="lf kc if bd kd lg lh li kh lj lk ll kl jn lm ln kp jr lo lp kt jv lq lr kx ls dt translated">让我们建立一个老派的服务器</h2><p id="dbc6" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">我冒昧地用Express REST API创建了一个小的repo。这是我以前的一篇文章<a class="ae le" href="https://hackernoon.com/restful-api-design-with-node-js-26ccf66eab09" rel="noopener ugc nofollow" target="_blank">中的一篇，你可能读过。我使用现有的Express API的目的是为了展示将它移植到无服务器是多么容易。</a></p><p id="d487" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先，让我们将回购克隆到我们的机器上。我们正在抓<code class="eh lt lu lv lw b">dev</code>分支，在那里我已经设置了所有必要的模块和配置。</p><pre class="lx ly lz ma fq mb lw mc md aw me dt"><span id="03e4" class="lf kc if lw b fv mf mg l mh mi">$ git clone -b dev https://github.com/adnanrahic/nodejs-restful-api.git</span></pre><p id="c73c" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这将把回购克隆到一个名为<code class="eh lt lu lv lw b">nodejs-restful-api</code>的目录中。在您选择的代码编辑器中打开它。我们有些工作要做。</p><p id="39d5" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最重要的是。安装节点模块。</p><pre class="lx ly lz ma fq mb lw mc md aw me dt"><span id="29be" class="lf kc if lw b fv mf mg l mh mi">$ npm install</span></pre><p id="1941" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">运行<code class="eh lt lu lv lw b">npm install</code>将安装来自<strong class="je ig"> package.json </strong>文件的所有模块。不会超过几秒钟。</p><p id="947b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">完成后，我们需要配置数据库连接。我们将它保存在<strong class="je ig"> db.js </strong>文件中。打开它，你会看到<strong class="je ig">mongose</strong>正在连接到一个数据库连接URL，我们将它保存在一个环境变量中。</p><pre class="lx ly lz ma fq mb lw mc md aw me dt"><span id="53e4" class="lf kc if lw b fv mf mg l mh mi">// db.js</span><span id="de92" class="lf kc if lw b fv mj mg l mh mi">var mongoose = require('mongoose');<br/>mongoose.connect(<strong class="lw ig">process.env.DB</strong>, { useMongoClient: true });</span></pre><p id="ae26" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们在一个<strong class="je ig">中设置这个环境变量。env </strong>文件。存在一个名为<strong class="je ig"> sample.variables.env </strong>的样本文件。让我们打开它，并将其重命名为<strong class="je ig"> variables.env </strong>。</p><pre class="lx ly lz ma fq mb lw mc md aw me dt"><span id="dda4" class="lf kc if lw b fv mf mg l mh mi">// variables.env</span><span id="3ebd" class="lf kc if lw b fv mj mg l mh mi">DB=mongodb://localhost:27017/test</span></pre><p id="ba1c" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">默认连接被设置为MongoDB的本地实例。您可以使用任何想要的连接URL。<a class="ae le" href="https://www.mongodb.com/cloud/atlas" rel="noopener ugc nofollow" target="_blank"> MongoDB Atlas </a>或者<a class="ae le" href="https://mlab.com/" rel="noopener ugc nofollow" target="_blank"> mLab </a>都可以。</p><p id="a877" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig"> <em class="ka">注意</em> </strong> <em class="ka">:如果您想按照本教程中的代码进行操作，请创建一个MongoDB Atlas数据库集群。一旦我们将应用程序部署到AWS，就会用到它。你可以跟随教程</em> <a class="ae le" href="https://hackernoon.com/building-a-serverless-rest-api-with-node-js-and-mongodb-2e0ed0638f47" rel="noopener ugc nofollow" target="_blank"> <em class="ka">这里的</em> </a> <em class="ka">来学习如何创建一个Atlas集群或者</em> <a class="ae le" href="https://hackernoon.com/restful-api-design-with-node-js-26ccf66eab09" rel="noopener ugc nofollow" target="_blank"> <em class="ka">这个</em> </a> <em class="ka">教程来创建一个mLab实例。</em></p><p id="1950" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">剩下要做的就是运行服务器。跳回终点。</p><pre class="lx ly lz ma fq mb lw mc md aw me dt"><span id="d0e2" class="lf kc if lw b fv mf mg l mh mi">$ node server.js</span></pre><p id="b53a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您添加了一个有效的数据库连接URL，它应该将<code class="eh lt lu lv lw b">Express server listening on port 3000</code>返回到命令行。</p><p id="0a7d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用失眠症，我将快速地向数据库添加一个新用户。</p><figure class="lx ly lz ma fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mk"><img src="../Images/04ba986504f2eefad08e09ad6d086b32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kyp_64_iPwvgAY33FIIpSA.png"/></div></div></figure><p id="39a8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">不要忘记选择<strong class="je ig">“表单URL编码”</strong>作为内容类型。更改方法以获取和移除请求正文。现在检查用户添加是否正确。</p><figure class="lx ly lz ma fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mk"><img src="../Images/e8940ed49234c7c7b268800682c22641.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Sitbvbc4R5Lpoj-PKrfOsw.png"/></div></div></figure><p id="28fd" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">似乎是对的。约翰活得好好的。</p><p id="9bcf" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在服务器和运行的Express API上使用这种传统方法非常适合各种用例。但是，即使你没有任何真正的用户吞吐量，你也必须为此付费。但危险的是，如果你突然有大量用户涌入，你就必须手动调整规模。那一点也不好玩。无服务器自动为您做到这一点！</p><h2 id="e242" class="lf kc if bd kd lg lh li kh lj lk ll kl jn lm ln kp jr lo lp kt jv lq lr kx ls dt translated">迁移到无服务器</h2><p id="1bd7" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">您猜怎么着，您可以使用上面的代码，通过无服务器框架将它部署到AWS，只需做一些小的改动。实际上，您只是替换了<strong class="je ig"> server.js </strong>文件中的几行，并安装了一个模块。最后，添加一个名为<strong class="je ig"> serverless.yml </strong>的无服务器配置文件。就是这样！</p><pre class="lx ly lz ma fq mb lw mc md aw me dt"><span id="7261" class="lf kc if lw b fv mf mg l mh mi">// server.js</span><span id="4ee6" class="lf kc if lw b fv mj mg l mh mi">// before</span><span id="417f" class="lf kc if lw b fv mj mg l mh mi">require('dotenv').config({ path: './variables.env' });<br/>var app = require('./app');</span><span id="56ff" class="lf kc if lw b fv mj mg l mh mi">var port = process.env.PORT || 3000;<br/>var server = app.listen(port, function() {<br/>  console.log('Express server listening on port ' + port);<br/>});</span><span id="df3c" class="lf kc if lw b fv mj mg l mh mi"><br/>// after</span><span id="8728" class="lf kc if lw b fv mj mg l mh mi">require('dotenv').config({ path: './variables.env' });<br/>var app = require('./app');</span><span id="9816" class="lf kc if lw b fv mj mg l mh mi">var serverless = require('serverless-http');<br/>module.exports.handler = serverless(app);</span></pre><p id="18f2" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们正在用<a class="ae le" href="https://github.com/dougmoscrop/serverless-http" rel="noopener ugc nofollow" target="_blank">无服务器http </a>模块替换服务器。然后，这个模块被赋予整个Express app对象，并通过一个处理程序导出。我们将在<strong class="je ig"> serverless.yml </strong>文件中配置这个处理程序。但是首先要安装模块。</p><pre class="lx ly lz ma fq mb lw mc md aw me dt"><span id="fda9" class="lf kc if lw b fv mf mg l mh mi">$ npm install --save serverless-http</span></pre><p id="df58" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们走吧。在项目目录的根目录下创建新的<strong class="je ig"> serverless.yml </strong>文件，并将该代码粘贴到。保持缩进正确是非常重要的，因此我把它作为一个要点添加进来。</p><figure class="lx ly lz ma fq hw"><div class="bz el l di"><div class="ml mm l"/></div></figure><p id="5d70" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这里发生的事情是，您将处理函数从<strong class="je ig"> server.js </strong>文件挂钩到<code class="eh lt lu lv lw b">/</code>端点。在AWS上，这意味着整个app对象将被创建为一个Lambda函数，具有一个主API网关路径。这多酷啊！？</p><h2 id="4bf2" class="lf kc if bd kd lg lh li kh lj lk ll kl jn lm ln kp jr lo lp kt jv lq lr kx ls dt translated">测试和部署</h2><p id="81fd" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">您可能已经注意到了<strong class="je ig"> serverless.yml </strong>文件中的插件部分。它声明了一个名为<code class="eh lt lu lv lw b">serverless-offline</code>的插件。我们需要这个来运行Lambda和API Gateway的本地仿真。</p><pre class="lx ly lz ma fq mb lw mc md aw me dt"><span id="6cdd" class="lf kc if lw b fv mf mg l mh mi">$ npm install --save-dev serverless-offline</span></pre><p id="a23d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们找到了。现在开始模拟。</p><pre class="lx ly lz ma fq mb lw mc md aw me dt"><span id="bb9e" class="lf kc if lw b fv mf mg l mh mi">$ sls offline start --skipCacheInvalidation</span></pre><p id="9071" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">像我们上面做的那样测试相同的端点，您应该看到它们完全一样地工作。现在有趣的部分来了。部署所有这些都轻而易举。一个命令就够了。</p><pre class="lx ly lz ma fq mb lw mc md aw me dt"><span id="2a96" class="lf kc if lw b fv mf mg l mh mi">$ sls deploy</span></pre><p id="3c3a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">deploy命令将向您返回一个端点。这是您部署的API的根路径。</p><figure class="lx ly lz ma fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mn"><img src="../Images/4a4e065e69cfcc8abaa646435dd398d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Lrc-m4M79zTM2fGRVAJhg.png"/></div></div></figure><p id="a6ac" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你会相信我这就是所需要的一切吗？的确如此。请随意尝试这个端点。它的行为就像本地实例一样。更酷的是，这一切都被打包成一个单一的功能。让我展示给你看。</p><h1 id="4a1d" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">你有记录兄弟吗？</h1><p id="7f66" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">这是什么意思，它只是一个λ函数？对我们来说最重要的是我们只有一次冷启动。也就是说让Lambda保持温暖要容易得多。无论它得到哪个请求方法，它都会命中同一个函数。对于一个小项目来说，这很好，但是对于更大的项目来说就不那么好了。但问题是。您可以在微服务级别上构建它。<code class="eh lt lu lv lw b">/users</code>路线可以有一个专用的Lambda，而其他功能可以有自己的。所有这些都可以用您已经熟悉的代码和模块来完成！</p><p id="3f48" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">看看这个。我用Dashbird 监控我的Lambdas已经有一段时间了，我非常高兴。我永远无法单独通过CloudWatch看到这一切。另一个好处是Dashbird有一个<a class="ae le" href="https://dashbird.io/pricing/" rel="noopener ugc nofollow" target="_blank">免费层</a>，不需要信用卡注册。在我看来这是双赢。</p><figure class="lx ly lz ma fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mo"><img src="../Images/26f62cf9cb8fc23ba62d9074b436a9e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*llWUIPOzWXJ8PuRu9N3ajQ.png"/></div></div></figure><p id="e4d2" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">即使方法不同，所有的请求都是向同一个函数发出的。有些是帖子，有些是get。但它们都发射相同的λ。我不是唯一一个在这里大肆宣传你可以写所有你已经习惯的代码，而是把它部署到Lambda的人。</p><h1 id="456a" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">包扎</h1><p id="9cd8" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">今天我们已经看到学习无服务器并不是什么大不了的事情。迁移现有的应用程序相当容易。我是说你为什么不呢？如果你不想一直为你的服务器付费，而只为你所使用的付费，这是非常合理的。我的意思是，用无服务器架构运行一个小型到中等规模的REST API几乎是免费的。只有这样它才是可行的，更不用说自动缩放了。也许是时候让你重新考虑下一个项目的技术了。我希望我已经让你相信了。</p><p id="fb0b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你想看看我们上面写的所有代码，<a class="ae le" href="https://github.com/adnanrahic/nodejs-restful-api/tree/sls-express-app" rel="noopener ugc nofollow" target="_blank">这里是资源库</a>。或者如果你想看我最新的文章，请到这里来。</p><div class="ht hu fm fo hv mp"><a href="https://medium.com/@adnanrahic/latest" rel="noopener follow" target="_blank"><div class="mq ab ej"><div class="mr ab ms cl cj mt"><h2 class="bd ig fv z el mu eo ep mv er et ie dt translated">阿德南·拉希奇写的最新故事</h2><div class="mw l"><h3 class="bd b fv z el mu eo ep mv er et ek translated">阅读Adnan Rahi在Medium上写的最新故事。软件工程师@bookvar_co .编码教育家@ACADEMY387…</h3></div><div class="mx l"><p class="bd b gc z el mu eo ep mv er et ek translated">medium.com</p></div></div><div class="my l"><div class="mz l na nb nc my nd ib mp"/></div></div></a></div><p id="c954" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果我想让你了解更多关于无服务器的知识，请随意浏览我写的关于这个主题的课程。</p><div class="ht hu fm fo hv mp"><a href="https://www.packtpub.com/web-development/serverless-javascript-example-video" rel="noopener  ugc nofollow" target="_blank"><div class="mq ab ej"><div class="mr ab ms cl cj mt"><h2 class="bd ig fv z el mu eo ep mv er et ie dt translated">无服务器JavaScript示例[视频] -视频|现在只需5美元</h2><div class="mw l"><h3 class="bd b fv z el mu eo ep mv er et ek translated">通过无服务器web开发的实时演示变得更加熟练</h3></div><div class="mx l"><p class="bd b gc z el mu eo ep mv er et ek translated">www.packtpub.com</p></div></div><div class="my l"><div class="ne l na nb nc my nd ib mp"/></div></div></a></div><p id="44cd" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">或者，加入我的时事通讯，获得直接送到您家门口的关于无服务器的精选内容！</p><figure class="lx ly lz ma fq hw"><div class="bz el l di"><div class="nf mm l"/></div></figure><p id="2d66" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">希望你们喜欢读这篇文章，就像我喜欢写这篇文章一样。 <br/> <em class="ka">你觉得这个教程会对某个人有帮助吗？不要犹豫分享。如果你喜欢，击碎下面的</em> <strong class="je ig"> <em class="ka">拍手</em> </strong> <em class="ka">这样其他人会在媒体上看到这个。</em></p></div></div>    
</body>
</html>