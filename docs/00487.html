<html>
<head>
<title>I’m afraid you’re thinking about AWS Lambda cold starts all wrong</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">恐怕你对AWS Lambda冷启动的想法完全错了</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/im-afraid-you-re-thinking-about-aws-lambda-cold-starts-all-wrong-7d907f278a4f?source=collection_archive---------1-----------------------#2018-01-16">https://medium.com/hackernoon/im-afraid-you-re-thinking-about-aws-lambda-cold-starts-all-wrong-7d907f278a4f?source=collection_archive---------1-----------------------#2018-01-16</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="3647" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当我在API Gateway的环境中与人们讨论AWS Lambda冷启动时，我经常得到这样的回答:</p><blockquote class="jp jq jr"><p id="abbb" class="ir is js it b iu iv iw ix iy iz ja jb jt jd je jf ju jh ji jj jv jl jm jn jo hn dt translated">呣，这只是第一个要求，对吗？所以如果一个请求很慢，下一百万个请求就会很快。</p></blockquote><p id="d065" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不幸的是，这过于简单化了。</p><p id="a4af" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于函数的每个<strong class="it hv">并发执行</strong>，冷启动发生<strong class="it hv">一次</strong>。</p><p id="be48" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果可能的话，API Gateway会重用已经在运行的函数的并发执行，根据我的观察，<strong class="it hv"> <em class="js">甚至可能</em> </strong> <em class="js">将请求排队一小段时间，希望其中一个并发执行能够完成并被重用</em>。</p><p id="7674" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果所有用户对API的请求都是一个接一个发生的，那么在这个过程中，你肯定只会经历一次冷启动。您可以通过捕获对API网关端点的请求并使用并发设置1重复它，来模拟使用<a class="ae jw" href="https://www.charlesproxy.com/" rel="noopener ugc nofollow" target="_blank"> Charles proxy </a>会发生什么。</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff jx"><img src="../Images/f00318c1c6b9373743263037fc35b363.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IC7TzqzpnYaovkfhFq8d1A.png"/></div></div></figure><p id="0df0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如您在下面的时间线中看到的，只有第一个请求经历了冷启动，因此与其他请求相比明显较慢。</p><p id="6ab0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">100分之一，这是可以忍受的，见鬼，它甚至不会出现在我的99%的延迟指标中。</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff kj"><img src="../Images/bf744d798d6fe7a95716ad7392c509f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nVhPdyavP47LshhyTJcoig.png"/></div></div><figcaption class="kk kl fg fe ff km kn bd b be z ek">Only the first request incurred the penalty of cold start.</figcaption></figure><p id="7b88" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果用户请求成群结队地到来会怎样？毕竟，用户行为是不可预测的，不太可能遵循我们上面看到的好的顺序模式。因此，让我们模拟一下，当我们收到100个请求，并发数为10时会发生什么。</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff ko"><img src="../Images/58aea5bacb1c94527d5858935d1b6255.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*li2scAaNrqODkIurmQlFDA.png"/></div></div></figure><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff kp"><img src="../Images/1f693eb1cc2aa32a4b5e9802638ac63b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gdh5_NNm2Ok0w3FsDrXwlg.png"/></div></div></figure><p id="fcf6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">突然间，事情看起来不那么乐观了——前10个请求都是冷启动！如果您的流量模式在一天中的特定时间或特定事件中高度突发，这可能会带来麻烦，例如</p><ul class=""><li id="414c" class="kq kr hu it b iu iv iy iz jc ks jg kt jk ku jo kv kw kx ky dt translated">订餐服务(如JustEat、Deliveroo)在用餐时间会出现流量激增</li><li id="b611" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky dt translated">电子商务网站在一年中受欢迎的购物日——网络星期一、黑色星期五等，流量高度集中。</li><li id="27a2" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky dt translated">博彩服务在体育赛事期间流量激增</li><li id="156b" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky dt translated">社交网络的流量会激增，嗯，几乎是世界各地发生的任何值得关注的事件</li></ul><p id="54ba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于所有这些服务，流量的突然爆发意味着API Gateway将不得不添加更多的Lambda函数并发执行，这相当于冷启动的爆发，这对您来说是个坏消息。这是你的业务最关键的时期，也正是你希望你的服务达到最佳状态的时候。</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff le"><img src="../Images/328285f4a0e8b9e77add31b46ce31f4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7BlPKBz4ybqr13bVZJan6g.png"/></div></div></figure><p id="6cd7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果峰值是可预测的，就像食品订购服务的情况一样，您可以通过预热API来减轻冷启动的影响，也就是说，如果您知道中午会出现流量激增，那么您可以在上午11:58安排一个cron作业(也称为CloudWatch schedule + Lambda ),该作业将向相关的API发出大量并发请求，足以使API Gateway产生足够数量的函数并发执行。</p><p id="9c42" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以用一个特殊的HTTP头或有效负载来标记这些请求，以便处理函数可以将其与普通的用户请求区分开来，并且可以在不尝试执行普通代码路径的情况下短路。</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff lf"><img src="../Images/481dbda1eb16bc1ceb4f82d369f2d18c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*534s22qv_b3c0EL8fi70qw.png"/></div></div></figure><p id="4e07" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这些可预测的流量爆发期间，您减轻了冷启动的影响，这很好，但<strong class="it hv">这难道没有违背无服务器计算的精神，</strong> <strong class="it hv">您不应该担心扩展吗？</strong></p><p id="1203" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然，但是<strong class="it hv">让用户开心</strong>重击其他一切，如果用户不得不等待你的功能冷启动才能点餐，他们会不高兴，转向竞争对手的成本很低，所以他们甚至可能第二天就不会回来。</p><p id="49d0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">或者，您可以考虑通过缩短冷启动时间来减少冷启动的影响:</p><ul class=""><li id="c332" class="kq kr hu it b iu iv iy iz jc ks jg kt jk ku jo kv kw kx ky dt translated">通过使用不会导致高冷启动时间的<a class="ae jw" href="https://read.acloud.guru/does-coding-language-memory-or-package-size-affect-cold-starts-of-aws-lambda-a15e26d12c76" rel="noopener ugc nofollow" target="_blank">语言编写Lambda函数，例如Node.js、Python或</a><a class="ae jw" href="https://aws.amazon.com/blogs/compute/announcing-go-support-for-aws-lambda/" rel="noopener ugc nofollow" target="_blank"> Go </a></li><li id="245c" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky dt translated">为处理用户请求的关键路径上的函数选择较高的内存设置(例如，用户必须等待响应的任何东西，包括中间API)</li><li id="a627" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky dt translated">优化函数的依赖项和包的大小</li><li id="27ce" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky dt translated"><strong class="it hv">尽可能远离VPC！</strong> VPC接入要求Lambda为目标VPC创建ENIs(弹性网络接口),这很容易为您的冷启动增加10秒(是的，您没有看错)</li></ul><p id="ecd0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">还有另外两个因素需要考虑:</p><ul class=""><li id="4f57" class="kq kr hu it b iu iv iy iz jc ks jg kt jk ku jo kv kw kx ky dt translated"><a class="ae jw" href="https://read.acloud.guru/how-long-does-aws-lambda-keep-your-idle-functions-around-before-a-cold-start-bf715d3b810" rel="noopener ugc nofollow" target="_blank">闲置一段时间的执行将被垃圾收集</a></li><li id="d448" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky dt translated">已经活跃了一段时间(大约4到7个小时)的执行也会被垃圾收集</li></ul><p id="4ae4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，那些很少用的API呢？实际上，很有可能每次有人点击那个API时，他们都会遭遇冷启动，所以对你的用户来说，那个API总是很慢，他们将来更不可能使用它，这是一个恶性循环。</p><p id="faa8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于这些API，您可以有一个cron作业，它每隔5-10分钟运行一次，并对API执行ping操作(使用一个特殊的ping请求)，这样，当API被一个真正的用户使用时，它就有希望是热的，而用户就不必忍受冷启动时间了。</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff lg"><img src="../Images/1c08a7b8e42cbce5d9a880f5ad5a784a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-HsWVd_LmZ4H24FQds-Sog.png"/></div></div></figure><p id="b0a1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这种pinging API端点以保持其热度的方法对于具有大量并发执行的“繁忙”函数来说不太有效——您的ping消息只会到达其中一个并发执行，如果并发用户请求的级别下降，那么一些并发执行将在闲置一段时间后被垃圾收集，这就是您想要的(不要为您不需要的资源付费)。</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff lh"><img src="../Images/e476a02d93cc6b3eb7e3cf94a7f68016.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pfge8GZPLTaNNd_6SsBlSQ.png"/></div></div></figure><p id="ee40" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">无论如何，这篇文章不打算成为你的AWS Lambda冷启动的一站式指南，而只是为了说明这是一个比“<em class="js">只是第一个请求</em>”更微妙的讨论。</p><p id="d260" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">冷启动是我们不得不接受的平台特性，我们喜欢AWS Lambda平台，并希望使用它，因为它在许多方面都提供了支持。重要的是，不要让我们自己的偏好蒙蔽了我们的双眼，让<strong class="it hv">让我们的用户开心，并打造一款他们愿意继续使用的产品</strong>。</p><p id="9767" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要做到这一点，您确实需要了解您正在构建的平台，而且由于实验成本如此之低，没有理由不亲自尝试AWS Lambda，并尝试了解它的行为以及如何充分利用它。</p></div><div class="ab cl li lj hc lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hn ho hp hq hr"><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div class="ab fr cl lp"><img src="../Images/8b4e4721bb1973db389b5b533d727ad1.png" data-original-src="https://miro.medium.com/v2/format:webp/0*b_1R345KzKSaI8sg.png"/></div></figure><p id="f870" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">嗨，我叫<strong class="it hv">崔琰</strong>。我是一个<a class="ae jw" href="https://aws.amazon.com/developer/community/heroes/yan-cui/" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv"> AWS无服务器英雄</strong> </a>和<a class="ae jw" href="https://bit.ly/production-ready-serverless" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">量产无服务器</strong> </a>的作者。我已经在AWS中运行了近10年的大规模生产工作负载，我是一名架构师或首席工程师，涉足从银行、电子商务、体育流媒体到移动游戏等多个行业。我目前是一名专注于AWS和无服务器的独立顾问。</p><p id="c37e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以通过<a class="ae jw" href="mailto:theburningmonk.com" rel="noopener ugc nofollow" target="_blank">邮箱</a>、<a class="ae jw" href="https://twitter.com/theburningmonk" rel="noopener ugc nofollow" target="_blank">推特</a>和<a class="ae jw" href="https://www.linkedin.com/in/theburningmonk/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我。</p></div><div class="ab cl li lj hc lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hn ho hp hq hr"><p id="404d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">查看我的新课程，<a class="ae jw" href="https://theburningmonk.thinkific.com/courses/complete-guide-to-aws-step-functions" rel="noopener ugc nofollow" target="_blank"><strong class="it hv">AWS步骤功能完全指南</strong> </a>。</p><p id="a329" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本课程中，我们将介绍有效使用AWS Step Functions服务所需了解的一切。包括基本概念、HTTP和事件触发器、活动、设计模式和最佳实践。</p><p id="cd40" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在此获取您的副本<a class="ae jw" href="https://theburningmonk.thinkific.com/courses/complete-guide-to-aws-step-functions" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl li lj hc lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hn ho hp hq hr"><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff lq"><img src="../Images/2faf40b47320300fed81b3e09483ffb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZYcHhOOzUf5VB-Ri.png"/></div></div></figure><p id="ee8c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">来了解AWS Lambda: CI/CD的操作性<strong class="it hv">最佳实践</strong>，本地测试&amp;调试功能、日志记录、监控、分布式跟踪、金丝雀部署、配置管理、认证&amp;授权、VPC、安全性、错误处理等等。</p><p id="8bb5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">代码<strong class="it hv"> ytcui </strong>还可以获得<strong class="it hv">票面价格6折</strong>。</p><p id="2e68" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">点击获取您的副本<a class="ae jw" href="https://bit.ly/production-ready-serverless" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>