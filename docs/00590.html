<html>
<head>
<title>Unlocking Web Audio — the smarter way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解锁网络音频——更智能的方式</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/unlocking-web-audio-the-smarter-way-8858218c0e09?source=collection_archive---------4-----------------------#2018-01-19">https://medium.com/hackernoon/unlocking-web-audio-the-smarter-way-8858218c0e09?source=collection_archive---------4-----------------------#2018-01-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/949bf00c42a743cd9b8f4bf34d9a6c94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jl47JZ4gjNdL_qOcqOErdQ.png"/></div></div></figure><div class=""/><p id="82cb" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ka" href="https://hackernoon.com/tagged/web-audio" rel="noopener ugc nofollow" target="_blank"> Web Audio </a> <a class="ae ka" href="https://hackernoon.com/tagged/api" rel="noopener ugc nofollow" target="_blank"> API </a>为控制Web上的音频提供了一个强大而通用的系统，允许开发人员选择音频源、为音频添加效果、创建音频可视化、应用空间效果(如平移)等等。</p><p id="d342" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它可以用于<a class="ae ka" href="https://hackernoon.com/tagged/developing" rel="noopener ugc nofollow" target="_blank">开发</a>复杂的基于网络的游戏或交互式应用，包括现代游戏音频引擎的功能以及现代桌面音频制作应用中的一些混合、处理和过滤任务；它可以很好地补充<a class="ae ka" href="https://get.webgl.org/" rel="noopener ugc nofollow" target="_blank"> WebGL </a>提供的更高级的图形功能。</p><p id="0186" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所有这些<strong class="je ig">听起来</strong>棒极了(双关语)，尽管在iOS设备上有一个小小的<a class="ae ka" href="https://developer.apple.com/library/content/documentation/AudioVideo/Conceptual/Using_HTML5_Audio_Video/PlayingandSynthesizingSounds/PlayingandSynthesizingSounds.html#//apple_ref/doc/uid/TP40009523-CH6-SW6" rel="noopener ugc nofollow" target="_blank">警告</a>:网络音频<a class="ae ka" href="https://hackernoon.com/tagged/api" rel="noopener ugc nofollow" target="_blank"> API </a>要求在任何声音可以在网页上播放之前，声音必须由明确的用户动作触发，比如轻击。</p><p id="c600" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">iOS设备之所以施加这种用户手势限制，是因为他们希望通过阻止广告或视频在用户与内容实际交互之前播放声音来保持愉快的用户体验，同时也是为了节省电池寿命，因为播放音频确实需要额外的处理能力。</p><p id="662b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在Web Audio API中，一切都发生在一个<code class="eh kb kc kd ke b"><a class="ae ka" href="https://developer.mozilla.org/en-US/docs/Web/API/AudioContext" rel="noopener ugc nofollow" target="_blank">AudioContext</a></code>中，这是一个由音频节点链接在一起构建的音频处理图，它控制它所包含的节点的创建以及音频处理或解码的执行。</p><p id="c7e2" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在iOS设备上，这个上下文最初是挂起的(“锁定”)，为了在网页上启用声音，我们需要在第一次用户交互中让它脱离挂起状态，或者“解锁”。</p><p id="9817" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ka" href="https://paulbakaus.com/tutorials/html5/web-audio-on-ios/" rel="noopener ugc nofollow" target="_blank">这个问题的早期解决方案</a>提出在运行中创建一个空声音，并在用户与页面交互后播放。</p><p id="1ffd" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这种方法之所以有效，是因为在实际播放音频之前，<a class="ae ka" href="https://github.com/WebKit/webkit/blob/750df37180842038b25fc9efe18fc40053785e24/Source/WebCore/Modules/webaudio/AudioContext.cpp#L978" rel="noopener ugc nofollow" target="_blank">在锁定的音频环境中播放音频源会将其设置为</a> <code class="eh kb kc kd ke b"><a class="ae ka" href="https://github.com/WebKit/webkit/blob/750df37180842038b25fc9efe18fc40053785e24/Source/WebCore/Modules/webaudio/AudioContext.cpp#L978" rel="noopener ugc nofollow" target="_blank">running</a></code> <a class="ae ka" href="https://github.com/WebKit/webkit/blob/750df37180842038b25fc9efe18fc40053785e24/Source/WebCore/Modules/webaudio/AudioContext.cpp#L978" rel="noopener ugc nofollow" target="_blank">状态</a>。</p><p id="662f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们开始把一些代码放在一起，以便尝试提出一个更简单的解决方案。首先，我们需要实例化一个音频上下文，以便能够进行任何音频操作:</p><figure class="kf kg kh ki fq hw"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="e1ab" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后，在我们创建音频上下文之后，我们应该检查它的<a class="ae ka" href="https://developer.mozilla.org/en-US/docs/Web/API/BaseAudioContext/state" rel="noopener ugc nofollow" target="_blank">状态</a>属性。<br/>如果状态等于<code class="eh kb kc kd ke b">suspended</code>，我们可能正在处理一个iOS设备:</p><figure class="kf kg kh ki fq hw"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="de79" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一些桌面浏览器，如<a class="ae ka" href="https://www.mozilla.org/en-US/firefox/" rel="noopener ugc nofollow" target="_blank"> Firefox Quantum </a>在实例化后会在<code class="eh kb kc kd ke b">suspended</code>状态中留下一个音频上下文，因此为了确保我们真正处理的是iOS设备，我们需要检查触摸事件是否可用:</p><figure class="kf kg kh ki fq hw"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="6a72" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果音频上下文被挂起，我们可以调用它的<code class="eh kb kc kd ke b"><a class="ae ka" href="https://developer.mozilla.org/en-US/docs/Web/API/BaseAudioContext/resume" rel="noopener ugc nofollow" target="_blank">resume</a>()</code>方法将其设置为<code class="eh kb kc kd ke b">running</code>状态:</p><figure class="kf kg kh ki fq hw"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="fb51" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，你可能会想“<em class="kl">嗯，事情不可能这么简单…”</em></p></div><div class="ab cl km kn hc ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="hn ho hp hq hr"><p id="e16e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">…你是对的😔。这段代码需要在用户交互中运行，以便实际工作。因此，我们将把它包装在一个函数中，并添加该函数作为触摸事件监听器。</p><p id="1892" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了尽快尝试解锁音频上下文，我们将在页面上任何地方发生第一个<code class="eh kb kc kd ke b"><a class="ae ka" href="https://developer.mozilla.org/en-US/docs/Web/Events/touchstart" rel="noopener ugc nofollow" target="_blank">touchstart</a></code>事件时运行我们的代码:</p><figure class="kf kg kh ki fq hw"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="7fa7" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这种方法的一个问题是，一些iOS版本的<a class="ae ka" href="https://bugs.webkit.org/show_bug.cgi?id=149367#c7" rel="noopener ugc nofollow" target="_blank">试图在</a> <code class="eh kb kc kd ke b"><a class="ae ka" href="https://bugs.webkit.org/show_bug.cgi?id=149367#c7" rel="noopener ugc nofollow" target="_blank">touchstart</a></code> <a class="ae ka" href="https://bugs.webkit.org/show_bug.cgi?id=149367#c7" rel="noopener ugc nofollow" target="_blank">事件上解锁网络音频无法工作</a>。</p><blockquote class="kt ku kv"><p id="d61a" class="jc jd kl je b jf jg jh ji jj jk jl jm kw jo jp jq kx js jt ju ky jw jx jy jz hn dt translated"><code class="eh kb kc kd ke b">touchstart</code>可能是滚动手势的开始，并且从用户的角度来看，在该手势期间播放音频可能是完全不期望的。</p></blockquote><p id="4d0f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">因此，考虑到这一点，我们还需要尝试从<code class="eh kb kc kd ke b"><a class="ae ka" href="https://developer.mozilla.org/en-US/docs/Web/Events/touchend" rel="noopener ugc nofollow" target="_blank">touchend</a></code>事件以及最初的<code class="eh kb kc kd ke b">touchstart</code>事件中解锁网络音频:</p><figure class="kf kg kh ki fq hw"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="adbd" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦音频上下文被解锁，我们将想要移除触摸事件监听器，因为我们不再需要它们了。为此，我们需要弄清楚音频上下文实际上是何时解锁的。</p><p id="79be" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在早期的解决方案中，确定这一点的技术是查询声音的<code class="eh kb kc kd ke b">playbackState</code>属性，这是在开始播放后不久动态创建的。之后直接做是不行的，因为启动声音是一个异步动作，所以查询必须通过超时回调来完成。<br/>然后，如果声音在<code class="eh kb kc kd ke b">PLAYING_STATE</code>或<code class="eh kb kc kd ke b">FINISHED_STATE</code>中，您可以假设上下文被解锁。</p><p id="5dd2" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这种方法在某些情况下可能仍然有效，但它远非简单，并且引入了兼容性问题，因为官方Web音频API规范不再支持<code class="eh kb kc kd ke b"><a class="ae ka" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API/Porting_webkitAudioContext_code_to_standards_based_AudioContext#Removal_of_AudioBufferSourceNode.playbackState_and_OscillatorNode.playbackState" rel="noopener ugc nofollow" target="_blank">playbackState</a></code> <a class="ae ka" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API/Porting_webkitAudioContext_code_to_standards_based_AudioContext#Removal_of_AudioBufferSourceNode.playbackState_and_OscillatorNode.playbackState" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="663d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一件有趣的事情是音频上下文的<code class="eh kb kc kd ke b">resume</code>方法实际上返回了一个<code class="eh kb kc kd ke b"><a class="ae ka" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" rel="noopener ugc nofollow" target="_blank">Promise</a></code>对象。当该承诺兑现时，我们确定音频上下文已被解锁，并且我们可以移除触摸事件监听器:</p><figure class="kf kg kh ki fq hw"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="2ef4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这就是你要做的:在iOS设备上解锁网络音频的防弹方式！</p><p id="ef4c" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们再做一些调整，使这段代码可以重用。<br/>首先，让我们把它包装在一个函数中:</p><figure class="kf kg kh ki fq hw"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="ee0b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最后，让我们提供一些有用的信息，如是否真的需要解锁网络音频，或者是否发生了错误以及原因是什么。<br/>我们可以通过将所有内容包装在一个<code class="eh kb kc kd ke b">Promise</code>中并从我们的函数中返回来实现这一点:</p><figure class="kf kg kh ki fq hw"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="0a7a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，您可以在代码中的任何地方使用该函数，如下所示:</p><figure class="kf kg kh ki fq hw"><div class="bz el l di"><div class="kj kk l"/></div></figure><h1 id="25b3" class="kz la if bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw dt translated">结论</h1><p id="c88e" class="pw-post-body-paragraph jc jd if je b jf lx jh ji jj ly jl jm jn lz jp jq jr ma jt ju jv mb jx jy jz hn dt translated">这就是在iOS设备上解锁网络音频API的简单有效的方法！</p><p id="0135" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我已经创建了一个名为<a class="ae ka" href="https://github.com/pavle-goloskokovic/web-audio-touch-unlock/" rel="noopener ugc nofollow" target="_blank"> web-audio-touch-unlock </a>的<a class="ae ka" href="https://www.npmjs.com/package/web-audio-touch-unlock" rel="noopener ugc nofollow" target="_blank"> npm包</a>，它公开了这个方法，并使它易于在您自己的项目中使用。<br/>只需将您的<code class="eh kb kc kd ke b">AudioContext</code>实例传递给它，您就可以开始了！</p><p id="6bde" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你可以在这里自己尝试一下<a class="ae ka" href="https://pavle-goloskokovic.github.io/web-audio-touch-unlock-example/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="fc54" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">干杯！</p><figure class="kf kg kh ki fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mc"><img src="../Images/0900dd4970528ee53a0f143550083a9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ygegxWNEsYDv-r5g7mW0kA.png"/></div></div><figcaption class="md me fg fe ff mf mg bd b be z ek"><strong class="bd mh">Tap anywhere to unlock…</strong></figcaption></figure><figure class="kf kg kh ki fq hw"><div class="bz el l di"><div class="mi kk l"/></div></figure></div></div>    
</body>
</html>