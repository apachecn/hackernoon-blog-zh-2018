<html>
<head>
<title>Migrating WeMove.co from Azure to Ubuntu VM on Digital Ocean</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在数字海洋上将WeMove.co从Azure迁移到Ubuntu虚拟机</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/migrating-wemove-co-from-azure-to-ubuntu-vm-on-digital-ocean-96280ce24777?source=collection_archive---------6-----------------------#2018-01-20">https://medium.com/hackernoon/migrating-wemove-co-from-azure-to-ubuntu-vm-on-digital-ocean-96280ce24777?source=collection_archive---------6-----------------------#2018-01-20</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="cac5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">早在2016年7月，当我开始编写将成为WeMove.co的代码时，我选择了使用ASP.NET核心，因为C#是我的首选静态语言(我在这里写了关于我是如何做出这个选择的博客:<a class="ae jp" href="http://ezeokoyecelestine.blogspot.com.ng/2016/07/microsofts-confusing-dilemma-with.html" rel="noopener ugc nofollow" target="_blank">http://ezoekoyecelestine . blogspot . com . ng/2016/07/microsofts-fumbling-dilemma-with . html</a>)。ASP.NET核心是新的，当时非常前卫，我在1.0版本中使用它，我面临一些非常有趣的问题。正如我在帖子中提到的，微软确实解决了问题，昨天，我成功地将我们的网站从Azure迁移到了位于<a class="ae jp" href="https://hackernoon.com/tagged/digital-ocean" rel="noopener ugc nofollow" target="_blank">数字海洋</a>上的Ubutu VM。</p><h1 id="f281" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">我们为什么迁移？</h1><p id="d6e1" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">长话短说:削减开支。</p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="ky kz l"/></div></figure><p id="f1d3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">1月2日，WeMove Technologies搬进了位于Bode Thomas Surulere的新办公室，这是拉各斯一个繁荣的业务部门。在拉各斯做生意，我们必须尽可能降低成本。因此，我认为中期内我们如何固定成本是很重要的。对我来说，一个主要的策略是要么加入微软的BizSpark计划，要么放弃Azure，因为成本已经开始堆积。</p><p id="021a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我从11月份开始申请BizSpark，没有得到任何回应，我决定开始购买替代云服务。Azure的PaaS是我的首选托管服务，因为它易于设置和部署，直接来自我的BitBucket repo。放手意味着我必须在移动的同时建立一个构建管道。</p><p id="93b1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">尽管主要驱动力是降低业务成本，但迁移的第二大原因是减少未来的错误。</p><ul class=""><li id="7e4f" class="la lb hu it b iu iv iy iz jc lc jg ld jk le jo lf lg lh li dt translated">我们将很快开始招聘，我需要开发人员只是写和推动代码回购，没有破坏任何东西。我不得不在圣诞节那天与网站宕机做斗争，因为一次错误地应用于生产的迁移，而我正在尝试一些东西。我不想重复那个错误。</li></ul><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="ky kz l"/></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Christmas day woes 😭</figcaption></figure><ul class=""><li id="f09b" class="la lb hu it b iu iv iy iz jc lc jg ld jk le jo lf lg lh li dt translated">我需要关注点分开。目前，WeMove代码是一个C#类库(内置。NET Core)，它包含所有的业务逻辑和一个ASP.NET汽车租赁核心web应用程序。我一个人编码的时候，在webapp里面做了一个类库的VS项目参考。这意味着代码驻留在同一个解决方案中，开发人员不能只专注于类库的工作，而不能在他们的PC上拥有所有的代码。这就增加了错误修改一些东西，推到回购的可能性。因此增加了出错的可能性。我不希望这种事发生。</li></ul><h1 id="0770" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">我们是如何迁移的？</h1><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="fe ff ln"><img src="../Images/1049c5c593180f075636ef5cb4928cc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*whzW4k4C_dxYVpu-xrUzvQ.png"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">A rough sketch of our build process (made with MS Paint)</figcaption></figure><h2 id="b2ab" class="lu jr hu bd js lv lw lx jw ly lz ma ka jc mb mc ke jg md me ki jk mf mg km mh dt translated">设置代码回购</h2><p id="2a5a" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">对于所有过去的项目和WeMove.co，我更喜欢在BitBucket托管代码。主要是因为我有很多免费的私有库，而且我的开发团队没有超过5个。然而，在我们为新员工制定计划时，我认为我们需要升级我们的BitBucket计划。</p><p id="9588" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后我发现了GitLab。</p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="ky kz l"/></div></figure><p id="aaee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我去GitLab签了免费的CI/CD，但最终还是用了，因为可用的团队成员数量没有限制(抱歉BitBucket，我还是❤️你)。最终没有使用他们的CI/CD，而是推出了我自己的构建服务器。</p><h2 id="a2f6" class="lu jr hu bd js lv lw lx jw ly lz ma ka jc mb mc ke jg md me ki jk mf mg km mh dt translated">设置构建和获取服务器</h2><p id="3d98" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">对于构建服务器，我们在Interswitch Cloud(【https://cloud.interswitch.com】T4)得到了一个Windows服务器盒子。我选择Jenkins作为构建服务器，因为这是我最有经验和最信任的。</p><p id="d280" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我花了1周的时间(在编码和运营业务之间切换)，71次构建&amp;将一个文件夹从我的开发PC复制到服务器，成功地让Jenkins按照我的要求部署了我的nuget服务器。主要问题是让Jenkins让MSBuild与Web Deploy一起工作(Nuget服务器是ASP.NET的4.5项目)。我甚至不确定我是否记得所有相关的步骤，所以我为没有做一步一步的指导而道歉。</p><p id="e9b4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">成功完成后，为车辆租赁ASP.NET核心应用程序设置脚本就容易多了。</p><ol class=""><li id="ef6a" class="la lb hu it b iu iv iy iz jc lc jg ld jk le jo mi lg lh li dt translated">提交后从回购中提取代码。</li><li id="c491" class="la lb hu it b iu mj iy mk jc ml jg mm jk mn jo mi lg lh li dt translated">要在Jenkins中进行构建和部署，请运行以下Windows批处理命令:</li></ol><pre class="kt ku kv kw fq mo mp mq mr aw ms dt"><span id="32e4" class="lu jr hu mp b fv mt mu l mv mw">dotnet restore</span><span id="616d" class="lu jr hu mp b fv mx mu l mv mw">dotnet publish -c Release -r ubuntu.16.04-x64 -o “%WORKSPACE%\deploy\path”</span><span id="6761" class="lu jr hu mp b fv mx mu l mv mw">jar -cMf ZipPackage.zip %WORKSPACE%\deploy\path\* </span><span id="f80e" class="lu jr hu mp b fv mx mu l mv mw">curl http://&lt;ubuntu-server-ip&gt;:&lt;hidden-port&gt;/deploy-handler.php?tasktoperform=deploy_wemove --upload-file ZipPackage.zip</span></pre><p id="66f2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="my">注意，在第2行，我告诉</em> <code class="eh mz na nb mp b"><em class="my">dotnet</em></code> <em class="my">使用</em> <code class="eh mz na nb mp b">-r ubuntu.16.04-x64</code>选项发布ubuntu。<em class="my">是的，我使用JDK的“jar”工具在第三行创建了一个zip文件。你看到我在那里做了什么吗？还有，第4行的curl命令只有在你从</em><a class="ae jp" href="https://dl.uxnr.de/build/curl/curl_winssl_msys2_mingw64_stc/curl-7.57.0/curl-7.57.0.zip" rel="noopener ugc nofollow" target="_blank"><em class="my">https://dl . uxnr . de/build/curl/curl _ winssl _ msys 2 _ mingw 64 _ STC/curl-7 . 57 . 0/curl-7 . 57 . 0 . zip</em></a>下载了curl for windows之后才起作用</p><p id="2cb4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我需要去<a class="ae jp" href="https://hackernoon.com/tagged/ubuntu" rel="noopener ugc nofollow" target="_blank"> Ubuntu </a>服务器并设置它接受ZipPackage.zip。这意味着编写一个小的PHP脚本，它接受请求并将zip文件解压缩到指定的<code class="eh mz na nb mp b">/var/www/</code>路径，这取决于为<code class="eh mz na nb mp b">?tasktoperform=&lt;action&gt;</code>指定的动作。</p><h2 id="ce4d" class="lu jr hu bd js lv lw lx jw ly lz ma ka jc mb mc ke jg md me ki jk mf mg km mh dt translated">设置Ubuntu web服务器来托管ASP.NET核心</h2><p id="7bcc" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">对于web服务器，我们从Digital Ocean获得了一台虚拟机。从注册到设置SSH密钥花了10多分钟。老实说，我印象非常深刻。</p><p id="ba14" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我创建了一个PHP脚本，它从构建服务器接收zip文件。它运行的端口只对构建服务器的IP地址开放，使用<code class="eh mz na nb mp b">ufw</code>防火墙实用程序配置。它获取文件并将其解压缩到适当的目录中。它还为ASP.NET核心复制适当的appsettings.json文件。我会在下面的<strong class="it hv">问题</strong>中解释原因。</p><p id="9751" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面的链接包含了如何为Ubuntu设置ASP.NET核心并配置它与Nginx一起工作的深入的分步指南。然后作为服务安装，因此它与服务器一起启动。所以我不会重复这些内容让你厌烦，只需点击链接:</p><div class="nc nd fm fo ne nf"><a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?tabs=aspnetcore2x" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab ej"><div class="nh ab ni cl cj nj"><h2 class="bd hv fv z el nk eo ep nl er et ht dt translated">使用Nginx在Linux上托管ASP.NET核心</h2><div class="nm l"><h3 class="bd b fv z el nk eo ep nl er et ek translated">本指南解释了如何在Ubuntu 16.04上建立一个生产就绪的ASP.NET核心环境…</h3></div><div class="nn l"><p class="bd b gc z el nk eo ep nl er et ek translated">docs.microsoft.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt ls nf"/></div></div></a></div><div class="nc nd fm fo ne nf"><a href="http://blog.bobbyallen.me/2017/05/01/deploying-and-hosting-asp-net-core-applications-on-ubuntu-linux/" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab ej"><div class="nh ab ni cl cj nj"><h2 class="bd hv fv z el nk eo ep nl er et ht dt translated">在Ubuntu Linux上部署和托管ASP.NET核心应用程序</h2><div class="nm l"><h3 class="bd b fv z el nk eo ep nl er et ek translated">如果你读过我的其他博客帖子或者在我的GitHub个人资料上看过我的一些项目，你会发现我是一个真正的Linux…</h3></div><div class="nn l"><p class="bd b gc z el nk eo ep nl er et ek translated">blog.bobbyallen.me</p></div></div><div class="no l"><div class="nu l nq nr ns no nt ls nf"/></div></div></a></div><p id="eadb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt">— —</p><p id="9b96" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，我继续将Let's Encrypt设置为WeMove的SSL提供者。下面的链接告诉你怎么做:</p><div class="nc nd fm fo ne nf"><a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-16-04" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab ej"><div class="nh ab ni cl cj nj"><h2 class="bd hv fv z el nk eo ep nl er et ht dt translated">如何在Ubuntu 16.04上用Let's Encrypt保护Nginx | digital ocean</h2><div class="nm l"><h3 class="bd b fv z el nk eo ep nl er et ek translated">在本教程中，我们将向您展示如何使用Let's Encrypt获得一个免费的SSL证书，并在Nginx上使用它…</h3></div><div class="nn l"><p class="bd b gc z el nk eo ep nl er et ek translated">www.digitalocean.com</p></div></div><div class="no l"><div class="nv l nq nr ns no nt ls nf"/></div></div></a></div><h2 id="718d" class="lu jr hu bd js lv lw lx jw ly lz ma ka jc mb mc ke jg md me ki jk mf mg km mh dt translated">逮到你了</h2><p id="98c8" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">如果你决定按照这些设置让ASP.NET核心在你的Ubuntu服务器上运行，这些事情可能会消磨你的时间。</p><ul class=""><li id="401a" class="la lb hu it b iu iv iy iz jc lc jg ld jk le jo lf lg lh li dt translated"><strong class="it hv">ASP.NET核心拒绝接收环境变量</strong> —这对我来说是个大问题，因为我不知道如何告诉ASP.NET核心使用我在环境变量中指定的数据库连接。它完全忽略了它们，只处理应用程序文件夹中的appsettings.json。作为一种变通方法，我必须在不同的位置创建appsettings.json的副本(它具有所有正确的设置)。然后我把它复制到应用程序文件夹里。这作为构建过程的一部分执行，由PHP脚本完成。</li><li id="8468" class="la lb hu it b iu mj iy mk jc ml jg mm jk mn jo lf lg lh li dt translated"><strong class="it hv"> Cloudflare循环HTTPS重定向</strong> —设置Let's Encrypt SSL过程的一部分是告诉web服务器将所有HTTP请求重定向到HTTPS。如果您在Cloudflare上配置DNS/域代理，HTTPS将被剥离，每个请求都将作为HTTP发送到您的服务器。这将在您的服务器上导致无限重定向循环。要修复它，请转到您的Cloudflare控制面板，在crypto &gt; SSL下，选择“完全(严格)”(如下所示)。这将强制Cloudflare仅向您的服务器发送SSL请求。</li></ul><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="fe ff nw"><img src="../Images/01b7c13a41bb527e1701f2160e2eb0ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e1fVZPwR92iEgRjXVJAdEQ.png"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Cloudflare settings for default SSL/strict</figcaption></figure><ul class=""><li id="fbfe" class="la lb hu it b iu iv iy iz jc lc jg ld jk le jo lf lg lh li dt translated"><strong class="it hv">对/var/www/app-dir目录以及您的web用户使用的其他目录的权限</strong> —不要忘记为www-data用户和组设置对所有目录的适当权限。这让我非常头疼。通过执行<code class="eh mz na nb mp b">chmod -R 775</code>使其只对公众写入。</li></ul><h1 id="9215" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">从中长期来看，这如何为我们节省了成本？</h1><p id="97d5" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">你可能想知道，在这种复杂的设置下，我们如何比仅仅推出BitBucket并让Azure PaaS将其构建为应用服务节省更多的钱。答案如下:</p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="ky kz l"/></div></figure><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="ky kz l"/></div></figure><p id="2ebf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它不仅可以监听多个端口，还可以服务于多个(子)域。这意味着，如果它没有被最大化或以任何方式损坏，我不会设置另一台服务器来服务WeMove子域。</p><p id="7367" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于我们部署到Azure的每个ASP.NET核心应用程序，我们需要设置一个新的应用程序服务。要获得SSL，它必须比入门支付层高一层(或两层)。美国每层应用服务的月平均使用费用在25美元到30美元之间。SQL Azure等其他服务的成本会更高，尤其是当您有多个数据库用于暂存和生产时。</p><p id="3b50" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行Nginx的数字海洋水滴让我们可以使用同一个服务器运行所有的网络应用程序，收费20美元。Nginx允许我们根据收到的请求，反向代理每个ASP.NET Kestrel服务器。</p><p id="7013" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们的数据库仍在Azure中，我计划长期保持这种状态。</p></div><div class="ab cl nx ny hc nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="hn ho hp hq hr"><p id="01e4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">感谢您抽出时间阅读本文。</p><p id="b3ff" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下周我们将推出一项新服务，敬请关注。</p><p id="c638" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您想在尼日利亚拉各斯租用任何车辆，请使用我们的服务<a class="ae jp" href="https://wemove.co." rel="noopener ugc nofollow" target="_blank">https://wemove.co。</a>在社交媒体上关注我们:@WeMoveCo</p><div class="nc nd fm fo ne nf"><a href="https://twitter.com/WeMoveCo" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab ej"><div class="nh ab ni cl cj nj"><h2 class="bd hv fv z el nk eo ep nl er et ht dt translated">WeMove.co(@ WeMoveCo)|推特</h2><div class="nm l"><h3 class="bd b fv z el nk eo ep nl er et ek translated">来自WeMoveCo的最新推文(@WeMoveCo)。在拉各斯需要车吗？在线预订。或者拨打0808-651-4565。或电子邮件…</h3></div><div class="nn l"><p class="bd b gc z el nk eo ep nl er et ek translated">twitter.com</p></div></div><div class="no l"><div class="oe l nq nr ns no nt ls nf"/></div></div></a></div><div class="nc nd fm fo ne nf"><a href="https://www.instagram.com/WeMoveCo/" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab ej"><div class="nh ab ni cl cj nj"><h2 class="bd hv fv z el nk eo ep nl er et ht dt translated">WeMove.co(@ wemoveco)* insta gram照片和视频</h2><div class="nm l"><h3 class="bd b fv z el nk eo ep nl er et ek translated">77个关注者，110个关注者，18个帖子-见来自wemoveco的Instagram照片和视频(@wemoveco)</h3></div><div class="nn l"><p class="bd b gc z el nk eo ep nl er et ek translated">www.instagram.com</p></div></div><div class="no l"><div class="of l nq nr ns no nt ls nf"/></div></div></a></div><div class="nc nd fm fo ne nf"><a href="https://www.facebook.com/WeMoveCo/" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab ej"><div class="nh ab ni cl cj nj"><h2 class="bd hv fv z el nk eo ep nl er et ht dt translated">WeMove.co</h2><div class="nm l"><h3 class="bd b fv z el nk eo ep nl er et ek translated">WeMove.co。177喜欢11谈论这个。租用您需要的车辆来运送您、您的客人或您的货物…</h3></div><div class="nn l"><p class="bd b gc z el nk eo ep nl er et ek translated">www.facebook.com</p></div></div><div class="no l"><div class="og l nq nr ns no nt ls nf"/></div></div></a></div><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="oh kz l"/></div></figure></div></div>    
</body>
</html>