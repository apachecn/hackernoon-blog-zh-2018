<html>
<head>
<title>Developing a flash sale system</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开发一个快速销售系统</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/developing-a-flash-sale-system-7481f6ede0a3?source=collection_archive---------13-----------------------#2018-01-21">https://medium.com/hackernoon/developing-a-flash-sale-system-7481f6ede0a3?source=collection_archive---------13-----------------------#2018-01-21</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/b2179dd9c8a3159df15ac7850b7db009.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IDV0DLWDt0EVMh0BAML5NA.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="http://www.internationalnewsandviews.com/wp-content/uploads/2017/03/flash-sale-banner.png" rel="noopener ugc nofollow" target="_blank">http://www.internationalnewsandviews.com/wp-content/uploads/2017/03/flash-sale-banner.png</a></figcaption></figure><p id="4eb6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在中国有一个几乎每个中国人都使用的著名网站，我们通常一年只使用一次——12306.com，火车票预订系统。</p><p id="3ab6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">当网站开始销售农历新年的门票时，许多人都在电脑前等待，准备在销售开始的准确时间点击<code class="eh kf kg kh ki b">reserve</code>按钮。</p><p id="3823" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">然后，网站崩溃，用户投诉。</p><p id="abf2" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">(然后软件工程师反思如何修复)</p><h1 id="5095" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">什么是闪购系统</h1><p id="544d" class="pw-post-body-paragraph jh ji hu jj b jk lh jm jn jo li jq jr js lj ju jv jw lk jy jz ka ll kc kd ke hn dt translated">上面的例子是一个典型的闪购系统。它通常具有以下特征:</p><ol class=""><li id="3f34" class="lm ln hu jj b jk jl jo jp js lo jw lp ka lq ke lr ls lt lu dt translated">大量用户同时进入系统，导致流量激增。(早上6点开始售票，6:30结束)</li><li id="ab1e" class="lm ln hu jj b jk lv jo lw js lx jw ly ka lz ke lr ls lt lu dt translated">订购请求的数量远大于库存规模。(100万用户争夺1万张门票)</li></ol><h1 id="0e89" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">挑战是什么</h1><ol class=""><li id="1262" class="lm ln hu jj b jk lh jo li js ma jw mb ka mc ke lr ls lt lu dt translated">读取时处理负载。用户将不断刷新页面以查看可用库存。也有可能所有用户会同时请求其他类似的资源，如帐户、商品描述等。</li><li id="7c4e" class="lm ln hu jj b jk lv jo lw js lx jw ly ka lz ke lr ls lt lu dt translated">提供高吞吐量。对于有限的库存记录，将会有许多并发的读取和写入，因此数据库锁可能会导致某些请求超时。</li><li id="3446" class="lm ln hu jj b jk lv jo lw js lx jw ly ka lz ke lr ls lt lu dt translated">避免库存超卖或低价出售。如何处理可用库存数？如果多个请求保留了相同的库存，则某个项目可能会超卖。如果库存处于暂挂状态，但流程失败且库存未释放，则产品可能会销售不足。这种情况发生在一些电子商务网站上，通常他们会打电话给客户退款。</li><li id="1a59" class="lm ln hu jj b jk lv jo lw js lx jw ly ka lz ke lr ls lt lu dt translated">防止用脚本作弊。用户可以编写一个脚本来循环触发请求。所以这个用户可能会产生许多重复的请求</li></ol><h1 id="9701" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">设计考虑</h1><ol class=""><li id="69cb" class="lm ln hu jj b jk lh jo li js ma jw mb ka mc ke lr ls lt lu dt translated">来自上游的限制要求:我们库存有限，即使100万用户来，也只能服务其中的1000个。可以减少用户不必要的请求数量？</li><li id="9604" class="lm ln hu jj b jk lv jo lw js lx jw ly ka lz ke lr ls lt lu dt translated">分流流量:根本原因是我们要求用户同时来，造成秒杀。能不能把销售分成不同的时间段，邀请不同时间段的用户？</li><li id="9cdc" class="lm ln hu jj b jk lv jo lw js lx jw ly ka lz ke lr ls lt lu dt translated">异步处理:我们需要立即处理请求吗？或者我们可以接受请求，以我们的系统可以支持的速度处理它，并在可接受的时间内通知用户？</li><li id="ec35" class="lm ln hu jj b jk lv jo lw js lx jw ly ka lz ke lr ls lt lu dt translated">缓存、缓存、缓存:对从不/很少更改的资源进行多次重复读取。我们能把它们保存在缓存中以减轻数据库的负荷吗？</li><li id="f79b" class="lm ln hu jj b jk lv jo lw js lx jw ly ka lz ke lr ls lt lu dt translated">理解权衡并做出牺牲:我们真的需要显示实时库存吗？我们一年只有一次闪购，投入这么多资源有意义吗？</li><li id="8bf7" class="lm ln hu jj b jk lv jo lw js lx jw ly ka lz ke lr ls lt lu dt translated">数据库设计:同一问题的不同模式设计会有不同的权衡。</li><li id="18b6" class="lm ln hu jj b jk lv jo lw js lx jw ly ka lz ke lr ls lt lu dt translated">可伸缩性:我们能够横向扩展以支持更多用户吗？</li></ol><h1 id="36fb" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">分层优化</h1><h2 id="6b8d" class="md kk hu bd kl me mf mg kp mh mi mj kt js mk ml kx jw mm mn lb ka mo mp lf mq dt translated">客户</h2><p id="4d05" class="pw-post-body-paragraph jh ji hu jj b jk lh jm jn jo li jq jr js lj ju jv jw lk jy jz ka ll kc kd ke hn dt translated">当用户提交请求后没有得到即时响应时，他们会一次又一次地点击按钮。但是，这些请求是重复的，会给系统带来不必要的负载。(想象一下，每个用户再提交9个请求，那么系统收到的90%的请求都是多余的)</p><p id="e8e0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们能做的是:</p><ol class=""><li id="b21b" class="lm ln hu jj b jk jl jo jp js lo jw lp ka lq ke lr ls lt lu dt translated">提交后禁用提交按钮</li><li id="22bf" class="lm ln hu jj b jk lv jo lw js lx jw ly ka lz ke lr ls lt lu dt translated">仅在最近1分钟内没有重复请求的情况下发送请求。</li></ol><p id="114d" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这将减少来自客户端的大部分不必要的请求，但是，它并不阻止用户编写脚本来绕过客户端的限制。因此，我们需要做更多的工作。</p><h2 id="3e7b" class="md kk hu bd kl me mf mg kp mh mi mj kt js mk ml kx jw mm mn lb ka mo mp lf mq dt translated">门</h2><p id="e28d" class="pw-post-body-paragraph jh ji hu jj b jk lh jm jn jo li jq jr js lj ju jv jw lk jy jz ka ll kc kd ke hn dt translated">当一个请求到达网关时，我们跟踪同一个用户的请求号。简单有效的解决方案是在内存中为每个用户ID保留一个计数器。</p><p id="8c36" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果该用户最近发出了相同的请求，我们可以放弃请求或返回相同的响应。</p><p id="e61a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">但是，如果这个用户创建了数千个用户帐户呢？我们将在服务层处理它。</p><h2 id="0e2d" class="md kk hu bd kl me mf mg kp mh mi mj kt js mk ml kx jw mm mn lb ka mo mp lf mq dt translated">服务</h2><p id="b899" class="pw-post-body-paragraph jh ji hu jj b jk lh jm jn jo li jq jr js lj ju jv jw lk jy jz ka ll kc kd ke hn dt translated">现在到达服务层的请求少了很多。我们开始处理吧。</p><ol class=""><li id="89a5" class="lm ln hu jj b jk jl jo jp js lo jw lp ka lq ke lr ls lt lu dt translated"><strong class="jj hv"> <em class="mr">管理可用库存</em> </strong></li></ol><p id="1baf" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们需要做的第一件事是检查可用库存。我们如何获得剩余的库存规模？</p><p id="7be2" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果我们使用类似于<code class="eh kf kg kh ki b">COUNT</code>的聚集来查询数据库，首先，我们可能需要为影响性能的事务设置一个<code class="eh kf kg kh ki b">serialisable</code>隔离级别。如果我们不应用这种隔离级别，我们可能会以幻像读取结束，并认为我们仍然有足够的库存请求，然后我们销售超过我们所拥有的。</p><p id="0a69" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">为了解决这个问题，我们可以使用一个具有原子性的计数器。当需要处理请求时，Redis将是原子减量的一个好选择。</p><p id="1cf9" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv"> <em class="mr"> 2。带消息队列</em>的缓冲区</strong></p><p id="0815" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">处理交易可能会非常复杂和繁重。例如，根据用户的忠诚度积分自动应用促销。</p><p id="294c" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">因此，让我们使用消息队列来缓冲请求，并让服务以自己的速度处理它。</p><h2 id="3475" class="md kk hu bd kl me mf mg kp mh mi mj kt js mk ml kx jw mm mn lb ka mo mp lf mq dt translated">数据库ˌ资料库</h2><p id="4b66" class="pw-post-body-paragraph jh ji hu jj b jk lh jm jn jo li jq jr js lj ju jv jw lk jy jz ka ll kc kd ke hn dt translated">现在，到达数据库的请求数量已经大大减少到可接受的数量。</p><p id="29cc" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们可以专注于设计更好的模式，优化查询，也许还可以对表进行分片。</p><h1 id="08cb" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">讨论</h1><blockquote class="ms mt mu"><p id="8a15" class="jh ji mr jj b jk jl jm jn jo jp jq jr mv jt ju jv mw jx jy jz mx kb kc kd ke hn dt translated">所以现在我可以直接把这个设计复制到我的项目里了？</p></blockquote><p id="d3c8" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">不。首先，这取决于你的要求。其次，你可能不需要花费这么多的努力，可能有其他更好的方法。</p><h1 id="475e" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">结论</h1><p id="1e1e" class="pw-post-body-paragraph jh ji hu jj b jk lh jm jn jo li jq jr js lj ju jv jw lk jy jz ka ll kc kd ke hn dt translated">这篇文章是一个简短的flash销售系统设计的案例研究。它为正在解决类似问题的人们提供了一个通用的指南和可能的启发。</p></div></div>    
</body>
</html>