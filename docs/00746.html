<html>
<head>
<title>How Tensorflow’s tf.image.resize stole 60 days of my life</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Tensorflow的tf.image.resize如何偷走了我生命中的60天</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-tensorflows-tf-image-resize-stole-60-days-of-my-life-aba5eb093f35?source=collection_archive---------6-----------------------#2018-01-24">https://medium.com/hackernoon/how-tensorflows-tf-image-resize-stole-60-days-of-my-life-aba5eb093f35?source=collection_archive---------6-----------------------#2018-01-24</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="cc78" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">这是对所有使用视觉内容的Tensorflow用户的一个简短警告。简短通知:不要使用任何<strong class="ak"> tf.image.resize </strong>函数！</h2></div><p id="cf11" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我正在重写我们的<a class="ae kf" href="https://letsenhance.io" rel="noopener ugc nofollow" target="_blank">神经网络图像升级服务</a>的代码库——让我们为更大更快的模型和API做好准备。当我们处理图像生成(超分辨率、去模糊等)时，我们依赖于典型的图像处理库，如OpenCV和PIL。我一直怀疑使用Tensorflow图像处理功能是有意义的——理论上，它们应该更快。因此，我决定坚持使用原生的Tensorflow图像预处理和数据集构建工具，使用dataset.map()将所有张量中的操作都放在我的代码周围。</p><p id="e7de" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这个问题相当糟糕——我新的、闪亮的超分辨率代码不仅不能复制任何最先进的网络，甚至不能复制我自己4个月前写的代码。最丑陋的部分是超分辨率本身的结果有时非常好，网络在工作，尽管没有达到目标PSNR，有时会有奇怪的视觉伪像，比如小线条的重叠。</p><h2 id="894b" class="kg kh hu bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la dt translated">让调试开始</h2><p id="0c96" class="pw-post-body-paragraph jj jk hu jl b jm lb iv jo jp lc iy jr js ld ju jv jw le jy jz ka lf kc kd ke hn dt translated">最初看起来很小的问题变成了60天的挣扎和不眠之夜。我的错误逻辑很简单——网络定义或训练过程有问题。数据预处理肯定是好的，因为我在Tensorboard中获得了有意义的结果和对图像处理的视觉控制。</p><p id="d0cb" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我调整了我能找到的一切，用Keras、Slim、raw TF定义了网络——什么都没有，寻找TF 1.3-&gt;1.4-&gt;1.5和不同CUDA版本、paddings行为的变化。我甚至羞于告诉你我最近的怀疑，这涉及到GPU RAM和静力学方面的缺陷。我在调整感知损失和风格损失，寻找原因。每一次迭代都需要几天的时间来重新训练，直到得到一些有意义的结果…</p><p id="b832" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">昨天看Tensorboard的时候发现了<strong class="jl hv">这个Bug，</strong>。这几乎是潜意识的感觉，图像有问题。我忽略了网络输出，只在Photoshop中叠加了目标图像和输入图像(即缩小的目标图像)。这是我得到的。</p><figure class="lh li lj lk fq ll fe ff paragraph-image"><div class="fe ff lg"><img src="../Images/04b2129ff28d9789c873b47498514a8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*ag9j3VGk7wFmq56cTv6aTQ.gif"/></div></figure><p id="398e" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">看起来很奇怪，这里发生了某种位移。完全违背任何逻辑，这不可能是真的！我的代码非常简单。读取图像，裁剪图像，调整图像大小。全在Tensorflow。</p><p id="3d35" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">反正RTFM。tf.image.resize_bicubic有一个参数——“对齐角”。你到底想怎样缩小图像而不对齐边角呢？你可以！所以这个函数有一个很奇怪的行为已经知道很久了——<a class="ae kf" href="https://github.com/tensorflow/tensorflow/issues/6720" rel="noopener ugc nofollow" target="_blank">读这个线程</a>。他们无法修复它，因为这会破坏大量旧代码和预先训练好的网络。</p><blockquote class="lo lp lq"><p id="98a0" class="jj jk lr jl b jm jn iv jo jp jq iy jr ls jt ju jv lt jx jy jz lu kb kc kd ke hn dt translated">我们的<code class="eh lv lw lx ly b">tf.image.resize_area</code>函数甚至不是反射等变的。修复这个很好，但是我担心会破坏旧的模型。</p></blockquote><p id="2fab" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这段代码实际上把你的图像向左上方移动了一个像素。Thread暗示TensorFlow里连插值都破了。2018年了，各位。这是TF的实际降尺度结果。</p><figure class="lh li lj lk fq ll fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff lz"><img src="../Images/9f5a967b7432bbdc9e54fc9549142303.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GUkWEyUDtYLRxwKRUO-3vQ.png"/></div></div></figure><p id="62c5" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">坚持使用Scipy/OpenCV/numpy/PIL，无论你喜欢什么图像处理。在我改变它的第二天，我的网络工作得非常好(实际上是第二天，当我看到训练结果的时候)。</p></div></div>    
</body>
</html>