<html>
<head>
<title>Level Triggering and Reconciliation in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes中的级别触发和协调</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/level-triggering-and-reconciliation-in-kubernetes-1f17fe30333d?source=collection_archive---------9-----------------------#2018-01-24">https://medium.com/hackernoon/level-triggering-and-reconciliation-in-kubernetes-1f17fe30333d?source=collection_archive---------9-----------------------#2018-01-24</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="74b3" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">Kubernetes如何用系统编程概念管理您的集群</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/32352a26e994a02f930a201c9da8f914.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mFcFKEbX_hCrTztoorM7XQ.png"/></div></div></figure><blockquote class="jv jw jx"><p id="8516" class="jy jz ka kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated"><em class="hu">揭秘:</em> <a class="ae kv" href="https://goo.gl/BtueKD" rel="noopener ugc nofollow" target="_blank">开发者集市流形</a> <em class="hu">之前赞助过黑客正午。</em> <a class="ae kv" href="https://goo.gl/BtueKD" rel="noopener ugc nofollow" target="_blank">使用code HACKERNOON2018获得任何服务10美元优惠。</a></p></blockquote><p id="180c" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">到目前为止，Kubernetes是最受欢迎的容器编制器。它的成功很大程度上来自于它的可靠性。所有的软件都有缺陷。在运行容器时，Kubernetes比其他选择更容易出错。</p><p id="0175" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">Kubernetes最终会及时达到您期望的运行容器数量。它坚持不懈地保持着这个数字。<a class="ae kv" href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" rel="noopener ugc nofollow" target="_blank"> Kubernetes文档</a>将此称为Kubernetes正在<strong class="kb hv">自愈。</strong>这种行为源自Kubernetes设计中的一个核心理念。</p><blockquote class="jv jw jx"><p id="dc9f" class="jy jz ka kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">“控制回路的目标寻找行为非常稳定。这一点已经在Kubernetes中得到证明，我们有一些未被注意到的错误，因为控制循环基本上是稳定的，并且会随着时间的推移自行纠正。</p><p id="2605" class="jy jz ka kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">如果你处于边缘触发状态，你将面临危及自身状态的风险，并且永远无法重新创建状态。如果你是水平触发的模式是非常宽容的，并允许组件的行为不应该被纠正的空间。这就是Kubernetes如此出色的原因。"</p><p id="fe7d" class="jy jz ka kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">Heptio首席技术官Joe Beda(引自Justin Garrison和Kris Nova的<a class="ae kv" href="http://shop.oreilly.com/product/0636920075837.do" rel="noopener ugc nofollow" target="_blank">云原生基础设施</a></p></blockquote><h1 id="64d4" class="kz la hu bd lb lc ld le lf lg lh li lj ja lk jb ll jd lm je ln jg lo jh lp lq dt translated">中断:边沿和电平触发</h1><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff lr"><img src="../Images/6620f0e8f1964fd8a891a864dd5110de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xzMwQrVwmeW8agLsS5he0A@2x.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">Edge and level triggering for the same signal.</figcaption></figure><p id="bc40" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">边沿和电平触发是来自电子和<a class="ae kv" href="https://en.wikipedia.org/wiki/Interrupt#Types_of_interrupts" rel="noopener ugc nofollow" target="_blank">系统编程</a>的概念。它们指的是系统应该如何随着时间的推移对电信号(或数字逻辑)的形状做出响应。当信号从低变高和从高变低时，系统应该关心<strong class="kb hv">，还是应该关心</strong>信号是否为高？</p><p id="d779" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">换一种方式来解释，给出下面的简单加法:</p><pre class="jk jl jm jn fq lw lx ly lz aw ma dt"><span id="e187" class="mb la hu lx b fv mc md l me mf">&gt; let <strong class="lx hv">a</strong> = <strong class="lx hv">3</strong>;<br/>&gt; <strong class="lx hv">a</strong> += <strong class="lx hv">4</strong>;<br/>&lt; <strong class="lx hv">7</strong></span></pre><p id="f47d" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">在操作的边缘触发视图中，我们会看到:</p><pre class="jk jl jm jn fq lw lx ly lz aw ma dt"><span id="9d3c" class="mb la hu lx b fv mc md l me mf">add <strong class="lx hv">4</strong> to <strong class="lx hv">a</strong></span></pre><p id="bc62" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">这将在添加时发生一次。</p><p id="2c19" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">在操作的级别触发视图中，我们会看到:</p><pre class="jk jl jm jn fq lw lx ly lz aw ma dt"><span id="ee9b" class="mb la hu lx b fv mc md l me mf"><strong class="lx hv">a</strong> is <strong class="lx hv">7</strong></span></pre><p id="66d4" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">从添加开始，我们会不断看到这种情况，直到下一个事件发生。</p><h1 id="fefd" class="kz la hu bd lb lc ld le lf lg lh li lj ja lk jb ll jd lm je ln jg lo jh lp lq dt translated">分布式系统中的边沿和电平触发</h1><p id="8052" class="pw-post-body-paragraph jy jz hu kb b kc mg iv ke kf mh iy kh kw mi kk kl kx mj ko kp ky mk ks kt ku hn dt translated">理论上，边沿触发和电平触发没有明显的区别。在现实世界中，即使在系统编程级别，我们也必须处理实际的限制。一个常见的限制是<a class="ae kv" href="https://en.wikipedia.org/wiki/Sampling_(signal_processing)#Sampling_rate" rel="noopener ugc nofollow" target="_blank">采样率</a>。如果系统对信号的采样不够频繁，它可能会错过一个触发信号，要么是边沿跳变，要么是电平的短暂变化。</p><p id="e9bb" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">在更大规模的全计算机和大型网络上，有更多的问题需要<a class="ae kv" href="https://en.wikipedia.org/wiki/Fallacies_of_distributed_computing" rel="noopener ugc nofollow" target="_blank">去解决。</a><a class="ae kv" href="http://www.cbc.ca/news/canada/nova-scotia/cellular-service-outage-bell-mobility-tellus-1.4235624" rel="noopener ugc nofollow" target="_blank">网</a>不靠谱。人<a class="ae kv" href="https://hothardware.com/news/dont-trip-over-the-power-cord-human-error-caused-massive-time-warner-network-outage" rel="noopener ugc nofollow" target="_blank">笨拙</a>。松鼠是不屈不挠的。在某种程度上，这些问题就像一个坏的或不一致的采样率。它们遮住了我们对信号的视线。</p><h1 id="f6ae" class="kz la hu bd lb lc ld le lf lg lh li lj ja lk jb ll jd lm je ln jg lo jh lp lq dt translated">中断会改变感知</h1><p id="8947" class="pw-post-body-paragraph jy jz hu kb b kc mg iv ke kf mh iy kh kw mi kk kl kx mj ko kp ky mk ks kt ku hn dt translated">让我们看看信号中断如何影响在边沿和电平触发系统中的观察:</p><h2 id="89d9" class="mb la hu bd lb ml mm mn lf mo mp mq lj kw mr ms ll kx mt mu ln ky mv mw lp mx dt translated">理想条件</h2><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff lr"><img src="../Images/968b9e69de13475b37ee892f1176eb08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*upiRs-xAI_9DRtXsI-6c5Q@2x.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">How edge and level triggered systems interpret a signal.</figcaption></figure><p id="a213" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">在理想条件下，边沿触发和电平触发系统都能观察到正确的信号。在信号从开转变为关之后，它们都立即将信号视为处于关状态。</p><h2 id="7b7e" class="mb la hu bd lb ml mm mn lf mo mp mq lj kw mr ms ll kx mt mu ln ky mv mw lp mx dt translated">两次中断</h2><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff lr"><img src="../Images/6758c8f23388b1f4be2be82061b94570.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CAwLrPetoaHyO1dFAQq6bA@2x.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">Disrupting the rise and fall loses the high signal for the edge triggered system, but arrives at the correct end state.</figcaption></figure><p id="16a6" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">由于信号状态的前两次变化周围有两次中断，边缘触发系统和水平触发系统之间的差异很明显。信号的边沿触发视图错过了第一次上升。水平触发系统假定信号处于其最后观察到的状态，直到它看到其他情况。这导致观察到的信号大部分是正确的，但是延迟到中断之后。</p><h2 id="d15f" class="mb la hu bd lb ml mm mn lf mo mp mq lj kw mr ms ll kx mt mu ln ky mv mw lp mx dt translated">一次中断</h2><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff lr"><img src="../Images/43f45b08e9e9011af8484c5838abb599.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fv_GwEYgek9agPJvsTAc-g@2x.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">A single well-placed disruption can have a large impact on the edge triggered system.</figcaption></figure><p id="84cf" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">更少的干扰并不总是带来更好的结果。随着一个单一的干扰掩盖了从高回落到低，水平触发系统基本上又是正确的。边沿触发系统只看到两次上升，导致原始信号从未出现的状态。</p><p id="54ab" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">为了再次用加法来表达这一点，信号表达为:</p><pre class="jk jl jm jn fq lw lx ly lz aw ma dt"><span id="c78c" class="mb la hu lx b fv mc md l me mf">&gt; let <strong class="lx hv">a</strong> = <strong class="lx hv">1</strong>;<br/>&gt; <strong class="lx hv">a</strong> += <strong class="lx hv">1</strong>;<br/>&gt; <strong class="lx hv">a</strong> -= <strong class="lx hv">1</strong>;<br/>&gt; <strong class="lx hv">a</strong> += <strong class="lx hv">1</strong>;<br/>&lt; <strong class="lx hv">2</strong></span></pre><p id="a251" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">但是边缘触发系统观察到:</p><pre class="jk jl jm jn fq lw lx ly lz aw ma dt"><span id="68ac" class="mb la hu lx b fv mc md l me mf">&gt; let <strong class="lx hv">a</strong> = <strong class="lx hv">1</strong>;<br/>&gt; <strong class="lx hv">a</strong> += <strong class="lx hv">1</strong>;<br/>&gt; <strong class="lx hv">a</strong> += <strong class="lx hv">1</strong>;<br/>&lt; <strong class="lx hv">3</strong></span></pre><h1 id="cf1e" class="kz la hu bd lb lc ld le lf lg lh li lj ja lk jb ll jd lm je ln jg lo jh lp lq dt translated">调和期望状态和实际状态</h1><p id="fb70" class="pw-post-body-paragraph jy jz hu kb b kc mg iv ke kf mh iy kh kw mi kk kl kx mj ko kp ky mk ks kt ku hn dt translated">Kubernetes观察的不仅仅是一个信号，而是两个信号:集群的期望状态和实际状态。期望的状态是使用集群的人希望它处于的状态(<em class="ka">“运行我的应用程序容器的两个实例”</em>)。理想情况下，实际状态与期望状态相匹配，但是它会受到许多硬件故障和恶意攻击的影响。这些会使它偏离理想状态。甚至时间也是一个因素，因为不可能立即让实际状态与期望状态相匹配。容器映像必须从注册表中下载，应用程序需要时间来正常关闭，等等。</p><p id="c696" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">Kubernetes必须获取实际状态，然后<strong class="kb hv">将它与期望的状态进行协调</strong>。它连续地这样做，取两种状态，确定它们之间的差异，并应用任何必须进行的改变，以使实际状态接近期望状态。</p><h2 id="8528" class="mb la hu bd lb ml mm mn lf mo mp mq lj kw mr ms ll kx mt mu ln ky mv mw lp mx dt translated">在Kubernetes扩展部署</h2><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff lr"><img src="../Images/ec1eb642fc1d931f90ac812139acb751.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PT8EMfrvsnit1A_eYPq66A@2x.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">In an edge triggered system, we could diverge wildly from our desired outcome.</figcaption></figure><p id="6257" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">即使网络没有中断，尝试协调两种状态的edge触发系统也可能以不正确的结果结束。</p><p id="b91f" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">如果我们从单个容器副本开始，并希望扩展到5个副本，然后减少到两个副本，则边缘触发的系统将看到以下期望状态:</p><pre class="jk jl jm jn fq lw lx ly lz aw ma dt"><span id="d0e0" class="mb la hu lx b fv mc md l me mf">&gt; let <strong class="lx hv">replicas</strong> = <strong class="lx hv">1</strong>;<br/>&gt; <strong class="lx hv">replicas</strong> += <strong class="lx hv">4</strong>;<br/>&gt; <strong class="lx hv">replicas</strong> -= <strong class="lx hv">3</strong>;</span></pre><p id="c06a" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">系统的实际状态不能对这些命令立即做出反应。如图所示，当只有3个副本运行时，它可能会终止3个副本。这给我们留下了0个副本，而不是所需的2个。</p><p id="e286" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">在电平触发系统中，我们总是比较完整的期望状态和实际状态。这减少了状态不同步的机会(一个错误)。</p><h1 id="7da4" class="kz la hu bd lb lc ld le lf lg lh li lj ja lk jb ll jd lm je ln jg lo jh lp lq dt translated">拉平</h1><p id="1d38" class="pw-post-body-paragraph jy jz hu kb b kc mg iv ke kf mh iy kh kw mi kk kl kx mj ko kp ky mk ks kt ku hn dt translated">边沿触发本身并不坏；它确实比电平触发有优势。边沿触发仅在发生变化时传输发生变化的内容。</p><p id="b1fc" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">可以减轻与边缘触发系统中的中断相关的问题。这通常通过与完整状态的定期协调来完成，就像水平触发系统如何工作一样。还可以通过事件的显式排序和版本控制来减轻中断。</p><p id="0c4f" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated">对于Kubernetes来说，将问题视为一个级别触发的系统已经导致了一个干净、简单的体系结构，并且尽管分布式计算中存在固有的问题，但它还是做了用户想要的事情。</p></div><div class="ab cl my mz hc na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="hn ho hp hq hr"><p id="3aef" class="pw-post-body-paragraph jy jz hu kb b kc kd iv ke kf kg iy kh kw kj kk kl kx kn ko kp ky kr ks kt ku hn dt translated"><em class="ka">特别感谢</em><a class="nf ng gr" href="https://medium.com/u/5a7755145e53?source=post_page-----1f17fe30333d--------------------------------" rel="noopener" target="_blank"><em class="ka">Meg Smith</em></a><em class="ka">为本文提供的图表。</em></p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><a href="https://goo.gl/BtueKD"><div class="fe ff nh"><img src="../Images/2193d0612cdd27051ebd23d087265c08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ryuTx6HWegvTsQVsb2i2vA.png"/></div></a></figure></div></div>    
</body>
</html>