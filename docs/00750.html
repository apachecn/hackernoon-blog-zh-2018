<html>
<head>
<title>A C++ Hello World And the Cute Heartless Rainbow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个C++ Hello World和可爱无情的彩虹</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/a-c-hello-world-and-the-cute-heartless-rainbow-3cc9695f4142?source=collection_archive---------10-----------------------#2018-01-24">https://medium.com/hackernoon/a-c-hello-world-and-the-cute-heartless-rainbow-3cc9695f4142?source=collection_archive---------10-----------------------#2018-01-24</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="1371" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是我们构建“Hello World”应用程序系列的第二部分。如果你参加聚会迟到了，我鼓励你先看看第一部分。</p><div class="jp jq fm fo jr js"><a href="https://hackernoon.com/a-c-hello-world-and-a-glass-of-wine-oh-my-263434c0b8ad" rel="noopener  ugc nofollow" target="_blank"><div class="jt ab ej"><div class="ju ab jv cl cj jw"><h2 class="bd hv fv z el jx eo ep jy er et ht dt translated">一个C++ Hello World和一杯葡萄酒，天啊！</h2><div class="jz l"><h3 class="bd b fv z el jx eo ep jy er et ek translated">其中我们尝试在Linux上使用Microsoft Visual C++编译器</h3></div><div class="ka l"><p class="bd b gc z el jx eo ep jy er et ek translated">hackernoon.com</p></div></div><div class="kb l"><div class="kc l kd ke kf kb kg kh js"/></div></div></a></div></div><div class="ab cl ki kj hc kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hn ho hp hq hr"><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="fe ff kp"><img src="../Images/8d01814d99b2cdef5fc56c8138122313.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sC1_SuuV-v_TWQbtWnDrGQ.png"/></div></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">Hic Sunt Arcūs</figcaption></figure><p id="2cac" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以，我们的老板进来检查我们的进展。他们开始想知道为什么要花一整天的时间将一个3行应用程序移植到一个新系统上。但他们此行的真正原因是想要一个新功能。虽然我们的“Hello world”业务蒸蒸日上，但市场部认为缺乏图形用户界面影响了销售。</p><p id="d731" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">看，没有人能逃脱软件膨胀。</p><p id="967d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">还是。急于让老板忘记在Linux上设置MSVC所花的时间，我做了更多的工作，完成了我们应用程序的全部重写。</p><figure class="kq kr ks kt fq ku"><div class="bz el l di"><div class="le lf l"/></div></figure><p id="cc0c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然，我们还提供了一个小巧的构建文件。</p><figure class="kq kr ks kt fq ku"><div class="bz el l di"><div class="le lf l"/></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">QBS is love, QBS is life. CMake is definitively Shrek 👹</figcaption></figure><p id="8d6b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Linux版本仍然运行良好。咄</p><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div class="fe ff lg"><img src="../Images/3508ac35a03c0cd67ffea85de2650ab5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*I-3Z4ePysVLAevKL49zdLw.png"/></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">The author likes to pretend all Linux machines are born with Qt And QBS installed. Just play along.</figcaption></figure><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div class="fe ff lh"><img src="../Images/594c3001fe23b98e97325baff301d0ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:458/format:webp/1*CqWp5CUXeQKrw1jADp4eqg.png"/></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">In case of nuclear disaster, click “no”</figcaption></figure><p id="2a3b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们热情地打造Windows版本</p><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="fe ff li"><img src="../Images/78077fa5dc61864095b58f06a3110ee2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DRHrS8YCdtWTpAGZG3sVSw.png"/></div></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">Not so Qt.</figcaption></figure><p id="7388" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">是的，事实证明，我们需要一个与我们的编译器兼容的Qt版本。现在，甚至QBS都不知道Qt。</p><p id="9056" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我去https://www.qt.io/download的<a class="ae lj" href="https://www.qt.io/download" rel="noopener ugc nofollow" target="_blank">上下载Qt。那个网站一天比一天差。Qt公司试图劝阻人们使用开源版本。但是如果你去</a><a class="ae lj" href="https://download.qt.io/" rel="noopener ugc nofollow" target="_blank">https://download.qt.io/</a>你有所有的tarballs和安装程序。</p><p id="fabf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">说到安装程序，他们没有为Windows提供64位版本。2018年。我们可能不得不把自己限制在32位，然后用葡萄酒提取。除了它不起作用，因为Qt安装程序框架没有静默模式(显然，你可以用100行JavaScript编写一个静默模式)，并且使用了一些WINE不支持的Windows方法。</p><p id="4f36" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">没关系。我将自己建立Qt来证明我的葡萄酒工具链有多棒。它将是64位。我会被提升，有4个博士学位的实习生会给我带来卡布奇诺。也许人们甚至会把我的名字当作一个动词(如果你还不知道的话，你一定要去看看！).</p><p id="b7d1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">除了。Qt还是用<code class="eh lk ll lm ln b">qmake</code>来自建。而<code class="eh lk ll lm ln b">qmake</code>的存在只是为了让<code class="eh lk ll lm ln b">cmake</code>看起来更酷更现代。有一个<a class="ae lj" href="http://code.qt.io/cgit/qt/qtbase.git/log/?h=wip/qbs2" rel="noopener ugc nofollow" target="_blank">正在努力</a>用<code class="eh lk ll lm ln b">qbs</code>构建Qt，虽然这非常令人兴奋，但它可能有点太前沿了，即使对这个博客来说也是如此。</p><p id="00cc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以，我们被<code class="eh lk ll lm ln b">qmake</code>困住了。<code class="eh lk ll lm ln b">qmake</code>是一个构建系统生成器，不幸的是它合并了工具链和构建系统。我确实尝试过为我的wine工具链创建配置，它实际上相当简单，并且确实用适当的命令生成了一些Makefiles。但它们是<code class="eh lk ll lm ln b">nmake</code>的Makefiles，这是一个类似make的windows工具，尽管其格式与最初的make不太兼容。我试着使用<code class="eh lk ll lm ln b">nmake</code>(这很好)，但是所有后续的<code class="eh lk ll lm ln b">cl.exe</code> / <code class="eh lk ll lm ln b">link.exe</code>调用都发生在wine环境中，这意味着它执行实际的crude而不是我们的包装器，所以我们粗糙的斜杠到反斜杠的转换脚本永远不会运行，编译失败，因为<code class="eh lk ll lm ln b">cl.exe</code>假设任何以<code class="eh lk ll lm ln b">/</code>开头的都是选项。我们不能让nmake调用我们的假包装器，因为nmake是一个windows进程，windows不知道ELF。</p><p id="54fe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是留给读者的一个练习，让他们计算使用<code class="eh lk ll lm ln b">\</code>作为路径分隔符的Windows花费了多少亿美元，以及这个行业的成本。</p><p id="ba26" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">解决方案是给<code class="eh lk ll lm ln b">qmake</code>打补丁。这是连<code class="eh lk ll lm ln b">qmake</code>的维护者都极力避免的。所以我们不要那么做。</p><p id="6c92" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">非常抱歉，但是我们将返回到我们的Windows VM并从那里构建Qt。</p><blockquote class="lo"><p id="a93f" class="lp lq hu bd lr ls lt lu lv lw lx jo ek translated">那应该很简单吧？</p></blockquote><p id="3768" class="pw-post-body-paragraph ir is hu it b iu ly iw ix iy lz ja jb jc ma je jf jg mb ji jj jk mc jm jn jo hn dt translated">当然，VC构建工具无法正确设置它们的环境。</p><p id="7629" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">建立一个构建环境需要多少名微软工程师？当然有不少，因为我能够在20个左右的文件中找到大约1900行批处理脚本。可能还有更多。</p><p id="c01c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我设法把我的环境分成三行。请记住，无论您的构建系统有多复杂，它都可以归结为一些变量。编译器不需要太多。</p><pre class="kq kr ks kt fq md ln me mf aw mg dt"><span id="5981" class="mh mi hu ln b fv mj mk l ml mm">set "INCLUDE=C:\Program Files (x86)\Microsoft Visual       Studio\2017\BuildTools\VC\Tools\MSVC\14.12.25827\include;<br/> %INCLUDE%"<br/>set "LIB=C:\Program Files (x86)\Microsoft Visual Studio\2017\BuildTools\VC\Tools\MSVC\14.12.25827\lib\x64\;%LIB%"<br/>set "PATH=%PATH%;C:\Users\cor3ntin\Documents\qtbase-everywhere-src-5.10.0\gnuwin32"</span></pre><p id="9bfc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">之后就是下载Qt 5.10设置x64构建环境的问题了(我用的是<code class="eh lk ll lm ln b">vcvars64.bat</code> +上面那三行，不过你可以手动设置<code class="eh lk ll lm ln b">PATH</code>，根本不用<code class="eh lk ll lm ln b">vcvars.bat</code>费心)。</p><p id="769f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">确保<code class="eh lk ll lm ln b">perl</code>已安装并在<code class="eh lk ll lm ln b">PATH</code>中。</p><p id="bc51" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">出于本文的目的，我只需要Qt Base(核心、Gui、网络…)所以这就是我正在构建的。构建使用chromium的QtWebEngine要复杂一些。</p><pre class="kq kr ks kt fq md ln me mf aw mg dt"><span id="067d" class="mh mi hu ln b fv mj mk l ml mm">configure -release -opensource -confirm-license -platform win32-msvc -nomake examples -nomake tests<br/>nmake<br/>nmake install</span></pre><p id="4ab5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦Qt完成构建，将文件夹复制回您的linux主机。你至少需要<code class="eh lk ll lm ln b">bin, include, lib, plugins</code>。把它们放在一个新的目录里。我把我的叫做<code class="eh lk ll lm ln b">qt5_10base-x64</code>。</p><p id="af2f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我对引用<code class="eh lk ll lm ln b">src</code>有疑问。所以你可以从windows上的Qt目录运行<code class="eh lk ll lm ln b">perl bin\syncqt.pl -copy -windows -version 5.10.0 -outdir cpy</code>，并使用在<code class="eh lk ll lm ln b">cpy</code>中生成的include文件夹。即使这样，我也不得不手动将一些文件(qconfig.h，q{core，gui，widgets，network，xml}-config.h)从src文件夹复制到它们各自的include文件夹中。确实有点复杂，但最终你会到达那里。</p><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="fe ff mn"><img src="../Images/8d494389a4675be32884b675ce87527e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ENI-1QJHfRmp1JUBO5U1yg.png"/></div></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">My Linux is slowly morphing into a Windows Box. I expect Clippy to appear at any moment now.</figcaption></figure><p id="69cc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以现在我们有Qt。但是我们怎么能告诉QBS实际使用它呢？</p><p id="feb8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">QBS的个人资料系统是它伟大的原因之一。您可以全局设置编译器工具链，并毫不费力地从一个工具链切换到另一个工具链。</p><p id="ae31" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，为了与Qt一起工作，qbs需要每个概要文件有一套完整的模块。我们前面使用的gcc概要文件由160个qbs文件组成，设置每个Qt库和组件。</p><p id="3b0c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">幸运的是，你需要做的就是调用这个方便的工具。</p><pre class="kq kr ks kt fq md ln me mf aw mg dt"><span id="0728" class="mh mi hu ln b fv mj mk l ml mm">qbs-setup-qt -h                                             <br/>This tool creates qbs profiles from Qt versions.<br/><br/>Usage:<br/><br/>    qbs-setup-qt [--settings-dir &lt;settings directory&gt;] --detect<br/><br/>    qbs-setup-qt [--settings-dir &lt;settings directory&gt;] &lt;path to qmake&gt; &lt;profile name&gt;<br/><br/>    qbs-setup-qt -h|--help<br/><br/>The first form tries to auto-detect all known Qt versions, looking them up via the PATH environment variable.<br/><br/>The second form creates one profile for one Qt version.</span></pre><p id="e21f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">只是我们不能从linux中调用这个工具，因为构建的qmake是一个windows应用程序，预计将在Windows上运行。希望有一天我们能完全摆脱qmake，但是现在，回到我们的Windows机器上。</p><p id="8e9d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们首先<a class="ae lj" href="https://doc.qt.io/qbs/installing.html" rel="noopener ugc nofollow" target="_blank">安装qbs的windows版本</a>并运行该工具。</p><pre class="kq kr ks kt fq md ln me mf aw mg dt"><span id="e1da" class="mh mi hu ln b fv mj mk l ml mm">qbs-windows-x86_64-1.10.0\bin\qbs-setup-qt.exe --settings-dir . bin\qmake.exe msvc14-x64-qt</span></pre><p id="ee60" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这应该会创建一个带有适当Qt配置的<code class="eh lk ll lm ln b">qbs</code>文件夹。将该文件夹移动到您的linux机器上之前创建的<code class="eh lk ll lm ln b">qt5_10base-x64</code>文件夹中。</p><p id="e287" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你打开一个<code class="eh lk ll lm ln b">.qbs</code>文件，比如说<code class="eh lk ll lm ln b">1.10.0/profiles/msvc14-x64-qt/modules/Qt/gui/gui.qbs</code>，你会注意到一个路径的引用。出于某种原因，在我这里是<code class="eh lk ll lm ln b">/usr/local/Qt-5.10.0</code>。我想我在某个地方搞砸了，因为我们应该有一个窗口路径。在任何情况下，我们都需要将该路径转换为Qt在Linux机器上的实际位置，这很容易做到，只需使用<code class="eh lk ll lm ln b">sed</code>。</p><pre class="kq kr ks kt fq md ln me mf aw mg dt"><span id="aa7b" class="mh mi hu ln b fv mj mk l ml mm">find -name "*.qbs" -exec sed -i -e 's\#/usr/local/Qt-5.10.0\#/home/cor3ntin/dev/cross-compilers/windows/qt-5.10-msvc-x64\#g' {} \;</span></pre><p id="bb67" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后我们需要修改我们的<code class="eh lk ll lm ln b">qbs.conf</code>来使用那些qt模块。编辑在第一部分中创建的QBS文件以引用它们:</p><pre class="kq kr ks kt fq md ln me mf aw mg dt"><span id="25cf" class="mh mi hu ln b fv mj mk l ml mm">qt-project\qbs\profiles\msvc14-x86_64\preferences\qbsSearchPaths=/home/cor3ntin/dev/Qt/qbs-wine-toolchain,/home/cor3ntin/dev/cross-compilers/windows/qt5_10base-x64/qbs/1.10.0/profiles/msvc14-x64-qt</span></pre><p id="d7a0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我知道这有点棘手。不过，最终我们可以运行<code class="eh lk ll lm ln b">qbs</code>，它会为Windows编译我们基于Qt的hello world。</p><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="fe ff mo"><img src="../Images/d5383a685b77001725cb874464bb4330.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xLP2MZCHUatCvZwW8Xc7SA.png"/></div></div></figure><p id="206d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它不会运行，因为它找不到Qt dll。你可以将dll复制到构建目录，或者确保它们在<code class="eh lk ll lm ln b">PATH.</code>窗口/wine <code class="eh lk ll lm ln b">PATH</code>中。</p><p id="3514" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我发现这样做的唯一方法是运行<code class="eh lk ll lm ln b">regedit</code>——确保从适当的<code class="eh lk ll lm ln b">WINEPREFIX</code>开始，并将Qt的bin目录的位置添加到<code class="eh lk ll lm ln b">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Environment</code>下的<code class="eh lk ll lm ln b">Path</code>中。</p><p id="0f2b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你知道如何把它写下来，请告诉我。</p><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="fe ff mp"><img src="../Images/f8a1b66eb1100f990ba6126de7ef06fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zCdD-4ub2NIru6jqKKJFTQ.png"/></div></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">Using regedit on Linux. What would I not do for my readers ?</figcaption></figure><p id="d40a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们还需要在我们构建的helloworld.exe二进制文件旁边放一个<code class="eh lk ll lm ln b">qt.conf</code>文件，告诉Qt从哪里加载插件。就我而言</p><pre class="kq kr ks kt fq md ln me mf aw mg dt"><span id="718c" class="mh mi hu ln b fv mj mk l ml mm">[Paths]<br/>Prefix = /home/cor3ntin/dev/cross-compilers/windows/qt5_10base-x64/<br/>Plugins = plugins</span></pre><p id="3597" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就是这样！这并不太难，是吗？</p><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="fe ff mq"><img src="../Images/1914aeca5746d0d0d4c46d13ecae051a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_FAynCIKI52-XwCjCCLTMA.png"/></div></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">I made a clicky thing !</figcaption></figure><h2 id="f7a3" class="mh mi hu bd mr ms mt mu mv mw mx my mz jc na nb nc jg nd ne nf jk ng nh ni nj dt translated">因此，Microsoft Studio Visual C++编译器是有史以来最伟大的东西！</h2></div><div class="ab cl ki kj hc kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hn ho hp hq hr"><p id="e289" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最近对两名学龄前儿童进行的一项研究表明，千禧一代喜欢彩虹。我立即被要求使我们的应用程序更加彩虹y。含糊不清的标签按钮显然是假装天启的骑士，所以我们也将摆脱他们。</p><p id="3c13" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们需要做的是迭代我们的字符串，并在每个字符周围注入一些html标记，以便它们以不同的颜色呈现。</p><p id="da69" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">遍历某个容器需要我们使用<code class="eh lk ll lm ln b">range-v3</code>。字面上的没有别的办法。</p><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="fe ff nl"><img src="../Images/ad0ca26a8368b731acebd28ea11ef60a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kOMrpyBT_MamoaiqybS3_w.png"/></div></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">Making WordArt Great Again.</figcaption></figure><p id="0d1f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这不是很好吗？</p><p id="d892" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是，我敢肯定，当你得知<code class="eh lk ll lm ln b">msvc</code>无法编译<code class="eh lk ll lm ln b">range-v3</code>时，你会大吃一惊。我知道，这是一个彻底的打击，彻底的失望。</p><h2 id="5296" class="mh mi hu bd mr ms mt mu mv mw mx my mz jc na nb nc jg nd ne nf jk ng nh ni nj dt translated">Microsoft Studio Visual C++编译器失败。</h2><p id="d812" class="pw-post-body-paragraph ir is hu it b iu nm iw ix iy nn ja jb jc no je jf jg np ji jj jk nq jm jn jo hn dt translated">我们绝对无能为力。它不像是存在一个兼容msvc的端口 <code class="eh lk ll lm ln b"><a class="ae lj" href="https://github.com/Microsoft/Range-V3-VS2015" rel="noopener ugc nofollow" target="_blank">range-v3</a></code>或<a class="ae lj" href="http://en.cppreference.com/w/cpp/language/range-for" rel="noopener ugc nofollow" target="_blank"/>来转换我们的字符串。请不要再说我故意编造了一个虚构的故事，这样我就可以使用范围和用彩虹打败msvc。那就是<em class="nk">的意思</em>。</p><p id="dce2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">唯一合理的就是抛弃<code class="eh lk ll lm ln b">msvc</code>，用别的东西代替。但是什么？<code class="eh lk ll lm ln b">Mingw</code>不懂MSVC头文件和libs，<code class="eh lk ll lm ln b">icc</code>相当贵，<code class="eh lk ll lm ln b">Cfront</code>不再维护。</p><p id="08a7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，你肯定知道我的意思了，不是吗？<code class="eh lk ll lm ln b">clang-cl</code>！如果你不知道<code class="eh lk ll lm ln b">clang-cl</code>，它是<code class="eh lk ll lm ln b">cl.exe</code>的替代品，除了它实际上是铿锵的，所以它会让你内心温暖而模糊。</p><p id="f2d2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Clang设计合理，它是一个了不起的工具，原因有很多，但最重要的是:</p><ul class=""><li id="8883" class="nr ns hu it b iu iv iy iz jc nt jg nu jk nv jo nw nx ny nz dt translated">它可以在所有主流操作系统上运行</li><li id="1e98" class="nr ns hu it b iu oa iy ob jc oc jg od jk oe jo nw nx ny nz dt translated">它不在编译时激活特定于操作系统的特性，而是在运行时激活。</li><li id="0aea" class="nr ns hu it b iu oa iy ob jc oc jg od jk oe jo nw nx ny nz dt translated">这意味着你可以从任何地方瞄准任何东西。</li><li id="9d70" class="nr ns hu it b iu oa iy ob jc oc jg od jk oe jo nw nx ny nz dt translated">它提供了一个与<code class="eh lk ll lm ln b">msvc</code>兼容的驱动程序(如果你喜欢，也可以是命令行界面)</li><li id="db0f" class="nr ns hu it b iu oa iy ob jc oc jg od jk oe jo nw nx ny nz dt translated">它很容易构建(如果您曾经尝试过构建GCC，您就会知道构建一个编译器有多难。)</li><li id="5a9e" class="nr ns hu it b iu oa iy ob jc oc jg od jk oe jo nw nx ny nz dt translated">它是开源的，它的设计不受政治动机的约束。</li></ul><h2 id="0700" class="mh mi hu bd mr ms mt mu mv mw mx my mz jc na nb nc jg nd ne nf jk ng nh ni nj dt translated">所以，还是用铿锵吧！</h2><p id="cfb1" class="pw-post-body-paragraph ir is hu it b iu nm iw ix iy nn ja jb jc no je jf jg np ji jj jk nq jm jn jo hn dt translated">如果您没有遵循Linux发行版的文档，那么默认情况下它应该附带clang-cl(这只是clang的一个符号链接)。</p><p id="d702" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">或者如果你像我一样，结帐并建立主干，<a class="ae lj" href="https://clang.llvm.org/cxx_status.html" rel="noopener ugc nofollow" target="_blank">它充满了善良</a>！</p><p id="2e47" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">除了作为替代品，我们还需要做一些事情。我们为wine编写的<code class="eh lk ll lm ln b">QBS</code>工具链模块并不完全有效，因为它将斜杠转换为反斜杠。</p><p id="1e78" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我复制了工具链模块并修复了一些其他细节。很快就会出现在GitHub上。</p><p id="e6ff" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为clang-cl创建一个QBS概要文件非常简单，从wine复制一个，并将工具链名称从<code class="eh lk ll lm ln b">msvc</code>更改为<code class="eh lk ll lm ln b">clang-cl</code>，并将<code class="eh lk ll lm ln b">toolchainInstallPath</code>指向包含<code class="eh lk ll lm ln b">clang-cl</code>和<code class="eh lk ll lm ln b">lld-link</code>的某个地方。</p><p id="ed12" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">哦，我没提到<code class="eh lk ll lm ln b">lld-link</code>吗？是对<code class="eh lk ll lm ln b">link.exe</code>的替代下降。<code class="eh lk ll lm ln b">lld </code>也是unix上<code class="eh lk ll lm ln b">ld</code>的替代品，它比<code class="eh lk ll lm ln b">ld</code>和<code class="eh lk ll lm ln b">gold</code>快得多，所以你应该<a class="ae lj" href="https://lld.llvm.org/" rel="noopener ugc nofollow" target="_blank">检查一下并使用它</a>！</p><p id="e6ab" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们还没有完成。</p><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div class="fe ff of"><img src="../Images/e30724c62e54096ff129aa21512b720f.png" data-original-src="https://miro.medium.com/v2/resize:fit:808/format:webp/1*_4h4mUSFXAZIO_U1jLHZ0g.jpeg"/></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">Case consistency at Microsoft is a serious matter.</figcaption></figure><p id="ac61" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Microsoft Windows是围绕不区分大小写的文件系统设计的。我确信这在当时看起来是个好主意。</p><p id="558f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，除非你自虐到在<code class="eh lk ll lm ln b">FAT</code>上运行你的Linux机器，否则你的文件系统很可能是区分大小写的。这对我们来说是个问题。</p><p id="0d23" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有多糟糕，真的吗？嗯…</p><pre class="kq kr ks kt fq md ln me mf aw mg dt"><span id="df7f" class="mh mi hu ln b fv mj mk l ml mm"><strong class="ln hv">A</strong>cl<strong class="ln hv">UI</strong>.<strong class="ln hv">L</strong>ib<br/>ahadmin.lib<br/>wdsClientAPI.<strong class="ln hv">LIB<br/>P</strong>sapi.<strong class="ln hv">L</strong>ib<br/>sensorsapi.lib<br/><strong class="ln hv">S</strong>etup<strong class="ln hv">API</strong>.<strong class="ln hv">L</strong>ib</span></pre><p id="218e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这只是一小部分文件。我不认为他们现在能做什么来解决这个问题，太晚了。</p><p id="ccee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们可以尝试通过改变每个库和头文件的文件名来解决大小写问题。但这可能行不通，因为第三方库也不一致。因此，即使我们试图修复我们的构建文件，我们迟早会遇到案例问题。</p><p id="dfc5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，“适当的”(对于适当的一些定义)解决方案是欺骗Linux内核不区分大小写。为此，我们需要使用不区分大小写的系统。幸运的是，一个文件可以是一个文件系统，所以我们将创建一个足够大的文件来保存windows SDK，用不区分大小写的文件系统(比如EXFAT)对其进行格式化，并将SDK放在那里。请注意，NTFS是区分大小写的，即使Windows内核不是。</p><pre class="kq kr ks kt fq md ln me mf aw mg dt"><span id="870f" class="mh mi hu ln b fv mj mk l ml mm">dd if=/dev/zero of=win_sdk_10.fs bs=1024 count=$((1024 * 100 * 3))<br/>mkfs.exfat win_sdk_10.fs<br/>mv sdk_10 sdk_10.bak<br/>mkdir sdk_10<br/>sudo mount win_sdk_10.fs<br/>mv sdk_10.bak/* sdk_10</span></pre><p id="8cc5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你会爱上Linux的。</p><p id="de5a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">而现在，用clang-cl编译工作。但是，运行该程序会暴露一个错误。</p><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="fe ff og"><img src="../Images/31c67c15ca94b2419ac6f6657000eabd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EPrQZZVjU9BfdlnWgL8cAg.png"/></div></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">Our program compiles with clang and runs but it exhibits a nasty bug.</figcaption></figure><p id="de93" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，复制到虚拟机的同一个可执行文件运行良好。</p><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="fe ff lg"><img src="../Images/244c5e19e3085433902a294e7b6fd404.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*IePJwJz6S888ie3V5BKH5w.png"/></div></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">Such greetings.</figcaption></figure><p id="7466" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我还是不确定窃听器到底在哪里。它看起来要么在-v3范围内，要么在我的使用范围内，但奇怪的是，它会公开不同的运行时行为。</p><p id="697d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是这就是拥有一个更大的开发环境的好处，如果你有bug，它们更有可能被暴露。首先，这个讨厌的图形故障让我意识到我应该把空白作为特例来处理。</p><p id="4bc3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">哦，如果你想检查clang实际上在做什么，你可以使用微软在<code class="eh lk ll lm ln b">msvc2017/bin/Hostx64/x64/</code>中找到的<code class="eh lk ll lm ln b">dumpbin.exe</code>。这个工具相当于unix的<code class="eh lk ll lm ln b">ldd</code>和<code class="eh lk ll lm ln b">nm</code>。</p><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="fe ff oh"><img src="../Images/da2e3d8ef566c9f4802092b73730a8a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2NM_zswTFQwCcLB1FAhtNA.png"/></div></div></figure><p id="fd6f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有趣的是，这个clang工件看起来和msvc制作的一模一样，只是多了几个部分。包括CRT和vcruntime！</p><p id="d5be" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是MSVC建立的二进制。</p><figure class="kq kr ks kt fq ku fe ff paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="fe ff oi"><img src="../Images/1676e0f9d78ba21f71491e720237d07d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Da08y0P9XGXpQBWUO3qR8g.png"/></div></div></figure><p id="34b0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">目前<code class="eh lk ll lm ln b">ldd-link</code>仍处于实验阶段<a class="ae lj" href="https://lld.llvm.org/windows_support.html" rel="noopener ugc nofollow" target="_blank">并且不支持调试信息。<code class="eh lk ll lm ln b">clang-cl</code>除了一些异常处理，</a><a class="ae lj" href="https://clang.llvm.org/docs/MSVCCompatibility.html" rel="noopener ugc nofollow" target="_blank">是否大部分完成</a>。可以混搭<code class="eh lk ll lm ln b">cl.exe</code><code class="eh lk ll lm ln b">clang-cl</code><code class="eh lk ll lm ln b">link.exe</code><code class="eh lk ll lm ln b">lld-link</code>。</p><p id="7f56" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我不能建议你在生产中使用<code class="eh lk ll lm ln b">clang-cl</code>(但是，它正在实现),但是它是添加到你的CI和开发环境中的一个令人惊奇的工具。</p><p id="c4a8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是我今天给你的全部，我希望你已经学到了一些东西！</p></div><div class="ab cl ki kj hc kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hn ho hp hq hr"><h1 id="26ab" class="oj mi hu bd mr ok ol om mv on oo op mz oq or os nc ot ou ov nf ow ox oy ni oz dt translated">…还有一件事…</h1><h2 id="e4ab" class="mh mi hu bd mr ms mt mu mv mw mx my mz jc na nb nc jg nd ne nf jk ng nh ni nj dt translated">第3部分再见！</h2><div class="jp jq fm fo jr js"><a rel="noopener follow" target="_blank" href="/@corentin.jabot/a-c-hello-world-and-the-rose-gold-walled-garden-of-doom-4ac3c92385ed"><div class="jt ab ej"><div class="ju ab jv cl cj jw"><h2 class="bd hv fv z el jx eo ep jy er et ht dt translated">一个C++ Hello World和玫瑰金围墙的毁灭花园</h2><div class="jz l"><h3 class="bd b fv z el jx eo ep jy er et ek translated">这是我的交叉编译系列文章的第3部分。你可以先看看第一部分和第二部分！</h3></div><div class="ka l"><p class="bd b gc z el jx eo ep jy er et ek translated">medium.com</p></div></div><div class="kb l"><div class="pa l kd ke kf kb kg kh js"/></div></div></a></div></div></div>    
</body>
</html>