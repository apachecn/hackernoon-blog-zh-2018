<html>
<head>
<title>Make yourself a Go web server with MongoDb. Go on, Go on, Go on…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用MongoDb让自己成为一个Go web服务器。继续，继续，继续…</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/make-yourself-a-go-web-server-with-mongodb-go-on-go-on-go-on-48f394f24e?source=collection_archive---------0-----------------------#2018-02-06">https://medium.com/hackernoon/make-yourself-a-go-web-server-with-mongodb-go-on-go-on-go-on-48f394f24e?source=collection_archive---------0-----------------------#2018-02-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/4a93d62311f55c070fe36f928240b064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oi7u14Jdjj8P-ZbEEUyVYw.png"/></div></div></figure><div class=""/><figure class="fi fk jc jd je hw"><div class="bz el l di"><div class="jf jg l"/></div></figure><p id="5e00" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我主要用c#和node.js编程，这篇文章是我最近涉猎围棋的结果。我开始在go中创建一个简单的web后端，看看它与node相比如何。我喜欢node，因为它允许我非常快速地创建API，但缺点是大多数项目严重依赖外部库，导致巨大的代码膨胀和<a class="ae kf" href="https://hackernoon.com/im-harvesting-credit-card-numbers-and-passwords-from-your-site-here-s-how-9a8cb347c5b5" rel="noopener ugc nofollow" target="_blank">潜在的恶意代码</a>。</p><p id="9a27" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我创建了一个小应用程序来演示如何设置rest api、测试、散列用户密码以及在MongoDb中存储数据，完整代码可以在这里查看:</p><div class="ht hu fm fo hv kg"><a href="https://github.com/eamonnmcevoy/go_rest_api.git" rel="noopener  ugc nofollow" target="_blank"><div class="kh ab ej"><div class="ki ab kj cl cj kk"><h2 class="bd ig fv z el kl eo ep km er et ie dt translated">eamonnmcevoy/go_rest_api</h2><div class="kn l"><h3 class="bd b fv z el kl eo ep km er et ek translated">go_rest_api -使用mongoDb运行web服务器</h3></div><div class="ko l"><p class="bd b gc z el kl eo ep km er et ek translated">github.com</p></div></div><div class="kp l"><div class="kq l kr ks kt kp ku ib kg"/></div></div></a></div><ol class=""><li id="fef0" class="kv kw if jj b jk jl jo jp js kx jw ky ka kz ke la lb lc ld dt translated"><a class="ae kf" href="#a432" rel="noopener ugc nofollow">从mongoDb创建和检索用户</a></li><li id="694e" class="kv kw if jj b jk le jo lf js lg jw lh ka li ke la lb lc ld dt translated"><a class="ae kf" href="#7aa1" rel="noopener ugc nofollow">加盐密码</a></li><li id="ffbe" class="kv kw if jj b jk le jo lf js lg jw lh ka li ke la lb lc ld dt translated"><a class="ae kf" href="#6c9c" rel="noopener ugc nofollow"> REST API —创建和检索用户</a></li><li id="f9d9" class="kv kw if jj b jk le jo lf js lg jw lh ka li ke la lb lc ld dt translated"><a class="ae kf" href="#9207" rel="noopener ugc nofollow">cmd文件夹—链接所有内容</a></li><li id="b5f4" class="kv kw if jj b jk le jo lf js lg jw lh ka li ke la lb lc ld dt translated"><a class="ae kf" href="#bb74" rel="noopener ugc nofollow">认证(一种)</a></li></ol></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><h1 id="de3c" class="lq lr if bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn dt translated">包装布局</h1><p id="b8e1" class="pw-post-body-paragraph jh ji if jj b jk mo jm jn jo mp jq jr js mq ju jv jw mr jy jz ka ms kc kd ke hn dt translated">在这个项目中，我试图遵循本·约翰逊描述的“标准包装布局”。</p><p id="c300" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这看起来是这样的:</p><pre class="mt mu mv mw fq mx my mz na aw nb dt"><span id="1886" class="nc lr if my b fv nd ne l nf ng">go_rest_api<br/>  /cmd<br/>    /app<br/>      -app.go<br/>      -main.go<br/>  /pkg<br/>    /mongo<br/>    /server<br/>    /mock<br/>    -user.go</span></pre><p id="43dc" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在<code class="eh nh ni nj my b">/cmd</code>文件夹中，我们有我们的主应用程序代码，这只是用来连接我们的依赖项和启动服务器。</p><p id="17ac" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">文件夹是我们大部分代码所在的地方。在根级别，我们定义我们的域类型和接口，我们的根包不依赖于任何其他包。</p></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><h1 id="370e" class="lq lr if bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn dt translated">第0部分—环境设置</h1><p id="6172" class="pw-post-body-paragraph jh ji if jj b jk mo jm jn jo mp jq jr js mq ju jv jw mr jy jz ka ms kc kd ke hn dt translated">如果你还没有安装Go，那就去做:<a class="ae kf" href="https://golang.org/doc/install" rel="noopener ugc nofollow" target="_blank">安装指南</a></p><p id="d076" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果你还没有学会围棋的基础知识，那就去学吧:<a class="ae kf" href="https://tour.golang.org/welcome/1" rel="noopener ugc nofollow" target="_blank">围棋赛</a></p><p id="d7e4" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">确保您的GOPATH目录采用以下格式:</p><pre class="mt mu mv mw fq mx my mz na aw nb dt"><span id="967a" class="nc lr if my b fv nd ne l nf ng">GOPATH/<br/>    /bin (to output your built executable files)<br/>    /pkg (to store your projects dependencies)<br/>    /src (your code goes here)</span></pre><p id="f9c3" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们将在这个项目中使用一些外部依赖，所以让我们现在下载它们。在GOPATH目录中运行以下命令。</p><pre class="mt mu mv mw fq mx my mz na aw nb dt"><span id="9583" class="nc lr if my b fv nd ne l nf ng">//required<br/>go get gopkg.in/mgo.v2                   //MongoDb driver<br/>go get golang.org/x/crypto/bcrypt        //password hashing</span><span id="89f5" class="nc lr if my b fv nk ne l nf ng">//could live without<br/>go get github.com/gorilla/mux            //http router<br/>go get github.com/gorilla/handlers       //http request logging<br/>go get github.com/google/uuid            //generate password salt</span></pre><p id="06cf" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们可以在没有Gorilla的情况下实现这个项目，这要感谢Go的内置http库。然而，一旦您的rest api开始增加复杂性，像Gorilla这样功能更全的路由工具包将会非常方便。</p><p id="5030" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最后但同样重要的是，安装一个版本的MongoDb，并通过在命令行运行<code class="eh nh ni nj my b">mongod</code>来启动服务器。</p><p id="5759" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">【https://docs.mongodb.com/manual/installation/】</p></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><h1 id="a432" class="lq lr if bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn dt translated">第1部分—从Mongo创建和检索用户</h1><p id="6d9c" class="pw-post-body-paragraph jh ji if jj b jk mo jm jn jo mp jq jr js mq ju jv jw mr jy jz ka ms kc kd ke hn dt translated">让我们开始吧，我们首先需要的是一个用户数据类型。在<code class="eh nh ni nj my b">pkg</code>文件夹中创建文件<code class="eh nh ni nj my b">user.go</code>并定义类型和服务接口。</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div><figcaption class="nm nn fg fe ff no np bd b be z ek">go_web_server/pkg/user.go</figcaption></figure><p id="29cd" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">接下来我们需要实现我们的<code class="eh nh ni nj my b">UserService</code>，因为我们已经决定使用MongoDb作为我们的数据库，让我们创建一个<code class="eh nh ni nj my b">mongo</code>包并在其中实现服务。</p><p id="9e29" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">创建一个文件夹<code class="eh nh ni nj my b">pkg/mongo</code>，并添加两个文件<code class="eh nh ni nj my b">user_model.go</code>，和<code class="eh nh ni nj my b">user_service.go</code></p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div><figcaption class="nm nn fg fe ff no np bd b be z ek">go_web_server/pkg/mongo/user_model.go</figcaption></figure><p id="56f8" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在这个文件中，我们定义了3件重要的事情</p><ol class=""><li id="a3f3" class="kv kw if jj b jk jl jo jp js kx jw ky ka kz ke la lb lc ld dt translated">我们将插入Mongo的文档结构— <code class="eh nh ni nj my b">userModel</code>。我们在这里没有使用<code class="eh nh ni nj my b">root.Model</code>，这样我们可以将对<code class="eh nh ni nj my b">gopkg/mgo.v2/bson</code>的依赖限制在<code class="eh nh ni nj my b">mongo</code>包中。</li><li id="9d6c" class="kv kw if jj b jk le jo lf js lg jw lh ka li ke la lb lc ld dt translated"><a class="ae kf" href="https://godoc.org/labix.org/v2/mgo#Index" rel="noopener ugc nofollow" target="_blank">应用于我们的用户集合的索引</a>。这个索引允许我们在<code class="eh nh ni nj my b">Username</code>字段上快速查询Mongo，并防止重复的<code class="eh nh ni nj my b">Username</code>。</li><li id="c1ce" class="kv kw if jj b jk le jo lf js lg jw lh ka li ke la lb lc ld dt translated"><code class="eh nh ni nj my b">newUserModel</code>和<code class="eh nh ni nj my b">toRootUser</code>用于在<code class="eh nh ni nj my b">userModel</code>和<code class="eh nh ni nj my b">root.User</code>之间转换</li></ol><p id="0e4f" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">你可能已经注意到了这个模型中明显的安全缺陷，我们以纯文本的形式存储密码；不要担心，我们将在第2部分用salted hash解决这个问题。</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div><figcaption class="nm nn fg fe ff no np bd b be z ek">go_web_server/pkg/mongo/user_service.go</figcaption></figure><p id="7686" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这是我们<code class="eh nh ni nj my b">UserService</code>实现的基础。构造函数从<code class="eh nh ni nj my b">session</code>参数中获取一个集合，并设置用户索引。</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div><figcaption class="nm nn fg fe ff no np bd b be z ek">go_web_server/pkg/mongo/user_service.go</figcaption></figure><p id="aa1f" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">实现我们的接口非常简单。<code class="eh nh ni nj my b">Create</code>函数非常简单，将<code class="eh nh ni nj my b">root.User</code>转换为<code class="eh nh ni nj my b">userModel</code>并插入到我们的集合中。<code class="eh nh ni nj my b">GetByUsername</code>使用匹配的<code class="eh nh ni nj my b">username</code>为单个用户执行M <a class="ae kf" href="https://docs.mongodb.com/manual/reference/method/db.collection.find/" rel="noopener ugc nofollow" target="_blank"> ongo查找操作</a>。</p><p id="00b6" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最后，我们将创建一个<code class="eh nh ni nj my b">session.go</code>文件来管理到Mongo的连接。</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div><figcaption class="nm nn fg fe ff no np bd b be z ek">go_web_server/pkg/mongo/session.go</figcaption></figure><p id="19b4" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">该文件定义了三个简单的函数来创建、访问和关闭Mongo会话，并从该会话中获取一个指向集合的指针。</p><p id="6cba" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">就这样，我们完全实现了<code class="eh nh ni nj my b">root</code>包中定义的<code class="eh nh ni nj my b">UserService</code>，并导出了创建和维护Mongo会话的函数；是时候写一些测试了，看看它是否有效。在Mongo包中创建另一个新文件<code class="eh nh ni nj my b">mongo_test.go</code></p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div><figcaption class="nm nn fg fe ff no np bd b be z ek">go_web_server/pkg/mongo/mongo_test.go</figcaption></figure><p id="2a8a" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在这个集成测试中，我们将一个用户插入到数据库中，验证集合中存在一个用户，并且他们与我们的测试数据相匹配。转到命令行并运行测试</p><pre class="mt mu mv mw fq mx my mz na aw nb dt"><span id="ce45" class="nc lr if my b fv nd ne l nf ng">➜ go test ./src/go_rest_api/pkg/mongo/<br/>ok      go_rest_api/pkg/mongo    0.145s</span></pre><p id="5d6d" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">成功！</p><p id="4228" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">…或者是吗？你会注意到，如果我们第二次运行测试，我们会得到一个错误。</p><pre class="mt mu mv mw fq mx my mz na aw nb dt"><span id="e158" class="nc lr if my b fv nd ne l nf ng">2017/03/14 22:58:04 Unable to create user: E11000 duplicate key error collection: test_db.user index: username_1 dup key: { : "integration_test_user" }</span></pre><p id="74d0" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们需要一种清理测试数据库的方法，让我们扩展<code class="eh nh ni nj my b">session.go</code>来提供一个删除数据库的功能。打开<code class="eh nh ni nj my b">session.go</code>，增加以下功能:</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div><figcaption class="nm nn fg fe ff no np bd b be z ek">go_web_server/pkg/mongo/session.go</figcaption></figure><p id="c655" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">然后修改<code class="eh nh ni nj my b">mongo_test.go</code>中的延期语句</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div><figcaption class="nm nn fg fe ff no np bd b be z ek">go_web_server/pkg/mongo/mongo_test.go</figcaption></figure><p id="2a49" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在我们运行测试我们的心满意足！</p></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><h1 id="7aa1" class="lq lr if bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn dt translated">第2部分—加盐密码</h1><p id="3cbb" class="pw-post-body-paragraph jh ji if jj b jk mo jm jn jo mp jq jr js mq ju jv jw mr jy jz ka ms kc kd ke hn dt translated">在第1部分中，我们实现了一个在MongoDb中存储用户文档的服务；但是，我们以明文形式存储用户密码。让我们引入一个新的go包，允许我们生成和比较加盐散列。</p><p id="f50e" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在根包中为我们的散列函数定义一个接口:</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div><figcaption class="nm nn fg fe ff no np bd b be z ek">go_web_server/pkg/hash.go</figcaption></figure><p id="534c" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">和实现，在<code class="eh nh ni nj my b">/pkg/crypto/hash.go</code></p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div><figcaption class="nm nn fg fe ff no np bd b be z ek">go_web_server/pkg/crypto/hash.go</figcaption></figure><p id="10da" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们的实现生成了一个格式为<code class="eh nh ni nj my b">{hash}||{salt}</code>的hash，这使得存储hash-salt组合稍微方便一些，因为我们只在一个数据库字段中存储，而不是两个。我们现在需要测试我们的实现，看看它是否工作，我们将测试我们是否可以成功地将生成的散列与输入字符串进行比较，检测何时进行了不正确的尝试，以及每次调用生成的散列都会产生不同的结果。</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div></figure><p id="77fe" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在我们知道我们的<code class="eh nh ni nj my b">cryto</code>包正在工作，让我们修改<code class="eh nh ni nj my b">user_service.go</code>来存储散列密码而不是纯文本。扩展<code class="eh nh ni nj my b">NewUserService</code>函数以接受<code class="eh nh ni nj my b">root.Hash</code>的实例，然后使用它在<code class="eh nh ni nj my b">Create</code>中生成散列密码。</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div></figure><p id="826b" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">到目前为止还不错，但是Mongo测试现在由于增加了参数而中断了。我们需要创建一个模拟的<code class="eh nh ni nj my b">Hash</code>实现来保持包之间的分离。在<code class="eh nh ni nj my b">pkg/mock/hash.go</code>中创建一个非常简单的模拟</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div></figure><p id="c175" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">然后，在<code class="eh nh ni nj my b">mongo_test.go</code>中，简单地用模拟散列实现实例化<code class="eh nh ni nj my b">UserService </code>实例。</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div></figure><p id="7bd7" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">就这样，在这一节中，我们创建了一个加密包来处理密码加盐，添加了包之间的交互，并创建了第一个模拟实现</p></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><h1 id="6c9c" class="lq lr if bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn dt translated">第3部分—用于创建和检索用户的REST API</h1><p id="4223" class="pw-post-body-paragraph jh ji if jj b jk mo jm jn jo mp jq jr js mq ju jv jw mr jy jz ka ms kc kd ke hn dt translated">系统中的下一个主要组件是http路由器，我们将使用<a class="ae kf" href="http://www.gorillatoolkit.org/pkg/mux" rel="noopener ugc nofollow" target="_blank"> Gorrilla mux </a>包来配置我们的rest端点。这个包将包含三个文件:</p><pre class="mt mu mv mw fq mx my mz na aw nb dt"><span id="f309" class="nc lr if my b fv nd ne l nf ng">go_web_server/pkg/server/<br/>      server.go           -- configure router &amp; starts listening<br/>      response.go         -- helper functions for sending responses<br/>      user_router.go      -- routes for our user service</span></pre><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div><figcaption class="nm nn fg fe ff no np bd b be z ek">go_web_server/pkg/server/server.go</figcaption></figure><p id="3771" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><code class="eh nh ni nj my b">NewServer</code>函数初始化服务器和用户子路由器，这允许我们将所有以<code class="eh nh ni nj my b">/user</code>开头的请求指向<code class="eh nh ni nj my b">user_router.go</code>文件。<code class="eh nh ni nj my b">Start</code>简单地在端口<code class="eh nh ni nj my b">8080</code>上启动我们的服务器，我们另外通过gorilla <code class="eh nh ni nj my b">LoggingHandler</code>传递所有请求，以提供对stdout的自动请求记录。</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div><figcaption class="nm nn fg fe ff no np bd b be z ek">go_web_server/pkg/server/user_router.go</figcaption></figure><p id="4ca5" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">用户路由器公开了两个rest端点，用于与Mongo服务进行交互。</p><ol class=""><li id="df4d" class="kv kw if jj b jk jl jo jp js kx jw ky ka kz ke la lb lc ld dt translated"><code class="eh nh ni nj my b">PUT /users/</code>用于向数据库添加新用户。</li><li id="859a" class="kv kw if jj b jk le jo lf js lg jw lh ka li ke la lb lc ld dt translated"><code class="eh nh ni nj my b">GET /users/{username}</code>用于搜索具有给定用户名的用户。</li></ol><p id="936c" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您会注意到对<code class="eh nh ni nj my b">Json</code>和<code class="eh nh ni nj my b">Error</code>的一些不常见的函数调用，这些是在<code class="eh nh ni nj my b">response.go</code>中定义的帮助函数</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div><figcaption class="nm nn fg fe ff no np bd b be z ek">go_web_server/pkg/server/response.go</figcaption></figure></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><h1 id="9207" class="lq lr if bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn dt translated">第4部分—<code class="eh nh ni nj my b">cmd</code>文件夹，链接所有内容</h1><p id="00d8" class="pw-post-body-paragraph jh ji if jj b jk mo jm jn jo mp jq jr js mq ju jv jw mr jy jz ka ms kc kd ke hn dt translated">既然<code class="eh nh ni nj my b">server</code> <code class="eh nh ni nj my b">mongo</code>和<code class="eh nh ni nj my b">crypto</code>包已经可以工作了，我们可以将它们连接到一个正常工作的web服务器中。创建文件夹<code class="eh nh ni nj my b">go_web_server/cmd/app</code>并添加<code class="eh nh ni nj my b">main.go</code></p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div></figure><p id="6b8d" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在我们可以编译并运行服务器了:</p><pre class="mt mu mv mw fq mx my mz na aw nb dt"><span id="5cd1" class="nc lr if my b fv nd ne l nf ng"><br/>➜  go install ./src/go_web_server/cmd/app<br/>➜  ./bin/app.exe<br/>2017/04/25 13:50:35 Listening on port 8080</span></pre><p id="c614" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">使用postman，我们可以很容易地测试服务器端点。</p><figure class="mt mu mv mw fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nq"><img src="../Images/a02b62f875e9145c426461aeaeca57e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*seR3O3N9Et_OLF8S9Rbheg.png"/></div></div></figure><figure class="mt mu mv mw fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nr"><img src="../Images/1de1a900fe7ad9d5e386d6c80b7447e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zZVl4Q-Y-BhEi2PsUUxNHA.png"/></div></div></figure></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><p id="e52c" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们现在有一个工作服务器，此时我们可以将它连接到web前端或移动应用程序，并开发一个用户注册表单。我们需要的下一个主要功能是认证用户和保护终端的能力。(当然，您不应该在这里返回用户密码)。</p><h1 id="bb74" class="lq lr if bd ls lt ns lv lw lx nt lz ma mb nu md me mf nv mh mi mj nw ml mm mn dt translated">第5部分—用户认证(某种程度上)</h1><p id="6b42" class="pw-post-body-paragraph jh ji if jj b jk mo jm jn jo mp jq jr js mq ju jv jw mr jy jz ka ms kc kd ke hn dt translated">我不会在这里创建一个完整的用户认证系统，只是一个验证用户凭证的端点。在我的下一篇文章中，我将展示如何将这一责任交给神奇的<a class="ae kf" href="https://getkong.org/about/" rel="noopener ugc nofollow" target="_blank"> kong api gateway </a>。</p><p id="d898" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">按照我们在前面几节中使用的相同模式，我添加了一个简单的端点来接受用户名/密码组合，并在数据库中找到具有匹配凭证的用户。如果找到用户，则返回它们，否则返回一个错误。</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nl jg l"/></div></figure></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><p id="2ca5" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在所有这些工作之后，我们创造了一个相当无用的api，但它是我们的，我们热爱它。</p><figure class="mt mu mv mw fq hw"><div class="bz el l di"><div class="nx jg l"/></div></figure><p id="7e93" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果你想被说服学习围棋，我推荐这篇文章:<a class="ae kf" rel="noopener" href="/@kevalpatel2106/why-should-you-learn-go-f607681fad65">https://medium . com/@ keval Patel 2106/why-should-you-learn-go-f 607681 fad 65</a></p><p id="579d" class="pw-post-body-paragraph jh ji if jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这篇文章阅读更多关于我在这个项目中使用的文件夹结构:<a class="ae kf" rel="noopener" href="/@benbjohnson/standard-package-layout-7cdbc8391fc1">https://medium . com/@ benbjohnson/standard-package-layout-7 cdbc 8391 fc1</a></p></div></div>    
</body>
</html>