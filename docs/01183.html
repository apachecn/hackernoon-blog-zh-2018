<html>
<head>
<title>Designing a Mission-Critical API Serving Millions of Requests per Month</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">设计一个每月服务数百万请求的关键任务API</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/designing-a-mission-critical-api-serving-millions-of-requests-per-month-575d850fb41f?source=collection_archive---------10-----------------------#2018-02-06">https://medium.com/hackernoon/designing-a-mission-critical-api-serving-millions-of-requests-per-month-575d850fb41f?source=collection_archive---------10-----------------------#2018-02-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="eb8b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当我与人合作创办我的上一家公司时，我们最大的挑战之一是向我们的客户提供一个可以100%保持运行的API。我们的产品是一个内容管理系统和一个API，每月服务于数百万个请求，我们的客户使用它来将内容集成到他们的网站中。在多次几乎瘫痪我们业务的停机后，我们开始致力于消除单点故障。</p><h1 id="88c5" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">停机是致命的</h1><p id="b111" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">我们的客户建立了网站，在他们的请求/响应生命周期中向我们发出页面内容的API请求。这意味着如果他们的API请求失败，他们的页面可能不会呈现。换句话说:如果我们的API宕机，我们客户的网站也会跟着宕机。</p><p id="dda0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是我们早年艰难学到的一课。不可靠的服务器托管导致频繁的间歇性停机和性能下降，这让客户感到沮丧。一次拙劣的DNS迁移导致了数小时的API宕机，导致数十个客户的网站宕机近半天，并让大量客户质疑他们是否可以继续依赖我们(其中有少数客户离开了我们)。</p><p id="12dd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在此事件之后，我们认识到确保接近100%的正常运行时间是一个生死攸关的问题。未来的重大停电可能会导致我们失去辛苦赢得的客户，并使我们的业务陷入危机。</p><h1 id="fb45" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">提供全球化、快速、灵活的API</h1><p id="52f0" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">完全避免失败是不可能的——你只能尽最大努力减少失败的机会。</p><p id="fdb5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">例如，通过运行自己的物理服务器来“控制自己的命运”可以保护您免受托管服务提供商的影响，但会让您不得不处理安全性和可伸缩性问题，这两个问题很容易让您崩溃，并且难以恢复。</p><p id="872e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对我们来说，始终保持我们的API并确保它在全球范围内提供高性能是至关重要的。但是，作为一家规模较小的公司，我们知道我们没有足够的资源来提供具有接近100%正常运行时间的全球高度可扩展的性能。所以我们求助于这样做的人:<a class="ae ks" href="https://www.fastly.com/" rel="noopener ugc nofollow" target="_blank">快速</a>。</p><p id="a0a7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Fastly将自己描述为“为全球最受欢迎的企业提供快速、安全和可扩展的数字体验的边缘云平台”。他们与大客户合作，包括纽约时报、BuzzFeed、Pinterest和New Relic。我们将Fastly放在API前面作为缓存层，这样所有的API请求都可以通过它们的CDN得到服务。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff kt"><img src="../Images/0035400b1923b603401aea07d05725db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xRi9E4091EzvSZEN."/></div></div><figcaption class="lf lg fg fe ff lh li bd b be z ek">Fastly’s points of presence</figcaption></figure><p id="7eba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当我们的一个客户在我们的后端更新他们的网站内容时，我们使被编辑的特定内容的API密钥无效。非缓存请求击中了我们的服务器，但我们有大约94%的命中率，因为我们客户网站上的内容相对于他们的访问者数量很少改变。这意味着即使我们的数据库或服务器经历了间歇性的中断，我们的API仍然保持运行。我们不希望这样，但理论上，我们的服务器可能会完全瘫痪几个小时，而我们客户的网站会保持正常。</p><p id="060d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Fastly的全球CDN为我们提供了另一个好处。我们的许多客户都有静态的JavaScript网站，API请求是从访问者的浏览器而不是他们的服务器发出的。通过Fastly的CDN提供API响应意味着我们客户的网站访问者无论身在何处都能获得快速的加载时间。</p><h1 id="bb05" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">消除单点故障</h1><p id="b0f6" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">在我们公司的早期，我们处理了两起独立的DNS事件，给我们留下了创伤。在第一个事件中，我们的DNS提供商当时意外地从他们的系统中“取消”了我们的帐户，导致我们花了近6个小时才完全恢复。我们的第二个事件发生在常规DNS编辑导致我们的[不同] DNS提供商出现故障时，花了将近半天时间才解决。DNS事件尤其具有破坏性，因为即使在问题被识别和修复之后，您也必须等待各种DNS服务器和ISP清空它们的缓存，然后客户才能看到它们的修复(DNS服务器也倾向于忽略您的TTL设置并实施它们自己的策略)。</p><p id="5dae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们的经验使我们非常专注于消除整个架构中的任何单点故障。</p><p id="aec7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于DNS，我们转而使用来自不同DNS提供商的多个域名服务器。DNS提供商通常允许并鼓励你使用4-6个冗余域名服务器(如ns2.example.com，ns2.example.com)。这很好:如果一个失败了，请求仍然会被其他的解决。但是因为你所有的域名服务器都来自同一家公司，你就过于相信它们会100%正常运行。</p><p id="e827" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于我们的应用服务器，我们使用Heroku的监控和<a class="ae ks" href="https://blog.heroku.com/heroku-autoscaling" rel="noopener ugc nofollow" target="_blank">自动伸缩</a>工具来确保我们的性能不会因为流量高峰而下降(或者如果Fastly出现故障，我们突然需要将所有请求直接路由到我们的服务器)。除了使用Fastly缓存我们的API，我们还使用Memcached在应用程序级别缓存我们的API。这提供了针对间歇性数据库或服务器故障的额外弹性层。</p><p id="24b4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了防止Heroku或AWS(Heroku在其上运行)完全中断的罕见可能性，我们维护了一个运行在Google Cloud上的独立服务器和数据库实例，我们可以快速地故障转移到该实例。</p><h1 id="f9d2" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">失败不可避免</h1><p id="d151" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">无论我们的API有多可靠，我们都不得不接受网络不可靠，失败是必然会发生的。我们都经历过连接Wi-Fi出现问题，或者电话突然掉线。总体而言，停机、路由问题和其他间歇性故障在统计上可能并不常见，但在某种环境背景下仍然会一直发生。</p><p id="f6ba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了克服这种固有的不可靠环境，我们帮助客户构建了在出现故障时仍能保持稳定的应用程序。我们构建了SDK，其中包括当API请求失败时自动重试等功能，或者支持使用Redis等本地备份。</p><h1 id="37f0" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">最后的想法</h1><p id="e002" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">我们中的许多人都没有意识到，他们正在我们的堆栈中构建单点故障。为了构建有弹性的容错系统，您必须考虑堆栈的所有方面，并找到即使在一个或多个方面出现故障时也能保持服务正常运行的方法。</p><p id="decb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="lj">喜欢这篇文章吗？</em> <a class="ae ks" href="https://twitter.com/abi" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv"> <em class="lj">在Twitter上关注我</em> </strong> </a> <em class="lj">在这里，我分享关于创业和生活的想法。</em> <a class="ae ks" href="https://pullreminders.com/" rel="noopener ugc nofollow" target="_blank"> <em class="lj">看看我最新的产品</em> </a> <em class="lj">，它会给你发送关于GitHub拉请求的延期提醒。</em></p></div></div>    
</body>
</html>