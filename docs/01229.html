<html>
<head>
<title>Daily DynamoDB Backups With Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器的每日DynamoDB备份</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/daily-dynamodb-backups-with-serverless-ee625643254c?source=collection_archive---------18-----------------------#2018-02-07">https://medium.com/hackernoon/daily-dynamodb-backups-with-serverless-ee625643254c?source=collection_archive---------18-----------------------#2018-02-07</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="7034" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">在re:Invent 2017期间，亚马逊宣布了一个很酷的功能:DynamoDB表的按需备份。在这篇文章中，我将介绍如何使用<a class="ae jj" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>框架建立定期自动备份。</h2></div><p id="8a5c" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated"><strong class="jm hv"> <em class="kg">更新:随着</em> </strong> <a class="ae jj" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/PointInTimeRecovery.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jm hv"> <em class="kg">时间点恢复</em> </strong> </a> <strong class="jm hv"> <em class="kg">备份的推出，这种解决方案现在已经过时。</em>T15】</strong></p><p id="a570" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">TL；灾难恢复安装无服务器<a class="ae jj" href="https://github.com/unitoio/dynamodb-backup-scheduler" rel="noopener ugc nofollow" target="_blank">包</a>用于计划的DynamoDB备份</p><figure class="ki kj kk kl fq km fe ff paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="fe ff kh"><img src="../Images/4746db1ac301ddc4fc3c38243c51dd52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V0xFrrFuUdEwlLrfwN8BWA.jpeg"/></div></div><figcaption class="kt ku fg fe ff kv kw bd b be z ek">Remember photocopiers?</figcaption></figure><h2 id="350f" class="kx ky hu bd kz la lb lc ld le lf lg lh jt li lj lk jx ll lm ln kb lo lp lq lr dt translated">按需备份</h2><p id="686d" class="pw-post-body-paragraph jk jl hu jm b jn ls iv jp jq lt iy js jt lu jv jw jx lv jz ka kb lw kd ke kf hn dt translated">以前，备份<a class="ae jj" href="https://hackernoon.com/tagged/dynamodb" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>表既耗费资源又耗费时间。根据解决方案的不同，它将涉及在EC2基础设施上运行<a class="ae jj" href="https://github.com/bchew/dynamodump" rel="noopener ugc nofollow" target="_blank">定制程序</a>，或者甚至产生<a class="ae jj" href="https://docs.aws.amazon.com/emr/latest/ReleaseGuide/EMRforDynamoDB.html" rel="noopener ugc nofollow" target="_blank">Elastic Mapreduce</a>x-large实例。</p><p id="0442" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">现在，只需点击一个按钮，您就可以获得数Pb数据的即时备份。亚马逊能够通过给表拍快照来做到这一点(如果你好奇，你可以阅读关于<a class="ae jj" href="http://searchdatabackup.techtarget.com/tip/Using-different-types-of-storage-snapshot-technologies-for-data-protection" rel="noopener ugc nofollow" target="_blank">快照技术</a>)。</p><p id="66ae" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">按需备份用Amazon管理的密钥加密。它们包括:</p><ul class=""><li id="7d6b" class="lx ly hu jm b jn jo jq jr jt lz jx ma kb mb kf mc md me mf dt translated">表格数据；</li><li id="762a" class="lx ly hu jm b jn mg jq mh jt mi jx mj kb mk kf mc md me mf dt translated">调配的容量设置；</li><li id="1d00" class="lx ly hu jm b jn mg jq mh jt mi jx mj kb mk kf mc md me mf dt translated">以及本地和全局辅助索引的设置。</li></ul><p id="9c9c" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">但是，它们不包括:</p><ul class=""><li id="a26c" class="lx ly hu jm b jn jo jq jr jt lz jx ma kb mb kf mc md me mf dt translated">自动缩放设置，</li><li id="f496" class="lx ly hu jm b jn mg jq mh jt mi jx mj kb mk kf mc md me mf dt translated">TTL设置</li><li id="e528" class="lx ly hu jm b jn mg jq mh jt mi jx mj kb mk kf mc md me mf dt translated">标签</li><li id="f1c3" class="lx ly hu jm b jn mg jq mh jt mi jx mj kb mk kf mc md me mf dt translated">IAM策略</li><li id="94cd" class="lx ly hu jm b jn mg jq mh jt mi jx mj kb mk kf mc md me mf dt translated">CloudWatch指标和警报。</li></ul><p id="f0fc" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">您必须意识到，恢复备份将花费更多的时间，如果您有一个巨大的表，从30分钟到几个小时不等。</p><h2 id="d066" class="kx ky hu bd kz la lb lc ld le lf lg lh jt li lj lk jx ll lm ln kb lo lp lq lr dt translated">无服务器框架</h2><p id="a451" class="pw-post-body-paragraph jk jl hu jm b jn ls iv jp jq lt iy js jt lu jv jw jx lv jz ka kb lw kd ke kf hn dt translated">设置Lambdas、AMI权限、Cloudwatch设置可能会很痛苦。幸运的是，<a class="ae jj" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank"> Serverless </a>框架让它变得轻而易举！</p><blockquote class="ml"><p id="b676" class="mm mn hu bd mo mp mq mr ms mt mu kf ek translated">专注于您的应用，而不是您的基础设施。</p><p id="84db" class="mm mn hu bd mo mp mq mr ms mt mu kf ek translated">serverless.com⎯<a class="ae jj" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank"/></p></blockquote></div><div class="ab cl mv mw hc mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="hn ho hp hq hr"><h2 id="1888" class="kx ky hu bd kz la lb lc ld le lf lg lh jt li lj lk jx ll lm ln kb lo lp lq lr dt translated">装置</h2><p id="3dd4" class="pw-post-body-paragraph jk jl hu jm b jn ls iv jp jq lt iy js jt lu jv jw jx lv jz ka kb lw kd ke kf hn dt translated">让我们继续安装无服务器框架:</p><pre class="ki kj kk kl fq nc nd ne nf aw ng dt"><span id="b773" class="kx ky hu nd b fv nh ni l nj nk">npm install -g serverless</span></pre><p id="ec22" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">根据您的安装，您可能需要<em class="kg"> sudo。</em></p><p id="3a74" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">然后安装代码:</p><pre class="ki kj kk kl fq nc nd ne nf aw ng dt"><span id="535e" class="kx ky hu nd b fv nh ni l nj nk">git clone <a class="ae jj" href="https://github.com/unitoio/dynamodb-backup-scheduler.git" rel="noopener ugc nofollow" target="_blank">https://github.com/unitoio/dynamodb-backup-scheduler.git</a></span></pre><p id="1ad3" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">最棘手的部分是设置<a class="ae jj" href="https://hackernoon.com/tagged/aws" rel="noopener ugc nofollow" target="_blank"> AWS </a>权限。首先，您需要创建一个IAM配置文件，并为无服务器配置适当的权限。编辑文件<code class="eh nl nm nn nd b">aws-profile.json</code>中的代码，并用实际值替换<code class="eh nl nm nn nd b">&lt;region&gt;</code>和<code class="eh nl nm nn nd b">&lt;account&gt;</code>。获取您的帐号的最简单方法是从控制台的右上角访问支持中心:</p><figure class="ki kj kk kl fq km fe ff paragraph-image"><div class="fe ff no"><img src="../Images/7ad79d45c8dfa3f42a7502bef747735f.png" data-original-src="https://miro.medium.com/v2/resize:fit:712/format:webp/1*vqJcJXMwqpXJcabB95whZA.png"/></div></figure><p id="0d41" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">你的账户会出现在页面的顶部。</p><p id="a7bc" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">转到IAM控制台，用这个JSON内容创建一个新策略。随意命名(比如<code class="eh nl nm nn nd b">serverless-admin</code>)并将该策略附加到您的用户。</p><p id="a626" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">如果您没有设置访问密钥和密码，可以通过IAM生成它们，并通过创建新的配置文件将它们安装在您的机器上</p><pre class="ki kj kk kl fq nc nd ne nf aw ng dt"><span id="e561" class="kx ky hu nd b fv nh ni l nj nk">aws configure --profile <em class="kg">&lt;account_name&gt;</em></span></pre><h2 id="7956" class="kx ky hu bd kz la lb lc ld le lf lg lh jt li lj lk jx ll lm ln kb lo lp lq lr dt translated">配置</h2><p id="a7d7" class="pw-post-body-paragraph jk jl hu jm b jn ls iv jp jq lt iy js jt lu jv jw jx lv jz ka kb lw kd ke kf hn dt translated">这个<code class="eh nl nm nn nd b">dynamodb-backup-scheduler</code>包很容易配置。将文件<code class="eh nl nm nn nd b">env-example.yml</code>复制到<code class="eh nl nm nn nd b">env.yml</code>。该文件是不言自明的。您将指定要备份的表的列表，以及备份的保留时间。</p><h2 id="67b1" class="kx ky hu bd kz la lb lc ld le lf lg lh jt li lj lk jx ll lm ln kb lo lp lq lr dt translated">部署</h2><p id="b002" class="pw-post-body-paragraph jk jl hu jm b jn ls iv jp jq lt iy js jt lu jv jw jx lv jz ka kb lw kd ke kf hn dt translated">我们都准备好了:</p><pre class="ki kj kk kl fq nc nd ne nf aw ng dt"><span id="c98c" class="kx ky hu nd b fv nh ni l nj nk">serverless deploy -v</span></pre><p id="2753" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">观察serverless为您创建Lambda函数、它的IAM角色和CloudWatch事件时的输出。</p><p id="e557" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">就是这样！您的计划备份已设置好！不过，如果你像我一样，你会想现在就测试lambda函数，而不是等待每日事件触发。</p><h2 id="322b" class="kx ky hu bd kz la lb lc ld le lf lg lh jt li lj lk jx ll lm ln kb lo lp lq lr dt translated">测试Lambda</h2><p id="b06e" class="pw-post-body-paragraph jk jl hu jm b jn ls iv jp jq lt iy js jt lu jv jw jx lv jz ka kb lw kd ke kf hn dt translated">在Lambda控制台中，单击刚刚创建的函数。它会有一个类似<code class="eh nl nm nn nd b">dynamodb-backup-scheduler-production-backupDynamoDBTables</code>的名字。在顶部附近，创建一个新的测试事件:</p><figure class="ki kj kk kl fq km fe ff paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="fe ff kh"><img src="../Images/c32734b54932f9c1aef4d31aa0d2ca8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2QTy41_DGcIjSjDNjIsHPQ.png"/></div></div></figure><p id="6299" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">通过查看源文件<code class="eh nl nm nn nd b">serverless.yml</code>，我们看到lamda被发送了3个输入。我们在测试活动中需要这些:</p><figure class="ki kj kk kl fq km fe ff paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="fe ff np"><img src="../Images/a7a25c3ec40898b78c7ac9023be58e88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VX0dYdoBwLUyeDs2IL3DUg.png"/></div></div></figure><p id="039b" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">确保在最后一个参数中给出真实的表名。一旦创建了测试事件，我们就回到了Lambda函数页面，单击test按钮</p><figure class="ki kj kk kl fq km fe ff paragraph-image"><div class="fe ff nq"><img src="../Images/4cf0dc50b37c1178071ee38705e0c223.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*iTV3k8Mxg4RG-rMT9vDLdQ.png"/></div></figure><p id="ec41" class="pw-post-body-paragraph jk jl hu jm b jn jo iv jp jq jr iy js jt ju jv jw jx jy jz ka kb kc kd ke kf hn dt translated">执行结果将显示在绿色部分。如果一切正常，您可以转到DynamoDB控制台，验证名为<code class="eh nl nm nn nd b">backupTest</code>的备份确实已经创建:</p><figure class="ki kj kk kl fq km fe ff paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="fe ff nr"><img src="../Images/51b2bc6acf9fe9ad35df6067860ce9bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mJe151VfxPA5FEu7eGmC_Q.png"/></div></div></figure><h2 id="df93" class="kx ky hu bd kz la lb lc ld le lf lg lh jt li lj lk jx ll lm ln kb lo lp lq lr dt translated">通过SNS警报进行监控</h2><p id="bdcd" class="pw-post-body-paragraph jk jl hu jm b jn ls iv jp jq lt iy js jt lu jv jw jx lv jz ka kb lw kd ke kf hn dt translated">为了使该过程完整并达到生产级别，还剩下一件事:在备份失败时添加一个警报。这是通过<a class="ae jj" href="https://serverless.com/blog/serverless-ops-metrics/" rel="noopener ugc nofollow" target="_blank">无服务器插件-aws-alerts </a>插件完成的。该包允许您在生产阶段通过在<code class="eh nl nm nn nd b">env.yml</code>中指定一个变量来启用这一功能，该变量指定将由插件创建的SNS主题的订阅。</p><pre class="ki kj kk kl fq nc nd ne nf aw ng dt"><span id="73c3" class="kx ky hu nd b fv nh ni l nj nk">notifications:<br/>  - protocol: email<br/>    endpoint: me@example.com</span></pre><figure class="ki kj kk kl fq km"><div class="bz el l di"><div class="ns nt l"/></div></figure></div></div>    
</body>
</html>