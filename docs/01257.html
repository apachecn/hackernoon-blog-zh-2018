<html>
<head>
<title>How to build a message delivery status in JavaScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用JavaScript构建消息传递状态</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-build-a-message-delivery-status-in-javascript-9889ee98f480?source=collection_archive---------14-----------------------#2018-02-08">https://medium.com/hackernoon/how-to-build-a-message-delivery-status-in-javascript-9889ee98f480?source=collection_archive---------14-----------------------#2018-02-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="cb16" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当构建实时应用程序时，我们经常想知道一个过程或事件发生的实际时间。例如，在一个即时消息应用程序中，我们想知道我们的消息是否以及何时被发送到目标客户。我们在WhatsApp上看到了这一点，消息是实时发送的，你可以看到每条消息在发送和阅读时的状态，发送时有两个灰色勾号，阅读时有两个蓝色勾号。我们可以使用Pusher和JavaScript很容易地构建一个消息传递状态。</p><h1 id="42b6" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">怎么会？</h1><p id="31c2" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">Pusher有一个通道和事件的概念，这是它的基础。我们可以通过通道向客户端发送消息，并让客户端通过触发一个事件来通知我们已读回执，发送方将侦听该事件并做出相应的反应。</p><p id="1c9d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通道提供了一种过滤数据和控制对不同信息流的访问的方式，而事件则是在构成所有通信基础的推送系统中打包消息的主要方法。</p><p id="9532" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要用Pusher实现消息传递状态，我们必须订阅一个通道并监听通道上的事件。我们将用JavaScript构建一个简单的聊天应用程序，它将向客户端发送消息，客户端收到消息后将触发一个事件。</p><h1 id="d6e3" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">应用程序设置</h1><p id="7f6f" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">要使用Pusher API，我们必须从仪表板注册并创建一个Pusher应用程序。我们可以创建尽可能多的应用程序，每个应用程序都将获得一个应用程序id和密钥，我们将使用它们在客户端或服务器端代码上初始化Pusher实例。</p><h1 id="0647" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">创建新的推销商账户</h1><ol class=""><li id="80fe" class="ks kt hu it b iu kn iy ko jc ku jg kv jk kw jo kx ky kz la dt translated"><a class="ae lb" href="https://pusher.com/signup" rel="noopener ugc nofollow" target="_blank">注册</a>成为Pusher，如果您已经有帐户，请登录。</li><li id="50c0" class="ks kt hu it b iu lc iy ld jc le jg lf jk lg jo kx ky kz la dt translated">注册后，我们进入仪表板，显示一个屏幕来设置一个新的pusher应用程序。</li><li id="ff1f" class="ks kt hu it b iu lc iy ld jc le jg lf jk lg jo kx ky kz la dt translated">输入应用程序的名称。在这种情况下，我称之为“聊天”。</li><li id="58e4" class="ks kt hu it b iu lc iy ld jc le jg lf jk lg jo kx ky kz la dt translated">选择一个集群</li><li id="89f3" class="ks kt hu it b iu lc iy ld jc le jg lf jk lg jo kx ky kz la dt translated">如果您希望拥有不同的开发、试运行和生产实例，请选择“为多个环境创建应用程序”选项</li><li id="4e3e" class="ks kt hu it b iu lc iy ld jc le jg lf jk lg jo kx ky kz la dt translated">选择前端技术。我将选择VanillaJS，因为我不会使用任何框架</li><li id="3430" class="ks kt hu it b iu lc iy ld jc le jg lf jk lg jo kx ky kz la dt translated">选择NodeJS作为我的后端</li><li id="74b9" class="ks kt hu it b iu lc iy ld jc le jg lf jk lg jo kx ky kz la dt translated">点击<strong class="it hv">创建App </strong>创建推送App。</li></ol><figure class="li lj lk ll fq lm fe ff paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="fe ff lh"><img src="../Images/81ad364287469525973d8c58a7a0dde2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ccHV41RvhiW6Ldha.png"/></div></div></figure><h1 id="5c14" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">密码</h1><p id="2c6f" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">我们将使用通道作为通过通道发送消息和触发事件的手段。推动器中有3种通道:</p><ul class=""><li id="a602" class="ks kt hu it b iu iv iy iz jc lt jg lu jk lv jo lw ky kz la dt translated"><strong class="it hv">公共频道</strong>，任何知道频道名称的人都可以订阅。</li><li id="b6dc" class="ks kt hu it b iu lc iy ld jc le jg lf jk lg jo lw ky kz la dt translated">私有频道，让你的服务器控制对你正在广播的数据的访问。</li><li id="9fd6" class="ks kt hu it b iu lc iy ld jc le jg lf jk lg jo lw ky kz la dt translated"><strong class="it hv">存在频道</strong>是私有频道的扩展，但强制频道订阅者在订阅时注册用户信息。它还能让用户知道谁在线。</li></ul><p id="6059" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">客户端需要通过身份验证才能使用私有通道和在线通道。对于示例应用程序，我们将使用vanilla JS构建客户机，使用NodeJS构建服务器(用于身份验证)。因为我不希望消息通过服务器，而是从客户端到客户端，并且我不需要知道用户是在线还是离开，所以我将使用一个私有通道进行演示，但是同样的技术也适用于任何类型的通道。客户端事件只能在私有或存在通道中触发，要使用这些通道类型，用户/客户端必须经过身份验证，因此需要NodeJS后端进行身份验证。</p><p id="99bd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，要使用客户端事件，必须为应用程序启用它们。转到Pusher仪表盘，在<strong class="it hv">应用设置</strong>选项卡上，选择“启用客户端事件”并更新。</p><h2 id="bd91" class="lx jq hu bd jr ly lz ma jv mb mc md jz jc me mf kd jg mg mh kh jk mi mj kl mk dt translated">后端</h2><p id="d463" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">因为我们正在使用Express在node中构建后端，所以让我们初始化一个新的Node应用程序并安装所需的依赖项。运行以下命令:</p><ul class=""><li id="34b3" class="ks kt hu it b iu iv iy iz jc lt jg lu jk lv jo lw ky kz la dt translated"><code class="eh ml mm mn mo b">npm init</code>并选择默认选项</li><li id="3139" class="ks kt hu it b iu lc iy ld jc le jg lf jk lg jo lw ky kz la dt translated"><code class="eh ml mm mn mo b">npm i --save body-parser express pusher</code>安装express和Pusher节点包</li></ul><p id="b95b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">添加一个名为<code class="eh ml mm mn mo b">server.js</code>的新文件，该文件将包含认证推送客户端的逻辑，并呈现我们稍后将添加的静态文件。该文件将包含以下内容</p><pre class="li lj lk ll fq mp mo mq mr aw ms dt"><span id="3ac8" class="lx jq hu mo b fv mt mu l mv mw">var express = require('express');<br/>var bodyParser = require('body-parser');</span><span id="b7d0" class="lx jq hu mo b fv mx mu l mv mw">var Pusher = require('pusher');</span><span id="a417" class="lx jq hu mo b fv mx mu l mv mw">var app = express();<br/>app.use(bodyParser.json());<br/>app.use(bodyParser.urlencoded({ extended: false }));</span><span id="2c49" class="lx jq hu mo b fv mx mu l mv mw">var pusher = new Pusher({ appId: APP_ID, key: APP_KEY, secret:  APP_SECRET, cluster: APP_Cluster });</span><span id="972b" class="lx jq hu mo b fv mx mu l mv mw">app.get('/',function(req,res){      <br/>     res.sendFile('index.html', {root: __dirname });<br/>});</span><span id="f61d" class="lx jq hu mo b fv mx mu l mv mw">app.use(express.static(__dirname + '/'));</span><span id="b21a" class="lx jq hu mo b fv mx mu l mv mw">app.post('/pusher/auth', function(req, res) {<br/>  var socketId = req.body.socket_id;<br/>  var channel = req.body.channel_name;<br/>  var auth = pusher.authenticate(socketId, channel);<br/>  res.send(auth);<br/>});</span><span id="e34f" class="lx jq hu mo b fv mx mu l mv mw">var port = process.env.PORT || 5000;<br/>app.listen(port, function () {<br/>  console.log(`Example app listening on port ${port}!`)<br/>});</span></pre><p id="d518" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们通过传入一个对象来实例化Pusher，该对象包含我们的应用ID和密钥的详细信息，可以在Pusher仪表板的<strong class="it hv">应用密钥</strong>选项卡上找到。线路<code class="eh ml mm mn mo b">var auth = pusher.authenticate(socketId, channel);</code>向Pusher认证客户端，并向主叫客户端返回认证码。为了允许在启动npm时运行该文件，我们使用以下值更新package.json:</p><pre class="li lj lk ll fq mp mo mq mr aw ms dt"><span id="a432" class="lx jq hu mo b fv mt mu l mv mw">"scripts": {<br/>    "start": "node server.js",<br/>    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"<br/>  },</span></pre><h2 id="378e" class="lx jq hu bd jr ly lz ma jv mb mc md jz jc me mf kd jg mg mh kh jk mi mj kl mk dt translated">前端</h2><p id="56a6" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">后端就绪后，我们现在继续制作前端。我们将使用来自这个<a class="ae lb" href="http://bootsnipp.com/snippets/6eWd" rel="noopener ugc nofollow" target="_blank">站点</a>的模板，稍加修改。</p><p id="937a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">添加一个名为<code class="eh ml mm mn mo b">index.html</code>和<code class="eh ml mm mn mo b">style.css</code>的新文件，每个文件的内容如下:</p><p id="3081" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">Index.html</strong></p><pre class="li lj lk ll fq mp mo mq mr aw ms dt"><span id="0220" class="lx jq hu mo b fv mt mu l mv mw">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;</span><span id="c02b" class="lx jq hu mo b fv mx mu l mv mw">    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"&gt;<br/></span><span id="1ae1" class="lx jq hu mo b fv mx mu l mv mw">    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous"&gt;</span><span id="ca53" class="lx jq hu mo b fv mx mu l mv mw">    &lt;scriptsrc="https://code.jquery.com/jquery-2.2.4.min.js"<br/>        integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="<br/>        crossorigin="anonymous"&gt;&lt;/script&gt;<br/></span><span id="0d30" class="lx jq hu mo b fv mx mu l mv mw">    &lt;script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"&gt;&lt;/script&gt;</span><span id="4459" class="lx jq hu mo b fv mx mu l mv mw">    &lt;link rel="stylesheet" href="style.css"&gt;<br/>    &lt;script src="https://js.pusher.com/4.0/pusher.min.js"&gt;&lt;/script&gt;<br/>    &lt;script src="index.js"&gt;&lt;/script&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>    &lt;div class="container"&gt;<br/>    &lt;div class="row form-group"&gt;<br/>        &lt;div class="col-xs-12 col-md-offset-2 col-md-8 col-lg-8 col-lg-offset-2"&gt;<br/>            &lt;div class="panel panel-primary"&gt;<br/>                &lt;div class="panel-heading"&gt;<br/>                    &lt;span class="glyphicon glyphicon-comment"&gt;&lt;/span&gt; Comments<br/>                    &lt;div class="btn-group pull-right"&gt;<br/>                        &lt;button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown"&gt;<br/>                            &lt;span class="glyphicon glyphicon-chevron-down"&gt;&lt;/span&gt;<br/>                        &lt;/button&gt;<br/>                        &lt;ul class="dropdown-menu slidedown"&gt;<br/>                            &lt;li&gt;&lt;a href="http://www.jquery2dotnet.com"&gt;&lt;span class="glyphicon glyphicon-refresh"&gt;<br/>                            &lt;/span&gt;Refresh&lt;/a&gt;&lt;/li&gt;<br/>                            &lt;li&gt;&lt;a href="http://www.jquery2dotnet.com"&gt;&lt;span class="glyphicon glyphicon-ok-sign"&gt;<br/>                            &lt;/span&gt;Available&lt;/a&gt;&lt;/li&gt;<br/>                            &lt;li&gt;&lt;a href="http://www.jquery2dotnet.com"&gt;&lt;span class="glyphicon glyphicon-remove"&gt;<br/>                            &lt;/span&gt;Busy&lt;/a&gt;&lt;/li&gt;<br/>                            &lt;li&gt;&lt;a href="http://www.jquery2dotnet.com"&gt;&lt;span class="glyphicon glyphicon-time"&gt;&lt;/span&gt;<br/>                                Away&lt;/a&gt;&lt;/li&gt;<br/>                            &lt;li class="divider"&gt;&lt;/li&gt;<br/>                            &lt;li&gt;&lt;a href="http://www.jquery2dotnet.com"&gt;&lt;span class="glyphicon glyphicon-off"&gt;&lt;/span&gt;<br/>                                Sign Out&lt;/a&gt;&lt;/li&gt;<br/>                        &lt;/ul&gt;<br/>                    &lt;/div&gt;<br/>                &lt;/div&gt;<br/>                &lt;div class="panel-body body-panel"&gt;<br/>                    &lt;ul class="chat"&gt;</span><span id="34f8" class="lx jq hu mo b fv mx mu l mv mw">                    &lt;/ul&gt;<br/>                &lt;/div&gt;<br/>                &lt;div class="panel-footer clearfix"&gt;<br/>                    &lt;textarea id="message" class="form-control" rows="3"&gt;&lt;/textarea&gt;<br/>                    &lt;span class="col-lg-6 col-lg-offset-3 col-md-6 col-md-offset-3 col-xs-12" style="margin-top: 10px"&gt;<br/>                        &lt;button class="btn btn-warning btn-lg btn-block" id="btn-chat"&gt;Send&lt;/button&gt;<br/>                    &lt;/span&gt;<br/>                &lt;/div&gt;<br/>            &lt;/div&gt;<br/>        &lt;/div&gt;<br/>    &lt;/div&gt;<br/>&lt;/div&gt;</span><span id="213e" class="lx jq hu mo b fv mx mu l mv mw">&lt;script id="new-message-other" type="text/template"&gt;<br/>    &lt;li class="left clearfix"&gt;<br/>        &lt;span class="chat-img pull-left"&gt;<br/>            &lt;img src="http://placehold.it/50/55C1E7/fff&amp;text=U" alt="User Avatar" class="img-circle" /&gt;<br/>        &lt;/span&gt;<br/>        &lt;div class="chat-body clearfix"&gt;<br/>            &lt;p&gt;<br/>                {{body}}<br/>            &lt;/p&gt;<br/>        &lt;/div&gt;<br/>    &lt;/li&gt;<br/>&lt;/script&gt;</span><span id="cacc" class="lx jq hu mo b fv mx mu l mv mw">&lt;script id="new-message-me" type="text/template"&gt;<br/>    &lt;li id="{{id}}" class="right clearfix"&gt;<br/>        &lt;span class="chat-img pull-right"&gt;<br/>            &lt;img src="http://placehold.it/50/FA6F57/fff&amp;text=ME" alt="User Avatar" class="img-circle" /&gt;<br/>        &lt;/span&gt;<br/>        &lt;div class="chat-body clearfix"&gt;<br/>            &lt;div class="header"&gt;<br/>                &lt;small class="text-muted"&gt;{{status}}&lt;/small&gt;</span><span id="add6" class="lx jq hu mo b fv mx mu l mv mw">            &lt;/div&gt;<br/>            &lt;p&gt;<br/>                {{body}}<br/>            &lt;/p&gt;<br/>        &lt;/div&gt;<br/>    &lt;/li&gt;<br/>&lt;/script&gt;</span><span id="5a7c" class="lx jq hu mo b fv mx mu l mv mw">&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="fe3d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> style.css </strong></p><pre class="li lj lk ll fq mp mo mq mr aw ms dt"><span id="0d9e" class="lx jq hu mo b fv mt mu l mv mw">@import url("http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css");<br/>.chat<br/>{<br/>    list-style: none;<br/>    margin: 0;<br/>    padding: 0;<br/>}</span><span id="6a3d" class="lx jq hu mo b fv mx mu l mv mw">.chat li<br/>{<br/>    margin-bottom: 10px;<br/>    padding-bottom: 5px;<br/>    border-bottom: 1px dotted #B3A9A9;<br/>}</span><span id="8f07" class="lx jq hu mo b fv mx mu l mv mw">.chat li.left .chat-body<br/>{<br/>    margin-left: 60px;<br/>}</span><span id="6a75" class="lx jq hu mo b fv mx mu l mv mw">.chat li.right .chat-body<br/>{<br/>    margin-right: 60px;<br/>}<br/></span><span id="3772" class="lx jq hu mo b fv mx mu l mv mw">.chat li .chat-body p<br/>{<br/>    margin: 0;<br/>    color: #777777;<br/>}</span><span id="3431" class="lx jq hu mo b fv mx mu l mv mw">.panel .slidedown .glyphicon, .chat .glyphicon<br/>{<br/>    margin-right: 5px;<br/>}</span><span id="108c" class="lx jq hu mo b fv mx mu l mv mw">.body-panel<br/>{<br/>    overflow-y: scroll;<br/>    height: 250px;<br/>}</span><span id="cead" class="lx jq hu mo b fv mx mu l mv mw">::-webkit-scrollbar-track<br/>{<br/>    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);<br/>    background-color: #F5F5F5;<br/>}</span><span id="c1f2" class="lx jq hu mo b fv mx mu l mv mw">::-webkit-scrollbar<br/>{<br/>    width: 12px;<br/>    background-color: #F5F5F5;<br/>}</span><span id="13ad" class="lx jq hu mo b fv mx mu l mv mw">::-webkit-scrollbar-thumb<br/>{<br/>    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,.3);<br/>    background-color: #555;<br/>}</span></pre><p id="20a5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们添加的页面包含一个一对一的聊天模板。在第<strong class="it hv"> 18 </strong>行，我们添加了加载Pusher JavaScript库的脚本，在第<strong class="it hv"> 19 </strong>行，我们加载了一个自定义的JavaScript文件，我们将使用它来处理来自页面的交互。添加包含以下内容的文件:</p><p id="3cab" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">索引. js </strong></p><pre class="li lj lk ll fq mp mo mq mr aw ms dt"><span id="bb1e" class="lx jq hu mo b fv mt mu l mv mw">$(document).ready(function(){<br/>    // Enable pusher logging - don't include this in production<br/>    Pusher.logToConsole = true;</span><span id="d8aa" class="lx jq hu mo b fv mx mu l mv mw">    var pusher = new Pusher('APP_KEY', {<br/>        cluster: 'eu',<br/>        encrypted: false<br/>    });</span><span id="3ab1" class="lx jq hu mo b fv mx mu l mv mw">    var channel = pusher.subscribe('private-channel');<br/>    //channel name prefixed with 'private' because it'll be a private channel<br/>});</span></pre><p id="b532" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">从上面的代码中，我们首先通过使用<strong class="it hv"> App_Key </strong>和集群创建一个Pusher对象来连接到Pusher。这些值是从推杆仪表板上获得的。<code class="eh ml mm mn mo b">encrypted</code>设置为false，允许它在未加密的连接上发送信息。</p><p id="6f23" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，我们订阅一个用于发送消息的频道。频道名称可以是任何名称，但最长不得超过164个字符。私有信道的另一个限制是它必须以<code class="eh ml mm mn mo b">private-</code>为前缀。</p><p id="ce41" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，我们绑定到事件。这样，我们可以通过订阅的通道从客户端接收消息。在<code class="eh ml mm mn mo b">index.js</code>中添加以下一行</p><pre class="li lj lk ll fq mp mo mq mr aw ms dt"><span id="4d27" class="lx jq hu mo b fv mt mu l mv mw">channel.bind('client-message-added', onMessageAdded);<br/>channel.bind('client-message-delivered', onMessageDelivered);</span><span id="4e2d" class="lx jq hu mo b fv mx mu l mv mw">$('#btn-chat').click(function(){<br/>    const id = generateId();<br/>    const message = $("#message").val();<br/>    $("#message").val("");</span><span id="24bc" class="lx jq hu mo b fv mx mu l mv mw">    let template = $("#new-message-me").html();<br/>    template = template.replace("{{id}}", id);<br/>    template = template.replace("{{body}}", message);<br/>    template = template.replace("{{status}}", "");</span><span id="216c" class="lx jq hu mo b fv mx mu l mv mw">    $(".chat").append(template);</span><span id="a9cd" class="lx jq hu mo b fv mx mu l mv mw">    //send message<br/>    channel.trigger("client-message-added", { id, message });<br/>});<br/>function generateId() {<br/>    return Math.round(new Date().getTime() + (Math.random() * 100));<br/>}</span><span id="17d9" class="lx jq hu mo b fv mx mu l mv mw">function onMessageAdded(data) {<br/>    let template = $("#new-message-other").html();<br/>    template = template.replace("{{body}}", data.message);</span><span id="538f" class="lx jq hu mo b fv mx mu l mv mw">    $(".chat").append(template);</span><span id="4f93" class="lx jq hu mo b fv mx mu l mv mw">    //notify sender<br/>    channel.trigger("client-message-delivered", { id: data.id });<br/>}</span><span id="e381" class="lx jq hu mo b fv mx mu l mv mw">function onMessageDelivered(data) {<br/>    $("#" + data.id).find("small").html("Delivered");<br/>}</span></pre><p id="d7d7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将从客户端触发事件，不希望它通过后端或被验证。这只是为了这个演示。<a class="ae lb" href="https://pusher.com/docs/client_api_guide/client_events#trigger-events" rel="noopener ugc nofollow" target="_blank">客户端事件</a>必须以<code class="eh ml mm mn mo b">client-</code>为前缀，这就是为什么我用上面的代码这样做的原因。带有任何其他前缀的事件将被推送服务器拒绝，发送到客户端未订阅的频道的事件也是如此。</p><blockquote class="my"><p id="0bba" class="mz na hu bd nb nc nd ne nf ng nh jo ek translated"><em class="ni">触发客户端事件时要格外小心，这一点很重要。因为这些内容来自其他用户，可能会被您站点的恶意用户篡改。</em></p></blockquote><p id="c466" class="pw-post-body-paragraph ir is hu it b iu nj iw ix iy nk ja jb jc nl je jf jg nm ji jj jk nn jm jn jo hn dt translated">当用户输入新消息时，将触发<code class="eh ml mm mn mo b">client-message-added</code>。一旦其他用户收到消息，它就会显示在页面上，并触发<code class="eh ml mm mn mo b">client-message-delivered</code>事件来通知发送者收到消息。通过这种方式，我们可以实现在应用程序中获得消息传递状态通知的目标。</p><p id="9862" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行应用程序，看看它是如何工作的。</p><figure class="li lj lk ll fq lm fe ff paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="fe ff no"><img src="../Images/4b3611eec234ee48cc845f50acd79a36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*mCu6YSLpLoHyLbQw2jBvyw.gif"/></div></div></figure><h1 id="0a3d" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">包裹</h1><p id="ad73" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">到目前为止，您已经看到了，并且知道通道和事件是Pusher的基础，我希望我已经向您展示了如何使用Pusher和JavaScript实现消息交付状态。你可以在<a class="ae lb" href="https://github.com/pmbanugo/pusher-message-delivery-status" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到代码</p></div><div class="ab cl np nq hc nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="hn ho hp hq hr"><p id="a7cf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="nw">此文最初发表于</em> <a class="ae lb" href="https://blog.pusher.com/build-secure-chat-web-app-javascript-auth0-pusher/" rel="noopener ugc nofollow" target="_blank"> <em class="nw">推手</em> </a></p></div></div>    
</body>
</html>