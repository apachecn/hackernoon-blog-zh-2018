<html>
<head>
<title>Docker Quotas and Mario Bros</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">码头配额和马里奥兄弟</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/docker-quotas-and-mario-bros-706aad98ba72?source=collection_archive---------16-----------------------#2018-02-08">https://medium.com/hackernoon/docker-quotas-and-mario-bros-706aad98ba72?source=collection_archive---------16-----------------------#2018-02-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><h1 id="ff5f" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">简介:</h1><p id="2f0a" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">很久以来我一直想写关于<strong class="jr hv"> docker </strong>和<a class="ae kn" href="https://en.wikipedia.org/wiki/Completely_Fair_Scheduler" rel="noopener ugc nofollow" target="_blank">T3】CFST5(完全公平调度器)的东西，但是我一直忙于工作等。</a></p><p id="6d39" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">我将使用Docker来限制进程的<strong class="jr hv"> cpu </strong>使用率，我们将探索我们需要什么样的指标来对供应不足的应用程序进行故障排除，我们将使用<a class="ae kn" href="http://www.fceux.com/web/home.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jr hv"> fceux </strong> </a>和<strong class="jr hv"> mario </strong></p><h1 id="1f4b" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">CFS(调度程序):</h1><p id="e52e" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated"><strong class="jr hv"> CFS </strong>已经成为<strong class="jr hv"> linux </strong>内核的默认调度程序有一段时间了，这并不是试图深入解释它，但是有很多关于这一点的有趣数据，尤其是关于主要开发者来自医疗领域之类的东西。</p><p id="a2cc" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">调度周期用<strong class="jr hv"> cpu.cfs_period_us </strong>表示，它们实际上是以微秒表示的时间单位，你可以称之为一个c <strong class="jr hv"> pu周期</strong>的长度，但重要的是</p><p id="01ff" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">它可以做得更长或更短。没有<strong class="jr hv"> cpu.cfs_quota_us，</strong>周期就什么都不是，就像是在说，如果我们不打算在这段时间里节流或做任何事情，那么计算时间又有什么意义。</p><p id="5e4a" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">在下面的例子中，一个给定的<strong class="jr hv">进程A，</strong>已经配置了一个:</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="dfff" class="lc is hu ky b fv ld le l lf lg"><strong class="ky hv">cpu.cfs_period_us = 100</strong></span><span id="41f1" class="lc is hu ky b fv lh le l lf lg"><strong class="ky hv">cpu.cfs_quota_us = 200</strong></span></pre><p id="a2d9" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">这可能看起来令人困惑，但是<strong class="jr hv"> perdiod </strong>按照<strong class="jr hv"> cpu </strong>(内核，如操作系统所见)计算，这意味着该配置将允许进程A“爆发”并运行2个周期(每个<strong class="jr hv"> cpu </strong>中1个周期)而不被抑制。</p><figure class="kt ku kv kw fq lj fe ff paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="fe ff li"><img src="../Images/e5114257deb256b493173f43822d344c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V7zCl0rxuSoz062Fpns-IA.png"/></div></div><figcaption class="lq lr fg fe ff ls lt bd b be z ek">yellow indicates your allowance</figcaption></figure><h1 id="9773" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">码头限额:</h1><p id="ad41" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">以上是理论，实际上你可以通过使用一些标志来达到同样的效果，例如:</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="50e6" class="lc is hu ky b fv ld le l lf lg">docker run -ti <strong class="ky hv">--cpu-period=50000 --cpu-quota=1000</strong> alpine sh</span></pre><p id="df27" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">这将创建一个新的<strong class="jr hv"> cgroup </strong> leaf，你可以这样找到它:</p><figure class="kt ku kv kw fq lj fe ff paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="fe ff lu"><img src="../Images/5cf3413e117657973c8c9da2534ad042.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YV2gYm2OAAEMU8XlVkqGTg.png"/></div></div></figure><p id="1fde" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">有了容器ID，我们将会到特定的<strong class="jr hv">组</strong>叶:</p><figure class="kt ku kv kw fq lj fe ff paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="fe ff lv"><img src="../Images/9e04323baeb34077f338e7b95058e0d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OsNKmMkF-dt_i7ojFK8muw.png"/></div></div></figure><p id="ee57" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">这里有很多真正有趣的东西，但我们将重点关注<strong class="jr hv"> cpu.stat，</strong>它看起来像这样:</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="b617" class="lc is hu ky b fv ld le l lf lg">nr_periods <strong class="ky hv">51</strong><br/>nr_throttled <strong class="ky hv">45</strong><br/>throttled_time 2313838319</span></pre><p id="fe15" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">基本上这意味着我们已经运行了<strong class="jr hv"> 51 </strong>个周期，其中有<strong class="jr hv"> 45 </strong>个周期被节流，节流时间为<strong class="jr hv"> 2313838319 </strong> us。</p><p id="337c" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">这在分析您想要<strong class="jr hv">停靠</strong>的应用程序时非常有用，例如，调整限制指标应该会让您的进程不会受到太多限制。</p><h1 id="ff11" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">马里奥呢？？</h1><p id="4f9b" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">我想选择一个过程，让我用图形来展示它，而不是用python脚本来寻找质数或类似的东西，所以Mario是这样的:</p><h2 id="b80b" class="lc is hu bd it lw lx ly ix lz ma mb jb ka mc md jf ke me mf jj ki mg mh jn mi dt translated">马里奥周期= 50000配额= 1000 [[~7 FPS]](几乎100%节流)</h2><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="899d" class="lc is hu ky b fv ld le l lf lg">docker run -ti — cpu-period=<strong class="ky hv">50000</strong> — cpu-quota=<strong class="ky hv">1000</strong> -e DISPLAY=$DISPLAY -v /home/jgarcia/Projects/games/games/:/games -v /tmp/.X11-unix:/tmp/.X11-unix -v /run/dbus/:/run/dbus/ — privileged 352b46a178cb</span></pre><p id="5306" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">结果:</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="32d8" class="lc is hu ky b fv ld le l lf lg">nr_periods <strong class="ky hv">411</strong><br/>nr_throttled <strong class="ky hv">385</strong><br/>throttled_time 22032678629</span></pre><figure class="kt ku kv kw fq lj"><div class="bz el l di"><div class="mj mk l"/></div><figcaption class="lq lr fg fe ff ls lt bd b be z ek">50000x1000</figcaption></figure><h2 id="5da9" class="lc is hu bd it lw lx ly ix lz ma mb jb ka mc md jf ke me mf jj ki mg mh jn mi dt translated">马里奥周期= 50000配额= 2000 [[~15 FPS]](还是不好..)</h2><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="e44e" class="lc is hu ky b fv ld le l lf lg">docker run -ti --cpu-period=<strong class="ky hv">50000</strong> --cpu-quota=<strong class="ky hv">2000</strong> -e DISPLAY=$DISPLAY -v /home/jgarcia/Projects/games/games/:/games -v /tmp/.X11-unix:/tmp/.X11-unix -v /run/dbus/:/run/dbus/ --p<br/>rivileged 352b46a178cb</span></pre><p id="becb" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">结果:</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="b00b" class="lc is hu ky b fv ld le l lf lg">nr_periods <strong class="ky hv">419</strong><br/>nr_throttled <strong class="ky hv">397</strong><br/>throttled_time 18784846882</span></pre><figure class="kt ku kv kw fq lj"><div class="bz el l di"><div class="ml mk l"/></div><figcaption class="lq lr fg fe ff ls lt bd b be z ek">50000 x 2000</figcaption></figure><h2 id="df92" class="lc is hu bd it lw lx ly ix lz ma mb jb ka mc md jf ke me mf jj ki mg mh jn mi dt translated">马里奥周期= 50000配额= 5000 [[~40 FPS]](非常好)</h2><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="1488" class="lc is hu ky b fv ld le l lf lg">docker run -ti --cpu-period=<strong class="ky hv">50000</strong> --cpu-quota=<strong class="ky hv">5000</strong> -e DISPLAY=$DISPLAY -v /home/jgarcia/Projects/games/games/:/games -v /tmp/.X11-unix:/tmp/.X11-unix -v /run/dbus/:/run/dbus/ --privileged 352b46a178cb</span></pre><p id="d325" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">结果:</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="c3cd" class="lc is hu ky b fv ld le l lf lg">nr_periods <strong class="ky hv">385</strong><br/>nr_throttled <strong class="ky hv">32</strong><br/>throttled_time 992353904</span></pre><figure class="kt ku kv kw fq lj"><div class="bz el l di"><div class="mm mk l"/></div><figcaption class="lq lr fg fe ff ls lt bd b be z ek">50000x5000</figcaption></figure><h2 id="1197" class="lc is hu bd it lw lx ly ix lz ma mb jb ka mc md jf ke me mf jj ki mg mh jn mi dt translated"><strong class="ak">马里奥跑配额少[[~62 FPS]](完美！！)</strong></h2><p id="db32" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">撒野！！</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="48d2" class="lc is hu ky b fv ld le l lf lg">nr_periods 0<br/>nr_throttled 0<br/>throttled_time 0</span></pre><figure class="kt ku kv kw fq lj"><div class="bz el l di"><div class="mn mk l"/></div><figcaption class="lq lr fg fe ff ls lt bd b be z ek">No limits</figcaption></figure><h2 id="e659" class="lc is hu bd it lw lx ly ix lz ma mb jb ka mc md jf ke me mf jj ki mg mh jn mi dt translated">最后备注:</h2><p id="4dd9" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">我并不提倡运行无限马里奥，但我只是想展示获得一些过去很难收集的数据是多么容易，并对其进行微小的调整。</p><p id="ef8e" class="pw-post-body-paragraph jp jq hu jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hn dt translated">抱歉，gif文件太大了，我已经尽力了。</p></div></div>    
</body>
</html>