<html>
<head>
<title>Serverless App: AWS CloudTrail Log Analytics using Amazon Elasticsearch Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器应用:使用亚马逊Elasticsearch服务的AWS CloudTrail日志分析</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/serverless-app-aws-cloudtrail-log-analytics-using-amazon-elasticsearch-service-76ed8dfa064a?source=collection_archive---------15-----------------------#2018-02-12">https://medium.com/hackernoon/serverless-app-aws-cloudtrail-log-analytics-using-amazon-elasticsearch-service-76ed8dfa064a?source=collection_archive---------15-----------------------#2018-02-12</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/43dd7a5365d202b042d53b8979ca76ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WUmFwWBN1HC58xsqazZ79w.png"/></div></div></figure><p id="d9d3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在本文中，我将讨论如何使用<a class="ae ka" href="https://github.com/awslabs/serverless-application-model" rel="noopener ugc nofollow" target="_blank"> AWS无服务器应用程序模型</a> (SAM)构建一个<a class="ae ka" href="https://hackernoon.com/tagged/serverless" rel="noopener ugc nofollow" target="_blank">无服务器应用程序，以使用</a><a class="ae ka" href="https://aws.amazon.com/elasticsearch-service/" rel="noopener ugc nofollow" target="_blank">亚马逊弹性搜索服务</a>对AWS <a class="ae ka" href="https://aws.amazon.com/cloudtrail/" rel="noopener ugc nofollow" target="_blank"> CloudTrail </a>数据执行日志分析。<a class="ae ka" href="https://hackernoon.com/tagged/aws" rel="noopener ugc nofollow" target="_blank"> AWS </a>无服务器应用程序将使用Amazon Elasticsearch服务帮助您分析<a class="ae ka" href="https://hackernoon.com/tagged/aws" rel="noopener ugc nofollow" target="_blank"> AWS </a> CloudTrail日志。应用程序创建CloudTrail trail，将日志交付设置到它创建的s3 bucket，并在CloudTrail日志文件写入s3时配置SNS交付。该应用程序还<br/>创建了一个亚马逊Elasticsearch域，并创建了一个亚马逊Lambda函数，该函数由SNS消息触发，获取s3文件位置，从s3文件中读取内容，并将数据写入Elasticsearch进行分析。</p><p id="3f34" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">先来了解一下什么是AWS CloudTrail，Elasticsearch，亚马逊Elasticsearch服务，AWS Lambda，AWS SAM。</p><h2 id="96f6" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">什么是AWS CloudTrail？</h2><p id="e8f6" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt lb translated"><span class="l lc ld le bm lf lg lh li lj di"> A </span> WS CloudTrail是一项服务，可对您的AWS帐户进行治理、合规、运营审计和风险审计。使用CloudTrail，您可以记录、持续监控和保留与整个AWS基础架构中的操作相关的帐户活动。CloudTrail提供了您的AWS帐户活动的事件历史，包括通过AWS管理控制台、AWS SDKs、命令行<a class="ae ka" href="https://hackernoon.com/tagged/tools" rel="noopener ugc nofollow" target="_blank">工具</a>和其他AWS服务采取的操作。此事件历史简化了安全分析、资源更改跟踪和故障排除。</p><div class="lk ll fm fo lm ln"><a href="https://aws.amazon.com/cloudtrail/" rel="noopener  ugc nofollow" target="_blank"><div class="lo ab ej"><div class="lp ab lq cl cj lr"><h2 class="bd hv fv z el ls eo ep lt er et ht dt translated">AWS云迹</h2><div class="lu l"><h3 class="bd b fv z el ls eo ep lt er et ek translated">AWS CloudTrail允许您跟踪并自动响应威胁您的AWS安全的帐户活动…</h3></div><div class="lv l"><p class="bd b gc z el ls eo ep lt er et ek translated">aws.amazon.com</p></div></div><div class="lw l"><div class="lx l ly lz ma lw mb ja ln"/></div></div></a></div><h2 id="4f45" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">什么是Elasticsearch？</h2><p id="a562" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">Elasticsearch是一个分布式RESTful搜索和分析引擎，能够解决越来越多的用例。作为弹性堆栈的核心，它集中存储您的数据，因此您可以发现预期的数据，发现意外的数据。</p><div class="lk ll fm fo lm ln"><a href="https://www.elastic.co/products/elasticsearch" rel="noopener  ugc nofollow" target="_blank"><div class="lo ab ej"><div class="lp ab lq cl cj lr"><h2 class="bd hv fv z el ls eo ep lt er et ht dt translated">Elasticsearch: RESTful分布式搜索和分析</h2><div class="lu l"><h3 class="bd b fv z el ls eo ep lt er et ek translated">分布式开源搜索和分析引擎，旨在实现横向可扩展性、可靠性和易用性…</h3></div><div class="lv l"><p class="bd b gc z el ls eo ep lt er et ek translated">www.elastic.co</p></div></div><div class="lw l"><div class="mc l ly lz ma lw mb ja ln"/></div></div></a></div><h2 id="6159" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">什么是亚马逊Elasticsearch服务？</h2><p id="52da" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt lb translated"><span class="l lc ld le bm lf lg lh li lj di"/>mazon Elasticsearch服务使部署、保护、操作和扩展elastic search变得容易，可用于日志分析、全文搜索、应用程序监控等。Amazon Elasticsearch服务是一项完全托管的服务，提供Elasticsearch易于使用的API和实时分析功能，以及生产工作负载所需的可用性、可扩展性和安全性。</p><div class="lk ll fm fo lm ln"><a href="https://aws.amazon.com/elasticsearch-service/" rel="noopener  ugc nofollow" target="_blank"><div class="lo ab ej"><div class="lp ab lq cl cj lr"><h2 class="bd hv fv z el ls eo ep lt er et ht dt translated">亚马逊弹性搜索服务—亚马逊网络服务(AWS)</h2><div class="lu l"><h3 class="bd b fv z el ls eo ep lt er et ek translated">使用亚马逊Elasticsearch服务在AWS上轻松部署、操作和扩展Elasticsearch。启动您的亚马逊…</h3></div><div class="lv l"><p class="bd b gc z el ls eo ep lt er et ek translated">aws.amazon.com</p></div></div><div class="lw l"><div class="md l ly lz ma lw mb ja ln"/></div></div></a></div><h2 id="3662" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">什么是AWS Lambda？</h2><p id="3bcf" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt lb translated"><span class="l lc ld le bm lf lg lh li lj di">一个</span> WS Lambda让你无需提供或管理服务器就能运行代码。您只需为您消耗的计算时间付费，当您的代码不运行时，则不收费。有了Lambda，你可以为几乎任何类型的应用程序或后端服务运行代码——所有这些都无需管理。只需上传你的代码，Lambda就会为你的代码提供高可用性的运行和扩展。您可以将代码设置为从其他AWS服务自动触发，或者直接从任何web或移动应用程序调用它。</p><div class="lk ll fm fo lm ln"><a href="https://aws.amazon.com/lambda/" rel="noopener  ugc nofollow" target="_blank"><div class="lo ab ej"><div class="lp ab lq cl cj lr"><h2 class="bd hv fv z el ls eo ep lt er et ht dt translated">AWS Lambda —无服务器计算—亚马逊网络服务</h2><div class="lu l"><h3 class="bd b fv z el ls eo ep lt er et ek translated">AWS Lambda允许您在不提供或管理服务器的情况下运行代码。您只需为消耗的计算时间付费。</h3></div><div class="lv l"><p class="bd b gc z el ls eo ep lt er et ek translated">aws.amazon.com</p></div></div><div class="lw l"><div class="me l ly lz ma lw mb ja ln"/></div></div></a></div><h2 id="5bb5" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">什么是AWS无服务器应用模型？</h2><p id="7684" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">AWS无服务器应用程序模型(AWS SAM)规定了在AWS上表达无服务器应用程序的规则。AWS SAM的目标是为无服务器应用程序定义一个标准应用程序模型。</p><div class="lk ll fm fo lm ln"><a href="https://github.com/awslabs/serverless-application-model" rel="noopener  ugc nofollow" target="_blank"><div class="lo ab ej"><div class="lp ab lq cl cj lr"><h2 class="bd hv fv z el ls eo ep lt er et ht dt translated">awb lass/无服务器应用模型</h2><div class="lu l"><h3 class="bd b fv z el ls eo ep lt er et ek translated">无服务器应用程序模型— AWS无服务器应用程序模型(AWS SAM)规定了表达无服务器…</h3></div><div class="lv l"><p class="bd b gc z el ls eo ep lt er et ek translated">github.com</p></div></div><div class="lw l"><div class="mf l ly lz ma lw mb ja ln"/></div></div></a></div><p id="cacd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在让我们看看如何使用Amazon Elasticsearch服务构建一个无服务器应用程序来对AWS CloudTrail数据执行日志分析。</p><p id="ed48" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是CloudTrail日志分析无服务器应用程序的架构:</p><figure class="mh mi mj mk fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mg"><img src="../Images/bd526724418cda92b31a2e31f0560251.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dF8a4xzZuHydWjokM2Xpqw.png"/></div></div><figcaption class="ml mm fg fe ff mn mo bd b be z ek">Architecture for Serverless Application: CloudTrail Log Analytics using Elasticsearch</figcaption></figure><p id="dcb0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">AWS无服务器应用模型是一个AWS <a class="ae ka" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"> Cloudformation </a>模板。在我们查看SAM模板的代码之前，让我们先打包我们的AWS Lambda。</p><p id="41d6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在您的工作站上，创建一个用于构建无服务器应用程序的工作文件夹。</p><h2 id="3068" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">为AWS Lambda创建名为index.py的文件:</h2><pre class="mh mi mj mk fq mp mq mr ms aw mt dt"><span id="4024" class="kb kc hu mq b fv mu mv l mw mx">""" This module reads the SNS message to get the S3 file location for cloudtrail<br/> log and stores into Elasticsearch. """</span><span id="8cbf" class="kb kc hu mq b fv my mv l mw mx">from __future__ import print_function<br/>import json<br/>import boto3<br/>import logging<br/>import datetime<br/>import gzip<br/>import urllib<br/>import os<br/>import traceback</span><span id="47af" class="kb kc hu mq b fv my mv l mw mx">from StringIO import StringIO<br/>from exceptions import *</span><span id="0892" class="kb kc hu mq b fv my mv l mw mx"># from awses.connection import AWSConnection<br/>from elasticsearch import Elasticsearch, RequestsHttpConnection<br/>from requests_aws4auth import AWS4Auth<br/>                                <br/>logger = logging.getLogger()<br/>logger.setLevel(logging.INFO)</span><span id="fcf9" class="kb kc hu mq b fv my mv l mw mx">s3 = boto3.client('s3', region_name=os.environ['AWS_REGION'])</span><span id="3868" class="kb kc hu mq b fv my mv l mw mx">awsauth = AWS4Auth(os.environ['AWS_ACCESS_KEY_ID'], os.environ['AWS_SECRET_ACCESS_KEY'], os.environ['AWS_REGION'], 'es', session_token=os.environ['AWS_SESSION_TOKEN'])<br/>es = Elasticsearch(<br/>    hosts=[{'host': os.environ['es_host'], 'port': 443}],<br/>    http_auth=awsauth,<br/>    use_ssl=True,<br/>    verify_certs=True,<br/>    connection_class=RequestsHttpConnection<br/>)<br/>    <br/>def handler(event, context):<br/>    logger.info('Event: ' + json.dumps(event, indent=2))</span><span id="5bc0" class="kb kc hu mq b fv my mv l mw mx">    s3Bucket = json.loads(event['Records'][0]['Sns']['Message'])['s3Bucket'].encode('utf8')<br/>    s3ObjectKey = urllib.unquote_plus(json.loads(event['Records'][0]['Sns']['Message'])['s3ObjectKey'][0].encode('utf8'))</span><span id="d55c" class="kb kc hu mq b fv my mv l mw mx">    logger.info('S3 Bucket: ' + s3Bucket)<br/>    logger.info('S3 Object Key: ' + s3ObjectKey)</span><span id="8fc7" class="kb kc hu mq b fv my mv l mw mx">    try:<br/>        response = s3.get_object(Bucket=s3Bucket, Key=s3ObjectKey)<br/>        content = gzip.GzipFile(fileobj=StringIO(response['Body'].read())).read()</span><span id="a038" class="kb kc hu mq b fv my mv l mw mx">        for record in json.loads(content)['Records']:<br/>            recordJson = json.dumps(record)<br/>            logger.info(recordJson)<br/>            indexName = 'ct-' + datetime.datetime.now().strftime("%Y-%m-%d")<br/>            res = es.index(index=indexName, doc_type='record', id=record['eventID'], body=recordJson)<br/>            logger.info(res)<br/>        return True<br/>    except Exception as e:<br/>        logger.error('Something went wrong: ' + str(e))<br/>        traceback.print_exc()<br/>        return False</span></pre><h2 id="c8ea" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">创建一个名为所需python包要求的文件:</h2><pre class="mh mi mj mk fq mp mq mr ms aw mt dt"><span id="f54e" class="kb kc hu mq b fv mu mv l mw mx">elasticsearch&gt;=5.0.0,&lt;6.0.0<br/>requests-aws4auth</span></pre><p id="baee" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在您的工作区中创建了上述需求文件后，运行下面的命令来安装所需的包:</p><pre class="mh mi mj mk fq mp mq mr ms aw mt dt"><span id="ac12" class="kb kc hu mq b fv mu mv l mw mx">python -m pip install -r requirements.txt -t ./</span></pre><p id="d39e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">创建一个名为template.yaml的文件，用于存储AWS SAM的代码:</p><pre class="mh mi mj mk fq mp mq mr ms aw mt dt"><span id="173e" class="kb kc hu mq b fv mu mv l mw mx">AWSTemplateFormatVersion: '2010-09-09'<br/>Transform: 'AWS::Serverless-2016-10-31'<br/>Description: &gt;</span><span id="27cd" class="kb kc hu mq b fv my mv l mw mx">    This SAM example creates the following resources:</span><span id="bf9d" class="kb kc hu mq b fv my mv l mw mx">      S3 Bucket: S3 Bucket to hold the CloudTrail Logs<br/>      CloudTrail: Create CloudTrail trail for all regions and configures it to delivery logs to the above S3 Bucket<br/>      SNS Topic: Configure SNS topic to receive notifications when the CloudTrail log file is created in s3<br/>      Elasticsearch Domain: Create Elasticsearch Domain to hold the CloudTrail logs for advanced analytics<br/>      IAM Role: Create IAM Role for Lambda Execution and assigns Read Only S3 permission<br/>      Lambda Function:  Create Function which get's triggered when SNS receives notification, reads the contents from s3 and stores them in Elasticsearch Domain<br/>Outputs:</span><span id="bafc" class="kb kc hu mq b fv my mv l mw mx">    S3Bucket:<br/>      Description: "S3 Bucket Name where CloudTrail Logs are delivered"<br/>      Value: !Ref S3Bucket<br/>    LambdaFunction:<br/>      Description: "Lambda Function that reads CloudTrail logs and stores them into Elasticsearch Domain"<br/>      Value: !GetAtt Function.Arn<br/>    ElasticsearchUrl:<br/>      Description: "Elasticsearch Domain Endpoint that you can use to access the CloudTrail logs and analyze them"<br/>      Value: !GetAtt ElasticsearchDomain.DomainEndpoint<br/>Resources:<br/>  SNSTopic:<br/>    Type: AWS::SNS::Topic<br/>  SNSTopicPolicy: <br/>    Type: "AWS::SNS::TopicPolicy"<br/>    Properties: <br/>      Topics: <br/>        - Ref: "SNSTopic"<br/>      PolicyDocument: <br/>        Version: "2008-10-17"<br/>        Statement: <br/>          - <br/>            Sid: "AWSCloudTrailSNSPolicy"<br/>            Effect: "Allow"<br/>            Principal: <br/>              Service: "cloudtrail.amazonaws.com"<br/>            Resource: "*"<br/>            Action: "SNS:Publish"<br/>  S3Bucket:<br/>    Type: AWS::S3::Bucket<br/>  S3BucketPolicy: <br/>    Type: "AWS::S3::BucketPolicy"<br/>    Properties: <br/>      Bucket: <br/>        Ref: S3Bucket<br/>      PolicyDocument: <br/>        Version: "2012-10-17"<br/>        Statement: <br/>          - <br/>            Sid: "AWSCloudTrailAclCheck"<br/>            Effect: "Allow"<br/>            Principal: <br/>              Service: "cloudtrail.amazonaws.com"<br/>            Action: "s3:GetBucketAcl"<br/>            Resource: <br/>              !Sub |-<br/>                arn:aws:s3:::${S3Bucket}<br/>          - <br/>            Sid: "AWSCloudTrailWrite"<br/>            Effect: "Allow"<br/>            Principal: <br/>              Service: "cloudtrail.amazonaws.com"<br/>            Action: "s3:PutObject"<br/>            Resource:<br/>              !Sub |-<br/>                arn:aws:s3:::${S3Bucket}/AWSLogs/${AWS::AccountId}/*<br/>            Condition: <br/>              StringEquals:<br/>                s3:x-amz-acl: "bucket-owner-full-control"<br/>  CloudTrail:<br/>    Type: AWS::CloudTrail::Trail<br/>    DependsOn:<br/>      - SNSTopicPolicy<br/>      - S3BucketPolicy<br/>    Properties: <br/>        S3BucketName: <br/>          Ref: S3Bucket<br/>        SnsTopicName: <br/>          Fn::GetAtt: <br/>            - SNSTopic<br/>            - TopicName<br/>        IsLogging: true<br/>        EnableLogFileValidation: true<br/>        IncludeGlobalServiceEvents: true<br/>        IsMultiRegionTrail: true<br/>  FunctionIAMRole:<br/>    Type: "AWS::IAM::Role"<br/>    Properties:<br/>        Path: "/"<br/>        ManagedPolicyArns:<br/>            - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"<br/>            - "arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess"<br/>        AssumeRolePolicyDocument:<br/>          Version: "2012-10-17"<br/>          Statement:<br/>            -<br/>              Sid: "AllowLambdaServiceToAssumeRole"<br/>              Effect: "Allow"<br/>              Action: <br/>                - "sts:AssumeRole"<br/>              Principal:<br/>                Service: <br/>                  - "lambda.amazonaws.com"<br/>  ElasticsearchDomain: <br/>    Type: AWS::Elasticsearch::Domain<br/>    DependsOn:<br/>      - FunctionIAMRole<br/>    Properties:<br/>      DomainName: "cloudtrail-log-analytics"<br/>      ElasticsearchClusterConfig: <br/>        InstanceCount: "2"<br/>      EBSOptions: <br/>        EBSEnabled: true<br/>        Iops: 0<br/>        VolumeSize: 20<br/>        VolumeType: "gp2"<br/>      AccessPolicies: <br/>        Version: "2012-10-17"<br/>        Statement: <br/>          - <br/>            Sid: "AllowFunctionIAMRoleESHTTPFullAccess"<br/>            Effect: "Allow"<br/>            Principal: <br/>              AWS: !GetAtt FunctionIAMRole.Arn<br/>            Action: "es:ESHttp*"<br/>            Resource:<br/>              !Sub |-<br/>                arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/cloudtrail-log-analytics/*<br/>          - <br/>            Sid: "AllowFullAccesstoKibanaForEveryone"<br/>            Effect: "Allow"<br/>            Principal: <br/>              AWS: "*"<br/>            Action: "es:*"<br/>            Resource:<br/>              !Sub |-<br/>                arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/cloudtrail-log-analytics/_plugin/kibana<br/>      ElasticsearchVersion: "5.5"<br/>  Function:<br/>    Type: 'AWS::Serverless::Function'<br/>    DependsOn:<br/>      - ElasticsearchDomain<br/>      - FunctionIAMRole<br/>    Properties:<br/>      Handler: index.handler<br/>      Runtime: python2.7<br/>      CodeUri: ./<br/>      Role: !GetAtt FunctionIAMRole.Arn<br/>      Events:<br/>        SNSEvent:<br/>          Type: SNS<br/>          Properties:<br/>            Topic: !Ref SNSTopic<br/>      Environment:<br/>        Variables:<br/>          es_host:<br/>            Fn::GetAtt: <br/>              - ElasticsearchDomain<br/>              - DomainEndpoint</span></pre><h2 id="d1f7" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">打包工件并将它们上传到s3:</h2><p id="5558" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">运行下面的命令将您的工件上传到S3，并输出一个打包的模板，该模板可以很容易地部署到CloudFormation。</p><pre class="mh mi mj mk fq mp mq mr ms aw mt dt"><span id="7d30" class="kb kc hu mq b fv mu mv l mw mx">aws cloudformation package \<br/>    --template-file template.yaml \<br/>    --s3-bucket bucket-name \<br/>    --output-template-file serverless-output.yaml</span></pre><h2 id="2c3f" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">将此AWS SAM部署到AWS CloudFormation:</h2><p id="6f00" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">您可以使用<code class="eh mz na nb mq b">aws cloudformation deploy</code> CLI命令来部署SAM模板。在幕后，它创建并执行变更集，并等待部署完成。当部署失败时，它还会打印调试提示。运行以下命令，将打包的模板部署到名为<code class="eh mz na nb mq b">cloudtrail-log-analytics</code>的堆栈中:</p><pre class="mh mi mj mk fq mp mq mr ms aw mt dt"><span id="8fcf" class="kb kc hu mq b fv mu mv l mw mx">aws cloudformation deploy \<br/>    --template-file serverless-output.yaml \<br/>    --stack-name cloudtrail-log-analytics \<br/>    --capabilities CAPABILITY_IAM</span></pre><p id="39f2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">更多细节参见<a class="ae ka" href="http://docs.aws.amazon.com/cli/latest/reference/cloudformation/deploy/index.html" rel="noopener ugc nofollow" target="_blank">文件</a>。</p><blockquote class="nc nd ne"><p id="93d9" class="jc jd nf je b jf jg jh ji jj jk jl jm ng jo jp jq nh js jt ju ni jw jx jy jz hn dt translated">我建议使用<a class="ae ka" href="http://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-createupdatedomains.html#es-createdomain-configure-access-policies" rel="noopener ugc nofollow" target="_blank">文档</a>阅读关于Elasticsearch服务访问策略的内容，并修改Elasticsearch域的访问策略，以进一步微调访问策略。</p></blockquote><p id="8f44" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦在您的AWS帐户中部署了无服务器应用程序，一旦日志被发送到s3，它就会自动将AWS CloudTrail数据存储到Amazon Elasticsearch服务中。有了Elasticsearch中的数据，您可以使用Kibana来可视化Elasticsearch中的数据，并在AWS CloudTrail数据上创建您需要的仪表板。</p><p id="e991" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">上述无服务器应用模型应用可从以下Github repo获得:</p><div class="lk ll fm fo lm ln"><a href="https://github.com/ExpediaDotCom/cloudtrail-log-analytics" rel="noopener  ugc nofollow" target="_blank"><div class="lo ab ej"><div class="lp ab lq cl cj lr"><h2 class="bd hv fv z el ls eo ep lt er et ht dt translated">ExpediaDotCom/cloud trail-log-analytics</h2><div class="lu l"><h3 class="bd b fv z el ls eo ep lt er et ek translated">cloudtrail-log-analytics —使用Amazon Elasticsearch服务的cloudtrail日志分析— AWS无服务器应用程序</h3></div><div class="lv l"><p class="bd b gc z el ls eo ep lt er et ek translated">github.com</p></div></div><div class="lw l"><div class="nj l ly lz ma lw mb ja ln"/></div></div></a></div><figure class="mh mi mj mk fq iv"><div class="bz el l di"><div class="nk nl l"/></div></figure></div></div>    
</body>
</html>