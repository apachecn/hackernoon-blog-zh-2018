<html>
<head>
<title>Combining MongoDB Collections</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">组合MongoDB集合</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/combining-mongodb-collections-928f187333b5?source=collection_archive---------9-----------------------#2018-02-13">https://medium.com/hackernoon/combining-mongodb-collections-928f187333b5?source=collection_archive---------9-----------------------#2018-02-13</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/0b3d44c3596a8c6e8cb446966c00202b.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*_8TMjVKjSG8xFsfvSFouyA.png"/></div></div></figure><div class=""/><p id="628a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最近，我一直在使用几个月前创建的数据库。对于那个特定的项目，我为每组项目创建了一个单独的数据库集合。当时，我有一个书籍和文章的收藏，按主题分类，出于某种原因，我把所有的书籍和文章放在基于主题的单独收藏中。然后，我为每个主题创建了端点。这样，我可以切换出用户搜索的主题的url集合，如下所示:</p><figure class="kb kc kd ke fq hw fe ff paragraph-image"><div class="fe ff ka"><img src="../Images/929430e715f069ae27dd8d5b9a64b2a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*4iooYnTN_68c6IeAPN8vPA.png"/></div></figure><p id="fbb5" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这种情况下，用户搜索“如何穿上裤子”。但是有了一个主题为“如何穿上裤子”的集合，我现在可以只获取这4个结果，而不是获取整个库。我用来完成这项工作的另一个组件是word map对象。我不会在这里深入讨论，但是如果你感兴趣，你可以在这里查看:<a class="ae kf" href="https://hackernoon.com/creating-more-accurate-search-results-for-small-sites-436e64da79b6" rel="noopener ugc nofollow" target="_blank">https://hacker noon . com/creating-more-accurate-search-results-for-small-sites-436 e 64 da 79 b 6</a></p><p id="8aa7" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">虽然这很棒，但我最近想能够一次搜索所有的收藏，这对于这么多单独的收藏来说并不容易。基本上，我想把所有的收藏组合成一个单一的收藏。</p><p id="1880" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我首先做了一个fetch，它列出了数据库中的所有集合。我正在使用mlab，如果您正在使用mlab，方法如下:</p><pre class="kb kc kd ke fq kg kh ki kj aw kk dt"><span id="c79e" class="kl km if kh b fv kn ko l kp kq">To get the collections in the specified database:</span><span id="27f3" class="kl km if kh b fv kr ko l kp kq">GET /databases/{database}/collections<br/><br/>Example:<br/>https://api.mlab.com/api/1/databases/my-db/collections?apiKey=myAPIKey</span></pre><p id="802b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">因此，您在实现中的代码将如下所示:</p><pre class="kb kc kd ke fq kg kh ki kj aw kk dt"><span id="6599" class="kl km if kh b fv kn ko l kp kq">fetch('<!-- -->https://api.mlab.com/api/1/databases/my-db/collections?apiKey=myAPIKey<a class="ae kf" href="https://api.mlab.com/api/1/databases/presentation-maker/collections?&amp;l=41994&amp;apiKey=T_4ma8aw6AyAhVzAcfzCpxEKDJqxffrn').then(function(response)" rel="noopener ugc nofollow" target="_blank">').then(function(response)</a> {<br/>if (response.status != 200) {<br/>window.alert("Oopsie daisy");<br/>return ;<br/>}<br/>response.json().then(function(data) {<br/>let api = data;</span></pre><p id="7e02" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您在此时console.log您的api，您将得到一个数组，其中包含您的每一个集合名称，作为字符串。完美。现在我要做一个for循环，遍历这些集合名称，做基本上和我在顶部做的一样的事情，在每个循环迭代中获取，并用当前api数组项替换获取集合名称。</p><pre class="kb kc kd ke fq kg kh ki kj aw kk dt"><span id="a2e4" class="kl km if kh b fv kn ko l kp kq">let arr = [];<br/>for (var i = 0; i &lt; api.length; i++) {<br/>  fetch('<!-- -->https://api.mlab.com/api/1/databases/my-db/collections/api[i]?apiKey=myAPIKey<a class="ae kf" href="https://api.mlab.com/api/1/databases/presentation-maker/collections/'+urlArr[i]+'?&amp;l=41994&amp;apiKey=T_4ma8aw6AyAhVzAcfzCpxEKDJqxffrn').then(function(response)" rel="noopener ugc nofollow" target="_blank">').then(function(response)</a> {<br/>  if (response.status != 200) {<br/>  window.alert("dag nabbit");<br/>  return ;<br/>  }<br/>  response.json().then(function(data) {<br/>  let test = data;<br/>  for (var k = 0; k &lt; test.length; k++) {<br/>    arr.push(test[k])<br/>  }<br/>});<br/>});<br/>}</span></pre><p id="cd74" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这里，我们在获取url (my-db)中有我们的数据库名称，并且在每个循环中，我们的集合名称会发生变化(api[i])。我们从那里获取数据，并将数据保存为“test”。然后，我们有一个嵌套循环，在这里我们循环通过test，并将每个数组项推入我们的数组arr。</p><p id="2023" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，如果我们console . log“arr ”,我们应该在一个地方有一个集合的整合数组，而不是在多个集合中。</p><p id="e323" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，我们需要将所有数据重新格式化为一个新的JSON对象数组。</p><pre class="kb kc kd ke fq kg kh ki kj aw kk dt"><span id="b54b" class="kl km if kh b fv kn ko l kp kq">setTimeout(function(){<br/>for (var i = 0; i &lt; arr.length; i++) {<br/>    let text = arr[i].article_text;<br/>    let text2 = text.replace(/"/g, "");<br/>    let text3 = text2.replace(/'/g, "");<br/>  arr[i] = `<br/>  &lt;p&gt;{"articleAuthor": "${arr[i].article_author}",<br/>  "articleAuthorTitle": "${arr[i].article_author_title}",<br/>  "articleName": "${arr[i].article_name}",<br/>  "articleDate": "${arr[i].article_date}",<br/>  "articleText": "${text3}"}&lt;/p&gt;<br/>  `;<br/>  document.getElementById('verseText').innerHTML += arr[i];<br/>}<br/>}, 50000);</span></pre><p id="a107" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我在这里使用了一个set timeout函数，允许前面步骤中的所有获取操作完成。否则，我可能会在获取完成之前就开始构建JSON数据。我遍历数组“arr”中包含的数据，用花括号将key:value对放在一个段落中，然后在DOM中呈现每个对象。然后，我将输出复制并粘贴到一个json文件中。只要没有错误，我就可以走了。此时，我可以使用mlabs保存文件，然后使用命令行提示符将其导出到mlabs集合:</p><pre class="kb kc kd ke fq kg kh ki kj aw kk dt"><span id="8da4" class="kl km if kh b fv kn ko l kp kq">mongoexport -h ds#####.mlab.com:#### -d &lt;database name&gt; -c &lt;collection name&gt; -u &lt;user&gt; -p &lt;password&gt; -o filename.json</span></pre><p id="3c96" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们结束了。现在，我可以从一个单独的数据库中访问我的所有数据，但我没有用单独的集合改变原始结构，以防我以后还想使用那种格式。</p><p id="54b0" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，在你评论说这个方法有多蠢之前，别担心，我知道。但是，如果你像我一样，更喜欢前端，这是一个可行的方法。我不是说这是最好的，但这是一种方法，而且很有效。</p></div></div>    
</body>
</html>