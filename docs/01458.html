<html>
<head>
<title>Get on the Good Foot with MicroPython, Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MicroPython获得良好的开端，第2部分</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/get-on-the-good-foot-with-micropython-part-2-e1f2efaad50b?source=collection_archive---------4-----------------------#2018-02-15">https://medium.com/hackernoon/get-on-the-good-foot-with-micropython-part-2-e1f2efaad50b?source=collection_archive---------4-----------------------#2018-02-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/33bc6d0dc47bc267e1af0d7e418e4256.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c3-mjgxnLu6XhmTl2Ojdtw.jpeg"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Photo by <a class="ae ih" href="https://www.flickr.com/photos/jhoc/" rel="noopener ugc nofollow" target="_blank">Jeremy Hockin</a></figcaption></figure><div class=""/><p id="453a" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><a class="ae ih" href="https://hackernoon.com/get-on-the-good-foot-with-micropython-on-the-esp32-decdd32c4720" rel="noopener ugc nofollow" target="_blank">在这个折磨人的教程的第一部分</a>中，我教读者如何在基于ESP32的开发板上开始使用<a class="ae ih" href="https://hackernoon.com/tagged/micropython" rel="noopener ugc nofollow" target="_blank"> MicroPython </a>。我们:</p><ol class=""><li id="c3f8" class="kf kg ik jj b jk jl jo jp js kh jw ki ka kj ke kk kl km kn dt translated">闪了一下黑板</li><li id="2f2c" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">在REPL嬉戏</li><li id="c0bb" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">已配置的WiFi</li><li id="b8c3" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">上传的脚本</li><li id="c80c" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">使用DS18B20单线温度传感器构建电路</li><li id="90d6" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">使用MicroPython读取温度</li></ol><p id="6045" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在教程的<em class="kt">这一</em>部分，我们将利用传感器收集数据，并通过<a class="ae ih" href="https://hackernoon.com/tagged/mqtt" rel="noopener ugc nofollow" target="_blank"> MQTT </a>发布。</p><p id="0cce" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果您对这个概念不熟悉，我将尝试简单地解释MQTT。</p><h1 id="4048" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">简单地说，MQTT</h1><p id="5e4a" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated"><a class="ae ih" href="https://en.wikipedia.org/wiki/MQTT" rel="noopener ugc nofollow" target="_blank"> MQTT </a>是一个用于发布和订阅消息的机器对机器<em class="kt">协议</em>。重要的是，MQTT对这些消息的内容和结构都没有限制。</p><p id="d5e6" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在典型的设置中，您有一个MQTT <em class="kt">代理</em>和一个或多个MQTT <em class="kt">客户机</em>。客户端可以发布消息、订阅消息或两者兼而有之。客户端不必是物联网设备、web应用、桌面或移动应用、微服务或任何特定的东西，只要它能说MQTT。</p><p id="c66e" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">所有客户端都连接到代理。代理负责接收发布的消息，并(可能)将它们传递给感兴趣的客户。</p><p id="e6f9" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">每条消息都有一个“主题”。对于发布/订阅模式来说至关重要的是，消息的发布者<em class="kt">不一定关心</em>是否有人在监听。感兴趣的客户将<em class="kt">订阅</em>这个话题。</p><h1 id="7d81" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">MQTT示例</h1><p id="3e72" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">您有一个MQTT客户机——可能是一个带有温度传感器的设备——叫做<code class="eh lx ly lz ma b">bob</code>,它想要发布温度数据。它可以发布诸如<code class="eh lx ly lz ma b">bob/sensor/temperature</code>的主题，并且消息将是数据，例如<code class="eh lx ly lz ma b">68.75</code>。</p><p id="33cc" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">另一个MQTT客户机<code class="eh lx ly lz ma b">ray</code>可能想要监听温度数据，这样我们就可以在仪表板上将它显示为时间序列图；<code class="eh lx ly lz ma b">ray</code>会告诉经纪人它希望订阅<code class="eh lx ly lz ma b">bob/sensor/temperature</code>主题。最后，当<code class="eh lx ly lz ma b">bob</code>发布这个话题时，代理通知<code class="eh lx ly lz ma b">ray</code>，然后<code class="eh lx ly lz ma b">ray</code>收到消息。然后可以对其数据做任何需要做的事情。</p><h1 id="c675" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">通配符</h1><p id="399c" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">订阅支持<em class="kt">通配符</em>。如果客户端<code class="eh lx ly lz ma b">bob</code>有另一个报告相对湿度的传感器，它可以在主题<code class="eh lx ly lz ma b">bob/sensor/humidity</code>下发布该数据。客户端<code class="eh lx ly lz ma b">ray</code>可以使用一个<em class="kt">单级通配符</em>，比如<code class="eh lx ly lz ma b">bob/sensor/+</code>，它将接收在<code class="eh lx ly lz ma b">bob/sensor/humidity</code> <em class="kt">和</em> <code class="eh lx ly lz ma b">bob/sensor/temperature</code>发布的消息。或者可能是一个<em class="kt">多级通配符</em>，比如<code class="eh lx ly lz ma b">bob/#</code>，它将订阅<em class="kt">任何以<code class="eh lx ly lz ma b">bob/</code>开头的</em>主题。</p><blockquote class="mb mc md"><p id="63ba" class="jh ji kt jj b jk jl jm jn jo jp jq jr me jt ju jv mf jx jy jz mg kb kc kd ke hn dt translated">对于我们的例子来说,“每个客户一个主题”仅仅是一个约定。MQTT没有强制这样的约束。</p></blockquote><p id="16ff" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">当然，除了以上这些，还有更多——但这是事实，我称之为好。</p><figure class="mi mj mk ml fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mh"><img src="../Images/f5d3d043ce0b0a996f94b0dab03bbe59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sMLo36hz8QQEVS2R."/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Photo by <a class="ae ih" href="https://unsplash.com/@cmart10?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit" rel="noopener ugc nofollow" target="_blank">Caleb Martin</a> / <a class="ae ih" href="https://unsplash.com/?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="c69f" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">为什么选择MQTT？</h1><p id="4197" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">理解<em class="kt">为什么</em>你想要使用一种技术而不是另一种(或者根本不使用)同样重要。</p><p id="bc27" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">MQTT的设计者考虑的是资源受限的设备(比如传感器)；这是一个“瘦”协议，比HTTP更容易实现。因此，你会发现MQTT是许多基于云的“物联网平台”背后的核心技术，包括<a class="ae ih" href="https://internetofthings.ibmcloud.com/#/" rel="noopener ugc nofollow" target="_blank"> IBM </a>、<a class="ae ih" href="https://aws.amazon.com/iot/" rel="noopener ugc nofollow" target="_blank">亚马逊</a>、<a class="ae ih" href="https://azure.microsoft.com/en-us/services/iot-hub/" rel="noopener ugc nofollow" target="_blank">微软</a>、<a class="ae ih" href="https://io.adafruit.com/" rel="noopener ugc nofollow" target="_blank"> Adafruit </a>以及许多其他产品。</p><p id="4695" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">你<em class="kt">可以</em>通过<a class="ae ih" href="https://en.wikipedia.org/wiki/Representational_state_transfer" rel="noopener ugc nofollow" target="_blank">RESTful</a>API直接访问这些服务，但是这样做必然会消耗更多的设备资源。</p><blockquote class="mb mc md"><p id="2222" class="jh ji kt jj b jk jl jm jn jo jp jq jr me jt ju jv mf jx jy jz mg kb kc kd ke hn dt translated">如果您需要进行<a class="ae ih" href="https://en.wikipedia.org/wiki/Remote_procedure_call" rel="noopener ugc nofollow" target="_blank">远程过程调用</a>，或者如果<a class="ae ih" href="https://en.wikipedia.org/wiki/Request%E2%80%93response" rel="noopener ugc nofollow" target="_blank">请求/响应</a>模型在您的问题域中比MQTT的发布/订阅模型更自然，那么使用HTTP(S)代替MQTT是有意义的。即便如此，像CoAP这样的协议也需要更少的资源。</p></blockquote><p id="e376" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在我们已经了解了MQTT的全部(或者更准确地说，“部分”)内容，让我们用它来传播我们的环境温度。</p><h1 id="7387" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">引导脚本和温度模块</h1><p id="33b3" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">我们将使用上一篇教程中的代码开始。作为参考，我将在下面展示它们。</p><p id="d2d1" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您应该有两(2)个文件，第一个是我们的启动脚本，<code class="eh lx ly lz ma b">boot.py</code>:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="16dd" class="mq kv ik ma b fv mr ms l mt mu">def connect():<br/>    import network<br/>    sta_if = network.WLAN(network.STA_IF)<br/>    if not sta_if.isconnected():<br/>        print('connecting to network...')<br/>        sta_if.active(True)<br/>        sta_if.connect('&lt;YOUR SSID&gt;', '&lt;YOUR PASSWORD&gt;')<br/>        while not sta_if.isconnected():<br/>            pass<br/>    print('network config:', sta_if.ifconfig())</span><span id="1c5a" class="mq kv ik ma b fv mv ms l mt mu">def no_debug():<br/>    import esp<br/>    # you can run this from the REPL as well<br/>    esp.osdebug(None)</span><span id="962d" class="mq kv ik ma b fv mv ms l mt mu">no_debug()<br/>connect()</span></pre><p id="e9fb" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">第二个是<code class="eh lx ly lz ma b">temperature.py</code>，围绕温度传感器的抽象概念:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="3f5e" class="mq kv ik ma b fv mr ms l mt mu">import time<br/>from machine import Pin<br/>from onewire import OneWire<br/>from ds18x20 import DS18X20<br/></span><span id="20ea" class="mq kv ik ma b fv mv ms l mt mu">class TemperatureSensor:<br/>    """<br/>    Represents a Temperature sensor<br/>    """<br/>    def __init__(self, pin):<br/>        """<br/>        Finds address of single DS18B20 on bus specified by `pin`<br/>        :param pin: 1-Wire bus pin<br/>        :type pin: int<br/>        """<br/>        self.ds = DS18X20(OneWire(Pin(pin)))<br/>        addrs = self.ds.scan()<br/>        if not addrs:<br/>            raise Exception('no DS18B20 found at bus on pin %d' <br/>                             % pin)<br/>        # save what should be the only address found<br/>        self.addr = addrs.pop()</span><span id="d51f" class="mq kv ik ma b fv mv ms l mt mu">    def read_temp(self, fahrenheit=True):<br/>        """<br/>        Reads temperature from a single DS18X20<br/>        :param fahrenheit: Whether or not to return value in<br/>                           Fahrenheit<br/>        :type fahrenheit: bool<br/>        :return: Temperature<br/>        :rtype: float<br/>        """</span><span id="d052" class="mq kv ik ma b fv mv ms l mt mu">        self.ds.convert_temp()<br/>        time.sleep_ms(750)<br/>        temp = self.ds.read_temp(self.addr)<br/>        if fahrenheit:<br/>            return self.c_to_f(temp)<br/>        return temp</span><span id="d7fa" class="mq kv ik ma b fv mv ms l mt mu">    @staticmethod<br/>    def c_to_f(c):<br/>        """<br/>        Converts Celsius to Fahrenheit<br/>        :param c: Temperature in Celsius<br/>        :type c: float<br/>        :return: Temperature in Fahrenheit<br/>        :rtype: float<br/>        """<br/>        return (c * 1.8) + 32</span></pre><p id="b1f9" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">通过<code class="eh lx ly lz ma b">ampy</code>上传这两个文件:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="60bb" class="mq kv ik ma b fv mr ms l mt mu">$ ampy --port /dev/tty.SLAB_USBtoUART put boot.py &amp;&amp; \<br/>  ampy --port /dev/tty.SLAB_USBtoUART put temperature.py</span></pre><p id="2be3" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">(用您的设备路径或COM端口替换<code class="eh lx ly lz ma b">/dev/tty.SLAB_USBtoUART</code>。)</p><p id="b336" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在本教程的第一部分，我告诉你下载(或克隆)micropython-lib项目。这个没必要！请继续阅读。</p><h1 id="e91e" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">通过<code class="eh lx ly lz ma b">upip</code>安装MQTT模块</h1><p id="5676" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">既然你的设备应该在线，我们可以使用REPL的<code class="eh lx ly lz ma b">upip</code>。<code class="eh lx ly lz ma b">upip</code>是一个精简的MicroPython包管理器。它内置在MicroPython的ESP32端口中；你已经有了。它从<a class="ae ih" href="https://pypi.org/" rel="noopener ugc nofollow" target="_blank"> PyPi </a>下载包，就像<code class="eh lx ly lz ma b">pip</code>一样。</p><p id="70aa" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">打开你的REPL，执行:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="0aab" class="mq kv ik ma b fv mr ms l mt mu">import upip<br/>upip.install('micropython-umqtt.robust')</span></pre><p id="1694" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">样本输出:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="64f8" class="mq kv ik ma b fv mr ms l mt mu">Installing to: /lib/<br/>Warning: pypi.python.org SSL certificate is not validated<br/>Installing micropython-umqtt.robust 1.0 from <a class="ae ih" href="https://pypi.python.org/packages/31/02/7268a19a5054cff8ff4cbbb126f00f098848dbe8f402caf083295a3a6a11/micropython-umqtt.robust-1.0.tar.gz" rel="noopener ugc nofollow" target="_blank">https://pypi.python.org/packages/31/02/7268a19a5054cff8ff4cbbb126f00f098848dbe8f402caf083295a3a6a11/micropython-umqtt.robust-1.0.tar.gz</a></span></pre><blockquote class="mb mc md"><p id="a744" class="jh ji kt jj b jk jl jm jn jo jp jq jr me jt ju jv mf jx jy jz mg kb kc kd ke hn dt translated">请注意:如果您的设备不在线，<code class="eh lx ly lz ma b">upip</code>将无法从设备的REPL工作。</p></blockquote><p id="6742" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">你还需要抓住它的依赖关系，<code class="eh lx ly lz ma b">micropython-umqtt.simple</code>:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="bbf1" class="mq kv ik ma b fv mr ms l mt mu">upip.install('micropython-umqtt.robust')</span></pre><p id="672b" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">样本输出:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="0b00" class="mq kv ik ma b fv mr ms l mt mu">Installing to: /lib/<br/>Installing micropython-umqtt.simple 1.3.4 from <a class="ae ih" href="https://pypi.python.org/packages/bd/cf/697e3418b2f44222b3e848078b1e33ee76aedca9b6c2430ca1b1aec1ce1d/micropython-umqtt.simple-1.3.4.tar.gz" rel="noopener ugc nofollow" target="_blank">https://pypi.python.org/packages/bd/cf/697e3418b2f44222b3e848078b1e33ee76aedca9b6c2430ca1b1aec1ce1d/micropython-umqtt.simple-1.3.4.tar.gz</a></span></pre><blockquote class="mb mc md"><p id="41cf" class="jh ji kt jj b jk jl jm jn jo jp jq jr me jt ju jv mf jx jy jz mg kb kc kd ke hn dt translated"><code class="eh lx ly lz ma b">umqtt.simple</code>是一个准系统MQTT客户机。<code class="eh lx ly lz ma b">umqtt.robust</code>依赖<code class="eh lx ly lz ma b">umqtt.simple</code>；这是一个MQTT客户机，如果发生连接断开，它会自动重新连接到代理。</p></blockquote><p id="2ac5" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">要验证安装是否正确，您可以从您的REPL执行:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="2576" class="mq kv ik ma b fv mr ms l mt mu">from umqtt.robust import MQTTClient</span></pre><p id="27ae" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">没有错误？你很棒。</p><h1 id="5c07" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">获取MQTT客户端应用程序</h1><p id="7855" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">在我们开始下一节之前，您可能希望手边有另一个应用程序——一个独立的MQTT客户机。你可以试试:</p><ul class=""><li id="4959" class="kf kg ik jj b jk jl jo jp js kh jw ki ka kj ke mw kl km kn dt translated"><a class="ae ih" href="http://mqttfx.org/" rel="noopener ugc nofollow" target="_blank">mqtt . FX</a>(GUI；Windows/Mac)</li><li id="a623" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke mw kl km kn dt translated"><a class="ae ih" href="http://workswithweb.com/mqttbox.html" rel="noopener ugc nofollow" target="_blank">MQTTBox</a>(GUI；Windows/Mac/Linux)</li><li id="7faf" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke mw kl km kn dt translated"><code class="eh lx ly lz ma b">mosquitto-clients</code>从<a class="ae ih" href="https://mosquitto.org/" rel="noopener ugc nofollow" target="_blank">mosquitt到</a>可通过软件包管理器(CLILinux/Mac)</li><li id="e824" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke mw kl km kn dt translated">应用商店(iOS/Android)上的各种免费客户端</li><li id="f24f" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke mw kl km kn dt translated"><a class="ae ih" href="https://nodered.org/" rel="noopener ugc nofollow" target="_blank"> Node-RED </a>也可以连接到MQTT代理(WebWindows/Mac/Linux)</li></ul><p id="b9de" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">严格来说，使用一个并不是必要的，但是会有助于实验。</p><h1 id="6fdf" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">在REPL做实验</h1><p id="afe7" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">如果你一直在仔细阅读，你会明白我们需要一个MQTT <em class="kt">代理</em>(“服务器”)；没有代理的MQTT客户机是没有用的。</p><p id="5f67" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">恰好<em class="kt"> public </em> MQTT经纪人存在；Mosquitto项目就是这样一个经纪人。作为大众的一员，可以用！请注意:<strong class="jj il">您在公共MQTT代理上发布的任何数据或信息也是<em class="kt">公共的</em></strong>。不要发表任何你不想让所有人都知道的东西。</p><p id="59cf" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">出于本教程的目的，我们将使用这个公共代理，但是如果您希望使用不同的代理，您可以继续这样做。</p><p id="cddb" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在，让我们尝试使用MQTT库在代理上发布消息。</p><h1 id="ae9c" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">创建唯一的“客户ID”</h1><p id="9e2b" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">关于MQTT有一点需要注意:每个连接到代理的MQTT客户机必须有一个惟一的标识符:一个<em class="kt">客户机ID </em>。你需要选择一个短语或生成一些东西。我将在命令行中生成一个:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="21b7" class="mq kv ik ma b fv mr ms l mt mu">$ python3 -c 'from uuid import uuid4; print(uuid4())'<br/>52dc166c-2de7-43c1-88ff-f80211c7a8f6</span></pre><p id="25d8" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">将结果值复制到剪贴板；你马上就会需要它。</p><h1 id="46d0" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">连接到REPL</h1><p id="6079" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">打开到您的ESP32的串行连接。这里我要用<code class="eh lx ly lz ma b">miniterm</code>，Python 3捆绑了哪些:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="e9ee" class="mq kv ik ma b fv mr ms l mt mu">$ python3 -m serial.tools.miniterm --raw /dev/tty.SLAB_USBtoUART 115200</span></pre><p id="3988" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><code class="eh lx ly lz ma b">--raw</code>标志避免了特殊字符如<code class="eh lx ly lz ma b">BS</code>和<code class="eh lx ly lz ma b">DEL</code>的问题。</p><h1 id="f8f8" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">连接到代理</h1><blockquote class="mb mc md"><p id="1bb2" class="jh ji kt jj b jk jl jm jn jo jp jq jr me jt ju jv mf jx jy jz mg kb kc kd ke hn dt translated">和第一个教程一样，在使用REPL时，我将省略提示(<code class="eh lx ly lz ma b">&gt;&gt;&gt;</code>)。</p></blockquote><p id="9677" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们现在应该能够导入<code class="eh lx ly lz ma b">MQTTClient</code>:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="557c" class="mq kv ik ma b fv mr ms l mt mu">from umqtt.simple import MQTTClient</span></pre><p id="733f" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><code class="eh lx ly lz ma b">MQTTClient</code>构造函数接受MQTT代理的客户机ID和DNS或IP地址。我们将使用上面的伪随机客户端ID，并将<code class="eh lx ly lz ma b">test.mosquitto.org</code>用于服务器，然后调用<code class="eh lx ly lz ma b">connect()</code>:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="0dc4" class="mq kv ik ma b fv mr ms l mt mu">client = MQTTClient('52dc166c-2de7-43c1-88ff-f80211c7a8f6', <br/>		'test.mosquitto.org')<br/>client.connect()</span></pre><p id="53ad" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果一切顺利，这个命令的输出应该是<code class="eh lx ly lz ma b">0</code>；<code class="eh lx ly lz ma b">connect()</code>如果连接失败，将引发异常。</p><h1 id="1d7b" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">连接第二台客户机</h1><p id="9558" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">至此，我要火起来<a class="ae ih" href="http://mqttfx.org/" rel="noopener ugc nofollow" target="_blank">mqtt . FX</a>；我将用它来订阅ESP32发布的消息。</p><p id="15d7" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我在服务器输入字段中输入server <code class="eh lx ly lz ma b">test.mosquitto.org</code>，并保留端口字段<code class="eh lx ly lz ma b">1883</code>，这是默认的(不安全的)MQTT端口。然后我点击“连接”，等待协商。这是我连接的客户端的屏幕截图:</p><figure class="mi mj mk ml fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mx"><img src="../Images/550c2eacaf5a01ccfbd736c91f914366.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-wqqHMfYhW-hm4QM.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">MQTT.fx connected to <code class="eh lx ly lz ma b">test.mosquitto.org</code>.</figcaption></figure><p id="aafe" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在我们学会从REPL发布之后，我将回到MQTT.fx。</p><h1 id="5220" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">发布MQTT消息</h1><p id="e45d" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">假设ESP32现在已经连接到代理，您就可以发布消息了。首先，我将发射一个华氏温度，题目是<code class="eh lx ly lz ma b">boneskull/test/temperature/fahrenheit</code>:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="e4ef" class="mq kv ik ma b fv mr ms l mt mu">client.publish('boneskull/test/temperature/fahrenheit', 72)</span></pre><p id="48f9" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">…但是MicroPython抱怨道:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="4019" class="mq kv ik ma b fv mr ms l mt mu">Traceback (most recent call last):<br/>  File "&lt;stdin&gt;", line 1, in &lt;module&gt;<br/>  File "umqtt/simple.py", line 112, in publish<br/>TypeError: object of type 'int' has no len()</span></pre><p id="107c" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这里有什么问题？让我解释一下:</p><ol class=""><li id="23b0" class="kf kg ik jj b jk jl jo jp js kh jw ki ka kj ke kk kl km kn dt translated">MQTT消息负载可以是<em class="kt">字面上的任何数据。MQTT没有“数据类型”的概念。它不知道什么是“数”或“整数”。您的有效负载将总是由<em class="kt">原始字节</em>组成。</em></li><li id="4c27" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">没有整数到“字节”的直接映射，因为没有<em class="kt">只有一种方式</em>将这个数字编码为二进制数据。我们不知道这是一个<em class="kt">有符号的</em>还是<em class="kt">无符号的</em>整数，应该用多少位等等。</li><li id="5c91" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">这个问题本来是显而易见的(我们可以使用RTFM)，但是由于资源限制，MicroPython避开了过于“友好”的API，所以这里发生了什么并不明显。</li></ol><p id="0e68" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最简单的解决方法？改为发布一个<code class="eh lx ly lz ma b">str</code>:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="d808" class="mq kv ik ma b fv mr ms l mt mu">client.publish('boneskull/test/temperature/fahrenheit', '72')</span></pre><p id="dfdc" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果这样做了，语句应该没有输出。</p><p id="67e9" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">万岁。我不相信——你相信吗？这只是把温度喷到了以太里！我们应该<em class="kt">看看</em>这些消息将走向何方。我可以在我的MQTT.fx客户端上通过<em class="kt">订阅</em>这个主题来实现。这是怎么回事:</p><figure class="mi mj mk ml fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mx"><img src="../Images/c4e84ec97044ac9af5d16c227d558975.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AXav4C2mPcTGWvWK.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Subscribing to a topic in MQTT.fx</figcaption></figure><ol class=""><li id="5fe7" class="kf kg ik jj b jk jl jo jp js kh jw ki ka kj ke kk kl km kn dt translated">点击“订阅”选项卡</li><li id="c689" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">在输入框中输入<code class="eh lx ly lz ma b">boneskull/test/temperature/fahrenheit</code></li><li id="278e" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">点击输入字段右侧的“订阅”按钮</li></ol><p id="6e39" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">完成此操作后，MQTT.fx将联系代理，如果成功，您将看到订阅出现在输入字段下方:</p><figure class="mi mj mk ml fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mx"><img src="../Images/607a950adcf61530017e115ad19d1186.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TAa48v7FIARJ31zq.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">An active subscription in MQTT.fx</figcaption></figure><p id="38ee" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">下次我们(或任何附属于代理的客户)发布这个主题时，我们会在这个窗口的右下区域看到它，它是灰色的，是空的。</p><p id="8e88" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">返回到您的串行终端，再次运行最后一个命令(您可以点击“向上箭头”，然后“回车”):</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="f370" class="mq kv ik ma b fv mr ms l mt mu">client.publish('boneskull/test/temperature/fahrenheit', '72')</span></pre><p id="f8d0" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">切换回MQTT.fx。根据代理的繁忙程度，这可能需要几秒钟的时间，但是现在消息应该出现在右侧，同时显示其有效负载:</p><figure class="mi mj mk ml fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mx"><img src="../Images/0eb7a22c35be1837597fa1b4ea0ce24e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Is0XlTV7dJPXak_W.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">A received message in MQTT.fx</figcaption></figure><p id="d9e4" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">干得好！</p><p id="d160" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在我们可以利用我们所学的一切，定期发布<em class="kt">真实的</em>温度数据。让我们设计一个小模块来做这件事。</p><h1 id="a5d0" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">发布温度的模块</h1><p id="4971" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">我写了一个小模块，它使用<code class="eh lx ly lz ma b">MQTTClient</code>和<code class="eh lx ly lz ma b">TemperatureSensor</code>(来自我们的第一个教程)来发布温度数据。</p><p id="9588" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">创建<code class="eh lx ly lz ma b">temperature_client.py</code>:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="41be" class="mq kv ik ma b fv mr ms l mt mu">import time</span><span id="27ba" class="mq kv ik ma b fv mv ms l mt mu">from umqtt.robust import MQTTClient</span><span id="54e7" class="mq kv ik ma b fv mv ms l mt mu">from temperature import TemperatureSensor<br/></span><span id="4917" class="mq kv ik ma b fv mv ms l mt mu">class TemperatureClient:<br/>    """<br/>    Represents an MQTT client which publishes temperature data on an<br/>    interval<br/>    """</span><span id="1955" class="mq kv ik ma b fv mv ms l mt mu">    def __init__(self, client_id, server, pin, fahrenheit=True, <br/>                 topic=None, **kwargs):<br/>        """<br/>        Instantiates a TemperatureSensor and MQTTClient; connects<br/>        to the MQTT broker.<br/>        Arguments `server` and `client_id` are required.</span><span id="dad4" class="mq kv ik ma b fv mv ms l mt mu">        :param client_id: Unique MQTT client ID<br/>        :type client_id: str<br/>        :param server: MQTT broker domain name / IP<br/>        :type server: str<br/>        :param pin: 1-Wire bus pin<br/>        :type pin: int<br/>        :param fahrenheit: Whether or not to publish temperature <br/>                           in Fahrenheit<br/>        :type fahrenheit: bool<br/>        :param topic: Topic to publish temperature on<br/>        :type topic: str<br/>        :param kwargs: Arguments for MQTTClient constructor<br/>        """<br/>        self.sensor = TemperatureSensor(pin)<br/>        self.client = MQTTClient(client_id, server, **kwargs)<br/>        if not topic:<br/>            self.topic = 'devices/%s/temperature/degrees' % \<br/>                         self.client.client_id<br/>        else:<br/>            self.topic = topic<br/>        self.fahrenheit = bool(fahrenheit)</span><span id="57f3" class="mq kv ik ma b fv mv ms l mt mu">        self.client.connect()</span><span id="cf0e" class="mq kv ik ma b fv mv ms l mt mu">    def publishTemperature(self):<br/>        """<br/>        Reads the current temperature and publishes it on the <br/>        configured topic.<br/>        """<br/>        t = self.sensor.read_temp(self.fahrenheit)<br/>        self.client.publish(self.topic, str(t))</span><span id="ddc3" class="mq kv ik ma b fv mv ms l mt mu">    def start(self, interval=60):<br/>        """<br/>        Begins to publish temperature data on an interval (in <br/>        seconds). This function will not exit! Consider using deep <br/>        sleep instead.        <br/>        :param interval: How often to publish temperature data (60s <br/>                         default)<br/>        :type interval: int<br/>        """<br/>        while True:<br/>            self.publishTemperature()<br/>            time.sleep(interval)</span></pre><p id="588e" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">将此上传到您的论坛:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="1568" class="mq kv ik ma b fv mr ms l mt mu">$ ampy --port /dev/tty.SLAB_USBtoUART put temperature_client.py</span></pre><p id="8941" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您的独立MQTT客户端应用程序应该仍然在线。让我们在REPL中发送一条消息，然后在独立客户端中查看结果(请在下面创建您自己的客户端ID):</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="2d2e" class="mq kv ik ma b fv mr ms l mt mu">from temperature_client import TemperatureClient<br/>tc = TemperatureClient('boneskull-test-1516667340',<br/>                       'test.mosquitto.org', 12, <br/>                       topic='boneskull/test/temperature')<br/>tc.start(10) # publish temperature every 10s</span></pre><p id="cd51" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">一个警告:一旦执行了上面的代码，REPL就会“挂起”，因为<code class="eh lx ly lz ma b">start()</code>方法只是<a class="ae ih" href="https://en.wikipedia.org/wiki/Busy_waiting" rel="noopener ugc nofollow" target="_blank">忙等待</a>。</p><blockquote class="mb mc md"><p id="3487" class="jh ji kt jj b jk jl jm jn jo jp jq jr me jt ju jv mf jx jy jz mg kb kc kd ke hn dt translated">即使这是一个忙等待，<code class="eh lx ly lz ma b">time.sleep()</code>并不意味着“什么都没发生”；<a class="ae ih" href="https://github.com/espressif/esp-idf" rel="noopener ugc nofollow" target="_blank">底层操作系统</a>中的节拍率为10ms任何小于等于10ms的睡眠时间(必须使用<code class="eh lx ly lz ma b">time.sleep_ms()</code>或<code class="eh lx ly lz ma b">time.sleep_us()</code>)都会抢占其他任务！</p></blockquote><p id="e796" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">返回MQTT.fx:</p><figure class="mi mj mk ml fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mx"><img src="../Images/63a6a509ea362c8399787a835be9c729.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QRrjpELoYkEf9lg4.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Real temperature data in MQTT.fx!</figcaption></figure><p id="9114" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这将无限循环，所以当准备好的时候，按下开发板上的“reset”按钮回到REPL(你<em class="kt">不需要</em>预先退出你的串行终端)。</p><blockquote class="mb mc md"><p id="e321" class="jh ji kt jj b jk jl jm jn jo jp jq jr me jt ju jv mf jx jy jz mg kb kc kd ke hn dt translated">重要注意事项:您在有效负载细节中看到的“时间和日期”并不意味着“发起客户端发送消息的时间”相反，它意味着“当接收客户端收到消息时”MQTT消息不包含“发送时间”时间戳，除非您自己添加一个！</p><p id="165b" class="jh ji kt jj b jk jl jm jn jo jp jq jr me jt ju jv mf jx jy jz mg kb kc kd ke hn dt translated">(为此，您需要询问一个<a class="ae ih" href="https://en.wikipedia.org/wiki/Network_Time_Protocol" rel="noopener ugc nofollow" target="_blank"> NTP </a>服务器或一个外部<a class="ae ih" href="https://en.wikipedia.org/wiki/Real-time_clock" rel="noopener ugc nofollow" target="_blank"> RTC </a>模块，这超出了我们的范围。)</p></blockquote><p id="78d3" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们成功发布了一个数字！这是个好消息，除了，这个数字可以指任何东西。在有效载荷中包含单位(华氏或摄氏)会很有帮助。我会告诉你怎么做。</p><h1 id="b9e0" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">使用JSON</h1><p id="5e63" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">正如我被<em class="kt">打死</em>的那样，MQTT有效载荷包含任何东西。这意味着如果你想发送一些结构化数据，<em class="kt">你</em>负责序列化和反序列化。</p><p id="b194" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><a class="ae ih" href="https://en.wikipedia.org/wiki/Json" rel="noopener ugc nofollow" target="_blank"> JSON </a>是一种通用的数据交换格式，MicroPython包含对它的内置支持(不像那种卑鄙的Arduino API)。“字符串化”一个<code class="eh lx ly lz ma b">dict</code>并发布结果是微不足道的。</p><p id="39b1" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">为了使用JSON——就像在真正的Python中一样——我们需要在<code class="eh lx ly lz ma b">temperature_client.py</code>中导入另一个模块:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="32db" class="mq kv ik ma b fv mr ms l mt mu">import json</span></pre><p id="1dbc" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">然后，在<code class="eh lx ly lz ma b">publishTemperature</code>方法中将数据添加到有效载荷中:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="f77e" class="mq kv ik ma b fv mr ms l mt mu">def publishTemperature(self):<br/>        """<br/>        Reads the current temperature and publishes a JSON payload on the<br/>        configured topic, e.g., `{"unit": "F", "degrees": 72.5}`<br/>        """<br/>        t = self.sensor.read_temp(self.fahrenheit)<br/>        payload = dict(degrees=t)<br/>        if self.fahrenheit:<br/>            payload['unit'] = 'F'<br/>        else:<br/>            payload['unit'] = 'C'<br/>        self.client.publish(self.topic, json.dumps(payload))</span></pre><p id="7aee" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">注意，为了发布，我们不需要将温度(“度”)强制转换成一个<code class="eh lx ly lz ma b">str</code>，因为JSON本身就是一个<code class="eh lx ly lz ma b">str</code>——这个有效载荷的接收者将把JSON解码成一个数值。</p><p id="f9f9" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">断开REPL(如果你碰巧在用<code class="eh lx ly lz ma b">miniterm</code>，那就是<code class="eh lx ly lz ma b">Ctrl-]</code>，再次上传<code class="eh lx ly lz ma b">temperate_client.py</code>到ESP32，然后重新连接到REPL。我们不需要开始一个无限循环来测试它，因为我们可以直接调用<code class="eh lx ly lz ma b">publishTemperature()</code>:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="1148" class="mq kv ik ma b fv mr ms l mt mu">from temperature_client import TemperatureClient<br/>tc = TemperatureClient('boneskull-test-1516667340',<br/>                       'test.mosquitto.org', 12, <br/>                       topic='boneskull/test/temperature')<br/>tc.publishTemperature()</span></pre><p id="c351" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">以上将发送一个单一的消息。在接收端:</p><figure class="mi mj mk ml fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mx"><img src="../Images/6c19a780918d46338d5b80141b07f1df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RVCn91sCfgWvorqs.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Pretty-printed JSON in MQTT.fx</figcaption></figure><p id="b1b9" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果您将MQTT.fx窗口的大小调整到足够高，您会在右下角看到“有效负载解码者”下拉菜单。你可以看到印刷精美的有效载荷出现了。</p><blockquote class="mb mc md"><p id="47c6" class="jh ji kt jj b jk jl jm jn jo jp jq jr me jt ju jv mf jx jy jz mg kb kc kd ke hn dt translated">MQTT.fx还包括Base64和hex解码器，但默认是“纯文本”。</p></blockquote><p id="bd68" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我认为你已经掌握了基本知识。但是，也许您不打算运行自己的私有MQTT代理。让我们更进一步，与物联网平台进行交互。</p><h1 id="2f32" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">在IBM Cloud上使用带有MicroPython的ESP32</h1><p id="ff0c" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">沃森物联网平台是IBM Cloud(前身为Bluemix)中的一项服务。我已经编写了一个MicroPython模块来与它接口，我们将使用它来节省一些时间。</p><h1 id="dd32" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">沃森物联网平台快速入门</h1><p id="c7ed" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">你可以在这个平台上进行实验，而不需要注册账户。</p><ol class=""><li id="9df3" class="kf kg ik jj b jk jl jo jp js kh jw ki ka kj ke kk kl km kn dt translated">访问<a class="ae ih" href="https://quickstart.internetofthings.ibmcloud.com/#/" rel="noopener ugc nofollow" target="_blank">快速入门</a>页面</li><li id="99af" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">仔细阅读完整的使用条款后，勾选“我接受”。</li><li id="2a80" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">在输入框中输入唯一的设备标识符。我把我的叫做“boneskull-esp32-test”。点击“开始”。</li></ol><figure class="mi mj mk ml fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff my"><img src="../Images/01e7373112786f722043077a5f8d3b0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4LaN-S19o87yjoxI.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Watson IoT Platform’s Quickstart Page</figcaption></figure><p id="7e20" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">保持此浏览器窗口打开；您现在可以发送数据，并实时查看结果。我们开始吧。</p><h1 id="c6f0" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">上传<code class="eh lx ly lz ma b">micropython-watson-iot</code>模块</h1><p id="e3ea" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated"><a class="ae ih" href="https://github.com/boneskull/micropython-watson-iot" rel="noopener ugc nofollow" target="_blank"> micropython-watson-iot </a>就是我前面提到的模块。它的README包含使用<code class="eh lx ly lz ma b">upip</code>的安装说明，但本质上它和以前一样，通过REPL:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="6d15" class="mq kv ik ma b fv mr ms l mt mu">import upip<br/>upip.install('micropython-watson-iot')</span></pre><p id="c228" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">要验证安装，请运行:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="5622" class="mq kv ik ma b fv mr ms l mt mu">from watson_iot import Device</span></pre><p id="6c09" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">假设没有抛出异常，我们可以这样使用它:</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="9bc1" class="mq kv ik ma b fv mr ms l mt mu">d = Device(device_id='boneskull-esp32-test')<br/>d.connect()<br/>d.publishEvent('temperature', {'degrees': 68.5, 'unit': 'F'})</span></pre><p id="bc10" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您应该会看到它反映在您的浏览器中。事实上，如果你做了这样的事情…</p><pre class="mi mj mk ml fq mm ma mn mo aw mp dt"><span id="d823" class="mq kv ik ma b fv mr ms l mt mu">import time<br/>d.publishEvent('temperature', {'degrees': 68.5, 'unit': 'F'})<br/>time.sleep(5)<br/>d.publishEvent('temperature', {'degrees': 69.5, 'unit': 'F'})<br/>time.sleep(5)<br/>d.publishEvent('temperature', {'degrees': 67.5, 'unit': 'F'})<br/>time.sleep(5)<br/>d.publishEvent('temperature', {'degrees': 66.5, 'unit': 'F'})</span></pre><p id="d854" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">…您应该会看到一个漂亮的折线图:</p><figure class="mi mj mk ml fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mz"><img src="../Images/b559b387b370d1fa986d06849ed59a14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4pxEmzy5oTCD7s4z.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Real-time graph of our temperature data</figcaption></figure><blockquote class="mb mc md"><p id="2682" class="jh ji kt jj b jk jl jm jn jo jp jq jr me jt ju jv mf jx jy jz mg kb kc kd ke hn dt translated">欢迎您对此进行更深入的探讨；沃森物联网平台有一个免费层。要注册，您需要:</p><p id="cc25" class="jh ji kt jj b jk jl jm jn jo jp jq jr me jt ju jv mf jx jy jz mg kb kc kd ke hn dt translated">1.<a class="ae ih" href="https://console.bluemix.net/registration" rel="noopener ugc nofollow" target="_blank">注册IBM Cloud </a>(不需要信用卡)<br/> 2。<a class="ae ih" href="https://console.bluemix.net/catalog/services/internet-of-things-platform" rel="noopener ugc nofollow" target="_blank">使用目录<br/> 3中的“免费计划”创建沃森物联网平台服务实例</a>。点击“启动”浏览平台。<br/> 4。此外，检查文档。</p></blockquote><p id="8518" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">与普通MQTT客户端和/或代理相比,<code class="eh lx ly lz ma b">micropython-watson-iot</code>库提供了一些“生活质量”方面的好处——正如物联网平台通常所做的那样:</p><ol class=""><li id="eb35" class="kf kg ik jj b jk jl jo jp js kh jw ki ka kj ke kk kl km kn dt translated">消息包含元数据，如“发布”时间，由云平台处理</li><li id="91ec" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">您可以通过逻辑“设备类型”对设备进行分组</li><li id="f1c1" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">结构化数据可以在JSON之间自动编码/解码(默认情况下是这样)</li><li id="d1b4" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">创建您自己的自定义编码器和解码器(例如，数字、Base64)</li><li id="2ab5" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">创建定制的“命令处理程序”，使设备在收到“命令”样式的MQTT消息时做出反应。例如，您可以发送一个命令来闪烁板载LED或重新启动设备。</li></ol><blockquote class="mb mc md"><p id="8026" class="jh ji kt jj b jk jl jm jn jo jp jq jr me jt ju jv mf jx jy jz mg kb kc kd ke hn dt translated">我已经提交了几个<a class="ae ih" href="https://github.com/boneskull/micropython-watson-iot/tree/master/example" rel="noopener ugc nofollow" target="_blank"> micropython-watson-iot的例子</a>；您可以将这些模式应用到您自己代码中。</p></blockquote><p id="9fca" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这里真的有比MQTT更多的东西——仪表板、网关和各种我不打算深入讨论的巫术。但是现在，多亏了我，在ESP32上使用MicroPython很容易。</p><p id="5cd2" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">咳咳…</p><h1 id="3198" class="ku kv ik bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">总结、强制性链接转储和告别</h1><p id="2c6a" class="pw-post-body-paragraph jh ji ik jj b jk ls jm jn jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke hn dt translated">在本教程中，我们学习了:</p><ol class=""><li id="12ed" class="kf kg ik jj b jk jl jo jp js kh jw ki ka kj ke kk kl km kn dt translated">MQTT是什么(以及它的用途)</li><li id="fdee" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">如何使用MicroPython和ESP32与MQTT代理对话</li><li id="2308" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">如何发布结构化数据</li><li id="bc9e" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">通过<code class="eh lx ly lz ma b">upip</code>从PyPi安装MicroPython库</li><li id="aee2" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">如何通过独立的MQTT客户机订阅简单的主题</li><li id="6bf7" class="kf kg ik jj b jk ko jo kp js kq jw kr ka ks ke kk kl km kn dt translated">如何使用<a class="ae ih" href="https://github.com/boneskull/micropython-watson-iot" rel="noopener ugc nofollow" target="_blank"> micropython-watson-iot </a>通过其<a class="ae ih" href="https://quickstart.internetofthings.ibmcloud.com/#/" rel="noopener ugc nofollow" target="_blank"> Quickstart </a>站点向Watson IoT平台发布数据</li></ol><p id="e643" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">查看 <code class="eh lx ly lz ma b"><a class="ae ih" href="https://github.com/boneskull/micropython-watson-iot/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">micropython-watson-iot</a></code>的自述文件，了解更多关于其用法和局限性的讨论。</p><p id="7a3c" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">为了您的方便，我已经将完整的示例文件<a class="ae ih" href="https://gist.github.com/boneskull/1f5ae354815c6db5b1cb05ad2cb6232b" rel="noopener ugc nofollow" target="_blank">贴在了这个要点</a>中。</p><p id="f436" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">感谢阅读！还要特别感谢<em class="kt">也做了</em>。</p><p id="3f6f" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">【boneskull.com】本文 <a class="ae ih" href="https://boneskull.com/micropython-on-esp32-part-2/" rel="noopener ugc nofollow" target="_blank"> <em class="kt">原载</em></a><em class="kt">2018年1月25日</em><a class="ae ih" href="https://boneskull.com" rel="noopener ugc nofollow" target="_blank"><em class="kt"/></a><em class="kt">。</em></p><figure class="mi mj mk ml fq hw"><div class="bz el l di"><div class="na nb l"/></div></figure></div></div>    
</body>
</html>