<html>
<head>
<title>[PoC] Password-Based user roles and triggers/actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">[PoC]基于密码的用户角色和触发器/操作</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/poc-password-based-user-roles-and-triggers-actions-3019659ddcf6?source=collection_archive---------19-----------------------#2018-02-16">https://medium.com/hackernoon/poc-password-based-user-roles-and-triggers-actions-3019659ddcf6?source=collection_archive---------19-----------------------#2018-02-16</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="49c9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">或者如何为同一帐户的多个角色使用不同的密码</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/a4ff19115d23fd67d42f53cffdc8b98a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2R7CM2FnHORDSRjFhXH7Jg.png"/></div></div></figure><p id="d352" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们都看过一两部电影，其中一个恶棍强迫一些无辜的人，给他密码以进入她的超级秘密账户(一个核设施，或瑞士银行账户)，这个恶棍最终获得了该账户，并将所有的钱转移到他自己的账户，或发射核武器。<br/>我们也听说过一些国家的当局强迫他们的公民甚至访客交出他们的社交媒体账户和密码。通常“受害者”没有任何选择，他们最终会提供自己的密码。</p><p id="d9a3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">防止这种情况的一种方法是在你的帐户上激活多级认证(2FA)，并在旅行时将你接收一次性密码的手机留在家里，但在很多情况下这可能不是一个真正的解决方案。</p><p id="866d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果不是所有这些，我们有系统/网站，每个帐户有多个角色/密码，而不是一直只使用一个密码，我们可以使用另一个告诉系统<strong class="it hv">“嘿，系统，当我使用这个特定的密码时，这意味着我不在一个安全的地方(或者我被迫交出我的密码)，所以请只显示我的帐户的受限版本</strong>，或者更好的“<strong class="it hv">嘿，系统， 当我使用这个特殊的密码时，只需禁用我的帐户，并且在30天内不接受任何激活它的请求。</strong></p><p id="abd8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将在本文中解释我们将如何实现这样一个系统，为了简单起见，我将只关注主要的概念，我将只使用一个控制器，一个用于用户及其角色的表，甚至只使用3种类型的帐户:主帐户、受限帐户和触发器帐户。我也将使用PHP/Laravel，但是您可以用自己选择的语言实现同样的想法。</p><h1 id="2ecd" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">为用户添加多个角色</h1><p id="6eb3" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">为了给用户添加多个角色，我们将为用户创建额外的[子]帐户。<br/>为此，我们将创建一个用户表迁移，其中包含:</p><pre class="jq jr js jt fq le lf lg lh aw li dt"><span id="2560" class="lj kc hu lf b fv lk ll l lm ln">$table-&gt;string('email')-&gt;unique()-&gt;nullable();<br/>$table-&gt;integer('master_account_id')-&gt;unsigned()-&gt;nullable();<br/>   $table-&gt;foreign('master_account_id')-&gt;references('id')-&gt;on('users');<br/>$table-&gt;string('type')-&gt;nullable();</span></pre><p id="9474" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如你在这里看到的，<code class="eh lo lp lq lf b">email</code>是可空的，所以我们可以不用电子邮件创建新帐户(我们可以用验证层防止用户不用密码创建新的“主”帐户)。<br/>我们还引用了主账户和账户类型。</p><p id="765c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们可以创建一个主帐户和两个子帐户，如下例所示:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff lr"><img src="../Images/df9df4c4a8352b1d19d2a01c0757f3a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*PstK0aaUfE-8GKKC."/></div></figure><h1 id="1688" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">基本/经典认证</h1><p id="7315" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">当我们在Laravel应用程序中构建经典的身份验证时(不使用内置的it authController)，我们通常会检查我们得到的密码是否对应于电子邮件，如下所示:</p><pre class="jq jr js jt fq le lf lg lh aw li dt"><span id="861f" class="lj kc hu lf b fv lk ll l lm ln">public function postLogin(Request $request)<br/>{<br/>   $data = $request-&gt;all();<br/>   $email = $data['email'];<br/>   $password = $data['password'];<br/>   if (Auth::attempt(['email' =&gt; $email, 'password' =&gt; $password]) {<br/>      // redirect the user to the dashboard<br/>   } else {<br/>   // redirect the user back to the login page<br/>   }<br/>…<br/>}</span></pre><p id="839a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们新的身份认证系统中，我们将对此稍作改变</p><p id="2e43" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，我们获得属于该电子邮件地址的所有帐户:</p><pre class="jq jr js jt fq le lf lg lh aw li dt"><span id="93e1" class="lj kc hu lf b fv lk ll l lm ln">$emailOwner = User::where('email', $email)→first();<br/>$users = User::where('master_account_id', $emailOwner-&gt;id)-&gt;get();</span></pre><p id="c6ca" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后我们尝试用收到的密码逐一登录:</p><pre class="jq jr js jt fq le lf lg lh aw li dt"><span id="44f5" class="lj kc hu lf b fv lk ll l lm ln">foreach ($users as $user) {<br/>   if (Auth::attempt(['id' =&gt; $user-&gt;id, 'password' =&gt; $password])) {<br/>      return redirect('/home');<br/>   }<br/>}<br/>// if we finish the loop without finding a match, redirect the user back to the login page</span></pre><p id="0aba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，我们正在尝试使用用户ID(不是电子邮件)和密码进行身份验证，一旦找到匹配项，我们就会使用找到的帐户登录。</p><p id="cd17" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如您所见，我们创建了一个多角色帐户，并根据用户使用的密码选择了角色。</p><h1 id="1bf2" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">添加基于密码的触发器/操作</h1><p id="d1cc" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">让我们添加一件事，让我们添加一种方法来触发一些行动时，我们登录的角色之一。为了简化示例，如果我们使用特定的密码进行身份验证，让我们禁用与电子邮件地址相关联的所有帐户。</p><p id="b0a2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，让我们向用户帐户添加一个附加字段:</p><pre class="jq jr js jt fq le lf lg lh aw li dt"><span id="4741" class="lj kc hu lf b fv lk ll l lm ln">$table-&gt;boolean('disabled')-&gt;default(false);</span></pre><p id="b170" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">PostLogin方法(我们用来验证用户的方法)将变成这样:</p><pre class="jq jr js jt fq le lf lg lh aw li dt"><span id="dcf5" class="lj kc hu lf b fv lk ll l lm ln">function postLogin(Request $request)<br/>{<br/>    $data       = $request-&gt;all();<br/>    $email      = $data['email'];<br/>    $emailOwner = User::where('email', $email)-&gt;first();</span><span id="0a80" class="lj kc hu lf b fv ls ll l lm ln">    if (!$email) {<br/>        return redirect()-&gt;route('login')-&gt;with('authentication-issue', true);<br/>    }</span><span id="d695" class="lj kc hu lf b fv ls ll l lm ln">    $password   = $data['password'];<br/>    $users      = User::where('master_account_id', $emailOwner-&gt;id)-&gt;get();<br/>    foreach ($users as $user) {<br/>        if (Auth::attempt(['id' =&gt; $user-&gt;id, 'password' =&gt; $password])) {<br/>            if ($user-&gt;type == "trigger") {<br/>                $this-&gt;trigger($emailOwner-&gt;id);<br/>            }<br/>            if ($user-&gt;disabled) {<br/>                return redirect()-&gt;route('login')-&gt;with('account-disabled', true);<br/>            }<br/>            return redirect('/home');<br/>        }<br/>    }</span><span id="7ef6" class="lj kc hu lf b fv ls ll l lm ln">    return redirect()-&gt;route('login')-&gt;with('authentication-issue', true);<br/>}</span><span id="2523" class="lj kc hu lf b fv ls ll l lm ln">function trigger($userId)<br/>{<br/>    $users = User::where('master_account_id', $userId)-&gt;get();<br/>    foreach ($users as $user) {<br/>        $user-&gt;disabled = true;<br/>        $user-&gt;save();<br/>    }<br/>}</span></pre><p id="a0f7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当我们使用与触发帐户关联的密码登录我们的帐户时，主帐户及其所有子帐户都会被禁用。</p><p id="b237" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以在这个回购里找到demo:<br/><a class="ae lt" href="https://github.com/djug/password-based-roles-actions" rel="noopener ugc nofollow" target="_blank">https://github.com/djug/password-based-roles-actions</a></p><figure class="jq jr js jt fq ju fe ff paragraph-image"><a href="https://goo.gl/RDUt4v"><div class="fe ff fg"><img src="../Images/52bf9e84126f483254abfde8427668f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fh3jPIRkLQOFi35thK-fkQ.png"/></div></a></figure></div></div>    
</body>
</html>