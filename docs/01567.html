<html>
<head>
<title>Chaos Engineering using Amazon EC2 Systems Manager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Amazon EC2系统管理器的混沌工程</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/chaos-engineering-using-amazon-ec2-systems-manager-5278e0bc8482?source=collection_archive---------16-----------------------#2018-02-19">https://medium.com/hackernoon/chaos-engineering-using-amazon-ec2-systems-manager-5278e0bc8482?source=collection_archive---------16-----------------------#2018-02-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/fcbb7a06e696ed5f1652620f748d2881.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1RAl8eBzLRfNpv98CskdUA.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">[Source: <a class="ae jg" href="https://www.pexels.com/photo/black-and-white-city-electric-train-electrical-wires-414931/" rel="noopener ugc nofollow" target="_blank">https://www.pexels.com/photo/black-and-white-city-electric-train-electrical-wires-414931/</a>]</figcaption></figure><h1 id="017b" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">背景</h1><p id="bc8e" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">我一直在研究如何将混沌引入应用程序的工具(混沌T2工程工具)，这样我就可以测试应用程序是否有弹性。当我在探索不同的<a class="ae jg" href="https://hackernoon.com/tagged/tools" rel="noopener ugc nofollow" target="_blank">工具</a>时，我探索了为什么我不能利用AWS中已经可用的Amazon EC2 Systems Manager工具套件来为应用程序引入混乱的想法。</p><h2 id="196a" class="ld ji hu bd jj le lf lg jn lh li lj jr kq lk ll jv ku lm ln jz ky lo lp kd lq dt translated">什么是亚马逊EC2系统管理器？</h2><p id="94d5" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">Amazon EC2 Systems Manager是一组功能，可帮助您自动执行管理任务，例如收集系统清单、应用操作系统补丁、自动创建Amazon机器映像(ami)以及大规模配置操作系统和应用程序。Systems Manager允许您远程安全地管理托管实例的配置。</p><p id="9c07" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">更多信息请访问:<a class="ae jg" href="http://docs.aws.amazon.com/systems-manager/latest/userguide/what-is-systems-manager.html" rel="noopener ugc nofollow" target="_blank">http://docs . AWS . Amazon . com/systems-manager/latest/user guide/what-is-systems-manager . html</a></p><p id="cdf5" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">带着这个想法，我开始寻找所有可以引入混乱的不同方法，并寻找可以使用EC2已经有的工具，而不是构建自己的工具。</p><p id="9517" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">这些工具是亚马逊系统管理器的一部分，我选择它们来执行混沌工程</p><ol class=""><li id="d9c1" class="lw lx hu kh b ki lr km ls kq ly ku lz ky ma lc mb mc md me dt translated">SSM文件</li><li id="b6b7" class="lw lx hu kh b ki mf km mg kq mh ku mi ky mj lc mb mc md me dt translated">运行命令</li></ol><h2 id="e857" class="ld ji hu bd jj le lf lg jn lh li lj jr kq lk ll jv ku lm ln jz ky lo lp kd lq dt translated">什么是SSM文件？</h2><p id="16a3" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">Amazon EC2系统管理器文档定义了系统管理器在托管实例上执行的操作。Systems Manager包括十几个预先配置的文档，您可以通过在运行时指定参数来使用这些文档。文档使用<a class="ae jg" href="https://hackernoon.com/tagged/javascript" rel="noopener ugc nofollow" target="_blank"> JavaScript </a>对象符号(JSON ),它们包括您指定的步骤和参数。步骤按顺序执行。</p><p id="c64c" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">更多信息请访问::<a class="ae jg" href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ssm-docs.html" rel="noopener ugc nofollow" target="_blank">http://docs . AWS . Amazon . com/systems-manager/latest/user guide/sysman-SSM-docs . html</a></p><h2 id="d012" class="ld ji hu bd jj le lf lg jn lh li lj jr kq lk ll jv ku lm ln jz ky lo lp kd lq dt translated">什么是运行命令？</h2><p id="7642" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">Systems Manager Run命令允许您远程安全地管理托管实例的配置。一个<em class="mk">托管实例</em>是混合环境中已经为Systems Manager配置的任何Amazon EC2实例或本地机器。运行命令使您能够自动执行常见的管理任务，并大规模执行临时配置更改。您可以从EC2控制台、AWS命令行界面、Windows PowerShell或AWS SDKs使用Run命令。</p><p id="2deb" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">更多信息请访问:<a class="ae jg" href="https://aws.amazon.com/ec2/run-command/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/ec2/run-command/</a></p><h1 id="4c20" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">安装演练</h1><p id="8da2" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">让我们演练一下运行混沌工程实验所需的设置</p><h2 id="2462" class="ld ji hu bd jj le lf lg jn lh li lj jr kq lk ll jv ku lm ln jz ky lo lp kd lq dt translated">设置系统管理器</h2><p id="f66d" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">要开始使用Amazon EC2系统管理器，请验证先决条件，配置AWS身份和访问管理(IAM)角色，并在托管实例上安装SSM代理。</p><p id="67af" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">本文讲述了如何配置IAM角色以及SSM代理的安装步骤:<a class="ae jg" href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-setting-up.html" rel="noopener ugc nofollow" target="_blank">http://docs . AWS . Amazon . com/systems-manager/latest/user guide/systems-manager-setting-up . html</a></p><p id="0784" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">使用上面的步骤，在您想要执行混沌实验的Amazon Linux EC2实例上安装SSM代理。</p><h2 id="a18d" class="ld ji hu bd jj le lf lg jn lh li lj jr kq lk ll jv ku lm ln jz ky lo lp kd lq dt translated">创建SSM文档</h2><p id="56c3" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">我们将创建一个SSM文档来运行我们不同的混沌工程实验。让我们从创建一个文档开始，在指定的时间内在指定的端口上封锁一个实例。我将继续用不同的SSM文档模板来完成不同的混沌工程实验。</p><p id="01e5" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">该页面讲述了如何创建SSM文档:<a class="ae jg" href="http://docs.aws.amazon.com/systems-manager/latest/userguide/create-ssm-doc.html" rel="noopener ugc nofollow" target="_blank">http://docs . AWS . Amazon . com/systems-manager/latest/user guide/create-SSM-doc . html</a></p><p id="e9db" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">对于实例上黑洞a端口的用例，您将使用以下信息创建文档:</p><p id="f640" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated"><strong class="kh hv">名称:</strong>混沌-黑洞</p><p id="9fec" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated"><strong class="kh hv">文档类型:</strong>命令</p><p id="0914" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated"><strong class="kh hv">内容:</strong></p><figure class="ml mm mn mo fq iv"><div class="bz el l di"><div class="mp mq l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Content used for Blackhole SSM Document</figcaption></figure><p id="93dd" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">正如你在上面看到的，我使用<code class="eh mr ms mt mu b">aws:runShellScript</code>动作在实例上执行命令来封锁实例上的一个端口。让我们演练一下我正在使用的命令。</p><p id="d142" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated"><code class="eh mr ms mt mu b">iptables -A INPUT -p tcp — destination-port {{ port }} -j DROP</code></p><p id="147d" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">添加iptables规则以丢弃指定端口上的数据包</p><p id="59e2" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated"><code class="eh mr ms mt mu b">sleep {{ duration }}</code></p><p id="83a3" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">等待指定的持续时间</p><p id="b1ff" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated"><code class="eh mr ms mt mu b">iptables -D INPUT -p tcp — destination-port {{ port }} -j DROP</code></p><p id="b1d4" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">删除iptable规则以丢弃指定端口上的数据包</p><blockquote class="mv mw mx"><p id="abfc" class="kf kg mk kh b ki lr kk kl km ls ko kp my lt ks kt mz lu kw kx na lv la lb lc hn dt translated">Port和Duration都是文档的参数，当执行Run命令时，这些参数将被填充值。</p></blockquote><h1 id="1ad7" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">运行混沌工程实验</h1><p id="e32f" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">现在，系统管理器代理已经安装在EC2实例上，SSM文档也已创建，是时候运行我们的混沌工程实验了，让我们看看如何运行混沌黑洞实验。在我们的实验中，我们将在安装了SSM代理的EC2实例上安装nginx，并将在nginx在该实例上使用的黑洞端口80上运行我们的混沌实验。当实验运行时，我们应该无法通过端口80上的浏览器访问该实例上的nginx。如果我们无法通过浏览器访问实例上的端口80，那么这意味着实验成功了。</p><h2 id="0133" class="ld ji hu bd jj le lf lg jn lh li lj jr kq lk ll jv ku lm ln jz ky lo lp kd lq dt translated">为我们的混沌工程实验准备EC2实例</h2><ol class=""><li id="0b6d" class="lw lx hu kh b ki kj km kn kq nb ku nc ky nd lc mb mc md me dt translated">SSH到安装了SSM代理的实例</li><li id="0541" class="lw lx hu kh b ki mf km mg kq mh ku mi ky mj lc mb mc md me dt translated">通过运行命令<code class="eh mr ms mt mu b">yum install nginx -y</code>安装nginx</li><li id="c9c1" class="lw lx hu kh b ki mf km mg kq mh ku mi ky mj lc mb mc md me dt translated">通过运行命令<code class="eh mr ms mt mu b">service nginx restart</code>启动nginx</li><li id="75ed" class="lw lx hu kh b ki mf km mg kq mh ku mi ky mj lc mb mc md me dt translated">通过运行<code class="eh mr ms mt mu b">curl <a class="ae jg" href="http://localhost" rel="noopener ugc nofollow" target="_blank">http://localhost</a></code>验证nginx正在实例上运行，并查看是否得到响应</li></ol><h2 id="7c49" class="ld ji hu bd jj le lf lg jn lh li lj jr kq lk ll jv ku lm ln jz ky lo lp kd lq dt translated">运行实验</h2><p id="e153" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">现在EC2实例在端口80上运行nginx，我们可以运行我们的混沌黑洞实验，看看我们的实验是否成功。对于本演练，我使用AWS管理控制台，但是我在文档中提到的所有步骤都可以使用AWS CLI或AWS SDK运行。</p><ul class=""><li id="4caa" class="lw lx hu kh b ki lr km ls kq ly ku lz ky ma lc ne mc md me dt translated">导航到AWS控制台，并从服务列表中选择EC2服务。在EC2仪表板中，从左侧菜单中选择<strong class="kh hv">运行命令</strong></li></ul><figure class="ml mm mn mo fq iv fe ff paragraph-image"><div class="fe ff nf"><img src="../Images/01550d6a920d207c2de1360e7960af94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*nPGgAUmNCLKx4AlhhLAgdg.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Run Command</figcaption></figure><ul class=""><li id="67d2" class="lw lx hu kh b ki lr km ls kq ly ku lz ky ma lc ne mc md me dt translated">在命令窗口中，点击<code class="eh mr ms mt mu b">Run a command</code>按钮</li><li id="bd3f" class="lw lx hu kh b ki mf km mg kq mh ku mi ky mj lc ne mc md me dt translated">在<code class="eh mr ms mt mu b">Run a command</code>窗口中，过滤<code class="eh mr ms mt mu b">Owned by me</code>的可用命令，选择<code class="eh mr ms mt mu b">Chaos-Blackhole</code>文档</li></ul><figure class="ml mm mn mo fq iv fe ff paragraph-image"><div class="fe ff nf"><img src="../Images/f243c1b24b3458249e92771383311a7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*U0g9avLn7QwZ_KKm4nAEZA.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Selecting Chaos-Blackhole Document from the list</figcaption></figure><ul class=""><li id="e695" class="lw lx hu kh b ki lr km ls kq ly ku lz ky ma lc ne mc md me dt translated">从目标实例中选择已配置SSM代理的实例</li><li id="b718" class="lw lx hu kh b ki mf km mg kq mh ku mi ky mj lc ne mc md me dt translated">输入80作为黑洞的端口号</li><li id="215c" class="lw lx hu kh b ki mf km mg kq mh ku mi ky mj lc ne mc md me dt translated">输入30秒作为黑洞的持续时间</li></ul><figure class="ml mm mn mo fq iv fe ff paragraph-image"><div class="fe ff nf"><img src="../Images/862abd82572eb7c151d29e672a1e64e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*2X2jWqzcAORgxJuxHa9_qA.png"/></div></figure><ul class=""><li id="1069" class="lw lx hu kh b ki lr km ls kq ly ku lz ky ma lc ne mc md me dt translated">填写完这些细节后，您可以点击底部的<code class="eh mr ms mt mu b">Run</code>按钮开始我们的实验</li><li id="7763" class="lw lx hu kh b ki mf km mg kq mh ku mi ky mj lc ne mc md me dt translated">在实验之前，我可以通过浏览器访问nginx</li></ul><figure class="ml mm mn mo fq iv fe ff paragraph-image"><div class="fe ff nf"><img src="../Images/856325f65d45acfbfaa85c01784b64fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*ADD4oum_IrfVZqoSHRGqXw.png"/></div></figure><ul class=""><li id="4b11" class="lw lx hu kh b ki lr km ls kq ly ku lz ky ma lc ne mc md me dt translated">在实验过程中，当我试图从浏览器点击EC2实例的ip时，它停止响应，轮子继续旋转</li></ul><figure class="ml mm mn mo fq iv fe ff paragraph-image"><div class="fe ff nf"><img src="../Images/45ad46ee10399a4e82e050f83c73d060.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*Hs4yve2OMqQTeIWeWBg6Ag.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Nginx was not accessible during the execution of the run command</figcaption></figure><ul class=""><li id="0f37" class="lw lx hu kh b ki lr km ls kq ly ku lz ky ma lc ne mc md me dt translated">一旦Run命令执行完毕，我就可以通过浏览器毫无问题地访问nginx了</li><li id="84af" class="lw lx hu kh b ki mf km mg kq mh ku mi ky mj lc ne mc md me dt translated">您还可以在命令列表窗口中查看运行命令的状态</li></ul><figure class="ml mm mn mo fq iv fe ff paragraph-image"><div class="fe ff nf"><img src="../Images/7dcd81aa352c8c2c21509161b554573c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*OP4K7I6ueIZeVGH2gXVkaw.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Run Command Execution</figcaption></figure><ul class=""><li id="5720" class="lw lx hu kh b ki lr km ls kq ly ku lz ky ma lc ne mc md me dt translated">通过利用EC2 Systems Manager，我能够在一个实例上成功运行黑洞a端口的混沌工程实验。</li></ul><p id="ed76" class="pw-post-body-paragraph kf kg hu kh b ki lr kk kl km ls ko kp kq lt ks kt ku lu kw kx ky lv la lb lc hn dt translated">请随时提供关于方法和改进方法的反馈。</p><figure class="ml mm mn mo fq iv"><div class="bz el l di"><div class="ng mq l"/></div></figure></div></div>    
</body>
</html>