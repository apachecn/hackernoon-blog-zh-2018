<html>
<head>
<title>How CodeSandbox uses Puppeteer &amp; Jest to test sandbox functionality</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CodeSandbox如何使用Puppeteer &amp; Jest测试沙盒功能</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-codesandbox-uses-puppeteer-jest-to-test-sandbox-functionality-17068b3bd23b?source=collection_archive---------12-----------------------#2018-02-22">https://medium.com/hackernoon/how-codesandbox-uses-puppeteer-jest-to-test-sandbox-functionality-17068b3bd23b?source=collection_archive---------12-----------------------#2018-02-22</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/6e7076bef47fad7f849c62380929e585.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C8O5Nd8UeoXQzswQdv8_WQ.png"/></div></div></figure><p id="b663" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">去年，<a class="kb kc gr" href="https://medium.com/u/3ccd3df9b3cf?source=post_page-----17068b3bd23b--------------------------------" rel="noopener" target="_blank"> Chrome开发者团队</a>发布了一款名为“<a class="ae ka" href="https://github.com/GoogleChrome/puppeteer" rel="noopener ugc nofollow" target="_blank">木偶师</a>的工具。这个工具是一个无头的Chrome，这意味着有了它你可以通过编程的方式与网站互动和访问网站。这是一个强大的概念，有许多用途。</p><p id="5307" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如今CodeSandbox 广泛使用木偶师。我想在两个帖子中解释我们如何使用木偶师。在这篇文章中，我将解释为什么以及如何在我们的测试套件中使用木偶师。在下一篇文章中，我将介绍我们如何使用木偶师和无服务器功能来为沙箱(项目)生成预览和元数据。</p><h1 id="c74e" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">但是为什么呢？</h1><p id="bdb3" class="pw-post-body-paragraph jc jd hu je b jf lb jh ji jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz hn dt translated">在CodeSandbox中，我们在浏览器中绑定所有沙盒代码，<a class="ae ka" href="https://hackernoon.com/how-i-created-a-parallel-offline-extensible-browser-based-bundler-886db508cc31" rel="noopener ugc nofollow" target="_blank">我构建了一个自定义绑定器</a>来完成这项工作。我们仍然会对这个bundler进行更改和添加功能，因此我们广泛测试这些更改是否会影响用户构建的现有沙盒是至关重要的。</p><h2 id="b30d" class="lg ke hu bd kf lh li lj kj lk ll lm kn jn ln lo kr jr lp lq kv jv lr ls kz lt dt translated">以前</h2><p id="b921" class="pw-post-body-paragraph jc jd hu je b jf lb jh ji jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz hn dt translated">我一直保存着一份“测试”沙箱列表，并会手动加载每个沙箱，看看它们是否还能工作。正如您可能预料的那样，这被证明是非常耗时的，因为列表一直在增长，超过了20个沙箱，我们开始收到更多的贡献。木偶师来救援了！</p><h2 id="0b6f" class="lg ke hu bd kf lh li lj kj lk ll lm kn jn ln lo kr jr lp lq kv jv lr ls kz lt dt translated">解决办法</h2><p id="f214" class="pw-post-body-paragraph jc jd hu je b jf lb jh ji jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz hn dt translated">木偶戏有一个非常漂亮的功能叫做<code class="eh lu lv lw lx b">screenshot</code>(你可以试试<a class="ae ka" href="https://try-puppeteer.appspot.com/" rel="noopener ugc nofollow" target="_blank">这里</a>)。该函数确实如其所描述的那样:它截取当前网页的截图，并返回截图的<code class="eh lu lv lw lx b">Buffer</code>。对于CodeSandbox，我们可以将它作为一个快照工具:每次提交后，我们都会对所有测试沙箱进行截图，并将它们与之前存储的截图进行比较。如果有超过1%的差异，我们就不能通过测试。</p><h1 id="9cd6" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated"><strong class="ak">实施</strong></h1><p id="ecaa" class="pw-post-body-paragraph jc jd hu je b jf lb jh ji jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz hn dt translated">我决定使用<a class="ae ka" href="https://facebook.github.io/jest/" rel="noopener ugc nofollow" target="_blank"> Jest </a>来运行所有测试。我们首先设置一系列沙箱来测试:</p><figure class="ly lz ma mb fq iv"><div class="bz el l di"><div class="mc md l"/></div></figure><p id="6b50" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是一个沙箱id列表，其中一些有额外的选项，如更宽容的阈值。我们迭代这个列表来创建测试用例:</p><figure class="ly lz ma mb fq iv"><div class="bz el l di"><div class="mc md l"/></div></figure><p id="19cf" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最大的问题是如何截取单个沙盒的截图。事实证明这非常简单，我们已经支持通过转到<code class="eh lu lv lw lx b">https://:id.codesandbox.io</code>打开一个沙箱作为一个单独的页面(例如:<a class="ae ka" href="https://vue.codesandbox.io" rel="noopener ugc nofollow" target="_blank">https://vue . code sandbox . io</a>)。所以留给我的唯一事情就是将这个功能添加到开发服务器中，这样我们就可以用新代码创建截图了。我最后把我们的webpack配置改成了“测试”模式，这种模式只会构建沙盒捆绑器并在<code class="eh lu lv lw lx b">http://localhost:3001#:id</code>托管它(例如:<code class="eh lu lv lw lx b">http://localhost:3001#vue</code>)。请注意，我们将id设置为散列，这样我们就不会干扰沙箱的路由。</p><figure class="ly lz ma mb fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff me"><img src="../Images/a97a5e50845732ce34b0f8e90a321566.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nxsohnjlNUCR8ugV."/></div></div><figcaption class="mf mg fg fe ff mh mi bd b be z ek">A generated screenshot of a todo redux example</figcaption></figure><p id="2444" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">完成这个设置后，构建其余部分就相当简单了。已经有一个比较截图的库叫<code class="eh lu lv lw lx b"><a class="ae ka" href="https://github.com/americanexpress/jest-image-snapshot" rel="noopener ugc nofollow" target="_blank">jest-image-snapshot</a></code>。这个库在<code class="eh lu lv lw lx b">expect</code>上暴露<code class="eh lu lv lw lx b">toMatchImageSnapshot</code>，工作方式几乎和<code class="eh lu lv lw lx b">toMatchSnapshot</code>一模一样。</p><p id="4860" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最终的实现如下所示:</p><figure class="ly lz ma mb fq iv"><div class="bz el l di"><div class="mc md l"/></div></figure><p id="a8c2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你可以在代码中看到我们公开了一个名为<code class="eh lu lv lw lx b">window.__puppeteer__</code>的函数。捆绑器在完成后调用<code class="eh lu lv lw lx b">window.__puppeteer__</code>，这个函数是由木偶师公开的，所以我们可以准确地知道什么时候可以截图。生成的截图然后保存在GitHub repo中。你可以在这里找到它们<a class="ae ka" href="https://github.com/CompuIves/codesandbox-client/blob/master/packages/app/integration-tests/tests/__image_snapshots__/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="3360" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们使用CircleCI运行这些测试，但是我们需要在本地生成初始截图。为了确保我们生成与CircleCI相似的截图，我们使用docker容器来生成截图。我们有一个简单的脚本，我们只是运行它来生成新的截图:</p><figure class="ly lz ma mb fq iv"><div class="bz el l di"><div class="mc md l"/></div></figure><p id="3a7f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我已经为CircleCI设置了一个简单的工作流来启动测试服务器并同时运行测试。这些测试在一个预装了木偶师的docker容器中运行。</p><figure class="ly lz ma mb fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mj"><img src="../Images/9348b446ae62a8cf350032da9097b616.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ucz8MXgvrK6SVOyfPMs4TA.png"/></div></div><figcaption class="mf mg fg fe ff mh mi bd b be z ek">The workflow of CodeSandbox, notice the test-integrations step</figcaption></figure><p id="f657" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们将所有差异保存为工件，因此我们可以轻松地比较截图。你可以在这里看到最近一次测试运行的工件列表:<a class="ae ka" href="https://circleci.com/gh/CompuIves/codesandbox-client/4291#artifacts/containers/0" rel="noopener ugc nofollow" target="_blank">https://circle ci . com/GH/compu Ives/code sandbox-client/4291 # artifacts/containers/0</a>。</p><figure class="ly lz ma mb fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff me"><img src="../Images/6a7c446a22b242f8d6baf5dd14b6159d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SreQNaaRyAwc765D.png"/></div></div><figcaption class="mf mg fg fe ff mh mi bd b be z ek">A diff artifact: the arrows are different</figcaption></figure><h1 id="a040" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">结论</h1><p id="ff92" class="pw-post-body-paragraph jc jd hu je b jf lb jh ji jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz hn dt translated">实现变得非常简单，但是已经节省了我很多时间。我们现在对每个提交和PR测试20多个沙箱。我还注意到，我更倾向于在测试套件中添加沙箱，这使得bundler总体上更加稳定。</p></div><div class="ab cl mk ml hc mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hn ho hp hq hr"><p id="b790" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在下一篇文章中，我将介绍我们如何使用Puppeteer和无服务器功能来为沙盒生成元数据和oEmbed标签。你可以关注我的推特<a class="ae ka" href="https://twitter.com/CompuIves" rel="noopener ugc nofollow" target="_blank"> @CompuIves </a>或者<a class="ae ka" href="https://twitter.com/codesandboxapp" rel="noopener ugc nofollow" target="_blank"> @codesandboxapp </a>来了解最新消息！</p><p id="9992" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你对代码感兴趣。这里描述的所有代码(以及CodeSandbox的代码)在GitHub上都是开源的。您可以在此处找到主存储库:</p><div class="mr ms fm fo mt mu"><a href="https://github.com/CompuIves/codesandbox-client" rel="noopener  ugc nofollow" target="_blank"><div class="mv ab ej"><div class="mw ab mx cl cj my"><h2 class="bd hv fv z el mz eo ep na er et ht dt translated">强制/代码沙盒-客户端</h2><div class="nb l"><h3 class="bd b fv z el mz eo ep na er et ek translated">codesandbox-client -一个为web应用程序开发定制的在线代码编辑器🏖️</h3></div><div class="nc l"><p class="bd b gc z el mz eo ep na er et ek translated">github.com</p></div></div><div class="nd l"><div class="ne l nf ng nh nd ni ja mu"/></div></div></a></div><p id="a338" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我希望你觉得这个帖子很有趣，不要犹豫，给木偶师更多的想法和用途！</p></div></div>    
</body>
</html>