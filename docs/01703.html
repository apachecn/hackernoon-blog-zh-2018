<html>
<head>
<title>RSpec Rails Controller Test</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">RSpec轨道控制器测试</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/rspec-rails-controller-test-158f142e11ce?source=collection_archive---------36-----------------------#2018-02-22">https://medium.com/hackernoon/rspec-rails-controller-test-158f142e11ce?source=collection_archive---------36-----------------------#2018-02-22</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="624d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Rails是一个web开发框架，其中<strong class="it hv">模型</strong>、<strong class="it hv">视图</strong>和<strong class="it hv">控制器</strong>是应用程序的重要方面。控制器，就像模型和查看器一样，需要用Ruby社区最喜欢的工具<strong class="it hv"> RSpec </strong>进行测试。</p><p id="ebfc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Rails中的<strong class="it hv">控制器</strong>接受<strong class="it hv"> HTTP请求</strong>作为它们的输入，并将<strong class="it hv"> HTTP响应</strong>作为输出。</p><h1 id="73f8" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">组织测试</h1><p id="c5b2" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated"><strong class="it hv">描述</strong>和<strong class="it hv">上下文块</strong>对于根据控制器的动作和我们正在测试的上下文，将测试组织成一个清晰的层次结构是至关重要的。Betterspecs.org提供了编写测试的基础知识，它将帮助你使你的测试更具表现力。</p><blockquote class="kt ku kv"><p id="d2ce" class="ir is kw it b iu iv iw ix iy iz ja jb kx jd je jf ky jh ji jj kz jl jm jn jo hn dt translated">“描述”的目的是针对一个功能包装一组测试，而“上下文”是针对同一状态下的一个功能包装一组测试。刘明的RSpec 中的描述与语境。</p></blockquote><p id="00f6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您希望为每个有意义的输入创建一个上下文，并将其包装到一个describe块中。</p><p id="783f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将用不同的describe块来表示每个HTTP会话。</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="5552" class="lm jq hu ld b fv ln lo l lp lq">describe "Stories" do<br/>  describe "GET stories#index" do<br/>    context "when the user is an admin" do<br/>      it "should list titles of all stories"<br/>    end</span><span id="64ff" class="lm jq hu ld b fv lr lo l lp lq">    context "when the user is not an admin" do<br/>      it "should list titles of users own stories" do<br/>    end</span></pre><p id="2bb0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当您想要控制<strong class="it hv">授权访问</strong>时，您可以为每个用户角色创建一个新的上下文。同样，您可以通过为登录和注销的用户创建一个新的上下文来管理<strong class="it hv">认证访问</strong>。</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="a770" class="lm jq hu ld b fv ln lo l lp lq">    context "when the user is logged in" do<br/>      it "should render stories#index"<br/>    end</span><span id="b073" class="lm jq hu ld b fv lr lo l lp lq">    context "when the user is logged out" do<br/>      it "should redirect to the login page"<br/>    end<br/>  end</span></pre><p id="a450" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">默认情况下，<a class="ae ks" href="https://kolosek.com/rails-rspec-setup/" rel="noopener ugc nofollow" target="_blank"> RSpec-Rails配置</a>禁用控制器规格模板的渲染。您可以通过添加<code class="eh la lb lc ld b">render_views</code>来启用它:</p><ol class=""><li id="31f9" class="ls lt hu it b iu iv iy iz jc lu jg lv jk lw jo lx ly lz ma dt translated">全局地，通过将其添加到<code class="eh la lb lc ld b">rails_helper.rb</code>文件中的<code class="eh la lb lc ld b">RSpec.configure</code>块</li><li id="9193" class="ls lt hu it b iu mb iy mc jc md jg me jk mf jo lx ly lz ma dt translated">按个人分组</li></ol><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="ffa6" class="lm jq hu ld b fv ln lo l lp lq">   describe "GET stories#show" do<br/>     it "should render stories#show template" do<br/>     end<br/>   end</span><span id="d9c2" class="lm jq hu ld b fv lr lo l lp lq">   describe "GET stories#new" do<br/>     it "should render stories#new template" do<br/>   end<br/> end</span></pre><p id="119e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在将属性保存到数据库之前，通常会检查您使用的属性是有效的还是无效的。</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="985e" class="lm jq hu ld b fv ln lo l lp lq">describe "POST stories#create" do context "with valid attributes" do it "should save the new story in the database" it "should redirect to the stories#index page" end context "with invalid attributes" do it "should not save the new story in the database" it "should render stories#new template" end end end</span></pre><h1 id="6e79" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">如何准备好您的数据？</h1><p id="12d7" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">我们使用<strong class="it hv">工厂</strong>为我们的控制器规格准备好数据。工厂的工作方式可以通过一个<a class="ae ks" href="https://kolosek.com/factory-girl-build-vs-build_stub/" rel="noopener ugc nofollow" target="_blank">工厂来改善。</a></p><p id="7beb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过下面的工厂，我们将使用不同标题和内容的<code class="eh la lb lc ld b">sequence</code>生成多个故事:</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="2629" class="lm jq hu ld b fv ln lo l lp lq">FactoryBot.define do<br/>  factory :story do<br/>    user<br/>    sequence(:title) { |n| "Title#{n}" }<br/>    sequence(:content) { |n| "Content#{n}" }<br/>  end<br/>end</span></pre><h1 id="31e4" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">让我们来测试一下！</h1><p id="e51a" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">是时候创建我们自己的控制器测试了。使用<a class="ae ks" href="https://kolosek.com/rails-rspec-setup/" rel="noopener ugc nofollow" target="_blank"> RSpec </a>和<a class="ae ks" href="https://kolosek.com/rails-capybara-setup/" rel="noopener ugc nofollow" target="_blank"> Capybara </a>编写测试。我们将在<code class="eh la lb lc ld b">stories_controller.rb</code>中介绍这些方法的测试:</p><h1 id="9286" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">#索引</h1><p id="7835" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">首先，我们想看看我们的控制器<code class="eh la lb lc ld b">stories_controller.rb</code>。索引动作<strong class="it hv">根据当前用户是否是管理员来授权对故事的访问</strong>:</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="855d" class="lm jq hu ld b fv ln lo l lp lq">def index<br/>  @stories = Story.view_premissions(current_user).<br/>end</span></pre><p id="05d8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在模型<code class="eh la lb lc ld b">story.rb</code>中，我们<strong class="it hv">检查</strong>当前用户是否是管理员:</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="6d19" class="lm jq hu ld b fv ln lo l lp lq">def self.view_premissions(current_user)<br/>  current_user.role.admin? ? Story.all : current_user.stories<br/>end</span></pre><p id="4e4a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">利用我们刚刚收集的信息，我们可以创建下面的<strong class="it hv"> GET stories#index </strong>测试:</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="372e" class="lm jq hu ld b fv ln lo l lp lq">describe "GET stories#index" do<br/>  context "when the user is an admin" do<br/>    it "should list titles of all stories" do<br/>      admin = create(:admin)<br/>      stories = create_list(:story, 10, user: admin)<br/>      login_as(admin, scope: :user)<br/>      visit stories_path</span><span id="4e51" class="lm jq hu ld b fv lr lo l lp lq">      stories.each do |story|<br/>        page.should have_content(story.title)<br/>      end<br/>   end<br/>end</span><span id="6b13" class="lm jq hu ld b fv lr lo l lp lq">  context "when the user is not an admin" do<br/>    it "should list titles of users own stories" do<br/>      user = create(:user)<br/>      stories = create_list(:story, 10, user: user)<br/>      login_as(user, scope: :user)<br/>      visit stories_path</span><span id="575a" class="lm jq hu ld b fv lr lo l lp lq">      stories.each do |story|<br/>      page.should have_content(story.title)<br/>      end<br/>    end<br/>  end<br/>end</span></pre><p id="91e3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如您所见，我们为每个用户角色(admin和not admin)创建了两个不同的上下文。管理员用户将能够看到所有的故事标题，另一方面，标准用户只能看到他们自己的。</p><p id="5c1b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用选项<code class="eh la lb lc ld b">create(:user)</code>和<code class="eh la lb lc ld b">create_list(:story, 10, user: user)</code>你可以创建用户和十个不同的用户故事。新创建的用户将登录<code class="eh la lb lc ld b">login_as(user, scope: :user)</code>并访问<code class="eh la lb lc ld b">stories_path</code>页面，在这里他可以根据他当前的角色<code class="eh la lb lc ld b">page.should have_content(story.title)</code>看到所有的故事标题。</p><p id="5270" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">另一个创建新用户的好方法是使用<a class="ae ks" href="https://kolosek.com/rspec-let-vs-before/" rel="noopener ugc nofollow" target="_blank"> let或before blocks </a>，这是编写干测试的两种不同方法。</p><h1 id="cfa7" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">#显示</h1><p id="773d" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">您可以用类似的方式编写#show方法测试。唯一的区别是你想访问的页面显示了你想读的故事。</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="7dc3" class="lm jq hu ld b fv ln lo l lp lq">describe "GET stories#show" do<br/>  it "should render stories#show template" do<br/>    user = create(:user)<br/>    story = create(:story, user: user)</span><span id="ed5c" class="lm jq hu ld b fv lr lo l lp lq">    login_as(user, scope: :user)<br/>    visit story_path(story.id)</span><span id="8475" class="lm jq hu ld b fv lr lo l lp lq">    page.should have_content(story.title)<br/>    page.should have_content(story.content)<br/>  end<br/>end</span></pre><p id="9889" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们再次想要创建用户<code class="eh la lb lc ld b">create(:user)</code>和故事<code class="eh la lb lc ld b">create(:story, user: user)</code>。创建的用户将登录并访问包含基于story.id <code class="eh la lb lc ld b">visit story_path(story.id)</code>的故事的页面。</p><h1 id="a727" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">#新建和#创建</h1><p id="c536" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">与其他方法不同，这种方法创建了一个新的故事。让我们来看看<code class="eh la lb lc ld b">stories_controller.rb</code>中的以下动作</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="828c" class="lm jq hu ld b fv ln lo l lp lq"># GET stories#new<br/>def new<br/>  @story = Story.new<br/>end</span><span id="f56d" class="lm jq hu ld b fv lr lo l lp lq"># POST stories#create<br/>def create<br/>  @story = Story.new(story_params)<br/>  if @story.save redirect_to story_path(@story), success: "Story is successfully created."<br/>  else<br/>    render action: :new, error: "Error while creating new story"<br/>  end<br/>end</span><span id="009c" class="lm jq hu ld b fv lr lo l lp lq">private</span><span id="2178" class="lm jq hu ld b fv lr lo l lp lq">def story_params<br/>  params.require(:story).permit(:title, :content)<br/>end</span></pre><p id="ec1b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh la lb lc ld b">new</code>动作呈现一个stories #新模板，这是一个您在使用<code class="eh la lb lc ld b">create</code>动作创建新故事之前填写的表单。成功创建后，故事将保存在数据库中。</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="3dc9" class="lm jq hu ld b fv ln lo l lp lq">describe "POST stories#create" do<br/>  it "should create a new story" do<br/>    user = create(:user)<br/>    login_as(user, scope: :user)<br/>    visit new_stories_path</span><span id="7593" class="lm jq hu ld b fv lr lo l lp lq">    fill_in "story_title", with: "Ruby on Rails"<br/>    fill_in "story_content", with: "Text about Ruby on Rails"</span><span id="8de8" class="lm jq hu ld b fv lr lo l lp lq">    expect { click_button "Save" }.to change(Story, :count).by(1)<br/>  end<br/>end</span></pre><p id="dd2b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这一次，一个已创建并登录的用户将访问该页面，在那里可以创建一个新故事<code class="eh la lb lc ld b">visit new_stories_path</code>。下一步是用标题和内容<code class="eh la lb lc ld b">fill_in "...", with: "..."</code>填充表单。一旦我们点击保存按钮<code class="eh la lb lc ld b">click_button "Save"</code>，总故事数将增加一个<code class="eh la lb lc ld b">change(Story, :count).by(1)</code>，意味着该故事已成功创建。</p><p id="2189" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每个人都希望能够更新他们的故事。这可以通过以下方式轻松实现:</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="9787" class="lm jq hu ld b fv ln lo l lp lq">def update<br/>  if @story.update(story_params)<br/>    flash[:success] = "Story #{@story.title} is successfully updated."<br/>    redirect_to story_path(@story)<br/>  else<br/>    flash[:error] = "Error while updating story"<br/>    redirect_to story_path(@story)<br/>  end<br/>end</span><span id="f364" class="lm jq hu ld b fv lr lo l lp lq">private</span><span id="3eab" class="lm jq hu ld b fv lr lo l lp lq">def story_params<br/>  params.require(:story).permit(:title, :content)<br/>end</span></pre><p id="5013" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当一个新的故事被创建时，我们可以通过访问故事编辑页面来更新它。</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="25a8" class="lm jq hu ld b fv ln lo l lp lq">describe "PUT stories#update" do<br/>  it "should update an existing story" do<br/>    user = create(:user)<br/>    login_as(user, scope: :user)<br/>    story = create(:story)<br/>    visit edit_story_path(story)</span><span id="8ec2" class="lm jq hu ld b fv lr lo l lp lq">    fill_in "story_title", with: "React"<br/>    fill_in "story_content", with: "Text about React"</span><span id="908d" class="lm jq hu ld b fv lr lo l lp lq">    click_button "Save"<br/>    expect(story.reload.title).to eq "React"<br/>    expect(story.content).to eq "Text about React"<br/>  end<br/>end</span></pre><p id="c31f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就像前面的方法一样，一个新创建的登录用户将创建一个故事并访问编辑故事页面<code class="eh la lb lc ld b">edit_story_path(story)</code>。一旦我们更新了故事的标题和内容，它就会按照我们的要求发生变化<code class="eh la lb lc ld b">expect(story.reload.title).to eq "React"</code>。</p><h1 id="e3a7" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">#删除</h1><p id="1c74" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">最后，我们希望能够删除我们不喜欢的故事。</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="85e4" class="lm jq hu ld b fv ln lo l lp lq">def destroy<br/>  authorize @story<br/>  if @story.destroy<br/>    flash[:success] = "Story #{@story.title} removed successfully"<br/>    redirect_to stories_path<br/>  else<br/>    flash[:error] = "Error while removing story!"<br/>    redirect_to story_path(@story)<br/>  end<br/>end</span></pre><p id="8a3f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你想通过安装<a class="ae ks" href="https://kolosek.com/rails-bundle-install-and-gemfile/" rel="noopener ugc nofollow" target="_blank"/><code class="eh la lb lc ld b"><a class="ae ks" href="https://kolosek.com/rails-bundle-install-and-gemfile/" rel="noopener ugc nofollow" target="_blank">gem 'pundit'</a></code>来确保只有故事的管理员和所有者可以删除它。</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="a62f" class="lm jq hu ld b fv ln lo l lp lq">class StoryPolicy &lt; ApplicationPolicy<br/>  def destroy?<br/>    @user.role.admin?<br/>  end<br/>end</span></pre><p id="b296" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们也来测试一下。</p><pre class="le lf lg lh fq li ld lj lk aw ll dt"><span id="0dbd" class="lm jq hu ld b fv ln lo l lp lq">describe "DELETE stories#destroy" do<br/>  it "should delete a story" do<br/>    user = create(:admin)<br/>    story = create(:story, user: user)<br/>    login_as(user, scope: :user)<br/>    visit story_path(story.id)<br/>    page.should have_link("Delete")<br/>    expect { click_link "Delete" }.to change(Story, :count).by(-1)<br/>  end<br/>end</span></pre><p id="af6a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该测试的编写方式与stories#create类似，主要区别在于。我们没有创建故事，而是删除了它，这样总计数就减少了一个<code class="eh la lb lc ld b">change(Story, :count).by(-1)</code>。</p><p id="c1e0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们又一次到达了终点！但是还有很多文章等着你，现在就订阅吧！</p></div><div class="ab cl mg mh hc mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="hn ho hp hq hr"><p id="5ad0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kw">原载于2018年2月22日kolosek.com</em><a class="ae ks" href="https://kolosek.com/rspec-controller-test/" rel="noopener ugc nofollow" target="_blank"><em class="kw"/></a><em class="kw">。</em></p></div></div>    
</body>
</html>