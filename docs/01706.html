<html>
<head>
<title>AWS Lambda Functions in Java</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Java中的AWS Lambda函数</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/aws-lambda-functions-in-java-24a2e41fa736?source=collection_archive---------2-----------------------#2018-02-23">https://medium.com/hackernoon/aws-lambda-functions-in-java-24a2e41fa736?source=collection_archive---------2-----------------------#2018-02-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/0b65223478da37f0935834666a3eb23c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2jhnbB6ZDpo-I7k6GthC7w.jpeg"/></div></div></figure><div class=""/><h1 id="0908" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">亚马逊网络服务</h1><p id="673d" class="pw-post-body-paragraph ka kb if kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">在过去，支持web应用程序需要购买一个或多个计算机系统来充当web服务器。其他硬件可能包括负载平衡器，用于在web服务器和数据库服务器之间分配web应用程序负载。这些计算机系统需要安装在空调设备中。需要报警系统和其他安全措施来提供人身安全。需要购买足够的互联网带宽来支持预期的高峰使用。</p><p id="455d" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">除了计算机硬件和设施的资本费用外，还需要工作人员来管理计算机系统。</p><p id="cd87" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">亚马逊网络服务(AWS)极大地降低了网络应用的成本。计算、互联网带宽和数据库服务没有前期成本(尽管预付某些服务可以省钱)。亚马逊计算和RDS数据库服务无需维护。</p><p id="40d2" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">尽管AWS在降低web应用程序成本方面具有革命性，但每周7天、每天24小时(24/7)运行弹性计算云(EC2)服务器的成本仍然很高(尤其是对于一家试图节约每一分钱的初创公司而言)。对于随着web应用程序需求的增加而扩展的AWS应用程序，应用程序的成本将随着负载均衡器添加额外的服务器而增加。</p><p id="8bb1" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">运行在web服务器上的应用程序将分配多个服务器线程来支持应用程序用户。当这些用户执行消耗内存或处理资源的操作时，负载平衡器可以分配额外的服务器来处理负载。在新服务器可以联机处理增加的负载之前，通常有一段时间延迟。为了避免这种延迟，可以分配额外的24/7运行的服务器(EC2实例)来处理高峰需求。为处理峰值负载而配置的EC2资源增加了web应用程序的成本，并且可能在大多数时间被轻度利用。</p><h2 id="d787" class="ld jd if bd je le lf lg ji lh li lj jm kl lk ll jq kp lm ln ju kt lo lp jy lq dt translated">自动气象站λ</h2><p id="d46d" class="pw-post-body-paragraph ka kb if kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">AWS Lambda允许将内存或计算密集型操作卸载到Lambda函数。Lambda函数具有高度的可伸缩性和并发性，可以快速满足高峰需求。Lambda函数缩放不会影响web服务器，也不会导致向web应用程序添加额外的EC2资源。</p><p id="fdfa" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">根据Lambda函数的调用频率，成本可能非常低(在某些情况下，没有成本)。例如，在撰写本文时，Amazon Lambda 的<a class="ae lr" href="https://aws.amazon.com/lambda/pricing/" rel="noopener ugc nofollow" target="_blank">免费层(例如，零成本)允许每月100万次调用和400，000千兆字节秒的计算。Lambda的免费层对新的和现有的AWS客户都是无限期可用的。</a></p><p id="67ee" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">AWS Lambda可用于支持各种AWS云功能。例如，Lambda可用于提供移动应用服务，消除对网络服务器的需求(支持所谓的“无服务器计算”)。Lambda函数也可以作为远程过程调用、卸载内存或计算密集型操作来调用。这是这里讨论的用例。</p><h1 id="765e" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">Java中的Lambda函数</h1><p id="d2d6" class="pw-post-body-paragraph ka kb if kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">关于Lambda Java函数的AWS文档主要关注为响应定义的AWS事件而调用的<a class="ae lr" href="https://docs.aws.amazon.com/lambda/latest/dg/invoking-lambda-function.html" rel="noopener ugc nofollow" target="_blank"> Lambda函数。例如，当在DynamoDB表中创建条目时，或者当文件存储在AWS S3存储中时，可以调用Lambda函数。尽管事件驱动的Lambda函数是Amazon文档中经常描述的用例，但Lambda函数并不一定要在响应事件时被调用。Lambda函数可以通过远程调用来调用。</a></p><p id="4b63" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">亚马逊为Eclipse  提供了<a class="ae lr" href="https://docs.aws.amazon.com/toolkit-for-eclipse/v1/user-guide/getting-started.html" rel="noopener ugc nofollow" target="_blank"> <em class="ls"> AWS工具包，这使得构建Java Lambda函数并将其下载到Lambda服务变得很容易。该工具包正确地构建并下载Lambda函数的代码，以及所有必需的Java“jar”文件。</em></a></p><p id="c9a1" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">下面显示了一个简单的Lambda函数，它回显其输入的注释副本。</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="e69f" class="ld jd if ly b fv mc md l me mf"><strong class="ly ig">package</strong> com.amazonaws.lambda.lambda_example;<br/><br/><strong class="ly ig">import</strong> <strong class="ly ig">com.amazonaws.services.lambda.runtime.Context</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">com.amazonaws.services.lambda.runtime.RequestHandler</strong>;<br/><br/>/**<br/> * &lt;p&gt;<br/> * SimpleLambdaFunctionExample<br/> * &lt;/p&gt;<br/> * &lt;p&gt;<br/> * An example of a minimal Lambda function that returns an annotated argument string.<br/> * &lt;/p&gt;<br/> * &lt;p&gt;<br/> * Feb 16, 2018<br/> * &lt;/p&gt;<br/> * <br/> * @author Ian Kaplan, iank@bearcave.com<br/> */<br/><strong class="ly ig">public</strong> <strong class="ly ig">class</strong> <strong class="ly ig">SimpleLambdaFunctionExample</strong> <strong class="ly ig">implements</strong> RequestHandler&lt;SimpleLambdaMessage, String&gt; {<br/>    <strong class="ly ig">public</strong> <strong class="ly ig">final</strong> <strong class="ly ig">static</strong> String lambdaFunctionName = "SimpleLambdaFunctionExample";<br/><br/>    <strong class="ly ig">@Override</strong><br/>    <strong class="ly ig">public</strong> String <strong class="ly ig">handleRequest</strong>(SimpleLambdaMessage message, Context context) {<br/>        <strong class="ly ig">final</strong> String resultStr = "Returned from AWS Lambda. Input string was " + message.getMessage();<br/>        <strong class="ly ig">return</strong> resultStr;<br/>    }<br/><br/>}</span></pre><p id="7ff1" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">Lambda函数的参数必须始终是一个Java对象，该对象可以序列化为一个<a class="ae lr" href="https://www.json.org/" rel="noopener ugc nofollow" target="_blank"> JSON </a>字符串。在这种情况下，Java对象是如下所示的SimpleLambdaMessage对象。</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="858f" class="ld jd if ly b fv mc md l me mf"><strong class="ly ig">package</strong> com.amazonaws.lambda.lambda_example;<br/>/**<br/> * &lt;h4&gt;<br/> * SimpleLambdaMessage<br/> * &lt;/h4&gt;<br/> * &lt;p&gt;<br/> * A class for sending message strings to an Amazon Web Services Lambda Function<br/> * &lt;/p&gt;<br/> * &lt;p&gt;<br/> * Feb 19, 2018<br/> * &lt;/p&gt;<br/> * <br/> * @author Ian Kaplan, iank@bearcave.com<br/> */<br/><strong class="ly ig">public</strong> <strong class="ly ig">class</strong> <strong class="ly ig">SimpleLambdaMessage</strong> {<br/>    <strong class="ly ig">private</strong> String mMessage;<br/><br/>    /**<br/>     * @param message the message contents for the object<br/>     */<br/>    <strong class="ly ig">public</strong> <strong class="ly ig">void</strong> <strong class="ly ig">setMessage</strong>(<strong class="ly ig">final</strong> String message) {<br/>        <strong class="ly ig">this</strong>.mMessage = message;<br/>    }<br/><br/>    /**<br/>     * @return the message string<br/>     */<br/>    <strong class="ly ig">public</strong> String <strong class="ly ig">getMessage</strong>() {<br/>        <strong class="ly ig">return</strong> <strong class="ly ig">this</strong>.mMessage;<br/>    }<br/><br/>    <strong class="ly ig">@Override</strong><br/>    <strong class="ly ig">public</strong> String <strong class="ly ig">toString</strong>() {<br/>        <strong class="ly ig">return</strong> <strong class="ly ig">this</strong>.mMessage;<br/>    }<br/><br/>}</span></pre><p id="820e" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">当用AWS工具包配置Eclipse时，可以选择SimpleLambdaFunction.java文件并“右键单击”以显示Eclipse菜单。其中一个菜单项是“亚马逊网络服务”，其中包括一个子菜单，条目为“向AWS Lambda上传功能”。选择此项将调用一组对话框将函数下载到Lambda。在将函数下载到Lambda之前，您需要设置AWS IAM权限和S3存储来支持Lambda函数。这样做的细节超出了本文的讨论范围。</p><p id="4fac" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">要从Java web应用程序(或jUnit测试代码)调用函数，您需要构建一个AWS Lambda客户端，并将函数参数转换为JSON。下面的代码显示了一个示例。要运行这段代码，您需要填写自己的Amazon ID和Lambda服务的密钥。</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="2fe0" class="ld jd if ly b fv mc md l me mf"><strong class="ly ig">package</strong> com.amazonaws.lambda.lambda_example;<br/><strong class="ly ig">import</strong> <strong class="ly ig">java.io.IOException</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">java.nio.ByteBuffer</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">java.nio.charset.StandardCharsets</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">java.util.logging.Logger</strong>;<br/><br/><strong class="ly ig">import</strong> <strong class="ly ig">org.junit.Test</strong>;<br/><br/><strong class="ly ig">import</strong> <strong class="ly ig">com.amazonaws.auth.AWSStaticCredentialsProvider</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">com.amazonaws.auth.BasicAWSCredentials</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">com.amazonaws.protocol.json.SdkJsonGenerator.JsonGenerationException</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">com.amazonaws.regions.Regions</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">com.amazonaws.services.lambda.AWSLambda</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">com.amazonaws.services.lambda.AWSLambdaClientBuilder</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">com.amazonaws.services.lambda.model.InvokeRequest</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">com.amazonaws.services.lambda.model.InvokeResult</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">com.amazonaws.services.s3.model.Region</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">com.fasterxml.jackson.databind.JsonMappingException</strong>;<br/><strong class="ly ig">import</strong> <strong class="ly ig">com.fasterxml.jackson.databind.ObjectMapper</strong>;<br/><br/>/**<br/> * A simple test harness for invoking your Lambda function via a remote Lambda call.<br/> */<br/><strong class="ly ig">public</strong> <strong class="ly ig">class</strong> <strong class="ly ig">LambdaFunctionTest</strong> {<br/><br/>    /**<br/>     * Build an Amazon Web Services Lambda client object.<br/>     * <br/>     * @param accessID The AWS credential ID<br/>     * @param accessKey The AWS credential secret key<br/>     * @return An AWS Lambda client<br/>     */<br/>    <strong class="ly ig">private</strong> AWSLambda <strong class="ly ig">buildClient</strong>(String accessID, String accessKey) {<br/>        Regions region = Regions.fromName(Region.US_West.toString());<br/>        BasicAWSCredentials credentials = <strong class="ly ig">new</strong> BasicAWSCredentials(accessID, accessKey);<br/>        AWSLambdaClientBuilder builder = AWSLambdaClientBuilder.standard()<br/>                                         .withCredentials(<strong class="ly ig">new</strong> AWSStaticCredentialsProvider(credentials))<br/>                                         .withRegion(region);<br/>        AWSLambda client = builder.build();<br/>        <strong class="ly ig">return</strong> client;<br/>    }<br/><br/>    /**<br/>     * See http://www.baeldung.com/jackson-inheritance<br/>     * <br/>     * @param obj<br/>     * @return<br/>     * @throws JsonGenerationException<br/>     * @throws JsonMappingException<br/>     * @throws IOException<br/>     */<br/>    <strong class="ly ig">private</strong> <strong class="ly ig">static</strong> String <strong class="ly ig">objectToJSON</strong>( Object obj, Logger logger) {<br/>        String json = "";<br/>        <strong class="ly ig">try</strong> {<br/>            ObjectMapper mapper = <strong class="ly ig">new</strong> ObjectMapper();<br/>            json = mapper.writeValueAsString(obj);<br/>        } <strong class="ly ig">catch</strong> (JsonGenerationException | IOException e) {<br/>            logger.severe("Object to JSON failed: " + e.getLocalizedMessage());<br/>        }<br/>        <strong class="ly ig">return</strong> json;<br/>    }<br/><br/>    <strong class="ly ig">@Test</strong><br/>    <strong class="ly ig">public</strong> <strong class="ly ig">void</strong> <strong class="ly ig">testLambdaFunction</strong>() {<br/>        <strong class="ly ig">final</strong> String aws_access_key_id = "Your AWS ID goes here";<br/>        <strong class="ly ig">final</strong> String aws_secret_access_key = "Your AWS secret key goes here";<br/>        <strong class="ly ig">final</strong> Logger logger = Logger.getLogger( <strong class="ly ig">this</strong>.getClass().getName() );<br/>        <strong class="ly ig">final</strong> String messageToLambda = "Hello Lambda Function";<br/>        <strong class="ly ig">final</strong> SimpleLambdaMessage messageObj = <strong class="ly ig">new</strong> SimpleLambdaMessage();<br/>        messageObj.setMessage(messageToLambda);<br/><br/>        AWSLambda lambdaClient = buildClient(aws_access_key_id, aws_secret_access_key);<br/>        String lambdaMessageJSON = objectToJSON( messageObj, logger );<br/>        InvokeRequest req = <strong class="ly ig">new</strong> InvokeRequest()<br/>                               .withFunctionName(SimpleLambdaFunctionExample<br/>                               .lambdaFunctionName)<br/>                               .withPayload( lambdaMessageJSON );<br/>        InvokeResult requestResult = lambdaClient.invoke(req);<br/>        ByteBuffer byteBuf = requestResult.getPayload();<br/>        <strong class="ly ig">if</strong> (byteBuf != <strong class="ly ig">null</strong>) {<br/>            String result = StandardCharsets.UTF_8.decode(byteBuf).toString();<br/>            logger.info("testLambdaFunction::Lambda result: " + result);<br/>        } <strong class="ly ig">else</strong> {<br/>            logger.severe("testLambdaFunction: result payload is null");<br/>        }<br/>    }<br/>}</span></pre><p id="ea8c" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">默认情况下，Eclipse会将Lambda项目构建为Maven项目。要编译代码来调用Lambda函数，您需要包含以下Maven依赖项(当然，Java SDK的版本会随着时间的推移而变化):</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="fe57" class="ld jd if ly b fv mc md l me mf">&lt;dependency&gt;<br/>           &lt;groupId&gt;com.amazonaws&lt;/groupId&gt;<br/>           &lt;artifactId&gt;aws-java-sdk&lt;/artifactId&gt;<br/>           &lt;version&gt;1.11.253&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><h1 id="6316" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">测试和调试Lambda函数</h1><p id="c68c" class="pw-post-body-paragraph ka kb if kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">像AWS Lambda这样的服务允许将内存和处理负载转移到Lambda，这将随着负载的增加而扩展。Lambda还允许用最少的服务器端资源构建移动应用程序。Lambda的吸引人的特性、亚马逊的营销和软件行业的从众心理导致了“无服务器计算”的流行。大多数写无服务器计算奇迹的人并不深究这样一个事实，即基于Lambda的应用程序有一个更老的名字:分布式应用程序。</p><p id="9542" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">众所周知，分布式应用程序很难调试，因为应用程序组件运行在通过计算机网络(在Amazon“虚拟专用云”网络的情况下)连接的不同计算机系统上。</p><p id="15b0" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">关于Lambda函数执行和错误的信息只能通过检查Lambda执行日志来获得。作为Lambda函数参数的上下文对象有一个相关联的记录器，可用于记录错误和执行状态。</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="03c6" class="ld jd if ly b fv mc md l me mf">LambdaLogger logger = context.getLogger();</span></pre><p id="3a27" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">通过读取Lambda执行日志来诊断Lambda函数错误的难度应该会促使谨慎的开发人员在将运行在Lambda上的代码集成到应用程序之前，尽可能彻底地对其进行测试。应该编写本地运行的Java jUnit测试来测试在Lambda下运行的代码。一旦这些测试通过，就应该编写在Lambda下运行代码的测试。只有当本地和远程Lambda测试通过时，Lambda代码才应该集成到应用程序中。</p><h1 id="901a" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">用AWS Lambda处理Java图像</h1><p id="d27a" class="pw-post-body-paragraph ka kb if kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">AWS Lambda的一个常见用例是从较大的数字照片中生成缩略图和缩放图像的图像处理。将图像处理从web服务器转移到Lambda函数可以消除图像处理操作可能导致的内存和处理器峰值。这降低了web服务器的负载，并允许应用程序在更少的web服务器上运行。Lambda函数将平滑缩放，并且可以支持多个web服务器线程中的图像处理操作。</p><p id="56ca" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">地下社交网络(由Topstone Software设计和建造)用户可以在他们的板上和照片库中发布照片。当照片被下载到地下时，会为缩略图和中等比例的照片生成照片的新版本。</p><p id="2bf7" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated">当照片库功能被添加到nderground时，额外的服务器被添加到AWS Elastic Beanstalk负载平衡器来管理内存和处理负载。通过添加Lambda函数来缩放图像，我们能够减少服务器的数量，从而降低了地下工程的每月成本。</p><h1 id="6900" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">GitHub上的Java图像缩放软件</h1><p id="257c" class="pw-post-body-paragraph ka kb if kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">Topstone software在GitHub上发布了Java图像缩放软件(见<a class="ae lr" href="https://github.com/IanLKaplan/LambdaImageProcessing" rel="noopener ugc nofollow" target="_blank">IanLKaplan/LambdaImageProcessing</a>)。该软件在Apache 2开源许可下可用。</p><p id="05a7" class="pw-post-body-paragraph ka kb if kc b kd ky kf kg kh kz kj kk kl la kn ko kp lb kr ks kt lc kv kw kx hn dt translated"><em class="ls">此文原载</em> <a class="ae lr" href="http://topstonesoftware.com/publications/lambda_functions.html" rel="noopener ugc nofollow" target="_blank"> <em class="ls">此处</em> </a> <em class="ls">在</em> <a class="ae lr" href="http://www.topstonesoftware.com" rel="noopener ugc nofollow" target="_blank"> <em class="ls">托普斯通软件咨询</em> </a> <em class="ls">网站上。</em></p></div></div>    
</body>
</html>