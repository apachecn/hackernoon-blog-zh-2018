<html>
<head>
<title>Public IPFS Node behind NGINX Reverse Proxy &amp; How-to communicate with it</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NGINX反向代理背后的公共IPFS节点&amp;如何与之通信</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/public-ipfs-node-behind-nginx-reverse-proxy-5682747f174b?source=collection_archive---------6-----------------------#2018-02-24">https://medium.com/hackernoon/public-ipfs-node-behind-nginx-reverse-proxy-5682747f174b?source=collection_archive---------6-----------------------#2018-02-24</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/7b1a4dc523718336e30d488c8c9b5cc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lGh_L0ldPWz1kFMcKvj4Qw.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="https://en.wikipedia.org/wiki/InterPlanetary_File_System" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/InterPlanetary_File_System</a></figcaption></figure><p id="3f02" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">用<strong class="jj hv">以太坊</strong>和<strong class="jj hv"> IPFS </strong>进行实验，在设置<a class="ae jg" href="https://cryptoblox.co" rel="noopener ugc nofollow" target="_blank">https://cryptoblox.co</a>的过程中，我想打开一个IPFS的公共节点，以便任何人从任何地方上传文件到IPFS——通过<strong class="jj hv"> CryptoBLOX </strong>。</p><p id="4ae1" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">使用<a class="ae jg" href="https://github.com/ipfs/js-ipfs" rel="noopener ugc nofollow" target="_blank"> js-ipfs </a>，我能够向公众开放一个ipfs节点，然而，我偶然发现了一个问题:ipfs-api目前不支持<strong class="jj hv"/><strong class="jj hv">HTTPS</strong>——尽管使用了<a class="ae jg" href="https://github.com/multiformats/multiaddr" rel="noopener ugc nofollow" target="_blank">多地址</a>格式。也许将来会有计划，但目前还不支持。</p><p id="61f9" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">显然，你不能在同一个网站上混合使用HTTP和HTTPS(混合内容拦截)。</p><p id="dcd6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">因此，我必须设置<strong class="jj hv"> NGINX </strong>作为我正在运行的<strong class="jj hv"> jsipfs守护进程</strong>的<strong class="jj hv">反向代理</strong>。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="ed53" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated"><strong class="ak">安装和设置JS-IPFS守护进程</strong></h1><figure class="ll lm ln lo fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lk"><img src="../Images/68c12130b25168ac5bd8f1b6613af6d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bxLe5kBt0Oj7iQZTE2KNfQ.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="https://github.com/ipfs/js-ipfs" rel="noopener ugc nofollow" target="_blank">https://github.com/ipfs/js-ipfs</a></figcaption></figure><p id="39f4" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">首先，我安装了IPFS:</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="ea81" class="lu kn hu lq b fv lv lw l lx ly">npm install ipfs --global</span></pre><p id="d61a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我决定从<strong class="jj hv"> CLI </strong>中使用它，因此我运行了以下命令(来自js-ipfs-api文档，已编辑) :</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="1c51" class="lu kn hu lq b fv lv lw l lx ly"># Show the ipfs config API port to check it is correct<br/>&gt; jsipfs config Addresses.API<br/>/ip4/127.0.0.1/tcp/5001<br/># Set it if it does not match the above output<br/>&gt; jsipfs config Addresses.API /ip4/<strong class="lq hv">127.0.0.1</strong>/tcp/5001<br/># Restart the daemon after changing the config<br/><br/># Run the daemon<br/>&gt; jsipfs daemon</span></pre><p id="1ae4" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在我的节点。JS服务器(在本地运行<strong class="jj hv"/>)我定期设置它:</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="34ea" class="lu kn hu lq b fv lv lw l lx ly">var ipfs = ipfsAPI('localhost', '5001', {protocol: 'http'})</span></pre><p id="bdb8" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">除此之外，我想让它作为合法的<strong class="jj hv">守护进程</strong>运行——重启后重启，崩溃后重启，等等。</p><p id="989e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">使用<strong class="jj hv"> systemctl </strong>我能够实现以下功能:</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="ced1" class="lu kn hu lq b fv lv lw l lx ly">vim /lib/systemd/system/jsipfs.service</span></pre><p id="5787" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">并粘贴以下内容:</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="cc21" class="lu kn hu lq b fv lv lw l lx ly">[Unit]<br/>Description=JSIPFS Daemon Client<br/>[Service]<br/>ExecStart=/root/.nvm/versions/node/v8.9.1/bin/node /root/.nvm/versions/node/v8.9.1/bin/jsipfs daemon<br/>Restart=always<br/>RestartSec=30<br/>Type=simple<br/>User=root<br/>Group=root<br/>[Install]<br/>WantedBy=multi-user.target</span></pre><p id="e3fe" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><em class="lz">注意，服务配置文件需要</em> <strong class="jj hv"> <em class="lz">到可执行文件的完整路径</em> </strong> <em class="lz">。</em></p><p id="fdd1" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在运行:</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="3bba" class="lu kn hu lq b fv lv lw l lx ly">systemctl daemon-reload</span><span id="d859" class="lu kn hu lq b fv ma lw l lx ly">systemctl start jsipfs</span><span id="be87" class="lu kn hu lq b fv ma lw l lx ly"># To see the last lines written to stdout / stderr by the process<br/>journalctl -u jsipfs -n50</span></pre></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="2541" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">将nginx设置为反向代理</h1><figure class="ll lm ln lo fq iv fe ff paragraph-image"><div class="fe ff mb"><img src="../Images/ad1d8741f777ffa6f3bcddc16cad73a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*P9PdkCzC2vBU1leyoK0hHg.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="https://nginx.com" rel="noopener ugc nofollow" target="_blank">https://nginx.com</a></figcaption></figure><p id="fc96" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在我的例子中，为了得到一个<strong class="jj hv"> SSL </strong>证书，我使用了<strong class="jj hv"> Let's Encrypt </strong>，我发现这个证书非常有用，非常方便，几分钟就可以设置好。</p><p id="9e14" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">简单跑步:</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="aff3" class="lu kn hu lq b fv lv lw l lx ly">sudo certbot --nginx -d cryptoblox.co</span></pre><p id="62f4" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在nginx上设置SSL，并添加一个从HTTP到HTTPS的<strong class="jj hv">重定向</strong>，不需要更多操作。</p><p id="96b2" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">继续编辑nginx <strong class="jj hv">配置</strong>(<em class="lz">/etc/nginx/sites-available/default</em>)—在原始服务器初始化后添加以下代码片段:</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="3010" class="lu kn hu lq b fv lv lw l lx ly">server {<br/>    listen [::]:5002 ssl ipv6only=on; # managed by Certbot<br/>    listen 5002 ssl; # managed by Certbot<br/>    ssl_certificate /etc/letsencrypt/live/cryptoblox.co/fullchain.pem; # managed by Certbot<br/>    ssl_certificate_key /etc/letsencrypt/live/cryptoblox.co/privkey.pem; # managed by Certbot<br/>    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot<br/>    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot<br/>    server_name cryptoblox.co;</span><span id="f5df" class="lu kn hu lq b fv ma lw l lx ly">location / {<br/>        proxy_pass <a class="ae jg" href="http://localhost:5001" rel="noopener ugc nofollow" target="_blank">http://localhost:5001</a>;<br/>        proxy_set_header Host $host;<br/>        proxy_cache_bypass $http_upgrade;<br/>     }<br/>}</span></pre><p id="959d" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在只需重启nginx 就可以了！</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="8a6e" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">与公共IPFS节点通信</h1><figure class="ll lm ln lo fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mc"><img src="../Images/930273999aaf79f29083f5e8a6d89896.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D_oUW9xcJ1A9eKcQW_nJCw.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="https://github.com/ipfs/js-ipfs-api" rel="noopener ugc nofollow" target="_blank">https://github.com/ipfs/js-ipfs-api</a></figcaption></figure><p id="962a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在<strong class="jj hv">客户端</strong>，在要求<a class="ae jg" href="https://github.com/ipfs/js-ipfs-api" rel="noopener ugc nofollow" target="_blank"> js-ipfs-api </a>后，我简单地用以下方式初始化它:</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="15c5" class="lu kn hu lq b fv lv lw l lx ly">var ipfsApi = ipfsAPI('cryptoblox.co', '5002', {protocol : "https"})</span></pre><p id="292c" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">或者，如果您需要他们的CDN:</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="cd7e" class="lu kn hu lq b fv lv lw l lx ly">var ipfsApi = window.IpfsApi('cryptoblox.co', '5002', {protocol : "https"})</span></pre><p id="0822" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">然后，一个简单的函数接受一个<strong class="jj hv">斑点</strong>，并将其添加到<strong class="jj hv"> IPFS </strong>:</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="9bf9" class="lu kn hu lq b fv lv lw l lx ly">async function saveToIPFSToBytes32(blob) {<br/>  var fileReader = await loadFileReader(blob);<br/>  var buff = Buffer.from(fileReader.result);<br/>  var result = await ipfsApi.add(buff, { progress: (prog) =&gt; {} });<br/>  return ipfsHashToBytes32(result[0].hash);<br/>}</span></pre><p id="92ca" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">请注意，文件保存在您的节点<strong class="jj hv">本地</strong>上，直到其他人<strong class="jj hv">请求</strong>它们，因此在上传它们之后，我们<strong class="jj hv">立即向<a class="ae jg" href="https://ipfs.io" rel="noopener ugc nofollow" target="_blank">https://ipfs . io</a>T16】全局</strong>网关发送请求，其中包含文件散列。</p><p id="0a1f" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">就这样，现在你可以通过<strong class="jj hv"> HTTPS </strong>与你的<strong class="jj hv">公众</strong> IPFS节点交流了。</p><p id="f54d" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">希望它能帮助那些致力于让互联网更加分散化的人👼</p></div></div>    
</body>
</html>