<html>
<head>
<title>Setup Raspberry PI 3 as AWS VPN Customer Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Raspberry PI 3设置为AWS VPN客户网关</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/setup-raspberry-pi-3-as-aws-vpn-customer-gateway-7432f653707?source=collection_archive---------5-----------------------#2018-02-26">https://medium.com/hackernoon/setup-raspberry-pi-3-as-aws-vpn-customer-gateway-7432f653707?source=collection_archive---------5-----------------------#2018-02-26</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/ff1be2dedfe80aa5c6561da1da1fc492.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XQ-Jm8pc0HAsF_hJw0eFhA.jpeg"/></div></div></figure><p id="cf9f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我的<a class="ae ka" href="https://hackernoon.com/aws-openvpn-access-server-c9edaece035a" rel="noopener ugc nofollow" target="_blank">上一篇文章</a>中，我向你展示了如何使用<strong class="je hv"> VPN软件解决方案</strong>，比如<strong class="je hv"> OpenVPN </strong>，来创建一个到你的<strong class="je hv"> AWS </strong>私有资源的安全隧道。在这篇文章中，我将带你一步一步地了解如何用一个<strong class="je hv"> Raspberry PI </strong>作为<strong class="je hv">客户网关</strong>，从你的家庭网络建立到你的远程<strong class="je hv"> AWS VPC子网</strong>的安全桥。</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kb"><img src="../Images/8ca7061d14f9f6166ae0134b87f6126c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DDw44UP9yYfvJPTs."/></div></div></figure><p id="a0b2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先，找到您的<strong class="je hv">家庭路由器</strong>面向公众的IP地址:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kg"><img src="../Images/4cf3cf94ff62aae97fad7c52003e5b85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KSBLoC6MbDYdDvvr."/></div></div></figure><p id="c365" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，登录<a class="ae ka" href="http://console.aws.amazon.com/console/home?region=us-east-1" rel="noopener ugc nofollow" target="_blank"> AWS管理控制台</a>，导航到<strong class="je hv"> VPC仪表板</strong>并创建一个新的<strong class="je hv"> VPN客户网关</strong>:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kg"><img src="../Images/aa3ba92cb1155d3179b12b24f234bf69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IO2YgoWdcp1ToMf5."/></div></div></figure><p id="0697" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，创建一个<strong class="je hv">虚拟专用网关</strong>:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kh"><img src="../Images/167538572f51831e4d91beb41ddbce23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7vZ5ZU5ieTtQcPFK."/></div></div></figure><p id="3ccf" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">并将其连接到目标<strong class="je hv"> VPC </strong>:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ki"><img src="../Images/b7324911ab8f803e7edfbc38e759e4ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*w9Y9ZRq0e-rNf80h."/></div></div></figure><p id="e183" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后，创建与<strong class="je hv">客户网关</strong>和<strong class="je hv">虚拟专用网关</strong>的<strong class="je hv"> VPN连接</strong>:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kj"><img src="../Images/0b990185b4831c8fe9becac2d6e011a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XVqwRxVQjQSEEQLa."/></div></div></figure><p id="2267" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注意:确保将您的<strong class="je hv">主CIDR子网</strong>添加到<strong class="je hv">静态IP前缀</strong>部分。</p><p id="9955" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦<strong class="je hv"> VPN连接</strong>被创建，点击“<strong class="je hv">隧道详细信息</strong>”选项卡，您应该看到两条冗余隧道:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kh"><img src="../Images/99470b13b81639e512f191259342bc03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_hLCaKucK8cd9bKf."/></div></div></figure><p id="deeb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">创建VPN连接可能需要几分钟时间。准备好后，选择连接，选择“<strong class="je hv">下载配置</strong>，打开配置文件，记下您的<strong class="je hv">预共享密钥</strong>和<strong class="je hv">隧道IP </strong>:</p><figure class="kc kd ke kf fq iv"><div class="bz el l di"><div class="kk kl l"/></div></figure><p id="38e9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我用了一个<strong class="je hv">Raspberry PI 3</strong>(Quand Core CPU 1.2 GHz，1 GB RAM)搭配<strong class="je hv"> Raspbian </strong>，启用<strong class="je hv"> SSH server </strong>(默认用户名&amp;密码:<em class="km"> pi </em> / <em class="km"> raspberry </em>，你可以登录并开始操作PI:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div class="fe ff kn"><img src="../Images/2d486eff2334946bf51ba0f3ab971846.png" data-original-src="https://miro.medium.com/v2/resize:fit:1378/0*ALIm1DJg-X4OlarW."/></div></figure><p id="a978" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">必须安装IPsec </strong>内核支持。因此，您必须在您的PI上安装<strong class="je hv"> openswan </strong>:</p><blockquote class="ko kp kq"><p id="85d4" class="jc jd km je b jf jg jh ji jj jk jl jm kr jo jp jq ks js jt ju kt jw jx jy jz hn dt translated">sudo apt-get install-y open swan lsof</p></blockquote><p id="3ab5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">更新<em class="km"> /etc/ipsec.conf </em>文件，如下所示:</p><figure class="kc kd ke kf fq iv"><div class="bz el l di"><div class="kk kl l"/></div></figure><p id="a968" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在<em class="km">/etc/IPsec . d/home-to-AWS . conf</em>中创建新的<strong class="je hv"> IPsec连接</strong>:</p><figure class="kc kd ke kf fq iv"><div class="bz el l di"><div class="kk kl l"/></div></figure><ul class=""><li id="fb8f" class="ku kv hu je b jf jg jj jk jn kw jr kx jv ky jz kz la lb lc dt translated"><strong class="je hv">左</strong>:你的树莓派私人IP。</li><li id="377d" class="ku kv hu je b jf ld jj le jn lf jr lg jv lh jz kz la lb lc dt translated"><strong class="je hv"> leftid </strong>:您的家用路由器面向公众的IP。</li><li id="2b86" class="ku kv hu je b jf ld jj le jn lf jr lg jv lh jz kz la lb lc dt translated"><strong class="je hv">左子网</strong>:您的主子网的CIDR。</li><li id="ef57" class="ku kv hu je b jf ld jj le jn lf jr lg jv lh jz kz la lb lc dt translated"><strong class="je hv">右</strong>:虚拟专用网关隧道IP。</li><li id="1ac1" class="ku kv hu je b jf ld jj le jn lf jr lg jv lh jz kz la lb lc dt translated"><strong class="je hv">右子网</strong>:你VPC的CIDR。</li></ul><p id="1484" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">将隧道<strong class="je hv">预共享密钥</strong>添加到<em class="km">/var/lib/open swan/IPSec . secrets . Inc</em>:</p><blockquote class="ko kp kq"><p id="4b83" class="jc jd km je b jf jg jh ji jj jk jl jm kr jo jp jq ks js jt ju kt jw jx jy jz hn dt translated">89.95 . x . y 52.47.119.151:PSK</p></blockquote><p id="62e2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要启用<strong class="je hv"> IPv4转发</strong>，请编辑<em class="km"> /etc/sysctl.conf </em>，并确保以下行未被注释:</p><figure class="kc kd ke kf fq iv"><div class="bz el l di"><div class="kk kl l"/></div></figure><p id="2fea" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">运行<em class="km"> sysctl -p </em>重新加载。然后，重启<strong class="je hv"> IPsec </strong>服务:</p><blockquote class="ko kp kq"><p id="89f5" class="jc jd km je b jf jg jh ji jj jk jl jm kr jo jp jq ks js jt ju kt jw jx jy jz hn dt translated">服务ipsec重新启动</p></blockquote><p id="081c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">验证服务是否正常运行:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff li"><img src="../Images/47bdc080f7bb1fcafe3d12c09c56a2b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-WksUeAgEzZQKsOL."/></div></div></figure><p id="e154" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您返回到您的<strong class="je hv"> AWS仪表板，</strong>您应该看到第一通道状态变为<strong class="je hv"> UP </strong>:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kh"><img src="../Images/3525338ffdc817b3b2b326d9a5cf083a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xFhxX3HSn7ob5PFD."/></div></div></figure><p id="60c8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">添加一个新的路由条目，通过VPN网关将流量转发到您的家庭子网:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lj"><img src="../Images/9275c08d338c5fc8e0cbdcd3215e7283.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E8-194pn7zBM_M9I."/></div></div></figure><p id="2b1f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注意:按照上述相同步骤设置第二个隧道，以实现VPN连接的弹性和高可用性。</p><p id="5ee7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在私有子网中启动一个<strong class="je hv"> EC2实例</strong>来验证VPN连接:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lk"><img src="../Images/41142617db399047ec240ac7ab0c1e10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wQwmcztSPK50Zkur."/></div></div></figure><p id="fc60" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">只允许从你的<strong class="je hv">家庭网关CIDR </strong>使用SSH:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kh"><img src="../Images/cfce35a939e6384a90b4774376934c68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MRQWIDS5Ao7UyKwI."/></div></div></figure><p id="57fa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">创建实例后，使用服务器私有ip地址通过<strong class="je hv"> SSH </strong>进行连接:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ll"><img src="../Images/8bc155b7693bc1d867c2c767f965efd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9jzm80mBhrU3hWxz."/></div></div></figure><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lm"><img src="../Images/f975114824b6863e5a1e11edcdf6af34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NVxa1jJO3kYuNayO."/></div></div></figure><p id="0edc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">恭喜你！现在，您可以安全地连接到您的私有EC2实例。</p><p id="365d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了进一步从同一个<strong class="je hv">家庭网络</strong>中的其他机器进行连接，添加一个静态路由，如下所述:</p><p id="8151" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv"> 1 —窗户</strong></p><blockquote class="ko kp kq"><p id="5bc7" class="jc jd km je b jf jg jh ji jj jk jl jm kr jo jp jq ks js jt ju kt jw jx jy jz hn dt translated">路由添加10.0.0.0掩码255.255.0.0 192.168.1.81</p></blockquote><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div class="fe ff ln"><img src="../Images/01e46101677b34a7138f4b15044ea19d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*OmHgcXbHEqLgNRvm."/></div></figure><p id="269c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv"> 2 — Linux </strong></p><blockquote class="ko kp kq"><p id="9545" class="jc jd km je b jf jg jh ji jj jk jl jm kr jo jp jq ks js jt ju kt jw jx jy jz hn dt translated">sudo上行路由添加网络10.0.0.0网络掩码255.255.0.0 gw 192.168.31.232</p></blockquote><p id="b434" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv"> 3 —麦克·OS X</strong></p><blockquote class="ko kp kq"><p id="db07" class="jc jd km je b jf jg jh ji jj jk jl jm kr jo jp jq ks js jt ju kt jw jx jy jz hn dt translated">sudo route -n地址10.0.0.0/16 192.168.31.232</p></blockquote><p id="e30c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">测试一下:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div class="fe ff ln"><img src="../Images/19c4648acd67fa0d64ddebec8efbe101.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*eozcuYO4HrAR-eI3."/></div></figure></div></div>    
</body>
</html>