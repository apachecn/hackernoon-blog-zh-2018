<html>
<head>
<title>Efficiently snapshotting your single-page-apps with Puppeteer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用木偶师高效拍摄单页应用程序</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/efficiently-snapshotting-spas-with-puppeteer-c4c77aa2831b?source=collection_archive---------3-----------------------#2018-02-27">https://medium.com/hackernoon/efficiently-snapshotting-spas-with-puppeteer-c4c77aa2831b?source=collection_archive---------3-----------------------#2018-02-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/8e71f5e5a07ee99cf2eaaaaac8db5811.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7lHnt9iSo9XpGZTEvdGJ0w.png"/></div></div></figure><div class=""/><div class=""><h2 id="8ed3" class="pw-subtitle-paragraph jc ie if bd b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ek translated">在每月5美元的VPS上运行截图服务</h2></div><h2 id="605b" class="ju jv if bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated"><strong class="ak">动机</strong></h2><p id="c74e" class="pw-post-body-paragraph ks kt if ku b kv kw jg kx ky kz jj la kf lb lc ld kj le lf lg kn lh li lj lk hn dt translated">我的爱好项目——npm charts，是一个单页的app，展示了各种NPM包的下载趋势。如果你想知道使用哪个无头chrome库，你会看到这个图表</p><figure class="ll lm ln lo fq hw"><div class="bz el l di"><div class="lp lq l"/></div></figure><p id="c65a" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">然而，当该页面被分享到脸书、Twitter或Slack时，显示的预览图像都是一样的——我两年前拍摄的比较前端框架的截图，并作为该网站唯一的开放图形图像上传。啧啧。</p><h2 id="1418" class="ju jv if bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated">问题是</h2><p id="aeb4" class="pw-post-body-paragraph ks kt if ku b kv kw jg kx ky kz jj la kf lb lc ld kj le lf lg kn lh li lj lk hn dt translated">一切都托管在我的5美元的数字海洋小水滴上。我把这个功能推迟这么久的原因之一是因为我担心droplet无法处理运行快照服务的负载。我必须努力提高效率。</p><h2 id="baf5" class="ju jv if bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated">从简单开始</h2><p id="38f1" class="pw-post-body-paragraph ks kt if ku b kv kw jg kx ky kz jj la kf lb lc ld kj le lf lg kn lh li lj lk hn dt translated">让我们从简单开始，首先得到一些有用的东西:</p><figure class="ll lm ln lo fq hw"><div class="bz el l di"><div class="lw lq l"/></div><figcaption class="lx ly fg fe ff lz ma bd b be z ek">This function is called by an express route handler for /chart-image</figcaption></figure><p id="29b4" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">相当简单，但是为每个请求启动一个浏览器实例，然后关闭它似乎很浪费。</p><p id="65c3" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">目前，在我的MacBook上，返回一张截图的平均时间约为3.5秒，在D.O. droplet上只需更长时间。让我们减少再利用。</p><blockquote class="mb mc md"><p id="1a21" class="ks kt me ku b kv lr jg kx ky ls jj la mf lt lc ld mg lu lf lg mh lv li lj lk hn dt translated">注:给出的所有计时都是在我的MacBook上运行的本地服务器上测量的。它只考虑了在2015 MBP上返回图像的函数的执行速度。不包括网络传输速度！</p></blockquote><h2 id="4cd3" class="ju jv if bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated">共享浏览器</h2><p id="c735" class="pw-post-body-paragraph ks kt if ku b kv kw jg kx ky kz jj la kf lb lc ld kj le lf lg kn lh li lj lk hn dt translated">池将允许我们保持少数浏览器实例打开，并在每个截图请求中重用它们。Puppeteer没有内置的池解决方案，但是有一些通用的库可用。我们将使用<code class="eh mi mj mk ml b"><a class="ae mm" href="https://www.npmjs.com/package/generic-pool" rel="noopener ugc nofollow" target="_blank">generic-pool</a></code>。</p><p id="2558" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">第一个池:</p><figure class="ll lm ln lo fq hw"><div class="bz el l di"><div class="lw lq l"/></div></figure><p id="a1c9" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">但是等等，我们也不需要为每个截图创建页面和设置视窗。让我们共享页面而不是浏览器:</p><figure class="ll lm ln lo fq hw"><div class="bz el l di"><div class="lw lq l"/></div></figure><p id="82d5" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">让我们更新我们的<code class="eh mi mj mk ml b">getChartImage</code>函数，从池中请求页面:</p><figure class="ll lm ln lo fq hw"><div class="bz el l di"><div class="lw lq l"/></div></figure><p id="4a46" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">后续截图平均时间现在降到了~1.58秒！<em class="me">(出于好奇，在没有页面的情况下，共享浏览器的平均时间是1.87秒)</em></p><blockquote class="mb mc md"><p id="f4f2" class="ks kt me ku b kv lr jg kx ky ls jj la mf lt lc ld mg lu lf lg mh lv li lj lk hn dt translated">更新:echojs的Michael J. Ryan敏锐地指出,你可以走得更远，让页面集中在一个浏览器上。浏览器实例的启动时间将会缩短。Chrome为每个标签/页面创建了一个独立的管理/运行过程！”<a class="ae mm" href="https://gist.github.com/anonymous/c3d9b0d51127ea0bd396432075b2990a" rel="noopener ugc nofollow" target="_blank">这里有一个链接，链接到一个更有效的要点getBrowserPool </a></p></blockquote><h2 id="a717" class="ju jv if bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated">利用“单页性”</h2><p id="d2ad" class="pw-post-body-paragraph ks kt if ku b kv kw jg kx ky kz jj la kf lb lc ld kj le lf lg kn lh li lj lk hn dt translated">SPAs的优势之一是浏览器不必在导航时重新加载所有资源和重新解析所有脚本。然而，通过每次调用<code class="eh mi mj mk ml b">page.goto</code>，我们在同一个应用内导航时不必要地触发了整个页面的重新加载。</p><p id="1797" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">这个问题的解决方案根据应用程序使用的框架和路由库而有所不同，但基本思想相当简单且可翻译</p><ol class=""><li id="1453" class="mn mo if ku b kv lr ky ls kf mp kj mq kn mr lk ms mt mu mv dt translated">在前端，公开路由功能，该功能将允许木偶师从全局上下文(即<code class="eh mi mj mk ml b">window</code>)触发路线导航</li><li id="bb3b" class="mn mo if ku b kv mw ky mx kf my kj mz kn na lk ms mt mu mv dt translated">同样在前端，做一个标志，让木偶师知道路线转换何时完成。</li><li id="9eea" class="mn mo if ku b kv mw ky mx kf my kj mz kn na lk ms mt mu mv dt translated">木偶师将标志翻转到<code class="eh mi mj mk ml b">false</code>，调用路由函数，并轮询标志的值，直到前端将其翻转到<code class="eh mi mj mk ml b">true</code>(表示路由更改完成)。</li></ol><p id="29b8" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">如果你的应用程序使用React和React-Router v4，你可以在应用程序的某个地方使用<code class="eh mi mj mk ml b">withRouter</code>来请求<code class="eh mi mj mk ml b">history</code>对象，然后将它粘贴到窗口中。例如</p><figure class="ll lm ln lo fq hw"><div class="bz el l di"><div class="lw lq l"/></div></figure><p id="325a" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">在我使用Vue 1.0和vue-router 0.7的情况下，我将这一行添加到根组件的<code class="eh mi mj mk ml b">ready</code>钩子中:</p><figure class="ll lm ln lo fq hw"><div class="bz el l di"><div class="lw lq l"/></div></figure><p id="6848" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">路由转换完成(数据加载和渲染完成)后，前端将翻转标志，向回发出信号，表示它已准备好拍摄屏幕截图:</p><figure class="ll lm ln lo fq hw"><div class="bz el l di"><div class="lw lq l"/></div></figure><p id="6fa5" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">让我们更新getChartImage以使用这些挂钩</p><figure class="ll lm ln lo fq hw"><div class="bz el l di"><div class="lw lq l"/></div></figure><p id="0034" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">一张截图现在只需要~860ms！我们已经设法将时间缩短到不到初始实施的四分之一。</p><p id="13f8" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">我们还可以做一件事—</p><h2 id="22a6" class="ju jv if bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated">记忆</h2><p id="499c" class="pw-post-body-paragraph ks kt if ku b kv kw jg kx ky kz jj la kf lb lc ld kj le lf lg kn lh li lj lk hn dt translated">如果我们不必在每次访问这些图像时都生成它们，我们会节省更多的资源。</p><p id="1e81" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">当有截图请求时，我们想—</p><ol class=""><li id="b1c4" class="mn mo if ku b kv lr ky ls kf mp kj mq kn mr lk ms mt mu mv dt translated">检查该资源的屏幕截图是否已经存在。</li><li id="e34a" class="mn mo if ku b kv mw ky mx kf my kj mz kn na lk ms mt mu mv dt translated">如果是，检查它是否过时，需要更新。</li><li id="96cc" class="mn mo if ku b kv mw ky mx kf my kj mz kn na lk ms mt mu mv dt translated">如果它存在并且没有过时，则直接返回该文件。</li><li id="5e85" class="mn mo if ku b kv mw ky mx kf my kj mz kn na lk ms mt mu mv dt translated">如果它不存在或需要更新，请创建一个新的快照。</li></ol><figure class="ll lm ln lo fq hw"><div class="bz el l di"><div class="lw lq l"/></div></figure><p id="75a3" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">就是这样！在某个时间段内的后续请求只需要0.3毫秒。下一步将是从CDN而不是本地文件系统保存和提供它，但我认为目前这已经足够好了:)数字海洋的droplet附带25g的SSD和1TB的传输，将在我需要时保存它。</p><p id="0739" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">希望这是有帮助的！非常感谢<a class="ae mm" href="https://twitter.com/hare_ben" rel="noopener ugc nofollow" target="_blank"> Ben Hare </a>和<a class="ae mm" href="https://twitter.com/jephuff" rel="noopener ugc nofollow" target="_blank"> Jeffrey Burt </a>对草稿的反馈，以及<a class="ae mm" href="https://twitter.com/tracker1?lang=en" rel="noopener ugc nofollow" target="_blank"> Michael J. Ryan </a>的建议和更正！</p><p id="2c08" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">请到我的网站<a class="ae mm" href="https://npmcharts.com" rel="noopener ugc nofollow" target="_blank">npmcharts.com</a>查看你所有的npm包比较需求！以下是webpack、browserify、rollup和package中的一个:—</p><figure class="ll lm ln lo fq hw"><div class="bz el l di"><div class="lp lq l"/></div><figcaption class="lx ly fg fe ff lz ma bd b be z ek"><a class="ae mm" href="https://github.com/cheapsteak/npmcharts.com" rel="noopener ugc nofollow" target="_blank">Project source available on Github.</a> Thanks to <a class="ae mm" href="http://twitter.com/osdevisnot" rel="noopener ugc nofollow" target="_blank">@osdevisnot</a> for pointing out the previous chart included “parcel”, which should have been “parcel-bundler” instead!</figcaption></figure><figure class="ll lm ln lo fq hw fe ff paragraph-image"><div class="fe ff nb"><img src="../Images/afbddd178e9dacb217be56e70226c8a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:240/format:webp/1*pTYpcACwtvhvyFJLLTYqtQ.png"/></div></figure><p id="3da2" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated">🐥<a class="ae mm" href="https://twitter.com/CheapSteak" rel="noopener ugc nofollow" target="_blank">发微博给我@Cheapsteak </a></p><p id="2858" class="pw-post-body-paragraph ks kt if ku b kv lr jg kx ky ls jj la kf lt lc ld kj lu lf lg kn lv li lj lk hn dt translated"><em class="me">🦈</em> <a class="ae mm" href="https://m.do.co/c/91557a2689b0" rel="noopener ugc nofollow" target="_blank"> <em class="me">数字海洋10美元推介链接</em> </a></p></div></div>    
</body>
</html>