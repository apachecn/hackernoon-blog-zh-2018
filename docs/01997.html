<html>
<head>
<title>Building a location app with ARKit, CoreLocation and Pusher</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用ARKit、CoreLocation和Pusher构建定位应用</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/building-a-location-app-with-arkit-corelocation-and-pusher-bee44fdec44f?source=collection_archive---------6-----------------------#2018-03-05">https://medium.com/hackernoon/building-a-location-app-with-arkit-corelocation-and-pusher-bee44fdec44f?source=collection_archive---------6-----------------------#2018-03-05</a></blockquote><div><div class="eg hj hk hl hm hn"/><div class="ho hp hq hr hs"><div class=""/><figure class="fj fl it iu iv iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg is"><img src="../Images/fb486571f8fd94cab8c2fa2d515e77d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DeumzRCggN3IJvxEIkBreQ.jpeg"/></div></div></figure><blockquote class="jd je jf"><p id="0157" class="jg jh ji jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke ho dt translated">披露:<a class="ae kf" href="https://goo.gl/52hnDL" rel="noopener ugc nofollow" target="_blank">为开发者提供实时API的Pusher </a>，此前曾赞助过黑客Noon。</p></blockquote><p id="71ef" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">增强现实(AR)有很多有趣且实用的用例。其中之一是位置。</p><p id="03b9" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">在iOS 11中，使用ARKit创建AR应用程序并将其与多个库相结合的能力打开了很多可能性。</p><p id="158c" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">在本教程中，我们将结合ARKit、CoreLocation和Pusher的力量来创建一个地理定位AR应用程序。</p><p id="9d96" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">让我们想想出租车服务。一些服务允许你在地图上跟踪将要接你的汽车，但如果有一个ar视图来查看汽车的路线以及它是如何靠近你的，这不是很好吗？</p><p id="5980" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">大概是这样的:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="kn ko l"/></div></figure><p id="f5b7" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">正如您所看到的，在ar世界中定位汽车的信息并不总是准确的，无论是在CoreLocation端还是在ARKit端，但是，对于这个用例，大多数时候这就足够了。</p><p id="e341" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">这是你需要的:</p><ul class=""><li id="5941" class="kp kq hv jj b jk jl jo jp kg kr kh ks ki kt ke ku kv kw kx dt translated">采用A9或更高版本处理器的设备(iPhone 6s或更高版本、iPhone SE、任何iPad Pro或2017款iPad)</li><li id="3d87" class="kp kq hv jj b jk ky jo kz kg la kh lb ki lc ke ku kv kw kx dt translated">iOS 11</li><li id="d69a" class="kp kq hv jj b jk ky jo kz kg la kh lb ki lc ke ku kv kw kx dt translated"><a class="ae kf" href="https://developer.apple.com/download/" rel="noopener ugc nofollow" target="_blank"> Xcode 9.1 </a>(或更新版本)</li><li id="3181" class="kp kq hv jj b jk ky jo kz kg la kh lb ki lc ke ku kv kw kx dt translated">汽车的3D模型(DAE格式)</li></ul><p id="9516" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">你可以在像<a class="ae kf" href="https://free3d.com" rel="noopener ugc nofollow" target="_blank"> Free3D </a>、<a class="ae kf" href="https://www.turbosquid.com/" rel="noopener ugc nofollow" target="_blank"> Turbosquid </a>或<a class="ae kf" href="https://poly.google.com" rel="noopener ugc nofollow" target="_blank">谷歌的Poly </a>这样的网站上找到免费的3D模型。</p><p id="d2c3" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">最常见的格式是OBJ(其纹理定义在MTL文件中)，可以使用Blender之类的程序将其转换为DAE。</p><p id="e780" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">对于这个项目，我选择了<a class="ae kf" href="https://free3d.com/3d-model/low-poly-car-40967.html" rel="noopener ugc nofollow" target="_blank">这个型号</a>，它有DAE格式。</p><p id="48cc" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">这个项目的数学有点难。我将花更多的时间来解释与地理定位相关的操作，而不是用ARKit旋转和平移模型。</p><p id="9ede" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">如果你不知道转换矩阵或者如何将你的3D模型转换成DAE格式，看看我以前的关于ARKit的教程。</p><p id="7181" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">作为参考，这个项目的源代码在<a class="ae kf" href="https://github.com/eh3rrera/ARKitAnimation" rel="noopener ugc nofollow" target="_blank"> Git </a> <a class="ae kf" href="https://github.com/eh3rrera/ARKitCarGeolocation" rel="noopener ugc nofollow" target="_blank"> Hub </a>上。</p><p id="48be" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">先来设置一个推送app。</p><h1 id="9881" class="ld le hv bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma dt translated">设置推动器</h1><p id="aae7" class="pw-post-body-paragraph jg jh hv jj b jk mb jm jn jo mc jq jr kg md ju jv kh me jy jz ki mf kc kd ke ho dt translated">如果你还没有，在<a class="ae kf" href="https://pusher.com/" rel="noopener ugc nofollow" target="_blank">推送器</a>创建一个免费账户。然后，转到您的仪表盘，创建一个应用程序，选择一个名称、离您最近的集群和作为您的前端技术的<em class="ji"> iOS </em>:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg mg"><img src="../Images/efde67f8dd67bbd34c240de86ab9eccb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HvIfME39SMf9z_syJqUHLw.png"/></div></div></figure><p id="707a" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">这将为您提供一些开始使用的示例代码:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg mh"><img src="../Images/7d8fae0f3eeadbe3583cdf4e0384f5a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4itzMt0FciChOXrM5KuU6A.png"/></div></div></figure><p id="cdce" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">保存你的应用id、密钥、密码和聚类值。我们以后会需要它们。</p><p id="b922" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">最后，转到<em class="ji">应用设置</em>选项卡，选中选项<em class="ji">启用客户端事件</em>并点击<em class="ji">更新</em>:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg mi"><img src="../Images/296dcc0c541fbdd7e876b1c8a039cff7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CTXdVhCb2_dtcaoORNsjLA.png"/></div></div></figure><p id="ecd4" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">通过这个应用程序，司机将发送他们的位置作为纬度/经度坐标，以及他们前进的方向(以度为单位)，作为客户端<a class="ae kf" href="https://pusher.com/docs/client_api_guide/client_events" rel="noopener ugc nofollow" target="_blank">事件</a>。</p><p id="7492" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">但是先不要操之过急，先把Xcode项目设置好。</p><h1 id="a8d4" class="ld le hv bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma dt translated">设置项目</h1><p id="1061" class="pw-post-body-paragraph jg jh hv jj b jk mb jm jn jo mc jq jr kg md ju jv kh me jy jz ki mf kc kd ke ho dt translated">打开Xcode 9，创建一个新的<em class="ji">单视图应用</em>:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg mj"><img src="../Images/885410aa1285b8ba119b68d4e0303b0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4RAguNwZTCeOUirUbQau-w.png"/></div></div></figure><p id="f393" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">我们选择此选项是因为我们将手动设置AR视图以及其他控件。</p><p id="78d5" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">输入项目信息，选择<em class="ji"> Swift </em>作为语言:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg mj"><img src="../Images/743ee00a1d199b6f972212b8aff2a4d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zwx9XOOApU9Z62UHyan6nQ.png"/></div></div></figure><p id="2aca" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">创建项目并关闭它。我们将使用<a class="ae kf" href="https://cocoapods.org/" rel="noopener ugc nofollow" target="_blank"> CocoaPods </a>来安装项目的依赖项。打开一个终端窗口，转到项目的根目录，如果您没有安装CocoaPods(或者如果您想更新它)，请执行:</p><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="17f2" class="mp le hv ml b fw mq mr l ms mt">sudo gem install cocoapods</span></pre><p id="839f" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">安装后，使用以下命令创建文件Podfile:</p><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="d669" class="mp le hv ml b fw mq mr l ms mt">pod init</span></pre><p id="97c7" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">编辑该文件，将平台设置为iOS 11，并将<a class="ae kf" href="https://github.com/pusher/pusher-websocket-swift" rel="noopener ugc nofollow" target="_blank"> Pusher的Swift库</a>添加为项目的依赖项；</p><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="0ecd" class="mp le hv ml b fw mq mr l ms mt"># Uncomment the next line to define a global platform for your project</span><span id="0dbd" class="mp le hv ml b fw mu mr l ms mt">platform :ios, '11.0'</span><span id="015f" class="mp le hv ml b fw mu mr l ms mt">target 'ARKitCarGeolocation' do</span><span id="cba7" class="mp le hv ml b fw mu mr l ms mt"># Comment the next line if you're not using Swift and don't want to use dynamic frameworks</span><span id="f35e" class="mp le hv ml b fw mu mr l ms mt">use_frameworks!</span><span id="faf5" class="mp le hv ml b fw mu mr l ms mt"># Pods for ARKitCarGeolocation</span><span id="7533" class="mp le hv ml b fw mu mr l ms mt">pod 'PusherSwift', '~&gt; 5.1.1'</span><span id="c813" class="mp le hv ml b fw mu mr l ms mt">end</span></pre><p id="c7c1" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">编辑完Podfile后，执行以下命令来安装依赖项:</p><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="f47d" class="mp le hv ml b fw mq mr l ms mt">pod install</span></pre><p id="f573" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">如果没有安装版本5.1.1(或更高版本)(安装的输出将告诉您已安装的版本),您可以使用以下命令更新您的CocoaPod存储库并安装最新版本的库:</p><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="2fa7" class="mp le hv ml b fw mq mr l ms mt">pod install --repo-update</span></pre><p id="6763" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">现在打开Xcode工作空间，而不是项目文件。工作区已经配置了相关性:</p><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="1199" class="mp le hv ml b fw mq mr l ms mt">open ARKitCarGeolocation.xcworkspace</span></pre><p id="7038" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">如果此时构建项目，可能会出现一些警告，但是操作应该会成功。</p><p id="3428" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">接下来，选择Info.plist文件，添加一行类型为<em class="ji">Privacy-Camera Usage Description</em>(<code class="ei mv mw mx ml b">NCameraUsageDescription</code>)的内容，并对其进行描述。这是ARKit访问摄像机所必需的。</p><p id="e271" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">我们还需要一行类型为<em class="ji">Privacy-Location When In Use用法描述</em> ( <code class="ei mv mw mx ml b">NSLocationWhenInUseUsageDescription</code>)的数据，这是从您设备的GPS获取位置所必需的(仅当应用程序正在使用时，而不是一直使用):</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg my"><img src="../Images/3c31e681081f37011164808e1b2398ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kF-5k1GDkN4lbGaNtMVj1w.png"/></div></div></figure><p id="c337" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">最后，配置一个团队，以便您可以在您的设备上运行应用程序:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg mz"><img src="../Images/f94a6804e3f01235b075a5b6844f11af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mdu851D-uuH36WtRMVK-BA.png"/></div></div></figure><p id="478a" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">现在让我们来构建用户界面。</p><h1 id="dbdd" class="ld le hv bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma dt translated">构建用户界面</h1><p id="37b1" class="pw-post-body-paragraph jg jh hv jj b jk mb jm jn jo mc jq jr kg md ju jv kh me jy jz ki mf kc kd ke ho dt translated">转到Main.storyboard并将一个<em class="ji"> ARKit SceneKit视图</em>拖到视图中:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg na"><img src="../Images/ceff6fc699cd0848b9a1f0bf6e2dc4f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PRQsmPSpB3YmEcFAvBnIYQ.png"/></div></div></figure><p id="38cd" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">接下来，向该视图的所有边添加约束，使其充满整个屏幕。您可以通过按下<code class="ei mv mw mx ml b">ctrl</code>键，同时从<code class="ei mv mw mx ml b">ARSCNView</code>向父视图的每一侧拖动一条线，并选择超级视图的前导、顶部、尾部和底部，值为<code class="ei mv mw mx ml b">0</code>:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg nb"><img src="../Images/b00f3371982315f64620b468953d5ec7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CvFqveLoxbeTSy25MWbOXw.png"/></div></div></figure><p id="a45f" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">接下来，添加一个文本视图，并在<em class="ji">属性检查器</em>中禁用其<em class="ji">可编辑</em>和<em class="ji">可选</em>行为</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg na"><img src="../Images/38cb6af2a61d6bf3ebcbb9d8b36171a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PTQqAmEmcAmmOON4dEtYGw.png"/></div></div></figure><p id="a347" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">改变它的背景颜色(我选择了一个白色和<code class="ei mv mw mx ml b">50%</code>不透明):</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg na"><img src="../Images/971f95aa967546a831f2fe02b02fe74b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cLnV-ZXTilvdxxyLq3mB9w.png"/></div></div></figure><p id="8367" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">添加值为<code class="ei mv mw mx ml b">90</code>的高度约束以及值为<code class="ei mv mw mx ml b">0</code>的前导、顶部和尾部约束，使其保持固定在屏幕顶部:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg na"><img src="../Images/802869be4d221e30f155298baad1d2f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HxXJTpubLGmPdd-QEOMfYw.png"/></div></div></figure><p id="ba8d" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">在<code class="ei mv mw mx ml b">ViewController.swift</code>中导入ARKit:</p><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="ea2a" class="mp le hv ml b fw mq mr l ms mt">import ARKit</span></pre><p id="3926" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">然后，创建两个<code class="ei mv mw mx ml b">IBOutlet</code>，一个到场景视图，另一个到文本视图:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg nc"><img src="../Images/42e7f90034d3dd948a6ad2eb6223d959.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G0VVVvN49ZAQZUllJZ5vjQ.png"/></div></div></figure><p id="d7c0" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">你已经准备好开始编写应用程序了，但在此之前，让我解释一下需要做什么。但是，如果您已经熟悉地理定位概念或者不感兴趣，可以跳过下一部分。</p><h1 id="d5c6" class="ld le hv bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma dt translated">了解应用程序的工作原理</h1><p id="6225" class="pw-post-body-paragraph jg jh hv jj b jk mb jm jn jo mc jq jr kg md ju jv kh me jy jz ki mf kc kd ke ho dt translated">想象你正站在世界的某个地方。你看的地方或方向并不重要。</p><p id="862a" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">你的位置由两个数字给出，纬度和经度。</p><p id="2e93" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">纬度是北极或南极与赤道(地球两极中间的假想圆)之间的距离。赤道以北的地方从<code class="ei mv mw mx ml b">0º</code>到<code class="ei mv mw mx ml b">90º</code>，赤道以南的地方从<code class="ei mv mw mx ml b">0º</code>到<code class="ei mv mw mx ml b">-90º</code>。</p><p id="3ccd" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">经度是从本初子午线(一条从北到南穿过英格兰格林威治的假想线)到西方或东方一点的距离。本初子午线以东的地方从<code class="ei mv mw mx ml b">0</code>到<code class="ei mv mw mx ml b">180º</code>，本初子午线以西的地方从<code class="ei mv mw mx ml b">0º</code>到<code class="ei mv mw mx ml b">-180º</code>。</p><p id="c4b3" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">例如，如果你在巴西，你的纬度和经度将是负的，因为你在地球的西南方:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg nd"><img src="../Images/5d4b70ac2c32be2225a9bf652b878426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WrkK6w8R6jTEVByea13zpA.png"/></div></div></figure><p id="d7e8" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">例如，如果你在日本，你的纬度和经度将是正的，因为你在地球的东北面:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg na"><img src="../Images/526c41178cd1490ef64e691700a62f66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nPrHxbtBIr2OIVFP4TmWdg.png"/></div></div></figure><p id="dcbd" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">该应用程序将考虑您和驾驶员在经纬度坐标系中的位置:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg ne"><img src="../Images/8e93acde2e9d45489c9751a2515e8f0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IEqJ5b3PnOQdYGLmnMILag.png"/></div></div></figure><p id="a1a8" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">但是如果对你来说比较容易，你可以把你的位置想象成原点(<code class="ei mv mw mx ml b">0</code>，<code class="ei mv mw mx ml b">0</code>):</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg nf"><img src="../Images/6841a0e565965bb8fb1e5cfef761890d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6RsChcxgvMvDZSB2Xd_ZiA.png"/></div></div></figure><p id="0194" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">你需要计算两件事:</p><ul class=""><li id="6282" class="kp kq hv jj b jk jl jo jp kg kr kh ks ki kt ke ku kv kw kx dt translated">你和司机之间的距离</li><li id="7574" class="kp kq hv jj b jk ky jo kz kg la kh lb ki lc ke ku kv kw kx dt translated">地球北(或南)线与你和驾驶员连线的夹角，称为<a class="ae kf" href="https://en.wikipedia.org/wiki/Bearing_(navigation)" rel="noopener ugc nofollow" target="_blank">方位</a>。</li></ul><figure class="kj kk kl km fr iw ff fg paragraph-image"><div class="ff fg ng"><img src="../Images/f7bb3876e1e08787983094664b2f6560.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*ZW4RrhKKuCrCAzNaw_AOew.png"/></div></figure><p id="dd23" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">距离会告诉你在ar世界中你必须定位3D模型多远。</p><p id="8684" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">方位角将帮助您创建旋转变换，以在上述距离的正确方向上定位您的模型。</p><p id="6af4" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">如果我们谈论的是一个简单的x和y坐标系统，我们可以通过应用<a class="ae kf" href="https://en.wikipedia.org/wiki/Pythagorean_theorem" rel="noopener ugc nofollow" target="_blank">勾股定理</a>和一些简单的三角学，以及<a class="ae kf" href="https://en.wikipedia.org/wiki/Sine" rel="noopener ugc nofollow" target="_blank">正弦</a>和<a class="ae kf" href="https://en.wikipedia.org/wiki/Law_of_cosines" rel="noopener ugc nofollow" target="_blank">余弦</a>运算来获得这些计算。</p><p id="c7d3" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">但是我们谈论的是地球的纬度和经度。由于地球不是一个平面，数学变得更加复杂。</p><p id="eb76" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">通过调用类<a class="ae kf" href="https://developer.apple.com/documentation/corelocation/cllocation" rel="noopener ugc nofollow" target="_blank"> CLLocation </a>的<a class="ae kf" href="https://developer.apple.com/documentation/corelocation/cllocation/1423689-distance" rel="noopener ugc nofollow" target="_blank">方法</a>来计算距离。它使用<a class="ae kf" href="http://www.igismap.com/haversine-formula-calculate-geographic-distance-earth/" rel="noopener ugc nofollow" target="_blank">哈弗辛公式</a>，该公式从两个不同的纬度/经度值对中，通过沿着地球曲率在它们之间描绘一条线来计算距离。</p><p id="940d" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">另一方面，我们必须手动计算两个不同纬度/经度值对之间的方位角。<a class="ae kf" href="http://www.igismap.com/formula-to-find-bearing-or-heading-angle-between-two-points-latitude-longitude/" rel="noopener ugc nofollow" target="_blank">这是公式</a>:</p><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="d3f0" class="mp le hv ml b fw mq mr l ms mt">atan2 ( X, Y )</span></pre><p id="245e" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">其中<code class="ei mv mw mx ml b">X</code>等于:</p><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="3044" class="mp le hv ml b fw mq mr l ms mt">sin(long2 - long1) * cos(long2)</span></pre><p id="92b4" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">并且<code class="ei mv mw mx ml b">Y</code>等于:</p><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="bbc1" class="mp le hv ml b fw mq mr l ms mt">cos(lat1) * sin(lat2) - sin(lat1) * cos(lat2) * cos(long2 - long1)<!-- -->π</span></pre><p id="53d9" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">另一件要考虑的事情是，对于矩阵变换，你必须使用<a class="ae kf" href="https://en.wikipedia.org/wiki/Radian" rel="noopener ugc nofollow" target="_blank">弧度</a>而不是度作为角度单位。由于一整周的长度等于2π弧度(<code class="ei mv mw mx ml b">360º</code>，一弧度等于180/π度。</p><p id="c19b" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">这就是计划。</p><p id="932c" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">使用Pusher，司机将实时发布他们的位置和前进方向。</p><p id="5e1e" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">使用CoreLocation，AR应用程序将获得您的位置。它还会监听司机的位置更新。</p><p id="51b0" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">当收到位置更新时，使用上面解释的公式，应用程序将在ar世界中相对于您的位置放置一个汽车的3D模型，并将模型定向到司机前进的相同方向。</p><p id="6400" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">该应用程序只会获取你的位置一次，所以它假设你的位置是固定的(大多数情况下都是如此)。</p><p id="8e4a" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">此外，一个箭头表情符号(⬇️)将一直显示在模型的顶部，这样你就可以很容易地发现它，你在最后一部分添加的文本视图将显示应用程序的状态以及你和汽车之间的距离。</p><p id="bf7d" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">既然你知道该做什么，让我们进入代码。</p><h1 id="e621" class="ld le hv bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma dt translated">使用ARKit和CoreLocation构建应用程序</h1><p id="a755" class="pw-post-body-paragraph jg jh hv jj b jk mb jm jn jo mc jq jr kg md ju jv kh me jy jz ki mf kc kd ke ho dt translated">让我们从定义两个扩展开始。</p><p id="f180" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">一个提供所有浮点类型的弧度和度数的转换方法。创建一个新的Swift文件<code class="ei mv mw mx ml b">FloatingPoint+Extension.swift</code>，内容如下:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="96bf" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">和另一个从字符串创建图像的扩展。创建另一个Swift文件<code class="ei mv mw mx ml b">String+Extension.swift</code>，内容如下(摘自此<a class="ae kf" href="https://stackoverflow.com/a/47164529/3593852" rel="noopener ugc nofollow" target="_blank"> StackOverflow回答</a>):</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="2e60" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">您将使用这个扩展用箭头表情符号(一个字符串)创建一个图像。它创建了一个宽度为<code class="ei mv mw mx ml b">100</code>高度为<code class="ei mv mw mx ml b">100</code>的矩形，背景透明，在其中绘制字体大小为<code class="ei mv mw mx ml b">90</code>的字符串。</p><p id="c379" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">接下来，打开<em class="ji">新建文件</em>对话框，向下滚动选择<em class="ji">资产目录</em>类型:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg mj"><img src="../Images/40661c9dc66f3e3c25b37e9427aa4bd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_uY2Xvk5fEB55S7N6QGstg.png"/></div></div></figure><p id="72bc" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">输入<code class="ei mv mw mx ml b">art.scnassets</code>作为文件名(确认使用扩展名<code class="ei mv mw mx ml b">scnassets</code>):</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg ni"><img src="../Images/2a3dec39ee6691f87531c3d4e22790cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rdIoppj38aGgnJ1uWICRhA.png"/></div></div></figure><p id="05ff" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">现在将您的模型复制到这个文件夹:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg nj"><img src="../Images/4ecaddec1a2c48c416fc65efacea42ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yy1cBykppva-Os_G94AQYQ.png"/></div></div></figure><p id="28c4" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">打开场景图视图，选择模型的主节点，在properties选项卡中，给它一个名称，您将使用该名称在代码中引用它:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg nk"><img src="../Images/9dfbfe30ae8c8f2da81f6d54ef62662e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9NElW2cAkXWg1vAiKaZrAA.png"/></div></div></figure><p id="e904" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">回到<code class="ei mv mw mx ml b">ViewController.swift</code>，让我们添加我们需要的<code class="ei mv mw mx ml b">import</code>语句:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="2b50" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">控制器将使用的代理:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="e5b9" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">接下来，让我们添加一些实例变量。</p><p id="48d0" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">首先，一个<code class="ei mv mw mx ml b">CLLocationManager</code>请求用户位置，另一个变量存储它:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="8ad1" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">然后，一个变量存储司机前进的方向、他们与用户之间的距离以及应用程序的状态:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="1248" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">每当设置距离或状态的新值时，文本视图将会更新。请注意，距离是以米计算的。</p><p id="787c" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">接下来，使用一个变量来存储汽车模型的根节点和该节点的名称，该名称应该与您在SceneKit编辑器中设置的名称相同:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="ac28" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">您还需要该节点的原始(第一个)转换:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="ceb9" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">为什么？</p><p id="c15e" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">以尽可能好的方式计算模型的方向(旋转)。</p><p id="f834" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">理想情况下，驾驶员的设备将始终为您提供正确的方向，以便您可以获取第一个接收到的读数，在该方向上旋转模型，然后计算相对于第一个旋转的下一次旋转。</p><p id="eed6" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">然而，如果第一次读数是错误的(这种情况有时会发生)，即使其余的读数都是正确的，接下来的旋转也会是错误的。</p><p id="d4e8" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">因此，您总是需要计算方向，就好像这是您第一次旋转模型一样，因为一旦您将模型旋转到某个角度，随后的旋转将相对于该角度进行。由于变换的工作方式(矩阵乘法)，将旋转重置为<code class="ei mv mw mx ml b">0º</code>也不起作用。</p><p id="f0d4" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">最后，您需要存储Pusher对象和通道来接收更新:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="6366" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">注意<code class="ei mv mw mx ml b">authMethod</code>选项的值。</p><p id="a512" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">你将通过私人频道接收更新。它们需要被服务器认证。然而，在开发时，您可以使用<code class="ei mv mw mx ml b">inline</code>选项来绕过设置一个认证端点作为服务器一部分的需要。</p><p id="63eb" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">你可以在这里了解更多关于物体的选项<a class="ae kf" href="https://github.com/pusher/pusher-websocket-swift#configuration" rel="noopener ugc nofollow" target="_blank">。如果需要，您可以在这个页面</a>上学习如何创建一个<a class="ae kf" href="https://pusher.com/docs/authenticating_users#implementing_endpoints" rel="noopener ugc nofollow" target="_blank">认证端点。</a></p><p id="f95c" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">在<code class="ei mv mw mx ml b">viewDidLoad</code>功能中，设置SceneKit场景和位置服务:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="24bd" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">接下来，配置AR会话:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="b7c6" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">选项<a class="ae kf" href="https://developer.apple.com/documentation/arkit/arconfiguration.worldalignment/2873776-gravityandheading" rel="noopener ugc nofollow" target="_blank"> gravityAndHeading </a>会将y轴设置为设备检测到的重力方向，将x轴和z轴设置为定位服务测量到的经度和纬度方向。</p><p id="e48f" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">对于用户位置，当他们授权使用定位服务时，您必须请求位置(使用<a class="ae kf" href="https://developer.apple.com/documentation/corelocation/cllocationmanager/1620548-requestlocation" rel="noopener ugc nofollow" target="_blank"> requestLocation </a>方法，因此位置只被请求一次):</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="21fb" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">一旦接收到用户的位置，获取数组的最后一个元素，更新状态，并连接到Pusher(在获得用户位置之前连接到Pusher是没有意义的，因为所有的计算都是错误的):</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="7262" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">在方法<code class="ei mv mw mx ml b">connectToPusher</code>中，您订阅<code class="ei mv mw mx ml b">private-channel</code>，当接收到客户端新位置事件时，提取驾驶员的纬度、经度和方向，并使用方法<code class="ei mv mw mx ml b">updateLocation</code>更新3D模型的状态和位置:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="dd51" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">在<code class="ei mv mw mx ml b">updateLocation</code>中，创建一个<a class="ae kf" href="https://developer.apple.com/documentation/corelocation/cllocation" rel="noopener ugc nofollow" target="_blank"> CLLocation </a>对象来计算用户和驾驶员之间的距离。记住<a class="ae kf" href="https://developer.apple.com/documentation/corelocation/cllocation/1423689-distance" rel="noopener ugc nofollow" target="_blank">距离</a>是以米计算的:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="fcbf" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">如果这是收到的第一个更新，<code class="ei mv mw mx ml b">self.modelNode</code>将会是<code class="ei mv mw mx ml b">nil</code>，所以你必须实例化这个模型:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="1d02" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">接下来，您需要将模型的<a class="ae kf" href="https://developer.apple.com/documentation/scenekit/scnnode/1408044-pivot" rel="noopener ugc nofollow" target="_blank">枢轴</a>移动到y轴的中心，这样它就可以在不改变位置的情况下旋转:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="95b3" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">保存模型的变换以计算未来的旋转，定位它，并将其添加到场景中:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="b92e" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">注意，不需要创建一个<a class="ae kf" href="https://developer.apple.com/documentation/arkit/aranchor" rel="noopener ugc nofollow" target="_blank"> ARAnchor </a>来添加节点作为它的子节点。ARAnchor使您能够跟踪模型相对于相机的位置和方向。</p><p id="e4d7" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">但在这种情况下，最好直接和孩子一起工作。主要是因为您不能手动删除或更改整个<code class="ei mv mw mx ml b">ARAnchor</code>的位置——只能删除其子节点。</p><p id="f695" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">最后，从表情符号创建箭头，将其放置在汽车的顶部(使用y轴，我通过反复试验获得了该值)，并将其添加为模型的子元素(因此它会一直伴随着它):</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="0c39" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">这是<code class="ei mv mw mx ml b">makeBillboardNode</code>方法的定义(取自这个<a class="ae kf" href="https://stackoverflow.com/a/44403042/3593852" rel="noopener ugc nofollow" target="_blank"> StackOverflow答案</a>，修改了平面的宽度和高度，以便可以正确地看到箭头):</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="b266" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">现在，如果这不是第一次更新，你只需要定位模型，动画运动，使它看起来很好:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="297a" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">要定位模型，只需先旋转，然后将其平移到正确的位置并缩放:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="fbb9" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">顺序很重要，因为矩阵乘法是如何工作的(<code class="ei mv mw mx ml b">a*b</code>与<code class="ei mv mw mx ml b">b*a</code>不同)。</p><p id="80d3" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">在ARKit中，y轴上的旋转是逆时针的(并以弧度处理)，所以我们需要减去<code class="ei mv mw mx ml b">180º</code>，使角度为负。这是方法<code class="ei mv mw mx ml b">rotateNode</code>的定义:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="cbcf" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">我按距离的比例缩放节点。它们成反比——距离越大，比例越小。在我的例子中，我只是将<code class="ei mv mw mx ml b">1000</code>除以距离，不允许该值小于<code class="ei mv mw mx ml b">1.5</code>或大于<code class="ei mv mw mx ml b">3</code>:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="3f0b" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">我从反复试验中得到了这些值。它们会根据您使用的型号而有所不同。</p><p id="c79f" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">要转换节点，您必须计算转换矩阵并从该矩阵中获取位置值(从其第四列，由从零开始的索引引用):</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="c79a" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">要计算转换矩阵:</p><ul class=""><li id="bab7" class="kp kq hv jj b jk jl jo jp kg kr kh ks ki kt ke ku kv kw kx dt translated">你用一个单位矩阵(不一定要用相机的矩阵之类的，司机的位置和方位是独立于你的位置和方位的。</li><li id="bbaa" class="kp kq hv jj b jk ky jo kz kg la kh lb ki lc ke ku kv kw kx dt translated">您必须使用上一节中解释的公式来计算方位角:</li></ul><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="830d" class="mp le hv ml b fw mq mr l ms mt">atan2 (</span><span id="7559" class="mp le hv ml b fw mu mr l ms mt">  sin(long2 - long1) * cos(long2),</span><span id="2053" class="mp le hv ml b fw mu mr l ms mt">  cos(lat1) * sin(lat2) - sin(lat1) * cos(lat2) * cos(long2 - long1)</span><span id="1b02" class="mp le hv ml b fw mu mr l ms mt">)</span></pre><ul class=""><li id="b041" class="kp kq hv jj b jk jl jo jp kg kr kh ks ki kt ke ku kv kw kx dt translated">使用一个单位矩阵，得到一个使用该方位的y轴旋转矩阵。</li><li id="11fd" class="kp kq hv jj b jk ky jo kz kg la kh lb ki lc ke ku kv kw kx dt translated">距离由z轴给出，因此用z位置的距离创建一个四元素向量来获得一个平移矩阵。</li><li id="df53" class="kp kq hv jj b jk ky jo kz kg la kh lb ki lc ke ku kv kw kx dt translated">将两个矩阵相乘(记住，顺序很重要)来组合它们。</li><li id="53f8" class="kp kq hv jj b jk ky jo kz kg la kh lb ki lc ke ku kv kw kx dt translated">通过将上一步的结果乘以作为参数传递的矩阵，获得最终的转换。</li></ul><p id="7935" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">所有这些都是通过以下方法完成的:</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="636d" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">关于如何在y轴上旋转，该方法返回矩阵的逆矩阵，因为ARKit中的旋转是逆时针的。<a class="ae kf" href="https://math.stackexchange.com/a/1616461" rel="noopener ugc nofollow" target="_blank">这里有一个来自数学堆栈交换的答案，很好地解释了旋转矩阵</a>。</p><p id="b155" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">就这样，是时候测试这个应用了。</p><h1 id="1686" class="ld le hv bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma dt translated">测试应用程序</h1><p id="c2fb" class="pw-post-body-paragraph jg jh hv jj b jk mb jm jn jo mc jq jr kg md ju jv kh me jy jz ki mf kc kd ke ho dt translated">第一次运行该应用程序时，您必须授予相机权限:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div class="ff fg nl"><img src="../Images/83138526356086e7b9805097d4cfbc5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/1*-oe-046VBpdjHA9jvKbYNw.png"/></div></figure><p id="935d" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">以及位置服务:</p><figure class="kj kk kl km fr iw ff fg paragraph-image"><div class="ff fg nm"><img src="../Images/e771e6a82cb27e731aad069ad8b1b2ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*BXx5fypX942IJfdTuVNDzQ.png"/></div></figure><p id="9067" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">并等待几秒钟，以便应用程序可以获得位置并连接到Pusher。</p><p id="bb18" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">为了测试它，你需要有人在驾驶时发布位置事件。</p><p id="8dc0" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">在<a class="ae kf" href="https://github.com/eh3rrera/PublishLocationiOSPusher" rel="noopener ugc nofollow" target="_blank">这个GitHub资源库</a>上，你可以找到一个发布位置事件的iOS版app。</p><p id="3136" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">它使用CoreLocation，代码与上一节中显示的代码非常相似，但是它每一两秒钟请求一次位置信息。</p><p id="312f" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">需要注意的是，对于航向测量，重要的是将设备保持在驾驶员前进的方向。</p><p id="5258" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">为了快速测试，你可以使用<a class="ae kf" href="https://gist.github.com/eh3rrera/6a643e77d5dfdc6564b84921372f51ad" rel="noopener ugc nofollow" target="_blank">跟随Node.js脚本</a>每两秒手动发送一些位置坐标(你可以从这个站点获得<a class="ae kf" href="https://www.latlong.net/convert-address-to-lat-long.html" rel="noopener ugc nofollow" target="_blank">):</a></p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="nh ko l"/></div></figure><p id="c6b0" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">一旦你安装了Node.js，你只需要把这个脚本复制到一个文件，比如说<code class="ei mv mw mx ml b">publish.js</code>，用命令创建一个<code class="ei mv mw mx ml b">package.json</code>文件:</p><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="c94f" class="mp le hv ml b fw mq mr l ms mt">npm init</span></pre><p id="7f0f" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">安装<a class="ae kf" href="https://github.com/pusher/pusher-http-node" rel="noopener ugc nofollow" target="_blank"> Pusher Node.js库</a>，包括:</p><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="6bd4" class="mp le hv ml b fw mq mr l ms mt">npm install --save pusher</span></pre><p id="457c" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">输入您的推动器和位置信息，并使用以下命令执行脚本:</p><pre class="kj kk kl km fr mk ml mm mn aw mo dt"><span id="98b6" class="mp le hv ml b fw mq mr l ms mt">node publish.js</span></pre><p id="1051" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">一旦应用程序开始接收位置事件，汽车的3D模型将出现在它在现实世界中的方向(如果离你很远，尺寸会很小):</p><figure class="kj kk kl km fr iw"><div class="bz em l di"><div class="kn ko l"/></div></figure><h1 id="372a" class="ld le hv bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma dt translated">结论</h1><p id="df14" class="pw-post-body-paragraph jg jh hv jj b jk mb jm jn jo mc jq jr kg md ju jv kh me jy jz ki mf kc kd ke ho dt translated">您已经学习了如何结合ARKit、CoreLocation和Pusher的力量来创建AR应用程序。</p><p id="cdf5" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">您可以添加更多功能使其更加有用:</p><ul class=""><li id="9400" class="kp kq hv jj b jk jl jo jp kg kr kh ks ki kt ke ku kv kw kx dt translated">向屏幕添加更多信息。例如，您可以<a class="ae kf" href="https://stackoverflow.com/a/38977983/3593852" rel="noopener ugc nofollow" target="_blank">将驱动程序的坐标转换为地址</a>。</li><li id="617d" class="kp kq hv jj b jk ky jo kz kg la kh lb ki lc ke ku kv kw kx dt translated">添加地图，这样，除了看到3D模型在世界上移动，你还可以看到汽车在任何给定的时间在哪条街上。</li><li id="6b51" class="kp kq hv jj b jk ky jo kz kg la kh lb ki lc ke ku kv kw kx dt translated">增加更多的汽车型号。</li><li id="f29b" class="kp kq hv jj b jk ky jo kz kg la kh lb ki lc ke ku kv kw kx dt translated">改变机械装置以获得汽车方向。例如，通过使用位置的增量。</li></ul><p id="4361" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">但是，请记住，应用程序取决于接收到的信息的质量。</p><p id="8af4" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">在我的测试中，在启动司机应用程序后的几秒钟内，航向信息完全错误，总体而言，位置偏离了几米。</p><p id="9fed" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">ARKit偶尔也会感到困惑。有时这可能是一个问题，这是另一个需要改进的地方。然而，我们才刚刚开始。毫无疑问，随着时间的推移，这些框架将会得到改进。</p><p id="bb53" class="pw-post-body-paragraph jg jh hv jj b jk jl jm jn jo jp jq jr kg jt ju jv kh jx jy jz ki kb kc kd ke ho dt translated">记住你可以在这个<a class="ae kf" href="https://github.com/eh3rrera/ARKitCarGeolocation" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>上找到整个项目，如果你有问题可以联系我。</p><blockquote class="jd je jf"><p id="5f63" class="jg jh ji jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke ho dt translated">最初发表于<a class="ae kf" href="https://blog.pusher.com/realtime-location-app-arkit-corelocation-pusher/" rel="noopener ugc nofollow" target="_blank">推手的博客</a>。</p></blockquote></div></div>    
</body>
</html>