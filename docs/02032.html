<html>
<head>
<title>Rails respond_to block Explained</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解释了Rails对块的响应</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/rails-respond-to-block-explained-1563773d23a3?source=collection_archive---------41-----------------------#2018-03-05">https://medium.com/hackernoon/rails-respond-to-block-explained-1563773d23a3?source=collection_archive---------41-----------------------#2018-03-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="2644" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当您启动第一个Rails应用程序时，您可能会认为<strong class="it hv">控制器动作</strong>只能呈现HTML。那么为什么以及如何使用<strong class="it hv"> respond_to </strong>块呢？在这里，我们将向您展示<strong class="it hv"> respond_to </strong>块有多方便。</p><p id="417e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">第一步是创建一个新项目，并在Rails中生成一个<a class="ae jp" href="https://kolosek.com/rails-scaffold/" rel="noopener ugc nofollow" target="_blank">脚手架</a>。让我们来看看我们的一些控制器动作。</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="447b" class="jz ka hu jv b fv kb kc l kd ke">def index<br/>  @blogs = Blog.all<br/>end</span></pre><p id="45ec" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如您所见，<code class="eh kf kg kh jv b">index</code>动作没有<code class="eh kf kg kh jv b">respond_to</code>块。所以，这在渲染HTML时是可行的。但是，如果客户要求获得文本格式的页面，该怎么办呢？这将导致一个<strong class="it hv">异常</strong>:</p><p id="01b3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh kf kg kh jv b">ActionView::MissingTemplate (Missing template blogs/index ... with { ... :formats=&gt;[:text], ...})</code></p><blockquote class="ki kj kk"><p id="f8df" class="ir is kl it b iu iv iw ix iy iz ja jb km jd je jf kn jh ji jj ko jl jm jn jo hn dt translated">Rails检查注册的格式，并试图为请求中的<a class="ae jp" href="https://github.com/rails/rails/blob/4f6f43338f7e4d3a3fe5ad86d024007ee95a7389/actionpack/lib/action_dispatch/http/mime_types.rb" rel="noopener ugc nofollow" target="_blank"> MIME类型找到兼容的格式。如果没有处理程序，它将引发一个错误。最大的</a><a class="ae jp" href="https://stackoverflow.com/questions/30600864/rails-respond-to-blocks-and-format/30601162#30601162" rel="noopener ugc nofollow" target="_blank">信用</a>。</p></blockquote><p id="8880" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们不是告诉我们的客户<strong class="it hv">文件丢失了</strong>，而是想告诉他们<strong class="it hv">请求格式不被支持</strong>。您可以在您的<code class="eh kf kg kh jv b">index</code>动作中添加一个<code class="eh kf kg kh jv b">respond_to</code>块:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="1d7b" class="jz ka hu jv b fv kb kc l kd ke">def index<br/>  @blogs = Blog.all</span><span id="b3bc" class="jz ka hu jv b fv kp kc l kd ke">   respond_to do |format|<br/>     format.html # index.html<br/>     format.js # index.js<br/>     format.xml { render xml: @blogs }<br/>   end<br/>end</span></pre><p id="ed70" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">更改后，客户端会在不支持格式时得到<code class="eh kf kg kh jv b">406 error</code>。另外，您的<code class="eh kf kg kh jv b">index</code>动作将响应两种新格式:js和xml。</p><p id="402b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你需要一个简单快捷的方法来渲染你的对象，你可以使用这个<strong class="it hv">快捷键</strong>，它的工作方式和上面的例子一样:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="c97d" class="jz ka hu jv b fv kb kc l kd ke">def index<br/>  @blogs = Blog.all<br/>  respond_to :html, :json, :xml<br/>end</span></pre><p id="69a0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不确定这是否真的有效？继续使用<a class="ae jp" href="https://kolosek.com/rails-rspec-setup/" rel="noopener ugc nofollow" target="_blank"> RSpec </a>和<a class="ae jp" href="https://kolosek.com/factory-girl-associations/" rel="noopener ugc nofollow" target="_blank"> FactoryBot </a>进行测试！</p><p id="ae58" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你能有一个<code class="eh kf kg kh jv b">respond_to</code>来影响<em class="kl">整个</em>控制器就好了。通常，控制器中的每个动作都可以使用相同的格式，你可以通过使用<code class="eh kf kg kh jv b">respond_with</code>来实现这一点。下面是一个如何实现它的示例:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="9956" class="jz ka hu jv b fv kb kc l kd ke">class BlogController &lt; ApplicationController<br/>  respond_to :html, :json, :xml</span><span id="2136" class="jz ka hu jv b fv kp kc l kd ke">  # GET /blogs<br/>  # GET /blogs.json<br/>  # GET /blogs.xml<br/>  def inde<br/>    @blogs = Blog.all<br/>    respond_with(@blogs)<br/>  end<br/>end</span></pre><p id="9fe7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您需要更多的控制，并希望能够有几个不同的动作，您总是可以使用完整的respond_to块。</p><p id="2921" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在Rails 4.2中，<code class="eh kf kg kh jv b">respond_with</code>不再包含在内。但是如果你<a class="ae jp" href="https://kolosek.com/rails-bundle-install-and-gemfile/" rel="noopener ugc nofollow" target="_blank">安装了响应宝石</a>就可以拿回来。一旦你安装并生成了一个<a class="ae jp" href="https://kolosek.com/rails-scaffold/" rel="noopener ugc nofollow" target="_blank">轨道脚手架</a>，生成器将使用<code class="eh kf kg kh jv b">respond_with</code>而不是<code class="eh kf kg kh jv b">respond_to</code>来创建控制器。</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="8c36" class="jz ka hu jv b fv kb kc l kd ke">class BlogController &lt; ApplicationController<br/>  before_action :set_blog, only: [:show, :edit, :update, :destroy]<br/>  respond_to :html, :json</span><span id="276a" class="jz ka hu jv b fv kp kc l kd ke">  def index<br/>    @blogs = Blog.all<br/>    respond_with(@blogs)<br/>  end<br/>  ...<br/>end</span></pre><h1 id="e919" class="kq ka hu bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm dt translated">全部格式化还是任意格式化？</h1><p id="e310" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc lp je jf jg lq ji jj jk lr jm jn jo hn dt translated">如果您想指定一个<code class="eh kf kg kh jv b">respond_to</code>来呈现所有格式的内容，同时保持其他选项不变，您可以按以下方式使用<strong class="it hv"> format.all </strong>:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="64b2" class="jz ka hu jv b fv kb kc l kd ke">respond_to do |format|<br/>  format.csv { render_csv }<br/>  format.all { render_404 }<br/>end</span></pre><p id="e106" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用<strong class="it hv"> format.any </strong>如果你想指定一个不同格式的公共块:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="947e" class="jz ka hu jv b fv kb kc l kd ke">def index<br/>  @blogs = Blog.all</span><span id="2ac0" class="jz ka hu jv b fv kp kc l kd ke"><br/>  respond_to do |format|<br/>    format.html<br/>    format.any(:xml, :json) {<br/>      render request.format.to_sym @blogs<br/>    }<br/>  end<br/>end</span></pre><p id="b4f5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所有的<a class="ae jp" href="https://kolosek.com/rspec-controller-test/" rel="noopener ugc nofollow" target="_blank">控制器动作</a>都需要测试，以确保它们按预期工作！</p><h1 id="1c1d" class="kq ka hu bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm dt translated">定义自定义MIME类型</h1><p id="4a72" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc lp je jf jg lq ji jj jk lr jm jn jo hn dt translated">如果您需要使用默认情况下不支持的MIME类型，您可以在<code class="eh kf kg kh jv b">config/initializers/mime_types.rb</code>中注册自己的处理程序:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="f146" class="jz ka hu jv b fv kb kc l kd ke">Mime::Type.register "text/markdown", :markdown</span></pre><p id="8d5c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本文到此为止！感谢您花时间阅读它！</p></div><div class="ab cl ls lt hc lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hn ho hp hq hr"><p id="94d8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kl">原载于2018年3月5日</em><a class="ae jp" href="https://kolosek.com/rails-respond_to-block/" rel="noopener ugc nofollow" target="_blank"><em class="kl">kolosek.com</em></a><em class="kl">。</em></p></div></div>    
</body>
</html>