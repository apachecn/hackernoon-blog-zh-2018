<html>
<head>
<title>Phasing out Python runtimes gracefully</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">逐步淘汰Python运行时</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/phasing-out-python-runtimes-gracefully-956f112f33c4?source=collection_archive---------30-----------------------#2018-03-06">https://medium.com/hackernoon/phasing-out-python-runtimes-gracefully-956f112f33c4?source=collection_archive---------30-----------------------#2018-03-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="6e27" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于任何包维护者来说，放弃对Python运行时的支持都是一项棘手的任务。</p><p id="1ba0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Python 2.6不再维护，3.3现在也不再维护，两者都与2.7和3.4中的公共子集有语法差距。当您可能希望以后只在一个包中提供Python 3支持时，您不希望完全冷落您的Python 2用户。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/882a9ea590f74cfd37d5174e89f42939.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ofcDyeotjvmRp_MZd_ikRw.png"/></div></div></figure><p id="98d0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Python打包权威机构一直致力于解决这个问题，结合了对PyPi(打包服务)、打包API、Pip(命令行安装程序)、setuptools(用于创建元数据的库)和元数据格式的更新。所有这些变化加在一起，允许包维护者向旧的Python运行时发布“维护版本”,向受支持的Python运行时发布新版本。</p><h1 id="c1ac" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">今天它是如何工作的</h1><p id="11a4" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">要将包发布到PyPi，您需要遵循3个步骤:</p><ol class=""><li id="dc31" class="le lf hu it b iu iv iy iz jc lg jg lh jk li jo lj lk ll lm dt translated">定义一个setup.py文件，其中包含distutils或setuptools，并使用一些关于包的信息调用<code class="eh ln lo lp lq b">setup(</code></li><li id="e089" class="le lf hu it b iu lr iy ls jc lt jg lu jk lv jo lj lk ll lm dt translated">如果您想包含一个车轮文件，请调用<code class="eh ln lo lp lq b">python setup.py sdist</code>或<code class="eh ln lo lp lq b">python setup.py sdist bdist_wheel</code></li><li id="5fcf" class="le lf hu it b iu lr iy ls jc lt jg lu jk lv jo lj lk ll lm dt translated">使用<code class="eh ln lo lp lq b">twine upload dist/*</code>将包上传到PyPi。</li></ol><h2 id="afe6" class="lw kc hu bd kd lx ly lz kh ma mb mc kl jc md me kp jg mf mg kt jk mh mi kx mj dt translated">定义PKG信息</h2><p id="662b" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">在Python源文件包(您下载的zip或tar-gz文件)中有一个名为PKG信息的文本文件。</p><p id="4f6d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个文件是由distutils或setuptools在生成源文件包时生成的。该文件包含一组键和值，键列表是PyPa标准元数据格式的一部分。您可以看到生成文件的内容，如下所示:</p><p id="243f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh ln lo lp lq b">tar xvfz dist/my-package-1.0.0.tar.gz -O | cat */PKG-INFO</code></p><p id="a8e5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在文件的顶部应该是头文件<code class="eh ln lo lp lq b">Metadata-Version</code>，它<strong class="it hv">取决于</strong>你安装的setuptools或distutils的版本。所以你要做的第一件事就是<strong class="it hv">升级setuptools，停止使用distutils。</strong></p><p id="82b0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh ln lo lp lq b">pip install — upgrade setuptools</code></p><p id="8ac3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Setuptools是现在由PyPa 维护的<em class="mk">包，所以确保在setup.py的顶部，您正在从setuptools模块导入设置方法。</em></p><p id="f203" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果升级正确，元数据版本值应该是1.2或更高。元数据1.2 <a class="ae ml" href="https://packaging.python.org/specifications/core-metadata/#requires-python" rel="noopener ugc nofollow" target="_blank">为这个包所需的Python版本</a>引入了一个新字段。</p><p id="59d0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">可以指定版本范围和排除规则，比如至少Python 3。或者，Python 2.7和3.4以后。</p><pre class="jq jr js jt fq mm lq mn mo aw mp dt"><span id="060e" class="lw kc hu lq b fv mq mr l ms mt">Requires-Python: &gt;=3<br/>Requires-Python: &gt;2.7,!=3.0.*,!=3.1.*, !=3.2.*,!=3.3.*</span></pre><p id="e315" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">设置这些值的方法是在setup.py脚本中调用<code class="eh ln lo lp lq b">setup</code>。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mu mv l"/></div></figure><p id="c47a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，调用<code class="eh ln lo lp lq b">python setup.py sdist</code>然后<code class="eh ln lo lp lq b">twine upload dist/*</code>将发布这个包的版本1，指定只支持Python 2.7+。</p><h2 id="de15" class="lw kc hu bd kd lx ly lz kh ma mb mc kl jc md me kp jg mf mg kt jk mh mi kx mj dt translated">发布前验证</h2><p id="50cb" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">因为几乎不可能在PyPi上编辑一个已发布的包，所以您真的想先检查一下，所以运行这个命令来验证元数据是否已经正确生成。</p><p id="c4e1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh ln lo lp lq b">tar xvfz dist/my-package-1.0.0.tar.gz -O | grep “Requires-Python”</code></p><h2 id="f9c0" class="lw kc hu bd kd lx ly lz kh ma mb mc kl jc md me kp jg mf mg kt jk mh mi kx mj dt translated">使用Twine发布</h2><p id="09ef" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">任何习惯于使用<code class="eh ln lo lp lq b">setup.py</code>将包发布到PyPi的人，现在也可以停止这样做了。除了速度更快之外，Twine还有许多优点，是目前支持的发布包的方法。</p><p id="dce1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">确保您使用的是最新版本的twine(在撰写本文时是1.9)。</p><h1 id="3e60" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">删除Python版本</h1><p id="9cbf" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">一旦发布了包含元数据的包，就可以进行进一步的更新，取消对Python运行时的支持。</p><p id="c355" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">必须按此顺序完成，自动回切才能正常工作。</p><p id="7268" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是一个非常典型的时间线</p><ol class=""><li id="286d" class="le lf hu it b iu iv iy iz jc lg jg lh jk li jo lj lk ll lm dt translated">在阅读本文之前，您发布了1.0版本的包</li><li id="c958" class="le lf hu it b iu lr iy ls jc lt jg lu jk lv jo lj lk ll lm dt translated">在阅读了关于语义版本化的PEP之后，您发布了1.1.0</li><li id="592d" class="le lf hu it b iu lr iy ls jc lt jg lu jk lv jo lj lk ll lm dt translated">你看了这篇文章，在所有2.7+版本的setup.py中添加了<code class="eh ln lo lp lq b">python_requires</code></li><li id="7c64" class="le lf hu it b iu lr iy ls jc lt jg lu jk lv jo lj lk ll lm dt translated">许多季节过去了，版本也过去了</li><li id="55a0" class="le lf hu it b iu lr iy ls jc lt jg lu jk lv jo lj lk ll lm dt translated">你发布了支持Python 2.7+的1.6.0</li><li id="722a" class="le lf hu it b iu lr iy ls jc lt jg lu jk lv jo lj lk ll lm dt translated">您向您的用户宣布，您将在一个月后停止对Python 2的支持</li><li id="9919" class="le lf hu it b iu lr iy ls jc lt jg lu jk lv jo lj lk ll lm dt translated">您将<code class="eh ln lo lp lq b">python_requires</code>字段修改为&gt; 3.3，并发布包的版本2.0.0</li></ol><blockquote class="mw"><p id="d467" class="mx my hu bd mz na nb nc nd ne nf jo ek translated">现在，如果用户拥有pip &gt;9.0，并且他们从Python 2安装您的包而没有指定版本号，他们将获得最新版本的包来支持他们的Python发行版！</p></blockquote><p id="fab7" class="pw-post-body-paragraph ir is hu it b iu ng iw ix iy nh ja jb jc ni je jf jg nj ji jj jk nk jm jn jo hn dt translated">如果用户拥有您在<code class="eh ln lo lp lq b">setup.py</code>中指定的受支持的Python发行版，那么他们将获得最新版本。</p><p id="fd7a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我发布给PyPi的名为<code class="eh ln lo lp lq b">friendly-deprecation-test</code>的包中尝试一下。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nl"><img src="../Images/c71d39873e3c8832ee1326ba52b44edd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CYIqRmonAwGpoK8bd7zejw.png"/></div></div></figure><h2 id="39d4" class="lw kc hu bd kd lx ly lz kh ma mb mc kl jc md me kp jg mf mg kt jk mh mi kx mj dt translated">但是等等…</h2><p id="ab0d" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">有人针对v1.6.0提出了一个严重的错误，而您不想让您的Python 2用户处于风险之中。你是做什么的？</p><ol class=""><li id="1d7e" class="le lf hu it b iu iv iy iz jc lg jg lh jk li jo lj lk ll lm dt translated">假设你在一个分支中有1.6，应用这个补丁。将分支上的版本提升到1.6.1，并用<code class="eh ln lo lp lq b">requires_python &gt;= 2.7</code>属性发布。把它释放给PyPi。</li><li id="1019" class="le lf hu it b iu lr iy ls jc lt jg lu jk lv jo lj lk ll lm dt translated">将补丁应用到主分支，并发布带有<code class="eh ln lo lp lq b">requires_python &gt;= 3.4</code>属性的2.0.1版本。</li></ol><p id="6f44" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在同样的过程适用，所有Python 2用户将获得1.6.1，Python 3.4+将获得2.0.1。</p></div></div>    
</body>
</html>