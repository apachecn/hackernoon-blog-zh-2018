<html>
<head>
<title>Serverless — Building a crypto wallet balance API to use with google spreadsheets (part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器——构建一个加密钱包余额API以用于google电子表格(第2部分)</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/serverless-part-2-61ad3986371f?source=collection_archive---------20-----------------------#2018-03-12">https://medium.com/hackernoon/serverless-part-2-61ad3986371f?source=collection_archive---------20-----------------------#2018-03-12</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="ad49" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本系列的这一部分中，我们将构建一个<a class="ae jp" href="https://hackernoon.com/tagged/serverless" rel="noopener ugc nofollow" target="_blank">无服务器</a> API端点来服务于我们的<a class="ae jp" href="https://hackernoon.com/tagged/google" rel="noopener ugc nofollow" target="_blank"> google </a>电子表格来跟踪加密钱包！你可以在这里找到回购<a class="ae jp" href="https://github.com/kvaggelakos/serverless-crypto-balance" rel="noopener ugc nofollow" target="_blank"/></p><p id="2568" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你错过了我的无服务器系列的其他帖子:<br/> <strong class="it hv">第1部分</strong> : <a class="ae jp" href="https://hackernoon.com/serverless-part-1-e75b4a5e59e6" rel="noopener ugc nofollow" target="_blank">超越过于简单的todo应用程序，进入现实世界</a>(构建一个无服务器函数，在文件上传到bucket时运行FFMPEG)<br/><strong class="it hv">第2部分:</strong>本文</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/f28a05f14d6354cd057813abf2798995.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z4GjInAN8Tr-D0OksnOdsA.png"/></div></div></figure><h1 id="ef1d" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">介绍</h1><p id="06d5" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated"><strong class="it hv">我们想做的:<br/> </strong>每当我们打开谷歌电子表格时，我们都希望它能实时查看我们的钱包，看看我们的余额。</p><p id="14b4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">结果将如下所示:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff lf"><img src="../Images/289fbead694387071dc77549d8518f0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qs1R2dVozYSCs1DS2nZo5Q.png"/></div></div></figure><p id="e600" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">为什么无服务器:<br/> </strong>在这种情况下，我们可以使用无服务器来快速部署一个可扩展的API，为各种钱包运行任意数量的查找。此外，我们只在浏览电子表格时才调用端点，所以不必为电子表格关闭的那些日子付费是件好事。</p><h1 id="4b3f" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">代码</h1><p id="a341" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">幸运的是，这不像第1部分那么高级。我知道我承诺过超越简单化的todo应用，但我认为这是一个有效的无服务器用例，简单、小巧，但非常强大。</p><h2 id="7095" class="lg kd hu bd ke lh li lj ki lk ll lm km jc ln lo kq jg lp lq ku jk lr ls ky lt dt translated">1.无服务器. yml</h2><p id="aaa9" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">这是一个非常简单的无服务器配置，我们有一个处理器，它将是一个提供平衡的处理器。正如您在http路径中看到的，我们接受一个参数<code class="eh lu lv lw lx b">id</code>，它将是钱包地址。</p><p id="bb70" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">需要注意的一点是(正如我们在第1部分中看到的)，这个插件允许我们在部署之前在本地运行。我们在这里介绍的另一件事是这个lambda 的<strong class="it hv">授权者的概念。我们不希望任何人滥用我们的系统！我们还定义了用户名和密码env变量，以便在部署后进行检查。</strong></p><p id="068b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">旁注:无服务器框架的类型<code class="eh lu lv lw lx b">request</code>允许我们检查正常的<code class="eh lu lv lw lx b">basic auth</code>。你可以在这里阅读更多关于<a class="ae jp" href="https://serverless.com/framework/docs/providers/aws/events/apigateway/#http-endpoints-with-custom-authorizers" rel="noopener ugc nofollow" target="_blank">不同授权人类型的信息</a>。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ly lz l"/></div></figure><h2 id="e592" class="lg kd hu bd ke lh li lj ki lk ll lm km jc ln lo kq jg lp lq ku jk lr ls ky lt dt translated">2.汉德勒·⚡⚡</h2><p id="6aaf" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">在我认真尝试不重新发明轮子的过程中，我找到了<a class="ae jp" href="https://github.com/litvintech/crypto-balances" rel="noopener ugc nofollow" target="_blank"> crypto-balances </a>一个节点模块来查询各种加密后端/节点，以找出一个地址的平衡！太好了！</p><p id="7c2e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于那些对其工作原理感兴趣的人，请查看其源代码。真正让我感兴趣的一段代码是我们如何传入任何地址，以及它如何计算出查询哪个服务/节点来获得平衡。现在我很快意识到这个模块已经2年没有更新了，因为我们已经有了叉子等等，这有点搞砸了这个自动检测！(总有进步的空间)。</p><p id="a913" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您还会注意到，我们从未在这段代码中添加任何用于检查auth的内容，这个决定是由API网关为您做出的，这是一个非常好的分离。</p><p id="4b61" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如你在下面看到的，我们只是简单地将<code class="eh lu lv lw lx b">crypto-balances</code>调用的结果包装成一个无服务器喜欢的响应，然后就可以开始了🚀</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ly lz l"/></div></figure><p id="aac5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本地运行它应该如下所示:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff ma"><img src="../Images/b3d2a1c17a7ea6307afa1ad4e32c7687.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LNTgdk6A_-V-R2HNPyFORw.png"/></div></div></figure><p id="3617" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这篇来自news.bitcoin.com的文章声称ETH起源地址(0x00…0)有超过7k的ETH。让我们看看我们是否能证实这一点！</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mb"><img src="../Images/0afe4549c6dfdb6d1dc30a88744e9e4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yYbWOlGgcFvMs6rDc8ks1A.png"/></div></div></figure><p id="d9dc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们的api管用！此外，我们已经确认了索赔。genesis地址确实有超过7k ETH:)需要注意的一点是，在这种情况下，我们的依赖项选择使用<a class="ae jp" href="http://api.etherscan.io" rel="noopener ugc nofollow" target="_blank">http://API . ethers can . io</a>来查找余额，这将因我们试图查找的钱包地址而异。</p><h2 id="111c" class="lg kd hu bd ke lh li lj ki lk ll lm km jc ln lo kq jg lp lq ku jk lr ls ky lt dt translated">3.作家（author的简写）</h2><p id="1dc2" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">好了，现在我们有了一个奇特的api。酷，但是如果我们想保护它呢？也许我们不想让别人给我们可怜的小拉姆达发垃圾邮件！</p><p id="6f01" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你仔细检查上面的截图，你会看到为了通过auth，curl有一个<code class="eh lu lv lw lx b">--user test:test</code>参数。如果我们传递了错误的信息，看起来会是这样:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mc"><img src="../Images/ad942e3ddcb3b3360bd5266e4604063a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bBw2aOqAO2PPqs1nL96Keg.png"/></div></div></figure><p id="17b4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们得到了一个美好的401回来！那么如何才能做到这一点呢？让我们深入研究授权代码！</p><p id="17c2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们之前在<code class="eh lu lv lw lx b">serverless.yml</code>中定义了一个授权器，这使得我们的API网关在允许任何人访问我们的lambda之前运行我们的授权器。</p><p id="0e53" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在第9行，我们基于环境变量(在<code class="eh lu lv lw lx b">serverless.yml)</code>中再次定义)构造了基本的auth字符串</p><p id="85d3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在第11行，我们将<code class="eh lu lv lw lx b">authString</code>与调用者在头中传递的内容进行匹配。如果匹配，我们返回一个精心制作的策略文档，包括动作(调用lambda)和效果“allow”。</p><p id="b225" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果不匹配，我们抛出一个401。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ly lz l"/></div></figure><h2 id="7a7c" class="lg kd hu bd ke lh li lj ki lk ll lm km jc ln lo kq jg lp lq ku jk lr ls ky lt dt translated">4.部署</h2><p id="310b" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">让我们在继续之前部署它，这样我们就可以在我们的google电子表格脚本中使用它。</p><p id="5a7c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用无服务器框架，我们需要做的就是运行:<code class="eh lu lv lw lx b">sls deploy -v<br/></code>确保它正常工作:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff me"><img src="../Images/216fb49d2ea03a6d82d66bc841cea263.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Vyo5sc67OdpGvj6xClvhg.png"/></div></div></figure><h2 id="e6f1" class="lg kd hu bd ke lh li lj ki lk ll lm km jc ln lo kq jg lp lq ku jk lr ls ky lt dt translated">5.谷歌电子表格代码</h2><p id="d257" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">一旦我们部署了无服务器，就该让从我们的表单中查询它变得简单了。</p><p id="7226" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是完整的电子表格代码，我们需要粘贴到我们的谷歌电子表格脚本编辑器。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ly lz l"/></div></figure><p id="83f3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要添加脚本，请打开脚本编辑器，如下图所示:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mf"><img src="../Images/286b3347605123aad08a025f18e311c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*os_mz0-Lwwp_6p3oFE0Wbw.png"/></div></div></figure><p id="e33c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后粘贴进去保存！</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mg"><img src="../Images/183483605fd84c4897fa1e17e902c978.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qxb2AFV_NxW_MnS6I0sq_w.png"/></div></div></figure><h2 id="e572" class="lg kd hu bd ke lh li lj ki lk ll lm km jc ln lo kq jg lp lq ku jk lr ls ky lt dt translated">结论</h2><p id="9da9" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">我希望你喜欢这个系列的<strong class="it hv">第2部分</strong>中超越表面的无服务器部分！</p><p id="a473" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">这部分遇到的几个现实生活中的问题:</strong></p><ol class=""><li id="7b3f" class="mh mi hu it b iu iv iy iz jc mj jg mk jk ml jo mm mn mo mp dt translated">我们学习了如何在无服务器中使用<strong class="it hv">授权器。我们传入一个基本的auth头，并通过处理环境变量将它与计算出的字符串进行匹配。</strong></li><li id="d282" class="mh mi hu it b iu mq iy mr jc ms jg mt jk mu jo mm mn mo mp dt translated">我们还看了如何将一个电子表格与我们的无服务器功能连接起来，以实际使用它来做一些有趣的事情。</li></ol><p id="0b57" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">感谢阅读！请用掌声和星星来传播❤！</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="mv lz l"/></div></figure></div></div>    
</body>
</html>