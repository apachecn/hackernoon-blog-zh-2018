<html>
<head>
<title>Migrating from Heroku to AWS with kubernetes and without stopping production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在不停止生产的情况下，使用kubernetes从Heroku迁移到AWS</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/migrating-from-heroku-to-aws-with-kubernates-and-without-stopping-production-4ff6346cccf8?source=collection_archive---------19-----------------------#2018-03-14">https://medium.com/hackernoon/migrating-from-heroku-to-aws-with-kubernates-and-without-stopping-production-4ff6346cccf8?source=collection_archive---------19-----------------------#2018-03-14</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="acb1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">几个月前，我们成功地将大部分基础设施从Heroku迁移到AWS。现在，当尘埃落定(或者我应该说是云)时，我们想分享我们决定背后的主要驱动力是什么，以及我们如何在不停止Voucherify API的情况下进行转移，哪怕是一分钟。</p><h1 id="ed78" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">架构摘要</h1><p id="9a41" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">为了更好地理解我们这里的推理，让我们快速地看一下什么是Voucherify以及这个架构是什么样子的。</p><p id="478d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Voucherify提供可编程的构建模块来构建优惠券、推荐和忠诚度活动。它基本上是一个API优先的平台，开发者可以用它来建立复杂和个性化的促销活动，比如当客户加入“高级”细分市场时，向他或她发送一封带有特定优惠券代码的电子邮件。它还允许公司跟踪优惠券的兑现，以找出什么样的促销效果最好。最后，它为营销人员提供了一个仪表板，以减轻开发人员维护和监控促销活动的负担。</p><p id="c0fa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该平台基本上由3个组件组成:</p><ul class=""><li id="e6c2" class="ks kt hu it b iu iv iy iz jc ku jg kv jk kw jo kx ky kz la dt translated">公开API的核心应用程序</li><li id="76d2" class="ks kt hu it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la dt translated">服务于仪表板的网站</li><li id="6388" class="ks kt hu it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la dt translated">支持非API相关作业的微服务</li></ul><p id="1794" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">说到数据存储，我们使用Postgres、Mongo和redis trio。</p><p id="7fd9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是它在迁移后的样子:</p><figure class="lh li lj lk fq ll fe ff paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="fe ff lg"><img src="../Images/724e98df841602d72b1640e87e9f11e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*caczY_id_8Qk8Fy3.png"/></div></div></figure><p id="9586" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">负载:</strong>我们服务于100多个客户，他们每月发送几百万个API调用，包括常规请求和一些更耗电的请求，如批量导入/导出或与第三方集成的同步。‍</p><h1 id="8ed0" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">为什么首先是Heroku？</h1><p id="7aeb" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">当我们在2015年启动Voucherify时，Heroku是一个完美的解决方案。它为我们提供了经济高效的托管和出色的持续部署工作流。任何以前使用过<a class="ae ls" href="https://hackernoon.com/tagged/heroku" rel="noopener ugc nofollow" target="_blank"> Heroku </a>的人都知道将其与<a class="ae ls" href="https://hackernoon.com/tagged/github" rel="noopener ugc nofollow" target="_blank"> Github </a>集成起来有多简单，以及部署起来有多快。最重要的是，Heroku是有据可查的，社区也非常活跃。</p><p id="669d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所有这些都让你可以专注于迭代你的产品，而不必在相当长的时间里指派一个专门的人来开发运维；我们的情况是大约16个月。在Heroku上托管实际上是速度的问题。您只需构建、交付和扩展，无需基础架构(部署脚本、扩展或安全性)的困扰。但这种速度也体现在Heroku遍布世界各地的数据中心所确保的低延迟上。这对我们来说非常重要，因为我们的API优先平台的主要重点是开发人员的体验——我不知道有哪个开发人员喜欢缓慢的响应。</p><h1 id="cb38" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">转换点</h1><p id="faff" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">Heroku很好，但我们的平台已经开始更有活力地增长。希望每天处理成千上万个API调用的新企业客户。我们用游击的方式来攀登dynos变得越来越昂贵。我们知道，从长远来看，这在财务上是不可行的。由于我们是一个自举企业，我们必须做出反应。</p><p id="c384" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们的账单是这样的:</p><ul class=""><li id="9567" class="ks kt hu it b iu iv iy iz jc ku jg kv jk kw jo kx ky kz la dt translated">API服务——750美元(只有处理流量的Dynos，没有数据库)</li><li id="c821" class="ks kt hu it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la dt translated">网络仪表板——50美元</li><li id="4709" class="ks kt hu it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la dt translated">下一个Dyno用于处理额外的API流量，至少50美元</li><li id="73ef" class="ks kt hu it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la dt translated">在大规模操作(导入、导出)的情况下，我们需要更大的容器和额外的内存。因此，每个web Dyno的成本上升到了250美元。</li></ul><p id="7fd6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是价格并不是我们离开Heroku的唯一原因。</p><p id="b910" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">首先是</strong>，我们开始面临奇怪且难以调试的基础设施问题。有几次我们注意到我们的平台有问题，并不确定地回应。我们去找问题，却发现(很久很久以后)问题出在赫罗库身上。状态页面没有立即更新。有时他们反应很快，有时我们不得不自己解决问题，因为修复需要几个小时。</p><p id="008e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">其次</strong>，Heroku(或者我猜任何其他PaaS)在资源利用上很差。Heroku计划对机器的资源结构非常严格。正如我们所知，这种资源限制策略是重要且合理的，我们应该记住，每个应用程序都是不同的，因此它需要一个适当的CPU/内存利用率配置文件。实际上，当我们升级计划以获得更多内存时，我们为额外未使用的CPU能力付出了代价。当你需要扩展你的应用时，它变得越来越明显和昂贵。让我们来看看我们的情况。<a class="ae ls" href="http://twitter.com/frakti" rel="noopener ugc nofollow" target="_blank">我们的基础设施工程师汤姆</a>说:</p><blockquote class="lt lu lv"><p id="f9c1" class="ir is lw it b iu iv iw ix iy iz ja jb lx jd je jf ly jh ji jj lz jl jm jn jo hn dt translated">现在，对于完全相同的月价格(750美元—只有服务，没有数据库)，我们在管理批量操作方面没有问题，因为我们合理地利用了资源。此外，我们可以处理600%以上的流量。</p></blockquote><p id="fe8c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">第三，</strong>缺少私有IP地址——我们收到通知说我们的应用程序正在生成垃圾邮件流量，但事实并非如此。此外，我们的一些企业客户有控制出站流量的安全策略，他们要求我们提供他们防火墙的IP地址——使用Heroku我们无法满足这一要求。</p><p id="aa48" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">最后，</strong>有限插件—一些Heroku插件与Voucherify集成的软件的最新版本不兼容。例如，Compose插件只能在其2.6版本中使用。</p><p id="5c48" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">总的来说，赫罗库变得既费钱又费时。</p><h1 id="5e49" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">AWS来拯救</h1><p id="b4e3" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">为什么是AWS？嗯，我想这是一个令人失望的答案，但它是最受欢迎的云提供商，我们从以前的项目中积累了丰富的经验。我们没有进行彻底的研究。另外，我们的数据库实例已经托管在相同地区的AWS上。</p><h2 id="fa00" class="ma jq hu bd jr mb mc md jv me mf mg jz jc mh mi kd jg mj mk kh jk ml mm kl mn dt translated">迁移流程—或者说如何保持所有系统100%正常运行</h2><p id="d527" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">我们的API处理全球成千上万的优惠券兑换请求。如果API下降，在世界的某个地方，当他们的拿铁折扣在结账时变得无效时，一群人会感到尴尬和沮丧。或者，有人不能用生日礼品卡来支付他们梦寐以求的新无人机。这种不愉快的情况很快升级到我们的客户，他们感到失望，这是我们最不希望的事情。</p><p id="759f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就是为什么我们想出了一个循序渐进的可用性优先迁移策略。我们是这样做的。</p><ol class=""><li id="ea53" class="ks kt hu it b iu iv iy iz jc ku jg kv jk kw jo mo ky kz la dt translated">我们用bash脚本迁移了一个应用程序。但是一旦我们进入细节(依赖关系，安全补丁等)。)脚本开始变得很难维护。我们转向集装箱。由于我们的API将在一组服务器上运行，并且需要负载平衡、自动伸缩和故障转移(Heroku提供了开箱即用的功能)，我们利用kubernetes来协调这一点。与Mesos和Docker Swarm相比，他们似乎拥有最大的社区</li><li id="b6ae" class="ks kt hu it b iu lb iy lc jc ld jg le jk lf jo mo ky kz la dt translated">Kubernetes支持开箱即用的谷歌云平台，但AWS不支持，这就是为什么我们使用<a class="ae ls" href="https://stackpoint.io/" rel="noopener ugc nofollow" target="_blank">堆栈点</a>来简化k8s的配置。通过这种方式，我们不必花费大量时间在AWS上配置集群。StackPoint最大的优点是，不管有多少个节点，它们都提供统一的费率。使用k8s的额外价值是，我们可以在需要时将集群移动到另一个云提供商。这是一个令人惊讶的有效观点，因为我们最近被要求选择在AWS之外托管。最后，使用这个设置，我们总是可以在15分钟内在另一个区域创建一个集群。</li><li id="70dd" class="ks kt hu it b iu lb iy lc jc ld jg le jk lf jo mo ky kz la dt translated">介绍k8s监控平台— Prometheus + Grafana。我们在文章中描述了这个设置，你可以订阅我们的博客来获得通知。</li><li id="b808" class="ks kt hu it b iu lb iy lc jc ld jg le jk lf jo mo ky kz la dt translated">计算Heroku上的当前资源利用率，以设置容器资源的参考点，并在EC2上选择合适的工作节点</li><li id="91db" class="ks kt hu it b iu lb iy lc jc ld jg le jk lf jo mo ky kz la dt translated">使用路由53递增地重新路由流量:</li></ol><ul class=""><li id="7b93" class="ks kt hu it b iu iv iy iz jc ku jg kv jk kw jo kx ky kz la dt translated">10% AWS — 90% Heroku</li><li id="c2c6" class="ks kt hu it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la dt">25% — 75%</li><li id="e333" class="ks kt hu it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la dt">50% — 50%</li><li id="aa61" class="ks kt hu it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la dt translated">100% AWS</li></ul><h1 id="9bce" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">结果</h1><p id="607e" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">最终，我们得到了一个更可预测的平台，并在接下来的几个月里针对不断增长的流量对其进行了保护。我们仍然将Heroku用于一些服务，比如我们的dashboard，因为它更容易部署，而且毕竟不需要那么多资源。Heroku Connect 也值得一提。我们喜欢它，因为它减轻了Salesforce sync的工作量。</p><p id="2d8e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，我们还从Heroku迁移了postgres实例。在不停止生产的情况下做到这一点需要我们运用一些有趣的技巧。我们将在下一篇文章中描述它们。敬请期待！</p></div><div class="ab cl mp mq hc mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="hn ho hp hq hr"><p id="b0d7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="lw">原载于</em><a class="ae ls" href="https://www.voucherify.io/blog/migrating-from-heroku-to-aws-with-kubernates-and-without-stopping-production" rel="noopener ugc nofollow" target="_blank"><em class="lw">www . voucherify . io</em></a><em class="lw">。</em></p><figure class="lh li lj lk fq ll"><div class="bz el l di"><div class="mw mx l"/></div></figure></div></div>    
</body>
</html>