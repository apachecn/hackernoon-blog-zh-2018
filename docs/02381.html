<html>
<head>
<title>10x Performance Increases: Optimizing a Static Site</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">10倍性能提升:优化静态站点</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/optimizing-a-static-site-d5ab6899f249?source=collection_archive---------0-----------------------#2018-03-16">https://medium.com/hackernoon/optimizing-a-static-site-d5ab6899f249?source=collection_archive---------0-----------------------#2018-03-16</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="bdbd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">几个月前，我在美国境外旅行，想向一个朋友展示我个人(静态)网站上的链接。我试着导航到我的网站，但是花的时间比我预期的要长。它绝对没有什么动态——它有动画和一些响应设计，但内容总是保持不变。我对结果感到非常震惊，DOMContentLoaded用了大约4秒，全页面加载用了6.8秒。有20个对静态站点的请求，总共传输了1mb的数据。我习惯了我在洛杉矶的1Gb/s、低延迟的<a class="ae jq" href="https://hackernoon.com/tagged/internet" rel="noopener ugc nofollow" target="_blank">互联网</a>连接到我在旧金山的服务器，这让这个庞然大物看起来快如闪电。在意大利，8mb/s，这是一个完全不同的画面。</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/b17a33b40f2108bf7f77c06a78dd8f48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OgqdIBjziyfhE_tbip24ww.png"/></div></div></figure><p id="1b33" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是我第一次尝试优化。到目前为止，任何时候我想添加一个库或资源，我都会直接扔进去，用<em class="jp"> src="…" </em>指向它。我对任何形式的<a class="ae jq" href="https://hackernoon.com/tagged/performance" rel="noopener ugc nofollow" target="_blank">性能</a>都毫不在意，从缓存到内联再到延迟加载。</p><p id="5c4f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我开始四处寻找有类似经历的人。不幸的是，许多关于静态优化的文献很快就过时了——2010年或2011年的建议讨论了库，或者做出了不再正确的假设，或者只是一遍又一遍地重复相同的准则。</p><p id="3b9c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，我确实找到了两个很好的信息来源——<a class="ae jq" href="https://hpbn.co" rel="noopener ugc nofollow" target="_blank">高性能浏览器网络</a>和<a class="ae jq" href="https://danluu.com/octopress-speedup/" rel="noopener ugc nofollow" target="_blank"> Dan Luu优化静态网站的类似经验</a>。虽然我在剥离格式和内容方面没有Dan走得那么远，但我确实设法让我的页面加载速度提高了大约10倍，对于DOMContentLoaded来说大约是五分之一秒，对于全页面加载来说只有388毫秒(这实际上有点不准确，因为它涉及了下面解释的延迟加载)。</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff kd"><img src="../Images/5cf87440c0d6783b4e11b4677328ed3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OBt9rTFK8KhlnPI1-olkmg.png"/></div></div></figure><h1 id="ad76" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">该过程</h1><p id="9220" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated">该过程的第一步是对网站进行分析。我想弄清楚什么花费的时间最长，以及如何最好地并行处理一切。我运行了各种工具来分析我的网站，并在世界各地进行测试，包括:</p><ul class=""><li id="980a" class="lh li hu it b iu iv iy iz jc lj jg lk jk ll jo lm ln lo lp dt translated"><a class="ae jq" href="https://tools.pingdom.com/" rel="noopener ugc nofollow" target="_blank">https://tools.pingdom.com/</a></li><li id="b980" class="lh li hu it b iu lq iy lr jc ls jg lt jk lu jo lm ln lo lp dt translated"><a class="ae jq" href="http://www.webpagetest.org/" rel="noopener ugc nofollow" target="_blank">www.webpagetest.org/</a></li><li id="9854" class="lh li hu it b iu lq iy lr jc ls jg lt jk lu jo lm ln lo lp dt translated"><a class="ae jq" href="https://tools.keycdn.com/speed" rel="noopener ugc nofollow" target="_blank">https://tools.keycdn.com/speed</a></li><li id="659b" class="lh li hu it b iu lq iy lr jc ls jg lt jk lu jo lm ln lo lp dt translated"><a class="ae jq" href="https://developers.google.com/web/tools/lighthouse/" rel="noopener ugc nofollow" target="_blank">https://developers.google.com/web/tools/lighthouse/</a></li><li id="ba53" class="lh li hu it b iu lq iy lr jc ls jg lt jk lu jo lm ln lo lp dt translated">https://developers.google.com/speed/pagespeed/insights/<a class="ae jq" href="https://developers.google.com/speed/pagespeed/insights/" rel="noopener ugc nofollow" target="_blank"/></li><li id="e004" class="lh li hu it b iu lq iy lr jc ls jg lt jk lu jo lm ln lo lp dt translated">【https://webspeedtest.cloudinary.com/ T4】</li></ul><p id="ec12" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">其中一些提供了改进的建议，但是当你的静态站点有50个请求时，你只能做这么多——从90年代留下的间隔gif到没有使用的资产(我加载了6种字体，只使用了1种)。</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff lv"><img src="../Images/815818d5d6ee6e1112b9c8e90d4716bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*61ngDdpQfLqBo-I8F_tuqw.png"/></div></div><figcaption class="lw lx fg fe ff ly lz bd b be z ek">Timeline for my site — I tested this on the Web Archive as I didn’t screenshot the original one, but it looks similar enough to what I saw a few months ago.</figcaption></figure><p id="8fb0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我想改进我能控制的一切——从javascript的内容和速度到实际的web服务器(Nginx)和DNS设置。</p><h1 id="c709" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">最佳化</h1><h2 id="012a" class="ma kf hu bd kg mb mc md kk me mf mg ko jc mh mi ks jg mj mk kw jk ml mm la mn dt translated">缩小和合并资源</h2><p id="a8d3" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated">我注意到的第一件事是，我对CSS和JS(没有任何形式的HTTP keepalive)以及各种站点发出了十几个请求，其中一些是https。这增加了到各种cdn或服务器的多次往返，并且一些JS文件正在请求其他文件，这导致了上面看到的阻塞级联。</p><p id="024f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我使用<a class="ae jq" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank"> webpack </a>将我所有的资源合并成一个js文件。每当我对我的内容进行更改时，它会自动缩小并将我所有的依赖项转换成一个文件。</p><figure class="js jt ju jv fq jw"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="d4e1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我尝试了不同的选项——目前，这个bundle.js文件在我的站点的中，并且被阻塞了。它的最终大小是829kb，包括所有非图像资源(字体、css、所有库和依赖项以及js)。其中绝大部分是字体很棒的字体，占了829kb中的724 kb。</p><p id="1c7b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我浏览了字体库，去掉了我正在使用的三个图标——fa-github、fa-envelope和fa-code。我使用了一个名为<a class="ae jq" href="http://fontello.com/" rel="noopener ugc nofollow" target="_blank"> fontello </a>的服务，只拉出我需要的图标。新的大小只有94kb。</p><p id="e2ad" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">网站目前的构建方式，如果我们只有样式表，它看起来不会是正确的，所以我接受了单个bundle.js的阻塞特性。加载时间约为118毫秒，比上面的好一个数量级以上。</p><p id="2914" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这也有一些额外的好处——我不再指向第三方资源或cdn，因此用户不需要1)对该资源执行DNs查询，2)执行https握手，以及3)实际等待从该资源的完整下载。</p><p id="6914" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">虽然CDNs和分布式缓存可能对大规模的分布式站点有意义，但对我的小型静态站点没有意义。大约100毫秒的额外时间是值得的。</p><h2 id="c14f" class="ma kf hu bd kg mb mc md kk me mf mg ko jc mh mi ks jg mj mk kw jk ml mm la mn dt translated">压缩资源</h2><p id="35d5" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated">我加载了一个8mb大小的头像，然后以10%的宽度/高度显示。这不仅仅是缺乏优化——这几乎是对用户带宽使用的疏忽。</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff mq"><img src="../Images/14b02211b6661cf6b5c992583389c400.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h79KSROW3oY6KWfQm6u5yA.png"/></div></div></figure><p id="0406" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我用https://webspeedtest.cloudinary.com/的<a class="ae jq" href="https://webspeedtest.cloudinary.com/" rel="noopener ugc nofollow" target="_blank">压缩了我所有的图片——它还建议我切换到</a><a class="ae jq" href="https://developers.google.com/speed/webp/" rel="noopener ugc nofollow" target="_blank">的webp </a>，但是我想尽可能地兼容更多的浏览器，所以我坚持使用jpg。有可能建立一个系统，在这个系统中，webp只被交付给支持它的浏览器，但是我想尽可能保持简单，并且增加抽象层的好处似乎不值得。</p><h2 id="7e73" class="ma kf hu bd kg mb mc md kk me mf mg ko jc mh mi ks jg mj mk kw jk ml mm la mn dt translated">改进Web服务器— HTTP2、TLS等</h2><p id="d180" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated">我做的第一件事是过渡到https——当我开始时，我在端口80上运行Nginx bare，只提供来自/var/www/html的文件</p><figure class="js jt ju jv fq jw"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="15d8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我首先设置https，并将所有http请求重定向到https。我从<a class="ae jq" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> Let's Encrypt </a>获得了我的TLS证书(这是一个伟大的组织，刚刚开始签署<a class="ae jq" href="https://community.letsencrypt.org/t/acme-v2-and-wildcard-certificate-support-is-live/55579" rel="noopener ugc nofollow" target="_blank">通配符证书</a>)!).</p><figure class="js jt ju jv fq jw"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="1947" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">仅仅通过添加http2指令，Nginx就能够利用最新http特性的所有现代优势。注意，如果你想利用HTTP2(以前的SPDY)，你<em class="jp">必须</em>使用HTTPS。点击阅读更多相关信息<a class="ae jq" href="https://hpbn.co/http2/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="60f9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您还可以利用HTTP2 push指令与<em class="jp">http 2 _ push images/headshot . jpg；</em></p><p id="e484" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注意:启用gzip和TLS可能会给你带来违反<a class="ae jq" href="https://en.wikipedia.org/wiki/BREACH" rel="noopener ugc nofollow" target="_blank">的风险。由于这是一个静态站点，实际的漏洞风险非常低，所以我很乐意保持压缩。</a></p><h2 id="5a77" class="ma kf hu bd kg mb mc md kk me mf mg ko jc mh mi ks jg mj mk kw jk ml mm la mn dt translated">利用缓存和压缩指令</h2><p id="e820" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated">仅仅通过Nginx还能完成什么？首先出现的是缓存和压缩指令。</p><p id="0fb8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我发送的是原始的、未压缩的HTML。只穿了一个gzip行，我得以从16000字节到8000字节，减少了50%。</p><p id="6ae7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们实际上可以进一步提高这个数字——如果将Nginx的<em class="jp"> gzip_static设置为on，</em>它将提前查找所有请求文件的预压缩版本。这与我们上面的webpack配置密切相关——我们可以在构建时使用<a class="ae jq" href="https://github.com/webpack-contrib/zopfli-webpack-plugin" rel="noopener ugc nofollow" target="_blank"> ZopflicPlugin </a>来预压缩我们所有的文件！这节省了计算资源，并允许我们在不牺牲速度的情况下最大化我们的压缩。</p><p id="4e21" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，我的站点很少更改，所以我希望尽可能长时间地缓存资源。这将使得在后续访问中，用户不需要重新下载所有资产(尤其是bundle.js)。</p><p id="b22c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我更新后的服务器配置如下所示。注意，我不会触及我所做的所有更改，比如TCP设置更改、gzip指令和文件缓存。如果你想了解更多，请阅读这篇关于调优Nginx的文章。</p><figure class="js jt ju jv fq jw"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="d0dc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">和相应的服务器块</p><figure class="js jt ju jv fq jw"><div class="bz el l di"><div class="mo mp l"/></div></figure><h2 id="6113" class="ma kf hu bd kg mb mc md kk me mf mg ko jc mh mi ks jg mj mk kw jk ml mm la mn dt translated">惰性装载</h2><p id="9d14" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated">最后，对我的实际网站做了一个小小的改动，这将对我的网站产生不可忽视的影响。有5张图片直到你按下它们对应的标签才会被看到，但是它们和其他的图片是同时被加载的(因为它们在一个<img src="”…”"/>标签中)。</p><p id="35a8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我写了一个简短的脚本，用<em class="jp"> lazyload类修改每个元素的属性。</em>这些图像只有在相应的框被点击时才会被加载。</p><figure class="js jt ju jv fq jw"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="863a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，一旦文档完成加载，它将修改<img/>标签，使它们从<img data-src="”…”"/>变为<img src="”…”"/>，并在后台加载它。</p><h2 id="499f" class="ma kf hu bd kg mb mc md kk me mf mg ko jc mh mi ks jg mj mk kw jk ml mm la mn dt translated">未来的改进</h2><p id="38a1" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated">还有一些其他的变化可以提高页面加载速度——最明显的是，使用服务人员来缓存和拦截所有请求，使网站即使在离线时也能运行，并在cdn上缓存内容，这样用户就不需要在SF中与服务器进行完整的往返。这些都是有价值的改变，但对于一个作为在线简历/关于我的页面的个人静态网站来说并不是特别重要。</p><h1 id="d214" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">结论</h1><p id="7888" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated">这将我的页面加载时间从8秒多提高到了第一次页面加载的350毫秒，随后的页面加载时间提高到了200毫秒。我真的推荐通读所有的<a class="ae jq" href="https://hpbn.co/#toc" rel="noopener ugc nofollow" target="_blank">高性能浏览器网络</a>——这是一个相当快速的阅读，提供了一个现代互联网的令人难以置信的好的概述，并在现代互联网模型的每一层进行优化。</p><p id="3ace" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我错过了什么吗？看到任何违反最佳实践或可能进一步提高我的绩效的情况了吗？ <a class="ae jq" href="https://jonlu.ca" rel="noopener ugc nofollow" target="_blank"> <em class="jp">随意伸手— JonLuca De Caro！</em>T19】</a></p><figure class="js jt ju jv fq jw"><div class="bz el l di"><div class="mr mp l"/></div></figure></div></div>    
</body>
</html>