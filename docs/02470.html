<html>
<head>
<title>How to deploy on multiple servers a project without a single line of code!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在多台服务器上部署一个项目，而不需要一行代码！</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-deploy-on-multiple-servers-a-project-without-a-single-line-of-code-60b7cb9a65c8?source=collection_archive---------15-----------------------#2018-03-19">https://medium.com/hackernoon/how-to-deploy-on-multiple-servers-a-project-without-a-single-line-of-code-60b7cb9a65c8?source=collection_archive---------15-----------------------#2018-03-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><blockquote class="ir is it"><p id="cef6" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">这个职位需要知道如何写和读。仅yaml语法:简单！；)</p></blockquote><h2 id="343c" class="jt ju hu bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dt translated">我们需要什么？</h2><ul class=""><li id="e6aa" class="kr ks hu ix b iy kt jc ku ke kv ki kw km kx js ky kz la lb dt translated">本地机器上带有php的终端</li><li id="e6a5" class="kr ks hu ix b iy lc jc ld ke le ki lf km lg js ky kz la lb dt translated">项目的git存储库</li></ul><h2 id="638b" class="jt ju hu bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dt translated">我们用什么？自动化！</h2><p id="f5f6" class="pw-post-body-paragraph iu iv hu ix b iy kt ja jb jc ku je jf ke lh ji jj ki li jm jn km lj jq jr js hn dt translated">这是automate的官方网站:<a class="ae lk" href="https://automate-deployer.com/" rel="noopener ugc nofollow" target="_blank">https://automate-deployer.com/</a></p><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div class="fe ff ll"><img src="../Images/0e395c3e2cf58afe33e79c9746108a84.png" data-original-src="https://miro.medium.com/v2/resize:fit:580/format:webp/0*AcmMnYxRAXv06Rrp.png"/></div><figcaption class="lt lu fg fe ff lv lw bd b be z ek">Automate</figcaption></figure></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><h1 id="afb4" class="me ju hu bd jv mf mg mh jz mi mj mk kd ml mm mn kh mo mp mq kl mr ms mt kp mu dt translated"><strong class="ak">该开始了！</strong></h1><h2 id="61eb" class="jt ju hu bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dt translated">第一，<code class="eh mv mw mx my b">.automate.yml </code>文件</h2><p id="fbe5" class="pw-post-body-paragraph iu iv hu ix b iy kt ja jb jc ku je jf ke lh ji jj ki li jm jn km lj jq jr js hn dt translated">首先，在项目的根目录下添加<code class="eh mv mw mx my b">.automate.yml</code>文件(不是公共目录)，写下这一行:</p><pre class="lm ln lo lp fq mz my na nb aw nc dt"><span id="5c12" class="jt ju hu my b fv nd ne l nf ng">repository: <a class="ae lk" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:romaricp/kit-starter-symfony-4-docker.git<br/>platforms:<br/>    development:<br/>        default_branch: master<br/>        max_releases: 2<br/>        servers:<br/>            dddv-server:<br/>                host: 10.128.12.12<br/>                user: dev<br/>                password: %dev_password%<br/>                path: /home/wwwroot/sf4<br/>    preprod:<br/>        default_branch: preprod<br/>        max_releases: 2<br/>        servers:<br/>            pddv-server:<br/>                host: 10.128.12.13<br/>                user: dev<br/>                password: %preprod_password%<br/>                path: /home/wwwroot/sf4<br/>shared_files:<br/>    - .env<br/>shared_folders:<br/>    - public/upload<br/>on_deploy:<br/>    - "composer install"<br/>    - "setfacl -R -m u:www-data:rwX -m u:`whoami`:rwX var"<br/>    - "setfacl -dR -m u:www-data:rwX -m u:`whoami`:rwX var"<br/>    - "php bin/console c:c --env=prod --no-debug"<br/>post_deploy:<br/>    - "php bin/console doctrine:schema:update --force"<br/>    - "php bin/console cache:war --no-debug"</span></pre><p id="b28e" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">好的，那么我们在这里写的是什么？只是设置，不是编码；)</p><pre class="lm ln lo lp fq mz my na nb aw nc dt"><span id="efe8" class="jt ju hu my b fv nd ne l nf ng">repository: <a class="ae lk" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:romaricp/kit-starter-symfony-4-docker.git</span></pre><p id="2936" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">在这里，我们只是写了你的项目的地址，例如这里有一个Symfony4的示例项目。</p></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><pre class="lm ln lo lp fq mz my na nb aw nc dt"><span id="164c" class="jt ju hu my b fv nd ne l nf ng">platforms:<br/>    development:<br/>        default_branch: master<br/>        max_releases: 2<br/>        servers:<br/>            dddv-server:<br/>                host: 10.128.12.12<br/>                user: dev<br/>                password: %dev_password%<br/>                path: /home/wwwroot/sf4<br/>    preprod:<br/>        default_branch: preprod<br/>        max_releases: 2<br/>        servers:<br/>            pddv-server:<br/>                host: 10.128.12.13<br/>                user: dev<br/>                password: %preprod_password%<br/>                path: /home/wwwroot/sf4</span></pre><p id="7741" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">在这里，我们定义了部署项目所需的所有服务器。如你所见，定义了两个服务器:<code class="eh mv mw mx my b">development </code>和<code class="eh mv mw mx my b">preproduction </code>一个。</p><p id="c818" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">对于每个服务器，我们通过<code class="eh mv mw mx my b">default_branch</code>定义使用哪个git分支；因此，对于<code class="eh mv mw mx my b">development</code>服务器，我想使用<code class="eh mv mw mx my b">master</code>分支，对于<code class="eh mv mw mx my b">preprod</code>服务器，我想使用<code class="eh mv mw mx my b">preprod</code>分支。</p><p id="3814" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">我们必须定义我们希望在每台服务器上存储多少最大版本。2看起来不错，因为如果你在一个新的部署后遇到一些bug，你可以用一个命令回滚，我们稍后会看到。</p></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><pre class="lm ln lo lp fq mz my na nb aw nc dt"><span id="d62c" class="jt ju hu my b fv nd ne l nf ng">servers:<br/>    pddv-server:<br/>        host: 10.128.12.13<br/>        user: dev<br/>        password: %preprod_password%<br/>        path: /home/wwwroot/sf4</span></pre><p id="5f41" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">这里，我们按平台定义了所有服务器，在这种情况下，我们只有一个服务器/平台，但您可以轻松地添加2或3个服务器来部署您的项目。</p><p id="b4b9" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">对于每台服务器，您必须定义:</p><ul class=""><li id="5059" class="kr ks hu ix b iy iz jc jd ke nh ki ni km nj js ky kz la lb dt translated">主持</li><li id="f764" class="kr ks hu ix b iy lc jc ld ke le ki lf km lg js ky kz la lb dt translated">用户(具有ssh访问权限)</li><li id="20ce" class="kr ks hu ix b iy lc jc ld ke le ki lf km lg js ky kz la lb dt translated">远程服务器上项目的路径</li><li id="acb7" class="kr ks hu ix b iy lc jc ld ke le ki lf km lg js ky kz la lb dt translated">对于密码，在这个文件中写这个不是一个好的做法，所以这就是为什么我们在每一边都使用<code class="eh mv mw mx my b">%</code>，因为当你开始部署时，终端会要求你输入正确的密码。</li></ul></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><pre class="lm ln lo lp fq mz my na nb aw nc dt"><span id="45d3" class="jt ju hu my b fv nd ne l nf ng">shared_files:<br/>    - .env</span></pre><p id="f8f1" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">在这里，我们定义了所有版本共享的所有文件，在这种情况下，这个<code class="eh mv mw mx my b">environment</code>文件是用于Symfony的，它包含了所有必要的环境变量。因此，无论哪个版本是当前版本，我的所有版本都只有一个配置文件！</p></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><pre class="lm ln lo lp fq mz my na nb aw nc dt"><span id="8e2c" class="jt ju hu my b fv nd ne l nf ng">shared_folders:<br/>    - public/upload</span></pre><p id="53e2" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">这里，文件夹也是如此。我们定义了所有版本需要的所有文件夹。最好的例子就是上传目录。</p></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><pre class="lm ln lo lp fq mz my na nb aw nc dt"><span id="fe68" class="jt ju hu my b fv nd ne l nf ng">on_deploy:<br/>    - "composer install"<br/>    - "php bin/console c:c --env=prod --no-debug"<br/>post_deploy:<br/>    - "php bin/console doctrine:schema:update --force"<br/>    - "php bin/console cache:war --no-debug"</span></pre><p id="9754" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">这里是您的项目需要完美部署的命令行列表。automate有3个可用事件:<code class="eh mv mw mx my b">pre_deploy</code>、<code class="eh mv mw mx my b">on_deploy</code>和<code class="eh mv mw mx my b">post_deploy</code>在这里都有很好的解释:</p><p id="7d72" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">【https://automate-deployer.com/】T4T6】doc</p></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><p id="2543" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated"><em class="iw">现在你的. automate.yml文件已经准备好了！</em></p></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><h2 id="5bcc" class="jt ju hu bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dt translated">二、安装<code class="eh mv mw mx my b">automate.phar</code></h2><p id="9357" class="pw-post-body-paragraph iu iv hu ix b iy kt ja jb jc ku je jf ke lh ji jj ki li jm jn km lj jq jr js hn dt translated">转到项目的根路径</p><pre class="lm ln lo lp fq mz my na nb aw nc dt"><span id="6ec6" class="jt ju hu my b fv nd ne l nf ng">cd /your/path/project</span></pre><p id="6c3a" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">您可以使用以下命令下载Automate的最新版本:</p><pre class="lm ln lo lp fq mz my na nb aw nc dt"><span id="dd11" class="jt ju hu my b fv nd ne l nf ng">curl -LSs https://<!-- -->automate-deployer.com<!-- -->/installer.php | php</span></pre><p id="313a" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">现在，您应该会看到这样的内容:</p><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div class="fe ff nk"><img src="../Images/2157d6e24d0db9b6a8379d9fbd2682df.png" data-original-src="https://miro.medium.com/v2/resize:fit:778/format:webp/1*sEn1spmi86gDJLvArp5kTQ.png"/></div><figcaption class="lt lu fg fe ff lv lw bd b be z ek">Sample with Symfony4 project</figcaption></figure></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><h1 id="188c" class="me ju hu bd jv mf mg mh jz mi mj mk kd ml mm mn kh mo mp mq kl mr ms mt kp mu dt translated">是时候部署了！</h1><p id="627a" class="pw-post-body-paragraph iu iv hu ix b iy kt ja jb jc ku je jf ke lh ji jj ki li jm jn km lj jq jr js hn dt translated">转到项目的根路径并启动automate！</p><pre class="lm ln lo lp fq mz my na nb aw nc dt"><span id="4e04" class="jt ju hu my b fv nd ne l nf ng">cd /your/path/project<br/>php automate.phar deploy preprod</span></pre><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div class="fe ff nl"><img src="../Images/eb3dfc3b4c87885666ebd4b1c49718b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*ejzH-8pV7RHgWa2Y5k0mEQ.png"/></div><figcaption class="lt lu fg fe ff lv lw bd b be z ek">start the deployment</figcaption></figure><p id="677a" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">进入<code class="eh mv mw mx my b">dev_password</code>欣赏表演吧！；)</p><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div class="fe ff nm"><img src="../Images/ac18ae6fb2eca452f512c354bd57337b.png" data-original-src="https://miro.medium.com/v2/resize:fit:534/0*nrsv0e5m_JG3S3Sy.gif"/></div></figure></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><p id="ded2" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">您应该得到这样的结果:</p><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="fe ff nn"><img src="../Images/0a06712d3811f0871e3c37b4266246eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Tlw1ELusGMNB0FQ994xOg.png"/></div></div><figcaption class="lt lu fg fe ff lv lw bd b be z ek">End point of the deployment</figcaption></figure></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><h1 id="5911" class="me ju hu bd jv mf mg mh jz mi mj mk kd ml mm mn kh mo mp mq kl mr ms mt kp mu dt translated">我们的服务器怎么了？</h1><p id="bf00" class="pw-post-body-paragraph iu iv hu ix b iy kt ja jb jc ku je jf ke lh ji jj ki li jm jn km lj jq jr js hn dt translated">如果你去我们的服务器，我们会得到这样的结果:</p><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="fe ff ns"><img src="../Images/864192ac1dbe0e8e4c68f848c78d1faa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r1uuNxzun_tWwTKm2l8_0g.png"/></div></div><figcaption class="lt lu fg fe ff lv lw bd b be z ek">our development server remote</figcaption></figure><ul class=""><li id="4c5a" class="kr ks hu ix b iy iz jc jd ke nh ki ni km nj js ky kz la lb dt translated">当前目录是指向最新版本的符号链接</li><li id="b324" class="kr ks hu ix b iy lc jc ld ke le ki lf km lg js ky kz la lb dt translated">releases目录包含所有最新版本(取决于您在. automate.yml文件中设置的max_releases号)</li><li id="db79" class="kr ks hu ix b iy lc jc ld ke le ki lf km lg js ky kz la lb dt translated">共享目录包含每个版本之间共享的所有文件夹</li></ul><p id="54ca" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">如果我们转到<strong class="ix hv">共享目录</strong>，您可以看到:</p><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div class="fe ff nt"><img src="../Images/749fb54fe9d9b4a657d99207c11f3563.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/format:webp/1*2ybehgIlEcvylebtyoPV_g.png"/></div><figcaption class="lt lu fg fe ff lv lw bd b be z ek">the shared directory</figcaption></figure><p id="d4cb" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">其中包含“真正的”文件夹和文件。另一方面，如果我们转到当前目录，您可以看到:</p><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div class="fe ff nu"><img src="../Images/89a926e58addebed530a94c797e7d90e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*OIEyJTj6IyaG6OczljHmFg.png"/></div></figure><p id="1f14" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated"><code class="eh mv mw mx my b">.env</code>文件是到共享目录中真实文件<code class="eh mv mw mx my b">.env</code>的符号链接。</p></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><p id="804f" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">如您所见，我们部署时没有一行代码！Automate非常容易使用和设置。Automate默认有很多插件，你可以在官方文档中看到这些:</p><p id="33be" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated"><a class="ae lk" href="https://automate-deployer.com/" rel="noopener ugc nofollow" target="_blank">https://automate-deployer.com/</a><a class="ae lk" href="https://automatephp.github.io/doc/#pre_deploy" rel="noopener ugc nofollow" target="_blank">doc</a></p></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><p id="9340" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">最后，我们现在可以想象使用automate和gitlab对每个合并请求进行自动部署！；)</p></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><p id="2975" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ke jh ji jj ki jl jm jn km jp jq jr js hn dt translated">感谢solène Louvrier&amp;<a class="nv nw gr" href="https://medium.com/u/11e4ce38b7c7?source=post_page-----60b7cb9a65c8--------------------------------" rel="noopener" target="_blank">Nicolas Legendre</a>的重读。:)</p></div></div>    
</body>
</html>