<html>
<head>
<title>Migrating to Kubernetes with zero downtime: the why and how</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">零停机时间迁移到Kubernetes:原因和方法</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/migrating-to-kubernetes-with-zero-downtime-the-why-and-how-2c9a1b04de78?source=collection_archive---------12-----------------------#2018-03-21">https://medium.com/hackernoon/migrating-to-kubernetes-with-zero-downtime-the-why-and-how-2c9a1b04de78?source=collection_archive---------12-----------------------#2018-03-21</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div class="ab fr cl iv"><img src="../Images/cacd2237503884748409b4d623227da4.png" data-original-src="https://miro.medium.com/v2/format:webp/1*vOzvwmpF_pvgCnQJNN--qA.png"/></div></figure><blockquote class="iy iz ja"><p id="5550" class="jb jc jd je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="hu">披露:</em> <a class="ae ka" href="https://goo.gl/Sm26zK" rel="noopener ugc nofollow" target="_blank"> Manifold </a>，独立开发者服务市场<em class="hu">，之前赞助过黑客正午。</em> <a class="ae ka" href="https://goo.gl/Sm26zK" rel="noopener ugc nofollow" target="_blank">使用code HACKERNOON2018获得任何服务10美元优惠。</a></p></blockquote><p id="5417" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">我们在<a class="ae ka" href="https://www.manifold.co/" rel="noopener ugc nofollow" target="_blank"> Manifold </a>总是努力从我们所做的每件事情中获得最大收益。为此，我们不断评估我们所做的事情，看它是否仍然符合我们的标准。不久前，我们决定深入研究我们的基础设施设置。</p><p id="42d9" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">在这篇博客文章中，我们将看看我们搬到Kubernetes的原因以及我们问自己的问题。然后，我们将看看我们必须做出的一些妥协，以及为什么我们必须做出这些妥协。我们还将了解如何配置我们的集群来实现我们的目标。</p><p id="7d0e" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">当我们开始多元化时，我们做了我们知道行之有效的事情。使用<a class="ae ka" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank">平台</a>将容器部署在<a class="ae ka" href="https://aws.amazon.com/ec2/" rel="noopener ugc nofollow" target="_blank"> AWS EC2 </a>上，并通过<a class="ae ka" href="https://aws.amazon.com/elasticloadbalancing/" rel="noopener ugc nofollow" target="_blank"> ELBs </a>将其暴露。我们发现自己处于这样一个位置，我们可以花一些额外的时间来构建一个更成熟的平台。最初的实施开始时非常简单，但是我们开始发现一些棘手的问题:</p><ul class=""><li id="5ec8" class="ke kf hu je b jf jg jj jk kb kg kc kh kd ki jz kj kk kl km dt translated">部署缓慢(大约15分钟)</li><li id="cdb9" class="ke kf hu je b jf kn jj ko kb kp kc kq kd kr jz kj kk kl km dt translated">不<a class="ae ka" href="https://continuousdelivery.com/" rel="noopener ugc nofollow" target="_blank">连续交付</a>意味着只有运营人员知道如何部署</li><li id="5e93" class="ke kf hu je b jf kn jj ko kb kp kc kq kd kr jz kj kk kl km dt translated">为每个实例运行一个容器会变得非常昂贵。通过增加集装箱密度，我们可以降低成本</li></ul><p id="410f" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">在过去的一年里，<a class="ae ka" href="https://trends.google.com/trends/explore?date=today%205-y&amp;q=kubernetes" rel="noopener ugc nofollow" target="_blank"> Kubernetes变得非常受欢迎</a>。凭借团队的经验，我们坚信这项新技术的未来。为此，我们创建了第一个<a class="ae ka" href="https://github.com/manifoldco/kubernetes-credentials" rel="noopener ugc nofollow" target="_blank"> Kubernetes集成</a>。我们也开始考虑集成，这将使<a class="ae ka" href="https://hackernoon.com/tagged/kubernetes" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>更容易访问。这就是建造<a class="ae ka" href="https://heighliner.com/" rel="noopener ugc nofollow" target="_blank">Heighliner</a>的想法诞生的地方。</p><p id="8970" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">这让我们想到了另一个我们赖以生存的原则:狗食。通过使用Manifold来构建Manifold，我们可以确切地知道我们的用户需要什么。</p><h1 id="cd5a" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">选择集群</h1><p id="f67b" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">我们问自己的第一个问题是“我们将在哪里运行这个集群？”。AWS还没有提供Kubernetes解决方案，但是Azure和Google云平台会提供。我们需要留在AWS内管理我们自己的集群，还是希望将一切都转移到另一家云提供商？</p><p id="d3e6" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">我们想要回答的关键问题是:</p><ul class=""><li id="b31f" class="ke kf hu je b jf jg jj jk kb kg kc kh kd ki jz kj kk kl km dt translated">我们能否在AWS上创建一个高可用性集群，管理起来有多容易？</li><li id="be8d" class="ke kf hu je b jf kn jj ko kb kp kc kq kd kr jz kj kk kl km dt translated">我们如何连接到我们的<a class="ae ka" href="https://aws.amazon.com/rds/" rel="noopener ugc nofollow" target="_blank"> RDS </a>实例，延迟是多少？</li><li id="562f" class="ke kf hu je b jf kn jj ko kb kp kc kq kd kr jz kj kk kl km dt translated">我们该如何处理我们的KMS加密？</li></ul><h1 id="5b15" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">通过kops实现高可用性(HA)</h1><p id="b931" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">如果我们可以在AWS中轻松地创建和管理集群，那么移动提供商的必要性就会降低。我们用kops 做的最初测试看起来很有希望，我们决定更进一步。是时候建立一个高可用性集群了。</p><p id="2aae" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">为了理解HA对Kubernetes的意义，我们需要首先理解它的一般意义。</p><blockquote class="iy iz ja"><p id="cea8" class="jb jc jd je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">高可用性解决方案的核心基础是冗余、可靠的存储层。高可用性的首要原则是保护数据。不管发生什么，不管着火了，如果你有数据，你可以重建。如果你丢失了数据，你就完了。</p><p id="32e1" class="jb jc jd je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">- <a class="ae ka" href="https://kubernetes.io/docs/admin/high-availability/building/" rel="noopener ugc nofollow" target="_blank"> Kubernetes文档</a></p></blockquote><figure class="lv lw lx ly fq iu fe ff paragraph-image"><div class="ab fr cl iv"><img src="../Images/f83b1705b375d10c00c9368c1ddcd98f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ZUtONpclr9xbQSeEaNk3tw@2x.png"/></div><figcaption class="lz ma fg fe ff mb mc bd b be z ek">Kubernetes components in a High Availability configuration</figcaption></figure><p id="e1de" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">在Kubernetes集群中，这个存储层是<a class="ae ka" href="https://coreos.com/etcd/" rel="noopener ugc nofollow" target="_blank"> etcd </a>，运行在主实例上。etcd是一个分布式的键/值存储，它遵循<a class="ae ka" href="https://raft.github.io/" rel="noopener ugc nofollow" target="_blank"> Raft共识算法</a>来实现仲裁。达到法定人数意味着让一组服务器在一组值上达成一致。要达成这个共识，需要<em class="jd">下级(n/2)+1 </em>各方同意。因此，我们总是需要奇数个实例，至少3个。</p><p id="36aa" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">下面，我们将看看几个可能的中断案例。</p><h1 id="23ce" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">容忍实例失败</h1><p id="34da" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">我们要看的第一个场景是当单个实例终止时会发生什么。我们能从中恢复吗？</p><figure class="lv lw lx ly fq iu fe ff paragraph-image"><div class="ab fr cl iv"><img src="../Images/dded6e1d57134259408ad333d297abb0.png" data-original-src="https://miro.medium.com/v2/1*vlfySroSjHHTJYHWyiUxag.gif"/></div><figcaption class="lz ma fg fe ff mb mc bd b be z ek">Tolerating instance failure</figcaption></figure><p id="5ad9" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">通过指定我们想要的节点数量，kops为每个实例组创建了一个<a class="ae ka" href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/AutoScalingGroup.html" rel="noopener ugc nofollow" target="_blank">自动缩放组</a>。这确保了当一个实例终止时，会创建一个新的实例。这允许我们在丢失一个实例时在集群中保持一致。</p><h1 id="70ea" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">容忍区域故障</h1><p id="8511" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">设置实例故障允许我们容忍单台机器的故障。但是，当整个数据中心因为断电而出现问题时，会发生什么情况呢？这就是<a class="ae ka" href="https://buildazure.com/2017/09/22/azure-regions-and-availability-zones/" rel="noopener ugc nofollow" target="_blank"> <em class="jd">区域</em>和<em class="jd">可用性区域</em> </a>发挥作用的地方。</p><p id="4944" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">再来看看我们的共识公式:<em class="jd"> lower(n/2)+1个实例至少有3个实例</em>。我们可以将其转化为区域，这将导致<em class="jd">较低的(n/2)+1个区域，其中至少有3个区域</em>。</p><figure class="lv lw lx ly fq iu fe ff paragraph-image"><div class="ab fr cl iv"><img src="../Images/f3cae25f37ea47bffa1efbb6e67fb950.png" data-original-src="https://miro.medium.com/v2/format:webp/1*TJ_Wk_VFRdv0AtBrSh5j3Q@2x.png"/></div><figcaption class="lz ma fg fe ff mb mc bd b be z ek">3 master nodes spread across 2 zones</figcaption></figure><figure class="lv lw lx ly fq iu fe ff paragraph-image"><div class="ab fr cl iv"><img src="../Images/99e0eb9ef836af4d5db242b0f845318c.png" data-original-src="https://miro.medium.com/v2/format:webp/1*BrI5ULZenKjSBvLpWF8SDg@2x.png"/></div><figcaption class="lz ma fg fe ff mb mc bd b be z ek">3 master nodes spread across 3 zones</figcaption></figure><p id="3ab3" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">对于kops，这也很简单。通过指定我们希望在其中运行主节点和节点的区域，我们可以在区域级别配置HA。然而，这是我们遇到的第一个障碍。出于任意的原因，当我们启动Manifold时，我们决定使用<em class="jd"> us-west-1 </em>地区。事实证明，这个区域只有两个区域可用。这意味着我们必须找到另一种解决方案来容忍区域故障。</p><h1 id="1c7c" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">容忍区域故障(及其他)</h1><p id="599f" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">主要目标是复制现有的基础架构。我们的旧设置没有跨多个地区运行，所以新设置也不需要。我们相信，在Kubernetes联合会的帮助下，这将更容易实现。</p><h1 id="0aa0" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">具有对等功能的内部网络</h1><p id="9f17" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">由于我们的区域限制，我们不得不寻找其他方法来容忍区域故障。一种选择是在一个单独的区域创建我们的集群。</p><p id="2560" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">每个地区都有自己独立的网络。这意味着我们不能只在一个地区使用另一个地区的资源。为此，我们研究了<a class="ae ka" href="https://docs.aws.amazon.com/AmazonVPC/latest/PeeringGuide/Welcome.html" rel="noopener ugc nofollow" target="_blank">地区间VPC对等</a>。这将允许我们连接到我们的us-west-1地区，并访问<a class="ae ka" href="https://aws.amazon.com/rds/" rel="noopener ugc nofollow" target="_blank"> RDS </a>和<a class="ae ka" href="https://aws.amazon.com/kms/" rel="noopener ugc nofollow" target="_blank"> KMS </a>。</p><figure class="lv lw lx ly fq iu fe ff paragraph-image"><div class="ab fr cl iv"><img src="../Images/336edde39e51bed659e170967cfa3ace.png" data-original-src="https://miro.medium.com/v2/format:webp/1*9QHAnWavHzT-7bG9Kfn3UQ@2x.png"/></div><figcaption class="lz ma fg fe ff mb mc bd b be z ek">Inter Region peering between us-west-1 and us-west-2</figcaption></figure><p id="32ba" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">这也使我们受到挫折。事实证明，<em class="jd"> us-west-1 </em>地区并不是你可以使用的最佳地区。在我们对此进行调查时，<em class="jd"> us-west-1 </em>不支持区域间VPC对等。这意味着我们也不能使用这个解决方案。</p><h1 id="022d" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">决定和妥协</h1><p id="828b" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">有了这些新知识，是时候做决定了。我们是继续使用AWS还是转向另一家提供商？</p><p id="5bc3" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">值得注意的是，转移到另一个提供商也会带来很多额外的开销。我们必须暴露我们的数据库，迁移我们的KMS，重新加密我们所有的数据。</p><p id="7f38" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">最后，我们决定<strong class="je hv">继续使用AWS </strong>并运行容忍节点故障解决方案。随着亚马逊EKS的宣布和地区间对等的即将到来，我们觉得这是足够好的第一步。</p><p id="2995" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">管理您自己的集群可能非常耗时。到目前为止，我们已经看到了最小的影响，但我们肯定<strong class="je hv">考虑到了集群维护</strong>。最耗时的是<strong class="je hv">集群更新</strong>。</p><p id="420a" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">从财务角度来看，我们也妥协了。是的，它会比传统系统便宜，但是会比竞争对手贵。Azure和GCP都免费提供主节点，这大大降低了成本。</p><h1 id="e89f" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">kops提示</h1><p id="061e" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">对我们来说，kops工作得很好。它确实有一组缺省值，您应该知道并覆盖这些缺省值。要做的关键事情之一是<strong class="je hv">启用etcd加密</strong>。这是通过提供<em class="jd"> —加密-etcd-存储</em>标志来完成的。</p><p id="348d" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">默认情况下，kops也不会启用RBAC。RBAC是限制集群中应用程序范围的一个很好的机制。我们强烈建议启用此功能并设置适当的角色。</p><p id="20f8" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">出于安全原因，我们在实例中禁用了SSH。这确保了没有人能够访问这些盒子，即使我们使用<strong class="je hv">私有网络拓扑</strong>运行。</p><h1 id="b283" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">配置集群</h1><p id="e25d" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">集群启动并运行后，就该开始工作了。下一步是配置它，以便我们可以开始在其中部署应用程序。</p><p id="c2a2" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">之前用<a class="ae ka" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>管理我们的服务意味着我们在如何设置方面有相当多的控制权。我们管理我们的elb、DNS、日志等。通过我们的地形结构。我们需要确保我们的Kubernetes设置也能做到这一点。</p><h1 id="ce8e" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">负载平衡</h1><p id="c79c" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">Kubernetes有<a class="ae ka" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">服务</a>和<a class="ae ka" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank">入口</a>的概念。有了服务，就有可能将pod分组——通常由<a class="ae ka" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" rel="noopener ugc nofollow" target="_blank">部署</a>管理——并在同一个端点下公开它们。该端点可以是内部的，也可以是外部的。当将服务配置为<a class="ae ka" href="https://en.wikipedia.org/wiki/Load_balancing_%28computing%29" rel="noopener ugc nofollow" target="_blank">负载平衡器</a>时，Kubernetes将生成一个ELB。这个ELB然后被链接到配置的服务。</p><figure class="lv lw lx ly fq iu fe ff paragraph-image"><div class="ab fr cl iv"><img src="../Images/9260bd5afdcb1c0ddf2ba00a4da112b2.png" data-original-src="https://miro.medium.com/v2/format:webp/1*E-rQPgEEkq-GAJbo9IrM2w@2x.png"/></div><figcaption class="lz ma fg fe ff mb mc bd b be z ek">Service LoadBalancer</figcaption></figure><p id="6389" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">这很好，但是你可以拥有的elb数量是有限制的。通过使用入口，我们可以创建单个ELB，并在集群内路由流量。有几个入口可用，但是我们使用默认的<a class="ae ka" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"> Nginx入口</a>。</p><figure class="lv lw lx ly fq iu fe ff paragraph-image"><div class="ab fr cl iv"><img src="../Images/322fc6f19f7aa7eba1561a855efaddf9.png" data-original-src="https://miro.medium.com/v2/format:webp/1*vIuN-DiCLLtET1USoOJTsQ@2x.png"/></div><figcaption class="lz ma fg fe ff mb mc bd b be z ek">Ingress LoadBalancer</figcaption></figure><p id="e6ed" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">既然我们可以将流量路由到服务，那么是时候通过域来公开这些流量了。为此，我们使用了<a class="ae ka" href="https://github.com/kubernetes-incubator/external-dns" rel="noopener ugc nofollow" target="_blank">外部DNS </a>项目。这是将配置的域名放在您的应用程序附近的好方法。</p><p id="53e9" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">公开服务的最后一步是确保我们通过SSL提供流量。这被证明是很容易的，而且已经有了解决方案。我们选定了<a class="ae ka" href="https://github.com/jetstack/cert-manager" rel="noopener ugc nofollow" target="_blank">证书管理器</a>，它集成了我们的Nginx入口。</p><h1 id="1f9e" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">服务配置</h1><p id="0988" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">服务配置对我们来说轻而易举。我们已经开始用我们的<a class="ae ka" href="https://github.com/manifoldco/terraform-provider-manifold/" rel="noopener ugc nofollow" target="_blank"> Terraform Integration </a>在流形的顶部构建流形。因此，我们需要的所有凭证都已经配置好了。</p><p id="e959" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">我们在设计<a class="ae ka" href="https://github.com/manifoldco/kubernetes-credentials" rel="noopener ugc nofollow" target="_blank"> Kubernetes集成</a>时考虑到了我们的Terraform集成。我们保持底层语义不变，这意味着迁移凭证轻而易举。</p><p id="0a6f" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">我们还增加了自定义秘密类型的<a class="ae ka" href="https://github.com/manifoldco/kubernetes-credentials/pull/20" rel="noopener ugc nofollow" target="_blank">选项。这允许我们配置一个</a><a class="ae ka" href="https://hackernoon.com/tagged/docker" rel="noopener ugc nofollow" target="_blank"> Docker </a> Auth secret。当<a class="ae ka" href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/" rel="noopener ugc nofollow" target="_blank">从私有注册表</a>中提取Docker图像时，您需要这个秘密。</p><h1 id="3f56" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">遥感勘测</h1><p id="64d5" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">运行分布式系统最重要的事情之一是了解系统内部发生了什么。为此，您需要设置集中的日志记录和指标。我们的传统平台中有这一功能，因此我们的新平台中肯定需要这一功能。</p><p id="567f" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">对于日志记录，我们扩展了我们的dogfooding，并设置了我们的LogDNA Integration来收集日志。<a class="ae ka" href="https://logdna.com/" rel="noopener ugc nofollow" target="_blank"> LogDNA </a>本身提供了一个<a class="ae ka" href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/" rel="noopener ugc nofollow" target="_blank"> DaemonSet </a>配置<a class="ae ka" href="https://docs.logdna.com/docs/kubernetes" rel="noopener ugc nofollow" target="_blank">。这允许您将日志从集群传送到它们的平台。</a></p><p id="db67" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">对于指标，我们依赖于<a class="ae ka" href="https://www.datadoghq.com/lpg/?utm_source=Advertisement&amp;utm_medium=GoogleAdsNon1stTierBrand&amp;utm_campaign=GoogleAdsNon1stTierBrand-Non1st&amp;utm_content=Datadog&amp;utm_keyword=%7Bkeyword%7D&amp;utm_matchtype=%7Bmatchtype%7D&amp;gclid=EAIaIQobChMIyviblJDO2QIVFzobCh2sdQtzEAAYASAAEgLUA_D_BwE" rel="noopener ugc nofollow" target="_blank"> Datadog </a>，到目前为止，它对我们来说工作得很好。和LogDNA一样，Datadog也<a class="ae ka" href="https://docs.datadoghq.com/agent/basic_agent_usage/kubernetes/" rel="noopener ugc nofollow" target="_blank">提供了一个DaemonSet配置</a>。他们甚至有一篇关于如何设置的很棒的博客文章。</p><h1 id="0ae4" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">移民</h1><p id="ad73" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">随着集群的配置和应用程序的部署，是时候进行迁移了。为了<strong class="je hv">确保零停机时间</strong>，我们必须分几个阶段进行。</p><p id="8e5d" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">第一阶段是在一个<strong class="je hv">单独的域</strong>上运行集群。通过连接这两个系统，我们可以在不干扰任何人的情况下进行测试。这有助于我们发现并修复一些早期问题。</p><p id="e116" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">在下一阶段，我们将<strong class="je hv">将一些流量路由到Kubernetes集群</strong>。为此，我们设置了<a class="ae ka" href="https://en.wikipedia.org/wiki/Round-robin_DNS" rel="noopener ugc nofollow" target="_blank">循环赛</a>。这是查看您的集群如何处理实际流量的好方法。大约一周后，我们有足够的信心进入下一阶段。</p><figure class="lv lw lx ly fq iu fe ff paragraph-image"><div class="ab fr cl iv"><img src="../Images/523d393e6f0c2fac3584c419ffdef11c.png" data-original-src="https://miro.medium.com/v2/1*FgTuR8t6DuumX3rjuYdVUw.gif"/></div><figcaption class="lz ma fg fe ff mb mc bd b be z ek">DNS round-robin between the Legacy infrastructure and our Kubernetes cluster</figcaption></figure><p id="7dc5" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">第三阶段涉及<strong class="je hv">移除遗留DNS记录</strong>。移除适当的地形配置后，我们所有的流量都将流经Kubernetes！</p><p id="5131" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">因为DNS缓存，我们决定让这个遗留系统再运行几天。这样，拥有缓存DNS条目的用户就不会遇到错误。这也为我们提供了回滚的可能性，以防出现问题。</p><h1 id="883c" class="ks kt hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">结论</h1><p id="d0ad" class="pw-post-body-paragraph jb jc hu je b jf lq jh ji jj lr jl jm kb ls jp jq kc lt jt ju kd lu jx jy jz hn dt translated">既然我们已经迁移了，我们可以回顾过去。我们的团队和公司称这次迁移是成功的。我们<strong class="je hv">将部署时间从大约15分钟减少到大约1.5分钟</strong>，并通过这样做成功<strong class="je hv">削减了运营成本</strong>。</p><p id="d9ce" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">我们还没有完成我们的持续交付渠道，但我们正在努力。我们已经开始研究Heighliner，它首先会帮助我们自己，但希望也能帮助其他人。</p><p id="5a3a" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">我们遇到了一个重大挫折:没有3个可用区域。这<strong class="je hv">阻止了我们跨区域运行高可用性</strong>。这是我们为了让系统正常运行而做出的妥协，我们将很快解决这个问题。</p><p id="9795" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">哦，还有一件事。<strong class="je hv">如此。很多。YAML </strong>。这就是Heighliner将帮助我们的地方。</p></div><div class="ab cl md me hc mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hn ho hp hq hr"><p id="eb18" class="pw-post-body-paragraph jb jc hu je b jf jg jh ji jj jk jl jm kb jo jp jq kc js jt ju kd jw jx jy jz hn dt translated">对梅格·史密斯为这篇博文制作的图片大加赞赏。</p><figure class="lv lw lx ly fq iu"><div class="bz el l di"><div class="mk ml l"/></div></figure></div></div>    
</body>
</html>