<html>
<head>
<title>Blue/Green Infrastructure with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有地形的蓝色/绿色基础设施</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/blue-green-infrastructure-with-terraform-d5f9e8f79ed4?source=collection_archive---------0-----------------------#2018-03-22">https://medium.com/hackernoon/blue-green-infrastructure-with-terraform-d5f9e8f79ed4?source=collection_archive---------0-----------------------#2018-03-22</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="4eaa" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">降低在云中引入突破性变化的恐惧</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/44917ca763aa5c2ec2ab4c5290505fcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0mCunIKB0wdEl07K0nCe6A.jpeg"/></div></div></figure><p id="cd02" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt kr translated"><span class="l ks kt ku bm kv kw kx ky kz di"> I </span>作为代码的基础结构现在是很酷的事情之一。在过去的两年里，每一次与DevOps相关的会议都会有一两次关于这个主题的演讲，这是一件好事。</p><p id="f4af" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">随着DevOps运动的开展，T2哈希公司成为该领域最受尊敬的公司之一。今天我将谈论他们的一种产品:<a class="ae la" href="https://www.hashicorp.com/products/terraform" rel="noopener ugc nofollow" target="_blank"> <strong class="jx hv"> Terraform </strong> </a>。</p><h1 id="62f6" class="lb lc hu bd ld le lf lg lh li lj lk ll ja lm jb ln jd lo je lp jg lq jh lr ls dt translated">什么是地形？</h1><p id="a1fe" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">Terraform是一种工具，允许以声明的方式轻松管理云资源。使用一种简单的编程语言，它可以让您定义云基础设施的大致形状，包括VPC、子网、计算实例、负载平衡器、DNS记录等。它适用于所有主要的云提供商，但并不是与云无关。这意味着，例如，您可以在AWS或Google Cloud中创建一个负载平衡器，但是每个负载平衡器的代码都略有不同。</p><h1 id="d666" class="lb lc hu bd ld le lf lg lh li lj lk ll ja lm jb ln jd lo je lp jg lq jh lr ls dt translated">什么是蓝色/绿色部署？</h1><p id="8b32" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">蓝色/绿色部署是DevOps的一种做法，旨在通过创建所需组件的新副本来减少更新时的停机时间，同时保持当前的。<br/>鉴于此，您将看到系统的两个版本:一个是实际版本(<em class="ly">蓝色</em>)另一个是新版本(<em class="ly">绿色</em>)。当新版本启动并运行时，您可以无缝切换流量。这不仅有助于减少停机时间，也有助于在发生错误时缩短回滚时间。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff lz"><img src="../Images/3e38ed1c5e8390b3d97372b952baf3d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7jSS2x7NpyGaSW5q3DlufA.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">Example 1</figcaption></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff me"><img src="../Images/f7ec954a6d3a6e7c6a6ccafd01a5c6bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*EfsTwfBg-_KtOgy9-7Ga-A.gif"/></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">Example 2</figcaption></figure><h1 id="cc79" class="lb lc hu bd ld le lf lg lh li lj lk ll ja lm jb ln jd lo je lp jg lq jh lr ls dt translated">蓝色/绿色基础设施</h1><p id="eee9" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">虽然蓝色/绿色部署是一种更常用于应用程序部署的技术，但云成本的降低，加上我们现在拥有的工具，使得拥有整个云基础架构的两个拷贝几乎没有痛苦成为可能。</p><p id="65ef" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">需要注意的是，对整个云基础架构进行蓝色/绿色部署不是一个万灵药，如果您要做一些小的更改(例如，向堆栈中添加一个新的EC2实例)，肯定会有点过分。但是对于重大/突破性的变化来说，这是一个胜利，我个人建议这样做。</p></div><div class="ab cl mf mg hc mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="hn ho hp hq hr"><h1 id="9bd2" class="lb lc hu bd ld le mm lg lh li mn lk ll ja mo jb ln jd mp je lp jg mq jh lr ls dt translated">地形前来救援！</h1><p id="40a0" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">在本教程中，我将使用亚马逊网络服务，但是代码不会因其他供应商而有太大变化。</p><p id="ac00" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">完成此操作后，您将能够创建一个包含以下内容的基础架构:</p><ul class=""><li id="a1ce" class="mr ms hu jx b jy jz kb kc ke mt ki mu km mv kq mw mx my mz dt translated">虚拟私有云</li><li id="d1e4" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated">三个子网，每个子网位于不同的可用性区域</li><li id="4663" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated">安全小组</li><li id="43db" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated">三个EC2实例服务于端口80上的NGINX服务器(每个实例位于不同的子网中)</li><li id="1c1b" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated">指向这些实例的负载平衡器</li></ul><p id="6c6f" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然后，您将能够:</p><ul class=""><li id="fcfc" class="mr ms hu jx b jy jz kb kc ke mt ki mu km mv kq mw mx my mz dt translated">改变基础设施</li><li id="44a6" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated">利用这一变化创建全新的基础架构</li><li id="9173" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated">通过新的基础架构切换流量</li><li id="526b" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated">摧毁旧的基础设施</li><li id="07a9" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated">利润</li></ul><p id="e703" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">完整示例可在<a class="ae la" href="https://github.com/santiagopoli/terraform-examples/tree/master/blue-green" rel="noopener ugc nofollow" target="_blank">https://github . com/santiagopoli/terra form-examples/tree/master/blue-green</a>上查看</p><p id="e93c" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为了遵循本教程，您需要在您的环境中配置您的AWS凭证，并且至少附加了<strong class="jx hv"> EC2FullAccess </strong>策略。</p><h2 id="7700" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">创建VPC(虚拟私有云)</h2><p id="566e" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">我知道这是一个地形教程，但推荐的做法是有一个手动创建的VPC。您可以使用Terraform创建VPC，但有许多外部服务需要事先知道您的VPC ID，因此最好不要每次在蓝/绿部署时都创建新的VPC。</p><p id="00ca" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">此外，您可能拥有由组织中的另一个团队在外部创建的安全组。为此，我们将使用AWS控制台创建一个VPC。您也可以通过命令行执行以下操作来创建VPC:</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="779e" class="nf lc hu nu b fv ny nz l oa ob">(change the CIDR block to anything you like)</span><span id="64cc" class="nf lc hu nu b fv oc nz l oa ob"><strong class="nu hv">&gt; aws ec2 create-vpc --cidr-block 10.0.0.0/16</strong></span><span id="5deb" class="nf lc hu nu b fv oc nz l oa ob">{<br/>  "Vpc": {<br/>      "VpcId": "<strong class="nu hv">vpc-ff7bbf86</strong>",<br/>      "InstanceTenancy": "default",<br/>      "Tags": [],<br/>      "CidrBlockAssociations": [<br/>          {<br/>              "AssociationId": "vpc-cidr-assoc-6e42b505",<br/>              "CidrBlock": "10.0.0.0/16",<br/>              "CidrBlockState": {<br/>                  "State": "associated"<br/>              }<br/>          }<br/>      ],<br/>      "Ipv6CidrBlockAssociationSet": [],<br/>      "State": "pending",<br/>      "DhcpOptionsId": "dopt-38f7a057",<br/>      "CidrBlock": "10.0.0.0/16",<br/>      "IsDefault": false<br/>  }<br/>}</span></pre><p id="53b8" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">记下你的<strong class="jx hv"> VpcId </strong>，因为你马上就会用到它。</p><h2 id="78f9" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">安装Terraform</h2><p id="5a2a" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">你可以通过<a class="ae la" href="https://www.terraform.io/downloads.html" rel="noopener ugc nofollow" target="_blank">这个链接</a>或者使用任何软件包管理器(brew，apt)来下载Terraform</p><h2 id="fa96" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">创建项目</h2><p id="c32d" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">在你的工作区创建一个新文件夹，命名为<strong class="jx hv"> terraform_blue_green。</strong>然后，初始化一个GIT存储库，添加一个简单的。忽略。terraform文件夹，用你喜欢的文本编辑器打开文件夹。在我的例子中，我将使用<a class="ae la" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> Visual Studio代码</a>。</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="8a76" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; mkdir terraform_blue_green<br/>&gt; cd terraform_blue_green<br/>&gt; git init<br/>&gt; echo .terraform &gt;&gt; .gitignore<br/>&gt; code .</strong></span></pre><h2 id="8b2f" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">初始化地形状态</h2><p id="5c24" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">Terraform将基础设施的状态存储在一个JSON文件中。建议(也是本教程的要求)将该文件存储在外部后端，如亚马逊S3。由于我在本教程中使用AWS，我将坚持使用S3，但是<a class="ae la" href="https://www.terraform.io/docs/backends/types/index.html" rel="noopener ugc nofollow" target="_blank"> Terraform在每个提供者</a>中支持相同的功能。</p><p id="26eb" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">首先，您需要创建状态所在的S3存储桶。您可以通过转到S3控制台或执行以下操作来完成此操作:</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="9eff" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; aws s3api create-bucket --bucket terraform-bluegreen</strong></span></pre><p id="c352" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然后，在项目文件夹中创建一个名为<strong class="jx hv"> bootstrap.tf </strong>的文件，内容如下。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="od oe l"/></div></figure><p id="03c9" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在这个文件中，我们定义了</p><ul class=""><li id="fffd" class="mr ms hu jx b jy jz kb kc ke mt ki mu km mv kq mw mx my mz dt translated">基础设施的<strong class="jx hv">版本</strong></li><li id="4f2f" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated">我们将使用的<strong class="jx hv">云提供商</strong>(在这里是AWS)</li><li id="89d4" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated">将保存状态的<strong class="jx hv">后端</strong>(在本例中是S3)，以及附加到它的配置。</li></ul><p id="4c95" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">文件准备就绪后，在项目文件夹中运行以下命令:</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="45cf" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; terraform init</strong></span><span id="d0bd" class="nf lc hu nu b fv oc nz l oa ob">Initializing the backend...</span><span id="a0d8" class="nf lc hu nu b fv oc nz l oa ob">Successfully configured the backend "s3"! Terraform will automatically<br/>use this backend unless the backend configuration changes.</span><span id="5cb5" class="nf lc hu nu b fv oc nz l oa ob">Initializing provider plugins...<br/>- Checking for available provider plugins on <a class="ae la" href="https://releases.hashicorp.com" rel="noopener ugc nofollow" target="_blank">https://releases.hashicorp.com</a>...<br/>- Downloading plugin for provider "aws" (1.11.0)...</span><span id="7ff0" class="nf lc hu nu b fv oc nz l oa ob">Terraform has been successfully initialized!</span></pre><h2 id="bb74" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">使用Terraform中的现有资源</h2><p id="10bf" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">因为我们需要之前创建的VPC的ID来在我们的基础设施中做任何事情，所以我们将把它存储在一个变量中。为此，创建一个名为<strong class="jx hv"> vpc.tf </strong>的文件，内容如下:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="od oe l"/></div></figure><h2 id="7db9" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">创建我们的第一个资源:子网</h2><p id="a89e" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">要做任何有用的事情，我们首先需要子网。我们将创建三个，每个位于不同的可用性区域。创建一个名为<strong class="jx hv"> subnets.tf，</strong>的文件，内容如下:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="od oe l"/></div></figure><p id="94e0" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在该文件中，我们创建了三个子网，分别指定:</p><ul class=""><li id="0045" class="mr ms hu jx b jy jz kb kc ke mt ki mu km mv kq mw mx my mz dt translated"><strong class="jx hv">计数:</strong>我们想要创建的子网数量</li><li id="2550" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv"> Availability zone: </strong>在本例中，我们使用了<em class="ly"> element() </em>函数，该函数接受一个列表和一个索引，并返回元素，即使索引大于元素的数量。这有助于为每个子网分配不同的可用性区域。</li><li id="cb6e" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv"> VPC ID </strong></li><li id="d52e" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv"> CIDR阻滞:</strong>这可能是最令人困惑的部分。我们将之前定义的<strong class="jx hv"> infrastructure_version </strong>变量插入到CIDR块中。这将有助于将来创建第二个版本。您可以使用您在VPC中定义的块来更改CIDR块。</li><li id="9280" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated">默认情况下，为分配给该子网的任何网络接口分配一个<strong class="jx hv">公共IP </strong></li><li id="34af" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv">名称:</strong>我们已经将基础设施版本添加到其中</li></ul><p id="fa7c" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">文件准备就绪后，首先执行以下操作:</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="f1b6" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; terraform plan</strong></span><span id="ee24" class="nf lc hu nu b fv oc nz l oa ob">+ aws_subnet.terraform-blue-green[0]<br/>...</span><span id="f7b8" class="nf lc hu nu b fv oc nz l oa ob">+ aws_subnet.terraform-blue-green[1]<br/>...</span><span id="0281" class="nf lc hu nu b fv oc nz l oa ob">+ aws_subnet.terraform-blue-green[2]<br/>...</span><span id="4d03" class="nf lc hu nu b fv oc nz l oa ob">Plan: 3 to add, 0 to change, 0 to destroy.</span></pre><p id="f86b" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">计划命令做一次预演，告诉你将要做什么改变。在做任何事情之前做计划是很重要的，因为你可以发现错误。在这种情况下，计划告诉我们，它将添加三个子网，这就是我们想要的。</p><p id="bda7" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">所以现在我们可以运行这个:</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="bcd6" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; terraform apply</strong></span><span id="3e06" class="nf lc hu nu b fv oc nz l oa ob">Do you want to perform these actions?<br/>  Terraform will perform the actions described above.<br/>  Only 'yes' will be accepted to approve.</span><span id="302f" class="nf lc hu nu b fv oc nz l oa ob">Enter a value: <strong class="nu hv">yes</strong></span><span id="8f9f" class="nf lc hu nu b fv oc nz l oa ob">aws_subnet.terraform-blue-green[0]: Creating...<br/>...<br/>aws_subnet.terraform-blue-green[1]: Creating...<br/>...<br/>aws_subnet.terraform-blue-green[2]: Creating...<br/>...<br/>aws_subnet.terraform-blue-green[0]: Creation complete after 5s <br/>aws_subnet.terraform-blue-green[1]: Creation complete after 5s <br/>aws_subnet.terraform-blue-green[2]: Creation complete after 5s</span><span id="1cc0" class="nf lc hu nu b fv oc nz l oa ob">Apply complete! Resources: 3 added, 0 changed, 0 destroyed.</span></pre><p id="ea83" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在，您可以转到AWS控制台(在<em class="ly">VPC/子网</em>部分下)，您的子网应该会出现</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff of"><img src="../Images/22eb8d5635090b90dc99251d06d01bc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_kwPDurnXM3-GvwbVoju9g.png"/></div></div></figure><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="og oe l"/></div></figure><h2 id="ec68" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">创建安全组</h2><p id="5cd8" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">为了能够在将来访问我们的资源，我们需要在我们的VPC中创建一个安全组。为了简单起见，我们将创建一个安全组来启用来自任何地方的所有入站流量。</p><p id="7179" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在您的项目中创建一个名为<strong class="jx hv"> security_groups.tf </strong>的文件，内容如下:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="od oe l"/></div></figure><p id="6181" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在该文件中，我们为VPC创建了一个安全组(使用其VPC ID)和两条规则:一条用于入站流量，一条用于出站流量。最重要的部分是:</p><ul class=""><li id="4605" class="mr ms hu jx b jy jz kb kc ke mt ki mu km mv kq mw mx my mz dt translated"><strong class="jx hv">起始/终止端口:</strong>规则适用的端口范围。在这种情况下，我们以所有可能的端口范围为目标</li><li id="d239" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv">协议:</strong>您可以使用HTTP、TCP或“-1”，这适用于TCP和HTTP</li><li id="e989" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv"> CIDR块:</strong>规则启用的CIDR块列表。在我们的例子中，我们启用了所有ipv4流量。</li></ul><p id="fc31" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">文件准备就绪后，运行<strong class="jx hv">地形计划</strong>和<strong class="jx hv">地形应用</strong>。之后，我们应该能够在AWS控制台中看到我们的安全组(在<em class="ly">EC2/安全组</em>下)。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff oh"><img src="../Images/51778fbfb9c007908ae319896de33fa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*enn6J_uAH0ePJooFIaN7jQ.png"/></div></div></figure><h2 id="31ec" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">创建SSH密钥</h2><p id="6044" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">为了以后能够访问AWS实例，我们需要为它分配一个SSH密钥。</p><p id="65a2" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">首先，使用<strong class="jx hv"> ssh-keygen: </strong>创建一个密钥对</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="5760" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; mkdir keypairs</strong><br/><strong class="nu hv">&gt; ssh-keygen -f keypairs/keypair -P ""</strong></span><span id="e09d" class="nf lc hu nu b fv oc nz l oa ob">Generating public/private rsa key pair.<br/>Your identification has been saved in keypairs/keypair.<br/>Your public key has been saved in keypairs/keypair.pub.</span></pre><p id="c5e5" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">鉴于这是一个教程，不要费心将私钥移动到一个安全的地方(但你一定要这样做)。</p><p id="a8ad" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然后，在项目的根文件夹中创建一个名为<strong class="jx hv"> keypairs.tf </strong>的文件。给它这个内容:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="od oe l"/></div></figure><p id="cc41" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然后做:</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="4d91" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; terraform plan</strong></span><span id="7d71" class="nf lc hu nu b fv oc nz l oa ob">+ aws_key_pair.key_pair<br/>...</span><span id="d07d" class="nf lc hu nu b fv oc nz l oa ob">Plan: 1 to add, 0 to change, 0 to destroy.</span><span id="ef41" class="nf lc hu nu b fv oc nz l oa ob"><strong class="nu hv">&gt; terraform apply</strong></span><span id="5ec2" class="nf lc hu nu b fv oc nz l oa ob">Terraform will perform the following actions:</span><span id="a1a9" class="nf lc hu nu b fv oc nz l oa ob">+ aws_key_pair.terraform-blue-green<br/>...</span><span id="0952" class="nf lc hu nu b fv oc nz l oa ob">Plan: 1 to add, 0 to change, 0 to destroy.</span><span id="86c6" class="nf lc hu nu b fv oc nz l oa ob">Do you want to perform these actions?<br/>  Terraform will perform the actions described above.<br/>  Only 'yes' will be accepted to approve.</span><span id="7e7d" class="nf lc hu nu b fv oc nz l oa ob">Enter a value: yes</span><span id="cbba" class="nf lc hu nu b fv oc nz l oa ob">Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span></pre><p id="8534" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在，密钥出现在AWS控制台上(在<em class="ly">EC2/密钥对</em>下)</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff oi"><img src="../Images/e9c5ed030cf317ee2cee6aca9d5468d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TgPGjo5np2ULeeQFPPLCbQ.png"/></div></div></figure><h2 id="c4ca" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">创造(终于！)EC2实例</h2><p id="7e9a" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">创建一个名为<strong class="jx hv"> instances.tf </strong>的文件，并粘贴以下内容:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="od oe l"/></div></figure><p id="ba27" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">让我们稍微解释一下这个文件:</p><p id="2642" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我们已经创建了一个类型为<strong class="jx hv"> aws_instance </strong>的资源，参数如下:</p><ul class=""><li id="7f69" class="mr ms hu jx b jy jz kb kc ke mt ki mu km mv kq mw mx my mz dt translated"><strong class="jx hv">计数:</strong>该类型资源的数量。在这种情况下，我们将创建3个实例</li><li id="f911" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv"> AMI: </strong>实例的Amazon映像。在本例中，我们选择了官方的AWS ECS映像，因为我们将在其中运行一个docker容器。请记住，这个AMI只在美国-西方-2地区有效，所以如果你在另一个地区，请检查这个链接。</li><li id="b8f6" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv">实例类型:</strong>实例的实例类型</li><li id="dd15" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv">子网Id: </strong>如上所述，<em class="ly"> element() </em>函数接受一个列表和一个索引，并返回元素，即使索引大于元素的数量。这允许我们为每个实例分配不同的子网id。</li><li id="f2e7" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv">密钥名:</strong>密钥对的名称。我们选择了之前创建的那个</li><li id="8769" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv">用户数据:</strong>这允许我们为实例分配一个初始化脚本。在我们的例子中，我们运行一个NGINX Docker容器，并在端口80公开它。有更好的方法来定义用户数据脚本，但是我们现在保持简单。</li></ul><p id="b478" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">文件就绪后，运行:</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="0f8f" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; terraform plan</strong></span><span id="c480" class="nf lc hu nu b fv oc nz l oa ob">Terraform will perform the following actions:</span><span id="eba5" class="nf lc hu nu b fv oc nz l oa ob">+ aws_instance.terraform-blue-green[0]<br/>...</span><span id="7ed8" class="nf lc hu nu b fv oc nz l oa ob">+ aws_instance.terraform-blue-green[1]<br/>...<br/>+ aws_instance.terraform-blue-green[2]<br/>...</span><span id="921f" class="nf lc hu nu b fv oc nz l oa ob">Plan: 3 to add, 0 to change, 0 to destroy.</span><span id="2ba0" class="nf lc hu nu b fv oc nz l oa ob"><strong class="nu hv">&gt; terraform apply</strong></span><span id="44b3" class="nf lc hu nu b fv oc nz l oa ob">Terraform will perform the following actions:</span><span id="cc63" class="nf lc hu nu b fv oc nz l oa ob">+ aws_instance.terraform-blue-green[0]<br/>...<br/>+ aws_instance.terraform-blue-green[1]<br/>...<br/>+ aws_instance.terraform-blue-green[2]<br/>...</span><span id="f431" class="nf lc hu nu b fv oc nz l oa ob">Plan: 3 to add, 0 to change, 0 to destroy.</span><span id="e534" class="nf lc hu nu b fv oc nz l oa ob">Do you want to perform these actions?<br/>  Terraform will perform the actions described above.<br/>  Only 'yes' will be accepted to approve.</span><span id="0470" class="nf lc hu nu b fv oc nz l oa ob">Enter a value: <strong class="nu hv">yes</strong></span><span id="cf11" class="nf lc hu nu b fv oc nz l oa ob">....</span><span id="41ab" class="nf lc hu nu b fv oc nz l oa ob">Apply complete! Resources: 3 added, 0 changed, 0 destroyed.</span><span id="8879" class="nf lc hu nu b fv oc nz l oa ob"><strong class="nu hv">Outputs:</strong></span><span id="9788" class="nf lc hu nu b fv oc nz l oa ob"><strong class="nu hv">instance_public_ips = [<br/>    ip1,<br/>    ip2,<br/>    ip3<br/>]</strong></span></pre><p id="6bfb" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">当命令完成时，您将能够在AWS控制台中看到实例</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff oj"><img src="../Images/ea7772b83e48c5698d0410643cfe0ad0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BvpwhINalhoUcpfcV5qiag.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">As you see, every of them are on different availability zones.</figcaption></figure><p id="e343" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">从浏览器访问您的任何实例(通过它们的公共IP)应该会显示:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff ok"><img src="../Images/2546e9527cf32d70fdbf9fc9a996daa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VRuSEsBB8F1s9SqgDLUOJg.png"/></div></div></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff ol"><img src="../Images/ab40e5ac9982eea5540dd543801ac45c.png" data-original-src="https://miro.medium.com/v2/resize:fit:630/1*DBGdHlkB6DVjBy62d3TANQ.gif"/></div></figure><h2 id="ddf9" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">添加负载平衡器</h2><p id="9579" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">使用以下内容创建一个名为load_balancers.tf的文件:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="od oe l"/></div></figure><p id="47e4" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在这个文件中，我们创建了一个负载平衡器</p><ul class=""><li id="ebe3" class="mr ms hu jx b jy jz kb kc ke mt ki mu km mv kq mw mx my mz dt translated"><strong class="jx hv">名称</strong>:不言自明</li><li id="f3a8" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv">子网</strong>:负载平衡器可用的子网</li><li id="0deb" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv">安全组:</strong>我们已经添加了之前创建的安全组，以便能够访问它</li><li id="6f51" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv">实例:</strong>我们已经添加了之前创建的实例</li><li id="5637" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv">监听器:</strong>我们添加了一个监听器，监听负载平衡器的80端口，并指向实例的80端口</li><li id="5a85" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv"> Healthcheck: </strong>我们添加了一个简单的HTTP Healthcheck，目标是实例的端口80。</li><li id="66b4" class="mr ms hu jx b jy na kb nb ke nc ki nd km ne kq mw mx my mz dt translated"><strong class="jx hv">输出:</strong>我们添加了一个显示负载平衡器公共DNS的输出</li></ul><p id="c06c" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">文件准备就绪后，进行<strong class="jx hv">地形计划</strong>和<strong class="jx hv">地形应用。当执行结束时，它应该输出负载平衡器的公共dns。</strong></p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="0860" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; terraform apply</strong></span><span id="8494" class="nf lc hu nu b fv oc nz l oa ob">....</span><span id="5ec8" class="nf lc hu nu b fv oc nz l oa ob">Outputs:<br/>...</span><span id="c7e8" class="nf lc hu nu b fv oc nz l oa ob"><strong class="nu hv">load_balancer_dns = terraform-blue-green-v1-xxxxxx.us-west-2.elb.amazonaws.com</strong></span></pre><p id="10c0" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">从浏览器访问负载平衡器的公共DNS应该会显示NGINX页面。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff om"><img src="../Images/905ec6d8318b6720fafe819b82706f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ufXWFosKpgpm1JE0Xdsm3g.png"/></div></div></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff ok"><img src="../Images/2546e9527cf32d70fdbf9fc9a996daa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VRuSEsBB8F1s9SqgDLUOJg.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">Yes, I’ve used the same screenshot twice</figcaption></figure><p id="95aa" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">您也应该能够在AWS控制台中看到它(在<em class="ly">EC2/负载平衡器</em>下)</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff on"><img src="../Images/e46bb35cb85416785779cd2677de473d.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/format:webp/1*NTprcG-dGiG8xJqOLrHLtg.png"/></div></figure><p id="1e1e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><strong class="jx hv">(可选)为负载平衡器V1分配一个DNS记录</strong></p><p id="aa44" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我不打算过多地讨论这种情况，但是我最终在生产中所做的是创建一个指向负载平衡器的特定版本的DNS记录。terraform中的一个例子是:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="od oe l"/></div></figure><h2 id="7902" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">提交您的更改</h2><p id="134b" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">提交到目前为止所做的更改</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="2d23" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; git add .<br/>&gt; git commit -m "Version 1"</strong></span></pre><h2 id="7984" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">手动将DNS记录指向负载平衡器</h2><p id="9bc2" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated"><strong class="jx hv"> DevOps不仅仅是自动化</strong>。在某些情况下，进行最少的人际互动是一个很好的实践。在我们的例子中，我们将为所需的基础设施版本分配一个DNS记录(通过负载平衡器)。</p><p id="a322" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为了能够执行这一步，你需要有一个注册域和相应的Route 53托管区域。</p><p id="5c09" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">进入所需的托管区域，创建一个<strong class="jx hv"> A记录</strong>，其<strong class="jx hv">别名为之前创建的<strong class="jx hv">负载平衡器</strong>(地形-蓝色-绿色-v1……)。</strong></p><p id="f077" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这是您的系统的入口点，也是您的客户端将要访问的内容。</p><h2 id="b628" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">创建V2基础设施</h2><p id="ffd4" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">首先，在您的存储库中创建一个新的分支(我强烈建议删除。terraform文件夹):</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="bdff" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; git checkout -b v2<br/>&gt; rm -rf .terraform</strong></span></pre><p id="d439" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在，用以下代码修改bootstrap.tf:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="od oe l"/></div></figure><p id="1529" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如您所见，您需要修改<strong class="jx hv"> infrastructure_version </strong>变量和S3存储桶的<strong class="jx hv">键。如果terraform允许在密钥中插入infrastructure_version变量，我会很高兴，但目前还不可能。但是Github有一个问题。</strong></p><p id="c63b" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在你删除了。terraform文件夹，您需要重新初始化状态:</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="afe0" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; terraform init</strong></span></pre><p id="ad00" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在用以下内容修改instances.tf:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="od oe l"/></div></figure><p id="a727" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">(我们已经<strong class="jx hv">将实例大小从t2.micro更改为t2.medium </strong>。你可以选择你喜欢的任何东西</p><p id="da2a" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">做一个<strong class="jx hv"> terraform计划</strong>会发现，其实terraform会重新创造所有资源。</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="4948" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; terraform plan</strong><br/>...<br/>Plan: 11 to add, 0 to change, 0 to destroy.</span></pre><p id="690c" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">完成<strong class="jx hv"> terraform apply后，</strong>您将拥有一个全新的基础设施，而无需改变旧的基础设施。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff oo"><img src="../Images/3087405b622907e4d05d493d79ac9f5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b9p9HRhfPzxWAK50wY_r5w.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">Instances</figcaption></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff op"><img src="../Images/3ab3df70683cf0054a104783356f34e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ao-aRzRtKG2cI2MH1oMe4w.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">Subnets</figcaption></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff oq"><img src="../Images/9077d799ad1b31fcd33b871381986608.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VHN0mBUQRR6_1wUZr5jXvQ.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">Security Groups</figcaption></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff or"><img src="../Images/564fa66d5a2c343b635eafa667fa672d.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*nHFDTk9XEIsv8oMSX06C-w.png"/></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">Load Balancers</figcaption></figure><h2 id="3e6d" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">通过新的基础设施路由流量</h2><p id="412f" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">正如我们之前在版本1中所做的那样，使用别名将您的DNS记录指向新的负载平衡器。</p><h2 id="31fa" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">删除旧的基础设施</h2><p id="ea1a" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">当所有流量都开始流向新的负载平衡器时，就该删除基础架构的版本1了。</p><p id="75a2" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为此，首先提交版本2中的所有更改，然后再次签出旧版本。删除。terraform文件夹并再次初始化状态。</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="e100" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; git add .<br/>&gt; git commit -m "Version 2"<br/>&gt; git checkout master<br/>&gt; rm -rf .terraform<br/>&gt; terraform init</strong></span></pre><p id="e8ff" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然后，简单地做:</p><pre class="jk jl jm jn fq nt nu nv nw aw nx dt"><span id="3167" class="nf lc hu nu b fv ny nz l oa ob"><strong class="nu hv">&gt; terraform destroy</strong></span><span id="4e1b" class="nf lc hu nu b fv oc nz l oa ob">Terraform will perform the following actions:</span><span id="b5f9" class="nf lc hu nu b fv oc nz l oa ob">- aws_elb.terraform-blue-green</span><span id="fd8d" class="nf lc hu nu b fv oc nz l oa ob">- aws_instance.terraform-blue-green[0]</span><span id="b7e6" class="nf lc hu nu b fv oc nz l oa ob">- aws_instance.terraform-blue-green[1]</span><span id="d39b" class="nf lc hu nu b fv oc nz l oa ob">- aws_instance.terraform-blue-green[2]</span><span id="f3e0" class="nf lc hu nu b fv oc nz l oa ob">- aws_key_pair.terraform-blue-green</span><span id="6c70" class="nf lc hu nu b fv oc nz l oa ob">- aws_security_group.terraform-blue-green</span><span id="d9e8" class="nf lc hu nu b fv oc nz l oa ob">- aws_security_group_rule.terraform-blue-green-inbound</span><span id="e621" class="nf lc hu nu b fv oc nz l oa ob">- aws_security_group_rule.terraform-blue-green-outbound</span><span id="3325" class="nf lc hu nu b fv oc nz l oa ob">- aws_subnet.terraform-blue-green[0]</span><span id="74fc" class="nf lc hu nu b fv oc nz l oa ob">- aws_subnet.terraform-blue-green[1]</span><span id="bba5" class="nf lc hu nu b fv oc nz l oa ob">- aws_subnet.terraform-blue-green[2]</span><span id="6a93" class="nf lc hu nu b fv oc nz l oa ob">Plan: 0 to add, 0 to change, 11 to destroy.</span><span id="d14d" class="nf lc hu nu b fv oc nz l oa ob">Do you really want to destroy?<br/>  Terraform will destroy all your managed infrastructure, as shown above.<br/>  There is no undo. Only 'yes' will be accepted to confirm.</span><span id="43df" class="nf lc hu nu b fv oc nz l oa ob">Enter a value: <strong class="nu hv">yes</strong></span><span id="dfd6" class="nf lc hu nu b fv oc nz l oa ob">...</span><span id="94f3" class="nf lc hu nu b fv oc nz l oa ob">Destroy complete! Resources: 11 destroyed.</span></pre><p id="dbf7" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在，如果您转到AWS控制台，您应该只能看到V2资源。例如，这是销毁版本1后实例的屏幕截图:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff os"><img src="../Images/5b08278ff5cfb951a33a087e49d40bc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OOZWeJFmCLn8z2DP4YlDbw.png"/></div></div></figure><p id="050c" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在，您可以将v2分支合并到主服务器中。如果你这么做只是为了好玩，请为v2做一个<strong class="jx hv">terra form destroy</strong>；)</p><p id="5dfe" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">请记住，您可以在<a class="ae la" href="https://github.com/santiagopoli/terraform-examples/tree/master/blue-green" rel="noopener ugc nofollow" target="_blank">https://github . com/santiagopoli/terra form-examples/tree/master/blue-green</a>上看到完整的示例</p><h2 id="390a" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">一个警告</h2><p id="4eba" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">在本指南中，我们使用DNS记录来选择哪个基础架构版本是生产版本。虽然这在大多数情况下是可行的，但在某些情况下，一些客户端库会缓存DNS条目，因此您应该等待一段时间，让流量从旧的平衡器中流出。您可以通过维护一个手动创建的负载平衡器并更改其实例来解决这个问题。</p><h2 id="7a4a" class="nf lc hu bd ld ng nh ni lh nj nk nl ll ke nm nn ln ki no np lp km nq nr lr ns dt translated">结论</h2><p id="1fb2" class="pw-post-body-paragraph jv jw hu jx b jy lt iv ka kb lu iy kd ke lv kg kh ki lw kk kl km lx ko kp kq hn dt translated">Terraform提供了一种清晰的声明式方法，将基础设施定义为代码。由于这一点，我们可以用它来完成几年前似乎不可能的事情。</p><p id="3b77" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我想以这种方法有几个缺点来结束这篇文章，我将在将来写一篇文章解释如何通过使用Terraform模块来实现相同的结果(事实上，这些模块总体上提供了更好的灵活性)。</p></div><div class="ab cl mf mg hc mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="hn ho hp hq hr"><blockquote class="ot"><p id="e793" class="ou ov hu bd ow ox oy oz pa pb pc kq ek translated">感谢阅读！</p></blockquote></div></div>    
</body>
</html>