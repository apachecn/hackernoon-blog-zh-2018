<html>
<head>
<title>jBuilding Realtime Web Applications Using Nest.js and Ably</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Nest.js和Ably构建实时Web应用程序</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/building-real-time-web-applications-using-nest-js-and-ably-d85887e81f06?source=collection_archive---------4-----------------------#2018-03-22">https://medium.com/hackernoon/building-real-time-web-applications-using-nest-js-and-ably-d85887e81f06?source=collection_archive---------4-----------------------#2018-03-22</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="e49e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">到处实时！如果您是行业趋势的忠实追随者，尤其是web开发生态系统，您会同意我的观点，即更大比例的用户喜欢web应用程序的实时响应。</p><p id="40c3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这可以是通知、事件、警报、即时消息或任何类似的形式。只有少数平台提供适用于实时数字体验的实时技术，如游戏和赌博、聊天和社交、数据内容、通知和警报等。这是一家公司大放异彩的地方。</p><p id="4229" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了探索实时技术，我一直想巧妙地尝试一下<a class="ae jp" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank"/>，在看完这个<a class="ae jp" href="https://blog.ably.io/news-flash-ably-is-no-longer-a-pub-sub-messaging-platform-long-live-pub-sub-ee767f29d71a" rel="noopener ugc nofollow" target="_blank">帖子</a>后，我不得不开始工作。所以当我终于有机会时，我能够通过构建下面的应用程序来探索由<a class="ae jp" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank">巧妙地</a>提供的实时功能的神奇之处:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/17ea20766db4d81e7a38523f12e20b02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*S_LRbYpUdaA2s_Nv9jhj-g.gif"/></div></div></figure><p id="fd1d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是一个用Nest.js构建的实时民意调查，由<a class="ae jp" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank">巧妙地</a>提供支持。在这篇文章中，我将一步一步地记录我是如何构建上述演示的过程。</p><h1 id="9635" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">先决条件</h1><p id="6756" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">为了充分利用本教程，建议对TypeScript和Node.js有一个基本的了解。</p><h1 id="ba19" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">工具</h1><p id="2adb" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">我们将使用以下工具来构建此应用程序:</p><ul class=""><li id="02b8" class="lf lg hu it b iu iv iy iz jc lh jg li jk lj jo lk ll lm ln dt translated"><a class="ae jp" href="https://nestjs.com/" rel="noopener ugc nofollow" target="_blank"> Nest.js </a>:一个渐进式Node.js框架，用于构建高效且可伸缩的服务器端应用。它利用TypeScript创建可靠且结构良好的服务器端应用程序。如果你非常熟悉Angular，Nest.js会给你类似的构建Angular应用的经验，但是是在后台。尽管使用现代的<a class="ae jp" href="https://hackernoon.com/tagged/javascript" rel="noopener ugc nofollow" target="_blank"> JavaScript </a> (Typescript)，它与普通的JavaScript非常兼容，这使得它非常容易上手。你可以在这里了解更多信息<a class="ae jp" href="https://docs.nestjs.com/" rel="noopener ugc nofollow" target="_blank">。</a></li></ul><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff lo"><img src="../Images/9434f4b511c87ca27f8ec2f4488df8ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8_uUnP2g8H8Zj3N_KktFtw.png"/></div></div><figcaption class="lp lq fg fe ff lr ls bd b be z ek">Nest.js</figcaption></figure><ul class=""><li id="648c" class="lf lg hu it b iu iv iy iz jc lh jg li jk lj jo lk ll lm ln dt translated">Ably:一个优秀的<a class="ae jp" href="https://hackernoon.com/tagged/realtime" rel="noopener ugc nofollow" target="_blank">实时</a>消息传递平台，可以很容易地为应用程序添加实时功能。</li></ul><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff lt"><img src="../Images/3b0d6e5a91b5078959d9072a01914bf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1016/format:webp/1*6OL2VCCelIWYZOtHWRzKNA.png"/></div><figcaption class="lp lq fg fe ff lr ls bd b be z ek">Ably Realtime</figcaption></figure><ul class=""><li id="2584" class="lf lg hu it b iu iv iy iz jc lh jg li jk lj jo lk ll lm ln dt translated">Axios:一个基于promise的HTTP客户端，可以在浏览器和node.js环境中工作。</li><li id="1569" class="lf lg hu it b iu lu iy lv jc lw jg lx jk ly jo lk ll lm ln dt translated">CanvasJS:一个用于数据可视化的响应性HTML5图表库。</li><li id="4375" class="lf lg hu it b iu lu iy lv jc lw jg lx jk ly jo lk ll lm ln dt translated">最后，我们还需要使用npm安装一些模块</li></ul><h1 id="17f8" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">设置应用程序</h1><p id="6914" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">使用Nest.js设置一个新的应用程序非常容易，但是在我们继续之前，假设您已经安装了node和npm。如果没有，请查看<a class="ae jp" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank"> node.js </a>和<a class="ae jp" href="https://www.npmjs.com/get-npm" rel="noopener ugc nofollow" target="_blank"> npm </a>网站了解安装步骤。</p><p id="ab72" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，使用下面的命令克隆一个新的starter存储库，将目录更改为新创建的项目文件夹，最后安装Nest.js应用程序所需的所有依赖项。</p><pre class="jr js jt ju fq lz ma mb mc aw md dt"><span id="c7ec" class="me kd hu ma b fv mf mg l mh mi">$ git clone https://github.com/nestjs/typescript-starter.git ably-nest-poll</span><span id="ec90" class="me kd hu ma b fv mj mg l mh mi">$ cd ably-nest-poll</span><span id="7a0b" class="me kd hu ma b fv mj mg l mh mi">$ npm install</span></pre><h1 id="7d14" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">运行应用程序</h1><pre class="jr js jt ju fq lz ma mb mc aw md dt"><span id="1743" class="me kd hu ma b fv mf mg l mh mi">$ npm run start</span></pre><p id="cbd7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将在Nest.js (3000)使用的默认端口上启动应用程序。前往<a class="ae jp" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a></p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mk"><img src="../Images/2a970c1f7e0098245802bde20114a93c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PNXj_IB1b_9-Eb7o61VV1A.png"/></div></div></figure><h1 id="bfec" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">Ably帐户设置</h1><p id="2f8b" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">如果你还没有一个ably账户，去他们的网站创建一个。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff ml"><img src="../Images/83cdaf76631ed7db5dc02d98c11c46ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zrIDWviQdahnNpUl47q9tg.png"/></div></div></figure><p id="86ec" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">按照剩下的过程，一旦你完成了，你应该有一个带有私钥的免费账户。您将在您的帐户仪表板上看到一个“API密钥”,这对我们很重要，因为我们将在教程的后面使用它来使用基本认证方案连接到<a class="ae jp" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff ml"><img src="../Images/92c5cad3395c1e985fb796bf5d1ed426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X1JzHrVRH6qSXpg1faK7BA.png"/></div></div></figure><p id="0966" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你会看到，默认情况下，<a class="ae jp" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank">巧妙地为你创建了一个应用程序，你可以随时开始使用。但是，您也可以创建一个新的应用程序，并根据需要进行配置。</a></p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mm"><img src="../Images/a86b02945d1cdf55c259094a585209b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EL3umcPFFKO5JjGi4mQMgQ.png"/></div></div></figure><p id="286e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我给我的取名为<code class="eh mn mo mp ma b">'ably-nest-poll'</code>。请随意选择任何符合您目的的名称。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mq"><img src="../Images/f460fa7dd5f53efd0458ab2fde82ce81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JImPnOWOueaiAWqXYFp1tw.png"/></div></div></figure><h1 id="cb48" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">属国</h1><p id="173a" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">使用<a class="ae jp" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank">节点包管理器</a>为应用程序安装依赖关系:</p><pre class="jr js jt ju fq lz ma mb mc aw md dt"><span id="36df" class="me kd hu ma b fv mf mg l mh mi">npm install ejs ably --save</span></pre><h1 id="87fe" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">引导应用程序</h1><p id="0910" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">Nest.js中的一个核心文件是<code class="eh mn mo mp ma b">'main.ts’</code>这个文件包含了引导我们的应用程序所必需的函数。Nest支持流行的MVC模式，因此允许使用模板引擎。打开<code class="eh mn mo mp ma b">'.src/main.ts’</code>，填入:</p><pre class="jr js jt ju fq lz ma mb mc aw md dt"><span id="36b7" class="me kd hu ma b fv mf mg l mh mi"><strong class="ma hv">import </strong>{ NestFactory } <strong class="ma hv">from </strong>'@nestjs/core';<br/><strong class="ma hv">import </strong>{ ApplicationModule } <strong class="ma hv">from </strong>'./app.module';</span><span id="2507" class="me kd hu ma b fv mj mg l mh mi"><strong class="ma hv">//</strong>import express module<strong class="ma hv"><br/>import </strong>* <strong class="ma hv">as </strong>express <strong class="ma hv">from </strong>'express';</span><span id="cc92" class="me kd hu ma b fv mj mg l mh mi">// path<strong class="ma hv"><br/>import </strong>* <strong class="ma hv">as </strong>path <strong class="ma hv">from </strong>'path';<br/><br/>   <strong class="ma hv">async function </strong>bootstrap() {<br/>   <strong class="ma hv">const </strong>app = <strong class="ma hv">await </strong>NestFactory.create(ApplicationModule);<br/><br/>   // A public folder to serve static files<br/>   <strong class="ma hv">app</strong>.use(express.static(path.join(__dirname, 'public')));</span><span id="5bea" class="me kd hu ma b fv mj mg l mh mi">   <strong class="ma hv">app</strong>.set('views', __dirname + '/views');</span><span id="0638" class="me kd hu ma b fv mj mg l mh mi"><br/>   // set ejs as the view engine<br/>   <strong class="ma hv">app</strong>.set('view engine', 'ejs');<br/><br/>   <strong class="ma hv">await </strong>app.listen(3000);<br/>}<br/>bootstrap();</span></pre><p id="3c6b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我对该文件的默认配置所做的唯一添加是导入Express module，path，并最终将<a class="ae jp" href="http://ejs.co/" rel="noopener ugc nofollow" target="_blank"> ejs </a>设置为应用程序的视图引擎。</p><h1 id="b0f6" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">设置视图</h1><p id="4704" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">为了呈现HTML输出并向用户显示应用程序，我们将在<code class="eh mn mo mp ma b">src</code>文件夹中创建一个名为<code class="eh mn mo mp ma b">views</code>的文件夹。现在，在这个新创建的文件夹中，创建一个新文件，命名为<code class="eh mn mo mp ma b">index.ejs</code></p><p id="2d54" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后将以下代码添加到您的<code class="eh mn mo mp ma b">'index.ejs'</code>文件中:</p><pre class="jr js jt ju fq lz ma mb mc aw md dt"><span id="3d95" class="me kd hu ma b fv mf mg l mh mi">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;<br/>&lt;head&gt;<br/>    &lt;meta charset="UTF-8"&gt;<br/>    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;<br/>    &lt;meta http-equiv="X-UA-Compatible" content="ie=edge"&gt;<br/>    &lt;link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css"&gt;<br/>    &lt;title&gt;Realtime Poll&lt;/title&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>    <br/>    &lt;div class="container"&gt;<br/>        &lt;h1&gt; Marvel Movies &lt;/h1&gt; <br/>        &lt;p&gt; Select your favorite Marvel Movie &lt;/p&gt;   <br/>        <br/>        &lt;form id="opinion-form"&gt;<br/>            &lt;p&gt;<br/>                &lt;input type="radio" name="movie" id="avengers" value="The Avengers"&gt;<br/>                &lt;label for="avengers"&gt;The Avengers&lt;/label&gt;<br/>            &lt;/p&gt;<br/>            <br/>            &lt;p&gt;<br/>                &lt;input type="radio" name="movie" id="black-panther" value="Black Panther"&gt;<br/>                &lt;label for="black-panther"&gt;Black Panther&lt;/label&gt;<br/>            &lt;/p&gt;<br/>            <br/>            &lt;p&gt;<br/>                &lt;input type="radio" name="movie" id="captain-america" value="Captain America"&gt;<br/>                &lt;label for="captain-america"&gt;Captain America&lt;/label&gt;<br/>            &lt;/p&gt; <br/>            <br/>            &lt;p&gt;<br/>                &lt;input type="radio" name="movie" id="other" value="Other"&gt;<br/>                &lt;label for="other"&gt;Something Else &lt;/label&gt;<br/>            &lt;/p&gt;<br/>            &lt;input type="submit" value="Vote" class="btn btn-success"/&gt;<br/>        &lt;/form&gt;<br/><br/>        &lt;br&gt;&lt;br&gt;<br/>        &lt;div id="chart-container" style="height:300px;width:100%;"&gt;<br/><br/>        &lt;/div&gt;<br/>    &lt;/div&gt;<br/>    <br/>    <br/>    &lt;script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"&gt;&lt;/script&gt;<br/>    &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"&gt;&lt;/script&gt;<br/>    &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.17.1/axios.js"&gt;&lt;/script&gt;<br/>    &lt;script src="http://cdn.ably.io/lib/ably.min-1.0.js"&gt;&lt;/script&gt;    <br/>    &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/canvasjs/1.7.0/canvasjs.min.js"&gt;&lt;/script&gt;    <br/>    &lt;script src="/main.js"&gt;&lt;/script&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="10a0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将作为我们的实时投票应用程序的主页。为了让这个页面看起来更好看，我为Materialize、Ably、CanvasJS和JQuery分别添加了一个CDN文件。此外，我还包含了一个带有单选按钮输入字段的表单，最后链接了一个名为<code class="eh mn mo mp ma b">main.js</code>的自定义脚本，我们将在本教程的后面部分访问它。</p><h1 id="d02b" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">搬运路线</h1><p id="5047" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">控制器层在Nest.js中处理路由。它接收传入的请求，并向客户端返回响应。Nest使用控制器元数据<code class="eh mn mo mp ma b">'@Controller'</code>将路由映射到特定的控制器。现在，我们将利用默认控制器来设置我们的演示应用程序的主页。因此，编辑<code class="eh mn mo mp ma b">'.src/app.controller.ts'</code>并添加如下所示的代码:</p><pre class="jr js jt ju fq lz ma mb mc aw md dt"><span id="a214" class="me kd hu ma b fv mf mg l mh mi"><strong class="ma hv">import </strong>{ Get, Controller, Res } <strong class="ma hv">from </strong>'@nestjs/common';<br/><br/>@Controller()<br/><strong class="ma hv">export class </strong>AppController {<br/>   @Get()<br/>   root(@Res() res) {<br/>    res.render('index');<br/>  }<br/>}</span></pre><p id="2eaa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上面的代码让我们通过使用<code class="eh mn mo mp ma b">@Res() </code>装饰器注入响应对象来操作响应。这将确保Nest将每条<code class="eh mn mo mp ma b">'/'</code>路径映射到<code class="eh mn mo mp ma b">'index.ejs'</code>文件。</p><h1 id="aee3" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">创建控制器</h1><p id="3fd5" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">我们需要构建的下一件事是轮询控制器。一旦用户做出选择并提交投票，这将处理每个请求。因此，继续在您的<code class="eh mn mo mp ma b">'src'</code>文件夹中创建一个名为<strong class="it hv"> poll </strong>的新文件夹，然后在其中创建一个文件<code class="eh mn mo mp ma b">'poll.controller.ts'</code>。将以下代码粘贴到新创建的文件中。</p><pre class="jr js jt ju fq lz ma mb mc aw md dt"><span id="2871" class="me kd hu ma b fv mf mg l mh mi"><strong class="ma hv">import </strong>{ Controller, Post, Res, Body } <strong class="ma hv">from </strong>'@nestjs/common';</span><span id="5d51" class="me kd hu ma b fv mj mg l mh mi">// import pollService<strong class="ma hv"><br/>import </strong>{ PollService } <strong class="ma hv">from </strong>'./poll.service';<br/><br/><br/>@Controller('poll')<br/><strong class="ma hv">export class </strong>PollController {</span><span id="401c" class="me kd hu ma b fv mj mg l mh mi">    // inject service<br/>    <strong class="ma hv">constructor</strong>(<strong class="ma hv">private </strong>pollService: PollService) {}<br/><br/>    @Post()<br/>    submitVote(@Res() res, @Body() poll: <strong class="ma hv">string</strong>) {<br/>        <strong class="ma hv">this</strong>.pollService.create(poll);<br/>        res.render('index');<br/>    }<br/>}</span></pre><p id="6cdc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">快速浏览一下上面的代码，您会发现我们导入了一个服务，并通过构造函数将它注入到控制器中，这是Nest推荐的，目的是确保控制器只处理HTTP请求。该服务将执行一项任务，将有效载荷发布到<a class="ae jp" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank">中</a>。我们稍后将创建这个服务<code class="eh mn mo mp ma b">PollService</code>。</p><p id="90be" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，<strong class="it hv">@控制器(' poll') </strong>告诉框架，我们期望这个控制器响应发布到<strong class="it hv"> /poll </strong>路由的请求。</p><h1 id="2095" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">实时服务</h1><p id="b36d" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">基本上，我们希望利用<a class="ae jp" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank"> Ably </a>的核心功能之一，即将消息或有效负载发布到<a class="ae jp" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank"> Ably </a>，并确保该通道上的每个连接客户端或设备通过订阅的方式实时接收它们。这是<a class="ae jp" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank">真正大放异彩的地方；您可以专注于构建应用程序，并允许平台使用其内部基础设施来管理通信，而无需担心这一点</a></p><p id="f41f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们在Nest.js中创建一个组件作为服务。这将用于在指定通道上向<a class="ae jp" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank">发布有效载荷。</a></p><p id="1fcc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Nest.js中的控制器只处理HTTP请求，将复杂的任务委托给组件。这里的组件是带有@Component decorator的普通TypeScript类。因此在<strong class="it hv"> poll </strong>文件夹中创建一个新文件，命名为<code class="eh mn mo mp ma b">poll.service.ts</code></p><pre class="jr js jt ju fq lz ma mb mc aw md dt"><span id="886d" class="me kd hu ma b fv mf mg l mh mi"><strong class="ma hv">import </strong>{ Component } <strong class="ma hv">from </strong>'@nestjs/common';<br/><br/>@Component()<br/><strong class="ma hv">export class </strong>PollService {<br/><br/>    <strong class="ma hv">private </strong>poll: <strong class="ma hv">string</strong>;<br/><br/>    create(poll) {<br/>        <strong class="ma hv">const </strong>Ably = require('ably');</span><span id="6bf2" class="me kd hu ma b fv mj mg l mh mi">        // replace with your API Key <br/>        <strong class="ma hv">var </strong>ably = <strong class="ma hv">new </strong>Ably.Realtime('YOUR_KEY');</span><span id="efab" class="me kd hu ma b fv mj mg l mh mi">        <strong class="ma hv">var </strong>channel = ably.channels.get('ably-nest');<br/><br/>        <strong class="ma hv">const </strong>data = {<br/>            points: 1,<br/>            movie: poll.movie<br/>        };<br/><br/>        channel.publish('vote', data);<br/>    }<br/>}</span></pre><p id="6474" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里，我需要前面安装的ably模块，并传入所需的API键。此外，我创建了一个独特的频道<code class="eh mn mo mp ma b">ably-nest</code>供客户订阅。我还有publish方法，它接受两个参数，一个是可选的消息事件名称，另一个是要发布的有效负载。</p><h1 id="2b3e" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">将这些点连接起来</h1><p id="07d6" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">目前，我们的应用程序不能识别任何新创建的控制器和服务。我们需要通过编辑我们的模块文件<code class="eh mn mo mp ma b">'app.module.ts'</code>来改变这一点，并将控制器放入<code class="eh mn mo mp ma b">'controller'</code>数组，将服务放入<code class="eh mn mo mp ma b">'@Module()</code>装饰器的<code class="eh mn mo mp ma b">'components'</code>数组。</p><pre class="jr js jt ju fq lz ma mb mc aw md dt"><span id="d05b" class="me kd hu ma b fv mf mg l mh mi"><strong class="ma hv">import </strong>{ PollController } <strong class="ma hv">from </strong>'./poll/poll.controller';<br/><strong class="ma hv">import </strong>{ Module } <strong class="ma hv">from </strong>'@nestjs/common';<br/><strong class="ma hv">import </strong>{ AppController } <strong class="ma hv">from </strong>'./app.controller';<br/><strong class="ma hv">import </strong>{ PollService } <strong class="ma hv">from </strong>'./poll/poll.service';<br/><br/>@Module({<br/>  imports: [],<br/>  controllers: [AppController, PollController],<br/>  components: [PollService],<br/>})<br/><strong class="ma hv">export class </strong>ApplicationModule {}</span></pre><h1 id="4913" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">巧妙地插入客户端并更新用户界面</h1><p id="8882" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">在最后阶段之前简单回顾一下。到目前为止，在本教程中，我们已经</p><ul class=""><li id="45a4" class="lf lg hu it b iu iv iy iz jc lh jg li jk lj jo lk ll lm ln dt translated">创建了一个带有单选按钮的表单，供用户投票和提交投票。</li><li id="7f2d" class="lf lg hu it b iu lu iy lv jc lw jg lx jk ly jo lk ll lm ln dt translated">我们进一步在<a class="ae jp" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank">上创建了一个账户</a></li><li id="e0b2" class="lf lg hu it b iu lu iy lv jc lw jg lx jk ly jo lk ll lm ln dt translated">建立主页</li><li id="48ff" class="lf lg hu it b iu lu iy lv jc lw jg lx jk ly jo lk ll lm ln dt translated">创建了一个控制器来处理post路由。</li><li id="be44" class="lf lg hu it b iu lu iy lv jc lw jg lx jk ly jo lk ll lm ln dt translated">设置一个服务，将有效载荷发布到<a class="ae jp" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank">上的一个命名通道<code class="eh mn mo mp ma b">ably-nest</code>上</a>并且</li><li id="951e" class="lf lg hu it b iu lu iy lv jc lw jg lx jk ly jo lk ll lm ln dt translated">最后，我们在应用程序模块中注册了新创建的控制器和服务。</li></ul><p id="e9c7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">还记得我们在<code class="eh mn mo mp ma b">index.ejs</code>文件中包含了一个定制的<code class="eh mn mo mp ma b">'main.js'</code>文件吗？继续在<code class="eh mn mo mp ma b">src</code>文件夹中创建一个名为<code class="eh mn mo mp ma b">public</code>的新文件夹，然后在其中创建<code class="eh mn mo mp ma b">main.js</code>文件。此外，将以下代码添加到文件中。</p><pre class="jr js jt ju fq lz ma mb mc aw md dt"><span id="c763" class="me kd hu ma b fv mf mg l mh mi"><strong class="ma hv">const </strong>form = document.getElementById('opinion-form');<br/><br/>// form submit event<br/>form.addEventListener('submit', (e) =&gt; {<br/>    <strong class="ma hv">const </strong>choice = document.querySelector('input[name=movie]:checked').value;<br/>    <strong class="ma hv">const </strong>data = {movie: choice};<br/>    <br/>    axios.post('/poll', data).then( (data) =&gt; {<br/>        console.log(data);<br/>    });<br/>    e.preventDefault();<br/>});<br/><br/>let dataPoints = [<br/>    {label: 'The Avengers', y: 0},<br/>    {label: 'Black Panther', y: 0},<br/>    {label: 'Captain America', y: 0},<br/>    {label: 'Other', y: 0},<br/>];<br/><br/><strong class="ma hv">const </strong>chartContainer = document.querySelector('#chart-container');<br/><br/><strong class="ma hv">if </strong>(chartContainer) {<br/>    <strong class="ma hv">const </strong>chart = <strong class="ma hv">new </strong>CanvasJS.Chart('chart-container', {<br/>        animationEnabled: <strong class="ma hv">true</strong>,<br/>        theme: 'theme1',<br/>        title: {<br/>            text: 'Favorite Movies'<br/>        },<br/>        data: [<br/>            {<br/>                type: 'column',<br/>                dataPoints: dataPoints<br/>            }<br/>        ]<br/>    });<br/>    <br/>    <br/>    chart.render();<br/>    <br/>    <strong class="ma hv">var </strong>ably = <strong class="ma hv">new </strong>Ably.Realtime('YOUR_KEY');<br/>    <strong class="ma hv">var </strong>channel = ably.channels.get('ably-nest');<br/>    channel.subscribe('vote', <strong class="ma hv">function</strong>(poll) {<br/>        <br/>        dataPoints = dataPoints.map(x =&gt; {<br/>            <strong class="ma hv">if </strong>(x.label == poll.data.movie) {<br/>                x.y += poll.data.points;<br/>                <strong class="ma hv">return </strong>x;<br/>            } <strong class="ma hv">else </strong>{<br/>                <strong class="ma hv">return </strong>x;<br/>            }<br/>        });<br/>        chart.render();<br/>    });<br/>}</span></pre><p id="0a7d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个文件的内容是不言自明的，我们使用<strong class="it hv"> axios </strong>处理表单提交并发送到<code class="eh mn mo mp ma b">poll</code>路径。</p><p id="1c30" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们还为图表设置了一个默认的<code class="eh mn mo mp ma b">dataPoints</code>,并最终订阅了从服务器发布的有效负载。</p><p id="9561" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不要忘记从你的仪表板上用合适的API键替换<code class="eh mn mo mp ma b">YOUR_KEY</code>。</p><h1 id="23e6" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">将这一切结合在一起</h1><p id="d78b" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">如果开发服务器当前正在运行，请重新启动它，并导航到<code class="eh mn mo mp ma b">http://localhost:3000</code>或<code class="eh mn mo mp ma b">http://127.0.0.1:3000</code>进行检查。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mr"><img src="../Images/8ea304c9d1d7e716eb9f0ed125cc0034.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Jd5qXEd-5yJl8qZOwpL58Q.gif"/></div></div></figure><p id="2272" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就是这样。</p><p id="b36c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你错过了任何一个步骤，你可以在GitHub的这里找到这个演示的代码</p><h1 id="6888" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">结论</h1><p id="bd20" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">在本教程中，我们成功实现了两件事:</p><ol class=""><li id="d93f" class="lf lg hu it b iu iv iy iz jc lh jg li jk lj jo ms ll lm ln dt translated">使用Nest.js构建web应用程序入门</li><li id="e7a2" class="lf lg hu it b iu lu iy lv jc lw jg lx jk ly jo ms ll lm ln dt translated">巧妙地探索<a class="ae jp" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank">提供的实时功能</a></li></ol><p id="0885" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你想了解更多关于频道、发布和订阅如何工作的信息，请看<a class="ae jp" href="https://www.ably.io/documentation/realtime/channels-messages" rel="noopener ugc nofollow" target="_blank">实时频道&amp;消息文档</a>或者更好地了解<a class="ae jp" href="https://www.ably.io/features" rel="noopener ugc nofollow" target="_blank"> Ably特性</a>的完整集合。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="mt mu l"/></div></figure></div></div>    
</body>
</html>