<html>
<head>
<title>How to Use rake db Commands In the Correct Way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何正确使用rake db命令</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-use-rake-db-commands-in-the-correct-way-6008a77c2c06?source=collection_archive---------41-----------------------#2018-03-22">https://medium.com/hackernoon/how-to-use-rake-db-commands-in-the-correct-way-6008a77c2c06?source=collection_archive---------41-----------------------#2018-03-22</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="a73a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> Rake </strong>是内置于<strong class="it hv"> Ruby和Rails </strong>中的一个实用程序，它提供了一种管理数据库变更的有效方式。您只需使用命令行就可以轻松地将数据库更改迁移到服务器上！</p><p id="db1b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在应用程序开发过程中，您可能会问自己:</p><ul class=""><li id="6bef" class="jp jq hu it b iu iv iy iz jc jr jg js jk jt jo ju jv jw jx dt translated"><em class="jy">使用<strong class="it hv"> rake数据库命令</strong>时</em>会发生什么？</li><li id="d5bc" class="jp jq hu it b iu jz iy ka jc kb jg kc jk kd jo ju jv jw jx dt translated">我应该什么时候使用它们？</li></ul><p id="a631" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们看看在开发应用程序时如何使用这些命令来更改数据库！</p><h1 id="65f3" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">创造</h1><p id="39b6" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated"><code class="eh lh li lj lk b">$ rake db:create</code> <br/>当您第一次<strong class="it hv">创建【Rails应用程序时，它还没有数据库。为了启动它，您需要确保数据库已经启动并正在运行。</strong></p><p id="fa5a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就像建议每个环境使用<a class="ae ll" href="https://kolosek.com/rails-bundle-install-and-gemfile/" rel="noopener ugc nofollow" target="_blank">不同的宝石</a>一样，你也应该创建三个数据库，分别用于<strong class="it hv">开发</strong>、<strong class="it hv">测试</strong>和<strong class="it hv">生产</strong>环境。您可以在您的<code class="eh lh li lj lk b">config/database.yml</code>文件中配置它们。</p><pre class="lm ln lo lp fq lq lk lr ls aw lt dt"><span id="7d47" class="lu kf hu lk b fv lv lw l lx ly">default: &amp;default<br/>  adapter: postgresql<br/>  encoding: unicode<br/>  username: username<br/>  password: password<br/>  host: localhost<br/>  port: 5432</span><span id="866d" class="lu kf hu lk b fv lz lw l lx ly">development:<br/>  &lt;&lt;: *default<br/>  database: story_dev</span><span id="6766" class="lu kf hu lk b fv lz lw l lx ly">test:<br/>  &lt;&lt;: *default<br/>  database: story_test</span><span id="943f" class="lu kf hu lk b fv lz lw l lx ly">production:<br/>  &lt;&lt;: *default<br/>  database: story</span></pre><h1 id="584e" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">迁移</h1><p id="2af7" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated"><code class="eh lh li lj lk b">rake db:migrate</code> <br/> <strong class="it hv">迁移</strong>设置数据库中的表。当您运行迁移命令时，它会在<code class="eh lh li lj lk b">db/migrate/</code>中查找任何ruby文件，并从最旧的开始执行。每个迁移文件名的开头都有一个<strong class="it hv">时间戳</strong>。</p><blockquote class="ma mb mc"><p id="d9ae" class="ir is jy it b iu iv iw ix iy iz ja jb md jd je jf me jh ji jj mf jl jm jn jo hn dt translated">每次迁移数据库或对其进行任何更改(如添加行或列、添加表或更改数据类型)时，都必须运行此命令，以使更改反映在数据库中。<a class="ae ll" href="https://rails.devcamp.com/learn-ruby-on-rails-from-scratch/building-your-first-rails-application/list-of-database-rake-tasks-in-a-rails-application" rel="noopener ugc nofollow" target="_blank">Rails应用程序中的数据库Rake任务列表</a></p></blockquote><p id="4ace" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当您运行像<a class="ae ll" href="https://kolosek.com/rails-scaffold/" rel="noopener ugc nofollow" target="_blank"> rails generate scaffold </a>、<code class="eh lh li lj lk b">rails generate model</code>或<code class="eh lh li lj lk b">rails generate migration</code>这样的命令时，就会创建迁移。</p><p id="bd30" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里有一个例子，当<a class="ae ll" href="https://kolosek.com/carrierwave-upload-multiple-images/" rel="noopener ugc nofollow" target="_blank">上传图像</a>时，你如何使用<code class="eh lh li lj lk b">rake db:migrate</code>。确保不要在迁移文件中创建数据！</p><h1 id="af16" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">正在初始化</h1><p id="ca22" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated"><code class="eh lh li lj lk b">rake db:schema:load</code> <br/>与<code class="eh lh li lj lk b">rake db:migrate</code>运行尚未运行的迁移不同，<code class="eh lh li lj lk b">rake db:schema:load</code>将<code class="eh lh li lj lk b">db/schema.rb</code>中已经生成的模式加载到数据库中。</p><p id="49e5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在以下情况下，请始终使用此命令:</p><ul class=""><li id="43f7" class="jp jq hu it b iu iv iy iz jc jr jg js jk jt jo ju jv jw jx dt translated">您第一次运行应用程序<strong class="it hv"/>。</li><li id="c861" class="jp jq hu it b iu jz iy ka jc kb jg kc jk kd jo ju jv jw jx dt translated">当您<strong class="it hv">删除数据库</strong>并需要再次创建它时。</li></ul><p id="d659" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jy">当心</em>！如果你在生产服务器上运行<code class="eh lh li lj lk b">rake db:schema:load</code>，你最终会删除所有的生产数据。</p><h1 id="da27" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">播种</h1><p id="9a1f" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated"><code class="eh lh li lj lk b">rake db:seed</code> <br/>我们总是有默认的数据，我们希望在我们的应用程序中进行测试。<strong class="it hv">种子命令</strong>的存在是为了自动化这个过程。</p><p id="e040" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jy">示例</em>:创建一个管理员用户，并将其数据存储在<code class="eh lh li lj lk b">db/seed.rb</code>文件中。当您运行<code class="eh lh li lj lk b">rake db:seed</code>时，它会将所有管理数据加载到您的应用程序中。</p><pre class="lm ln lo lp fq lq lk lr ls aw lt dt"><span id="64a4" class="lu kf hu lk b fv lv lw l lx ly">Admin.create!(email: '<a class="ae ll" href="https://kolosek.com/cdn-cgi/l/email-protection" rel="noopener ugc nofollow" target="_blank">[xxx@example.com]</a>',<br/>              password: 'password',<br/>              password_confirmation: 'password')</span></pre><p id="8c7f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Rails seeding通常用于<strong class="it hv">开发</strong>和/或<strong class="it hv">登台</strong>环境，在生产中只有少数用途。您不希望您的生产应用程序播种虚拟用户！</p><h1 id="8ac9" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">正在回滚</h1><p id="3850" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated"><code class="eh lh li lj lk b">rake db:rollback</code> <br/>您是在不想迁移的情况下创建了迁移，还是只是改变了想法？<em class="jy">不怕！</em>当您运行此命令时，它将查看上次创建的迁移并撤消它！</p><p id="fe8b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jy">示例</em>:让我们以<code class="eh lh li lj lk b">:role</code>为整数创建一个<strong class="it hv">新迁移</strong>，然后<strong class="it hv">运行迁移</strong>。然后我们决定把它变成一个字符串。因此，我们将编辑新创建的迁移并再次运行它，但是什么也没有发生，您的<a class="ae ll" href="https://kolosek.com/factory-girl-associations/" rel="noopener ugc nofollow" target="_blank">测试和工厂</a>将会失败。</p><pre class="lm ln lo lp fq lq lk lr ls aw lt dt"><span id="728d" class="lu kf hu lk b fv lv lw l lx ly">class CreateRoles &lt; ActiveRecord::Migration<br/>  def change<br/>    create_table :roles do |t|<br/>      t.integer :role # we will change this to<br/>      t.string :role<br/>      t.references :user<br/>      t.timestamps<br/>    end<br/>  end<br/>end</span></pre><p id="d996" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">为什么这不起作用？</strong> <br/>使用<code class="eh lh li lj lk b">rake db:migrate</code>命令仅运行最后创建的迁移。这意味着编辑现有迁移不会带来任何变化。为了使这个工作，您将需要运行<code class="eh lh li lj lk b">rake db:rollback</code>来代替。这将告诉Rails做两件事:</p><ol class=""><li id="ddd2" class="jp jq hu it b iu iv iy iz jc jr jg js jk jt jo mg jv jw jx dt translated">撤消您刚才对数据库所做的最后更改。</li><li id="13a1" class="jp jq hu it b iu jz iy ka jc kb jg kc jk kd jo mg jv jw jx dt translated">更新迁移时间戳。</li></ol><h1 id="e0ad" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">落下</h1><p id="f9b3" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated"><code class="eh lh li lj lk b">rake db:drop</code> <br/>有时我们想删除所有的数据和表格，重新开始。这就是<code class="eh lh li lj lk b">rake db:drop</code>的作用。如果您想保留现有的数据，请确保在运行此命令之前对其进行备份。</p><p id="014a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">删除数据库也将删除任何<strong class="it hv">模式冲突</strong>或<strong class="it hv">坏数据</strong>。一旦数据库被删除，您将希望通过重新创建数据库、运行迁移和播种数据来重新开始这个过程。在重建数据库之后，确保您的<a class="ae ll" href="https://kolosek.com/rails-rspec-setup/" rel="noopener ugc nofollow" target="_blank"> RSpec测试</a>通过！</p><p id="36e8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">确保您没有连接到数据库，否则它不会断开。</p><h1 id="fd0a" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">重复定位</h1><p id="29a7" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated"><code class="eh lh li lj lk b">rake db:reset</code> <br/>有时，您可能需要删除本地数据库，并使用从<code class="eh lh li lj lk b">db/seeds.rb</code>加载的数据重新开始。这是一个有用的命令，当您还在弄清楚您的模式，并且经常需要向现有模型添加字段时。</p><p id="2f11" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦使用复位命令，它将执行以下操作:</p><ol class=""><li id="fe2c" class="jp jq hu it b iu iv iy iz jc jr jg js jk jt jo mg jv jw jx dt translated">掉数据库:<code class="eh lh li lj lk b">rake db:drop</code></li><li id="bc9d" class="jp jq hu it b iu jz iy ka jc kb jg kc jk kd jo mg jv jw jx dt translated">加载模式:<code class="eh lh li lj lk b">rake db:schema:load</code></li><li id="5341" class="jp jq hu it b iu jz iy ka jc kb jg kc jk kd jo mg jv jw jx dt translated">种子数据:<code class="eh lh li lj lk b">rake db:seed</code></li></ol><p id="da75" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">为什么是db:schema:load而不是db:migrate？</strong> <br/> <code class="eh lh li lj lk b">rake db:schema:load</code>比<code class="eh lh li lj lk b">rake db:migrate</code>快得多，因为它加载我们已经从<code class="eh lh li lj lk b">db/schema.rb</code>生成的模式，而不是再次经历所有的迁移。</p><p id="a060" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">希望这有助于你理解rake数据库命令之间的主要区别！</p></div><div class="ab cl mh mi hc mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="hn ho hp hq hr"><p id="0299" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jy">原载于2018年3月22日kolosek.com</em><em class="jy">的</em> <a class="ae ll" href="https://kolosek.com/rake-db-commands/" rel="noopener ugc nofollow" target="_blank"> <em class="jy">。</em></a></p></div></div>    
</body>
</html>