<html>
<head>
<title>Resumable file upload in PHP: Handle large file uploads in an elegant way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PHP中的可恢复文件上传:以优雅的方式处理大文件上传</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/resumable-file-upload-in-php-handle-large-file-uploads-in-an-elegant-way-e6c6dfdeaedb?source=collection_archive---------0-----------------------#2018-03-25">https://medium.com/hackernoon/resumable-file-upload-in-php-handle-large-file-uploads-in-an-elegant-way-e6c6dfdeaedb?source=collection_archive---------0-----------------------#2018-03-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><blockquote class="ir is it"><p id="404f" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">曾经在PHP中为大文件上传而挣扎过吗？想知道你是否可以继续上传你离开的地方，而不需要在任何中断的情况下重新上传全部数据？如果这听起来对你来说很熟悉，那么继续读下去。</p></blockquote><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="fe ff jt"><img src="../Images/d969beb9e26692c5954b4d94a8f147db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4GzNFJwBTrA0xvly."/></div></div><figcaption class="kf kg fg fe ff kh ki bd b be z ek">Photo by <a class="ae kj" href="https://unsplash.com/@rawpixel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">rawpixel.com</a> on <a class="ae kj" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="b786" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">文件上传是我们在几乎所有现代web项目中的一项常见任务。有了所有不同的工具，用任何语言实现文件上传功能都不是很难。但是，当涉及到大文件上传时，事情变得有点复杂。</p><p id="4688" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">比方说，你正试图上传一个相当大的文件。你已经等了一个多小时了，上传了90%。然后突然，你的连接中断或浏览器崩溃。上传被中止，您需要从头开始。令人沮丧，不是吗？更糟糕的是，如果你的连接速度很慢，就像世界上很多地方一样，无论你尝试多长时间，每次都只能上传第一部分。</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div class="fe ff kn"><img src="../Images/b6ef23793d7fb886e529c8f22f58bee0.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*vf60tLKejXf1XZgBJcxhMw.png"/></div></figure><p id="8e1d" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">在本帖中，我们将看到一个尝试，通过使用tus协议上传可恢复块中的文件，在<a class="ae kj" href="https://hackernoon.com/tagged/php" rel="noopener ugc nofollow" target="_blank"> PHP </a>中解决这个问题。</p><figure class="ju jv jw jx fq jy"><div class="bz el l di"><div class="ko kp l"/></div><figcaption class="kf kg fg fe ff kh ki bd b be z ek">Resumable File Upload in PHP — Demo</figcaption></figure></div><div class="ab cl kq kr hc ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="hn ho hp hq hr"><h1 id="3172" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">图斯是什么？</h1><p id="2838" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf kk lx ji jj kl ly jm jn km lz jq jr js hn dt translated">Tus是基于HTTP的<a class="ae kj" href="https://tus.io/" rel="noopener ugc nofollow" target="_blank">开放协议，用于可恢复文件上传</a>。可恢复意味着我们可以继续我们离开的地方，而不需要在任何中断的情况下重新上传全部数据。如果用户想要暂停，中断可能是自愿发生的，或者在网络问题或服务器中断的情况下偶然发生的。</p><blockquote class="ir is it"><p id="7a0d" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">Tus协议于2017年5月被Vimeo 采用<a class="ae kj" rel="noopener" href="/vimeo-engineering-blog/vimeo-is-adopting-tus-d5e999acd517">。</a></p></blockquote><h1 id="7bdd" class="kx ky hu bd kz la ma lc ld le mb lg lh li mc lk ll lm md lo lp lq me ls lt lu dt translated">为什么是塔斯？</h1><p id="0a78" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf kk lx ji jj kl ly jm jn km lz jq jr js hn dt translated">引用自<a class="ae kj" rel="noopener" href="/vimeo-engineering-blog/vimeo-is-adopting-tus-d5e999acd517"> Vimeo的博客</a>:</p><blockquote class="mf"><p id="7d50" class="mg mh hu bd mi mj mk ml mm mn mo js ek translated">我们决定在我们的上传栈中使用tus，因为tus协议以简洁和开放的方式标准化了上传文件的过程。这种标准化将允许API开发人员更多地关注他们的应用程序特定的代码，而不是上传过程本身。</p></blockquote><p id="1e36" class="pw-post-body-paragraph iu iv hu ix b iy mp ja jb jc mq je jf kk mr ji jj kl ms jm jn km mt jq jr js hn dt translated">以这种方式上传文件的另一个主要好处是，你可以从笔记本电脑开始上传，甚至可以继续从手机或任何其他设备上传相同的文件。这是增强用户体验的好方法。</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="fe ff mu"><img src="../Images/7542a976b4d0861116bfbf29fc6f36b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N4JhqeXJgWA1Z7pc6_5T_A.png"/></div></div><figcaption class="kf kg fg fe ff kh ki bd b be z ek">Pic: Basic Tus Architecture</figcaption></figure></div><div class="ab cl kq kr hc ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="hn ho hp hq hr"><h1 id="24b4" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">入门指南</h1><p id="5c19" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf kk lx ji jj kl ly jm jn km lz jq jr js hn dt translated">让我们从添加依赖项开始。</p><pre class="ju jv jw jx fq mv mw mx my aw mz dt"><span id="7005" class="na ky hu mw b fv nb nc l nd ne">$ composer require ankitpokhrel/tus-php</span></pre><p id="cdbf" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated"><a class="ae kj" href="https://github.com/ankitpokhrel/tus-php" rel="noopener ugc nofollow" target="_blank"> <em class="iw"> tus-php </em> </a>是一个框架不可知的纯PHP <a class="ae kj" href="https://tus.io/implementations.html" rel="noopener ugc nofollow" target="_blank">服务器和客户端实现</a>用于tus可恢复上传协议v1.0.0。</p><div class="nf ng fm fo nh ni"><a href="https://github.com/ankitpokhrel/tus-php/" rel="noopener  ugc nofollow" target="_blank"><div class="nj ab ej"><div class="nk ab nl cl cj nm"><h2 class="bd hv fv z el nn eo ep no er et ht dt translated">ankitpokhrel/tus-php</h2><div class="np l"><h3 class="bd b fv z el nn eo ep no er et ek translated">tus-php -🚀用于tus可恢复上传协议v1.0.0的纯PHP服务器和客户端</h3></div><div class="nq l"><p class="bd b gc z el nn eo ep no er et ek translated">github.com</p></div></div><div class="nr l"><div class="ns l nt nu nv nr nw kd ni"/></div></div></a></div><blockquote class="ir is it"><p id="a57f" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><strong class="ix hv">更新</strong> : Vimeo现在正在为Vimeo API 使用他们<a class="ae kj" href="https://github.com/vimeo/vimeo.php/pull/186" rel="noopener ugc nofollow" target="_blank">官方PHP库</a><a class="ae kj" href="https://github.com/vimeo/vimeo.php/releases/tag/3.0.0" rel="noopener ugc nofollow" target="_blank"> v3 </a>中的<a class="ae kj" href="https://github.com/ankitpokhrel/tus-php" rel="noopener ugc nofollow" target="_blank"> TusPHP </a>。</p></blockquote><h1 id="d35d" class="kx ky hu bd kz la ma lc ld le mb lg lh li mc lk ll lm md lo lp lq me ls lt lu dt translated">创建一个服务器来处理我们的请求</h1><p id="93b6" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf kk lx ji jj kl ly jm jn km lz jq jr js hn dt translated">这是一个简单服务器的样子。</p><pre class="ju jv jw jx fq mv mw mx my aw mz dt"><span id="1a83" class="na ky hu mw b fv nb nc l nd ne">// server.php</span><span id="26b6" class="na ky hu mw b fv nx nc l nd ne">$server   = new \TusPhp\Tus\Server('redis');<br/>$response = $server-&gt;serve();</span><span id="afb9" class="na ky hu mw b fv nx nc l nd ne">$response-&gt;send();</span><span id="b05f" class="na ky hu mw b fv nx nc l nd ne">exit(0); // Exit from current PHP process.</span></pre><p id="322d" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">您需要配置您的服务器来响应特定的端点。例如，在Nginx中，您应该这样做:</p><pre class="ju jv jw jx fq mv mw mx my aw mz dt"><span id="6c6b" class="na ky hu mw b fv nb nc l nd ne"># nginx.conf<br/><br/>location /files {<br/>    try_files $uri $uri/ /path/to/server.php?$query_string;<br/>}</span></pre><p id="2b23" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">假设我们服务器的URL是<a class="ae kj" href="http://server.tus.local." rel="noopener ugc nofollow" target="_blank"><em class="iw">http://server . tus . local</em>。</a> <em class="iw"> </em>因此，基于以上nginx配置，我们可以使用<a class="ae kj" href="http://server.tus.local/files." rel="noopener ugc nofollow" target="_blank"><em class="iw">http://server.tus.local/files.</em></a>来访问我们的tus端点</p><p id="d544" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">现在，我们可以使用以下RESTful端点。</p><pre class="ju jv jw jx fq mv mw mx my aw mz dt"><span id="f7c7" class="na ky hu mw b fv nb nc l nd ne"># Gather information about server's current configuration<br/>OPTIONS /files</span><span id="221f" class="na ky hu mw b fv nx nc l nd ne"># Check if the given upload is valid<br/>HEAD /files/{upload-key}</span><span id="91e2" class="na ky hu mw b fv nx nc l nd ne"># Create a new upload<br/>POST /files</span><span id="3688" class="na ky hu mw b fv nx nc l nd ne"># Resume upload created with POST<br/>PATCH /files/{upload-key}</span><span id="4c70" class="na ky hu mw b fv nx nc l nd ne"># Delete the previous upload<br/>DELETE /files/{upload-key}</span></pre><p id="188c" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">查看<a class="ae kj" href="https://tus.io/protocols/resumable-upload.html" rel="noopener ugc nofollow" target="_blank">协议详情</a>了解更多关于端点的信息。</p><blockquote class="mf"><p id="5b55" class="mg mh hu bd mi mj mk ml mm mn mo js ek translated">如果您使用任何像Laravel这样的框架，您可以在您的<a class="ae kj" href="https://hackernoon.com/tagged/framework" rel="noopener ugc nofollow" target="_blank">框架</a>路由文件中定义到所有基于tu的端点的路由，而不是修改您的服务器配置。我们将在另一个教程中详细介绍这一点。</p></blockquote><h1 id="63fd" class="kx ky hu bd kz la ma lc ld le mb lg lh li ny lk ll lm nz lo lp lq oa ls lt lu dt translated">使用tus-php客户端处理上传</h1><p id="31c6" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf kk lx ji jj kl ly jm jn km lz jq jr js hn dt translated">一旦服务器就位，就可以使用客户机来上传文件。让我们从创建一个简单的HTML表单来获取用户输入开始。</p><pre class="ju jv jw jx fq mv mw mx my aw mz dt"><span id="4dbd" class="na ky hu mw b fv nb nc l nd ne">&lt;form action="upload.php" method="post" enctype="multipart/form-data"&gt;<br/>    &lt;input type="file" name="tus_file" id="tus-file" /&gt;<br/>    &lt;input type="submit" value="Upload" /&gt;<br/>&lt;/form&gt;</span></pre><p id="6366" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">提交表单后，我们需要遵循几个步骤来处理上传。</p><ol class=""><li id="d258" class="ob oc hu ix b iy iz jc jd kk od kl oe km of js og oh oi oj dt translated"><strong class="ix hv">创建一个tus-php客户端对象</strong></li></ol><pre class="ju jv jw jx fq mv mw mx my aw mz dt"><span id="4795" class="na ky hu mw b fv nb nc l nd ne">// Tus client</span><span id="b986" class="na ky hu mw b fv nx nc l nd ne">$client = new \TusPhp\Tus\Client('http://server.tus.local');</span></pre><p id="ce24" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">上面代码中的第一个参数是您的tus服务器端点。</p><p id="d3ba" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">2.<strong class="ix hv">用文件元数据初始化客户端</strong></p><p id="6e89" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">为了保持上传的唯一性，我们需要使用一些标识符来识别即将到来的请求中的上传。为此，我们必须生成一个唯一的上传密钥，用于以后继续上传。您可以明确提供上传密钥，也可以让系统自己生成密钥。</p><pre class="ju jv jw jx fq mv mw mx my aw mz dt"><span id="f907" class="na ky hu mw b fv nb nc l nd ne">// Set upload key and file meta</span><span id="b4e5" class="na ky hu mw b fv nx nc l nd ne">$client-&gt;setKey($uploadKey)<br/>    -&gt;file($_FILES['tus_file']['tmp_name'], 'your file name');</span></pre><p id="965a" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">如果您没有明确提供上传密钥，上述步骤将如下所示:</p><pre class="ju jv jw jx fq mv mw mx my aw mz dt"><span id="d9ca" class="na ky hu mw b fv nb nc l nd ne">$client-&gt;file($_FILES['tus_file']['tmp_name'], 'your file name');</span><span id="1b57" class="na ky hu mw b fv nx nc l nd ne">$uploadKey = $client-&gt;getKey(); // Unique upload key</span></pre><p id="c30e" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">3.<strong class="ix hv">上传一大块</strong></p><pre class="ju jv jw jx fq mv mw mx my aw mz dt"><span id="50ba" class="na ky hu mw b fv nb nc l nd ne">// $chunkSize is size in bytes, i.e. 5000000 for 5 MB</span><span id="8dea" class="na ky hu mw b fv nx nc l nd ne">$bytesUploaded = $client-&gt;upload($chunkSize);</span></pre><p id="7edb" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">下一次，当你想上传另一个块，你可以使用相同的上传键继续。</p><pre class="ju jv jw jx fq mv mw mx my aw mz dt"><span id="90e3" class="na ky hu mw b fv nb nc l nd ne">// To resume upload in next request</span><span id="84bb" class="na ky hu mw b fv nx nc l nd ne">$bytesUploaded = $client-&gt;setKey($uploadKey)-&gt;upload($chunkSize);</span></pre><p id="bf12" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">上传完成后，服务器会根据校验和验证上传，以确保上传的文件没有损坏。默认情况下，服务器将使用<code class="eh ok ol om mw b">sha256</code>算法来验证上传。</p><blockquote class="ir is it"><p id="8290" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">上面演示视频的完整实现可以在<a class="ae kj" href="https://github.com/ankitpokhrel/tus-php/tree/master/example/basic" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></blockquote><h1 id="bf74" class="kx ky hu bd kz la ma lc ld le mb lg lh li mc lk ll lm md lo lp lq me ls lt lu dt translated">使用tus-js-client处理上传</h1><p id="071a" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf kk lx ji jj kl ly jm jn km lz jq jr js hn dt translated"><a class="ae kj" href="https://uppy.io/" rel="noopener ugc nofollow" target="_blank"> Uppy </a>是一个时髦的模块化文件上传插件，由支持tus协议的人开发。你可以使用uppy无缝集成官方的<a class="ae kj" href="https://github.com/tus/tus-js-client" rel="noopener ugc nofollow" target="_blank"> tus-js-client </a>和<em class="iw"> tus-php </em>服务器。这意味着我们使用服务器的php实现和客户机的js实现。</p><pre class="ju jv jw jx fq mv mw mx my aw mz dt"><span id="dd9d" class="na ky hu mw b fv nb nc l nd ne">uppy.use(Tus, {<br/>  endpoint: 'https://server.tus.local/files/', // your tus endpoint<br/>  resume: true,<br/>  autoRetry: true,<br/>  retryDelays: [0, 1000, 3000, 5000]<br/>})</span></pre><blockquote class="ir is it"><p id="61f4" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">在<a class="ae kj" href="https://uppy.io/docs/tus/" rel="noopener ugc nofollow" target="_blank"> uppy文档</a>和示例实现<a class="ae kj" href="https://github.com/ankitpokhrel/tus-php/tree/master/example/uppy" rel="noopener ugc nofollow" target="_blank">中查看更多详细信息。</a></p></blockquote><h1 id="f9ac" class="kx ky hu bd kz la ma lc ld le mb lg lh li mc lk ll lm md lo lp lq me ls lt lu dt translated">部分上传</h1><p id="218c" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf kk lx ji jj kl ly jm jn km lz jq jr js hn dt translated"><em class="iw"> tus-php </em>服务器支持<a class="ae kj" href="https://tus.io/protocols/resumable-upload.html#concatenation" rel="noopener ugc nofollow" target="_blank">连接扩展</a>，能够将多个上传连接成一个，使客户端能够执行并行上传和上传不连续的块。</p><figure class="ju jv jw jx fq jy"><div class="bz el l di"><div class="on kp l"/></div><figcaption class="kf kg fg fe ff kh ki bd b be z ek">Partial file upload using tus-php</figcaption></figure><p id="093b" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">部分上传的完整示例可以在<a class="ae kj" href="https://github.com/ankitpokhrel/tus-php/tree/master/example/partial" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="858b" class="kx ky hu bd kz la ma lc ld le mb lg lh li mc lk ll lm md lo lp lq me ls lt lu dt translated">最后的话</h1><p id="bdb3" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf kk lx ji jj kl ly jm jn km lz jq jr js hn dt translated"><a class="ae kj" href="https://github.com/ankitpokhrel/tus-php" rel="noopener ugc nofollow" target="_blank"> tus-php项目</a>本身还处于起步阶段。某些部分将来可能会改变。在<a class="ae kj" href="https://github.com/ankitpokhrel/tus-php/tree/master/example" rel="noopener ugc nofollow" target="_blank">示例</a>文件夹中可以找到三个不同的实施示例。请随意尝试并报告发现的任何问题。拉请求和项目建议非常受欢迎。</p><p id="de1c" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">编码快乐！</p><figure class="ju jv jw jx fq jy"><div class="bz el l di"><div class="oo kp l"/></div></figure></div></div>    
</body>
</html>