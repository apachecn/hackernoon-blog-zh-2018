<html>
<head>
<title>Reviewing gRPC on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes上查看gRPC</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/reviewing-grpc-on-kubernetes-8a705b928abd?source=collection_archive---------6-----------------------#2018-03-26">https://medium.com/hackernoon/reviewing-grpc-on-kubernetes-8a705b928abd?source=collection_archive---------6-----------------------#2018-03-26</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/efff0197a691f2c43c3d7b7a16528045.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lDKPXkDlPQ7nP9ZMM9Dusw.png"/></div></div></figure><div class=""/><p id="e3e6" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ka">TL；DR:在集群内部使用gRPC和Kubernetes非常简单。公开gRPC服务集群——对外不太公开。也许一个好的实践是:在集群内部使用gRPC，并使用HTTP和/或WebSockets提供公共接口？</em></p></div><div class="ab cl kb kc hc kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hn ho hp hq hr"><p id="5b96" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt ki translated"><span class="l kj kk kl bm km kn ko kp kq di"> S </span>起点是一个简单的名为<a class="ae kr" href="https://github.com/mhausenblas/yages" rel="noopener ugc nofollow" target="_blank">的gRPC服务器示例，还有另一个gRPC echo服务器(YAGES) </a>。这个YAGES示例展示了如何使用Go和Kubernetes开发和部署gRPC服务。当然<a class="ae kr" href="https://github.com/mhausenblas/yages#develop" rel="noopener ugc nofollow" target="_blank">你可以使用</a>你最喜欢的<a class="ae kr" href="https://hackernoon.com/tagged/programming" rel="noopener ugc nofollow" target="_blank">编程语言</a>(只要gRPC<a class="ae kr" href="https://grpc.io/docs/" rel="noopener ugc nofollow" target="_blank">支持</a>)而不是去实现服务。现在，在<a class="ae kr" href="https://github.com/mhausenblas/yages#as-an-kubernetes-app" rel="noopener ugc nofollow" target="_blank">将</a>gRPC服务部署为Kubernetes应用程序之后，从集群内部访问gRPC服务就足够简单了，例如，<a class="ae kr" href="https://github.com/mhausenblas/yages#from-inside-the-cluster" rel="noopener ugc nofollow" target="_blank">使用安装了<a class="ae kr" href="https://github.com/fullstorydev/grpcurl" rel="noopener ugc nofollow" target="_blank"> grpcurl </a>的jump pod </a>:</p><pre class="ks kt ku kv fq kw kx ky kz aw la dt"><span id="bcb1" class="lb lc if kx b fv ld le l lf lg">$ grpcurl --plaintext yages.grpc-demo:9000 yages.Echo.Ping<br/>{<br/>  "text": "pong"<br/>}</span></pre><p id="9867" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">好吧，酷。如果我想从群集外部访问它呢？嗯，让我想想…</p></div><div class="ab cl kb kc hc kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hn ho hp hq hr"><p id="73df" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt ki translated">gRPC博客很好地介绍了文章中的主题<a class="ae kr" href="https://grpc.io/blog/loadbalancing" rel="noopener ugc nofollow" target="_blank"> gRPC负载平衡</a>讨论了选项，文档中有一些<a class="ae kr" href="https://github.com/grpc/grpc/blob/master/doc/load-balancing.md" rel="noopener ugc nofollow" target="_blank">相关信息</a>。关于这个主题的精彩介绍，请参见汤姆·威尔基的<a class="ae kr" href="https://www.slideshare.net/kausalco/grpc-kubernetes" rel="noopener ugc nofollow" target="_blank">演讲</a>。</p><p id="f8ce" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">配备了基本的我开始得到一个设置工作的重点是UX和易用性。理想情况下，它可以开箱即用，或者至少只需最少的配置工作。我看了几个负载平衡器/反向代理/服务网格选项:<a class="ae kr" href="https://hackernoon.com/tagged/nginx" rel="noopener ugc nofollow" target="_blank"> NGINX </a>，三个基于特使的解决方案(Ambassador、Contour和Istio)，Linkerd和trfik。</p><p id="c56e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">以下是我的发现…</p></div><div class="ab cl kb kc hc kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hn ho hp hq hr"><h2 id="aef1" class="lb lc if bd lh li lj lk ll lm ln lo lp jn lq lr ls jr lt lu lv jv lw lx ly lz dt translated">大使</h2><p id="1962" class="pw-post-body-paragraph jc jd if je b jf ma jh ji jj mb jl jm jn mc jp jq jr md jt ju jv me jx jy jz hn dt translated">Datawire基于特使的API网关<a class="ae kr" href="https://www.getambassador.io/" rel="noopener ugc nofollow" target="_blank">大使</a>拥有一流的<a class="ae kr" href="https://www.getambassador.io/user-guide/grpc" rel="noopener ugc nofollow" target="_blank"> gRPC支持</a>，我们也在<a class="ae kr" href="https://github.com/kubeflow/kubeflow/issues/154" rel="noopener ugc nofollow" target="_blank">kube flow</a>中使用它。UX很好，唯一需要注意的是它需要一个集群角色和各自的绑定。我还不知道如何在名称空间级别上使用它，也就是说，在我没有权限创建集群范围的资源的环境中。</p><h2 id="6aaa" class="lb lc if bd lh li lj lk ll lm ln lo lp jn lq lr ls jr lt lu lv jv lw lx ly lz dt translated">轮廓</h2><p id="a6ca" class="pw-post-body-paragraph jc jd if je b jf ma jh ji jj mb jl jm jn mc jp jq jr md jt ju jv me jx jy jz hn dt translated">Heptio的<a class="ae kr" href="https://github.com/heptio/contour" rel="noopener ugc nofollow" target="_blank">轮廓</a>是使用Envoy的Kubernetes入口控制器。似乎gRPC支持正在积极地工作，我发现了一个<a class="ae kr" href="https://github.com/heptio/contour/issues/15" rel="noopener ugc nofollow" target="_blank">问题</a>需要解决，以使其工作。</p><h2 id="22d3" class="lb lc if bd lh li lj lk ll lm ln lo lp jn lq lr ls jr lt lu lv jv lw lx ly lz dt translated">林克尔德</h2><p id="891a" class="pw-post-body-paragraph jc jd if je b jf ma jh ji jj mb jl jm jn mc jp jq jr md jt ju jv me jx jy jz hn dt translated">Linkerd 是CNCF的一个初始项目，最初由服务网格先锋浮力开发。它<a class="ae kr" href="https://linkerd.io/features/grpc/" rel="noopener ugc nofollow" target="_blank">支持gRPC </a>开箱即用。有很多关于这个主题的很好的博客帖子——例如2017年4月的<a class="ae kr" href="https://buoyant.io/2017/04/19/a-service-mesh-for-kubernetes-part-ix-grpc-for-fun-and-profit/" rel="noopener ugc nofollow" target="_blank">Kubernetes第九部分的服务网格:gRPC的乐趣和利润</a>和2018年2月的<a class="ae kr" rel="noopener" href="/@riknauta/building-scalable-micro-services-with-kubernetes-grpc-linkerd-7ccafd179599">与GRPC Kubernetes建立可扩展的微服务&amp;Linkerd</a>—但我还没有尝试过。</p><h2 id="622d" class="lb lc if bd lh li lj lk ll lm ln lo lp jn lq lr ls jr lt lu lv jv lw lx ly lz dt translated">trfik</h2><p id="bb39" class="pw-post-body-paragraph jc jd if je b jf ma jh ji jj mb jl jm jn mc jp jq jr md jt ju jv me jx jy jz hn dt translated">trfik是一个HTTP反向代理和负载均衡器，内置了对gRPC 的支持。也在我的工作清单上。</p><h2 id="0e89" class="lb lc if bd lh li lj lk ll lm ln lo lp jn lq lr ls jr lt lu lv jv lw lx ly lz dt translated">NGINX</h2><p id="313d" class="pw-post-body-paragraph jc jd if je b jf ma jh ji jj mb jl jm jn mc jp jq jr md jt ju jv me jx jy jz hn dt translated">我觉得公平的说NGINX不需要介绍。在许多其他事情中，你可以使用它作为一个<a class="ae kr" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"> Kubernetes入口控制器</a>。它现在还支持<a class="ae kr" href="https://www.nginx.com/blog/nginx-1-13-10-grpc/" rel="noopener ugc nofollow" target="_blank"> gRPC </a>(自2018年3月中旬1.13.10起)。我试着在Minikube上打补丁(它仍然使用控制器的v0.9.0版),但到目前为止没有运气。我也将在<a class="ae kr" href="https://cloud.google.com/endpoints/docs/grpc/get-started-grpc-kubernetes-engine" rel="noopener ugc nofollow" target="_blank"> GKE </a>的背景下尝试一下。</p><h2 id="70cd" class="lb lc if bd lh li lj lk ll lm ln lo lp jn lq lr ls jr lt lu lv jv lw lx ly lz dt translated">伊斯迪奥</h2><p id="e368" class="pw-post-body-paragraph jc jd if je b jf ma jh ji jj mb jl jm jn mc jp jq jr md jt ju jv me jx jy jz hn dt translated">最后<a class="ae kr" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio </a>是云原生生态系统的另一个项目，它是一个服务网格，默认情况下将Envoy用于数据平面。似乎社区正在积极<a class="ae kr" href="https://github.com/istio/issues/issues/87" rel="noopener ugc nofollow" target="_blank">致力于gRPC支持</a>。一旦有货我就去试试。</p></div><div class="ab cl kb kc hc kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hn ho hp hq hr"><p id="cae3" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了完整起见，我还会提到，显然也可以使用HAProxy来处理gRPC，但是我没有仔细研究过。此外，还有<a class="ae kr" href="https://github.com/sercand/kuberesolver" rel="noopener ugc nofollow" target="_blank">sercand/kubersolver</a>，这是一个客户端负载平衡器/Kubernetes名称解析器，对于集群内部用例来说，这听起来是一个不错的选择。</p><p id="4c06" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请注意，我的设置是针对Minikube (v0.25)和GKE的<em class="ka"> Kubernetes 1.9 </em>，我唯一的硬性要求是它必须与启用RBAC的<em class="ka">一起工作。</em></p></div><div class="ab cl kb kc hc kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hn ho hp hq hr"><p id="a965" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt ki translated">结论:我还没能成功地使用上面的任何一个选项向外界展示我的小YAGES示例。到目前为止，我和大使走得最远，但还没能和<code class="eh mf mg mh kx b">grpcurl</code>走到一起。gRPC要求HTTP/2似乎是挑战的一部分，RBAC是另一个挑战。</p><p id="54bf" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我毫不怀疑，鉴于生态系统发展如此之快，围绕配置和使用gRPC面向集群外部客户端的UX/DX将会有很大改进。根据我的经验，现在还为时尚早。有可能，但就UX/DX而言并不容易。</p><blockquote class="mi mj mk"><p id="0602" class="jc jd ka je b jf jg jh ji jj jk jl jm ml jo jp jq mm js jt ju mn jw jx jy jz hn dt translated">也许向外界公开gRPC本身并不是一个好主意？也就是说，也许我们可以得到的好的实践是:在集群中使用gRPC和HTTP和/或WebSockets与集群外部的客户端进行通信？</p></blockquote><p id="0553" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我很乐意在这里了解您在这一领域的经历以及任何想法或建议！</p></div><div class="ab cl kb kc hc kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hn ho hp hq hr"><p id="1517" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">更新2018-03-27:自从发布这个帖子以来，我收到了大量有价值的反馈，并了解了更多的事情。所以，感谢每一个花时间阅读和跟进的人，非常感谢！现在我想补充两点:</p><ul class=""><li id="a69f" class="mo mp if je b jf jg jj jk jn mq jr mr jv ms jz mt mu mv mw dt translated">Linkerd的制造商在市场上推出了一个名为<a class="ae kr" href="https://conduit.io/" rel="noopener ugc nofollow" target="_blank">导管</a>的新项目和产品。现在，我意识到了这一点，并亲自尝试了一下(超级容易使用，例如查看<a class="ae kr" href="https://www.youtube.com/watch?v=--b641eQ7U8" rel="noopener ugc nofollow" target="_blank">的这个视频</a>，但是到目前为止还没有找到任何正在进行的将gRPC服务向外界公开的工作。原来我亲爱的朋友<a class="ae kr" href="https://github.com/grampelberg" rel="noopener ugc nofollow" target="_blank">托马斯R </a>现在在浮力公司工作，谢天谢地，他给我指出了一个抓住其本质的<a class="ae kr" href="https://github.com/runconduit/conduit/issues/629" rel="noopener ugc nofollow" target="_blank">问题。谢谢！</a></li><li id="4da9" class="mo mp if je b jf mx jj my jn mz jr na jv nb jz mt mu mv mw dt translated">另一个超级有用的输入来自Twitter:<a class="ae kr" href="https://twitter.com/andrewvwebber/" rel="noopener ugc nofollow" target="_blank">Andrew Webber</a><a class="ae kr" href="https://twitter.com/andrewvwebber/status/978392651471970306" rel="noopener ugc nofollow" target="_blank">指出</a>还有一个非常酷的项目可以使用:<a class="ae kr" href="https://github.com/zlabjp/nghttpx-ingress-lb" rel="noopener ugc nofollow" target="_blank"> nghttpx入口控制器</a> —我也会检查这个，谢谢！</li><li id="fb18" class="mo mp if je b jf mx jj my jn mz jr na jv nb jz mt mu mv mw dt translated">最后，我的同事<a class="ae kr" href="https://twitter.com/christianposta" rel="noopener ugc nofollow" target="_blank"> Christian Posta </a>，我们的微服务和Istio主题专家，让我意识到OpenShift中的<a class="ae kr" href="https://blog.zhaw.ch/icclab/openshift-custom-router-with-tcpsni-support/" rel="noopener ugc nofollow" target="_blank">自定义路线</a>，利用TCP/SNI。很好，干杯，又一个我要做的事情:)</li></ul><figure class="ks kt ku kv fq hw"><div class="bz el l di"><div class="nc nd l"/></div></figure></div></div>    
</body>
</html>