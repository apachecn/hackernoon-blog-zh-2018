<html>
<head>
<title>Break Hashing Integrity with NTFS Streams</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">破坏NTFS流的哈希完整性</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/breaking-software-integrity-with-ntfs-streams-fe4a1b13d2da?source=collection_archive---------13-----------------------#2018-03-27">https://medium.com/hackernoon/breaking-software-integrity-with-ntfs-streams-fe4a1b13d2da?source=collection_archive---------13-----------------------#2018-03-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/17b03ef97296c1c201db9f90b4fd187e.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/1*1WR-SeWux7HzTo5oWCSIJQ.gif"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">F*ck software integrity</figcaption></figure><p id="79f2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">出于安全目的，许多应用程序使用哈希来确保软件完整性。在基于Windows的NTFS文件系统上，有一个弱点。文件可以隐藏在文件内部或后面。在某些情况下，这些隐藏文件可以被散列并保持隐藏。感兴趣了吗？幸运的是，维基解密在2016/17年的一次大规模披露中泄露了一份旧的中情局行动手册的一部分。一个漏洞技术引起了我的注意，<a class="ae ka" href="https://wikileaks.org/ciav7p1/cms/page_13763461.html" rel="noopener ugc nofollow" target="_blank">在NTFS数据流中隐藏数据</a>。缺少完整的说明；然而，由于我们中的一些人已经秘密地享受使用这种技术很多年了，是时候传播这种快乐了。早在2013年，微软就从开发者的角度在上面发布了一个<a class="ae ka" href="https://blogs.technet.microsoft.com/askcore/2013/03/24/alternate-data-streams-in-ntfs/" rel="noopener ugc nofollow" target="_blank">博客</a>。不是邪恶的(穿上帽衫)黑客视角。快，躲在邪恶黑客的被窝里，一切都会好的。我们要达到中情局的水平，打破一些禁忌。</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div class="fe ff kb"><img src="../Images/0631145100e94a7a69c2d4a6e74495a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:624/0*PTqifdBIxU2NP5W_."/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">Self explanatory…</figcaption></figure><p id="6025" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们比无意中起草的MS博客文章更进一步，在驱动器的根目录上添加一些散列。微软已经推出了一款名为<a class="ae ka" href="https://technet.microsoft.com/en-us/sysinternals/bb897440.aspx" rel="noopener ugc nofollow" target="_blank">SysInternals Streams.exe</a>的工具，可以免费下载，用于这项技术。它可以帮助检测NTFS流并验证结果。</p><p id="06a6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果攻击者想在众目睽睽之下隐藏数据，根据情况和目标，这是一个可以考虑的狡猾的小方法。NTFS替代数据流(ADS)也被称为<a class="ae ka" href="https://en.wikipedia.org/wiki/Fork_(file_system)" rel="noopener ugc nofollow" target="_blank">分叉</a>。是的，它过去曾被恶意使用，很好的问题。我决定用完整的说明更新最初的帖子。然后进一步向您展示如何通过使用SHA256++和NTFS ADS来破坏文件完整性。</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div class="fe ff kg"><img src="../Images/23789bd6dd3ef792790366933be90647.png" data-original-src="https://miro.medium.com/v2/resize:fit:582/format:webp/1*1x2hBt8DO1Z1DDl8EfMQgg.png"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek"><strong class="bd kh"><em class="ki">And Ants</em></strong></figcaption></figure><p id="548a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="kj">格式化后的中情局行动手册，供你阅读愉悦。</em></p><p id="d499" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv"> NTFS备用数据流(ADS) </strong></p><p id="bc9b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ka" href="https://www.techopedia.com/definition/14682/data-exfiltration" rel="noopener ugc nofollow" target="_blank"> <em class="kj">渗透</em> </a> <em class="kj">，操纵软件和文件完整性，混淆</em></p><p id="1900" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">驱动器根上的备用数据流</strong></p><p id="4539" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这取决于目标和系统配置。NTFS备用数据流(ADS)应被视为隐藏数据和避开保护或警报的可行方法。尤其是在保护严重依赖或依赖文件哈希作为验证文件完整性的方法的情况下。无论是为了渗透、操纵诚信、混淆视听还是普通交易。非常适合绕过许多安全控制，深入目标网络。</p><p id="7ed3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">有几种方法。最简单的方法之一是从命令提示符。在硬盘目录的根目录下工作。如果您已经可以远程访问受害者，这也可以远程完成。</p><p id="143d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">获得本地或远程访问受害者的权限</strong></p><p id="b449" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">以受害者D:数据驱动器为例，由于权限有限。攻击者有一个IP地址文件，除了卡巴斯基的列表之外，这些IP地址是与<a class="ae ka" href="http://www.miamiherald.com/news/nation-world/world/article130131929.html" rel="noopener ugc nofollow" target="_blank"> StoneDrill </a>和NewsBeEF相关的额外命令和控制域。作为有针对性攻击的一部分，攻击者需要悄悄地将该列表放到受害机器上。攻击也可以通过PowerShell或批处理文件来完成。一旦批处理文件在系统上，重命名它们以绕过安全控制通常是很容易的，只需要有限的访问。如果它是一个可执行文件，你也可以在PSExec.exe中使用这种技术。许多反恶意软件和其他保护将捕捉PSExec，但并不总是如此。</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div class="fe ff kk"><img src="../Images/23515fce314728110dd6b0b8ccfc3f3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:320/format:webp/1*Mz9m40wTwMGF-1-6OuI8pw.png"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek"><em class="ki">Sample contents of the evil file</em></figcaption></figure><p id="6e2f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">执行NTFS广告并隐藏邪恶文件</strong></p><p id="4382" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在受害机器上打开本地或远程命令提示符。攻击者，为了使用方便。将命令和控制服务器的文本文件放在D的根目录下，命名为evilcancips.txt</p><p id="9d82" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">创建您想要隐藏邪恶文件的文件。在这个例子中，我们将调用这个文件:<strong class="je hv"> testfile.txt </strong>。在根目录下键入以下命令。该命令首先创建无辜文件。第二个命令将邪恶的文件隐藏在看起来无害的文件后面。</p><p id="c7e4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv"> ECHO "这是一个测试文件"&gt; testfile.txt </strong></p><p id="b666" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv"> ECHO“这是广告文件中的恶文”&gt;testfile . txt:evil cancips . txt</strong></p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff kl"><img src="../Images/00240a44b67831ee093781694d20f4bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v2UhEh3xPnLgqFYk9vMsbw.png"/></div></div></figure><p id="ba73" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">验证NTFS ADS流工作正常</strong></p><p id="d01f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">检查目录在命令提示符下显示的内容。它看起来应该和NTFS广告之前一样</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div class="fe ff kq"><img src="../Images/56bef9093523055a71304e5d0d8fdc23.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*dWwOFHqDuOFdkcRSc8HgCA.png"/></div></figure><p id="1aec" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该目录在GUI中的样子</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div class="fe ff kr"><img src="../Images/4350f538cd7b85fd35ae607c0b0a8403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*ZZ4CVV87aHRw6zjo9hHX9g.png"/></div></figure><p id="786e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">虽然可以在命令提示符下轻松显示ADS NTFS流/分支。这超出了普通用户的水平，也是最技术性的。作为一种攻击或间谍手段，这种技术仍然有些晦涩难懂。Windows的GUI部分不容易显示NTFS ADS文件。</p><p id="05d2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在命令提示符下，确保NTFS ADS流正常工作。它将显示与原始文件的双线，然后显示隐藏的文件。</p><p id="59b4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">方向/r </strong></p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div class="fe ff ks"><img src="../Images/aebed1b379c19f6a6e23e1f7880ed291.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*3B_um-hmtF6XwtUoiDEcjA.png"/></div></figure><p id="4e37" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">练习时，也要使用Streams.exe进行验证。在本例中，安装了Streams.exe。</p><p id="9ef0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">打开命令提示符，将工作目录加载到Streams所在的位置。然后对看起来无害的文件执行流:testfile.txt</p><p id="a81d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">流d:\testfile.txt </strong></p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div class="fe ff kt"><img src="../Images/3128051bf9817f010b31ea22d6e29069.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*jAJnUNDHZRcHu0tNX7J6AQ.png"/></div></figure><p id="268e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">哈希验证文件完整性</strong></p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div class="fe ff ku"><img src="../Images/dea13192cd4c3e0d5bac49b0f5950212.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*y-z6To2edupcv09p."/></div></figure><p id="0277" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">确保你把邪恶文件藏在受害者的机器上。在NTFS ADS之前哈希无害文件，记录哈希。PowerShell中的默认哈希级别是Sha256。因为现代基于Windows的受害者机器有PowerShell。散列不需要额外的工具。攻击者不需要成为管理员就可以使用PowerShell来散列文件。在此示例中，PowerShell不是以管理员身份运行的。大多数用户和企业管理员仍然不熟悉PowerShell，并且将功能默认配置为攻击者可以利用的方式。</p><p id="ea8a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在PowerShell提示符下，使用cmdlet <strong class="je hv"> Get-FileHash </strong>，然后使用原始文件所在的<strong class="je hv"> -Path </strong>。</p><p id="eb62" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">Get-file hash-Path d:\ testfile . txt</strong></p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff kv"><img src="../Images/0d76b6115f658d2b2d9293ce2a1c8c4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OvS09FYBN2_l1HmmtVQU5A.png"/></div></div></figure><p id="cb28" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在NTFS广告之后，在隐藏邪恶文件的地方再次散列原始文件。</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff kw"><img src="../Images/99c9cadd55bb17b24e8f1dd6f5331db6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sMFeCWxrXjf8OhmC_H2q1Q.png"/></div></div></figure><p id="2c54" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">哈希将显示相同的哈希。<strong class="je hv">9 bb 114 c 0 Fe 4 f 787 ef 64 a 43 f 310 ea 81 f 273 fc 87001503 a 141 a 125d 9689 AE 8 dfef</strong></p><p id="092f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果受害者使用大多数现代Windows使用的NTFS文件系统。任何人都可以将任何恶意文件隐藏到根目录下的一个无害文件中，如示例所示。受害者和攻击者都不能在GUI中显示隐藏的文件。防御是基于目标保护机制是否能够识别邪恶的文件或行为。很少使用<strong class="je hv">方向/r </strong>。该文件可以隐藏和散列与MD5，SHA1，沙256等…邪恶的文件将看起来隐藏。在对目标进行现场测试之前，可以很容易地重新创建和实践这种技术。</p><p id="ab31" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">结论</strong>(暗示邪笑)</p><p id="2810" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">依靠散列来保证文件完整性并不能完全减轻这种风险或攻击技术。通过给人一种限制风险的假象，哈希过程在某种程度上进一步隐藏了数据。许多安全产品依赖哈希来保证文件完整性。这是公认的最佳实践。现在每个人都知道它可以在特定条件下被操纵。就像许多安全研究人员担心政府囤积漏洞或被狡猾的罪犯滥用一样。我2012年写的关于这个话题的论文是保密的。她会很快变得邪恶。看看谷歌，他们变得如此邪恶，他们不得不改变他们的名字。</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff kx"><img src="../Images/f70b9d05ceafe3910a641ee45fd8e705.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z4OlDb8m03WhBX11QExgjA.png"/></div></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">2012 , that’s almost last century!</figcaption></figure><p id="b8e5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我想我不再需要那个密码或加密那份旧文件了。感谢中情局和维基解密:-)</p><p id="36d8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">享受阅读，留下一个掌声(或50)，并进入评论。加入我的<a class="ae ka" href="https://www.goodreads.com/author/show/17044584" rel="noopener ugc nofollow" target="_blank"> Goodreads </a>阅读一本好书或<a class="ae ka" href="https://www.peerlyst.com/users/chriskubecka/info?trk=user_dropdown" rel="noopener ugc nofollow" target="_blank"> Peerlyst </a>进行技术社区讨论。</p></div></div>    
</body>
</html>