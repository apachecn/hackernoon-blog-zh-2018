<html>
<head>
<title>Cleaning up after Spectre and Meltdown: figuring out how badly they slowed down your servers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spectre和Meltdown之后的清理工作:弄清楚它们使您的服务器变慢的程度</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/cleaning-up-after-spectre-and-meltdown-figuring-out-how-badly-they-slowed-down-your-servers-9bd96da07cf7?source=collection_archive---------27-----------------------#2018-03-27">https://medium.com/hackernoon/cleaning-up-after-spectre-and-meltdown-figuring-out-how-badly-they-slowed-down-your-servers-9bd96da07cf7?source=collection_archive---------27-----------------------#2018-03-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="fff5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">这篇文章基于我在plur sight</em><em class="jp">上的</em> <a class="ae jq" href="http://pluralsight.pxf.io/c/1191769/424552/7490?subId1=solving&amp;u=https%3A%2F%2Fapp.pluralsight.com%2Fprofile%2Fauthor%2Fdavid-clinton" rel="noopener ugc nofollow" target="_blank"> <em class="jp"> Linux性能监控和调优课程，巧合的是，该课程恰好在Spectre和Meltdown的新闻爆出之前发布。</em></a></p><p id="82fc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">到目前为止,<a class="ae jq" href="https://www.techrepublic.com/article/spectre-and-meltdown-cheat-sheet/" rel="noopener ugc nofollow" target="_blank">幽灵和崩溃漏洞</a>的关键阶段已经基本结束。受影响的操作系统的补丁已经写好了，假设你保持你的服务器正确更新，你应该是安全的。</p><p id="a4a6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是容易的部分。真正的问题是该补丁可能会降低系统速度——尤其是如果您正在运行经常与内核交互的应用程序。所以你会想知道你受到了多大的打击，以及你需要什么样的升级才能让你回到你应该在的地方。</p><p id="1ba1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我最近的【Pluralsight课程讨论了理解、诊断、调优和监控Linux服务器的性能。这些都是针对这个问题所要求的评估和管理的工具，所以我想我应该制作这个指南来安装和使用collectd守护进程来收集和监控本地或整个网络的性能指标。</p><p id="996e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">除了collectd，本课程还包括Nagios、Munin和nmon监控工具，以及分析指标和优化现有堆栈。</p><p id="d328" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">理想情况下，您应该有一些旧的、Spectre之前的性能数据可以用作基线。但即使你不得不从头开始，用不了多久collectd就会开始针对你的痛点指指点点。</p><h2 id="b910" class="jr js hu bd jt ju jv jw jx jy jz ka kb jc kc kd ke jg kf kg kh jk ki kj kk kl dt translated">安装集合d</h2><p id="f9b7" class="pw-post-body-paragraph ir is hu it b iu km iw ix iy kn ja jb jc ko je jf jg kp ji jj jk kq jm jn jo hn dt translated">collectd是一个Linux系统守护进程，它收集系统性能数据并将其组织到循环数据库(RRD)文件中，这些文件通常保存在/var/lib/collectd/rrd/目录树中。</p><p id="e339" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将带您完成安装和配置collectd的过程。然后，我将演示一个名为collectd-web的工具，它可以将RRD数据转换成图表。完成所有这些工作后，我将向您展示如何将几个远程服务器设置为collectd客户机，这样我们就可以在一台服务器上访问整个车队的数据。但是一次只能做一件事。</p><p id="e96d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将collectd独立安装很简单:您只需要collectd包。另一方面，安装并运行collectd-web工具可能有点小技巧。因为客户机只需要collectd，所以我将集中精力设置我们的collectd服务器。我将在运行Ubuntu 16.04的LXC容器上做这件事。</p><p id="51d8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是包裹清单。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="db81" class="jr js hu kw b fv la lb l lc ld"># apt install -y collectd python build-essential \<br/> librrds-perl librrds-perl libjson-perl libhtml-parser-perl \<br/> apache2</span></pre><p id="a7f6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我给你解释一下。我们将需要Python来运行collectd-web工具和build-essential来构建我们稍后将获得的源代码。这些Perl库将解释RRD数据库文件，并添加JSON和CGI功能。最后，我们将使用Apache作为我们的web服务器来处理web请求本身。我会让一切顺其自然，跳过无聊的细节。接下来，我将使用a2enmod来启用CGI模块，这将允许Apache管理一些可视化。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="7d84" class="jr js hu kw b fv la lb l lc ld"># a2enmod cgi cgid</span></pre><p id="86c7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">cpan将安装几个Perl模块。确保JSON和CGI使用大写字母。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="6c9f" class="jr js hu kw b fv la lb l lc ld"># cpan JSON<br/># cpan CGI</span></pre><p id="5963" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将使用一个文本编辑器向/etc/apache2/sites-available/目录中的000-default.conf文件添加一个部分，该部分将支持从web服务器端处理Apache CGI脚本。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="aa99" class="jr js hu kw b fv la lb l lc ld">&lt;Directory /var/www/html/collectd-web/cgi-bin&gt;<br/>Options Indexes ExecCGI<br/>AllowOverride All<br/>AddHandler cgi-script .cgi<br/>Require all granted<br/>&lt;/Directory&gt;</span></pre><p id="7686" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">完成这些后，只剩下一件事要做了，就是按照我们想要的方式获得Apache。查看apache2.conf配置文件，向下滚动到Include行，在那里我们设置监听的网络端口。注意它是如何被卸载到一个名为ports.conf的文件中的。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="66f6" class="jr js hu kw b fv la lb l lc ld"># Include list of ports to listen on<br/>Include ports.conf</span></pre><p id="278e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果我们希望能够通过浏览器远程访问我们的数据，那就是我们想要编辑的文件。我将确保ports.conf中的“Listen”行显示为0.0.0.0:80，这样我们就不会仅限于本地来宾。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="0cac" class="jr js hu kw b fv la lb l lc ld">Listen 0.0.0.0:80</span></pre><p id="feb0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们所有的Apache工作都完成了，现在是重新启动它的时候了，这样所有的东西都得到了适当的更新。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="2589" class="jr js hu kw b fv la lb l lc ld"># systemctl restart apache2</span></pre><p id="3a2b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们应该快速查看一下/etc/collect TD/目录中的collectd.conf配置文件。这是一个很大的文件，大多数默认设置现在对我们来说都适用，但是您应该知道您可以添加的东西的种类以及它们是如何配置的。collectd的大部分功能都是通过它的插件提供的，这些插件是在LoadPlugin部分加载的(通过取消注释)。一些插件可能已经被加载了，比如apache和cpu。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="d9b0" class="jr js hu kw b fv la lb l lc ld">LoadPlugin apache<br/>#LoadPlugin apcups<br/>#LoadPlugin ascent<br/>[…]<br/>LoadPlugin cpu</span></pre><p id="6ec3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这意味着，在下面正确配置的情况下，collectd将监视和报告Apache和CPU的行为。</p><p id="f2ed" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您还需要在下面的配置部分配置您的每个插件。cpu配置被注释掉了，但是它将使用其缺省值正常工作。在这种情况下，配置部分只是为那些想要定制它的人准备的。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="a0b7" class="jr js hu kw b fv la lb l lc ld">#&lt;Plugin cpu&gt;<br/># ReportByCpu true<br/># ReportByState true<br/># ValuesPercentage false<br/>#&lt;/Plugin&gt;</span></pre><p id="abd3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果编辑配置文件，请确保使用systemctl重新启动守护程序。这也是在出现问题时查找错误消息的好地方。密切注意您收到的任何错误消息，尤其是通过系统日志，并仔细检查您在配置文件中使用的语法。也有可能您遗漏了一两个Perl模块。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="5a94" class="jr js hu kw b fv la lb l lc ld"># systemctl restart collectd<br/># systemctl status collectd</span></pre><p id="c97a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是在所有这些有用之前，我们需要安装collectd-web工具本身。我将首先安装git，然后克隆collectd-web存储库。这将把源代码保存到一个名为collectd-web的新目录中。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="a8e4" class="jr js hu kw b fv la lb l lc ld"># apt install git<br/>$ git clone <a class="ae jq" href="https://github.com/httpdss/collectd-web.git" rel="noopener ugc nofollow" target="_blank">https://github.com/httpdss/collectd-web.git</a></span></pre><p id="510e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在cgi-bin子目录中有一个脚本，我们必须将其设置为可执行的，因此我将更改为cgi-bin，并使用chmod向graphdefs.cgi添加一个可执行位，然后我将返回到collect TD-web目录的一个级别，以便对Python runserver脚本进行一次编辑。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="a744" class="jr js hu kw b fv la lb l lc ld">$ cd collectd-web/cgi-bin<br/>$ chmod +x graphdefs.cgi<br/>$ cd ..<br/>$ nano runserver.py</span></pre><p id="95b1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将更改127.0.0.1引用localhost的两个位置，并通过将其编辑为0.0.0.0，向整个互联网开放。这将允许collectd监听来自其他机器的数据。</p><p id="a7fb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就这样，我们都准备好了。确保您在collectd-web目录中，并运行runserver.py脚本。我将添加&amp;字符，这样它将在后台运行，我将得到我的命令行。不过，最好留意这个shell，因为事件打印在这里，有时会很有用。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="1cb4" class="jr js hu kw b fv la lb l lc ld">$ ./runserver.py &amp;</span></pre><p id="e75f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我将启动一个浏览器，将它指向LXC容器的IP地址，指定端口8888。说到网络端口，如果你运行的是防火墙，你需要打开端口8888和25826。您可以单击您的主机名称，然后从下面显示的指标中进行选择。</p><figure class="kr ks kt ku fq lf fe ff paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="fe ff le"><img src="../Images/ff8a2925519b68075ac422cbe2e82dcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W_RPHxQSY08skjwZi749jQ.png"/></div></div><figcaption class="lm ln fg fe ff lo lp bd b be z ek">The CPU display for the local machine (called collectd)</figcaption></figure><h2 id="6d4a" class="jr js hu bd jt ju jv jw jx jy jz ka kb jc kc kd ke jg kf kg kh jk ki kj kk kl dt translated">多主机集合配置</h2><p id="9045" class="pw-post-body-paragraph ir is hu it b iu km iw ix iy kn ja jb jc ko je jf jg kp ji jj jk kq jm jn jo hn dt translated">如果到目前为止您一直在跟随演示，那么您已经获得了通过本地web服务显示的单个服务器的指标。但是如果你有很多服务器，你可能不会喜欢为每一个打开一个新的浏览器标签——尤其是当你在工作日中需要周期性地浏览它们的时候。</p><p id="891c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">那么，为什么不将数据发送到一台服务器呢？就这么办吧。我已经启动了两台服务器，并在每台服务器上只安装了collectd包。它们的主机名是collectd-client1和collectd-client2，这将使以后更容易识别它们。</p><p id="5dac" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我登录到我的一个客户端，我将编辑collectd.conf配置文件。至少，我需要确保网络插件已启用，然后进入配置页面进行设置。我需要做的就是取消对打开和关闭插件网络行、打开和关闭服务器行的注释，然后编辑服务器IP地址以匹配我的Collectd服务器使用的IP。这是为了让客户端可以将数据推送到服务器。我将保留其他行的默认值。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="81b6" class="jr js hu kw b fv la lb l lc ld">LoadPlugin network</span><span id="3527" class="jr js hu kw b fv lq lb l lc ld">&lt;Plugin network&gt;<br/># # client setup:<br/># Server “ff18::efc0:4a42” “25826”<br/> &lt;Server “10.0.3.102” “25826”&gt;<br/># SecurityLevel Encrypt<br/># Username “user”<br/># Password “secret”<br/># Interface “eth0”<br/># ResolveInterval 14400<br/> &lt;/Server&gt;<br/># TimeToLive 128<br/>#<br/># # server setup:<br/># Listen “ff18::efc0:4a42” “25826”<br/># &lt;Listen “239.192.74.66” “25826”&gt;<br/># SecurityLevel Sign<br/># AuthFile “/etc/collectd/passwd”<br/># Interface “eth0”<br/># &lt;/Listen&gt;<br/># MaxPacketSize 1452<br/>#<br/># # proxy setup (client and server as above):<br/># Forward true<br/>#<br/># # statistics about the network plugin itself<br/># ReportStats false<br/>#<br/># # “garbage collection”<br/># CacheFlush 1800<br/>&lt;/Plugin&gt;</span></pre><p id="3dd7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就是这样。您将重新启动collectd服务，然后在您想要监视的任何其他客户端上重复该过程。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="6521" class="jr js hu kw b fv la lb l lc ld"># systemctl restart collectd</span></pre><p id="6825" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，回到服务器上，我将编辑相同的配置文件，并确保联网已启用。同样，和以前一样，我将向下滚动到networking configuration部分并取消对插件行的注释，但是这一次，我将取消对Server Setup部分的注释并编辑它，而不是客户机部分。在这里，我将Listen行改为0.0.0.0，这样服务器将监听来自任何地方的传入数据。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="a095" class="jr js hu kw b fv la lb l lc ld"># server setup:<br/># Listen “ff18::efc0:4a42” “25826”<br/> &lt;Listen “0.0.0.0” “25826”&gt;<br/># SecurityLevel Sign<br/># AuthFile “/etc/collectd/passwd”<br/># Interface “eth0”<br/> &lt;/Listen&gt;</span></pre><p id="8e07" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将保存并关闭文件，然后重启collectd和apache服务。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="b127" class="jr js hu kw b fv la lb l lc ld"># systemctl restart collectd</span></pre><p id="1bc0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，确保Python runserver脚本尚未运行——如果已经运行，您应该使用kill关闭它——再次启动它。</p><pre class="kr ks kt ku fq kv kw kx ky aw kz dt"><span id="e5a2" class="jr js hu kw b fv la lb l lc ld">$ ./runserver.py &amp;</span></pre><p id="6017" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在回到浏览器并刷新页面。你的每个客户的链接应该立即出现，让我们在视图之间进行选择。</p><figure class="kr ks kt ku fq lf fe ff paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="fe ff lr"><img src="../Images/fb20b62f952d5e88aa70e6d046cebc72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*edCRn5xE-uU2IWA1donMCQ.png"/></div></div><figcaption class="lm ln fg fe ff lo lp bd b be z ek">A multi-host configuration. Note links to three hosts in the left panel</figcaption></figure><p id="cbf3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可能需要重新启动服务器，并希望第一次就能成功。它可能有点挑剔。但你肯定会欣赏结果的。</p><p id="3ef2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">解释您得到的结果并采取行动是您的职责，但是我的</em> <a class="ae jq" href="http://pluralsight.pxf.io/c/1191769/424552/7490?subId1=solving&amp;u=https%3A%2F%2Fapp.pluralsight.com%2Fprofile%2Fauthor%2Fdavid-clinton" rel="noopener ugc nofollow" target="_blank"> <em class="jp"> Pluralsight Linux性能监控和调优课程</em> </a> <em class="jp">涉及了许多您需要了解的内容。对Linux管理感兴趣吗？在我的Bootstrap IT网站上还有很多，包括我的手册《Linux in Action》的链接，以及一个名为</em><a class="ae jq" href="https://www.manning.com/livevideo/linux-in-motion?a_aid=bootstrap-it&amp;a_bid=0c56986f&amp;chan=motion1" rel="noopener ugc nofollow" target="_blank"><em class="jp">Linux in Motion</em></a><em class="jp">的混合课程，它由两个多小时的视频和大约40%的Linux in Action文本组成。</em></p></div></div>    
</body>
</html>