<html>
<head>
<title>From Express.js to AWS Lambda: Migrating existing Node.js applications to serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Express.js到AWS Lambda:将现有Node.js应用程序迁移到无服务器</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/from-express-js-to-aws-lambda-migrating-existing-node-js-applications-to-serverless-7473041ecc56?source=collection_archive---------4-----------------------#2018-03-29">https://medium.com/hackernoon/from-express-js-to-aws-lambda-migrating-existing-node-js-applications-to-serverless-7473041ecc56?source=collection_archive---------4-----------------------#2018-03-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="dc13" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">无服务器架构使得一些设计应用程序的良好实践过时了。从头开始构建一个无服务器的应用程序需要思维的转变，但是一旦你开始以无服务器的方式思考，所有的点会很快连接起来。在Claudia.js等<a class="ae jp" href="https://hackernoon.com/tagged/tools" rel="noopener ugc nofollow" target="_blank">工具</a>的帮助下，开发和部署周期短而容易。</p><p id="5b24" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但大多数时候你不能只是从零开始。相反，你有一个有几千行代码和几千个每日活跃用户的应用程序，有一个由业务请求或其他问题引起的可疑决策的历史，这些问题以特定的方式塑造了你的代码。</p><p id="caf1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您是否能够并且应该将这样的应用程序迁移到无服务器环境中？答案并不简单，因为它取决于您的应用程序的具体情况、您的团队的结构以及许多其他因素。但是在大多数情况下，无服务器对遗留应用程序是有益的。</p><p id="3b23" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">假设您正在开发一个漂亮而简单的Node.js应用程序。比如一个类似于<a class="ae jp" href="http://vacationtrackerbot.com/" rel="noopener ugc nofollow" target="_blank">的休假追踪机器人</a>的app，一个简单的管理团队休假的Slack工具。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/58938a9b5490863aee3428eadb67c549.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OIeMQqztL-x0zbyE.jpg"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">Vacation tracker flow</figcaption></figure><p id="d01f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个应用程序本身很简单。大部分交流都是通过Slack进行的，但也有一个不错的网络仪表盘。当您正在构建MVP时，您不想在它上面花费太多的资源，所以您创建了一个新的数字海洋实例，并将所有东西都打包在其中。此时，如下图所示，您的应用程序包含以下内容:</p><ul class=""><li id="8e09" class="kg kh hu it b iu iv iy iz jc ki jg kj jk kk jo kl km kn ko dt translated">使用nginx的Ubuntu droplet</li><li id="3c30" class="kg kh hu it b iu kp iy kq jc kr jg ks jk kt jo kl km kn ko dt translated">提供静态页面(SPA仪表板)和API的Express.js应用程序</li><li id="4238" class="kg kh hu it b iu kp iy kq jc kr jg ks jk kt jo kl km kn ko dt translated">MongoDB数据库</li><li id="d412" class="kg kh hu it b iu kp iy kq jc kr jg ks jk kt jo kl km kn ko dt translated">发送预定消息的Cronjob</li></ul><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/05bd3d594ac140c0a0745480545b91b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uKmYXnNQ7izl0yv2.jpg"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">Simple Express.js and MongoDB app</figcaption></figure><p id="6a9a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但有时你的应用程序有一个很大的使用高峰，你需要考虑扩展。更不用说你还需要很多其他的东西，比如监控、SSL、开发和生产环境等等。</p><p id="960e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于第一批用户，你有趣的项目很快变成了另一件你需要花几个小时来维护和配置的事情。it成本越来越高，即使用户仍然不为此付费。一点都不好玩。</p><p id="ceb2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您听说了无服务器，并决定尝试一下。但是，如何将传统的Node.js应用程序转换为无服务器应用程序呢？你应该把一切都装进<a class="ae jp" href="https://hackernoon.com/tagged/aws-lambda" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>吗？</p><blockquote class="ku kv kw"><p id="3aa9" class="ir is kx it b iu iv iw ix iy iz ja jb ky jd je jf kz jh ji jj la jl jm jn jo hn dt translated"><em class="hu">万一你不熟悉serverless，或者你还觉得是用仓鼠轮子而不是服务器来运行web apps的某种魔力，请看</em> <a class="ae jp" href="https://livebook.manning.com/#!/book/serverless-apps-with-node-and-claudiajs/chapter-1" rel="noopener ugc nofollow" target="_blank"> <em class="hu">这个解释</em> </a> <em class="hu">。</em></p></blockquote><h1 id="e8b7" class="lb lc hu bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">分步解决</h1><p id="a37a" class="pw-post-body-paragraph ir is hu it b iu lz iw ix iy ma ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">虽然将所有东西都放入AWS Lambda技术上会使你的应用程序无服务器，这可能是一个很好的第一步，但要获得无服务器的全部好处，你需要付出更多的努力，通过将你的应用程序分成小服务来拥抱无服务器平台。</p><p id="e258" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们了解如何操作之前，您可以获得哪些好处？</p><p id="22dc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一些最重要的好处是:</p><ul class=""><li id="b7fe" class="kg kh hu it b iu iv iy iz jc ki jg kj jk kk jo kl km kn ko dt translated">您的应用程序将自动缩放。它的速度很快，不到几秒钟就能从0增加到1000个并行用户。</li><li id="939e" class="kg kh hu it b iu kp iy kq jc kr jg ks jk kt jo kl km kn ko dt translated">只有当有人使用你的应用时，你才需要付费。零用户花费你0美元。随着用户数量的增加，成本也会有所增加。比如MindMup每月100美元，月活跃用户40万，印象深刻吧？点击了解更多信息<a class="ae jp" href="https://livebook.manning.com/#!/book/serverless-apps-with-node-and-claudiajs/chapter-15" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="01ee" class="kg kh hu it b iu kp iy kq jc kr jg ks jk kt jo kl km kn ko dt translated">如果没有人使用，拥有尽可能多的类似于生产的环境不会让你付出任何代价。运行实验和测试比以往任何时候都更容易和更便宜。</li><li id="532c" class="kg kh hu it b iu kp iy kq jc kr jg ks jk kt jo kl km kn ko dt translated">更快的开发和部署周期，因为您的应用程序被分成更小的单元，即使是几乎没有后端经验的前端开发人员也可以部署生产就绪的应用程序。</li></ul><p id="9b8f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你是怎么做到的？简单(但有时不容易)。</p><p id="6074" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以从把你的单页应用和静态内容转移到AWS S3开始。是的，就是你用来存储文件的那个S3。如果你把它和AWS CloudFront结合起来，你会得到一个强大的无服务器的静态网站托管和SSL和缓存。你可以手动或使用<a class="ae jp" href="https://github.com/stojanovic/scottyjs" rel="noopener ugc nofollow" target="_blank"> Scotty.js </a>等工具来配置你的静态网站<a class="ae jp" href="https://www.josephecombs.com/2018/03/05/how-to-make-an-AWS-S3-static-website-with-ssl" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="55c3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下一步是将数据库移出数字海洋水滴。如果您希望将MongoDB作为一个数据库，您可以将其迁移到MongoDB Atlas，这是一个云托管的MongoDB服务，由构建MongoDB数据库的同一个团队设计和运行。另外，可能更好的选择是将您的内容迁移到AWS DynamoDB数据库，这是一个由Amazon Web Services提供的无服务器noSQL数据库。</p><p id="4b1a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">既然您的静态文件和数据库已经退出了游戏，那么您可以开始从Express.js应用程序中提取其他服务。例如，预定消息(每周团队休假通知)是一个很好的首选。由于你不能在AWS Lambda中运行cronjob，你将需要另一个服务的帮助:CloudWatch事件可以在预定的时间触发你的Lambda函数，正如这里所描述的<a class="ae jp" href="https://medium.freecodecamp.org/scheduling-slack-messages-using-aws-lambda-e56a8eb22818" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="841f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，您必须迁移您的API。为此，您可以将您的逻辑拆分成多个AWS Lambda函数，并将API网关放在它们前面，因为Lambda函数不能由HTTP请求直接触发。你应该如何分割你的API？这取决于您的用例，但是最简单的方法是将它分成业务逻辑单元。例如，一个Lambda函数将处理Slack slash命令，另一个将处理Slack事件webhooks，一些其他函数将服务于仪表板API。由于您有一些Node.js经验，您可以使用<a class="ae jp" href="https://claudiajs.com/" rel="noopener ugc nofollow" target="_blank"> Claudia.js </a>轻松创建、部署和管理web APIs。</p><p id="bdab" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由于您的一些API端点将需要auth(直接或通过社交登录)，您可以用AWS无服务器auth service Cognito替换passport.js之类的工具。有了Cognito，没有有效授权的请求永远不会触发您的Lambda函数，所以您将付出更少的代价。</p><p id="d1ca" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">迁移后，您的应用程序可能如下所示:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/d543ecd60ca057bf90f66ca80a86faf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XGsUj-qI8XUGaJ80.jpg"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">Structure of serverless Vacation tracker app</figcaption></figure><p id="6456" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您想看到实际效果，请点击这里:</p><div class="me mf fm fo mg mh"><a href="http://vacationtrackerbot.com" rel="noopener  ugc nofollow" target="_blank"><div class="mi ab ej"><div class="mj ab mk cl cj ml"><h2 class="bd hv fv z el mm eo ep mn er et ht dt translated">休假跟踪系统-管理员工的缺勤和休假</h2><div class="mo l"><h3 class="bd b fv z el mm eo ep mn er et ek translated">假期跟踪器是一个简单的Slack机器人，帮助你管理你的团队的假期，病假和休息日。报名参加…</h3></div><div class="mp l"><p class="bd b gc z el mm eo ep mn er et ek translated">vacationtrackerbot.com</p></div></div><div class="mq l"><div class="mr l ms mt mu mq mv ka mh"/></div></div></a></div><h1 id="a444" class="lb lc hu bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">后续步骤</h1><p id="a659" class="pw-post-body-paragraph ir is hu it b iu lz iw ix iy ma ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">许多团队已经在生产中使用无服务器it，根据<a class="ae jp" href="http://www.zdnet.com/article/serverless-computing-containers-see-triple-digit-quarterly-growth-among-cloud-users/" rel="noopener ugc nofollow" target="_blank">最近由Cloudability </a>发布的AWS客户调查，无服务器的采用在一年内增长了近700%。</p><p id="75a2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你想了解更多关于构建和迁移无服务器应用的知识，以及上面提到的每一项服务，<a class="ae jp" href="https://twitter.com/simalexan" rel="noopener ugc nofollow" target="_blank">亚历山大·西蒙维奇</a>和我为曼宁出版社写了一整本书。你可以在这里得到这本书并阅读免费章节:</p><div class="me mf fm fo mg mh"><a href="https://www.manning.com/books/serverless-apps-with-node-and-claudiajs" rel="noopener  ugc nofollow" target="_blank"><div class="mi ab ej"><div class="mj ab mk cl cj ml"><h2 class="bd hv fv z el mm eo ep mn er et ht dt translated">Node和Claudia.js的无服务器应用程序</h2><div class="mo l"><h3 class="bd b fv z el mm eo ep mn er et ek translated">使用Claudia.js进行无服务器部署的精彩介绍</h3></div><div class="mp l"><p class="bd b gc z el mm eo ep mn er et ek translated">www.manning.com</p></div></div><div class="mq l"><div class="mw l ms mt mu mq mv ka mh"/></div></div></a></div><p id="59d2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本书还将告诉你更多关于其他团队如何在生产中使用无服务器的信息。例如，要了解MindMup如何通过两人团队和100美元的AWS账单为400，000名月活跃用户提供服务，或者一个小型CodePen前端开发团队如何使用AWS Lambda为每小时200，000个请求提供服务，请直接跳转到案例研究章节<a class="ae jp" href="https://livebook.manning.com/#!/book/serverless-apps-with-node-and-claudiajs/chapter-15" rel="noopener ugc nofollow" target="_blank">此处</a>。</p></div><div class="ab cl mx my hc mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="hn ho hp hq hr"><p id="8c86" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kx">原载于2018年3月29日</em><a class="ae jp" href="https://effortless-serverless.com/serverless/claudia/migration/2018/03/29/serverless-migration/" rel="noopener ugc nofollow" target="_blank"><em class="kx">effortless-serverless.com</em></a><em class="kx">。</em></p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ne nf l"/></div></figure></div></div>    
</body>
</html>