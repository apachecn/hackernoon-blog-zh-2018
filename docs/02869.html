<html>
<head>
<title>API testing using SuperTest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SuperTest的API测试</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/api-testing-using-supertest-1f830ce838f1?source=collection_archive---------0-----------------------#2018-03-31">https://medium.com/hackernoon/api-testing-using-supertest-1f830ce838f1?source=collection_archive---------0-----------------------#2018-03-31</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/05912fe5be375e61ad84a71a80cd00ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xMaFF2hSXpf_kIfG.jpg"/></div></div></figure><p id="d577" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">想知道如何为你的API编写测试？你可以使用超级测试来测试HTTP端点。</p><p id="c912" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在开始<strong class="je hv">超级测试</strong>之前，让我们使用node + express创建一个简单的API。让我们利用他们给我们的路线来学习<strong class="je hv">超级测试</strong>库。本文的重点不是使用express framework创建rest API。</p><p id="2754" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们转到/routes/users.js文件并创建一些端点。</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="c7c9" class="kk kl hu kg b fv km kn l ko kp"><strong class="kg hv">var </strong>express = require('express');<br/><strong class="kg hv">var </strong>router = express.Router();<br/><br/><em class="kq">/**<br/> * get all users<br/> */<br/></em>router.get('/', <strong class="kg hv">function </strong>(req, res, next) {<br/>    <strong class="kg hv">return </strong>res.json('all users sent');<br/>});<br/><br/><em class="kq">/**<br/> * Get a specific user<br/> */<br/></em>router.get('/:id', <strong class="kg hv">function </strong>(req, res, next) {<br/>    <strong class="kg hv">if </strong>(req.params.id === 'U001') { // just to demo<br/>        <strong class="kg hv">return </strong>res.json("user U001 found");<br/>    }<br/>    <strong class="kg hv">return </strong>res.status(404).json('user not found');<br/>});<br/><br/><em class="kq">/**<br/> * Add a user<br/> */<br/></em>router.post('/', <strong class="kg hv">function </strong>(req, res, next) {<br/>    <strong class="kg hv">let </strong>content = req.body;<br/>    <strong class="kg hv">if </strong>(content.id) { //just to demo<br/>        <strong class="kg hv">return </strong>res.status(201).json("user created");<br/>    }<br/>    <strong class="kg hv">return </strong>res.status(400).json('user not created');<br/>});<br/><br/>module.exports = router;</span></pre><p id="515a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我创建了两个简单的获取用户数据的get方法和一个保存用户的post方法。哈哈，我是开玩笑的，没有真正的数据库集成或保存功能，只是基于一些虚拟逻辑发送一些JSON输出😹和状态代码来测试我们的API。您可以创建一个真正的工作API。但是记得发送相关的<a class="ae ka" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" rel="noopener ugc nofollow" target="_blank"> HTTP状态代码</a>，这样以后编写单元测试时就容易了。</p><p id="5088" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在让我们关注使用<strong class="je hv"> SuperTest </strong>编写API测试。首先，您需要将依赖项安装为devDependancy。</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="62c8" class="kk kl hu kg b fv km kn l ko kp">npm install supertest --save-dev</span></pre><p id="f739" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这也包括mocha，因为super test使用mocha测试框架。但是你不需要安装它，它带有超级测试。</p><p id="c3d2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后，让我们在项目的根级别创建一个名为<em class="kq"> test </em>的目录，并创建一个名为<em class="kq"> apiTest.js的文件。</em>这个文件是我们编写API测试的文件。</p><p id="c2c3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们首先需要的是超级测试模块。</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="00fe" class="kk kl hu kg b fv km kn l ko kp">//apiTest.js<br/>const request = require('supertest');</span></pre><p id="d861" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后我们需要通过http。服务器调用supertest的request()方法。要做到这一点，让我们包括我们的快速应用程序如下。</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="3191" class="kk kl hu kg b fv km kn l ko kp">//apiTest.js<br/>const request = require('supertest');<br/>const<strong class="kg hv"> </strong>app = require('../app'); //reference to you app.js file</span></pre><p id="475c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们编写第一个API测试来测试<a class="ae ka" href="http://localhost:3000/users" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/users</a>端点。如果此端点正常工作，它应该返回状态代码200。用户路由文件就是这样实现的。参见下面的代码res.json()会自动设置状态码200。所以不用担心。</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="e45b" class="kk kl hu kg b fv km kn l ko kp"><em class="kq">//from users.js route file<br/>/**<br/> * get all users<br/> */<br/></em>router.get('/', <strong class="kg hv">function </strong>(req, res, next) {<br/>    <strong class="kg hv">return </strong>res.json('all users sent');<br/>});</span></pre><p id="61ca" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">好了，我们如何使用supertest在out apiTest.js中为这条路由编写测试。</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="a9b9" class="kk kl hu kg b fv km kn l ko kp">//apiTest.js<strong class="kg hv"><br/>const </strong>request = require('supertest');<br/><strong class="kg hv">const </strong>app = require('../app');<br/><br/>//==================== user API test ====================<br/><br/><em class="kq">/**<br/> * Testing get all user endpoint<br/> */<br/></em>describe('GET /users', <strong class="kg hv">function </strong>() {<br/>    it('respond with json containing a list of all users', <strong class="kg hv">function </strong>(done) {<br/>        request(app)<br/>            .get('/users')<br/>            .set('Accept', 'application/json')<br/>            .expect('Content-Type', /json/)<br/>            .expect(200, done);<br/>    });<br/>});</span></pre><p id="2294" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这里<strong class="je hv">描述</strong>方法来自于mocha测试框架。我们简单地指定端点名称作为第一个参数，然后指定函数来编写测试用例。这里摩卡<strong class="je hv">描述</strong>()是用于对测试用例进行分组，而<strong class="je hv"> it </strong>()是用于编写真实的测试用例。我们给出一个简单的描述，作为it()函数中的第一个参数，我们将要测试什么。然后是要调用的回调函数。</p><p id="e878" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">请求</strong>()需要HTTP.server，因此我们传递我们的express app引用。然后在<strong class="je hv"> get </strong>()中我们指定路线终点。这里我们在app中所以可以省略<a class="ae ka" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000/ </a>部分。只需给出路线终点。</p><p id="7061" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在<strong class="je hv"> set </strong>()中，我们设置HTTP头属性。然后在<strong class="je hv"> expect </strong>()中，我们检查返回值，包括头值和正文值。</p><p id="58a1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这个例子中，我们检查返回的内容类型是否是JSON。因为我们使用res.json()方法将响应作为JSON发送。然后expect(200)检查返回的状态代码是否等于200。然后我们通过调用回调函数<em class="kq"> done </em>来结束测试。</p><p id="e1ce" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">目前为止一切顺利。但是我们如何进行测试呢？你必须在你的<em class="kq"> package.json </em>文件中做这个改变。</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="25f0" class="kk kl hu kg b fv km kn l ko kp">"scripts": {<br/>  "start": "node ./bin/www",<br/>  "test": "mocha 'test/apiTest.js'" //path to your test file<br/>}</span></pre><p id="1db9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，您可以通过简单地使用</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="1a54" class="kk kl hu kg b fv km kn l ko kp">&gt; npm test</span></pre><p id="aa52" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">运行测试文件后，您将看到以下输出。</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="8909" class="kk kl hu kg b fv km kn l ko kp">&gt; mocha 'test/apiTest.js'</span><span id="2f0c" class="kk kl hu kg b fv kr kn l ko kp">GET /users<br/>GET /users 200 5.289 ms - 16<br/>    ✓ respond with json containing a list of all users</span><span id="ed04" class="kk kl hu kg b fv kr kn l ko kp">1 passing (38ms)</span></pre><p id="ac30" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们继续在users.js文件中编写所有端点的更多测试用例。</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="5fef" class="kk kl hu kg b fv km kn l ko kp"><strong class="kg hv">const </strong>request = require('supertest');<br/><strong class="kg hv">const </strong>app = require('../app');<br/><br/>//==================== user API test ====================<br/><br/><em class="kq">/**<br/> * Testing get all user endpoint<br/> */<br/></em>describe('GET /users', <strong class="kg hv">function </strong>() {<br/>    it('respond with json containing a list of all users', <strong class="kg hv">function </strong>(done) {<br/>        request(app)<br/>            .get('/users')<br/>            .set('Accept', 'application/json')<br/>            .expect('Content-Type', /json/)<br/>            .expect(200, done);<br/>    });<br/>});<br/><br/><em class="kq">/**<br/> * Testing get a user endpoint by giving an existing user<br/> */<br/></em>describe('GET /user/:id', <strong class="kg hv">function </strong>() {<br/>    it('respond with json containing a single user', <strong class="kg hv">function </strong>(done) {<br/>        request(app)<br/>            .get('/users/U001')<br/>            .set('Accept', 'application/json')<br/>            .expect('Content-Type', /json/)<br/>            .expect(200, done);<br/>    });<br/>});<br/><br/><em class="kq">/**<br/> * Testing get a user endpoint by giving a non-existing user<br/> */<br/></em>describe('GET /user/:id', <strong class="kg hv">function </strong>() {<br/>    it('respond with json user not found', <strong class="kg hv">function </strong>(done) {<br/>        request(app)<br/>            .get('/users/idisnonexisting')<br/>            .set('Accept', 'application/json')<br/>            .expect('Content-Type', /json/)<br/>            .expect(404) //expecting HTTP status code<br/>            .expect('"user not found"') // expecting content value<br/>            .end((err) =&gt; {<br/>                <strong class="kg hv">if </strong>(err) <strong class="kg hv">return </strong>done(err);<br/>                done();<br/>            });<br/>    });<br/>});<br/><br/><em class="kq">/**<br/> * Testing post user endpoint<br/> */<br/></em>describe('POST /users', <strong class="kg hv">function </strong>() {<br/>    <strong class="kg hv">let </strong>data = {<br/>        "id": "1",<br/>        "name": "dummy",<br/>        "contact": "dummy",<br/>        "address": "dummy"<br/>    }<br/>    it('respond with 201 created', <strong class="kg hv">function </strong>(done) {<br/>        request(app)<br/>            .post('/users')<br/>            .send(data)<br/>            .set('Accept', 'application/json')<br/>            .expect('Content-Type', /json/)<br/>            .expect(201)<br/>            .end((err) =&gt; {<br/>                <strong class="kg hv">if </strong>(err) <strong class="kg hv">return </strong>done(err);<br/>                done();<br/>            });<br/>    });<br/>});<br/><br/><em class="kq">/**<br/> * Testing post user endpoint<br/> */<br/></em>describe('POST /users', <strong class="kg hv">function </strong>() {<br/>    <strong class="kg hv">let </strong>data = {<br/>        //no id<br/>        "name": "dummy",<br/>        "contact": "dummy",<br/>        "address": "dummy"<br/>    }<br/>    it('respond with 400 not created', <strong class="kg hv">function </strong>(done) {<br/>        request(app)<br/>            .post('/users')<br/>            .send(data)<br/>            .set('Accept', 'application/json')<br/>            .expect('Content-Type', /json/)<br/>            .expect(400)<br/>            .expect('"user not created"')<br/>            .end((err) =&gt; {<br/>                <strong class="kg hv">if </strong>(err) <strong class="kg hv">return </strong>done(err);<br/>                done();<br/>            });<br/>    });<br/>});</span></pre><p id="7c58" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你仔细观察<em class="kq"> apiTest.js </em>文件中的代码，你会发现其中的规律。我只展示了GET和POST方法，但是您可以使用真正的工作API尝试PUT和DELETE方法。</p><p id="a48b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您使用<em class="kq"> npm test </em>命令运行这个测试文件，最后您会看到如下输出。</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="6469" class="kk kl hu kg b fv km kn l ko kp">&gt; mocha 'test/apiTest.js'<br/>GET /users<br/>GET /users 200 5.610 ms - 16<br/>    ✓ respond with json containing a list of all users</span><span id="0279" class="kk kl hu kg b fv kr kn l ko kp">GET /user/:id<br/>GET /users/U001 200 0.870 ms - 17<br/>    ✓ respond with json containing a single user</span><span id="57cf" class="kk kl hu kg b fv kr kn l ko kp">GET /user/:id<br/>GET /users/idisnonexisting 404 0.458 ms - 16<br/>    ✓ respond with json user not found</span><span id="f284" class="kk kl hu kg b fv kr kn l ko kp">POST /users<br/>POST /users 201 10.196 ms - 14<br/>    ✓ respond with 201 created</span><span id="dec0" class="kk kl hu kg b fv kr kn l ko kp">POST /users<br/>POST /users 400 0.607 ms - 18<br/>    ✓ respond with 400 not created</span><span id="232b" class="kk kl hu kg b fv kr kn l ko kp">5 passing (62ms)</span></pre><p id="110f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最好向https://github.com/visionmedia/supertest寻求更多的知识。</p></div></div>    
</body>
</html>