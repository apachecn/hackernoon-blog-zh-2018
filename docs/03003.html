<html>
<head>
<title>Image Classification with Convolutional Neural Networks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于卷积神经网络的图像分类</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/image-classification-with-convolutional-neural-networks-e2ec72130ecc?source=collection_archive---------8-----------------------#2018-04-05">https://medium.com/hackernoon/image-classification-with-convolutional-neural-networks-e2ec72130ecc?source=collection_archive---------8-----------------------#2018-04-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/8173ecaf30e3a16e6346cd28b4134ab8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CpAlLgVsQt8ATlax."/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">“Close up of modern metal sculpture of human face at Canary Wharf” by <a class="ae ih" href="https://unsplash.com/@clemono2?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Clem Onojeghuo</a> on <a class="ae ih" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><div class=""/><div class=""><h2 id="7b05" class="pw-subtitle-paragraph jh ij ik bd b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy ek translated">在21秒内，用4行代码训练和评估一个世界级的深度学习模型</h2></div><blockquote class="jz ka kb"><p id="6608" class="kc kd ke kf b kg kh jl ki kj kk jo kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">斯蒂芬·里马克</p></blockquote><p id="185b" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">以下包含笔记和<a class="ae ih" href="https://hackernoon.com/tagged/python" rel="noopener ugc nofollow" target="_blank"> python </a>代码，编译自<a class="ae ih" href="http://course.fast.ai" rel="noopener ugc nofollow" target="_blank"> fast.ai </a>联合创始人<a class="ae ih" href="http://www.fast.ai/about/#jeremy" rel="noopener ugc nofollow" target="_blank">杰瑞米·霍华德</a>的一次演讲。非常感谢Jeremy和<a class="ae ih" href="http://www.fast.ai/about/#rachel" rel="noopener ugc nofollow" target="_blank"> Rachel Thomas </a>构建fast.ai和<a class="ae ih" href="https://github.com/fastai/fastai/" rel="noopener ugc nofollow" target="_blank"> fast.ai库</a>，这是<a class="ae ih" href="http://pytorch.org" rel="noopener ugc nofollow" target="_blank"> PyTorch </a>的高级包装器。以下代码基于fast.ai库。要了解更多信息，请观看面向程序员的实用<a class="ae ih" href="https://hackernoon.com/tagged/deep-learning" rel="noopener ugc nofollow" target="_blank">深度学习</a>第一部分的第一课(共七课),该课程免费公开提供。如果你热衷于学习深度学习，你不会后悔的！</p><h1 id="ae6a" class="lc ld ik bd le lf lg lh li lj lk ll lm jq ln jr lo jt lp ju lq jw lr jx ls lt dt translated">目录</h1><ol class=""><li id="a734" class="lu lv ik kf b kg lw kj lx kz ly la lz lb ma ky mb mc md me dt translated">介绍我们的第一个任务:“狗对猫”</li><li id="c5ca" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky mb mc md me dt translated">先看猫咪图片</li><li id="be4f" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky mb mc md me dt translated">模型</li><li id="f5f1" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky mb mc md me dt translated">分析结果:查看图片</li></ol></div><div class="ab cl mk ml hc mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hn ho hp hq hr"><h1 id="4125" class="lc ld ik bd le lf mr lh li lj ms ll lm jq mt jr lo jt mu ju lq jw mv jx ls lt dt translated">1.介绍我们的第一个任务:狗对猫</h1><p id="373a" class="pw-post-body-paragraph kc kd ik kf b kg lw jl ki kj lx jo kl kz mw ko kp la mx ks kt lb my kw kx ky hn dt translated">我们将使用卷积神经网络(CNN)来让我们的计算机看到——这只能归功于深度学习。</p><p id="21d7" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">我们将尝试基于之前名为<a class="ae ih" href="https://www.kaggle.com/c/dogs-vs-cats" rel="noopener ugc nofollow" target="_blank">狗对猫</a>的Kaggle比赛的数据创建一个深度学习CNN模型。有<a class="ae ih" href="https://www.kaggle.com/c/dogs-vs-cats/data" rel="noopener ugc nofollow" target="_blank"> 25，000张带标签的狗和猫照片</a>可用于训练，测试集中有12，500张我们必须为这场比赛尝试标记。根据Kaggle网站，当这项比赛开始时(2013年底):</p><blockquote class="jz ka kb"><p id="f0f8" class="kc kd ke kf b kg kh jl ki kj kk jo kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">“最新技术水平:目前的文献表明，机器分类器在这项任务中可以达到80%以上的准确率”。</p></blockquote><p id="9333" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">因此，如果我们能超过80%，那么到2013年，我们将处于领先地位！好了，我们走吧。</p></div><div class="ab cl mk ml hc mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hn ho hp hq hr"><p id="89f4" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">将这些放在每个笔记本的顶部，以获得自动重新加载和内嵌绘图:</p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="ac68" class="ni ld ik ne b fv nj nk l nl nm">%reload_ext autoreload<br/>%autoreload 2<br/>%matplotlib inline</span></pre><p id="4489" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">在这里，我们导入我们需要的库:</p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="b6be" class="ni ld ik ne b fv nj nk l nl nm"><strong class="ne il">from</strong> <strong class="ne il">fastai.imports</strong> <strong class="ne il">import</strong> *<br/><strong class="ne il">from</strong> <strong class="ne il">fastai.transforms</strong> <strong class="ne il">import</strong> *<br/><strong class="ne il">from</strong> <strong class="ne il">fastai.conv_learner</strong> <strong class="ne il">import</strong> *<br/><strong class="ne il">from</strong> <strong class="ne il">fastai.model</strong> <strong class="ne il">import</strong> *<br/><strong class="ne il">from</strong> <strong class="ne il">fastai.dataset</strong> <strong class="ne il">import</strong> *<br/><strong class="ne il">from</strong> <strong class="ne il">fastai.sgdr</strong> <strong class="ne il">import</strong> *<br/><strong class="ne il">from</strong> <strong class="ne il">fastai.plots</strong> <strong class="ne il">import</strong> *</span><span id="2f28" class="ni ld ik ne b fv nn nk l nl nm">PATH = "data/dogscats/"</span></pre><p id="c3c9" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">我们将下面的尺寸设置为<code class="eh no np nq ne b">224</code>，因为<strong class="kf il"> resnet </strong>使用224 x 224的图像尺寸。稍后将详细介绍:</p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="8030" class="ni ld ik ne b fv nj nk l nl nm">sz=224</span></pre><h1 id="5b0e" class="lc ld ik bd le lf lg lh li lj lk ll lm jq ln jr lo jt lp ju lq jw lr jx ls lt dt translated">数据下载</h1><p id="765d" class="pw-post-body-paragraph kc kd ik kf b kg lw jl ki kj lx jo kl kz mw ko kp la mx ks kt lb my kw kx ky hn dt translated">数据集可在<a class="ae ih" href="http://files.fast.ai/data/dogscats.zip" rel="noopener ugc nofollow" target="_blank">http://files.fast.ai/data/dogscats.zip</a>获得。您可以通过在终端中运行下面一行来直接下载到您的服务器上。<code class="eh no np nq ne b">wget http://files.fast.ai/data/dogscats.zip</code>。您应该将数据放在Jupyter笔记本目录的子目录中，名为<code class="eh no np nq ne b">data/</code>。</p></div><div class="ab cl mk ml hc mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hn ho hp hq hr"><h1 id="7353" class="lc ld ik bd le lf mr lh li lj ms ll lm jq mt jr lo jt mu ju lq jw mv jx ls lt dt translated">2.先看猫咪图片</h1><p id="eff5" class="pw-post-body-paragraph kc kd ik kf b kg lw jl ki kj lx jo kl kz mw ko kp la mx ks kt lb my kw kx ky hn dt translated">fast.ai库会假设你有<em class="ke"> train </em>和<em class="ke">有效的</em>目录。它还假设每个目录都有您希望识别的每个类的子目录(在本例中为“猫”和“狗”)。</p><p id="969d" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">下面将显示“路径”文件夹的内容；<code class="eh no np nq ne b">!</code>意为迎头痛击。</p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="df80" class="ni ld ik ne b fv nj nk l nl nm">!ls {PATH}</span><span id="18b6" class="ni ld ik ne b fv nn nk l nl nm">!ls {PATH}valid</span></pre><p id="1dcf" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">以下代码显示了validation cats文件夹中的内容。这是共享或提供影像分类文件的标准方式。</p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="b76d" class="ni ld ik ne b fv nj nk l nl nm">files = !ls {PATH}valid/cats | head<br/>files</span><span id="01b0" class="ni ld ik ne b fv nn nk l nl nm"><em class="ke"># Example: show first cat image in the cats folder</em></span><span id="f1ba" class="ni ld ik ne b fv nn nk l nl nm">img = plt.imread(f'<strong class="ne il">{PATH}</strong>valid/cats/<strong class="ne il">{files[0]}</strong>') <em class="ke"># This is formatting string</em><br/><br/>plt.imshow(img);</span></pre><figure class="mz na nb nc fq hw fe ff paragraph-image"><div class="fe ff nr"><img src="../Images/544794df775cc0083518f6f3830bcf26.png" data-original-src="https://miro.medium.com/v2/resize:fit:480/format:webp/1*sGoluqZEa4RT1671WfiHfg.png"/></div><figcaption class="id ie fg fe ff if ig bd b be z ek">I am cute</figcaption></figure><p id="7097" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">下面的代码显示了原始数据的样子。这被称为一个<code class="eh no np nq ne b">rank 3 tensor </code>又名一个3×3矩阵。每个单元显示红色、绿色和蓝色像素值btwn 0和255。</p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="97f6" class="ni ld ik ne b fv nj nk l nl nm">img.shape</span><span id="8f61" class="ni ld ik ne b fv nn nk l nl nm"><strong class="ne il">Output:</strong><br/>(198, 179, 3)</span><span id="532e" class="ni ld ik ne b fv nn nk l nl nm">img[:4,:4]</span><span id="4f3c" class="ni ld ik ne b fv nn nk l nl nm"><strong class="ne il">Output:</strong><br/>array([[[ 29,  20,  23],<br/>        [ 31,  22,  25],<br/>        [ 34,  25,  28],<br/>        [ 37,  28,  31]],<br/><br/>       [[ 60,  51,  54],<br/>        [ 58,  49,  52],<br/>        [ 56,  47,  50],<br/>        [ 55,  46,  49]],<br/><br/>       [[ 93,  84,  87],<br/>        [ 89,  80,  83],<br/>        [ 85,  76,  79],<br/>        [ 81,  72,  75]],<br/><br/>       [[104,  95,  98],<br/>        [103,  94,  97],<br/>        [102,  93,  96],<br/>        [102,  93,  96]]], dtype=uint8)</span></pre></div><div class="ab cl mk ml hc mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hn ho hp hq hr"><h1 id="9f32" class="lc ld ik bd le lf mr lh li lj ms ll lm jq mt jr lo jt mu ju lq jw mv jx ls lt dt translated">3.模型</h1><p id="9611" class="pw-post-body-paragraph kc kd ik kf b kg lw jl ki kj lx jo kl kz mw ko kp la mx ks kt lb my kw kx ky hn dt translated">我们将使用一个<strong class="kf il">预训练的</strong>模型，也就是说，一个由其他人创建的模型来解决一个不同的问题。我们将使用一个在<a class="ae ih" href="https://en.wikipedia.org/wiki/ImageNet" rel="noopener ugc nofollow" target="_blank">ImageNet</a>(120万张图片和1000个类)上训练的模型作为起点，而不是从头构建一个模型来解决类似的问题。该模型是卷积神经网络(CNN)，这是一种为计算机视觉建立最先进模型的神经网络。</p><p id="6548" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">我们将使用<strong class="kf il"> resnet34 </strong>作为我们的预训练模型。resnet34是赢得2015年ImageNet竞赛的模型版本。这里有更多关于resnet模型的信息。</p><p id="3b56" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">以下是如何用4行代码在21秒内训练和评估一个<em class="ke">狗对猫</em>模型。在下面的语法罩下是由fast.ai编写的代码/包装器。fast.ai库定期更新，并跟上尖端的深度学习研究。所以fast.ai确保最佳实践总是被使用。反过来，这工作得非常快(例如，10-60秒，取决于GPU)，因为它位于Pytorch之上，py torch是facebook编写的一个非常灵活的库。</p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="cc96" class="ni ld ik ne b fv nj nk l nl nm">arch=resnet34</span><span id="115f" class="ni ld ik ne b fv nn nk l nl nm">data = ImageClassifierData.from_paths(PATH, tfms=tfms_from_model(arch, sz))</span><span id="d5dd" class="ni ld ik ne b fv nn nk l nl nm">learn = ConvLearner.pretrained(arch, data, precompute=<strong class="ne il">True</strong>)</span><span id="9122" class="ni ld ik ne b fv nn nk l nl nm">learn.fit(0.01, 3)</span><span id="e63d" class="ni ld ik ne b fv nn nk l nl nm"><strong class="ne il">Output:</strong></span><span id="0d24" class="ni ld ik ne b fv nn nk l nl nm">100%|██████████| 360/360 [00:57&lt;00:00,  6.24it/s]<br/>100%|██████████| 32/32 [00:05&lt;00:00,  6.04it/s]</span><span id="33ad" class="ni ld ik ne b fv nn nk l nl nm">epoch      trn_loss   val_loss   accuracy                     <br/>    0      0.045726   0.028603   0.989258  <br/>    1      0.039685   0.026488   0.990234                     <br/>    2      0.041631   0.03259    0.990234</span><span id="802b" class="ni ld ik ne b fv nn nk l nl nm">[0.032590486, 0.990234375]</span></pre><p id="06b0" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated"><code class="eh no np nq ne b">data</code>对象包含训练和验证数据。</p><p id="8fe5" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated"><code class="eh no np nq ne b">ImageClassifierData.from_paths</code>读入图像及其标签作为子文件夹名称:</p><ul class=""><li id="8160" class="lu lv ik kf b kg kh kj kk kz ns la nt lb nu ky nv mc md me dt translated"><code class="eh no np nq ne b">path</code>:数据的根路径(用于存储训练模型、预计算值等)</li><li id="6312" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky nv mc md me dt translated"><code class="eh no np nq ne b">bs</code>:批量大小。默认64。</li><li id="61dd" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky nv mc md me dt translated"><code class="eh no np nq ne b">tfms</code>:转换(用于数据扩充)。例如<code class="eh no np nq ne b">tfms_from_model</code>的输出。默认“无”</li><li id="7853" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky nv mc md me dt translated"><code class="eh no np nq ne b">trn_name</code>:包含训练图像的文件夹的名称。默认“列车”</li><li id="306e" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky nv mc md me dt translated"><code class="eh no np nq ne b">val_name</code>:包含验证图像的文件夹的名称。默认“有效”</li><li id="dfb9" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky nv mc md me dt translated"><code class="eh no np nq ne b">test_name</code>:包含测试图像的文件夹的名称。默认“无”</li><li id="35fc" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky nv mc md me dt translated"><code class="eh no np nq ne b">num_workers</code>:工人数量。默认“8”</li></ul><p id="b865" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated"><code class="eh no np nq ne b">learn</code>对象包含模型。</p><p id="80b6" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated"><code class="eh no np nq ne b">ConvLearner.pretrained</code>:</p><ul class=""><li id="f22e" class="lu lv ik kf b kg kh kj kk kz ns la nt lb nu ky nv mc md me dt translated"><code class="eh no np nq ne b">f</code>:拱形。例如resnet34</li><li id="f0c6" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky nv mc md me dt translated"><code class="eh no np nq ne b">data</code>:之前定义的数据对象</li><li id="9ad9" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky nv mc md me dt translated"><code class="eh no np nq ne b">precompute</code>:包含/排除预计算激活。默认“假”</li></ul><p id="70ab" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated"><code class="eh no np nq ne b">learn.fit</code>通过给定的学习率和时期训练/拟合模型。在这种情况下，它将以0.01的学习率进行3个时期，这意味着它将总共查看每幅图像三次。</p><p id="67d4" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated"><code class="eh no np nq ne b">trn_loss</code>和<code class="eh no np nq ne b">val_loss</code>是交叉熵损失函数值。</p><p id="4115" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">这种模式有多好？在这场比赛之前，最先进的是80%的准确率。但比赛的结果是准确率大幅跃升至99.0%，一个受欢迎的深度学习库的作者赢得了比赛。不同寻常的是，不到4年后，我们现在可以在几秒钟内打破这个结果！</p><p id="5004" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">上面的模型，可以用在任何类型的图片上，只要是人们平常拍照的东西。然而，像病理图片或CT扫描这样的东西使用这种模型不会做得很好。我们需要做一些小事情来实现这些功能。这将在随后的笔记本中介绍。敬请期待！</p></div><div class="ab cl mk ml hc mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hn ho hp hq hr"><h1 id="01eb" class="lc ld ik bd le lf mr lh li lj ms ll lm jq mt jr lo jt mu ju lq jw mv jx ls lt dt translated">4.分析结果:查看图片</h1><p id="19d8" class="pw-post-body-paragraph kc kd ik kf b kg lw jl ki kj lx jo kl kz mw ko kp la mx ks kt lb my kw kx ky hn dt translated">除了查看整体指标，查看一些预测示例也是一个不错的主意:</p><ol class=""><li id="0336" class="lu lv ik kf b kg kh kj kk kz ns la nt lb nu ky mb mc md me dt translated">随意几个正确的标签</li><li id="521c" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky mb mc md me dt translated">一些不正确的标签</li><li id="f1fb" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky mb mc md me dt translated">每个类别中最正确的标签(即最有可能正确的标签)</li><li id="ef3a" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky mb mc md me dt translated">每个类别中最不正确的标签(即最有可能不正确的标签)</li><li id="e151" class="lu lv ik kf b kg mf kj mg kz mh la mi lb mj ky mb mc md me dt translated">最不确定的标签(即概率最接近0.5的标签)。</li></ol><p id="7c5e" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">我们很快就会看到这一切。但是首先，如果我们想要了解数据，我们可以用下面的一些方法来查看内部:</p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="975e" class="ni ld ik ne b fv nj nk l nl nm"><em class="ke"># Pull the label (dependent variable)<br/></em>data.val_y</span><span id="0acf" class="ni ld ik ne b fv nn nk l nl nm"><em class="ke"># Pull the data classes<br/></em>data.classes</span><span id="695c" class="ni ld ik ne b fv nn nk l nl nm"><em class="ke"># Pull the y log predictions<br/></em>log_preds = learn.predict()<br/>log_preds.shape</span><span id="6b1d" class="ni ld ik ne b fv nn nk l nl nm"><em class="ke"># Pull first 10 predictions<br/></em>log_preds[:10]</span><span id="d507" class="ni ld ik ne b fv nn nk l nl nm"><em class="ke"># from log probabilities to 0 or 1<br/></em>preds = np.argmax(log_preds, axis=1) </span><span id="1b3b" class="ni ld ik ne b fv nn nk l nl nm"><em class="ke"># pr(dog); i.e., anti log<br/></em>probs = np.exp(log_preds[:,1])</span></pre><p id="1809" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated"><strong class="kf il">绘图功能</strong></p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="905b" class="ni ld ik ne b fv nj nk l nl nm"><strong class="ne il">def</strong> rand_by_mask(mask): <strong class="ne il">return</strong> np.random.choice(np.where(mask)[0], 4, replace=<strong class="ne il">False</strong>)</span><span id="a5b9" class="ni ld ik ne b fv nn nk l nl nm"><strong class="ne il">def</strong> rand_by_correct(is_correct): <strong class="ne il">return</strong> rand_by_mask((preds == data.val_y)==is_correct)</span><span id="06e2" class="ni ld ik ne b fv nn nk l nl nm"><strong class="ne il">def</strong> plot_val_with_title(idxs, title):<br/>    imgs = np.stack([data.val_ds[x][0] <strong class="ne il">for</strong> x <strong class="ne il">in</strong> idxs])<br/>    title_probs = [probs[x] <strong class="ne il">for</strong> x <strong class="ne il">in</strong> idxs]<br/>    print(title)<br/>    <strong class="ne il">return</strong> plots(data.val_ds.denorm(imgs), rows=1, titles=title_probs)</span><span id="87ec" class="ni ld ik ne b fv nn nk l nl nm"><strong class="ne il">def</strong> plots(ims, figsize=(12,6), rows=1, titles=<strong class="ne il">None</strong>):<br/>    f = plt.figure(figsize=figsize)<br/>    <strong class="ne il">for</strong> i <strong class="ne il">in</strong> range(len(ims)):<br/>        sp = f.add_subplot(rows, len(ims)//rows, i+1)<br/>        sp.axis('Off')<br/>        <strong class="ne il">if</strong> titles <strong class="ne il">is</strong> <strong class="ne il">not</strong> <strong class="ne il">None</strong>: sp.set_title(titles[i], fontsize=16)<br/>        plt.imshow(ims[i])</span><span id="506d" class="ni ld ik ne b fv nn nk l nl nm"><strong class="ne il">def</strong> load_img_id(ds, idx): <strong class="ne il">return</strong> np.array(PIL.Image.open(PATH+ds.fnames[idx]))</span><span id="d762" class="ni ld ik ne b fv nn nk l nl nm"><strong class="ne il">def</strong> plot_val_with_title(idxs, title):<br/>    imgs = [load_img_id(data.val_ds,x) <strong class="ne il">for</strong> x <strong class="ne il">in</strong> idxs]<br/>    title_probs = [probs[x] <strong class="ne il">for</strong> x <strong class="ne il">in</strong> idxs]<br/>    print(title)<br/>    <strong class="ne il">return</strong> plots(imgs, rows=1, titles=title_probs, figsize=(16,8))</span><span id="f3ae" class="ni ld ik ne b fv nn nk l nl nm"><strong class="ne il">def</strong> most_by_mask(mask, mult):<br/>    idxs = np.where(mask)[0]<br/>    <strong class="ne il">return</strong> idxs[np.argsort(mult * probs[idxs])[:4]]<br/><br/><strong class="ne il">def</strong> most_by_correct(y, is_correct): <br/>    mult = -1 <strong class="ne il">if</strong> (y==1)==is_correct <strong class="ne il">else</strong> 1<br/>    <strong class="ne il">return</strong> most_by_mask(((preds == data.val_y)==is_correct) &amp; (data.val_y == y), mult)</span></pre><h1 id="a4f7" class="lc ld ik bd le lf lg lh li lj lk ll lm jq ln jr lo jt lp ju lq jw lr jx ls lt dt translated">随意几个正确的标签</h1><p id="06e5" class="pw-post-body-paragraph kc kd ik kf b kg lw jl ki kj lx jo kl kz mw ko kp la mx ks kt lb my kw kx ky hn dt translated">任何大于0.5的都是狗；小于0.5的任何值都是cat:</p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="0e01" class="ni ld ik ne b fv nj nk l nl nm">plot_val_with_title(rand_by_correct(<strong class="ne il">True</strong>), "Correctly classified")</span></pre><figure class="mz na nb nc fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nw"><img src="../Images/b66fc19617a129d847882079a3bdc02a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XpELXe_n6M_jI89yKjr_Qg.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Ahhh</figcaption></figure><h1 id="b6f3" class="lc ld ik bd le lf lg lh li lj lk ll lm jq ln jr lo jt lp ju lq jw lr jx ls lt dt translated">一些不正确的标签</h1><p id="04a7" class="pw-post-body-paragraph kc kd ik kf b kg lw jl ki kj lx jo kl kz mw ko kp la mx ks kt lb my kw kx ky hn dt translated">任何大于0.5的都是狗；小于0.5的任何值都是cat:</p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="16fa" class="ni ld ik ne b fv nj nk l nl nm">plot_val_with_title(rand_by_correct(<strong class="ne il">True</strong>), "Correctly classified")</span></pre><figure class="mz na nb nc fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nw"><img src="../Images/7b6664363cbabc6e3467dc8ec22db317.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EtQNb8tsf0gHEuBLMFkApQ.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Dogs?</figcaption></figure><h1 id="80a8" class="lc ld ik bd le lf lg lh li lj lk ll lm jq ln jr lo jt lp ju lq jw lr jx ls lt dt translated">每类最正确的标签</h1><p id="6747" class="pw-post-body-paragraph kc kd ik kf b kg lw jl ki kj lx jo kl kz mw ko kp la mx ks kt lb my kw kx ky hn dt translated">(即，正确概率最高的那些)</p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="f8ba" class="ni ld ik ne b fv nj nk l nl nm">plot_val_with_title(most_by_correct(0, <strong class="ne il">True</strong>), "Most correct cats")</span><span id="a547" class="ni ld ik ne b fv nn nk l nl nm">plot_val_with_title(most_by_correct(1, <strong class="ne il">True</strong>), "Most correct dogs")</span></pre><figure class="mz na nb nc fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nx"><img src="../Images/999e5acdf9769462fceab2d393d6df4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YqdkiHol1xl0pE3GsOe2_A.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">I like the grey ones</figcaption></figure><figure class="mz na nb nc fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nw"><img src="../Images/c83140bc50207c1446f029b3c52ad19c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZozuC7QhLGeDW3jLiOfqBg.png"/></div></div></figure><h1 id="97d4" class="lc ld ik bd le lf lg lh li lj lk ll lm jq ln jr lo jt lp ju lq jw lr jx ls lt dt translated">每类最不正确的标签</h1><p id="3eab" class="pw-post-body-paragraph kc kd ik kf b kg lw jl ki kj lx jo kl kz mw ko kp la mx ks kt lb my kw kx ky hn dt translated">(即最有可能不正确的那些)</p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="b05e" class="ni ld ik ne b fv nj nk l nl nm">plot_val_with_title(most_by_correct(0, <strong class="ne il">False</strong>), "Most incorrect cats")</span><span id="8f0e" class="ni ld ik ne b fv nn nk l nl nm">plot_val_with_title(most_by_correct(1, <strong class="ne il">False</strong>), "Most incorrect dogs")</span></pre><figure class="mz na nb nc fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nw"><img src="../Images/cf7029bb3825db01d30462cd8acf5b4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lp6yu21SDnDILvualg5gAw.png"/></div></div></figure><figure class="mz na nb nc fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nw"><img src="../Images/6dc5d04bd49c5428a28409f9fca22dc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Xd_-BPERpSH25e3irpPvQ.png"/></div></div></figure><h1 id="dc3d" class="lc ld ik bd le lf lg lh li lj lk ll lm jq ln jr lo jt lp ju lq jw lr jx ls lt dt translated">最不确定的标签</h1><p id="dc91" class="pw-post-body-paragraph kc kd ik kf b kg lw jl ki kj lx jo kl kz mw ko kp la mx ks kt lb my kw kx ky hn dt translated">(即概率最接近0.5的那些)</p><pre class="mz na nb nc fq nd ne nf ng aw nh dt"><span id="6c2b" class="ni ld ik ne b fv nj nk l nl nm"><em class="ke"># probabilites are closest to 0.5</em></span><span id="e3d0" class="ni ld ik ne b fv nn nk l nl nm">most_uncertain = np.argsort(np.abs(probs -0.5))[:4]<br/>plot_val_with_title(most_uncertain, "Most uncertain predictions")</span></pre><figure class="mz na nb nc fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nx"><img src="../Images/51146e84eb95209378b52ab5e6ca8623.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kEhq4LkBNdP-k7lwiW139g.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">weird</figcaption></figure><p id="d81f" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">注意:上面尺寸错误的图片(如矩形图片)会扭曲结果。我们使用一种叫做<code class="eh no np nq ne b">data augmentation</code>的技术来处理这个问题。在以后的文章中会有更多的介绍。</p><p id="321e" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated"><strong class="kf il">专家提示</strong>:如果你想让模型变得更好，你可能想利用它为什么做得好，并修正它做得不好的地方。例如，在另一个Jupyter笔记本中，尝试移除只是扭曲数据的图像，如卡通等。如果你知道怎么做，请告诉我:)</p><p id="f980" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">以上所有工作见下面的GitHub链接。</p><p id="3ae7" class="pw-post-body-paragraph kc kd ik kf b kg kh jl ki kj kk jo kl kz kn ko kp la kr ks kt lb kv kw kx ky hn dt translated">感谢阅读！</p><div class="ht hu fm fo hv ny"><a href="https://github.com/Stephen-Rimac/Image-classification-with-CNNs" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab ej"><div class="oa ab ob cl cj oc"><h2 class="bd il fv z el od eo ep oe er et ij dt translated">Stephen-Rimac/使用CNN的图像分类</h2><div class="of l"><h3 class="bd b fv z el od eo ep oe er et ek translated">通过在GitHub上创建一个帐户，为使用CNN的图像分类开发做出贡献。</h3></div><div class="og l"><p class="bd b gc z el od eo ep oe er et ek translated">github.com</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om ib ny"/></div></div></a></div><figure class="mz na nb nc fq hw"><div class="bz el l di"><div class="on oo l"/></div></figure></div></div>    
</body>
</html>