<html>
<head>
<title>Finally you can share Docker machines — without a script</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">最后，您可以共享Docker机器——无需脚本</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/finally-you-can-share-docker-machines-without-a-script-8f946d050f7?source=collection_archive---------3-----------------------#2018-04-06">https://medium.com/hackernoon/finally-you-can-share-docker-machines-without-a-script-8f946d050f7?source=collection_archive---------3-----------------------#2018-04-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/b2eca082e8a6a9d5cb700c3dc6078849.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rzsn1mA1i5iFcGu6nXkozA.jpeg"/></div></div></figure><p id="4c76" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ka" href="https://hackernoon.com/tagged/docker" rel="noopener ugc nofollow" target="_blank"> Docker </a>机器是供应新Docker主机或<em class="kb">机器</em>的最简单方式。我用它来设置新的远程登台服务器，最多需要一分钟。它为Docker引擎选择一个合适的Linux发行版，并安装Docker守护进程，这一切都是一次性完成的。</p><p id="ab73" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它可以通过15个不同的云提供商完成所有这些工作！您可以在其中任何一个中设置一个服务器，使用同样简单的命令<em class="kb"> docker-machine create </em>。<br/>例如，如果您使用的是<a class="ae ka" href="https://hackernoon.com/tagged/aws" rel="noopener ugc nofollow" target="_blank"> AWS </a>，Docker Machine会代表您调用AWS API，在您的AWS帐户中创建一个EC2实例。</p><p id="1509" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">—它非常快<br/> —命令行非常简单<br/> —它管理所有的SSH密钥和TLS证书，即使您有几十台服务器<br/> —让您的服务器立即为Docker部署做好准备</p><p id="87bd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是有一个问题……它只能在你的电脑上本地存储它的所有配置。</p><p id="8b6c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所以在你设置好你的服务器并部署好你的项目后，你的队友将无法连接到<em class="kb">机器</em>并自行重新部署。</p><p id="22a8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如何与队友共享Docker主机的访问权限？他们需要SSH密钥和机器创建的TLS证书来连接到远程Docker守护进程。<br/>您至少需要TLS证书才能从本地Docker客户端连接到您的远程Docker主机，因为这是Docker连接到端口2376上显示的Docker HTTP API的安全方式。</p><h2 id="3c62" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">顺便问一下，它是如何工作的？</h2><p id="73c5" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">我已经在这里展示了Docker Machine如何在你的本地计算机上存储密钥和证书。都在<code class="eh lc ld le lf b">~/.docker/machine/machines</code>里。</p><h2 id="9248" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">失败1:使用Docker机器通用驱动程序</h2><p id="d051" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">docker Machine“generic”驱动程序使用带有SSH的现有VM/主机创建<em class="kb">机器</em>。例如，如果您已经为您的服务器提供了Terraform，这也很好，因为它会连接到这些服务器并为您安装Docker守护程序。</p><p id="5b77" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">通用驱动程序听起来像是让您的队友安装Docker机器的有效解决方案:</p><pre class="lg lh li lj fq lk lf ll lm aw ln dt"><span id="2d3b" class="kc kd hu lf b fv lo lp l lq lr">docker-machine create \<br/>  --driver generic \<br/>  --generic-ip-address=YOUR_SERVER_IP \<br/>  --generic-ssh-key PATH_TO_YOUR_SSH_KEY \<br/>  my_project</span></pre><p id="9ce5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这将连接到远程服务器，重启Docker守护进程，停止所有正在运行的容器，并…重新生成远程TLS证书。这意味着他们可以连接，但你不能再连接了！</p><figure class="lg lh li lj fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ls"><img src="../Images/71a53968ec2afc2d3ec8c10fb82e2985.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cmAnaQyHunaDIPvoNJ2D8g.png"/></div></div><figcaption class="lt lu fg fe ff lv lw bd b be z ek">Error checking and/or regenerating the certs. You can attempt to regenerate them using ‘docker-machine regenerate-certs [name]’</figcaption></figure><p id="1f7c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">嗯，你可以从你的终端重新生成本地和远程证书，你的队友下一次也必须这样做，等等..失败</p><h2 id="3746" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">失败2:复制文件夹</h2><p id="8318" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">现在你知道Machine如何在内部存储<em class="kb"> machine </em>的配置，第二个想法就是简单地将<code class="eh lc ld le lf b">~/.docker/machine/machines/xxx</code>文件夹直接复制到你的队友<code class="eh lc ld le lf b">~/.docker/machine/machines</code>文件夹中。</p><p id="2710" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们试一试，并尝试连接到Docker主机:</p><figure class="lg lh li lj fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lx"><img src="../Images/c9d799eb06e99765853ae9221db58b4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XERUvFH1b10NtwhzwJGAww.png"/></div></div><figcaption class="lt lu fg fe ff lv lw bd b be z ek">There was an error validating certificates for host “YOUR_SERVER_IP:2376”: x509: certificate signed by unknown authority</figcaption></figure><p id="8a27" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">哇，机器检测到您复制的客户端证书不是您自己创建/签名的(您自己的主证书存储在<code class="eh lc ld le lf b">~/.docker/machine/certs</code>)并拒绝连接。失败</p><h2 id="99a7" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">失败3:使用Docker机器“无”驱动程序</h2><p id="105d" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">这个看起来符合要求，但是好像已经坏了一段时间了。</p><h2 id="2aef" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">解决方案</h2><p id="bc80" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">解决方案是为这个Docker主机导入客户机证书和SSH密钥，同时还要从最初创建Docker <em class="kb">机器</em>的开发人员那里导入主证书。</p><p id="87e0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您不想覆盖自己的主证书，所以我们将它们保存在<em class="kb">机器</em>文件夹中，并修改<em class="kb">机器</em> <code class="eh lc ld le lf b">config.json</code>文件以指向这些特定的主证书。</p><ol class=""><li id="1500" class="ly lz hu je b jf jg jj jk jn ma jr mb jv mc jz md me mf mg dt translated">将您的<em class="kb">机器</em>文件夹克隆到一个临时目录中，并将您的证书克隆到其中:</li></ol><pre class="lg lh li lj fq lk lf ll lm aw ln dt"><span id="725c" class="kc kd hu lf b fv lo lp l lq lr">$ <!-- -->cp -R ~/.docker/machine/machines/my_machine . &amp;&amp; \<br/>  cp ~/.docker/machine/certs/* ./my_machine/certs</span></pre><p id="8f26" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">2.更新<code class="eh lc ld le lf b">./my_machine/config.json</code>以兼容你的队友Docker存储路径(Docker机器只取绝对路径，所以你需要用<code class="eh lc ld le lf b">/Users/her_username/.docker</code>替换<code class="eh lc ld le lf b">/Users/your_username/.docker</code>)(假设OSX):</p><pre class="lg lh li lj fq lk lf ll lm aw ln dt"><span id="0d0c" class="kc kd hu lf b fv lo lp l lq lr">$ sed -i.bak 's/machine\/certs/machine\/machines\/my_machine\/certs/' ./my_machine/config.json</span><span id="c75f" class="kc kd hu lf b fv mh lp l lq lr">$ sed -i.bak 's/your_username/her_username/' ./my_machine/config.json</span></pre><p id="02b7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">3.存档您的<em class="kb">机器</em>配置:</p><pre class="lg lh li lj fq lk lf ll lm aw ln dt"><span id="67dd" class="kc kd hu lf b fv lo lp l lq lr">$ tar -zcf my_machine.tar.gz my_machine</span></pre><p id="b9de" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让他们将档案解压到他们的<code class="eh lc ld le lf b">~/.docker/machine</code>中。瞧啊。</p><figure class="lg lh li lj fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mi"><img src="../Images/60ee4b4572df969fa3bb72d6eb302120.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ei7RLlGElX10NA_3_Cw-_g.jpeg"/></div></div></figure></div><div class="ab cl mj mk hc ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="hn ho hp hq hr"><p id="f0c2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">莱昂内尔是总部位于伦敦的初创公司Wi5的首席技术官，也是《面向未来的工程文化课程<a class="ae ka" href="https://hackernoon.com/why-the-platform-model-is-broken-a51478b1b4ee" rel="noopener ugc nofollow" target="_blank"><em class="kb"/></a><em class="kb">的作者。你可以在</em><a class="ae ka" href="https://getlionel.com" rel="noopener ugc nofollow" target="_blank"><em class="kb">https://getlionel.com</em></a>上联系他</p><figure class="lg lh li lj fq iv"><div class="bz el l di"><div class="mq mr l"/></div></figure></div></div>    
</body>
</html>