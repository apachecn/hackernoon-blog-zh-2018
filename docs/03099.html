<html>
<head>
<title>Tutorial: SSR Split Testing and Analytics with React, Redux, and Next.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">教程:使用React、Redux和Next.js进行SSR分割测试和分析</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/tutorial-ssr-split-testing-and-analytics-with-react-redux-and-next-js-5392799c15c7?source=collection_archive---------5-----------------------#2018-04-09">https://medium.com/hackernoon/tutorial-ssr-split-testing-and-analytics-with-react-redux-and-next-js-5392799c15c7?source=collection_archive---------5-----------------------#2018-04-09</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/b7e4017738770a20ac36b5d7a4ac4ca1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yfy9qOJwzCxxK9bdOAOpFA.png"/></div></div></figure><div class=""/><p id="b28a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Eric Reis的《精益创业》为我们企业的成功开出了药方:建立、<strong class="je ig">测量</strong>，学习，重复。这篇文章主要关注“测量”部分。</p><p id="6403" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">分割测试和分析不是特性，而是需求。</strong></p><p id="1c93" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你连用户在做什么都不知道，你怎么能知道任何东西在工作呢？如果不进行测量，您如何知道一种方法是成功还是失败？</p><blockquote class="ka"><p id="8d82" class="kb kc if bd kd ke kf kg kh ki kj jz ek translated">“当推出一个新的漏斗时，你不一定期望它马上起作用——你是在购买数据。”—鲁达·克里希纳</p></blockquote><p id="aa1d" class="pw-post-body-paragraph jc jd if je b jf kk jh ji jj kl jl jm jn km jp jq jr kn jt ju jv ko jx jy jz hn dt translated">不仅是分割测试和分析需求；他们也是均衡器。他们可以帮助你的团队消除“河马”或高薪人士的看法。</p><p id="d5dd" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这就是说，尽管有证据表明一个解决方案是强有力的，但薪酬最高的人的意见仍然是最终得到实施的东西……因为他们是这么说的，而且他们赚的比你多。显然，更高的“波段”意味着更高的智力…😜</p><p id="290b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">我更喜欢更科学的方法:<em class="kp">一切都是假设，除非数据显示并非如此。</em> </strong></p><p id="c3fa" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为此，我已经写了很多分测试，而且，我认为很多人真的把事情过分复杂化了。</p><p id="b77b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我想展示使用Redux和Next.js添加自定义SSR分割测试是多么简单。</p><p id="c01b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">在本教程中，我们将从一个空的Node.js项目开始，并通过创建自定义Redux分析中间件，使用Next.js、Redux和无缝分析构建简单的分割测试功能。</strong></p><p id="9fa2" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">这是一举两得。作为对Redux和Next.js的介绍，以及如何使用它们构建一个实际有用的特性。</strong></p><p id="69d3" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对于那些不熟悉这些技术的人来说:</p><p id="cc42" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig"> Redux: </strong> Redux是JavaScript应用的可预测状态容器。它帮助您编写行为一致、在不同环境(客户机、服务器和本机)中运行、易于测试的应用程序。<br/> <strong class="je ig"> React </strong>:用于构建用户界面的JavaScript库<br/> <strong class="je ig"> Next.js: </strong>服务器渲染或静态导出React应用的框架</p><p id="32d8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">注:</strong>这是用next@5写的——用next@6破教程。教程中的概念是重要的部分，可以应用于任何框架或语言。我已经在安装命令中添加了版本号，所以您仍然可以遵循。</p><h1 id="deec" class="kq kr if bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated"><strong class="ak"> 1。我们将从一个全新的Node.js项目</strong>开始</h1><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="2969" class="lx kr if lt b fv ly lz l ma mb">mkdir split-test<br/>cd split-test<br/>echo "node_modules\n.next" | tee .gitignore<br/>npm init</span></pre><h1 id="8f06" class="kq kr if bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">2.<strong class="ak">安装并配置Next.js </strong></h1><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="aad3" class="lx kr if lt b fv ly lz l ma mb">npm install --save next@5 react@16 react-dom@16</span><span id="628e" class="lx kr if lt b fv mc lz l ma mb"># and open up your code editor. I'm using VSCode.<br/>code .</span></pre><p id="b77f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了完成下一步的设置，我们需要将以下内容添加到<code class="eh md me mf lt b">package.json</code></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="7ee8" class="lx kr if lt b fv ly lz l ma mb">"scripts": {<br/> "dev": "next",<br/> "build": "next build",<br/> "start": "next start"<br/>}</span></pre><p id="1607" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，我们需要一个索引页面。从根目录创建一个名为<code class="eh md me mf lt b">pages</code>的文件夹，并在其中创建一个文件<code class="eh md me mf lt b">index.js</code></p><p id="3bbd" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/pages/index.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="7c84" class="lx kr if lt b fv ly lz l ma mb">export default () =&gt; &lt;div&gt;Welcome to next.js!&lt;/div&gt;</span></pre><p id="6b30" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你不熟悉Next.js，它是一个围绕Webpack构建的固执己见的框架。<code class="eh md me mf lt b">pages</code>目录中的一切都是新的<code class="eh md me mf lt b">entrypoint</code>，也就是<code class="eh md me mf lt b">code-split</code>。</p><p id="98e2" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您现在可以使用<code class="eh md me mf lt b">npm run dev</code>运行您的应用程序。默认情况下启用热代码重载。请访问localhost:3000查看您的进度！</p><p id="cd07" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是如果这个页面写着“欢迎来到我的next.js”会转换得更好呢？我们继续吧。</p><h1 id="59b0" class="kq kr if bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated"><strong class="ak"> 3。配置冗余</strong></h1><p id="2d1f" class="pw-post-body-paragraph jc jd if je b jf mg jh ji jj mh jl jm jn mi jp jq jr mj jt ju jv mk jx jy jz hn dt translated">Redux将管理应用程序的状态，包括哪些实验当前是活动的。</p><h2 id="d731" class="lx kr if bd ks ml mm mn kw mo mp mq la jn mr ms le jr mt mu li jv mv mw lm mx dt translated"><strong class="ak">安装Redux </strong></h2><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="aa43" class="lx kr if lt b fv ly lz l ma mb">npm i --save redux@3 react-redux@5 next-redux-wrapper@1</span></pre><p id="4160" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，让我们创建一个初始化Redux的模块。姑且称之为<code class="eh md me mf lt b">initRedux.js</code>，存放在一个新文件夹<code class="eh md me mf lt b">lib</code>。</p><p id="9721" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/lib/initRedux.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="0197" class="lx kr if lt b fv ly lz l ma mb">import {<br/>  createStore,<br/>  combineReducers,<br/>  applyMiddleware,<br/>  compose<br/>} from 'redux'</span><span id="0ea4" class="lx kr if lt b fv mc lz l ma mb">let reducers = {}<br/>let reduxStore = null</span><span id="1d90" class="lx kr if lt b fv mc lz l ma mb">// The following checks if the Redux DevTools extension <br/>// is available in your browser, and activates it if so.<br/>// Otherwise, it executes a no-op function<br/>let devtools = f =&gt; f<br/>if (process.browser &amp;&amp; window.__REDUX_DEVTOOLS_EXTENSION__) {<br/>  devtools = window.__REDUX_DEVTOOLS_EXTENSION__()<br/>}</span><span id="2055" class="lx kr if lt b fv mc lz l ma mb">function create (initialState = {}) {<br/>  return createStore(<br/>    combineReducers({ // Setup reducers<br/>      ...reducers<br/>    }),<br/>    initialState, // Hydrate the store with server-side data<br/>    devtools<br/>  )<br/>}</span><span id="3d67" class="lx kr if lt b fv mc lz l ma mb">export default function initStore (initialState) {<br/>  // Make sure to create a new store for every server-side request so that data<br/>  // isn't shared between connections (which would be bad)<br/>  if (!process.browser) {<br/>    return create(initialState)<br/>  }<br/>  <br/>  // Reuse store on the client-side<br/>  if (!reduxStore) {<br/>    reduxStore = create(initialState)<br/>  }</span><span id="7b31" class="lx kr if lt b fv mc lz l ma mb">  return reduxStore<br/>}</span></pre><p id="4923" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在上面的文件中，我们导出了一个默认函数<code class="eh md me mf lt b">initStore</code>，它将使用提供的<code class="eh md me mf lt b">initialState</code>创建商店。因为Next.js是<strong class="je ig">同构的</strong>，这意味着代码将在客户端和服务器端运行。在<code class="eh md me mf lt b">initStore</code>中，我们还检查该进程是否正在浏览器中运行。如果是，我们可以重用在服务器上创建的<code class="eh md me mf lt b">reduxStore</code>。</p><p id="75f4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">无论哪种情况，接下来都会调用<code class="eh md me mf lt b">create</code>。这用我们的reducers、initialState和Redux DevTools创建了一个新的redux store，用于更好的开发实验。</p><h2 id="247c" class="lx kr if bd ks ml mm mn kw mo mp mq la jn mr ms le jr mt mu li jv mv mw lm mx dt translated">接下来，让我们将Redux“连接”到我们的索引页面。</h2><p id="8454" class="pw-post-body-paragraph jc jd if je b jf mg jh ji jj mh jl jm jn mi jp jq jr mj jt ju jv mk jx jy jz hn dt translated"><strong class="je ig">。/pages/index.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="f0db" class="lx kr if lt b fv ly lz l ma mb">import initStore from '../lib/initRedux'<br/>import withRedux from 'next-redux-wrapper'</span><span id="76a7" class="lx kr if lt b fv mc lz l ma mb">const Index = () =&gt; &lt;div&gt;Welcome to next.js!&lt;/div&gt;</span><span id="8633" class="lx kr if lt b fv mc lz l ma mb">const mapStateToProps = () =&gt; ({})<br/>const mapDispatchToProps = () =&gt; ({})</span><span id="36ba" class="lx kr if lt b fv mc lz l ma mb">export default withRedux(initStore, mapStateToProps, mapDispatchToProps)(Index)</span></pre><p id="ba71" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们通过用<code class="eh md me mf lt b">withRedux</code>包装组件来修改<code class="eh md me mf lt b">./pages/index.js</code>。<code class="eh md me mf lt b">withRedux</code>接受一个返回redux store的函数作为它的第一个参数，并接受两个额外的函数返回一个对组件可用的<code class="eh md me mf lt b">props</code>对象。我们将很快填写这些内容。目前，我们已经成功连接了Redux。访问localhost:3000，将显示<a class="ae my" href="http://extension.remotedev.io/" rel="noopener ugc nofollow" target="_blank"> Redux DevTools chrome扩展</a>已启用。如果您还没有安装它，请安装它。</p><h1 id="3561" class="kq kr if bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">4.实验缩减器</h1><p id="1bbe" class="pw-post-body-paragraph jc jd if je b jf mg jh ji jj mh jl jm jn mi jp jq jr mj jt ju jv mk jx jy jz hn dt translated">Reducers是存储应用程序逻辑的地方。动作进来，reducer决定这个动作如何改变状态。</p><p id="fdfc" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们先在lib中新建一些文件夹，分别叫做<code class="eh md me mf lt b">redux</code>和<code class="eh md me mf lt b">redux/reducers</code>，在新建的<code class="eh md me mf lt b">reducers</code>文件夹中定义一个文件<code class="eh md me mf lt b">experiments.js</code>。</p><p id="917f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/lib/redux/reducers/experiments . js</strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="2ab3" class="lx kr if lt b fv ly lz l ma mb">export default (state = {<br/>  active: {}<br/>}, { type, payload }) =&gt; {<br/>  switch (type) {<br/>    case 'START_EXPERIMENT':<br/>      let { name, variant } = payload<br/>      let active = Object.assign({}, state.active)<br/>      active[name] = variant<br/>      return {<br/>        active<br/>      }<br/>    default:<br/>      return state<br/>  }<br/>}</span><span id="438b" class="lx kr if lt b fv mc lz l ma mb">export function startExperiment ({name, variant}) {<br/>  return {<br/>    type: 'START_EXPERIMENT',<br/>    payload: {<br/>      name,<br/>      variant<br/>    }<br/>  }<br/>}</span></pre><p id="a7e0" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们的整个缩减器非常简单——它导出一个初始状态为<code class="eh md me mf lt b">{ active: {} }</code>的缩减器。我们的应用程序真正需要知道的是哪些实验是活动的，所以这就足够了。</p><p id="460f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，我们为缩减器的<code class="eh md me mf lt b">switch</code>语句定义了一个<code class="eh md me mf lt b">case 'START_EXPERIMENT'</code>。这将为我们用实验的<strong class="je ig">名称</strong>定义的<code class="eh md me mf lt b">active</code>状态添加一个新的键，该值将是活动的<strong class="je ig">变量</strong>。</p><p id="0d70" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最后，我们导出一个<em class="kp">动作</em> <code class="eh md me mf lt b">startExperiment</code>。这需要一个配置对象，并期望一个实验<code class="eh md me mf lt b">name</code>，以及哪个<code class="eh md me mf lt b">variant</code>是活动的。</p><p id="6ea8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/lib/redux/reducers/index . js</strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="147d" class="lx kr if lt b fv ly lz l ma mb">import experiments from './experiments'</span><span id="6b64" class="lx kr if lt b fv mc lz l ma mb">export default {<br/>  experiments<br/>}</span></pre><p id="5179" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">每当我们有新的减速器时，我们都可以将其添加到此导出中。我们只需要把它连接起来。</p><p id="3300" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/lib/initRedux.js </strong></p><p id="1854" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在<code class="eh md me mf lt b">./lib/initRedux.js</code>中更换管路:</p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="de0b" class="lx kr if lt b fv ly lz l ma mb">let reducers = {}</span></pre><p id="8344" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用:</p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="4ba6" class="lx kr if lt b fv ly lz l ma mb">import reducers from './redux/reducers'</span></pre><p id="7b5e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig"> Redux现在与我们的减速器“连接”在一起。</strong></p><p id="1d4b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，我们需要利用Next.js的<code class="eh md me mf lt b">getInitialProps</code>在服务器端开始实验。</p><h1 id="cffb" class="kq kr if bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">5.<code class="eh md me mf lt b">dispatch</code>来自<code class="eh md me mf lt b">getInitialProps</code></h1><p id="22cb" class="pw-post-body-paragraph jc jd if je b jf mg jh ji jj mh jl jm jn mi jp jq jr mj jt ju jv mk jx jy jz hn dt translated">在<code class="eh md me mf lt b">const Index = ...</code>行下面，我们来添加一个<code class="eh md me mf lt b">getInitialProps</code>函数。当我们使用<code class="eh md me mf lt b">withRedux</code>包装我们的组件时，这使得Redux <code class="eh md me mf lt b">store</code>在传递给<code class="eh md me mf lt b">getInitialProps</code>的上下文对象中是可访问的。我们需要调用我们在reducer中定义的动作，所以也在顶部导入它。</p><p id="83b1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/pages/index.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="b283" class="lx kr if lt b fv ly lz l ma mb">import { startExperiment } from '../lib/redux/reducers/experiments'</span><span id="df71" class="lx kr if lt b fv mc lz l ma mb">// ...</span><span id="e9bf" class="lx kr if lt b fv mc lz l ma mb">/* context: {req, res, query, isServer, store} */<br/>Index.getInitialProps = ({store}) =&gt; {<br/>  const dispatchStartExperiment = ({name, variant}) =&gt; {<br/>    store.dispatch(startExperiment({<br/>      name,<br/>      variant<br/>    }))<br/>  }<br/>}</span><span id="7486" class="lx kr if lt b fv mc lz l ma mb">// ...</span></pre><p id="01e9" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">好了，我们已经定义了一个函数来分派一个<code class="eh md me mf lt b">startExperiment</code>动作，并接受实验<strong class="je ig">名称</strong>和<strong class="je ig">变量</strong>作为参数。</p><p id="7766" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来我们需要实验。我们自然会用JavaScript来实现。</p><h1 id="e150" class="kq kr if bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated"><strong class="ak"> 6。创建新实验()</strong></h1><p id="638e" class="pw-post-body-paragraph jc jd if je b jf mg jh ji jj mh jl jm jn mi jp jq jr mj jt ju jv mk jx jy jz hn dt translated">我们将创建一个实验类，扩展<code class="eh md me mf lt b">EventEmitter</code>作为一种简单的方法来挂钩每个实验的状态变化。</p><p id="29e5" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先是实验班。</p><p id="0d9a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在其中，一个给定变量列表和id的<code class="eh md me mf lt b">selectVariant</code>算法将总是选择相同的变量。也就是说，要确保用户总是得到相同的实验，你需要做的就是传入相同的id。您可以通过在cookie中存储他们的userId或其散列来做到这一点。这个算法是我从<a class="ae my" href="https://github.com/pushtell/react-ab-test/blob/master/src/Experiment.jsx#L51" rel="noopener ugc nofollow" target="_blank"> react-ab-test </a>借来的。</p><p id="1394" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我认为使用React组件来维护实验的状态过于复杂，redux更适合这项任务，但“支持”算法<a class="mz na gr" href="https://medium.com/u/1b78fc47a4ad?source=post_page-----5392799c15c7--------------------------------" rel="noopener" target="_blank"> John Wehr </a>。👏</p><p id="46b9" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/lib/experience . js</strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="f6a1" class="lx kr if lt b fv ly lz l ma mb">import { EventEmitter } from 'events'<br/>import crc32 from 'fbjs/lib/crc32'</span><span id="288c" class="lx kr if lt b fv mc lz l ma mb">export default class Experiment extends EventEmitter {<br/>  constructor ({<br/>    name,<br/>    variants,<br/>    userId<br/>  }) {<br/>    super()<br/>    this.name = name<br/>    this.variants = variants<br/>    this.userId = userId<br/>  }</span><span id="e9b1" class="lx kr if lt b fv mc lz l ma mb">selectVariant (userId) {</span><span id="b471" class="lx kr if lt b fv mc lz l ma mb">    /*<br/>    Choosing a weighted variant:<br/>      For C, A, B with weights 2, 4, 8<br/>      variants = A, B, C<br/>      weights = 4, 8, 2<br/>      weightSum = 14<br/>      weightedIndex = 9<br/>      AAAABBBBBBBBCC<br/>      ========^<br/>      Select B<br/>    */</span><span id="1565" class="lx kr if lt b fv mc lz l ma mb">    // Sorted array of the variant names, example: ["A", "B", "C"]<br/>    const variants = Object.keys(this.variants).sort()</span><span id="c0a8" class="lx kr if lt b fv mc lz l ma mb">    // Array of the variant weights, also sorted by variant name. For example, if<br/>    // variant C had weight 2, variant A had weight 4, and variant B had weight 8<br/>    // return [4, 8, 2] to correspond with ["A", "B", "C"]<br/>    const weights = variants.reduce((weights, variant) =&gt; {<br/>      weights.push(this.variants[variant].weight)<br/>      return weights<br/>    }, [])</span><span id="6d1e" class="lx kr if lt b fv mc lz l ma mb">    // Sum the weights<br/>    const weightSum = weights.reduce((a, b) =&gt; {<br/>      return a + b<br/>    }, 0)</span><span id="bf3a" class="lx kr if lt b fv mc lz l ma mb">    // A random number between 0 and weightSum<br/>    let weightedIndex = typeof userId === 'string' ? Math.abs(crc32(userId) % weightSum) : Math.floor(Math.random() * weightSum)</span><span id="fff6" class="lx kr if lt b fv mc lz l ma mb">    // Iterate through the sorted weights, and deduct each from the weightedIndex.<br/>    // If weightedIndex drops &lt; 0, select the variant. If weightedIndex does not<br/>    // drop &lt; 0, default to the last variant in the array that is initially assigned.<br/>    let selectedVariant = variants[variants.length - 1]<br/>    for (let index = 0; index &lt; weights.length; index++) {<br/>      weightedIndex -= weights[index]<br/>      if (weightedIndex &lt; 0) {<br/>        selectedVariant = variants[index]<br/>        break<br/>      }<br/>    }</span><span id="8df3" class="lx kr if lt b fv mc lz l ma mb">    return selectedVariant<br/>  }</span><span id="f2af" class="lx kr if lt b fv mc lz l ma mb">  start ({ userId }) {<br/>    userId = userId || this.userId<br/>    let variant = this.selectVariant(userId)<br/>    this.emit('variant.selected', { name: this.name, variant })<br/>  }<br/>}</span></pre><p id="86fa" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们用它来做一个实验！</p><p id="a5cd" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/experiments/headerText.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="20de" class="lx kr if lt b fv ly lz l ma mb">import Experiment from '../lib/Experiment'</span><span id="7684" class="lx kr if lt b fv mc lz l ma mb">const headerTextExperiment = new Experiment({<br/>  name: 'Header Text',<br/>  variants: {<br/>    control: {<br/>      weight: 50,<br/>      displayName: 'control'<br/>    },<br/>    mine: {<br/>      weight: 50,<br/>      displayName: 'mine'<br/>    }<br/>  }<br/>})</span><span id="8aba" class="lx kr if lt b fv mc lz l ma mb">export default headerTextExperiment</span></pre><p id="4afe" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我们定义的实验类中，我们只需要传入一个带有一些初始化选项的对象:1)实验的名称，以及2)变量及其各自的权重。在本例中，我们有两种变体，对半分割。</p><h1 id="18f5" class="kq kr if bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">7.激活实验</h1><p id="1290" class="pw-post-body-paragraph jc jd if je b jf mg jh ji jj mh jl jm jn mi jp jq jr mj jt ju jv mk jx jy jz hn dt translated">我们想激活<strong class="je ig">上的实验。/pages/index.js，</strong>所以让我们导入它，并在getInitialProps中激活它。正如我前面提到的，如果userId存在，我们将希望传入一个userId，所以为了演示起见，我们假设它在cookies中是可用的。</p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="f2e5" class="lx kr if lt b fv ly lz l ma mb">npm install --save next-cookies@1</span></pre><p id="5885" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/pages/index.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="87ab" class="lx kr if lt b fv ly lz l ma mb">import initStore from '../lib/initRedux'<br/>import withRedux from 'next-redux-wrapper'<br/>import { startExperiment } from '../lib/redux/reducers/experiments'<br/><strong class="lt ig">import headerTextExperiment from '../experiments/headerText'<br/>import cookies from 'next-cookies'</strong></span><span id="1155" class="lx kr if lt b fv mc lz l ma mb"><strong class="lt ig">const Index = ({experiments}) =&gt; (<br/>  &lt;div&gt;<br/>    { experiments.active[headerTextExperiment.name] === 'control' ? "Welcome to Next.js!" : null }<br/>    { experiments.active[headerTextExperiment.name] === 'mine' ? "Welcome to MY Next.js!" : null }<br/>  &lt;/div&gt;<br/>)</strong></span><span id="1f49" class="lx kr if lt b fv mc lz l ma mb">/* context: {req, res, query, isServer, store} */<br/><strong class="lt ig">Index.getInitialProps = (ctx) =&gt; {<br/>  const { store } = ctx</strong><br/>  const dispatchStartExperiment = ({name, variant}) =&gt; {<br/>    console.log('starting experiment')<br/>    store.dispatch(startExperiment({<br/>      name,<br/>      variant<br/>    }))<br/>  }</span><span id="8bd9" class="lx kr if lt b fv mc lz l ma mb">  <strong class="lt ig">const activeExperiments = [<br/>    headerTextExperiment<br/>  ]</strong></span><span id="2f76" class="lx kr if lt b fv mc lz l ma mb"><strong class="lt ig">  headerTextExperiment.once('variant.selected', dispatchStartExperiment)</strong></span><span id="c898" class="lx kr if lt b fv mc lz l ma mb"><strong class="lt ig">  let { userId } = cookies(ctx)<br/>  activeExperiments.forEach((experiment) =&gt; {<br/>    experiment.start({userId})<br/>  })</strong><br/>}</span><span id="2f97" class="lx kr if lt b fv mc lz l ma mb"><strong class="lt ig">const mapStateToProps = ({ experiments }) =&gt; ({<br/>  experiments<br/>})</strong><br/>const mapDispatchToProps = () =&gt; ({})</span><span id="54c9" class="lx kr if lt b fv mc lz l ma mb">export default withRedux(initStore, mapStateToProps, mapDispatchToProps)(Index)</span></pre><p id="962f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了清楚起见，我用粗体字标出了变化。首先，我们导入<code class="eh md me mf lt b">headerTextExperiment</code>和<code class="eh md me mf lt b">cookies</code>。<code class="eh md me mf lt b">cookies</code>需要next的上下文对象，所以快速重构getInitialProps以在顶部暴露它。然后，我们创建一个要激活的实验数组，并使用forEach来启动每个实验，如果可用的话，传入一个<code class="eh md me mf lt b">userId</code>。</p><p id="fc56" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">实验启动后，会选择一个变量，并发出一个事件:<code class="eh md me mf lt b">'variant.selected'</code>。当发生这种情况时，我们将向redux发送一个动作，该动作将更新全局状态。当状态改变时，<code class="eh md me mf lt b">mapStateToProps</code>将被触发，让我们的组件通过它的<code class="eh md me mf lt b">props</code>访问正在进行的实验。</p><p id="7a4d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果实验的变体“control”是活动的，我们显示原始文本，如果变体“mine”是活动的，我们显示替代文本。</p><h1 id="f32a" class="kq kr if bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">8.使用分析中间件跟踪事件</h1><p id="5d4a" class="pw-post-body-paragraph jc jd if je b jf mg jh ji jj mh jl jm jn mi jp jq jr mj jt ju jv mk jx jy jz hn dt translated">因为我们使用redux来改变我们的应用程序的状态，所以我们可以挂钩到它，并在redux动作发生时发出分析事件。为此，我们将创建一个定制的分析中间件。我将展示如何与google analytics以及facebook analytics集成。你可以用你的想象力进行其他的整合。我特别喜欢Mixpanel的这种类型的分析。</p><p id="b051" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/lib/analytics.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="fd91" class="lx kr if lt b fv ly lz l ma mb">export const track = ({event, value}) =&gt; {<br/>  console.log('track', event, {<br/>    value<br/>  })</span><span id="b9ef" class="lx kr if lt b fv mc lz l ma mb">  if (process.browser) {<br/>    window.ga &amp;&amp; window.ga('send', 'event', {<br/>      eventCategory: event,<br/>      eventLabel: value<br/>    })<br/>    window.fbq &amp;&amp; window.fbq('track', event, {<br/>      value<br/>    })<br/>  }<br/>}</span></pre><p id="1057" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/lib/redux/middleware/analytics . js</strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="8c60" class="lx kr if lt b fv ly lz l ma mb">import { track } from '../../analytics'</span><span id="b5ec" class="lx kr if lt b fv mc lz l ma mb">export default ({ dispatch, getState }) =&gt; next =&gt; action =&gt; {<br/>  const {<br/>    analytics<br/>  } = action.meta || {}</span><span id="27b2" class="lx kr if lt b fv mc lz l ma mb">next(action)</span><span id="e102" class="lx kr if lt b fv mc lz l ma mb">if (analytics) {<br/>    track(analytics)<br/>  }<br/>}</span></pre><p id="4f39" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/lib/initRedux.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="d0cb" class="lx kr if lt b fv ly lz l ma mb"><strong class="lt ig">import analyticsMiddleware from './redux/middleware/analytics'</strong></span><span id="0112" class="lx kr if lt b fv mc lz l ma mb">// ...</span><span id="2c75" class="lx kr if lt b fv mc lz l ma mb">function create (initialState = {}) {<br/>  return createStore(<br/>    combineReducers({ // Setup reducers<br/>      ...reducers<br/>    }),<br/>    initialState, // Hydrate the store with server-side data<br/>    <strong class="lt ig">compose(<br/>      applyMiddleware(<br/>        analyticsMiddleware<br/>      ),<br/>      devtools<br/>    )</strong><br/>  )<br/>}</span></pre><p id="8de7" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们使用<code class="eh md me mf lt b">compose</code>和<code class="eh md me mf lt b">applyMiddleware</code>是为了使用多个中间件以及Redux DevTools。</p><p id="d112" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在我们可以简单地在redux动作中添加一个<code class="eh md me mf lt b">meta</code>键，以便在它们发生时跟踪它们。</p><p id="ee93" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/lib/redux/reducers/experiments . js</strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="32c1" class="lx kr if lt b fv ly lz l ma mb">// ...</span><span id="949b" class="lx kr if lt b fv mc lz l ma mb">export function startExperiment ({name, variant}) {<br/>  return {<br/>    type: 'START_EXPERIMENT',<br/>    payload: {<br/>      name,<br/>      variant<br/>    }<strong class="lt ig">,</strong><br/>    <strong class="lt ig">meta: {<br/>      analytics: {<br/>        event: `${name} Experiment Played`,<br/>        value: variant<br/>      }<br/>    }</strong><br/>  }<br/>}</span></pre><p id="d6c8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，每次调度startExperiment时，一个事件“NAME Experiment Played”将被发送到您的具有所选变体的分析端点。</p><h1 id="be77" class="kq kr if bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">9.跟踪其他事件</h1><p id="5ecd" class="pw-post-body-paragraph jc jd if je b jf mg jh ji jj mh jl jm jn mi jp jq jr mj jt ju jv mk jx jy jz hn dt translated">但是，按照设计，此操作不会在客户端发生。只有服务器。</p><p id="5fd0" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们添加一个特殊的异常，以便在组件装载到客户机上时也跟踪这个事件，因为我们需要这个数据。有很多很好的理由需要在服务器和客户端进行分析。例如，查看有多少人请求了一个页面，但是在它加载之前因为某种原因而放弃了。</p><p id="c043" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们需要一些生命周期事件，所以这导致了一些重构，以使Index extend React的组件，以及将getInitialProps移入其中。</p><p id="09ce" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/pages/index.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="f67c" class="lx kr if lt b fv ly lz l ma mb">// ...<br/><strong class="lt ig">import { Component } from 'react'<br/>import { track } from '../lib/analytics'</strong></span><span id="65f4" class="lx kr if lt b fv mc lz l ma mb"><strong class="lt ig">class Index extends Component {<br/>  static getInitialProps (ctx) {</strong><br/>    /* ctx: {req, res, query, isServer, store} */<br/>    const { store } = ctx<br/>    const dispatchStartExperiment = ({name, variant}) =&gt; {<br/>      store.dispatch(startExperiment({<br/>        name,<br/>        variant<br/>      }))<br/>    }</span><span id="50ac" class="lx kr if lt b fv mc lz l ma mb">    const activeExperiments = [<br/>      headerTextExperiment<br/>    ]<br/>  <br/>    headerTextExperiment.once('variant.selected', dispatchStartExperiment)<br/>  <br/>    let { userId } = cookies(ctx)<br/>    activeExperiments.forEach((experiment) =&gt; {<br/>      experiment.start({userId})<br/>    })<br/>  <strong class="lt ig">}</strong></span><span id="0fc6" class="lx kr if lt b fv mc lz l ma mb">  <strong class="lt ig">componentDidMount () {<br/>    const { experiments } = this.props</strong></span><span id="7ca6" class="lx kr if lt b fv mc lz l ma mb"><strong class="lt ig">    if (experiments.active[headerTextExperiment.name]) {<br/>      // startExperiment just returns the redux action object<br/>      // we can make use of this to look up the analytics<br/>      // event name and value<br/>      let analytics = startExperiment({<br/>        name: headerTextExperiment.name,<br/>        variant: experiments.active[headerTextExperiment.name]<br/>      }).meta.analytics<br/>      track({<br/>        event: analytics.event, <br/>        value: analytics.value<br/>      })<br/>    }<br/>  }</strong></span><span id="e593" class="lx kr if lt b fv mc lz l ma mb">  <strong class="lt ig">render () {<br/>    const { experiments } = this.props<br/>    return </strong>(<br/>      &lt;div&gt;<br/>        { experiments.active[headerTextExperiment.name] === 'control' ? "Welcome to Next.js!" : null }<br/>        { experiments.active[headerTextExperiment.name] === 'mine' ? "Welcome to MY Next.js!" : null }<br/>      &lt;/div&gt;<br/>    )<br/>  <strong class="lt ig">}</strong><br/><strong class="lt ig">}</strong></span><span id="1d63" class="lx kr if lt b fv mc lz l ma mb">// ...</span></pre><p id="efa4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">新的<code class="eh md me mf lt b">componentDidMount</code>功能只在客户端运行。如果一个实验是活动的，我们只是从redux动作对象中用相同的值调用<code class="eh md me mf lt b">track</code>。</p><h1 id="151b" class="kq kr if bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">10.包括第三方分析库</h1><p id="4271" class="pw-post-body-paragraph jc jd if je b jf mg jh ji jj mh jl jm jn mi jp jq jr mj jt ju jv mk jx jy jz hn dt translated">我们可以简单地从任何提供的snippet的<code class="eh md me mf lt b">&lt;script&gt;</code>标签中提取javascript，并将它们存储为纯js。接下来，我们将利用React的<code class="eh md me mf lt b">dangerouslySetInnerHTML</code> API使用<code class="eh md me mf lt b">next/head</code>来插入它们。</p><p id="d1f0" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/pages/index.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="0e05" class="lx kr if lt b fv ly lz l ma mb"><strong class="lt ig">import ga from '../lib/analytics/ga'<br/>import fb from '../lib/analytics/fb'<br/>import Head from 'next/head'</strong></span><span id="62a2" class="lx kr if lt b fv mc lz l ma mb">class Index extends Component {<br/>  // ...</span><span id="8257" class="lx kr if lt b fv mc lz l ma mb">  render () {<br/>    const { experiments } = this.props<br/>    return (<br/>      &lt;div&gt;<br/>        <strong class="lt ig">&lt;Head&gt;<br/>          &lt;title&gt;SSR Split Tests&lt;/title&gt;<br/>          &lt;meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" /&gt;<br/>          &lt;script dangerouslySetInnerHTML={{__html: ga}} /&gt;<br/>          &lt;script dangerouslySetInnerHTML={{__html: fb}} /&gt;<br/>        &lt;/Head&gt;</strong><br/>        { experiments.active[headerTextExperiment.name] === 'control' ? "Welcome to Next.js!" : null }<br/>        { experiments.active[headerTextExperiment.name] === 'mine' ? "Welcome to MY Next.js!" : null }<br/>      &lt;/div&gt;<br/>    )<br/>  }<br/>}</span><span id="ce21" class="lx kr if lt b fv mc lz l ma mb">// ...</span></pre><p id="06ad" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/lib/analytics/fb.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="566d" class="lx kr if lt b fv ly lz l ma mb">export default `<br/>if(typeof fbq === 'undefined') {<br/>  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?<br/>  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;<br/>  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;<br/>  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,<br/>  document,'script','<a class="ae my" href="https://connect.facebook.net/en_US/fbevents.js'" rel="noopener ugc nofollow" target="_blank">https://connect.facebook.net/en_US/fbevents.js'</a>);<br/>  fbq('init', '<strong class="lt ig">YOUR FB ID GOES HERE</strong>');<br/>  fbq('track', 'PageView');<br/>} else {<br/>  fbq('track', 'PageView');<br/>}<br/>`</span></pre><p id="6957" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/lib/analytics/ga.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="e10d" class="lx kr if lt b fv ly lz l ma mb">export default `<br/>  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){<br/>  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),<br/>  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)<br/>  })(window,document,'script','<a class="ae my" href="https://www.google-analytics.com/analytics.js','ga'" rel="noopener ugc nofollow" target="_blank">https://www.google-analytics.com/analytics.js','ga'</a>);<br/>  ga('create', '<strong class="lt ig">YOUR GA ID GOES HERE</strong>', 'auto');<br/>  ga('send', 'pageview');<br/>`</span></pre><h1 id="516b" class="kq kr if bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">11.如果有目标，会有帮助</h1><p id="51f3" class="pw-post-body-paragraph jc jd if je b jf mg jh ji jj mh jl jm jn mi jp jq jr mj jt ju jv mk jx jy jz hn dt translated">此外，我们需要一个目标。现在，我们只知道一个实验何时被观看。</p><p id="227e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我最初为一个登录页面做了所有这些，所以让我们继续这个例子。所以我们这个页面的目标是让用户输入他们的电子邮件地址并提交它！</p><p id="1a34" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当这种情况发生时，我们希望将他们的电子邮件存储在我们的redux store中，并说声谢谢。这也展示了未接触的<code class="eh md me mf lt b">mapDispatchToProps</code>和使用多个减速器。</p><p id="ca2d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">似乎我们是如何跟踪<strong class="je ig">线索</strong>的，让我们做一个<code class="eh md me mf lt b">lead</code>减速器。</p><p id="0a6e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/lib/redux/reducers/lead . js</strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="a681" class="lx kr if lt b fv ly lz l ma mb">export default (state = {<br/>  email: null<br/>}, { type, payload }) =&gt; {<br/>  switch (type) {<br/>    case 'SIGNUP_LEAD':<br/>      let { email } = payload<br/>      return {<br/>        ...state,<br/>        email<br/>      }<br/>    default:<br/>      return state<br/>  }<br/>}</span><span id="5f34" class="lx kr if lt b fv mc lz l ma mb">export function signupLead ({email}) {<br/>  return {<br/>    type: 'SIGNUP_LEAD',<br/>    payload: {<br/>      email<br/>    },<br/>    meta: {<br/>      analytics: {<br/>        event: `Signed Up`,<br/>        value: email<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="f484" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/lib/redux/reducers/index . js</strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="be70" class="lx kr if lt b fv ly lz l ma mb">import experiments from './experiments'<br/>import lead from './lead'</span><span id="76be" class="lx kr if lt b fv mc lz l ma mb">export default {<br/>  experiments,<br/>  lead<br/>}</span></pre><p id="6582" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，我们需要一个新的组件来包含注册表单，并显示在索引页面上。</p><p id="ac80" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/components/SignUpForm.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="3999" class="lx kr if lt b fv ly lz l ma mb">export default function SignUpForm () {<br/>  function submit(e) {<br/>    e.preventDefault()<br/>    let email = e.target.elements.email.value<br/>    if (email) {<br/>      alert(email)<br/>    } else {<br/>      alert("Email is Required")<br/>    }<br/>  }<br/>  return (<br/>    &lt;form onSubmit={submit}&gt;<br/>      &lt;input name="email" type="email" placeholder="Enter your email..." /&gt;<br/>      &lt;button&gt;Submit&lt;/button&gt;<br/>    &lt;/form&gt;<br/>  )<br/>}</span></pre><p id="0aad" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/pages/index.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="a2d5" class="lx kr if lt b fv ly lz l ma mb"><strong class="lt ig">import SignUpForm from '../components/SignUpForm'</strong></span><span id="708c" class="lx kr if lt b fv mc lz l ma mb">// ...  <br/>  render () {<br/>    const { experiments } = this.props<br/>    return (<br/>      &lt;div&gt;<br/>        &lt;Head&gt;<br/>          &lt;title&gt;SSR Split Tests&lt;/title&gt;<br/>          &lt;meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" /&gt;<br/>          &lt;script dangerouslySetInnerHTML={{__html: ga}} /&gt;<br/>          &lt;script dangerouslySetInnerHTML={{__html: fb}} /&gt;<br/>        &lt;/Head&gt;<br/>        { experiments.active[headerTextExperiment.name] === 'control' ? &lt;h1&gt;Welcome to Next.js!&lt;/h1&gt; : null }<br/>        { experiments.active[headerTextExperiment.name] === 'mine' ? &lt;h1&gt;Welcome to MY Next.js!&lt;/h1&gt; : null }<br/>        <strong class="lt ig">&lt;SignUpForm/&gt;</strong><br/>      &lt;/div&gt;<br/>    )<br/>  }<br/>// ...</span></pre><h1 id="c1fe" class="kq kr if bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">12.将redux连接到表单</h1><p id="ec1d" class="pw-post-body-paragraph jc jd if je b jf mg jh ji jj mh jl jm jn mi jp jq jr mj jt ju jv mk jx jy jz hn dt translated">我们的表单需要访问我们定义的redux动作，以及来自我们存储的<code class="eh md me mf lt b">lead</code>状态。我们可以使用<code class="eh md me mf lt b">mapDispatchToProps</code>和<code class="eh md me mf lt b">mapStateToProps</code>来提供访问。</p><p id="9785" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/pages/index.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="3393" class="lx kr if lt b fv ly lz l ma mb">// ...<br/><strong class="lt ig">import { signupLead}  from '../lib/redux/reducers/lead'</strong></span><span id="4c82" class="lx kr if lt b fv mc lz l ma mb">class Index extends Component {<br/>  // ...</span><span id="1000" class="lx kr if lt b fv mc lz l ma mb">  render () {<br/>    const { experiments<strong class="lt ig">, lead, signupLead</strong> } = this.props<br/>    return (<br/>      &lt;div&gt;<br/>        &lt;Head&gt;<br/>          &lt;title&gt;SSR Split Tests&lt;/title&gt;<br/>          &lt;meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" /&gt;<br/>          &lt;script dangerouslySetInnerHTML={{__html: ga}} /&gt;<br/>          &lt;script dangerouslySetInnerHTML={{__html: fb}} /&gt;<br/>        &lt;/Head&gt;<br/>        { experiments.active[headerTextExperiment.name] === 'control' ? &lt;h1&gt;Welcome to Next.js!&lt;/h1&gt; : null }<br/>        { experiments.active[headerTextExperiment.name] === 'mine' ? &lt;h1&gt;Welcome to MY Next.js!&lt;/h1&gt; : null }<br/><strong class="lt ig">        &lt;SignUpForm lead={lead} signup={signupLead}/&gt;<br/></strong>      &lt;/div&gt;<br/>    )<br/>  }<br/>}</span><span id="14e4" class="lx kr if lt b fv mc lz l ma mb">const mapStateToProps = ({ experiments<strong class="lt ig">, lead</strong> }) =&gt; ({<br/>  experiments,<br/>  <strong class="lt ig">lead</strong><br/>})<br/><strong class="lt ig">const mapDispatchToProps = (dispatch, ownProps) =&gt; ({<br/>  signupLead: ({email}) =&gt; {<br/>    dispatch(signupLead({email}))<br/>  }<br/>})</strong></span><span id="7086" class="lx kr if lt b fv mc lz l ma mb">// ...</span></pre><p id="f495" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在上面的例子中，我们只是简单地导入新动作，然后用<code class="eh md me mf lt b">mapDispatchToProps</code>中的<code class="eh md me mf lt b">dispatch</code>将它映射到道具。我们还修改了<code class="eh md me mf lt b">mapStateToProps</code>来访问<code class="eh md me mf lt b">lead</code>状态。</p><p id="48ab" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最后，让我们使用新的道具来完成表格！</p><p id="997b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">。/components/SignUpForm.js </strong></p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="a591" class="lx kr if lt b fv ly lz l ma mb">export default function SignUpForm (<strong class="lt ig">{lead, signup}</strong>) {<br/>  function submit(e) {<br/>    e.preventDefault()<br/>    let email = e.target.elements.email.value<br/>    if (email) {<br/>      <strong class="lt ig">signup({email})</strong><br/>    } else {<br/>      alert("Email is Required")<br/>    }<br/>  }<br/>  return (<br/>    &lt;div&gt;<br/>      <strong class="lt ig">{typeof lead.email === 'string' &amp;&amp; lead.email.length &gt; 0 ? <br/>      &lt;p&gt;Hello {lead.email}&lt;/p&gt;<br/>      :<br/>      &lt;form onSubmit={submit}&gt;<br/>        &lt;input name="email" type="email" placeholder="Enter your email..." /&gt;<br/>        &lt;button&gt;Submit&lt;/button&gt;<br/>      &lt;/form&gt;<br/>      }</strong><br/>    &lt;/div&gt;<br/>  )<br/>}</span></pre><p id="2019" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，当按下submit时，输入框将切换到say <code class="eh md me mf lt b">Hello {lead.email}</code>并以email为值跟踪事件“已注册”。</p><p id="964f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，在您的漏斗分析中，您可以进行两个查询:</p><ol class=""><li id="bae7" class="nb nc if je b jf jg jj jk jn nd jr ne jv nf jz ng nh ni nj dt translated">从值为“控制”的“标题文本试验播放”开始</li><li id="ba7a" class="nb nc if je b jf nk jj nl jn nm jr nn jv no jz ng nh ni nj dt translated">从值为“mine”的“标题文本试验播放”开始</li></ol><p id="c02b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您将能够很容易地看到通过每个实验的每个步骤的用户的百分比。</p><h1 id="9708" class="kq kr if bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">结论🎉</h1><p id="9f0c" class="pw-post-body-paragraph jc jd if je b jf mg jh ji jj mh jl jm jn mi jp jq jr mj jt ju jv mk jx jy jz hn dt translated">现在你有了，SSR分裂测试(大部分)自动分析(只要你继续使用redux)！</p><p id="fe2a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">感谢阅读！下次见！如果你觉得这有用，请鼓掌并分享，因为它将帮助我接触到更多的人！:)</p><p id="4beb" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你可以在GitHub库中找到所有的代码。请随意使用它作为样板！</p><p id="5351" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">帕特里克·斯科特</p><p id="3d13" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt">—</p><blockquote class="ka"><p id="8cdf" class="kb kc if bd kd ke kf kg kh ki kj jz ek translated">没有无用的AWS认证，有兴趣听听我的DevOps之旅吗？ <a class="ae my" href="https://hackernoon.com/my-journey-to-achieving-devops-bliss-without-useless-aws-certifications-a7cbf7c539d1" rel="noopener ugc nofollow" target="_blank"> <em class="np">现在就在HackerNoon </em> </a> <em class="np">上看。</em></p></blockquote><p id="460e" class="pw-post-body-paragraph jc jd if je b jf kk jh ji jj kl jl jm jn km jp jq jr kn jt ju jv ko jx jy jz hn dt translated"><strong class="je ig">我有空咨询——在</strong> <a class="ae my" href="https://twitter.com/pat_scott" rel="noopener ugc nofollow" target="_blank"> <strong class="je ig"> Twitter </strong> </a> <strong class="je ig">或</strong><a class="ae my" href="https://www.linkedin.com/in/patricklscott/" rel="noopener ugc nofollow" target="_blank"><strong class="je ig">LinkedIn</strong></a><strong class="je ig">上给我发消息。请提及你看到了我的文章！不要害羞！</strong></p><p id="4c0e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="kp">想了解如何使用微服务构建自定义分析后端吗？在我即将开始的课程“</em> <a class="ae my" href="http://www.microservicedriven.com/get-access" rel="noopener ugc nofollow" target="_blank"> <em class="kp">微服务驱动</em> </a> <em class="kp">”中，我就是这么做的。从</em> <strong class="je ig"> <em class="kp">这个</em> </strong> <em class="kp">例子开始，你将学习如何构建一个用于跟踪分析和线索的微服务后端，并使用Docker Swarm在生产中运行它。</em> <a class="ae my" href="http://www.microservicedriven.com/get-access" rel="noopener ugc nofollow" target="_blank"> <em class="kp">现在就报名吧！</em> </a></p></div></div>    
</body>
</html>