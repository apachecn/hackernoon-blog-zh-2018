<html>
<head>
<title>Deploy your Flask API to any Serverless Cloud Platform using this Simple Pattern</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用这个简单的模式将您的Flask API部署到任何无服务器的云平台</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/deploy-your-flask-api-to-any-serverless-cloud-platform-using-this-simple-pattern-2d32c3c4629a?source=collection_archive---------18-----------------------#2018-04-12">https://medium.com/hackernoon/deploy-your-flask-api-to-any-serverless-cloud-platform-using-this-simple-pattern-2d32c3c4629a?source=collection_archive---------18-----------------------#2018-04-12</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="46b1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将演示如何让Flask应用程序无服务器化，而不会将您局限于任何工具或云平台。它不需要任何应用程序代码的改变或者无服务器的<a class="ae jp" href="https://hackernoon.com/tagged/frameworks" rel="noopener ugc nofollow" target="_blank">框架</a>，所以你可以像以前一样继续本地开发。</p><p id="b729" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">理想情况下，您应该将您的应用程序重新架构成小的离散功能，以充分利用无服务器。然而，如果你想迁移一个遗留的应用程序或者只是一个快速开始使用无服务器的方法，那么这是一个很好的方法。</p><p id="950e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">1.创建烧瓶应用程序<br/> 2。使应用程序无服务器<br/> 3。将Lambda <br/> 4的应用程序打包到Zip中。使用Terraform部署</p><h1 id="bac8" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">1.创建烧瓶应用程序</h1><p id="c1bd" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">我们将为<a class="ae jp" href="https://hackernoon.com/tagged/python" rel="noopener ugc nofollow" target="_blank"> Python </a> 3.6+创建一个Flask应用。</p><h2 id="8a1c" class="kt jr hu bd js ku kv kw jw kx ky kz ka jc la lb ke jg lc ld ki jk le lf km lg dt translated">设置</h2><p id="531f" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">首先创建一个虚拟环境并安装依赖项。</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="7bd0" class="kt jr hu lm b fv lq lr l ls lt">$ python3 -m venv env $ source env/bin/activate<br/>$ pip install flask flask-lambda-python36 http-prompt</span></pre><h2 id="6b01" class="kt jr hu bd js ku kv kw jw kx ky kz ka jc la lb ke jg lc ld ki jk le lf km lg dt translated">应用代码</h2><p id="56ce" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">添加下面的代码，它将创建一个具有完美音乐品味的Flask应用程序。</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="6fbf" class="kt jr hu lm b fv lq lr l ls lt">$ tree -L 4<br/>.<br/>├── app<br/>│   ├── api<br/>│   │   ├── __init__.py<br/>│   │   └── resources.py<br/>│   └── __init__.py<br/>└── run.py</span><span id="1c0b" class="kt jr hu lm b fv lu lr l ls lt"># app/api/resources.py<br/>from flask import Blueprint<br/>from flask import request, jsonify</span><span id="f264" class="kt jr hu lm b fv lu lr l ls lt">api = Blueprint(‘api’, __name__)</span><span id="85a0" class="kt jr hu lm b fv lu lr l ls lt"><a class="ae jp" href="http://twitter.com/api" rel="noopener ugc nofollow" target="_blank">@api</a>.route(‘/artists’, methods=(‘GET’, ‘POST’))<br/>def handle_artists():<br/>    if request.method == 'POST':<br/>        return 'ok'</span><span id="b6dc" class="kt jr hu lm b fv lu lr l ls lt">return jsonify([{'name': 'enya'}])</span><span id="19ff" class="kt jr hu lm b fv lu lr l ls lt"># app/api/__init__.py<br/>from .resources import api</span><span id="ddb8" class="kt jr hu lm b fv lu lr l ls lt"># app/__init__.py<br/>def create_app(Flask):<br/>    app = Flask(__name__)<br/>    from .api import api as api_blueprint<br/>    app.register_blueprint(api_blueprint)</span><span id="66c9" class="kt jr hu lm b fv lu lr l ls lt">return app</span><span id="8ea3" class="kt jr hu lm b fv lu lr l ls lt"># run.py<br/>from flask import Flask<br/>from app import create_app</span><span id="0a1a" class="kt jr hu lm b fv lu lr l ls lt">http_server = create_app(Flask)</span></pre><p id="9188" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">完整的应用程序代码可从<a class="ae jp" href="https://github.com/techjacker/python-serverless-api" rel="noopener ugc nofollow" target="_blank">示例库</a>获得。</p><h2 id="8866" class="kt jr hu bd js ku kv kw jw kx ky kz ka jc la lb ke jg lc ld ki jk le lf km lg dt translated">运行应用程序</h2><p id="78e2" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">在本地开发模式下运行应用程序。</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="13a6" class="kt jr hu lm b fv lq lr l ls lt">$ FLASK_DEBUG=1 FLASK_APP=run.py flask run</span></pre><h2 id="e008" class="kt jr hu bd js ku kv kw jw kx ky kz ka jc la lb ke jg lc ld ki jk le lf km lg dt translated">测试应用程序</h2><p id="42d2" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">在另一个终端窗口中手动测试API。</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="2d59" class="kt jr hu lm b fv lq lr l ls lt">$ http-prompt localhost:5000</span><span id="62d0" class="kt jr hu lm b fv lu lr l ls lt"><a class="ae jp" href="http://localhost:5000" rel="noopener ugc nofollow" target="_blank">http://localhost:5000</a>&gt; get artists</span><span id="99d2" class="kt jr hu lm b fv lu lr l ls lt">HTTP/1.0 200 OK<br/>Content-Length: 31<br/>Content-Type: application/json<br/>Date: Thu, 12 Apr 2018 19:15:56 GMT<br/>Server: Werkzeug/0.14.1 Python/3.6.5</span><span id="daad" class="kt jr hu lm b fv lu lr l ls lt">[<br/>    {<br/>        "name": "enya"<br/>    }<br/>]</span></pre><h1 id="1e4a" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">2.使应用程序无服务器</h1><p id="288a" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">到目前为止，这只是另一个烧瓶应用程序。是时候让它没有服务器了。将另一个名为<code class="eh lv lw lx lm b">run-lambda.py</code>的文件添加到项目的根目录中。</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="de9c" class="kt jr hu lm b fv lq lr l ls lt"># run-lambda.py<br/>from flask_lambda import FlaskLambda<br/>from app import create_app</span><span id="0ddf" class="kt jr hu lm b fv lu lr l ls lt">http_server = create_app(FlaskLambda)</span></pre><p id="a0c7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就是这样！您的应用程序现在可以在AWS Lambda上运行了。这里的诀窍是使用<a class="ae jp" href="https://github.com/sivel/flask-lambda" rel="noopener ugc nofollow" target="_blank"> FlaskLambda </a>代替普通烧瓶。FlaskLambda将AWS提供给Lambda函数的有效负载转换成Flask所期望的格式。</p><p id="e5f5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这种适配器模式与<a class="ae jp" href="https://github.com/Miserlou/Zappa" rel="noopener ugc nofollow" target="_blank"> zappa </a>使用的模式相同。就我个人而言，我不喜欢引入任何额外的工具依赖，而是选择Terraform或<a class="ae jp" href="https://aws.amazon.com/about-aws/whats-new/2016/11/introducing-the-aws-serverless-application-model/" rel="noopener ugc nofollow" target="_blank"> AWS无服务器应用程序模型(SAM) </a>进行部署。</p><p id="c87c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，FlaskLambda只支持Python &lt;= 3.5. I’ve created a <a class="ae jp" href="https://github.com/techjacker/flask-lambda" rel="noopener ugc nofollow" target="_blank"> fork </a>，该fork添加了对Python 3.6+的支持，而Python 3.6+是您之前用<code class="eh lv lw lx lm b">pip install flask-lambda-python36</code>安装的。</p><h1 id="129f" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">3.将应用程序打包成Lambda的Zip文件</h1><p id="2adb" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">为了部署您的应用程序，您需要将您的应用程序打包成一个zip文件。以下脚本将捆绑您的应用程序代码和依赖项。</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="bb7e" class="kt jr hu lm b fv lq lr l ls lt"># bundlelambda.sh<br/>#!/usr/bin/env bash</span><span id="99e7" class="kt jr hu lm b fv lu lr l ls lt">OUTPUT_ZIP="$PWD/terraform/flask-app.zip"<br/>ARCHIVE_TMP="/tmp/lambda-bundle-tmp.zip"</span><span id="7191" class="kt jr hu lm b fv lu lr l ls lt">addToZip() {<br/>    local exclude_packages="setuptools pip easy_install"<br/>    zip -r9 s"$ARCHIVE_TMP" \<br/>        --exclude ./*.pyc \<br/>        --exclude "$exclude_packages" \<br/>        -- "${@}"<br/>}<br/>addDependencies() {<br/>    local packages_dir=()<br/>    packages_dir+=($(python -c "from distutils.sysconfig import get_python_lib; print(get_python_lib())"))<br/>    env_packages=$(python -c "from distutils.sysconfig import get_python_lib; print(get_python_lib(plat_specific=1))")<br/>    if [[ "$env_packages" != "${packages_dir[0]}" ]]; then<br/>        packages_dir+=($env_packages)<br/>    fi<br/>    for (( i=0; i&lt;${#packages_dir[@]}; i++ )); do<br/>        [[ -d "${packages_dir[$i]}" ]] &amp;&amp; cd "${packages_dir[$i]}" &amp;&amp; addToZip -- *<br/>    done<br/>}</span><span id="95c3" class="kt jr hu lm b fv lu lr l ls lt">rm "$ARCHIVE_TMP" "$OUTPUT_ZIP"<br/>addDependencies<br/>addToZip app ./*.py<br/>mv "$ARCHIVE_TMP" "$OUTPUT_ZIP"</span></pre><p id="913c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是示例存储库中脚本<a class="ae jp" href="https://github.com/techjacker/python-serverless-api/blob/master/bin/bundlelambda" rel="noopener ugc nofollow" target="_blank">的简化版本。</a></p><p id="756f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">保存并运行脚本，在<code class="eh lv lw lx lm b">terraform/flask-app.zip</code>创建一个zip包。</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="2702" class="kt jr hu lm b fv lq lr l ls lt">$ chmod +x bundlelambda.sh<br/>$ ./bundlelambda.sh</span></pre><p id="7beb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">确保您在Linux平台上运行它，以确保与Lambda运行时环境的兼容性。</p><h1 id="712d" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">4.使用<a class="ae jp" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank">地形</a>部署</h1><h2 id="c068" class="kt jr hu bd js ku kv kw jw kx ky kz ka jc la lb ke jg lc ld ki jk le lf km lg dt translated">地形配置</h2><p id="8340" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">我们将使用<code class="eh lv lw lx lm b"><a class="ae jp" href="https://registry.terraform.io/modules/techjacker/lambda-api-gateway/aws/1.0.2" rel="noopener ugc nofollow" target="_blank">lambda-api-gateway</a></code> terraform模块来处理部署。在<code class="eh lv lw lx lm b">terraform/main.tf</code>创建Terraform配置文件，并用您的AWS帐户ID更新<code class="eh lv lw lx lm b">account_id</code>。</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="54c3" class="kt jr hu lm b fv lq lr l ls lt"># terraform/main.tf<br/>module "lambda_api_gateway" {<br/>    source               = "<a class="ae jp" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:techjacker/terraform-aws-lambda-api-gateway"</span><span id="a6c1" class="kt jr hu lm b fv lu lr l ls lt"># tags<br/>    project              = "todo-mvc"<br/>    service              = "acme-corp"<br/>    owner                = "Roadrunner"<br/>    costcenter           = "acme-abc"</span><span id="28e0" class="kt jr hu lm b fv lu lr l ls lt"># vpc<br/>    vpc_cidr             = "10.0.0.0/16"<br/>    public_subnets_cidr  = ["10.0.1.0/24", "10.0.2.0/24"]<br/>    private_subnets_cidr = ["10.0.3.0/24", "10.0.4.0/24"]<br/>    nat_cidr             = ["10.0.5.0/24", "10.0.6.0/24"]<br/>    igw_cidr             = "10.0.8.0/24"<br/>    azs                  = ["eu-west-1a", "eu-west-1b"]</span><span id="19e5" class="kt jr hu lm b fv lu lr l ls lt"># lambda<br/>    lambda_zip_path      = "flask-app.zip"<br/>    lambda_handler       = "run_lambda.http_server"<br/>    lambda_runtime       = "python3.6"<br/>    lambda_function_name = "HttpWebserver"</span><span id="7741" class="kt jr hu lm b fv lu lr l ls lt"># API gateway<br/>    region               = "eu-west-1"<br/>    account_id           = "123456789"<br/>}</span></pre><p id="d719" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里的键值是<code class="eh lv lw lx lm b">lambda_handler</code>，它指示AWS Lambda使用<code class="eh lv lw lx lm b">run_lambda.py</code>文件作为我们应用程序的入口点。</p><h2 id="16d3" class="kt jr hu bd js ku kv kw jw kx ky kz ka jc la lb ke jg lc ld ki jk le lf km lg dt translated">部署</h2><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="76d6" class="kt jr hu lm b fv lq lr l ls lt">$ cd terraform<br/>$ terraform apply</span></pre><p id="6acc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">完成后，Terraform应该输出API URL，您可以使用它来手动测试部署是否成功。</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="8505" class="kt jr hu lm b fv lq lr l ls lt">$ http-prompt $(terraform output api_url)<br/>GET artists</span><span id="842c" class="kt jr hu lm b fv lu lr l ls lt">HTTP/1.0 200 OK<br/>Content-Length: 31<br/>Content-Type: application/json<br/>Date: Thu, 12 Apr 2018 19:15:56 GMT<br/>Server: Werkzeug/0.14.1 Python/3.6.5</span><span id="f4e5" class="kt jr hu lm b fv lu lr l ls lt">[<br/>  {<br/>    "name": "enya"<br/>  }<br/>]</span></pre><h1 id="6339" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">结论</h1><p id="fbf8" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">我们用一个现有的Flask应用程序，只用三行代码就把它变成了无服务器的！通过使用adaptor模式，我们给了自己在未来轻松更换无服务器云提供商的自由。我们甚至可以切换到基于容器的部署，而无需更改任何应用程序代码。</p><p id="3884" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这种方法的好处:</p><ul class=""><li id="b96c" class="ly lz hu it b iu iv iy iz jc ma jg mb jk mc jo md me mf mg dt translated">像往常一样在本地开发(不需要模拟器)</li><li id="6f41" class="ly lz hu it b iu mh iy mi jc mj jg mk jk ml jo md me mf mg dt translated">全面了解和控制您的基础架构</li><li id="411d" class="ly lz hu it b iu mh iy mi jc mj jg mk jk ml jo md me mf mg dt translated">避免云供应商锁定</li><li id="8b6b" class="ly lz hu it b iu mh iy mi jc mj jg mk jk ml jo md me mf mg dt translated">避免应用程序代码框架锁定</li></ul><p id="f81d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">未来的帖子将涵盖<a class="ae jp" href="https://aws.amazon.com/about-aws/whats-new/2016/11/introducing-the-aws-serverless-application-model/" rel="noopener ugc nofollow" target="_blank"> AWS无服务器应用模型(SAM) </a>、Azure功能和谷歌云功能部署。</p><p id="63bf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本教程的完整代码可从<a class="ae jp" href="https://github.com/techjacker/python-serverless-api" rel="noopener ugc nofollow" target="_blank"> github </a>获得。</p></div><div class="ab cl mm mn hc mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="hn ho hp hq hr"><p id="9f13" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="mt">原载于</em><a class="ae jp" href="https://andrewgriffithsonline.com/blog/180412-deploy-flask-api-any-serverless-cloud-platform" rel="noopener ugc nofollow" target="_blank"><em class="mt">andrewgriffithsonline.com</em></a><em class="mt">。Andrew Griffiths是一名自由开发人员，专门使用无服务器平台构建和部署Golang、Python和JavaScript应用程序。</em></p><figure class="lh li lj lk fq mu"><div class="bz el l di"><div class="mv mw l"/></div></figure></div></div>    
</body>
</html>