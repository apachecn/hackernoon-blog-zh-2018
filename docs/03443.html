<html>
<head>
<title>Stellar Escrow Smart Contract Development</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">恒星托管智能合同开发</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/stellar-escrow-smart-contract-development-4fb08d8267c8?source=collection_archive---------8-----------------------#2018-04-19">https://medium.com/hackernoon/stellar-escrow-smart-contract-development-4fb08d8267c8?source=collection_archive---------8-----------------------#2018-04-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="6e2d" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">在Stellar网络上创建您的第一个托管智能合同。</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/b1eadac8accbf22ff07a2e73781c371d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZXsVh1kzts8KUkYxwhmvtQ.jpeg"/></div></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">Source: <a class="ae jz" href="https://gratisography.com/" rel="noopener ugc nofollow" target="_blank">gratisography.com</a></figcaption></figure><p id="e947" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">在阅读本教程之前，您应该对Stellar如何工作以及如何在测试网络上创建一个简单的帐户有一个基本的了解。看看我在这个系列中的<a class="ae jz" rel="noopener" href="/wearetheledger/exploring-stellar-lumens-development-tutorial-78b4e1c92733">上一篇文章</a>，让你得到更新。</p><p id="72ea" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">本文将向您解释如何使用Stellar Lumens开发托管智能合同。我还会强调一些额外的特性，比如检索余额和干净的历史日志。</p><p id="fa2f" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated"><em class="kw">额外说明:本文是</em> <a class="ae jz" rel="noopener" href="/wearetheledger/blockchaingers-hackathon-2018-the-aftermath-7a5bc7682dfa"> <em class="kw">区块链器系列</em> </a> <em class="kw">的一部分。与TheLedger一起，我们在最大的区块链黑客马拉松中赢得了“数字国家基础设施”赛道。你可以在这里</em>  <em class="kw">了解更多关于我们的想法</em> <a class="ae jz" rel="noopener" href="/wearetheledger/what-weve-built-to-win-the-worlds-biggest-blockchain-hackathon-of-2018-ea01decfd60c"> <em class="kw">。Stellar testnet上的托管智能合同是这个原型的一部分。</em></a></p><h1 id="3ba1" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">用例描述</h1><p id="9172" class="pw-post-body-paragraph ka kb hu kc b kd lp iv kf kg lq iy ki kj lr kl km kn ls kp kq kr lt kt ku kv hn dt translated">我们有两个身份:房子和承包商。房子可以向承包商支付房屋相关服务的费用，比如检查你的中央供暖系统。一旦房屋和承包商同意提供服务，房屋将把商定的金额(在XLM)存入托管智能合同。一旦工作完成，房子和承包商都必须签字释放资金。</p><h1 id="e254" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">准备</h1><p id="3316" class="pw-post-body-paragraph ka kb hu kc b kd lp iv kf kg lq iy ki kj lr kl km kn ls kp kq kr lt kt ku kv hn dt translated">首先，我们需要在testnet上创建一个新的空帐户。让我们创建一个。</p><pre class="jk jl jm jn fq lu lv lw lx aw ly dt"><span id="3916" class="lz ky hu lv b fv ma mb l mc md">const newKey = Stellar.Keypair.random();</span><span id="3dc7" class="lz ky hu lv b fv me mb l mc md">const transaction = new Stellar.TransactionBuilder(ownerAccount)<br/>    .addOperation(Stellar.Operation.createAccount({<br/>        destination: escrowPubKey,<br/>        startingBalance: '2.5000000'<br/>    }))<br/>    .build();</span><span id="ae59" class="lz ky hu lv b fv me mb l mc md">transaction.sign(ownerKeypair);</span><span id="0f28" class="lz ky hu lv b fv me mb l mc md">return StellarConfig.server.submitTransaction(transaction);</span></pre><p id="ce13" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">我们还必须定义一个所有者帐户，该帐户负责创建托管，但不能对其执行任何操作。我们使用一个配置文件来检索我们的服务器，这段代码与:<code class="eh mf mg mh lv b">new Stellar.Server('https://horizon-testnet.stellar.org');</code> <em class="kw"> </em>相同，它创建了一个与Stellar testnet的新连接。</p><p id="ecc8" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">或许，你想知道为什么我要把250万XLM交给第三方托管？Stellar要求每个账户的初始余额为1 XLM。此外，除了随机托管签名者之外，我们还增加了两个签名者。对于你添加到合同中的每一个签名者，你必须用0.5 XLM补足起始余额。所以，…</p><pre class="jk jl jm jn fq lu lv lw lx aw ly dt"><span id="5c1f" class="lz ky hu lv b fv ma mb l mc md">3 x 0.5 (signers) + 1 (base balance) = 2.5</span></pre><p id="55e9" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">更多信息可在Stellar <a class="ae jz" href="https://www.stellar.org/developers/guides/concepts/fees.html#minimum-account-balance" rel="noopener ugc nofollow" target="_blank">文档</a>中找到。</p><h1 id="f486" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">构建一流的托管交易</h1><p id="b714" class="pw-post-body-paragraph ka kb hu kc b kd lp iv kf kg lq iy ki kj lr kl km kn ls kp kq kr lt kt ku kv hn dt translated">让我们取回托管账户，</p><pre class="jk jl jm jn fq lu lv lw lx aw ly dt"><span id="04aa" class="lz ky hu lv b fv ma mb l mc md">const escrowAccount = StellarConfig.server.loadAccount(pubKey);</span></pre><p id="e2da" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">并建立托管交易。</p><pre class="jk jl jm jn fq lu lv lw lx aw ly dt"><span id="6e97" class="lz ky hu lv b fv ma mb l mc md">let transaction = new Stellar.TransactionBuilder(escrowAccount)<br/>    .addOperation(Stellar.Operation.setOptions({<br/>        signer: { <br/>            ed25519PublicKey: houseKeypair.publicKey(),<br/>            weight: 1<br/>        }<br/>    }))<br/>    .addOperation(Stellar.Operation.setOptions({<br/>        masterWeight: 0,<br/>        lowThreshold: 2,<br/>        medThreshold: 2,<br/>        highThreshold: 2,<br/>        signer: {<br/>            ed25519PublicKey: contractorKeypair.publicKey(),<br/>            weight: 1<br/>        }<br/>    }))<br/>    .build();</span></pre><p id="b2f7" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">如你所见，我们在托管合同上增加了两个签名人。我们给两个签名者相同的投票权(1)并将阈值设置为2。因为我们没有给托管账户本身一个明确的权重，所以这个权重被设置为零。这意味着房子和承包商都必须签字才能释放资金，而不是托管所有人。您可以在这里看到一个托管智能合同交易创建的示例<a class="ae jz" href="https://horizon-testnet.stellar.org/accounts/GAFMVD63P3ZQB7AX6M2ZNWSRMC7HMXWEVQQNRSZDXJMT754AHDKZMH6N" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff mi"><img src="../Images/4afa2aa3d2bf452b12d1b813deacc99b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*gtMhewqZwBQG1kglZYXqow.png"/></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">Stellar Escrow Contract</figcaption></figure><p id="b54c" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">最后，我们需要签名(用随机密钥对)并将交易发送到网络。</p><pre class="jk jl jm jn fq lu lv lw lx aw ly dt"><span id="f4df" class="lz ky hu lv b fv ma mb l mc md">transaction.sign(newKey);<br/>await StellarConfig.server.submitTransaction(transaction);</span></pre><p id="ce3e" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">理想情况下，房屋将商定的金额发送到托管智能合同。发送充值交易的代码如下所示。</p><pre class="jk jl jm jn fq lu lv lw lx aw ly dt"><span id="d0b9" class="lz ky hu lv b fv ma mb l mc md">memo = Stellar.Memo.text('Pay: House to Contractor');<br/>return new Stellar.TransactionBuilder(&lt;source-account&gt;, { memo })<br/>    .addOperation(Stellar.Operation.payment({<br/>        &lt;destination-pub-key&gt;,<br/>        asset: Stellar.Asset.native(),<br/>        &lt;amount&gt;</span><span id="ed90" class="lz ky hu lv b fv me mb l mc md">}))<br/>.build();</span></pre><h1 id="bbdf" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">释放资金</h1><p id="cd95" class="pw-post-body-paragraph ka kb hu kc b kd lp iv kf kg lq iy ki kj lr kl km kn ls kp kq kr lt kt ku kv hn dt translated">释放资金其实很简单。您创建了一个从托管账户到承包商的新转账交易。这里唯一的区别是房子和承包商都必须用他们的钥匙对签名。</p><pre class="jk jl jm jn fq lu lv lw lx aw ly dt"><span id="7fba" class="lz ky hu lv b fv ma mb l mc md">transaction.sign(houseKeyPair);<br/>transaction.sign(contractorKeyPair);</span></pre><h1 id="6a70" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">附加操作</h1><h2 id="90ab" class="lz ky hu bd kz mj mk ml ld mm mn mo lh kj mp mq lj kn mr ms ll kr mt mu ln mv dt translated">检索客户的历史记录</h2><p id="21d1" class="pw-post-body-paragraph ka kb hu kc b kd lp iv kf kg lq iy ki kj lr kl km kn ls kp kq kr lt kt ku kv hn dt translated">这将给你一个清单，列出某个账户已经执行的所有付款。我们从数组中移除第一个结果(带有<code class="eh mf mg mh lv b">shift()</code>),因为这是账户创建交易(对其自身的0 XLM支付)。</p><pre class="jk jl jm jn fq lu lv lw lx aw ly dt"><span id="dafd" class="lz ky hu lv b fv ma mb l mc md">async retrievePayments(pubKey:string) {<br/>    let account = await this.loadAccountAsync(pubKey);<br/>    let payments = await axios.get(`${StellarConfig.baseUrl}/accounts/${account.accountId()}/payments`);</span><span id="6868" class="lz ky hu lv b fv me mb l mc md">let paymentRecords = payments.data._embedded.records;<br/>    paymentRecords.shift();</span><span id="fcdb" class="lz ky hu lv b fv me mb l mc md">return paymentRecords.map(record =&gt; { <br/>        return { <br/>            id: record.transaction_hash, <br/>            from: record.from,<br/>            to: record.to,<br/>            amount: record.amount<br/>        };<br/>    });<br/>}</span></pre><p id="463d" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">您也可以使用HTTP API端点<a class="ae jz" href="https://horizon-testnet.stellar.org/accounts/GACBOMUEPLW6YWXVQ7ZXRTO4TWDLUM3FHEPPT4DW2OFVUOA3EZPIIDOL/payments" rel="noopener ugc nofollow" target="_blank">/accounts/&lt;account-ID&gt;/payments</a>在您的web浏览器中检索它。您将会看到这样的内容:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff mw"><img src="../Images/9b8ebb664f29d31798be4ddfd00a504c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*qpjzallTpV3myXGhpY-gyw.png"/></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">One payment object (history) for an account.</figcaption></figure><h2 id="fd87" class="lz ky hu bd kz mj mk ml ld mm mn mo lh kj mp mq lj kn mr ms ll kr mt mu ln mv dt translated">获取帐户余额</h2><p id="7d20" class="pw-post-body-paragraph ka kb hu kc b kd lp iv kf kg lq iy ki kj lr kl km kn ls kp kq kr lt kt ku kv hn dt translated">要检索一个帐户的XLM余额，只需根据它的公钥加载(检索)帐户。由于一个帐户可以有多个余额(原生XLM和其他硬币部署在恒星网络)，我们将只寻找原生余额。</p><pre class="jk jl jm jn fq lu lv lw lx aw ly dt"><span id="9c01" class="lz ky hu lv b fv ma mb l mc md">async getBalance(pubKey) {<br/>    const account = await StellarConfig.server.loadAccount(pubKey);<br/>    let balance;</span><span id="fec1" class="lz ky hu lv b fv me mb l mc md">account.balances.forEach((balanceObject) =&gt; {<br/>        if (balanceObject.asset_type === 'native') {<br/>             balance = balanceObject.balance;<br/>        }<br/>    });</span><span id="17e4" class="lz ky hu lv b fv me mb l mc md">    return balance;<br/>}</span></pre><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff mx"><img src="../Images/63289993976f4cebafd1e86555b98bdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*wDN2JPJCYNzFUicL.gif"/></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">Source: <a class="ae jz" href="https://www.in3dc.com/single-post/2017/04/26/Thats-a-Wrap-Did-we-WoW-you" rel="noopener ugc nofollow" target="_blank">https://www.in3dc.com</a></figcaption></figure><h1 id="0c86" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">接下来读什么</h1><ul class=""><li id="3de5" class="my mz hu kc b kd lp kg lq kj na kn nb kr nc kv nd ne nf ng dt translated"><a class="ae jz" rel="noopener" href="/wearetheledger/exploring-stellar-lumens-development-tutorial-78b4e1c92733"> <strong class="kc hv">探索恒星流明|入门开发教程</strong> </a></li><li id="b4e4" class="my mz hu kc b kd nh kg ni kj nj kn nk kr nl kv nd ne nf ng dt translated"><a class="ae jz" href="https://hackernoon.com/builders-of-the-decentralized-web-10-of-the-most-innovative-technologies-197271aefa82" rel="noopener ugc nofollow" target="_blank"> <strong class="kc hv">【去中心化网络的建设者:10项最具创新性的技术</strong> </a></li><li id="2208" class="my mz hu kc b kd nh kg ni kj nj kn nk kr nl kv nd ne nf ng dt translated"><a class="ae jz" rel="noopener" href="/wearetheledger/the-tech-stack-to-win-the-worlds-biggest-blockchain-hackathon-of-2018-bcad38815bd6"> <strong class="kc hv">赢得2018年全球最大的区块链黑客马拉松的技术团队！</strong> </a></li></ul><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nm nn l"/></div></figure></div></div>    
</body>
</html>