<html>
<head>
<title>From Makefile to Go semantic versioning service on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Makefile到Go语义版本服务</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/from-makefile-to-go-semantic-versioning-service-on-kubernetes-3fae678db87c?source=collection_archive---------9-----------------------#2018-04-20">https://medium.com/hackernoon/from-makefile-to-go-semantic-versioning-service-on-kubernetes-3fae678db87c?source=collection_archive---------9-----------------------#2018-04-20</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/8c882a5c83ddf87d8728c03497900185.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EXzYpzDRDw1jX7M7m6D0vQ.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Photo by Alexander Andrews (<a class="ae jg" href="https://unsplash.com/@alex_andrews" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/@alex_andrews</a>)</figcaption></figure><p id="2f1e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">大约一周前，我试图弄清楚是否有一个好的Makefile可以用于go项目。</p><figure class="kf kg kh ki fq iv"><div class="bz el l di"><div class="kj kk l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Huge number of followers I have couldn’t help me much …</figcaption></figure><p id="62fa" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我能够找到一堆资源，从非常简单的Makefiles到非常高级的东西，包括各种任务，如运行测试、林挺、go格式等。</p><p id="d04a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">当我浏览所有这些资源时，我偶然发现了来自<a class="ae jg" href="https://github.com/jessfraz" rel="noopener ugc nofollow" target="_blank">杰斯·弗雷泽勒</a>的Github repos的<a class="ae jg" href="https://github.com/genuinetools/img/blob/master/Makefile" rel="noopener ugc nofollow" target="_blank">makefile</a>中的一个。除了我在这里考虑的“标准”目标(构建、lint、格式)，她还使用了一个增加项目/包版本的<code class="eh kl km kn ko b">bump-version</code>目标。为了增加版本，Jess使用了她创建的sembump工具，我在想，如果有一个我可以使用的服务就好了，它会做几乎相同的事情——你可以为它提供一个版本，即你想要提升的版本部分(主要版本、次要版本或补丁),服务会用一个新版本来响应。</p><p id="f0ed" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">一开始是寻找Go的首发<code class="eh kl km kn ko b">Makefile</code>，最后变成了一个简单的碰撞semversion服务。我创建的服务在<a class="ae jg" href="https://semver.xyz" rel="noopener ugc nofollow" target="_blank"> https://semver.xyz </a>启动并运行，你可以使用它，也可以去<a class="ae jg" href="https://bump.semver.xyz/minor?version=1.0.0" rel="noopener ugc nofollow" target="_blank">https://bump.semver.xyz/minor?version=1.0.0</a>试用它</p><p id="a0ef" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我还将整个项目上传到了GitHub，以防你想继续下去并实际查看代码。</p><p id="a635" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">由于其他人已经做了大量的工作，实际代码并不多——只有几行<a class="ae jg" href="https://github.com/peterj/semver/blob/master/pkg/semver/semver.go#L24" rel="noopener ugc nofollow" target="_blank">代码</a>。我正在使用一个名为<a class="ae jg" href="https://github.com/blang/semver" rel="noopener ugc nofollow" target="_blank"> semver </a>的现有库，由<a class="ae jg" href="https://github.com/blang" rel="noopener ugc nofollow" target="_blank"> Benedikt Lang </a>构建。这个库完成了解析版本的最难的部分，我只取了你想要增加的版本的一部分。除了这个库之外，我还使用了<a class="ae jg" href="https://github.com/gorilla/mux" rel="noopener ugc nofollow" target="_blank"> Gorilla </a>来公开一个端点，您可以调用它来修改它接收到的版本。</p><p id="0046" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">编码部分基本完成后，我开始思考将该服务快速部署到Kubernetes集群的最简单、最快的方法。</p><p id="fa19" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">此时，一个巨大平板卡车上的玩具卡车的图像浮现在脑海中——在集群上运行这么小的东西可能很浪费，但是我已经有一个集群在运行，所以我可以原谅:)</p><p id="76a6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">无论如何，为了将东西部署到集群，我从Kubernetes部署和服务开始—类似这样:</p><figure class="kf kg kh ki fq iv"><div class="bz el l di"><div class="kp kk l"/></div></figure><p id="9389" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">部署这是一个运行<code class="eh kl km kn ko b">kubectl apply -f filename.yaml</code>的过程，你很好。但是，一旦您对代码进行了一些更改，您就必须重新构建Docker映像，将其推送到注册表中，然后重新启动Pod，以便获得新的映像。这意味着我可能需要一个为我构建和推送图像的<code class="eh kl km kn ko b">Makefile</code>目标，大致如下所示(我确实参数化了<code class="eh kl km kn ko b">Docker</code>文件名和图像名):</p><figure class="kf kg kh ki fq iv"><div class="bz el l di"><div class="kp kk l"/></div></figure><p id="8f8e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">因此，现在我能够构建我的图像并将其推送到注册表。下一步是用新的映像名称修改Kubernetes <code class="eh kl km kn ko b">yaml</code>，然后部署它。起初，我想在<code class="eh kl km kn ko b">yaml</code>文件中定义一些变量(例如<code class="eh kl km kn ko b">%IMAGE_NAME%</code>、<code class="eh kl km kn ko b">%VERSION%</code>、…)并用<code class="eh kl km kn ko b">sed</code>将它们替换为实际值。听起来像是一个好方法，但后来我想起我可以使用<a class="ae jg" href="https://github.com/kubernetes/helm" rel="noopener ugc nofollow" target="_blank"> Helm </a>并对部署进行模板化——从长远来看这将使事情变得更容易，因为我将能够升级版本并以这种方式进行一些跟踪。</p><p id="8c96" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">安装Helm后，我开始创建一个图表(<code class="eh kl km kn ko b">helm create semver-svc</code>)。幸运的是，空的chart Helm几乎包含了我需要的所有东西，所以这只是更新<code class="eh kl km kn ko b">values.yaml</code>文件中的值的问题。一旦我通过运行<code class="eh kl km kn ko b">helm install</code>进行了测试，我就回到了<code class="eh kl km kn ko b">Makefile</code>并创建了另一组安装和升级头盔版本的目标:</p><figure class="kf kg kh ki fq iv"><div class="bz el l di"><div class="kp kk l"/></div></figure><p id="a0bd" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我为该服务定义了一个<code class="eh kl km kn ko b">install</code>和<code class="eh kl km kn ko b">upgrade</code>目标——首次尝试创建Helm版本时使用install，升级用于该版本的后续更新。</p><p id="ddb8" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">随着大多数目标的参数化，我能够定义uber <code class="eh kl km kn ko b">upgrade</code>目标，该目标修改版本，构建并发布Docker映像，最后调用服务上的upgrade来实际升级已经在Kubernetes集群中运行的东西。</p><p id="6dde" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><code class="eh kl km kn ko b">Makefile</code>的<code class="eh kl km kn ko b">bump-version</code>部分与Jess 在她的<a class="ae jg" href="https://github.com/genuinetools/img/blob/master/Makefile" rel="noopener ugc nofollow" target="_blank"> Makefile </a>中的<a class="ae jg" href="https://github.com/jessfraz" rel="noopener ugc nofollow" target="_blank">部分非常相似，不同之处在于，一旦我部署了我的服务，我就能够像这样调用服务来升级版本:</a></p><figure class="kf kg kh ki fq iv"><div class="bz el l di"><div class="kp kk l"/></div></figure><p id="1f59" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我还想通过一个定制的域(<a class="ae jg" href="https://www.semver.xyz" rel="noopener ugc nofollow" target="_blank"> https://www.semver.xyz </a>)来公开这个服务，所有这些都使用SSL和其他东西！设置这个需要安装<code class="eh kl km kn ko b"><a class="ae jg" href="https://github.com/jetstack/kube-lego" rel="noopener ugc nofollow" target="_blank">kube-lego</a></code>(用于从Letsencrypt自动获得SSL证书)和一个Nginx入口(向外界公开服务)，如下所示:</p><pre class="kf kg kh ki fq kq ko kr ks aw kt dt"><span id="ff41" class="ku kv hu ko b fv kw kx l ky kz">helm install stable/kube-lego \<br/>  --set config.LEGO_EMAIL=[YOUR_EMAIL] \<br/>  --set config.LEGO_URL=https://acme-v01.api.letsencrypt.org/directory</span><span id="9b43" class="ku kv hu ko b fv la kx l ky kz">helm install stable/nginx-ingress --namespace [NAMESPACE]</span></pre><p id="0326" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">因为为服务创建的默认舵图已经包含了一个<code class="eh kl km kn ko b">ingress.yaml</code>模板，所以只需要为它设置值:</p><figure class="kf kg kh ki fq iv"><div class="bz el l di"><div class="kp kk l"/></div></figure><p id="de54" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最后，我必须去我的域名注册商(name.com)那里，把我得到的酷域名和Nginx入口控制器的IP地址连接起来(你基本上需要为你的域名创建一个指向IP地址的A记录)。</p><p id="41ae" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">搞定了。我现在可以通过https公开访问这项服务了！(后来我还添加了一个简单的静态HTML页面，基本上使用了相同的目标和一个新的舵图来部署它)。</p><h1 id="744e" class="lb kv hu bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">结论</h1><p id="743d" class="pw-post-body-paragraph jh ji hu jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">实际服务的实现非常简单明了。我花了大部分时间计算出<code class="eh kl km kn ko b">Makefile</code>的目标，创建掌舵图，为我的目标取名字(安装？升级？部署？释放？).</p><p id="b93f" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">下一步，我会考虑尝试用Makefile/Helm charts创建一个好的基本模板，我可以用它来开发任何新的服务/项目。</p><h1 id="9c29" class="lb kv hu bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">感谢阅读！</h1><p id="2b63" class="pw-post-body-paragraph jh ji hu jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">欢迎对本文的任何反馈！你也可以在<a class="ae jg" href="http://twitter.com/pjausovec" rel="noopener ugc nofollow" target="_blank"> Twitter </a>和<a class="ae jg" href="http://github.com/peterj" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上关注我。如果你喜欢这个并且想在其他部分准备好的时候得到通知，你应该订阅<a class="ae jg" href="https://tinyletter.com/pjausovec" rel="noopener ugc nofollow" target="_blank">我的简讯</a>！</p></div></div>    
</body>
</html>