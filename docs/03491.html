<html>
<head>
<title>How To Shut Down XenServer automatically With NUT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用坚果自动关闭XenServer</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-shut-down-xenserver-automatically-with-nut-12206c3245c2?source=collection_archive---------11-----------------------#2018-04-21">https://medium.com/hackernoon/how-to-shut-down-xenserver-automatically-with-nut-12206c3245c2?source=collection_archive---------11-----------------------#2018-04-21</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/0b744288362e0d12e2e5735b643354c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lzc_mNPWEaJeR7qjBQqzew.jpeg"/></div></div></figure><div class=""/><p id="a7a3" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们学校的核心基础设施由UPS保护。不幸的是，我们总是有电源故障(大多是短暂的)，在我们的UPS的帮助下，我们至少可以稍微桥接它们。在我们的UPS上挂了一个<a class="ae ka" href="https://amzn.to/2HOnPde" rel="noopener ugc nofollow" target="_blank">树莓Pi </a>、<a class="ae ka" href="https://openschoolsolutions.org/shutdown-servers-case-power-failure%e2%80%8a-%e2%80%8aups-nut-co/" rel="noopener ugc nofollow" target="_blank">配置成坚果服务器</a>。如果电源出现故障，UPS切换到电池供电，Raspberry Pi会在特定充电状态后向所有连接的服务器发送命令。这些然后自动关闭。我们所有的虚拟机、备份系统和服务器都将关闭。然而，仍然缺少一个重要的服务器:虚拟化主机。所以今天我想简单描述一下如何通过设置XenServer为坚果客户端来自动关闭它。</p><h1 id="ab1f" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">安装螺母客户端</h1><p id="3dd6" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">XenServer基于CentOS，但是不允许安装第三方包。您还应该知道，如果您安装了额外的软件包，您可能不再获得支持(如果您有支持合同)。</p><p id="a2f4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了安装坚果客户端，我们必须修改文件<strong class="je ig"><em class="le">/etc/yum . repos . d/CentOS-base . repo</em></strong>中的XenServer 7。在<code class="eh lf lg lh li b">[extras]</code>部分，我们用<code class="eh lf lg lh li b">7</code>替换了<code class="eh lf lg lh li b">baseurl</code>行中的<code class="eh lf lg lh li b">$releaseserver</code>。</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="07ee" class="lr kc if li b fv ls lt l lu lv">$ nano /ect/yum.repos.d/CentOS-Base.repo<br/>…<br/>[extras]<br/>name=CentOS-$releasever — Extras<br/>mirrorlist=http://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;rep$<br/>baseurl=http://mirror.centos.org/centos/7/extras/$basearch/<br/>…</span></pre><p id="5867" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后我们可以设置Epel Repo并安装NUT客户端:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="baa2" class="lr kc if li b fv ls lt l lu lv">$ yum clean all<br/>$ yum — enablerepo=extras -y install epel-release</span></pre><p id="43fe" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在让我们看看哪个包提供了我们的NUT客户机并安装它:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="3d80" class="lr kc if li b fv ls lt l lu lv">$ yum provides /usr/sbin/upsmon<br/>Geladene Plugins: fastestmirror<br/>Loading mirror speeds from cached hostfile<br/>* epel: mirrors.bangmodhosting.com<br/>nut-2.7.2–3.el7.x86_64 : Network UPS Tools<br/>Quelle : epel<br/>Übereinstimmung von:<br/>Dateiname : /usr/sbin/upsmon</span><span id="d7c9" class="lr kc if li b fv lw lt l lu lv">$ yum install nut-client-2.7.2–3.el7.x86_64</span></pre><h1 id="6aa3" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">NUT客户端设置</h1><p id="ffef" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">既然已经安装了NUT客户机，我们需要对它进行配置，以便我们的XenServer在电源故障时关闭。首先，我们必须创建一个文件来告诉NUT我们的XenServer是一个客户端:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="be96" class="lr kc if li b fv ls lt l lu lv">$ nano /etc/ups/nut.conf<br/>MODE=netclient</span></pre><p id="2a51" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">主配置发生在文件<strong class="je ig"><em class="le">/etc/ups/up smon . conf</em></strong>中。在那里我们改变了两行:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="50a1" class="lr kc if li b fv ls lt l lu lv">$ nano /etc/ups/upsmon.conf</span><span id="f1d1" class="lr kc if li b fv lw lt l lu lv">…<br/>MONITOR ups@192.168.1.2 1 upsremote password slave<br/>…<br/>SHUTDOWNCMD "etc/ups/xen-shutdown.sh"<br/>…</span></pre><p id="f1fe" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">根据NUT master的配置，UPS名称、IP以及用户名和密码仍必须在此处进行调整。</p><p id="beb1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我们的XenServer关闭之前，它必须首先关闭所有虚拟机。我找到了下面的<a class="ae ka" href="https://github.com/serrc-techops/NUT-Configuration/blob/master/slave/xen/xen-shutdown.sh" rel="noopener ugc nofollow" target="_blank">脚本</a>，我们下载它并使其可执行。</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="a800" class="lr kc if li b fv ls lt l lu lv">$ cd /etc/ups/<br/>$ wget <a class="ae ka" href="https://raw.githubusercontent.com/serrc-techops/NUT-Configuration/master/slave/xen/xen-shutdown.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/serrc-techops/NUT-Configuration/master/slave/xen/xen-shutdown.sh</a><br/>$ chmod +x xen-shutdown.sh</span></pre><p id="e4ae" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了让NUT客户机也自动启动，我们还必须设置一个systemd服务。我们创建文件<strong class="je ig"><em class="le">/etc/systemd/system/nut-monitor . service</em></strong>并插入以下内容:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="1c44" class="lr kc if li b fv ls lt l lu lv">$ nano /etc/systemd/system/nut-monitor.service</span><span id="74bf" class="lr kc if li b fv lw lt l lu lv">[Unit]<br/>Description=Network UPS Tools — power device monitor and shutdown controller<br/>After=local-fs.target network.target</span><span id="a6e5" class="lr kc if li b fv lw lt l lu lv">[Service]<br/>ExecStart=/usr/sbin/upsmon<br/>PIDFile=/run/nut/upsmon.pid<br/>Type=forking</span><span id="ef2b" class="lr kc if li b fv lw lt l lu lv">[Install]<br/>WantedBy=multi-user.target</span></pre><p id="234d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，我们激活并启动该服务:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="bc0c" class="lr kc if li b fv ls lt l lu lv">$ systemctl enable nut-monitor.service<br/>$ systemctl daemon-reload<br/>$ systemctl start nut-monitor</span></pre><p id="61e1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">用<code class="eh lf lg lh li b">systemctl status nut-monitor</code>我们可以看到一切是否都在运行:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="8669" class="lr kc if li b fv ls lt l lu lv">nut-monitor.service — Network UPS Tools — power device monitor and shutdown controller<br/>Loaded: loaded (/etc/systemd/system/nut-monitor.service; enabled; vendor preset: disabled)<br/>Active: active (running) since Mi 2018–04–18 17:13:42 ICT; 1 day 12h ago<br/>Process: 997 ExecStart=/usr/sbin/upsmon (code=exited, status=0/SUCCESS)<br/>Main PID: 1001 (upsmon)<br/>CGroup: /system.slice/nut-monitor.service<br/>├─1000 /usr/sbin/upsmon<br/>└─1001 /usr/sbin/upsmon</span></pre><h1 id="451d" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">测试自动关机</h1><p id="a596" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">首先，我们可以测试关闭XenServer的脚本，看看是否所有启动的虚拟机都关闭了。为此，我们只需执行脚本:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="14a1" class="lr kc if li b fv ls lt l lu lv">$ sh /etc/ups/xen-shutdown.sh</span></pre><p id="0a1f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了模拟电源故障，我们可以在<em class="le">螺母主</em>上发出以下命令:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="8019" class="lr kc if li b fv ls lt l lu lv">$ sudo upsmon -c fsd</span></pre><p id="ff6e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">之后，您必须手动打开所有设备，或者通过局域网唤醒来唤醒它们。</p><h1 id="a9eb" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">结论</h1><p id="9f8a" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated"><a class="ae ka" href="http://networkupstools.org/" rel="noopener ugc nofollow" target="_blank">坚果</a>是一个伟大的项目，它允许我们非常灵活的场景。目前，我们只有一个大型UPS连接到螺母主设备，但也可以将多个UPS连接到螺母主设备。结合Check_MK，我们可以持续监控UPS的状态，还可以统计电源故障的频率。</p></div><div class="ab cl lx ly hc lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hn ho hp hq hr"><p id="0cf5" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">【openschoolsolutions.org】最初发表于<a class="ae ka" href="https://openschoolsolutions.org/shut-down-xenserver-automatically-nut/" rel="noopener ugc nofollow" target="_blank"><em class="le"/></a><em class="le">。</em> <strong class="je ig"> <em class="le">注册</em> </strong> <em class="le">订阅我们的时事通讯，获取免费的PDF格式，并为您的课堂提供出色的开源应用，或者在Twitter上关注</em><a class="ae ka" href="https://twitter.com/OpenSchoolZ" rel="noopener ugc nofollow" target="_blank"><em class="le">@ OpenSchoolZ</em></a><em class="le">。</em></p></div></div>    
</body>
</html>