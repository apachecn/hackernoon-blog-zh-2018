<html>
<head>
<title>How to Test GraphQL Server Using Mocha and Chai</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Mocha和Chai测试GraphQL服务器</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-test-graphql-server-using-mocha-and-chai-f5a10956e71a?source=collection_archive---------16-----------------------#2018-04-23">https://medium.com/hackernoon/how-to-test-graphql-server-using-mocha-and-chai-f5a10956e71a?source=collection_archive---------16-----------------------#2018-04-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="bbab" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当Kolosek团队第一次<a class="ae jp" href="https://kolosek.com/sails-graphql-guide/" rel="noopener ugc nofollow" target="_blank">开始在NodeJS项目</a>中使用GraphQL时，有一场编写测试的斗争:团队阅读了大量博客，寻找最佳方法。不幸的是，似乎没有，所以团队决定自己做一个，这就是。</p><p id="3dd0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本文将帮助您使用<a class="ae jp" href="https://mochajs.org/#getting-started" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">【摩卡】</strong></a><a class="ae jp" href="http://chaijs.com/api/" rel="noopener ugc nofollow" target="_blank"><strong class="it hv">【柴】</strong></a><a class="ae jp" href="https://github.com/visionmedia/supertest" rel="noopener ugc nofollow" target="_blank"><strong class="it hv">SuperTest</strong></a>和<a class="ae jp" href="http://graphql.org/graphql-js/" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv"> GraphQL </strong> </a>来测试您的GraphQL服务器。</p><p id="fc53" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，让我们设置运行测试所需的一切:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="2572" class="jz ka hu jv b fv kb kc l kd ke">npm i --save-dev mocha chai supertest graphql</span></pre><p id="4461" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在你已经安装好了所有的东西，接下来你可以继续<strong class="it hv">导入你将在<em class="kf"> User.test.js </em>文件中使用的所有依赖项</strong>:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="18a5" class="jz ka hu jv b fv kb kc l kd ke">const chai = require('chai');</span><span id="74f9" class="jz ka hu jv b fv kg kc l kd ke">const expect = chai.expect;<br/>const url = `http://localhost:3001/`;<br/>const request = require('supertest')(url);</span><span id="d376" class="jz ka hu jv b fv kg kc l kd ke">describe('GraphQL', () =&gt; {<br/>    // Tests<br/>});</span></pre><p id="d00a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kf">设置甚至比</em> <a class="ae jp" href="https://kolosek.com/rails-rspec-setup/" rel="noopener ugc nofollow" target="_blank"> <em class="kf">设置RSpec </em> </a> <em class="kf">进行测试还要简单！</em></p><p id="9a44" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在运行任何测试之前，您必须将一个命令添加到您的包中。</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="19aa" class="jz ka hu jv b fv kb kc l kd ke">  "scripts": {<br/>      "test": "mocha test/*.test.js"<br/>  }</span></pre><p id="1dab" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将告诉<strong class="it hv">摩卡</strong>用<em class="kf">测试所有文件。在你的测试文件夹中测试</em>扩展。要运行测试，只需键入:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="acd6" class="jz ka hu jv b fv kb kc l kd ke">npm test</span></pre><p id="c08b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它将显示<strong class="it hv"> 0通过</strong>，因为您还没有编写任何测试用例。</p><p id="8aff" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们定义一个graphql模式，您将使用它来编写测试。例如，在这里，您将在<em class="kf"> UserType.js </em>文件中创建一个包含用户基本信息的用户类型:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="4119" class="jz ka hu jv b fv kb kc l kd ke">const graphql = require('graphql');</span><span id="b9bf" class="jz ka hu jv b fv kg kc l kd ke">export default new graphql.GraphQLObjectType({<br/>name : 'UserType',<br/> fields : {<br/>     id : {<br/>         type : graphql.GraphQLInt<br/>     },<br/>     name : {<br/>         type : graphql.GraphQLString<br/>     },<br/>     username:{<br/>         type: graphql.GraphQLString<br/>     },<br/>     email : {<br/>         type : graphql.GraphQLString<br/>     }<br/>});</span></pre><p id="06a6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kf">科洛塞克团队组织测试的方式与其组织</em> <a class="ae jp" href="https://kolosek.com/rspec-controller-test/" rel="noopener ugc nofollow" target="_blank"> <em class="kf"> RSpec控制器测试</em> </a> <em class="kf">的方式相似！</em></p><p id="232d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们定义查询字段，该字段将向用户返回您刚才定义的字段:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="c647" class="jz ka hu jv b fv kb kc l kd ke">const graphql = require('graphql');<br/>const UserType = require('./UserType').default;</span><span id="f858" class="jz ka hu jv b fv kg kc l kd ke">export default {<br/> user: {<br/>   description: 'Returns information about user/s',<br/>   type: new graphql.GraphQLList(UserType),<br/>   args: {<br/>     id: { type: graphql.GraphQLInt },<br/>   },<br/>   resolve: async (_, { id }) =&gt; {<br/>       if (id) return User.find({ id })<br/>       return User.find()<br/>   }<br/> },</span></pre><p id="ee1d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了能够查询用户，您必须定义GraphQL模式:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="f426" class="jz ka hu jv b fv kb kc l kd ke">const graphql = require('graphql');<br/>const UserQuery = require('./UserQuery');</span><span id="af6a" class="jz ka hu jv b fv kg kc l kd ke">export default new graphql.GraphQLSchema({<br/>    name: 'Query',<br/>    fields: UserQuery<br/>})</span></pre><p id="d031" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在开始编写测试之前要做的最后一件事是创建一个通用的GraphQL控制器，它将为每个查询触发，这样客户端应用程序(您是使用React 的<a class="ae jp" href="https://kolosek.com/react-first-steps/" rel="noopener ugc nofollow" target="_blank">)和您的测试也有一个端点来发出请求。</a></p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="5029" class="jz ka hu jv b fv kb kc l kd ke">const graphql = require('graphql');<br/>const schema = require('./schema').default;</span><span id="3bef" class="jz ka hu jv b fv kg kc l kd ke">module.exports = {<br/>   graphql: async (req, res) =&gt; {<br/>     try {<br/>       const result = await graphql(schema, req.body.query, req);<br/>       if (result.errors) throw (result.errors);<br/>       return res.ok(result);<br/>     } catch (err) {<br/>       return res.badRequest(err);<br/>     }<br/>   },</span></pre><p id="ae54" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在您已经定义了用户类型，为它定义了查询对象，并将其包含在GraphQLSchema中，您已经准备好<strong class="it hv">编写测试</strong>。</p><p id="1ab9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们假设在您的数据库中有一些用户，剩下唯一要做的事情就是向您的<em class="kf"> GraphQLController </em>发送带有<em class="kf"> supertest </em>的请求，并输出您的查询结果:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="ca78" class="jz ka hu jv b fv kb kc l kd ke">const chai = require('chai');</span><span id="d2e4" class="jz ka hu jv b fv kg kc l kd ke">const expect = chai.expect;<br/>const url = `http://localhost:3001/`;<br/>const request = require('supertest')(url);</span><span id="13d1" class="jz ka hu jv b fv kg kc l kd ke">describe('GraphQL', () =&gt; {<br/>    it('Returns user with id = 10', (done) =&gt; {<br/>        request.post('/graphql')<br/>        .send({ query: '{ user(id: 10) { id name username email } }'})<br/>        .expect(200)<br/>        .end((err,res) =&gt; {<br/>            // res will contain array with one user<br/>            if (err) return done(err);<br/>            res.body.user.should.have.property('id')<br/>            res.body.user.should.have.property('name')<br/>            res.body.user.should.have.property('username')<br/>            res.body.user.should.have.property('email')<br/>            done();<br/>          })<br/>     })</span><span id="b721" class="jz ka hu jv b fv kg kc l kd ke">     it('Returns all users', (done) =&gt; {<br/>         request.post('/graphql')<br/>         .send({ query: '{ user { id name username email } }' })<br/>         .expect(200)<br/>         .end((err, res) =&gt; {<br/>             // res will contain array of all users<br/>             if (err) return done(err);<br/>             // assume there are a 100 users in the database<br/>             res.body.user.should.have.lengthOf(100);<br/>          })<br/>      })<br/>});</span></pre><p id="dc16" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然，柴库提供了更多的选择。</p><p id="6f6c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就这样，我们结束了这篇文章。</p><p id="7550" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">希望你喜欢它，并发现它的信息！</p></div><div class="ab cl kh ki hc kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hn ho hp hq hr"><p id="107b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kf">原载于2018年4月23日</em><a class="ae jp" href="https://kolosek.com/testing-graphql-server/?utm_source=hn" rel="noopener ugc nofollow" target="_blank"><em class="kf">kolosek.com</em></a><em class="kf">。</em></p></div></div>    
</body>
</html>