<html>
<head>
<title>Debugging with Science!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用科学调试！</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/debugging-with-science-24eadafb1f9d?source=collection_archive---------33-----------------------#2018-04-23">https://medium.com/hackernoon/debugging-with-science-24eadafb1f9d?source=collection_archive---------33-----------------------#2018-04-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/2307af0658c1392597c9cf1575a58f79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_f3HIJOyGU1r8417.jpg"/></div></div></figure><p id="258c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">关于你的bug的根本原因，你是在欺骗自己吗？</p><p id="cf94" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我的上一家公司成立之初，我们有一个不为人知的错误，它会周期性地让一个大型流行网站的整个数据中心瘫痪。在已经成功处理了数十亿次交易的代码中，这个错误很难被发现，而且只发生在晚上。更糟糕的是，它偶尔会导致全面停电。我们知道我们必须在第一时间找到并解决问题，这样我们才不会失去一个重要的早期客户。</p><p id="d991" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">以下是我们如何找到漏洞并拯救公司的。</p><h2 id="5a15" class="ka kb hu bd kc kd ke kf kg kh ki kj kk jn kl km kn jr ko kp kq jv kr ks kt ku dt translated">科学的方法</h2><p id="7e17" class="pw-post-body-paragraph jc jd hu je b jf kv jh ji jj kw jl jm jn kx jp jq jr ky jt ju jv kz jx jy jz hn dt translated">为了挽救我们与这位客户的机会，也可能是公司本身的机会，我们只有一次机会来修复这个bug。这意味着没有猜测。我们需要一种严格的科学方法。</p><p id="d8aa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这种方法的第一部分是查看我们的证据:核心转储、回溯、日志消息、数据包数据等。，并制定了一个关于我们的错误来源的假设。这将是我们的<em class="la">根本原因假设</em>。</p><p id="d4ab" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">科学中的一个关键概念是<a class="ae lb" href="https://en.wikipedia.org/wiki/Falsifiability" rel="noopener ugc nofollow" target="_blank">可证伪性</a>。对于某些类型的陈述，比如“所有的天鹅都是白色的”，一个假说的一个反证就足以推翻它。就这样，就一个。如果我看到一只黑天鹅，我需要重新设定我的假设。</p><p id="1b2d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对于我们的bug，如果只有一个数据没有被我们的根本原因假设所解释，我们可能没有找到正确的罪魁祸首…或者至少不是所有的<em class="la">罪魁祸首。这意味着更多的潜在停电。我们要么证明无法解释的数据是伪造的，要么改进我们的根本原因假说来解释它。</em></p><figure class="ld le lf lg fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lc"><img src="../Images/a596056c2064dc8ffe2e2cc9eb2c1bae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*msQ_S58xfFZiVJ1q.jpg"/></div></div></figure><h2 id="ff68" class="ka kb hu bd kc kd ke kf kg kh ki kj kk jn kl km kn jr ko kp kq jv kr ks kt ku dt translated">假设</h2><p id="08aa" class="pw-post-body-paragraph jc jd hu je b jf kv jh ji jj kw jl jm jn kx jp jq jr ky jt ju jv kz jx jy jz hn dt translated">我们的公司LineRate Systems构建了高性能的纯软件负载平衡器。在对这个受欢迎的网站进行概念验证的过程中，事情进展得非常顺利。</p><p id="a636" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">每天早上，客户的运营团队会将负载平衡器投入生产，并开始将其扩展到越来越多的数据中心，直到我们在数百台web服务器前以超过10 Gb/s的生产流量运行。令人兴奋的东西。我们最终与客户建立了足够的信心，是时候进行一些连续测试了，通宵运行。</p><p id="1707" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这就是问题开始的时候。</p><p id="e63c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一天晚上，所有负载平衡进程都卡住了，消耗了100%的CPU。重大停电、愤怒的客户和令人沮丧的挫折。</p><p id="7004" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们又回到了只有白天的测试。我们对系统进行了测试，以记录故障发生的时间，并添加了一个看门狗来转储违规进程的核心，以便我们可以分析故障。与此同时，启动了一个新的进程来保持系统运行。</p><figure class="ld le lf lg fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lh"><img src="../Images/dc92bad945019f6d32f1320857061add.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kSpRhUu3yXWkD2v-.jpg"/></div></div></figure><h2 id="87f1" class="ka kb hu bd kc kd ke kf kg kh ki kj kk jn kl km kn jr ko kp kq jv kr ks kt ku dt translated">只在夜间活动的虫子</h2><p id="0f9b" class="pw-post-body-paragraph jc jd hu je b jf kv jh ji jj kw jl jm jn kx jp jq jr ky jt ju jv kz jx jy jz hn dt translated">奇怪的是，在任何白天的测试中，我们都没有看到失败。所以，有了新的看门狗，我们又开始了夜间测试。(耐心和宽容的早期客户价值连城。)果然，我们开始看到进程在100% CPU挂起后被看门狗杀死。至少这一次，这仅仅导致了一些连接丢失，但是没有大的中断。</p><p id="47f6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在收集了核心转储和数百Gb的数据包捕获之后(记住，在10 Gb/s的速度下，每秒钟可以获得大约1 GB的数据包数据)，我们开始了我们的分析。核心转储表明我们陷入了HTTP解析器内部的无限循环。然而，这段代码此时已经成功处理了数十亿个HTTP请求，所以问题是，“为什么现在失败了，为什么只在晚上失败？”</p><p id="335a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，艰苦的工作开始了。我们构建了一个工具来查找在某个时间窗口内没有响应的HTTP请求，因为这是一个进程可能已经挂起并且没有响应的线索。几个小时后，该工具开始吐出数据包序列…而且，它们看起来都一样。</p><p id="555a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">找到了。我们希望找到确凿的证据。原来，每次负载平衡器无法响应传入的HTTP请求时，HTTP头都相当大，并且有几十个额外的<code class="eh li lj lk ll b">NOKIA-</code>头。在通过解析器重放这些头之后，我们能够确定大的头是通过慢速网络链接进入的，因此很可能在正确的位置出现缓冲区中断，从而触发解析器错误，无法推进缓冲区指针。这导致解析器一遍又一遍地查看同一个字节，导致100%的CPU使用率。</p><p id="9e35" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这成了我们的根本原因假说。</p><figure class="ld le lf lg fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lc"><img src="../Images/829bc60ed6fa59ebfc320a59d593bf4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*L41w4uZgbrQwGQuq.jpg"/></div></div></figure><h2 id="c652" class="ka kb hu bd kc kd ke kf kg kh ki kj kk jn kl km kn jr ko kp kq jv kr ks kt ku dt translated">该死的科学</h2><p id="d306" class="pw-post-body-paragraph jc jd hu je b jf kv jh ji jj kw jl jm jn kx jp jq jr ky jt ju jv kz jx jy jz hn dt translated">这一切都很有希望，但我们无法解释为什么这种情况只发生在夜间，而不是白天。请记住，我们必须解释<em class="la">所有</em>的数据，否则我们可能无法正确地解决问题，并且我们会以一个非常愤怒的客户和信誉的巨大损失而告终。</p><p id="e28f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">幸运的是，在与分配到我们项目的客户运营团队进行头脑风暴后，我们提出了一个令人满意的解释。所有失败的请求都来自连接到诺基亚基站的手机，我们可以从他们添加的HTTP报头膨胀中推断出来。此外，对于失败的情况，连接延迟和分组间延迟非常高。</p><p id="51ce" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在美国，很少有诺基亚基站，如果有的话。然而，早在2011年，亚洲的主要运营商都在使用诺基亚基站。快速检查违规HTTP请求的来源IP地址确实都来自亚洲，尤其是印度。</p><p id="677c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">就在那里。如果所有的违规流量都来自印度，这就可以解释当时(以及今天)的互联网状况下的高延迟和可变的数据包到达间隔时间。这也解释了为什么我们只在晚上看到令人不快的请求——在印度是白天。</p><p id="4c57" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对我们的数据包分析产生的所有违规请求的时间戳的快速查看显示，它们发生在印度和东南亚的使用高峰期。并且时间也对应于IP地址位置估计。我们解释了所有的数据。科学！</p><h2 id="57c3" class="ka kb hu bd kc kd ke kf kg kh ki kj kk jn kl km kn jr ko kp kq jv kr ks kt ku dt translated">结论</h2><p id="ffbc" class="pw-post-body-paragraph jc jd hu je b jf kv jh ji jj kw jl jm jn kx jp jq jr ky jt ju jv kz jx jy jz hn dt translated">好消息是，如果你在运营一项由你的公司控制运营的服务，你也许可以不用解释所有深奥的数据。但是你应该小心，因为你的修复可能只会掩盖真正的问题，使它不太可能发生。因此，它会静静地潜伏着，等待着造成网站范围的中断。</p><p id="e280" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我们的情况下，我们别无选择。在公司早期，我们只有几次机会接近客户。我们的软件绝对是关键任务，我们无法控制部署时间表。</p><p id="3093" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">幸运的是，调试失败的好的科学方法和好的工程实践会带来好的结果。我们甚至在客户站点结束了产品，而客户忘记了他们已经在生产中安装了产品。当他们发现疏忽时，系统正常运行时间超过一年，没有监控、操作员干预或停机。哦，那是该产品的测试版。</p><p id="f02a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这就是科学的力量！</p></div><div class="ab cl lm ln hc lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="hn ho hp hq hr"><p id="83a7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="la">原载于</em><a class="ae lb" href="https://unbounded.systems/blog/debugging-with-science/" rel="noopener ugc nofollow" target="_blank"><em class="la"/></a><em class="la">。</em></p></div></div>    
</body>
</html>