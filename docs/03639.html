<html>
<head>
<title>Erlang Serpents</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">二郎大蛇</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/erlang-serpents-3eca35bf7c6d?source=collection_archive---------10-----------------------#2018-04-26">https://medium.com/hackernoon/erlang-serpents-3eca35bf7c6d?source=collection_archive---------10-----------------------#2018-04-26</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="1e03" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由布鲁约·贝纳维德斯</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/b4f02d361ac228fae41c1c9c6d71cd84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sPL3IwYCTk-MAftTSR5nOQ.png"/></div></div></figure><h1 id="6c1f" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">放弃</h1><p id="5553" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated"><strong class="it hv">做好准备……一封长信就要来了。</strong></p><p id="3e8e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我花了很长时间写这篇博文，主要原因是它包含了许多不同的主题。这将是一篇关于</p><ul class=""><li id="d9df" class="lf lg hu it b iu iv iy iz jc lh jg li jk lj jo lk ll lm ln dt translated">黑客马拉松</li><li id="5f48" class="lf lg hu it b iu lo iy lp jc lq jg lr jk ls jo lk ll lm ln dt translated">TimeDivisionDuplex 时分双工</li><li id="b4e8" class="lf lg hu it b iu lo iy lp jc lq jg lr jk ls jo lk ll lm ln dt translated">游戏开发</li><li id="8d42" class="lf lg hu it b iu lo iy lp jc lq jg lr jk ls jo lk ll lm ln dt translated">函数式语言中的数据类型抽象</li><li id="95fb" class="lf lg hu it b iu lo iy lp jc lq jg lr jk ls jo lk ll lm ln dt translated">占线小时</li><li id="8645" class="lf lg hu it b iu lo iy lp jc lq jg lr jk ls jo lk ll lm ln dt translated">位串语法</li><li id="de76" class="lf lg hu it b iu lo iy lp jc lq jg lr jk ls jo lk ll lm ln dt translated">RESTful APIs</li><li id="9988" class="lf lg hu it b iu lo iy lp jc lq jg lr jk ls jo lk ll lm ln dt translated">多种工具，如牛仔，混合器，步道，招摇，lasse等。</li></ul><h1 id="c7da" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">历史</h1><p id="524c" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">很久以前，当我还是个孩子的时候，我开始用<a class="ae jp" href="https://en.wikipedia.org/wiki/QBasic" rel="noopener ugc nofollow" target="_blank"> QBasic </a>编程，正如你们很多人可能知道的，QBasic附带了两个小游戏。其中一个是小点心</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff lt"><img src="../Images/acc622642611dfab7bb3c558f76c6eba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*t5p_h_WVcywBWaGy.jpg"/></div></div></figure><p id="a428" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">快进25年……你会发现我在Erlang Solutions，在Roberto Romero和Hernán Rivas Acosta的帮助下，试图为我们的下一次<strong class="it hv">黑客马拉松</strong>提出主题。我们想要一个可以在一个屏幕上观看的多人游戏。<em class="lu">当然</em>我们想出了<a class="ae jp" href="https://github.com/inaka/serpents" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">大蛇</strong> </a>！</p><h1 id="00d1" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">黑客马拉松</h1><p id="5c83" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">每年在Erlang Solutions，我们都会从项目中抽出一天时间，一起庆祝我们最喜欢的事情:<em class="lu">编程</em>。2014年，我们举办了一场<em class="lu">“仅在一天内构建您的应用”</em>竞赛，结果令人惊叹。对于2015年版，我们决定推出一款多人游戏，组织者设置服务器，团队开发客户端。我将在这篇博文的其余部分展示的代码，都来自Hernán、Roberto和我自己开发的游戏服务器。</p><h1 id="1005" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">目标</h1><p id="17ec" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">蛇的主要目标当然是用于黑客马拉松。但我对此也有一个隐藏的议程:由于这个项目将在github上开源，我想用它作为一个案例来展示我们是如何工作的。我希望能够让人们在IRC、erlang-questions、reddit、stackoverflow等网站上交流。会问类似“嘿！如何在Erlang中构建web服务器？”告诉他们“看这里。你就是这么干的！”。考虑到这一点，我们把这个项目当作一个客户项目来面对，结果，我们的<em class="lu">客户</em>(我们的开发伙伴)实际上是我们曾经面对过的最难对付的客户之一。</p><h1 id="2a2e" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">体系结构</h1><p id="fee1" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">那么，我们如何为一个大蛇的游戏建立一个多人游戏服务器呢？我们首先将其分为3个主要部分:</p><ul class=""><li id="e7bf" class="lf lg hu it b iu iv iy iz jc lh jg li jk lj jo lk ll lm ln dt translated">显示游戏进程的网页。</li><li id="de98" class="lf lg hu it b iu lo iy lp jc lq jg lr jk ls jo lk ll lm ln dt translated">一个网络服务器，为网页提供服务，并为其提供RESTful API，以便在<em class="lu">实时更新</em>。</li><li id="2a87" class="lf lg hu it b iu lo iy lp jc lq jg lr jk ls jo lk ll lm ln dt translated">为客户端提供连接方式的游戏服务器。</li></ul><p id="4b2d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于网页，我们使用了普通的HTML和一些Javascript(你至少可以看出我对此并不感兴趣:P)。<strong class="it hv">有趣的是</strong>的实时<em class="lu">部分。我们在<a class="ae jp" href="http://www.w3.org/TR/eventsource/" rel="noopener ugc nofollow" target="_blank"> SSE </a>上实现了那个(就像我们通常做的那样)。在一场比赛中，网站看起来是这样的:</em></p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff lv"><img src="../Images/c57906b428e96f3ff9152dbead6020f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/0*v5w4VJWp_yA5If45.png"/></div></figure><p id="f470" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">从服务器的角度来看，我们使用<a class="ae jp" href="https://github.com/ninenines/cowboy" rel="noopener ugc nofollow" target="_blank"> cowboy </a>在<a class="ae jp" href="https://github.com/inaka/cowboy-trails" rel="noopener ugc nofollow" target="_blank"> trails </a>上实现了RESTful API，并用<a class="ae jp" href="https://github.com/inaka/cowboy-swagger" rel="noopener ugc nofollow" target="_blank"> swagger </a>对其进行了记录。结果是这样的:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff lw"><img src="../Images/1c8452458780f27deeb3215f490ca513.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/0*rCseFHVnC7MLpmHB.png"/></div></figure><p id="b08c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">另一方面，我们决定给客户端devs 2选项。他们可以使用相同的RESTful API和SSE连接与服务器通信，或者他们可以使用我们的<a class="ae jp" href="https://github.com/inaka/serpents/blob/master/HDP.md" rel="noopener ugc nofollow" target="_blank"> HDP </a>协议。</p><p id="e3b6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">HDP 是一种运行在UDP上的速度惊人的协议。它是由埃尔南开发的，并以<em class="lu">卡夫卡风格</em>记录下来，供所有人使用。它是专门为serpents开发的，但是可以很容易地在其他项目中复制。</p><h1 id="aa30" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">内部架构</h1><p id="6cf3" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">在内部，正如你在github上看到的，代码被分成多个文件夹和多个模块，我们可以单独测试。</p><p id="f365" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一方面，我们有游戏的基本构建模块:规则(在<code class="eh lx ly lz ma b">spts_core</code>中)被实现为每个游戏的<code class="eh lx ly lz ma b">gen_fsm</code>及其实体(表示为<em class="lu">数据类型</em>或<em class="lu">模型</em>，每个都有自己的模块和不透明类型)。你可以在<code class="eh lx ly lz ma b">spts_serpents</code>看到我们的方法:</p><pre class="jr js jt ju fq mb ma mc md aw me dt"><span id="1d2e" class="mf kd hu ma b fv mg mh l mi mj">%%% @doc Serpent model<br/>-module(spts_serpents).<br/>-author('elbrujohalcon@inaka.net').<br/><br/>-type status() :: alive | dead.<br/>-type name() :: binary().<br/>-opaque serpent() ::<br/>    #{ name       =&gt; name()<br/>     , numeric_id =&gt; pos_integer()<br/>     , token      =&gt; binary()<br/>     , body       =&gt; [spts_games:position()]<br/>     , direction  =&gt; spts_games:direction()<br/>     , food       =&gt; pos_integer()<br/>     , status     =&gt; status()<br/>     }.<br/>-export_type([serpent/0, status/0, name/0]).<br/><br/>-export([new/6]).<br/>-export([ name/1<br/>        , numeric_id/1<br/>        , direction/1<br/>        , direction/2<br/>        , to_json/1<br/>        , to_json/2<br/>        , to_binary/2<br/>        % ...<br/>        ]).<br/><br/>-spec name(serpent()) -&gt; name().<br/>name(#{name := Name}) -&gt; Name.<br/><br/>-spec direction(<br/>        serpent(), spts_games:direction()) -&gt;<br/>        serpent().<br/>direction(Serpent, Direction) -&gt;<br/>    Serpent#{direction := Direction}.<br/><br/>% ...</span></pre><p id="e0b3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们还为API的不同端点提供了多个牛仔处理程序。它们都是使用<em class="lu">混音器</em>从<code class="eh lx ly lz ma b">spts_base_handler</code>中“继承”功能而构建的。</p><pre class="jr js jt ju fq mb ma mc md aw me dt"><span id="deb0" class="mf kd hu ma b fv mg mh l mi mj">%%% @doc /games/:game_id/serpents handler<br/>-module(spts_serpents_handler).<br/>-author('elbrujohalcon@inaka.net').<br/><br/>-include_lib("mixer/include/mixer.hrl").<br/>-mixin([{ spts_base_handler<br/>        , [ init/3<br/>          , rest_init/2<br/>          , allowed_methods/2<br/>          , content_types_accepted/2<br/>          , content_types_provided/2<br/>          , resource_exists/2<br/>          ]<br/>        }]).<br/><br/>-export([ handle_post/2<br/>        , trails/0<br/>        ]).<br/><br/>-type state() :: spts_base_handler:state().<br/><br/>-behaviour(trails_handler).<br/><br/>-spec trails() -&gt; trails:trails().<br/>trails() -&gt;<br/>  Metadata =<br/>    #{ post =&gt;<br/>       #{ tags =&gt; ["serpents"]<br/>        , description =&gt;<br/>            "Adds a serpent to a game"<br/>        , consumes =&gt; ["application/json"]<br/>        , produces =&gt; ["application/json"]<br/>        , parameters =&gt;<br/>            [ spts_web:param(request_body)<br/>            , spts_web:param(game_id)<br/>            ]<br/>        }<br/>     },<br/>  Path = "/api/games/:game_id/serpents",<br/>  Opts = #{path =&gt; Path},<br/>  [trails:trail(Path, ?MODULE, Opts, Metadata)].<br/><br/>% ...</span></pre><p id="2b5a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了从核心向SSE或HDP客户端报告事件，我们使用了<code class="eh lx ly lz ma b">gen_event</code>，但是为了方便起见，我们实现了一个简单的<code class="eh lx ly lz ma b">gen_event</code>处理程序，反过来，只需要在您的客户端中实现一个函数:<code class="eh lx ly lz ma b">notify(pid(), event())</code>。我们称之为<code class="eh lx ly lz ma b"><a class="ae jp" href="https://github.com/inaka/serpents/blob/master/src/spts_gen_event_handler.erl" rel="noopener ugc nofollow" target="_blank">spts_gen_event_handler</a></code>。我们使用相同的处理程序为核心编写测试，而不依赖于任何类型的客户端。</p><p id="c321" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于HDP，我们编写了一个异步UDP监听器，它为每个<em class="lu">连接</em>的客户端启动一个<code class="eh lx ly lz ma b">gen_server</code>(UDP中没有实际的连接)。简单的原因在于我们将所有的协议解析/验证逻辑抽象到它自己的模块:<code class="eh lx ly lz ma b">spts_hdp</code>。这个模块本身就是Erlang的<a class="ae jp" href="http://www.erlang.org/documentation/doc-5.6/doc/programming_examples/bit_syntax.html" rel="noopener ugc nofollow" target="_blank">位语法</a>的一个很好的例子。它展示了列表理解，结合了二进制理解和许多惊人的二进制模式匹配表达式。我最喜欢的:</p><pre class="jr js jt ju fq mb ma mc md aw me dt"><span id="c066" class="mf kd hu ma b fv mg mh l mi mj">%% @doc Parses a list of serpent diffs.<br/>%%      Each one includes the serpent id and the<br/>%%      length of its body, followed by each of<br/>%%      the body cells.<br/>parse_diff_serpents(0, Next, Acc) -&gt;<br/>  {lists:reverse(Acc), Next};<br/>parse_diff_serpents(<br/>  N,<br/>  &lt;&lt; SerpentId:?UINT<br/>   , BodyLength:?USHORT<br/>   , Body1:BodyLength/binary<br/>   , Body2:BodyLength/binary<br/>   , Next/binary<br/>   &gt;&gt;,<br/>  Acc) -&gt;<br/>  Body = &lt;&lt;Body1/binary, Body2/binary&gt;&gt;,<br/>  Serpent =<br/>    #{ id =&gt; SerpentId<br/>     , body =&gt;<br/>         [ {Row, Col}<br/>         || &lt;&lt;Row:?UCHAR, Col:?UCHAR&gt;&gt; &lt;= Body]<br/>     },<br/>  parse_diff_serpents(N-1, Next, [Serpent|Acc]).</span></pre><h1 id="519d" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">开发方法学</h1><p id="7492" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">为了创建所有这些，我们使用了我们通常的方法:<strong class="it hv"> TDD </strong>。为此我们与<code class="eh lx ly lz ma b">common_test</code>一起工作，你可以在这里看到我们实现的<a class="ae jp" href="https://github.com/inaka/serpents/tree/master/test" rel="noopener ugc nofollow" target="_blank">的测试套件列表。我们已经写了很多关于TDD、代码覆盖甚至元测试的博文，所以我在这里不再赘述。请记住，如果你需要这些东西的例子，这里有很多。</a></p><h1 id="48dd" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">客户</h1><p id="e10f" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">如果你问自己<em class="lu">有没有客户的例子？</em>没错，就是这里的<a class="ae jp" href="https://github.com/inaka/serpents/tree/master/src/clients" rel="noopener ugc nofollow" target="_blank"/>。这些都是我自己开发的，你可以从头开始或者使用<a class="ae jp" href="https://github.com/inaka/serpents/blob/master/src/spts_cli.erl" rel="noopener ugc nofollow" target="_blank"> spts_cli </a>来创建你自己的。</p><h1 id="deb7" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">结果</h1><h1 id="bd81" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">结论</h1><p id="20e4" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">我们最终实现了我的两个目标。一方面，我可以说我们举办了一次非同寻常的黑客马拉松，很多人一边编码一边开心地玩。另一方面，现在我们有了一个很好的例子来展示我们如何在Erlang Solutions中构建东西。你也可以享受它！只是做…</p><pre class="jr js jt ju fq mb ma mc md aw me dt"><span id="cd9d" class="mf kd hu ma b fv mg mh l mi mj">$ git clone https://github.com/inaka/serpents.git<br/>$ cd serpents<br/>$ make<br/>$ _rel/serpents/bin/serpents start</span></pre><p id="3429" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">…并在浏览器中打开<a class="ae jp" href="http://localhost:8585/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8585 </a>开始播放！</p><p id="88fc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然，正如我小时候对小零食所做的那样，最有趣的部分开始于你开始修改代码，让大蛇变得更胖、更瘦，在吃了一个有毒的水果后随机喝醉</p><p id="1045" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">哦，天啊！我<em class="lu">有</em>去实现那个！再见，9岁的我有重要的事情要做…</p></div><div class="ab cl mk ml hc mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hn ho hp hq hr"><p id="b8a7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="lu">原载于2018年4月26日</em><a class="ae jp" href="http://www2.erlang-solutions.com/l/23452/2018-04-26/5g8gvr" rel="noopener ugc nofollow" target="_blank"><em class="lu">www.erlang-solutions.com</em></a><em class="lu">。</em></p><p id="c449" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="lu">这篇博文最初是在2015年11月13日写给inaka.net的。</em> </strong></p></div></div>    
</body>
</html>