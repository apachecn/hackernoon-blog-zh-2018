<html>
<head>
<title>Infrastructure Cost Optimization with Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用Lambda优化基础设施成本</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/infrastructure-cost-optimization-with-lambda-83b4bb733e76?source=collection_archive---------8-----------------------#2018-04-29">https://medium.com/hackernoon/infrastructure-cost-optimization-with-lambda-83b4bb733e76?source=collection_archive---------8-----------------------#2018-04-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/ea466862c19a6cbb26736eee60862993.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kWXs9U-Dwuvjri9oTUk-OA.jpeg"/></div></div></figure><p id="30cf" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">拥有多个环境对于构建持续的集成/部署管道非常重要，并且能够轻松地在生产中重现bug，但这是有代价的。为了降低AWS基础设施的成本，不必要地全天候运行的实例(<strong class="je hv">沙盒</strong> &amp; <strong class="je hv">分级</strong>环境)必须在正常工作时间之外关闭。</p><p id="60e9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">下图描述了调度、停止和启动实例以帮助削减成本的自动化流程。这个解决方案是使用<strong class="je hv">无服务器计算</strong>的完美例子。</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ka"><img src="../Images/2d9f71542cba7b2fbbbfd2eb92ced5d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wq1p8S7Zc6sOewlJFdEnwg.png"/></div></div></figure><p id="1afa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注意:我的<a class="ae kf" href="https://github.com/mlabouardy/cost-optimization" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上有完整的代码。</p><p id="ddd7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">2 Lambda函数将被创建，它们将扫描所有环境寻找特定的标签。我们使用的标签命名为<em class="kg"> ' </em> <strong class="je hv"> <em class="kg">环境</em> </strong> <em class="kg"> ' </em>。没有<strong class="je hv"> <em class="kg">环境</em> </strong>标签的实例不会受到影响:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="947c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv"> StartEnvironment </strong>函数将使用前一个函数返回的实例id列表查询<strong class="je hv"> StartInstances </strong>方法:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="df02" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">类似地，<strong class="je hv"> StopEnvironment </strong>函数将查询<strong class="je hv"> StopInstances </strong>方法:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="634f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最后，两个功能都将向<strong class="je hv"> Slack </strong>通道发布一条消息，用于实时通知:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="06cb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在我们的函数已经定义好了，让我们使用下面的Bash脚本来构建部署包(<em class="kg"> zip </em>文件):</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="33f0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这些功能需要一个<strong class="je hv"> IAM </strong>角色才能与<strong class="je hv"> EC2 </strong>交互。StartEnvironment函数必须能够描述和<em class="kg"> start </em> EC2实例:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="7e82" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">StopEnvironment函数必须能够<em class="kg">描述</em>和<em class="kg"> stop </em> EC2实例:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="1555" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最后，为每个功能创建一个IAM角色，并附加上述策略:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="1cb9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该脚本将为每个IAM角色输出<strong class="je hv"> ARN </strong>:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kj"><img src="../Images/1173ec165e99e502710844ab9b012be5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vKoGQwKbRT2v0OC7k_gUUQ.png"/></div></div></figure><p id="1172" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在跳转到部署部分之前，我们需要创建一个<a class="ae kf" href="https://my.slack.com/services/new/incoming-webhook/" rel="noopener ugc nofollow" target="_blank"> Slack WebHook </a>来将消息发布到Slack channel:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kk"><img src="../Images/2698d93b427c735a438a879c943459bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4o5gkMzVwFqrCIjBJqwy7Q.png"/></div></div></figure><p id="e07b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，使用以下脚本将您的函数部署到<strong class="je hv"> AWS Lambda </strong>(确保替换IAM角色，Slack WebHook令牌&amp;目标环境):</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="b817" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">部署完成后，如果您登录到<a class="ae kf" href="http://console.aws.amazon.com/console/home" rel="noopener ugc nofollow" target="_blank"> AWS管理控制台</a>，导航到Lambda控制台，您应该会看到两个功能都已成功部署:</p><p id="63aa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">启动环境:</strong></p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kl"><img src="../Images/5d5fa3d378fcf4d6e7fb4d1665fae615.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ejkQfrUjVJKc8C45DRWM3A.png"/></div></div></figure><p id="4ce3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">停止环境:</strong></p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff km"><img src="../Images/c224389ca3fa690d61734cc80fb1935b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*59NMitvf57QVdjVKJ79sPw.png"/></div></div></figure><p id="f8e7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">以进一步自动化在正确的时间调用Lambda函数的过程。将使用AWS <strong class="je hv"> CloudWatch预定事件</strong>。</p><p id="df6d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用下面的<em class="kg"> cron </em>表达式创建一个新的CloudWatch规则(它将在每天上午9点被调用):</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kn"><img src="../Images/5066a8097ffb3442c143beaae41e55bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x04ekKEVFJnJPoe6OoRZ0A.png"/></div></div></figure><p id="7d51" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">以及另一个在下午6点停止环境的规则:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ko"><img src="../Images/a46968605730c928d20a64533038c671.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CFEVsycfSBhh71bIgYgNKQ.png"/></div></div></figure><p id="94b0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注:所有时间都是GMT时间。</p><p id="48c1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">测试:</strong></p><p id="41a7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv"> a —停止环境</strong></p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div class="fe ff kp"><img src="../Images/1a449fb093da4a1181bcfddcd41c8818.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*28Ih4crWNlqO6-wtaS_dDA.png"/></div></figure><p id="a56a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">结果:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kq"><img src="../Images/9c1ac61ebe884324310d66462db2d1ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*md_uLj6HAn9-GL0yqVnLAQ.png"/></div></div></figure><p id="6125" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv"> b —启动环境</strong></p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div class="fe ff kp"><img src="../Images/787fdde5f0b5e6d09c7881b61aa1894e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*UQt5Xb9QkEAhgYKlm-N7dw.png"/></div></figure><p id="1991" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">结果:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kr"><img src="../Images/e53b7a7b21f926f0dec5641d64e326a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MB8l8mrlMTZpU-cwqS8d0A.png"/></div></div></figure><p id="5452" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该解决方案易于部署，有助于降低运营成本。</p><p id="72d3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="kg">完整代码可以在我的</em><a class="ae kf" href="https://github.com/mlabouardy/cost-optimization" rel="noopener ugc nofollow" target="_blank"><em class="kg">GitHub</em></a><em class="kg">上找到。请务必在下面留下您的评论、反馈或建议，或者直接在Twitter上与我联系</em><a class="ae kf" href="https://twitter.com/mlabouardy" rel="noopener ugc nofollow" target="_blank"><strong class="je hv"><em class="kg">@</em></strong><em class="kg">mlabouardy</em></a><em class="kg">。</em></p></div></div>    
</body>
</html>