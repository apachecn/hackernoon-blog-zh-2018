<html>
<head>
<title>Keeping your connections alive — A Clojure - Redis story</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保持人脉——clo jure-Redis的故事</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/keeping-your-connections-alive-a-clojure-redis-story-3b226b91a3d5?source=collection_archive---------7-----------------------#2018-05-06">https://medium.com/hackernoon/keeping-your-connections-alive-a-clojure-redis-story-3b226b91a3d5?source=collection_archive---------7-----------------------#2018-05-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/d23404d6001bbac1854cadb164f0b5ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vJ4LAe8s5v5ETpq0NN85zA.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Created with https://canva.com</figcaption></figure><p id="a298" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">双关语肯定是有意的，保持一些<a class="ae ke" href="https://hackernoon.com/tagged/connections" rel="noopener ugc nofollow" target="_blank">联系</a>是现实和生产中健康生活的必要条件。</p><p id="1587" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">Redis Pubsub非常棒，还有瑞士军刀风格的<a class="ae ke" href="https://github.com/ptaoussanis/carmine" rel="noopener ugc nofollow" target="_blank">Carmine——全Clojure Redis客户端</a> ( <a class="ae ke" href="https://hackernoon.com/tagged/clojure" rel="noopener ugc nofollow" target="_blank"> Clojure </a>就像我们在<a class="kf kg gr" href="https://medium.com/u/5b9405a30408?source=post_page-----3b226b91a3d5--------------------------------" rel="noopener" target="_blank"> Swym </a>喜欢我们的函数lispy:)。Redis标准<a class="ae ke" href="https://redis.io/topics/clients" rel="noopener ugc nofollow" target="_blank">文档</a>可以解释为Pubsub连接是不朽的，这意味着它们可以在长时间空闲后继续存在。</p><figure class="ki kj kk kl fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kh"><img src="../Images/57f563077a07f1e07e79b675213906df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*stasFcvMkhTILnNdBQL7NA.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Source — <a class="ae ke" href="https://redis.io/topics/clients" rel="noopener ugc nofollow" target="_blank">https://redis.io/topics/clients</a></figcaption></figure><p id="baf4" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">听起来是个完美的故事。就像每一个完美的故事一样，它并不完美:/，一个悖论。Redis客户端连接一直是众多讨论的主题，跨越技术栈(问题链接在帖子底部)。</p><ol class=""><li id="9030" class="km kn hu ji b jj jk jn jo jr ko jv kp jz kq kd kr ks kt ku dt translated">一个人如何确保他们的Pubsub客户的长期关系或永恒关系？</li><li id="f36e" class="km kn hu ji b jj kv jn kw jr kx jv ky jz kz kd kr ks kt ku dt translated">在客户端连接的意义上，如何回收连接而不占用内存？</li><li id="43d5" class="km kn hu ji b jj kv jn kw jr kx jv ky jz kz kd kr ks kt ku dt translated">处理这种情况的最佳配置是什么？我们肯定不是这个星球上唯一遇到这种情况的人</li></ol><p id="e5e4" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在<a class="kf kg gr" href="https://medium.com/u/5b9405a30408?source=post_page-----3b226b91a3d5--------------------------------" rel="noopener" target="_blank"> Swym，</a>我们有这样的场景，Redis Pubsub推出事件主要是为了清除任何缓存的数据。缓存分布在负载平衡的服务中。因此，事件需要到达服务的最深处，以便<em class="la">真正</em>清除所有相关数据。</p><p id="8a12" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这就是症结所在。</p><p id="9856" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">所以它的健康至关重要。由于Azure上的Redis服务出现了一些令人费解的问题，我们的Pubsub连接将会因为“不”的原因而消亡。理想情况下，我们希望在它们倒下时得到提醒，这样就可以做些什么，或者更好，尽可能地让它们活着。</p><h1 id="881f" class="lb lc hu bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">你还活着吗？</h1><p id="cf2b" class="pw-post-body-paragraph jg jh hu ji b jj lz jl jm jn ma jp jq jr mb jt ju jv mc jx jy jz md kb kc kd hn dt translated">根据客户端的说法，连接是活动的。<br/>根据Redis服务器，连接是活跃的，但不是真的。</p><p id="8d49" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这里有一个例子</p><figure class="ki kj kk kl fq iv fe ff paragraph-image"><div class="fe ff me"><img src="../Images/d499accd5a2be0a6150f80af589bd687.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*FOCXZUojdL8Q4C2HZC3qNg.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Client state 1</figcaption></figure><figure class="ki kj kk kl fq iv fe ff paragraph-image"><div class="fe ff mf"><img src="../Images/0d40d6e242a9f098c18aa9931597bbe6.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*ACyWMVdtaR2IucPAtCa2BQ.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Publish 1</figcaption></figure><figure class="ki kj kk kl fq iv fe ff paragraph-image"><div class="fe ff mg"><img src="../Images/2c737d0944f1c708d438406dae1ed4ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:528/format:webp/1*YKvHbrAFVypxvE7dy2Zs2g.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Subscriber 1</figcaption></figure><blockquote class="mh"><p id="e744" class="mi mj hu bd mk ml mm mn mo mp mq kd ek translated"><strong class="ak"> …几分钟后… </strong></p></blockquote><figure class="mr ms mt mu mv iv fe ff paragraph-image"><div class="fe ff me"><img src="../Images/c69cfa3152efe1cbc13d877f18a2b5f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*QjkBJBOB8d7v0PAgfVfNCQ.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Connection state 2</figcaption></figure><figure class="ki kj kk kl fq iv fe ff paragraph-image"><div class="fe ff mw"><img src="../Images/ff18ec23f3d91ece542e6f76d5ccd1b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*zwN-kqM77YogRm-J3M-n-g.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Publish 2</figcaption></figure><figure class="ki kj kk kl fq iv fe ff paragraph-image"><div class="fe ff mx"><img src="../Images/0cc3e9419797389d9742f2bd868aced1.png" data-original-src="https://miro.medium.com/v2/resize:fit:610/format:webp/1*nVPRzPzwxJrBu9d6UEdlHQ.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Subscriber 2 — nope, can’t hear you</figcaption></figure><p id="a07c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">另一种情况是，当Redis集群使用辅助碎片时，会导致以前的连接无效，或者Redis实例决定重新启动。</p><p id="db37" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">所以我们有两个主要问题</p><ol class=""><li id="39ec" class="km kn hu ji b jj jk jn jo jr ko jv kp jz kq kd kr ks kt ku dt translated">在大多数情况下，连接失败不会被通知为“错误”。<br/>这些是系统故障，应该报告给devops/tools，以便采取措施解决</li><li id="f44f" class="km kn hu ji b jj kv jn kw jr kx jv ky jz kz kd kr ks kt ku dt translated">连接不应该因为空闲而失败。<br/>连接应在无线电静默期间继续存在，减少失效连接的数量(读1)。</li></ol><p id="f5e0" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">管理TCP超时的一个潜在方法是将<code class="eh my mz na nb b">tcp-keepalive</code>设置为某个合理的值，而不是默认值(在我的例子中是300)。&gt;<a class="ae ke" href="https://github.com/antirez/redis/issues/1810" rel="noopener ugc nofollow" target="_blank">https://github.com/antirez/redis/issues/1810,</a>但是正如你在截图中看到的，连接“存在”于322，也许我的客户端TCP也需要配置。这似乎是一个配置问题，是吗？</p><h1 id="9cdf" class="lb lc hu bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">使用源</h1><p id="273e" class="pw-post-body-paragraph jg jh hu ji b jj lz jl jm jn ma jp jq jr mb jt ju jv mc jx jy jz md kb kc kd hn dt translated">Carmine是一个很棒的图书馆，里面有你能想到的所有东西，并且要感谢Peter Taoensso把这么棒的Clojure放在那里。就像尤达大师建议的那样，我从阅读原始资料开始(愿他的记忆比这些redis连接更长久:/)。我很高兴在源代码中看到一些未解决的问题和代码。</p><p id="e478" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这个问题已经讨论多年了。所以，很自然地，这是一个让我卷起袖子想办法的机会。redis(3.2+版)已经在Pubsub连接上“PING”了一段时间。这意味着可以通过一系列心跳pings来管理连接空闲时间。</p><p id="cbeb" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">卡明的<code class="eh my mz na nb b">with-pubsub-new-listener</code>是这样工作的</p><ol class=""><li id="6cac" class="km kn hu ji b jj jk jn jo jr ko jv kp jz kq kd kr ks kt ku dt translated">用一个<code class="eh my mz na nb b">future-call</code>启动一个长时间运行的线程来轮询连接套接字流</li><li id="5ba5" class="km kn hu ji b jj kv jn kw jr kx jv ky jz kz kd kr ks kt ku dt translated">当收到回复时，将其传递回消息处理程序。</li></ol><p id="5a42" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这有一个很大的问题——因为Clojure future在执行线程中捕获错误，并且不通知任何人，除非另一个线程试图实现future。在这种情况下，除非出现套接字读取/超时错误，否则future永远不会完成评估。这需要一个及时的民调来检查未来的评价状态。这里有一些代码来说明，</p><pre class="ki kj kk kl fq nc nb nd ne aw nf dt"><span id="96bb" class="ng lc hu nb b fv nh ni l nj nk">(require '[taoensso.carmine :as car])<br/>;(def conn-spec {:host "localhost" :port 6379}) ;; replace with your spec<br/>(def l (car/with-new-pubsub-listener conn-spec {"ps-foo" #(println %)} (car/subscribe "ps-foo")))<br/>(realized? (:future l))<br/>; false</span><span id="00e3" class="ng lc hu nb b fv nl ni l nj nk">(def l-status (future (while (not (realized? (:future l)))<br/>  (println "realized" (:future l)))))<br/>;;realized #object[clojure.core$future_call$reify__6962 0x154a8d5 {:status :pending, :val nil}]</span><span id="7080" class="ng lc hu nb b fv nl ni l nj nk">;;...... A lot of logs later ......</span><span id="c673" class="ng lc hu nb b fv nl ni l nj nk">;;realized #object[clojure.core$future_call$reify__6962 0x154a8d5 {:status :failed, :val #error {<br/>; :cause nil<br/>; :via<br/>; [{:type java.util.concurrent.ExecutionException<br/>;   :message java.io.EOFException<br/>;   :at [java.util.concurrent.FutureTask report FutureTask.java 122]}<br/>;  {:type java.io.EOFException<br/>;   :message nil<br/>;   :at [java.io.DataInputStream readByte DataInputStream.java 267]}]<br/>; :trace<br/>; [... &lt;&lt;truncated&gt;&gt; ...]}}]<br/>;;</span></pre><p id="ef78" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这听起来不像是对CPU周期的最佳利用。所以首先，在<code class="eh my mz na nb b">future-call</code>中添加一个回调错误处理程序的方法——这将允许终端客户端得到连接失败的通知，并基于异常重试。</p><p id="1cf9" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">接下来，添加一个未来的PING调用，以防在指定的超时(conn-spec中的<code class="eh my mz na nb b">ping-ms</code>，默认为30秒)后没有收到消息。当连接空闲时添加及时的心跳。</p><p id="95a1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">有了这两个地方(<a class="ae ke" href="https://github.com/aravindbaskaran/redis-pubsub" rel="noopener ugc nofollow" target="_blank">使用我的新库</a>:))，下面是它的样子，</p><pre class="ki kj kk kl fq nc nb nd ne aw nf dt"><span id="bffb" class="ng lc hu nb b fv nh ni l nj nk">(require '[taoensso.carmine :as car])<br/>(require '[redis-pubsub.core :as pubsub])<br/>(def keepalive-l (<strong class="nb hv">pubsub/with-new-keepalive-pubsub-listener</strong><br/>  conn-spec<br/>  {<br/>    "ps-foo" #(println %)<br/>    "pubsub:ping" #(println "ping" %)<br/>    "pubsub:listener:fail" #(println "listener failed - add try again" %)}<br/>  (car/subscribe "ps-foo")))</span><span id="cde1" class="ng lc hu nb b fv nl ni l nj nk">;; prints ping [pong pubsub:ping] after 30 seconds of idleness</span><span id="5ca4" class="ng lc hu nb b fv nl ni l nj nk">;; When listener fails, immediately a callback is fired<br/>; listener failed - add try again [pubsub:error pubsub:listener:fail #error {<br/>; :cause nil<br/>; :via<br/>; [{:type java.io.EOFException<br/>;   :message nil<br/>;   :at [java.io.DataInputStream readByte DataInputStream.java 267]}]<br/>; :trace<br/>; [... &lt;&lt;truncated&gt;&gt; ...]}]</span></pre><p id="ef7c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">成功运行测试用例后，是时候与其他人分享优点了。有一个<a class="ae ke" href="https://github.com/ptaoussanis/carmine/pull/207" rel="noopener ugc nofollow" target="_blank"> Pull请求</a>在主库项目上打开，但这可能需要一段时间，因为我可能已经破坏了其他更深层次的测试用例(我希望没有)。所以这是一个附加库(<a class="ae ke" href="https://clojars.org/com.aravindbaskaran/redis-pubsub" rel="noopener ugc nofollow" target="_blank">我的第一个clojars </a>，耶！)可以和胭脂红包含在一起。有了这个，你就可以给你的连接提供他们需要的心跳。</p><p id="7461" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">感谢阅读！请尝试一下，并让我知道您在Clojure服务中是如何处理它的。</p><p id="b7bc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">不要脸的插头——如果你对不仅仅是一个读者感兴趣，让我们一起努力——<a class="ae ke" href="https://angel.co/swym/jobs" rel="noopener ugc nofollow" target="_blank">我们积极寻求与像你这样的酷人合作</a>:)！</p><h2 id="23f1" class="ng lc hu bd ld nm nn no lh np nq nr ll jr ns nt lp jv nu nv lt jz nw nx lx ny dt translated">参考</h2><ol class=""><li id="17c0" class="km kn hu ji b jj lz jn ma jr nz jv oa jz ob kd kr ks kt ku dt translated"><a class="ae ke" href="https://groups.google.com/forum/#!topic/redis-db/MwHnkLLs070" rel="noopener ugc nofollow" target="_blank">https://groups.google.com/forum/#!topic/redis-db/MwHnkLLs070 </a></li><li id="18a0" class="km kn hu ji b jj kv jn kw jr kx jv ky jz kz kd kr ks kt ku dt translated"><a class="ae ke" href="https://github.com/andymccurdy/redis-py/issues/386" rel="noopener ugc nofollow" target="_blank">https://github.com/andymccurdy/redis-py/issues/386</a></li><li id="f754" class="km kn hu ji b jj kv jn kw jr kx jv ky jz kz kd kr ks kt ku dt translated"><a class="ae ke" href="https://stackoverflow.com/questions/8678349/subscription-to-redis-channel-does-not-keep-alive" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/8678349/subscription-to-redis-channel-does-not-keep-alive</a></li><li id="96df" class="km kn hu ji b jj kv jn kw jr kx jv ky jz kz kd kr ks kt ku dt translated"><a class="ae ke" href="https://github.com/ptaoussanis/carmine/issues/15" rel="noopener ugc nofollow" target="_blank">https://github.com/ptaoussanis/carmine/issues/15,</a>T14】https://github.com/ptaoussanis/carmine/issues/201</li><li id="88ba" class="km kn hu ji b jj kv jn kw jr kx jv ky jz kz kd kr ks kt ku dt translated"><a class="ae ke" href="http://rossipedia.com/blog/2014/01/redis-i-like-you-but-youre-crazy/" rel="noopener ugc nofollow" target="_blank">http://rossi pedia . com/blog/2014/01/redis-I-like-you-but-you-crazy/</a></li></ol><h1 id="ac63" class="lb lc hu bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">页（page的缩写）学生:</h1><p id="44e2" class="pw-post-body-paragraph jg jh hu ji b jj lz jl jm jn ma jp jq jr mb jt ju jv mc jx jy jz md kb kc kd hn dt translated">你已经走了这么远:)，也许你也喜欢我的其他Clojure帖子，只是把它放在那里-</p><div class="oc od fm fo oe of"><a href="https://hackernoon.com/clojure-macros-lessons-from-unspoken-symbols-c4945d8ed8bf" rel="noopener  ugc nofollow" target="_blank"><div class="og ab ej"><div class="oh ab oi cl cj oj"><h2 class="bd hv fv z el ok eo ep ol er et ht dt translated">Clojure宏——未言符号的教训</h2><div class="om l"><h3 class="bd b fv z el ok eo ep ol er et ek translated">在Swym，我们使用Clojure做很多事情。不变的是，我们已经结束了宏被认为是…</h3></div><div class="on l"><p class="bd b gc z el ok eo ep ol er et ek translated">hackernoon.com</p></div></div><div class="oo l"><div class="op l oq or os oo ot ja of"/></div></div></a></div><div class="oc od fm fo oe of"><a href="https://hackernoon.com/destructuring-clojure-with-javascript-bd1398bdacb6" rel="noopener  ugc nofollow" target="_blank"><div class="og ab ej"><div class="oh ab oi cl cj oj"><h2 class="bd hv fv z el ok eo ep ol er et ht dt translated">用Javascript析构Clojure</h2><div class="om l"><h3 class="bd b fv z el ok eo ep ol er et ek translated">Clojure是我在Swym Corporation工作时学习的一门语言。当我去年加入时，我…</h3></div><div class="on l"><p class="bd b gc z el ok eo ep ol er et ek translated">hackernoon.com</p></div></div></div></a></div><figure class="ki kj kk kl fq iv"><div class="bz el l di"><div class="ou ov l"/></div></figure></div></div>    
</body>
</html>