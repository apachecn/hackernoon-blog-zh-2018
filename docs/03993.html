<html>
<head>
<title>Know the operations currently executing on your MongoDB server inside out</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">彻底了解当前在MongoDB服务器上执行的操作</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/mongodb-currentop-18fe2f9dbd68?source=collection_archive---------2-----------------------#2018-05-10">https://medium.com/hackernoon/mongodb-currentop-18fe2f9dbd68?source=collection_archive---------2-----------------------#2018-05-10</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/90bae2fa214cd096d57107a6c6410623.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gHLb2vtQ36YSv26l."/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">“Dashboard in the pilot's cockpit” by <a class="ae jg" href="https://unsplash.com/@valeon?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Mitchel Boot</a> on <a class="ae jg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="7686" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">介绍</h1><p id="300b" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">有没有人问过—<em class="ld">‘为什么你的</em><a class="ae jg" href="https://hackernoon.com/tagged/mongodb" rel="noopener ugc nofollow" target="_blank"><em class="ld">MongoDB</em></a><em class="ld"/><a class="ae jg" href="https://hackernoon.com/tagged/database" rel="noopener ugc nofollow" target="_blank"><em class="ld">数据库</em> </a> <em class="ld">服务器运行缓慢？’</em>。如果您想知道，<em class="ld">“哪些操作使速度变慢了？”那么你的思考方向是正确的。这是多部分系列文章之一，<a class="ae jg" rel="noopener" href="/p/mastering-mongodb-5544e16df023">掌握MongoDB —一天一个技巧</a>，专为您创建，通过学习<em class="ld">“一天一个技巧”</em>来掌握<a class="ae jg" href="https://www.mongodb.com" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>。</em></p><p id="9b56" class="pw-post-body-paragraph kf kg hu kh b ki le kk kl km lf ko kp kq lg ks kt ku lh kw kx ky li la lb lc hn dt translated">在几篇系列文章中，我将给出各种提示来帮助您回答上述问题。本文讨论了<em class="ld">current top</em>命令——它的应用、用例场景，最后是用例场景，最后是一些动手实验练习。</p></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><h1 id="545b" class="jh ji hu bd jj jk lq jm jn jo lr jq jr js ls ju jv jw lt jy jz ka lu kc kd ke dt translated">母带制作—当前顶部</h1><h1 id="1858" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">什么是currentOp</h1><p id="fd19" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated"><a class="ae jg" href="https://docs.mongodb.com/manual/reference/command/currentOp/" rel="noopener ugc nofollow" target="_blank">current top</a>是一个管理命令，它提供关于MongoDB服务器上正在执行的当前操作的信息。</p><p id="8964" class="pw-post-body-paragraph kf kg hu kh b ki le kk kl km lf ko kp kq lg ks kt ku lh kw kx ky li la lb lc hn dt translated"><em class="ld">current top</em>必须针对管理数据库运行。当授权打开时，当前用户必须在<em class="ld"> admin </em>数据库上拥有“<em class="ld">in Prog”</em>权限才能查看所有操作，或者必须使用“<em class="ld">$ ownOps”</em>查看自己的操作。</p><h1 id="8c80" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">如何使用currentOp</h1><p id="c89e" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">您可以使用adminCommand或current top包装函数在mongo shell中运行current top，如下所示。</p><figure class="lv lw lx ly fq iv"><div class="bz el l di"><div class="lz ma l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The MongoDB currentOp command via db.adminCommand</figcaption></figure><p id="d9a7" class="pw-post-body-paragraph kf kg hu kh b ki le kk kl km lf ko kp kq lg ks kt ku lh kw kx ky li la lb lc hn dt translated">上述adminCommand的另一个包装函数</p><figure class="lv lw lx ly fq iv"><div class="bz el l di"><div class="lz ma l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The MongoDB currentOp command via a db.currentOp() wrapper function.</figcaption></figure><h1 id="ba28" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">当前顶部的使用案例</h1><p id="6fd1" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated"><em class="ld">current top</em>命令的用例是收集关于当前在MongoDB服务器上执行的操作的信息。<em class="ld">当前顶部</em>命令帮助您找到</p><ul class=""><li id="7734" class="mb mc hu kh b ki le km lf kq md ku me ky mf lc mg mh mi mj dt translated">不使用任何索引的查询</li><li id="fef9" class="mb mc hu kh b ki mk km ml kq mm ku mn ky mo lc mg mh mi mj dt translated">具有高数值字段的操作</li><li id="9c05" class="mb mc hu kh b ki mk km ml kq mm ku mn ky mo lc mg mh mi mj dt translated">等待锁定的操作</li><li id="37eb" class="mb mc hu kh b ki mk km ml kq mm ku mn ky mo lc mg mh mi mj dt translated">长时间运行的操作</li></ul><h2 id="2c2e" class="mp ji hu bd jj mq mr ms jn mt mu mv jr kq mw mx jv ku my mz jz ky na nb kd nc dt translated">不使用任何索引的查询</h2><p id="2c14" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">以下示例将帮助您找到不使用索引<em class="ld">{ " plan summary ":" coll scan " }</em>的<em class="ld">查询</em>操作</p><figure class="lv lw lx ly fq iv"><div class="bz el l di"><div class="lz ma l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The MongoDB currentOp command to help find queries not using any index</figcaption></figure><h2 id="2bd8" class="mp ji hu bd jj mq mr ms jn mt mu mv jr kq mw mx jv ku my mz jz ky na nb kd nc dt translated">具有高数值字段的操作</h2><p id="72cf" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">以下示例将帮助您在<em class="ld">指南</em>数据库中找到<em class="ld">num fields</em>大于或等于100的所有操作。注意正则表达式<em class="ld">“ns”:/^guidebook./ </em>还用于进一步过滤<em class="ld">指南</em>数据库的操作。</p><figure class="lv lw lx ly fq iv"><div class="bz el l di"><div class="lz ma l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The MongoDB currentOp command to help you find database operations with number of yields greater than or equal to 100</figcaption></figure><h2 id="d045" class="mp ji hu bd jj mq mr ms jn mt mu mv jr kq mw mx jv ku my mz jz ky na nb kd nc dt translated">等待锁定的操作</h2><p id="c924" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">下面的示例返回所有等待锁的写操作的信息。</p><figure class="lv lw lx ly fq iv"><div class="bz el l di"><div class="lz ma l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The MongoDB currentOp command to help you find all the write operations that are waiting for a lock.</figcaption></figure><h2 id="ebb7" class="mp ji hu bd jj mq mr ms jn mt mu mv jr kq mw mx jv ku my mz jz ky na nb kd nc dt translated">长时间运行的查询</h2><p id="8006" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">以下示例返回运行时间超过300毫秒的所有操作的信息。</p><figure class="lv lw lx ly fq iv"><div class="bz el l di"><div class="lz ma l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The MongoDB currentOp command to help you find all the operations running longer than 300 milliseconds.</figcaption></figure></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><h1 id="7182" class="jh ji hu bd jj jk lq jm jn jo lr jq jr js ls ju jv jw lt jy jz ka lu kc kd ke dt translated">动手实验练习</h1><p id="3797" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">这个实验练习使用了来自MongoDB的<a class="ae jg" href="https://raw.githubusercontent.com/mongodb/docs-assets/primer-dataset/primer-dataset.json" rel="noopener ugc nofollow" target="_blank">餐馆</a>样本数据集。请按照下面的说明导入<em class="ld">餐馆</em>数据，生成一些负载来帮助您学习这里讨论的概念。</p><figure class="lv lw lx ly fq iv"><div class="bz el l di"><div class="lz ma l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">A bash script to help you download, import and generate load on the sample restaurant database.</figcaption></figure><h1 id="1db0" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">摘要</h1><p id="fbb4" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated"><em class="ld">db . current top()</em>命令提供了查找当前正在MongoDB服务器上运行的所有查询的方法。可以进一步利用可选字段来帮助根据特定标准筛选结果。</p><blockquote class="nd"><p id="3d66" class="ne nf hu bd ng nh ni nj nk nl nm lc ek translated">我想重申非常重要的一点——“<em class="nn">db . current top()</em>返回关于<em class="nn">正在进行的操作</em>的信息”。</p></blockquote><p id="b741" class="pw-post-body-paragraph kf kg hu kh b ki no kk kl km np ko kp kq nq ks kt ku nr kw kx ky ns la lb lc hn dt translated">如果您感兴趣的查询执行得非常快(这是一件好事)，如果您稍微早一点或晚一点运行<em class="ld">db . current top()</em>命令，它甚至可能不会出现在<em class="ld">current top</em>输出中(这是最令人沮丧的)。</p><p id="f656" class="pw-post-body-paragraph kf kg hu kh b ki le kk kl km lf ko kp kq lg ks kt ku lh kw kx ky li la lb lc hn dt translated">为了确保在一定时间内捕获所有操作，可以在如下所示的<em class="ld"> while </em>循环中执行<em class="ld">db . current top()</em>命令。</p><figure class="lv lw lx ly fq iv"><div class="bz el l di"><div class="lz ma l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">A JavaScript function to execute currentOp in a while loop to capture operations over a period of time.</figcaption></figure><p id="6c18" class="pw-post-body-paragraph kf kg hu kh b ki le kk kl km lf ko kp kq lg ks kt ku lh kw kx ky li la lb lc hn dt translated">然而，捕获长时间的操作并整合输出以供进一步处理将变得相当具有挑战性。为了帮助您正确地捕获一段时间内的所有查询，您需要使用<em class="ld">概要分析</em>。但那是另一天的话题。</p><p id="fa7f" class="pw-post-body-paragraph kf kg hu kh b ki le kk kl km lf ko kp kq lg ks kt ku lh kw kx ky li la lb lc hn dt translated">希望你今天在攀登“<a class="ae jg" rel="noopener" href="/p/mastering-mongodb-5544e16df023">掌握MongoDB——一天一个技巧</a>”之路时学到了一些新东西。</p><figure class="lv lw lx ly fq iv"><div class="bz el l di"><div class="nt ma l"/></div></figure></div></div>    
</body>
</html>