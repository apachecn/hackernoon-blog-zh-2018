<html>
<head>
<title>Creating a music streaming server and live music playing android client</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建音乐流媒体服务器和实况音乐播放android客户端</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/creating-a-music-streaming-server-and-live-music-playing-android-client-c12cd0600e56?source=collection_archive---------2-----------------------#2018-05-15">https://medium.com/hackernoon/creating-a-music-streaming-server-and-live-music-playing-android-client-c12cd0600e56?source=collection_archive---------2-----------------------#2018-05-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/04e2824689a43e44be7ae3abc744de34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_VMbxSXQpvjXT0q3ztNYxQ.jpeg"/></div></div></figure><p id="5229" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当我参加<a class="ae ka" href="https://innovate.mygov.in/sih2018/" rel="noopener ugc nofollow" target="_blank"> Smart India黑客马拉松决赛</a>时，我有一次很棒的经历，我们解决了一个公告系统的问题。所以，我决定写一篇博客，介绍如何在NodeJS中制作一个简单的音频/音乐流媒体服务器，以及一个简单的android应用程序，它将实时播放音频。通过使用以下代码，您可以创建自己的本地简单音乐流服务器，并且可以在android客户端或浏览器上实时欣赏音乐。所以，我们打开烤箱来做这道菜吧。</p><h1 id="0b7f" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">创建一个简单的音乐流媒体服务器</h1><p id="3c79" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">你可以使用任何方法来制作自己的流媒体服务器，但我在这里发现的最简单的方法是使用开源软件<strong class="je hv"> SWYH </strong>(流媒体播放你听到的内容)。你可以查看官方网站<a class="ae ka" href="https://www.streamwhatyouhear.com/" rel="noopener ugc nofollow" target="_blank">这里</a>。该应用程序仅适用于windows，可以从<a class="ae ka" href="https://www.streamwhatyouhear.com/download/" rel="noopener ugc nofollow" target="_blank">这里</a>下载。你也可以使用<a class="ae ka" href="http://icecast.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv"> IceCast </strong> </a>为好。</p><p id="d3d8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这里重要的是，我们不需要维护一个缓冲区，然后在一些代码的帮助下通过请求传输音频块。我们使用这些软件来为我们处理权重，因此很容易获得一个音频流的url。</p><p id="ed02" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦安装好<strong class="je hv"> SWYH </strong>后，请按照这里的步骤<a class="ae ka" href="https://www.streamwhatyouhear.com/getting-started/" rel="noopener ugc nofollow" target="_blank">开始</a>。如果一切顺利，您将会看到以下画面:</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div class="fe ff le"><img src="../Images/f642e3c5bb8d2b1e067efd8577aa5cf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/1*18m2GHIr1pdxeJnLZQuxrw.png"/></div></figure><p id="e224" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这里你可以查看<em class="lj"> URL </em>作为服务器的某个本地地址和<strong class="je hv"> /stream/swyh.mp3 </strong>的路由。要听音乐，您必须连接到带有SWYH的机器所连接的同一个<strong class="je hv"> wifi网络</strong>。您可以创建一个简单的热点，或者您可以连接到您自己的网络在家里。<em class="lj">这是必须的，那些想要收听流的设备应该连接到同一个网络</em>。现在我们准备向前迈进。</p><p id="0324" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以简单地将SWYH显示的<em class="lj"> URL </em>粘贴到浏览器中，然后就搞定了！！你也可以在那个设备上听音乐。当然，需要有人在安装了SWYH的机器上播放音乐。现在你已经准备好了流媒体服务器，我们可以构建android应用程序了。如果你到目前为止还不明白以上内容，请不要担心，随着我们的深入，它会变得清晰，或者你可以检查<em class="lj"> SWYH </em>的<em class="lj">文档</em>以获得清晰的理解。</p><h1 id="2d61" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">创建NodeJS流服务器</h1><p id="f9e7" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">让我们假设你想让你的流媒体公开，世界上的每个人都可以听到你的Weekend，Linkin-Park，Queen(我最喜欢的一个:我想挣脱束缚；-)等。您可以创建一个简单的nodeJS服务器来<strong class="je hv">传输</strong>当前由<strong class="je hv"> SWYH </strong>软件传输的流。</p><p id="d249" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要将流传输到不同的URL，我们可以使用<code class="eh lk ll lm ln b">request</code> <code class="eh lk ll lm ln b">node module</code>。你所要做的就是首先安装<code class="eh lk ll lm ln b">request</code>节点模块。</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="82f0" class="ls kc hu ln b fv lt lu l lv lw">$ npm install request --save</span></pre><p id="e9d1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦你安装了<code class="eh lk ll lm ln b">request</code>模块，你就可以在你的<code class="eh lk ll lm ln b">Express server</code>中使用它</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="8d7f" class="ls kc hu ln b fv lt lu l lv lw">var express = require('express');<br/>    var path = require('path');<br/>    var request = require('request');<br/>    <br/>    var app = express()<br/>    <br/>    app.get('/playback.mp3', function(req, res){<br/>    <br/>    //the request module is piping the steam over the get request coming on playback.mp3<br/>    request.get('http://&lt;your-swyh-url:56789&gt;/stream/swyh.mp3').pipe(res, function(error){<br/>       		console.log(error);<br/>       });<br/>    });<br/>    <br/>    //here the server is localhost and listening on the port 8000<br/>    app.listen(8000,function(){<br/>	console.log("Listening on 8000");<br/>    });</span></pre><p id="9263" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">正如你所看到的，我们正在通过管道将流从一个<em class="lj"> URL </em>传输到另一个<em class="lj"> URL </em>，即从一个服务器传输到另一个服务器。在这里，我想提一下，你可以使用<code class="eh lk ll lm ln b">request.get(...)</code>功能中的任何链接。举个例子，你也可以用<a class="ae ka" href="http://playerservices.streamtheworld.com/api/livestream-redirect/KUFXFM_SC" rel="noopener ugc nofollow" target="_blank">这个</a>。</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="4b02" class="ls kc hu ln b fv lt lu l lv lw">//....<br/>request.get('<a class="ae ka" href="http://playerservices.streamtheworld.com/api/livestream-redirect/KUFXFM_SC" rel="noopener ugc nofollow" target="_blank">http://playerservices.streamtheworld.com/api/livestream-redirect/KUFXFM_SC</a>')<br/>.pipe(res,function(error){<br/>//....<br/> });</span></pre><p id="3a93" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">答对了。！现在你知道如何制作一个简单的音乐流媒体服务器了！！！这里完成了一半的食谱。</p><h1 id="a7b2" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">烘焙android客户端</h1><p id="bf02" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">创建一个android客户端应用程序来收听实时音频非常简单。我们将使用android框架中现有的<code class="eh lk ll lm ln b">MediaPlayer</code>类。在这里查看描述<a class="ae ka" href="https://developer.android.com/reference/android/media/MediaPlayer" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="ea02" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它在后台处理音频缓冲，可以从android设备的扬声器中听到音频。下面是一个<code class="eh lk ll lm ln b">onCreate()</code>方法中的代码:</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="9ea9" class="ls kc hu ln b fv lt lu l lv lw">public class MainActivity extends AppCompatActivity {<br/>    //....//declaring the MediaPlayer<br/>    MediaPlayer mp;<br/>        <br/>    @Override<br/>    protected void onCreate(Bundle savedInstanceState) {<br/>    	super.onCreate(savedInstanceState);<br/>        setContentView(R.layout.activity_main);<br/>        //...<br/>        //...<br/>        String streamURL = "your-music-streaming-url-whatever";<br/>        //Instantiating the MediaPlayer class<br/>        <br/>        mp = new MediaPlayer();<br/>        <br/>        //setting the audio stream type to Streaming music<br/>        try{<br/><br/>            mp.setAudioStreamType(AudioManager.STREAM_MUSIC);<br/>            mp.setDataSource(streamURL);<br/>            mp.prepareAsync();<br/><br/>        }catch (Exception e){<br/>            e.printStackTrace();<br/>        }<br/>        <br/>        //catching the error if any<br/>        mp.setOnErrorListener((mediaPlayer,what,extra)-&gt;{<br/>            mediaPlayer.reset();<br/>            return false;<br/>        });<br/>       <br/>    }</span></pre><p id="d4b4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这里，我们已经初始化了<code class="eh lk ll lm ln b">MediaPlayer</code>，音频流类型被设置为<code class="eh lk ll lm ln b">STREAM_MUSIC</code>。<code class="eh lk ll lm ln b">DataSource</code>被设置为我们用来传输音频/音乐的<code class="eh lk ll lm ln b">URL</code>。</p><p id="5c4d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">有趣的是<code class="eh lk ll lm ln b">prepareAsync()</code>方法。这个方法创建了一个对URL的异步请求<strong class="je hv">并将网络隔离在<code class="eh lk ll lm ln b">MainThread</code>之外。<code class="eh lk ll lm ln b">MediaPlayer</code>异步调用我们服务器的<code class="eh lk ll lm ln b">GET</code>方法，并响应请求发送audi包。音频包被捕获并存储在缓冲器中。</strong></p><p id="dbff" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当缓冲区被加载到足以播放一些音乐时，媒体播放器准备将声音发送到扬声器。<code class="eh lk ll lm ln b">SetOnPreparedListener</code>用于检查上面的情况，我们可以<code class="eh lk ll lm ln b">play()</code>播放音乐。下面的代码显示了写在上面代码正下方的<code class="eh lk ll lm ln b">SetOnPreparedListener</code>。</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="d06f" class="ls kc hu ln b fv lt lu l lv lw">mp.setOnPreparedListener((mediaPlayer)-&gt;{<br/>    	//TODO:use some button to play and pause the music<br/>        // you can use this with some button click action as well<br/>    	if(playButton.isChecked()){<br/>        	mp.start();<br/>        }else{<br/>        	mp.pause();<br/>        }<br/>        <br/>    });</span></pre><p id="06fd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh lk ll lm ln b">mp.start()</code> call将播放扬声器中的声音，您可以享受美妙的音乐。哇！！</p><p id="5c77" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，当我们在制作这个食谱的时候制造了一些混乱，我们需要把事情做好，除非我们将面临android中的大量内存泄漏。在您的<code class="eh lk ll lm ln b">onDestroy()</code>和<code class="eh lk ll lm ln b">onStop()</code>方法中添加以下代码，您就可以开始了:</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="6232" class="ls kc hu ln b fv lt lu l lv lw">//...<br/>    @Override<br/>    protected void onDestroy() {<br/>        super.onDestroy();<br/><br/>        if (mp!=null){<br/>            if (mp.isPlaying()){<br/>                mp.stop();<br/>            }<br/>            mp.release();<br/>            mp = null;<br/>        }<br/>     //...</span></pre><p id="bb03" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">好吧，我要去听一些皇后乐队和酷玩乐队。有任何疑问吗？评论部分在下面↓。</p><blockquote class="lx ly lz"><p id="9922" class="jc jd lj je b jf jg jh ji jj jk jl jm ma jo jp jq mb js jt ju mc jw jx jy jz hn dt translated">音乐之父</p></blockquote><figure class="lf lg lh li fq iv fe ff paragraph-image"><a href="http://buymeacoff.ee/mrcurious"><div class="fe ff md"><img src="../Images/83dc7212ef8502659c81086ad58b8d96.png" data-original-src="https://miro.medium.com/v2/resize:fit:340/format:webp/1*bk_C8Um34KavCkO2yzMCZg.png"/></div></a><figcaption class="me mf fg fe ff mg mh bd b be z ek">Support me !</figcaption></figure></div></div>    
</body>
</html>