<html>
<head>
<title>DevOps: Setting up GitLab + Jenkins CI with Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DevOps:使用Docker设置GitLab + Jenkins CI</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/setting-up-gitlab-jenkins-ci-with-docker-da74c67373ac?source=collection_archive---------3-----------------------#2018-05-15">https://medium.com/hackernoon/setting-up-gitlab-jenkins-ci-with-docker-da74c67373ac?source=collection_archive---------3-----------------------#2018-05-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="ede3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每一个认真的开发者在某一点之后肯定会想要部署他/她的产品或者将他们的游戏升级到产品。一旦你写完软件/产品，精通DevOps管道肯定会有帮助。因此，我们继续设置我们自己的Git服务器，以及一个持续的部署/集成管道。这里有一个更简单的介绍，让你接触到后端工程之后的东西。欢迎来到DevOps！</p><p id="a56c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">找了好几天，也找不到足够的关于如何设置自己的GitLab服务器和Jenkins CI服务器的信息。特别是如何将它们整合起来，建立一个最小但完整的生态系统。有一些非常好的博客展示了这个过程，但都是零碎的。这就是为什么这个博客可能会帮助那些试图掌握相关概念的人，并且有一个一站式教程可以遵循。</p><p id="4c8c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我用截图策划了整个过程，因为我知道即使在通读之后看到事情也有很大帮助。为了清楚地了解它是如何工作的以及本教程接下来会讲些什么，这里有一个完整设置和流程的流程图。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/e1e92351361441045a1e55e65c343081.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*30lnb0Vjw1KFbpiohl-c_w.png"/></div></div></figure><p id="1e71" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该教程遵循代码可在<a class="ae kb" href="https://github.com/dkaushik94/Gitlab-Jenkins" rel="noopener ugc nofollow" target="_blank">这里。</a>您可以选择克隆存储库并遵循代码。或者，您可以按照指南设置自己的代码。该设置需要docker。在这里找到安装docker <a class="ae kb" href="https://docs.docker.com/install/" rel="noopener ugc nofollow" target="_blank">的信息</a>。</p><p id="001e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行以下命令来安装Gitlab。安装完成后，我们可以看到Gitlab容器正在运行。您可以通过运行命令<code class="eh kc kd ke kf b">docker ps -a</code>找到这些信息</p><pre class="jq jr js jt fq kg kf kh ki aw kj dt"><span id="8cad" class="kk kl hu kf b fv km kn l ko kp">sudo docker run --detach \ --hostname gitlab.example.com \ --publish 443:443 --publish 80:80 --publish 22:22 \ --name gitlab \ --restart always \ gitlab/gitlab-ce:latest</span></pre><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/5116e2fdc5fa8262f077dd298f8805bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VI4Av4cpyz4XZwHH.png"/></div></div></figure><p id="9a8d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在去<code class="eh kc kd ke kf b">https://localhost:80/</code>找Gitlab启动运行。如果它还不可用，请等待几分钟，直到您可以看到Gitlab正常运行。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/6d6cc0240a2f910d2f2de05a5f95f7a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ortfNNt5TcStYuvk.png"/></div></div></figure><p id="74c1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">设置一个新密码，这将是用户<code class="eh kc kd ke kf b">root</code>的密码，默认为管理员用户。您可以根据需要创建更多用户。一旦设置了密码，您就可以登录Gitlab，如下所示。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/361dee9da79a438e16a5c6c576b05f9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FXkq2OHdpRdPa2FQ.png"/></div></div></figure><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/1ad44263867955a9af6b991380b842e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4QyP_ZgbsPmgSUc5.png"/></div></div></figure><p id="df8d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在导航到用户设置。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/c7f6622f482c49afe120e66a34cec897.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CCPvSBuwlbaBt6Ao.png"/></div></div></figure><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/95404f427f7236984976cf36bb57a957.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GLRiPmgRG83oWxT-.png"/></div></div></figure><p id="4194" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">导航至访问令牌，继续生成访问令牌。给它一个名称和截止日期。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/79eba9508cf6a94eeb5c2144ff51d643.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NJnbsLykHh0Trf0d.png"/></div></div></figure><p id="a2a3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">生成令牌后，请将其保存在安全的地方。我们将使用这个令牌来自动填充Gitlab服务器中的项目。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/ff8271941231324a7d92c61378f74c70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_tvD3clulY_MOJf5.png"/></div></div></figure><p id="7d88" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们现在将运行<code class="eh kc kd ke kf b">fetch_repo.py</code>从Github中提取指定语言的项目，并将它们推送到GitLab。</p><pre class="jq jr js jt fq kg kf kh ki aw kj dt"><span id="4dc5" class="kk kl hu kf b fv km kn l ko kp">python3 fetch_repos.py [your_github_username] [your_github_password]</span></pre><p id="432f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用有效的Github凭证运行这个命令，然后会提示提供我们之前获得的个人访问令牌。输入令牌后，项目就在Gitlab中建立起来了。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kr"><img src="../Images/442700eaf303181aa6bb0eb0761a2843.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PcfTm2FaHpPB7BLt.png"/></div></div></figure><p id="9f62" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们现在可以检查Gitlab是否已经设置了所有的回购。我们现在就安排詹金斯。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/261e004ffbc69052801cc061eec83ad4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*haq3Np89qGes9zlH.png"/></div></div></figure><h1 id="c470" class="ks kl hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">Jenkins —设置</h1><pre class="jq jr js jt fq kg kf kh ki aw kj dt"><span id="5f72" class="kk kl hu kf b fv km kn l ko kp">sudo docker run -p 8080:8080 --name=jenkins-master jenkins</span></pre><p id="a6f4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦Jenkins容器运行，我们需要做一次设置。如您在终端中所见，复制打印的密码或密码始终可用:<code class="eh kc kd ke kf b">/var/jenkins_home/secrets/initialAdminPassword</code></p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/37d82863eae0c0e33b1f7f4f7860a356.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6uTQfMfmu4_PnTte.png"/></div></div></figure><p id="4985" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为此，首先通过运行命令登录到容器，</p><p id="8cc6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh kc kd ke kf b">sudo docker exec -i -t jenkins-master(name_of_the_image) /bin/bash</code></p><p id="b152" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后导航到上面的路径，将<code class="eh kc kd ke kf b">initialAdminPassword</code>复制到剪贴板。现在转到<code class="eh kc kd ke kf b">http://localhost:8080/</code>找到如下图所示的启动并运行的Jenkins。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/b0a5ef22c90ad6b236cc68d7ad9f05f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qhnB0AaLUKQ0JFKX.png"/></div></div></figure><p id="66b9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在将<code class="eh kc kd ke kf b">initialAdminPassword</code>粘贴到Jenkins网页的剪贴板中。</p><p id="fb4d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">单击继续。现在Jenkins给出了定制/建议安装的选项，如下图所示。我们选择建议的安装。</p><p id="f737" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将安装标准组件。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/169390bf122e3edcdd328a02a0f0684a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zO7hYYsbxdKLb-VF.png"/></div></div></figure><p id="36f2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">完成安装后，Jenkins将带您创建第一个用户。如图所示创建一个用户。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/7fcdc395d7e413fcc47433416970af71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BkcsOzJmMJauhOhW.png"/></div></div></figure><p id="c849" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">创建用户后，单击complete，Jenkins现在就可以使用了！</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/4997f246cde67ec117beb97dc81d4522.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KezEyimOQX6ZBjEE.png"/></div></div></figure><p id="593c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">詹金斯的新观点应该是这样的。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/62fe179a4a35b9f673d18a9d3fae5d60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NILPW3x9flpbVJcR.png"/></div></div></figure><p id="1b89" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们现在需要在Jenkins中设置插件。运行install_plugins脚本— <code class="eh kc kd ke kf b">python3 install_plugins.py</code> <br/>如果输出是<code class="eh kc kd ke kf b">True</code>，运行命令<code class="eh kc kd ke kf b">docker restart jenkins-master</code>重启Jenkins</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/6aa34e4974d70febc16d787cd59e86b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fPctbB6bkqDRRgep.png"/></div></div></figure><h1 id="e500" class="ks kl hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">现在我们需要配置Gitlab插件。</h1><p id="9204" class="pw-post-body-paragraph ir is hu it b iu lp iw ix iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated">前往<code class="eh kc kd ke kf b">Manage Jenkins</code> &gt; <code class="eh kc kd ke kf b">Configure System</code>。这里Gitlab部分没有配置，应该如下图所示</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/76a5369a0d11b52e160e627b74124db6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GlIKocS6PcAJScUd.png"/></div></div></figure><p id="1327" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们需要给出一些细节:<br/>·连接名称:Gitlab连接的名称，我们稍后将在每个创建的作业以及作业DSL中引用它。这种联系对詹金斯来说是全球性的。我们将给出<code class="eh kc kd ke kf b">gitlab</code>作为名称。</p><p id="7fea" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Gitlab主机url:这是系统中运行的Gitlab容器的url。我们输入<code class="eh kc kd ke kf b"><a class="ae kb" href="http://172.17.0.2:80/" rel="noopener ugc nofollow" target="_blank">http://172.17.0.2:80/</a></code></p><p id="264b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">凭证:到目前为止，我们没有任何Gitlab凭证设置。我们将创建一个新的如下。点击<code class="eh kc kd ke kf b">Add</code>按钮设置新的凭证。输入之前生成的Gitlab个人访问令牌。Jenkins会将此凭证用于各种目的，如获取工作回购</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/e4324362b529c94bb78fd39cf60b1183.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QH28QDEczGFVCtx7.png"/></div></div></figure><p id="d7e6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">设置完成后，单击测试连接。这将返回如下所示的<code class="eh kc kd ke kf b">success</code>。</p><blockquote class="lu lv lw"><p id="d1f4" class="ir is lx it b iu iv iw ix iy iz ja jb ly jd je jf lz jh ji jj ma jl jm jn jo hn dt translated"><em class="hu">取消勾选</em> <code class="eh kc kd ke kf b"><em class="hu">Enable authentication for project Endpoint</em></code> <em class="hu">。我们将禁用身份验证，以便web hook在没有令牌的情况下也能工作。</em></p></blockquote><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/64fdc477e333884fc35a59650dd7879b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3AYAC72DRiBgxbfb.png"/></div></div></figure><blockquote class="lu lv lw"><p id="b491" class="ir is lx it b iu iv iw ix iy iz ja jb ly jd je jf lz jh ji jj ma jl jm jn jo hn dt translated">如果您遇到任何错误，请查看Gitlab的url。它不应该是localhost。由于我们是通过docker运行Gitlab和Jenkins，所以Jenkins和Gitlab是在docker的局域网内运行的。詹金斯需要在那个网络中参考Gitlab。所以，要获取Gitlab的地址，在Gitlab的bash中，在<code class="eh kc kd ke kf b">/etc/hosts</code>文件中找到url。在此输入url。</p></blockquote><h1 id="14e9" class="ks kl hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">提供就业机会</h1><p id="f5f8" class="pw-post-body-paragraph ir is hu it b iu lp iw ix iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated">我们需要为Gitlab中的每个回购设置创建工作。为此，我们将使用作业DSL插件来完成。Job DSL是用groovy编写的，用于获取Gitlab中的所有项目，并为Gitlab中的每个repo设置设置一个作业。下面是作业DSL的代码</p><blockquote class="lu lv lw"><p id="1540" class="ir is lx it b iu iv iw ix iy iz ja jb ly jd je jf lz jh ji jj ma jl jm jn jo hn dt translated"><em class="hu">注:我们使用的是Jenkins的IP，</em> <code class="eh kc kd ke kf b"><em class="hu">private_token</em></code> <em class="hu">是之前从Gitlab获得的个人访问令牌。令牌对你来说是不同的。在运行脚本之前，替换</em> <code class="eh kc kd ke kf b"><em class="hu">create_master_job.py</em></code> <em class="hu">中的令牌。如果IP也不同，也要更换。</em></p></blockquote><pre class="jq jr js jt fq kg kf kh ki aw kj dt"><span id="8d01" class="kk kl hu kf b fv km kn l ko kp">//This is the Private Access token obtained in GitLab. Please //replace this with the one you obtained in create_master_job.py.  </span><span id="ee6a" class="kk kl hu kf b fv mb kn l ko kp">String private_token = "DjotJ94w7GRsRdU6eDWt" // If the address of jenkins is different from this, please replace that too. String ip = "http://172.17.0.3:80/" // We need to fetch URLs of all the repos in order to create a job for each of them def jdata = new groovy.json.JsonSlurper().parseText(new URL("http://172.17.0.3:80/api/v3/projects?private_token="+private_token).text) jdata.each { String repo_url = it.ssh_url_to_repo repo_url = repo_url.replace("git@gitlab.example.com:",ip) String proj = repo_url.substring(repo_url.lastIndexOf('/') + 1); String project_name = proj[0..-5] job(project_name) { // Basic details of the job description('A job for the project: ' + project_name) displayName(project_name) // SCM details of the repo scm { git { branch('master') remote { url(repo_url) credentials('gitlab-root-user') } } } // Build steps steps { gradle('check') gradle { tasks('clean') tasks('build') switches('--stacktrace') switches('--debug') } } // Setting up Jacoco Code coverage publishers { jacocoCodeCoverage { execPattern '**/**.exec' classPattern '**/classes' sourcePattern '**/src/main/java' exclusionPattern '' inclusionPattern '' } } // Setting up triggers for Gitlab triggers { gitlabPush { buildOnMergeRequestEvents(true) buildOnPushEvents(true) } } authenticationToken('auhgtbereb675nksnwewrhbbe==') } }</span></pre><p id="2a79" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将此代码用作主作业xml中脚本的一部分。我们再次使用python Jenkins创建一个主作业，然后构建已创建的作业。该作业将依次为Gitlab中的每个repo创建一个作业。验证url并用我们在Gitlab中得到的替换<code class="eh kc kd ke kf b">private_token</code>是很重要的。</p><p id="d437" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们现在需要运行create_master_job脚本来完成所有这些工作。打开终端并运行命令<code class="eh kc kd ke kf b">python3 create_master_job.py</code></p><p id="81bd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在已经为Gitlab中的每个repo创建了一个作业，如下所示</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/1db312bc7caaec3573078f32b3e9259c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ep3OROvJOx4nz4Sa.png"/></div></div></figure><h1 id="eedd" class="ks kl hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">网钩</h1><p id="59e7" class="pw-post-body-paragraph ir is hu it b iu lp iw ix iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated">一旦所有的工作都在詹金斯创建，我们需要创建网络挂钩。为此，我们将运行<code class="eh kc kd ke kf b">create_webhooks.py</code>，它将查看所有创建的作业，并使用python Gitlab向Gitlab中的每个repo添加web hook。运行命令<code class="eh kc kd ke kf b">python3 create_webhooks.py</code>。然后前往Gitlab查看为每个项目创建的web挂钩，如下所示。</p><p id="9a7f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以导航到任何回购的集成部分，以找到创建的挂钩。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/aa83ad2df065d97e7c0d15bcbfbd8420.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2V_998xFH2szIzOc.png"/></div></div></figure><p id="d803" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在集成部分，一旦你向下滚动，你可以看到钩子。单击test，您应该会在顶部看到一条成功消息。如您所见，web-hook中的url是Jenkins job的项目url。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mc"><img src="../Images/e5b5ecc91b116fcd97f21d25aef545d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*609y0QmWXZ2OLqEe.png"/></div></div></figure><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/96894e23126fd77acd166d7dba5ba621.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8cICZY516t3U1bxJ.png"/></div></div></figure><p id="7417" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在回购中的任何推动都会自动触发詹金斯的构建。让我们试试吧！</p><p id="fb44" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们编辑README.md文件并推送更改，看看它是否会触发构建。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff md"><img src="../Images/fea1fc7a58d217187b1749cbe0c80f4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CqvJ1UpvG9qr7y1X.png"/></div></div></figure><p id="8dea" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦变更被推送，我们前往Jenkins job进行同一个项目<code class="eh kc kd ke kf b">MPAndroidChart</code>，我们可以看到构建已经被触发。在左下角，我们可以看到构建和指示<code class="eh kc kd ke kf b">Started ​by ​GitLab ​push ​by ​Administrator</code>的消息</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/ed188a68709185c69703b28e43af60d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tzKOj2yNGrcPc6fC.png"/></div></div></figure><h1 id="283f" class="ks kl hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">代码覆盖率</h1><p id="3129" class="pw-post-body-paragraph ir is hu it b iu lp iw ix iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated">如果gradlew配置和build.gradle是正确的，构建应该工作正常，并且应该生成如下代码覆盖率报告。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/3a744fdf75b743925fbe98b4f8dd0ce4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lP7OCFiV6IJogww9.png"/></div></div></figure><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/daa617f0bbeccb3452bfdb5566bb9b09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AEYwU0E3ku-2Z2h_.png"/></div></div></figure><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/fccaafa5f4e6e3acbee0e48a61768f32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7ghM_CA6czeOd91a.png"/></div></div></figure><blockquote class="lu lv lw"><p id="7b39" class="ir is lx it b iu iv iw ix iy iz ja jb ly jd je jf lz jh ji jj ma jl jm jn jo hn dt translated">如果一个项目没有成功，我们有一个回购协议，Jacoco在这方面做得很好。你可以在这里找到回购<a class="ae kb" href="https://github.com/sandeepjoshi1910/TokBox-BookStore" rel="noopener ugc nofollow" target="_blank"><em class="hu"/></a></p></blockquote><h1 id="1a63" class="ks kl hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">明白；理解</h1><p id="7193" class="pw-post-body-paragraph ir is hu it b iu lp iw ix iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated">这一部分是分析Jenkins CI代码覆盖率工具的输出。现在你一定已经为Gitlab和Jenkins做好了一切准备。我们使用understand来生成代码分析报告。脚本<code class="eh kc kd ke kf b">understand.py</code>交互地询问以下参数</p><ul class=""><li id="03f5" class="me mf hu it b iu iv iy iz jc mg jg mh jk mi jo mj mk ml mm dt translated">包含理解工具的文件夹的路径</li><li id="df6c" class="me mf hu it b iu mn iy mo jc mp jg mq jk mr jo mj mk ml mm dt translated">要分析的回购的路径</li><li id="8055" class="me mf hu it b iu mn iy mo jc mp jg mq jk mr jo mj mk ml mm dt translated">存储结果的路径</li><li id="1e66" class="me mf hu it b iu mn iy mo jc mp jg mq jk mr jo mj mk ml mm dt translated">了解项目的名称</li></ul><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/2285a7fd52f9283fbf78be038f9e1fb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*i9DbbvHvEIhNxVjY.png"/></div></div></figure><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/f610a25baf23eb917b41cac8edd2d5c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*k1xp0-x5RE4BIxE5.png"/></div></div></figure><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/6c2c8cfc54b15f2399ac9eb4a941138d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6Gi-uGpehJL_luNr.png"/></div></div></figure><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ms"><img src="../Images/11a7bfad5a4b4e8163cc4df341766fc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4NOfSp6viE7fYzEw.png"/></div></div></figure><h1 id="a8e8" class="ks kl hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">运行例行程序</h1><p id="48a8" class="pw-post-body-paragraph ir is hu it b iu lp iw ix iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated">运行以下命令来启动脚本。这个脚本独立于目录，因为它直接与Github API对话。</p><pre class="jq jr js jt fq kg kf kh ki aw kj dt"><span id="b8b5" class="kk kl hu kf b fv km kn l ko kp">python3 git_analytics.py &lt;your_github_username&gt; &lt;your_github_password&gt;</span></pre><p id="0a15" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将会询问你想看哪种语言的分析。您可以输入您选择的任何语言，但是对于这个练习，输入与您在<code class="eh kc kd ke kf b">'fetch_repos.py'</code>中获取存储库完全相同的语言。</p><p id="a592" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">输入参数后，脚本将开始与API对话，并遍历15个(脚本中repos的预定义范围)存储库，分析最近4次提交中的每一次，哪些文件更改最多。这表明这些文件中出现了更多的错误，因为更大的更改更容易导致测试失败。</p><p id="444b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它将输出如下内容:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/83d424c70bab49c96b5ade19ca8db100.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zGutjwj0-kTZyHXD.png"/></div></div></figure><p id="3525" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它还将创建一个名为“analytics.md”的文件，这是在markdown中生成的输出文件，将包含所有15个存储库的输出。</p><p id="e7c1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注意:<em class="lx">您可以删除analytics.md文件，因为它是自动生成的文件，然后重新运行您的脚本以生成新文件。</em></p><h1 id="df96" class="ks kl hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">试验</h1><p id="ac37" class="pw-post-body-paragraph ir is hu it b iu lp iw ix iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated"><code class="eh kc kd ke kf b">fetch_repo_test.py</code>运行fetch_repo.py并检查设置为从Github导入的回购编号是否确实被推送到itlab</p><h1 id="ba40" class="ks kl hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">2.插件安装</h1><p id="628a" class="pw-post-body-paragraph ir is hu it b iu lp iw ix iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated"><code class="eh kc kd ke kf b">plugin_install_test.py</code>通过运行<code class="eh kc kd ke kf b">install_plugins.py</code>安装插件，并获取Jenkins中安装的所有插件，以查看脚本安装的插件是否确实安装了。</p><h1 id="6c22" class="ks kl hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">3.詹金斯创造就业机会</h1><p id="5372" class="pw-post-body-paragraph ir is hu it b iu lp iw ix iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated"><code class="eh kc kd ke kf b">jenkins_job_test.py</code>运行create_master_job.py为Gitlab中的每个repo创建作业。然后检查创建的作业数量是否等于现有的回购数量。</p><h1 id="dc97" class="ks kl hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">4.网络挂钩创建</h1><p id="6328" class="pw-post-body-paragraph ir is hu it b iu lp iw ix iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated">现在，一旦设置了web挂钩，我们就将一个样本文本文件推送到其中一个repo中，然后检查相应的Jenkins作业的构建号是否增加了。</p><h1 id="fea3" class="ks kl hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">项目的局限性</h1><ul class=""><li id="e1cc" class="me mf hu it b iu lp iy lq jc mt jg mu jk mv jo mj mk ml mm dt translated">Gradle:项目的Gradle配置可能非常不同，构建经常失败。很难分析每个回购，然后对作业DSL脚本中创建的作业进行更改。如果项目是使用maven或sbt构建的，同样很难在Job DSL中为项目存储库中指定的所有可能的构建配置设置构建选项。</li><li id="f104" class="me mf hu it b iu mn iy mo jc mp jg mq jk mr jo mj mk ml mm dt translated">由于webhooks的编程创建，我们无法对webhooks进行身份验证，并且它们是在没有令牌的情况下创建的。这可以通过手动创建webhooks来解决。</li><li id="7ad7" class="me mf hu it b iu mn iy mo jc mp jg mq jk mr jo mj mk ml mm dt translated">我们正在使用python-jenkins包。虽然我们可以用python-jenkins完成几乎所有的Jenkins任务，但是有些非常特殊的事情却做不到。例如，我们需要在Jenkins的系统配置中配置Gitlab插件。我们无法用python-jenkins或jenkins-cli做到这一点。并非所有可能的插件配置都支持API。唯一可能的选择是使用selenium这样的自动化工具或者手动完成。</li></ul><p id="d68a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你已经成功地设置了Gitlab和Jenkins，集成了JaCoCo和<em class="lx"> Understand </em>代码分析工具。我已经尽力做到尽可能全面。欢迎对本教程发表评论并留下任何问题。如果你喜欢这个博客，别忘了喜欢和分享！感谢你的阅读。干杯！</p></div><div class="ab cl mw mx hc my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="hn ho hp hq hr"><p id="fca5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="lx">原载于2018年5月15日</em><a class="ae kb" href="https://dkaushik94.github.io/devops/2018/05/15/jenkins-gitlab/" rel="noopener ugc nofollow" target="_blank"><em class="lx">dkaushik 94 . github . io</em></a><em class="lx">。</em></p></div></div>    
</body>
</html>