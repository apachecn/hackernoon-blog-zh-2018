<html>
<head>
<title>Secure NPM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保卫NPM</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/secure-npm-ca2fe0e9aeff?source=collection_archive---------11-----------------------#2018-05-15">https://medium.com/hackernoon/secure-npm-ca2fe0e9aeff?source=collection_archive---------11-----------------------#2018-05-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="a656" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">概念验证，以确保NPM软件包及其源代码之间的一致性</h2></div><h2 id="c0ff" class="jj jk hu bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg dt translated">TL；DR；</h2><p id="7db1" class="pw-post-body-paragraph kh ki hu kj b kk kl iv km kn ko iy kp ju kq kr ks jy kt ku kv kc kw kx ky kz hn dt translated"><a class="ae la" href="https://github.com/wilk/snpm" rel="noopener ugc nofollow" target="_blank"> <em class="lb"> SNPM </em> </a> <em class="lb">是一个概念验证，旨在确保NPM注册中心和公共存储库(如Github)上的开源版本之间的一致性。</em></p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="fe ff lc"><img src="../Images/dc50e7922f941caab74471e94fdb9510.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f_wzAc2irpT6U0xvvASHEQ.jpeg"/></div></div><figcaption class="lo lp fg fe ff lq lr bd b be z ek"><a class="ae la" href="https://unsplash.com/photos/IV--3UEiHlI" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="8b72" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated">4月底，<a class="ae la" rel="noopener" href="/the-node-js-collection/the-node-js-project-introduces-latest-release-line-node-js-10-x-bf07abfa9076"> <strong class="kj hv"> Node.js 10发布</strong> </a>于是NPM <a class="ae la" rel="noopener" href="/npm-inc/announcing-npm-6-5d0b1799a905"> <strong class="kj hv">宣布npm@6 </strong> </a>。<br/>版本6引入的主要特性之一是关于<a class="ae la" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank">安全性</a>:我说的是<a class="ae la" href="https://docs.npmjs.com/getting-started/running-a-security-audit" rel="noopener ugc nofollow" target="_blank"> <strong class="kj hv"> npm审计</strong> </a>。<br/>这个新命令允许用户执行<em class="lb">“安全漏洞的包依赖性评估，帮助用户保护其包的用户免受已知漏洞的影响，这些漏洞可能导致数据丢失、服务中断、对敏感信息的未授权访问等等”。这是NPM团队为整个社区做出的巨大改进。</em></p><p id="099b" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated">但是，我认为<strong class="kj hv">他们没有抓住真正的问题</strong>。</p><h1 id="ec51" class="lx jk hu bd jl ly lz ma jp mb mc md jt ja me jb jx jd mf je kb jg mg jh kf mh dt translated">重大安全漏洞</h1><p id="850a" class="pw-post-body-paragraph kh ki hu kj b kk kl iv km kn ko iy kp ju kq kr ks jy kt ku kv kc kw kx ky kz hn dt translated">2018年初，<a class="ae la" href="https://hackernoon.com/@david.gilbertson" rel="noopener ugc nofollow" target="_blank"><strong class="kj hv">@ David . gilbertson</strong></a>发表了一篇关于NPM生态系统安全脆弱性的惊人文章 。<br/>大卫当时做的是<strong class="kj hv">曝光NPM车型的一个</strong> <strong class="kj hv">重大安全漏洞</strong>。</p><blockquote class="mi"><p id="215e" class="mj mk hu bd ml mm mn mo mp mq mr kz ek translated">简而言之:NPM注册表上发布的内容可能与你在Github上看到的不同。</p></blockquote><p id="baef" class="pw-post-body-paragraph kh ki hu kj b kk ms iv km kn mt iy kp ju mu kr ks jy mv ku kv kc mw kx ky kz hn dt translated">通常，一个NPM包的源代码发布在Github上(或托管在另一个公共存储库上)，让用户能够验证项目并做出贡献。然而，当有人在NPM上发布一个新的包时，没有人能说上传的就是已经在Github上发布的。<br/>这意味着你可以在NPM上上传一段恶意代码，然后在Github上发布一段不同的无害代码，用户不会意识到。至少不是马上。</p><blockquote class="mi"><p id="7a12" class="mj mk hu bd ml mm mn mo mp mq mr kz ek translated">这削弱了开源的基础</p></blockquote><p id="395a" class="pw-post-body-paragraph kh ki hu kj b kk ms iv km kn mt iy kp ju mu kr ks jy mv ku kv kc mw kx ky kz hn dt translated">我们怎么能信任一个允许用户共享封闭源代码而没有任何方法验证其真实性的系统呢？</p><p id="0c17" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated">有趣的事实:最近，<a class="ae la" href="https://amp.reddit.com/r/Python/comments/8hvzja/backdoor_in_sshdecorator_package/?st=jgynd5qc&amp;sh=81855e72&amp;__twitter_impression=true" rel="noopener ugc nofollow" target="_blank">在一个名为ssh-decorator </a>的Python包中发现了一个后门。<br/>有人在源代码中发现了它，并提醒了用户，因此受损的软件包最终被移除。<br/>这证明了访问源代码可以让社区预防和治疗不良情况。</p><h1 id="926d" class="lx jk hu bd jl ly lz ma jp mb mc md jt ja me jb jx jd mf je kb jg mg jh kf mh dt translated">SNPM救援</h1><p id="93a9" class="pw-post-body-paragraph kh ki hu kj b kk kl iv km kn ko iy kp ju kq kr ks jy kt ku kv kc kw kx ky kz hn dt translated">所以，在大卫的文章之后，我开始创建一个<a class="ae la" href="https://github.com/wilk/snpm" rel="noopener ugc nofollow" target="_blank"> <strong class="kj hv">概念验证</strong> </a>来避免NPM的这些情况。它叫做<strong class="kj hv">安全NPM (SNPM) </strong>，我将尝试用几个简单的步骤来解释它是如何工作的。</p><p id="02af" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated"><strong class="kj hv"> <em class="lb">免责声明</em> </strong> <em class="lb"> : SNPM针对编译(二进制)和传输包进行校准，但也适用于普通包。</em></p><p id="8cfd" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated">首先，当作者想要发布他们包的新版本时，他们<strong class="kj hv">构建源代码</strong>并且<strong class="kj hv">计算编译输出的校验和</strong>。</p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div class="fe ff mx"><img src="../Images/975728ffad772732d8d1efb4efe4fc8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:936/format:webp/1*Nop9q4dsJP2cH3mzwEeDWQ.png"/></div><figcaption class="lo lp fg fe ff lq lr bd b be z ek">Build sources</figcaption></figure><p id="f51e" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated">然后，他们需要<strong class="kj hv">用新版本和校验和更新package.json </strong>。<br/> <a class="ae la" href="http://wiki.commonjs.org/wiki/Packages/1.1#Catalog_Properties" rel="noopener ugc nofollow" target="_blank"> CommonJS提供了一个名为<strong class="kj hv">校验和</strong>的字段</a>，作者可以在其中存储其代码的校验和。</p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div class="fe ff my"><img src="../Images/361632601f275fab6ac49807367cbeae.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/1*e4IJK0Wz184YP9kzFUAirg.png"/></div><figcaption class="lo lp fg fe ff lq lr bd b be z ek">Update package.json</figcaption></figure><p id="0694" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated">现在他们可以用一个新标签在Github(或另一个公共回购)上发布它。</p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div class="fe ff mz"><img src="../Images/9db9d7d5192319cf6629ae4b482cbe73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/format:webp/1*IXW6QLxX1TvqhHf_odpqjQ.png"/></div><figcaption class="lo lp fg fe ff lq lr bd b be z ek">Release on a public repository</figcaption></figure><p id="f324" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated">此时，他们可以<strong class="kj hv">通过SNPM在NPM上发布</strong>它:它将只发送少量数据，如包版本、公共存储库url和校验和。<br/>这不同于"<em class="lb"> npm publish" </em>命令，因为它不会发送完整的源代码，也不会发送编译后的文件，而只是上面的三个信息。</p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div class="fe ff na"><img src="../Images/e521fa3c43f2912ebfea4b8e19d72c42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*Su6TlXoYbYhGEFu88k7ihA.png"/></div><figcaption class="lo lp fg fe ff lq lr bd b be z ek">Publish on NPM, using SNPM</figcaption></figure><p id="523c" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated">NPM现在负责<strong class="kj hv">从公开回购中获取发布版本</strong>。</p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div class="fe ff nb"><img src="../Images/f3c6cf0f1b219578457e30ba05a64e22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*MrMo0OwJKi8OqpI32IQHsQ.png"/></div><figcaption class="lo lp fg fe ff lq lr bd b be z ek">Fetch released version tar.gz</figcaption></figure><p id="cdce" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated">NPM现在可以通过执行一系列操作来验证校验和:</p><ol class=""><li id="e4f7" class="nc nd hu kj b kk ls kn lt ju ne jy nf kc ng kz nh ni nj nk dt translated">通过<strong class="kj hv"> npm安装</strong>安装所有依赖项</li><li id="8d5d" class="nc nd hu kj b kk nl kn nm ju nn jy no kc np kz nh ni nj nk dt translated">通过<strong class="kj hv"> npm运行构建</strong>构建源代码</li><li id="4641" class="nc nd hu kj b kk nl kn nm ju nn jy no kc np kz nh ni nj nk dt translated"><strong class="kj hv">计算编译文件的校验和</strong></li><li id="3a41" class="nc nd hu kj b kk nl kn nm ju nn jy no kc np kz nh ni nj nk dt translated"><strong class="kj hv">验证校验和</strong></li></ol><figure class="ld le lf lg fq lh fe ff paragraph-image"><div class="fe ff nq"><img src="../Images/df142f2d9f532045bc70e3975c573aa9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*ol9SVx6rx0Sx5NIAm-lwbw.png"/></div><figcaption class="lo lp fg fe ff lq lr bd b be z ek">Reproduce and verify the checksum</figcaption></figure><p id="a315" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated">在这一点上，NPM有所有的信息给<strong class="kj hv">回复</strong>一个成功的答案或者一个错误。</p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div class="fe ff nq"><img src="../Images/75c96616b289c31a09153d41764a856f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*bH9nlPlhUfsSLVKL5iTi1Q.png"/></div><figcaption class="lo lp fg fe ff lq lr bd b be z ek">Reply to the publish request</figcaption></figure><p id="4e0b" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated">就是这样。<br/>遵循总结算法:</p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="fe ff nr"><img src="../Images/05d80f30d1378185f52080a34537aec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1b7KHDG2St5D-6jepfMhNA.png"/></div></div><figcaption class="lo lp fg fe ff lq lr bd b be z ek">SNPM algorithm</figcaption></figure><p id="f8a8" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated">NPM和SNPM之间的主要区别在于,(编译的)源代码不再从(不可信的)作者处上传，而是直接从公共回购(可信的)处下载，在公共回购处，每个人都可以再现相同的过程并验证校验和。</p><h1 id="22dd" class="lx jk hu bd jl ly lz ma jp mb mc md jt ja me jb jx jd mf je kb jg mg jh kf mh dt translated">结论</h1><p id="5dee" class="pw-post-body-paragraph kh ki hu kj b kk kl iv km kn ko iy kp ju kq kr ks jy kt ku kv kc kw kx ky kz hn dt translated">不幸的是，<em class="lb"> npm审计</em>并没有解决这个主要的漏洞，这个问题仍然是开放的，特别是对于二进制和缩小的<a class="ae la" href="https://hackernoon.com/tagged/javascript" rel="noopener ugc nofollow" target="_blank"> Javascript </a>。<br/>我们(作为一个社区)必须获得经过验证和确认的包。</p><p id="65db" class="pw-post-body-paragraph kh ki hu kj b kk ls iv km kn lt iy kp ju lu kr ks jy lv ku kv kc lw kx ky kz hn dt translated">无论如何，我要感谢NPM团队的出色工作，我希望这篇文章将推动他们提高有史以来最好的软件包管理器之一的安全性。</p><h2 id="67f9" class="jj jk hu bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg dt translated">***更新***</h2><p id="9c32" class="pw-post-body-paragraph kh ki hu kj b kk kl iv km kn ko iy kp ju kq kr ks jy kt ku kv kc kw kx ky kz hn dt translated">我已经在NPM的知识库上创建了一个新的问题 ，请求一个功能请求。<br/>之后，我添加了<a class="ae la" href="https://github.com/npm/npm/issues/20640#issuecomment-389762201" rel="noopener ugc nofollow" target="_blank"> <strong class="kj hv">另一个提议</strong> </a>总是在同一个线程上，叫做<strong class="kj hv"> npm verify </strong>:作为一个npm命令，它应该重现下载-构建-校验和验证过程，所以用户可以动态地验证包。</p><h2 id="4277" class="jj jk hu bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg dt translated">***更新—7月***</h2><p id="0a8c" class="pw-post-body-paragraph kh ki hu kj b kk kl iv km kn ko iy kp ju kq kr ks jy kt ku kv kc kw kx ky kz hn dt translated">我已经为NPM  和T21<a class="ae la" href="https://github.com/yarnpkg/rfcs/pull/94" rel="noopener ugc nofollow" target="_blank">提交了一份</a><a class="ae la" href="https://github.com/npm/rfcs/pull/16" rel="noopener ugc nofollow" target="_blank"> <strong class="kj hv">新RFC，为纱线</strong> </a>提交了一份RFC。</p><figure class="ld le lf lg fq lh"><div class="bz el l di"><div class="ns nt l"/></div></figure></div></div>    
</body>
</html>