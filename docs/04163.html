<html>
<head>
<title>Mastering MongoDB — Ahhh …! Someone just dropped a collection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">掌握MongoDB——啊啊啊！有人刚刚丢了一个收藏</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/mongodb-createrole-e1ca1346d3bb?source=collection_archive---------9-----------------------#2018-05-16">https://medium.com/hackernoon/mongodb-createrole-e1ca1346d3bb?source=collection_archive---------9-----------------------#2018-05-16</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="364e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你有没有遇到过这样的情况:<em class="jp">“有人在生产过程中不小心掉了整个系列？”</em>除非你能从备份中恢复数据，否则你的处境很糟糕。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/89c3c366e9870955c6d07c1fbe06446c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ULYIBaYfhVq0VyAk."/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">“A man stretching out his two hands with careless written on them in black and white” by <a class="ae kg" href="https://unsplash.com/@lensinkmitchel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Mitchel Lensink</a> on <a class="ae kg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ef1f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我遇到过几个曾经面临这种情况的客户。因此，首先采取安全措施来防止这种情况发生是很重要的。您可以通过使用用户定义的角色轻松实现这一点。</p><p id="25eb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是多部分系列文章之一，<a class="ae kg" rel="noopener" href="/p/mastering-mongodb-5544e16df023">掌握MongoDB -一天一个技巧</a>，专为您创建，通过学习<em class="jp">‘一天一个技巧’</em>来掌握<a class="ae kg" href="https://www.mongodb.com" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>。在几篇系列文章中，我将给出各种各样的技巧来加强<a class="ae kg" href="https://hackernoon.com/tagged/mongodb" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>上的安全性。在本文中，我将讨论用户定义的角色如何帮助防止有人意外删除集合。</p><h1 id="370b" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">掌握用户定义的角色</h1><h1 id="1fe6" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">什么是角色</h1><p id="d898" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">MongoDB使用基于角色的访问控制(RBAC)来管理对MongoDB系统的访问。一个<a class="ae kg" href="https://docs.mongodb.com/manual/tutorial/manage-users-and-roles/#create-a-user-defined-role" rel="noopener ugc nofollow" target="_blank">角色</a>授予用户访问MongoDB资源的权限。在角色分配之外，用户无权访问系统。</p><p id="4473" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里有一些我想让你知道的概念</p><ul class=""><li id="9278" class="lk ll hu it b iu iv iy iz jc lm jg ln jk lo jo lp lq lr ls dt translated">用户被授予一个或多个角色。</li><li id="6312" class="lk ll hu it b iu lt iy lu jc lv jg lw jk lx jo lp lq lr ls dt translated">角色授予对资源执行多组操作的权限。</li><li id="14b0" class="lk ll hu it b iu lt iy lu jc lv jg lw jk lx jo lp lq lr ls dt translated">权限由资源和对资源允许的操作组成。</li><li id="6090" class="lk ll hu it b iu lt iy lu jc lv jg lw jk lx jo lp lq lr ls dt translated">资源是一个<a class="ae kg" href="https://hackernoon.com/tagged/database" rel="noopener ugc nofollow" target="_blank">数据库</a>，一个集合或一组集合。</li><li id="7c1b" class="lk ll hu it b iu lt iy lu jc lv jg lw jk lx jo lp lq lr ls dt translated">动作指定资源上允许的操作。</li></ul><h1 id="58ef" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">为什么是用户定义的角色</h1><p id="8c37" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">MongoDB提供了许多内置角色，管理员可以使用这些角色来控制对MongoDB系统的访问。每个数据库都包括以下角色</p><p id="3be3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">数据库用户角色</p><ul class=""><li id="85c1" class="lk ll hu it b iu iv iy iz jc lm jg ln jk lo jo lp lq lr ls dt translated">阅读</li><li id="b69d" class="lk ll hu it b iu lt iy lu jc lv jg lw jk lx jo lp lq lr ls dt translated">读写</li></ul><p id="1876" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">数据库管理角色</p><ul class=""><li id="3ff8" class="lk ll hu it b iu iv iy iz jc lm jg ln jk lo jo lp lq lr ls dt translated">dbAdmin</li><li id="3a58" class="lk ll hu it b iu lt iy lu jc lv jg lw jk lx jo lp lq lr ls dt translated">用户管理</li><li id="37f9" class="lk ll hu it b iu lt iy lu jc lv jg lw jk lx jo lp lq lr ls dt translated">dbOwner</li></ul><p id="b93a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是，如果这些角色不能描述所需的权限集，您可以使用<em class="jp"> db.createRole() </em>方法创建一个新的用户定义的角色。创建角色时，您可以指定要授予访问权限的权限集。</p><h1 id="f0cd" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">读写角色具有dropCollection操作</h1><p id="bf82" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">数据库管理员通常利用内置的<em class="jp">‘read’</em>和<em class="jp">‘read write’</em>角色来限制对数据的访问。下面的<em class="jp">‘getRole’</em>命令显示了具有<em class="jp">‘read write’</em>角色的用户可以执行的各种操作。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ly lz l"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">The MongoDB getRole command to show all the granted actions for readWrite role</figcaption></figure><p id="122d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">根据本文的上下文，其中最危险的操作是<em class="jp">‘drop collection’</em>操作。如果(人类)用户确实需要拥有读&amp;写权限，建议拥有一个用户定义的角色，该角色拥有除<em class="jp">‘drop collection’</em>动作之外的所有动作，来自<em class="jp">‘read write’</em>角色。通过将此用户定义的角色分配给这些用户，管理员可以防止有人意外删除集合。</p><h1 id="f495" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">动手实验练习</h1><p id="9f04" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">本实验练习帮助您创建一个用户定义的角色，并说明与具有<em class="jp"> readWrite </em>角色的用户相比，<em class="jp"> readWriteMinusDropRole </em>如何防止有人意外删除集合。</p><h2 id="8d7f" class="ma ki hu bd kj mb mc md kn me mf mg kr jc mh mi kv jg mj mk kz jk ml mm ld mn dt translated">设置环境</h2><p id="a27f" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">首先，你需要一个玩耍的环境。我推荐使用<em class="jp"> mlaunch </em>，一个来自<a class="ae kg" href="https://github.com/rueckstiess/mtools" rel="noopener ugc nofollow" target="_blank"> <em class="jp"> mtools </em> </a>的实用工具，在您的本地机器上设置一个测试环境。如果您已经有一个启用了身份验证的环境，您可以跳过这一步。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ly lz l"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">A bash script to setup a MongoDB environment with authentication on your local machine</figcaption></figure><h2 id="1b14" class="ma ki hu bd kj mb mc md kn me mf mg kr jc mh mi kv jg mj mk kz jk ml mm ld mn dt translated">创建具有读写角色的app_user</h2><p id="737c" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">使用上述凭证登录测试环境，并在<em class="jp">社交</em>数据库上创建具有<em class="jp">读写</em>角色的<em class="jp"> app_user </em>。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ly lz l"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">A bash script to create a user with readWrite role on the social database</figcaption></figure><h2 id="7de9" class="ma ki hu bd kj mb mc md kn me mf mg kr jc mh mi kv jg mj mk kz jk ml mm ld mn dt translated">具有读写角色的用户可以删除集合</h2><p id="0d7e" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">使用<em class="jp"> app_user </em>凭证登录到测试环境，并在<em class="jp"> social </em>数据库上创建一个示例<em class="jp"> person </em>文档。由于<em class="jp"> app_user </em>具有<em class="jp"> readWrite </em>角色，该角色授予对<em class="jp"> dropCollection </em>动作的访问权限，因此命令<em class="jp"> db.person.drop() </em>执行成功，集合被丢弃。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ly lz l"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">Set of bash &amp; JavaScript to show that user with readWrite role can drop a collection</figcaption></figure><h2 id="79d0" class="ma ki hu bd kj mb mc md kn me mf mg kr jc mh mi kv jg mj mk kz jk ml mm ld mn dt translated">创建用户定义的角色</h2><p id="3d18" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">使用<em class="jp">用户</em>凭证登录到测试环境，并在<em class="jp">社交</em>数据库上创建以下内容。</p><ul class=""><li id="6a17" class="lk ll hu it b iu iv iy iz jc lm jg ln jk lo jo lp lq lr ls dt translated">一个用户定义的角色，<em class="jp">readwriteminusdroplerole</em></li><li id="8d8d" class="lk ll hu it b iu lt iy lu jc lv jg lw jk lx jo lp lq lr ls dt translated">具有<em class="jp">角色</em>的用户<em class="jp"> human_user </em></li></ul><p id="08eb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，在授予<em class="jp">readwriteminusdroplerole</em>的动作集中，没有<em class="jp"> dropCollection </em>动作。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ly lz l"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">A bash script with MongoDB commands to create a user-defined role and a user.</figcaption></figure><h2 id="aea3" class="ma ki hu bd kj mb mc md kn me mf mg kr jc mh mi kv jg mj mk kz jk ml mm ld mn dt translated">具有readWriteMinusDropRole角色的用户无法删除集合</h2><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ly lz l"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">A user with user-defined role, readWriteMinusDropRole, cannot drop a collection</figcaption></figure><h1 id="8e16" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">摘要</h1><p id="b537" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">虽然MongoDB提供了各种内置角色来提供数据库系统中通常需要的不同访问级别，但是您需要用户定义的角色来授予对MongoDB资源的细粒度操作。</p><blockquote class="mo"><p id="5941" class="mp mq hu bd mr ms mt mu mv mw mx jo ek translated">不要等到你后悔没有早点做。使用用户定义的角色来加强您的安全措施，并防止有人意外丢失集合。</p></blockquote><p id="2537" class="pw-post-body-paragraph ir is hu it b iu my iw ix iy mz ja jb jc na je jf jg nb ji jj jk nc jm jn jo hn dt translated">以下是我的客户为加强安全而采取的一些措施。</p><ul class=""><li id="2b16" class="lk ll hu it b iu iv iy iz jc lm jg ln jk lo jo lp lq lr ls dt translated">开发人员无法访问生产环境(更极端)</li><li id="6e46" class="lk ll hu it b iu lt iy lu jc lv jg lw jk lx jo lp lq lr ls dt translated">如果需要访问，将<em class="jp">【读取】</em>角色交给开发人员(非常需要)</li><li id="8fd0" class="lk ll hu it b iu lt iy lu jc lv jg lw jk lx jo lp lq lr ls dt translated">创建一个用户定义的角色，具有所有<em class="jp">‘读写’</em>动作，但不具有<em class="jp">‘删除集合’</em></li><li id="2ce2" class="lk ll hu it b iu lt iy lu jc lv jg lw jk lx jo lp lq lr ls dt translated">如果任何用户需要<em class="jp">的【读】写</em>权限，则分配上述用户定义的角色(强烈推荐)</li><li id="afee" class="lk ll hu it b iu lt iy lu jc lv jg lw jk lx jo lp lq lr ls dt translated">为您的应用程序创建一个单独的<em class="jp"> app_user </em>，并授予<em class="jp">‘read write’</em>权限，以便与MongoDB交互</li></ul><p id="5ec0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用MongoDB v3.6，您可以通过定义允许用户使用<a class="ae kg" href="https://docs.mongodb.com/manual/reference/method/db.createUser/#authentication-restrictions" rel="noopener ugc nofollow" target="_blank"><em class="jp">authenticationRestrictions</em></a>进行身份验证的IP地址范围来进一步加强安全性。但那是另一天的话题。希望你今天在“掌握MongoDB -一天一个技巧”的道路上学到了一些新东西。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="nd lz l"/></div></figure></div></div>    
</body>
</html>