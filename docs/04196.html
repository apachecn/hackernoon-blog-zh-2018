<html>
<head>
<title>Migrate API: custom Drupal-to-Drupal migration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">迁移API:自定义Drupal到Drupal的迁移</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/migrate-api-custom-drupal-to-drupal-migration-5c3b86816ece?source=collection_archive---------5-----------------------#2018-05-17">https://medium.com/hackernoon/migrate-api-custom-drupal-to-drupal-migration-5c3b86816ece?source=collection_archive---------5-----------------------#2018-05-17</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/0399adb1076ed3d4d30ac639d22e42d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jR0IdeNMvIASsBAJ.jpg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="https://goo.gl/1H4EkN" rel="noopener ugc nofollow" target="_blank">By ADCI Solutions</a></figcaption></figure><p id="ac85" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">每个开发人员迟早都会面临这个被称为“迁移”的可怕(实际上不是)过程。如果您是其中之一，那么您一定听说过Drupal 7最优秀和最可靠的模块之一:<a class="ae jg" href="https://www.drupal.org/project/migrate" rel="noopener ugc nofollow" target="_blank"> Migrate </a>。实际上，这甚至都不是模块，它是一个迁移框架，为从各种来源到Drupal的数据迁移提供了极好的API和各种强大的工具。在我看来，这种模块的存在对于Drupal社区和Drupal生态系统非常重要，因为它提供了一种将项目从另一个CMS或任何其他框架迁移到Drupal的简单方法。因此，我们可以为我们的客户提供一种相对便宜的方式来改变他们的系统，使之支持Drupal。在本文中，您将了解如何在Drupal 8中使用<strong class="jj hv">迁移API </strong>，我们将构建一个简单的模块来执行从Drupal 7到<strong class="jj hv"> Drupal 8 </strong>的迁移。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="ba2a" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">一点理论</h1><p id="31e1" class="pw-post-body-paragraph jh ji hu jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">此图中显示了迁移过程。</p><figure class="lp lq lr ls fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/ec96fd1fe91b80ef66bfd1ed8cb3daf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*E2g_AyRLj0kijas6.jpg"/></div></div></figure><p id="4aef" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这是一种常见的迁移方法，没有任何特定的Drupal方面。我们有一个源数据库(这不是必要的应该是一个数据库，它可以是CSV，XML等。)我们有一个目标数据库，当然是Drupal 8 <strong class="jj hv">数据库</strong>。正如您在这两个数据库(源和目标)之间的图表上看到的，我们有一个有序操作的列表。</p><p id="a938" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">第一个是数据获取，它是一个查询系统，让你从源数据库中获取数据。然后是映射，您可以设置源数据库中的哪个字段应该放在目标数据库的哪个源中。下一步是处理，在这个操作中，我们可以更改来自源数据库的数据。例如，我们需要改变获取数据的格式，以适应Drupal 8中的新结构。最后一个是设置，它是目标对象的一部分，设置目标数据库结构中的数据(Drupal 8数据库结构)。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="ce76" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">Drupal 8中的迁移API</h1><p id="7e73" class="pw-post-body-paragraph jh ji hu jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">让我们看看Drupal 8和<strong class="jj hv">迁移模块</strong>的进展。我们在drupal.org没有Drupal 8版本的迁移项目，因为它的大部分特性都被移植到了Drupal核心中:主迁移模块“Migrate”和用于D6和D7迁移的模块“migrate_drupal”。我说过并不是Migrate模块的所有特性都移植到了内核中，但这并不意味着与Drupal 7版本相比，我们受到了这种情况的限制，一点也不。所有这些熟悉的特性都存在于contrib项目中。下面是为Drupal 8提供Drupal 7模块所具有的特性的模块列表:</p><ol class=""><li id="102b" class="lt lu hu jj b jk jl jo jp js lv jw lw ka lx ke ly lz ma mb dt translated"><a class="ae jg" href="https://www.drupal.org/project/migrate_tools" rel="noopener ugc nofollow" target="_blank">迁移工具</a>:这个模块提供了通用的Drush命令和管理迁移的基本UI。</li><li id="ba3e" class="lt lu hu jj b jk mc jo md js me jw mf ka mg ke ly lz ma mb dt translated"><a class="ae jg" href="https://www.drupal.org/project/migrate_upgrade" rel="noopener ugc nofollow" target="_blank">迁移升级</a>:这里我们可以找到Drupal到Drupal迁移的Drush命令。</li><li id="eada" class="lt lu hu jj b jk mc jo md js me jw mf ka mg ke ly lz ma mb dt translated"><a class="ae jg" href="https://www.drupal.org/project/migrate_plus" rel="noopener ugc nofollow" target="_blank"> Migrate Plus </a>:非常有用的模块。提供API扩展，例如，PREPARE_ROW事件、一个附加的源和目标插件、一个记录良好的示例模块和一个组功能。</li><li id="b474" class="lt lu hu jj b jk mc jo md js me jw mf ka mg ke ly lz ma mb dt translated"><a class="ae jg" href="https://www.drupal.org/project/migrate_source_csv" rel="noopener ugc nofollow" target="_blank">迁移源CSV </a>，<a class="ae jg" href="https://www.drupal.org/project/migrate_spreadsheet?utm_source=medium&amp;utm_medium=social&amp;utm_campaign=MigrateAPI8&amp;utm_term=-&amp;utm_content=medium-story-MigrateAPI8" rel="noopener ugc nofollow" target="_blank">迁移电子表格</a>:两个提供特定源插件的有用模块。</li></ol><p id="2f41" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">从逻辑上讲，迁移API的结构在Drupal 7中没有太大的不同:例如，我们有源，然后我们处理来自这些源的数据，之后，所有的数据都到达目的地。在第8版中，我们有3个主要部分，通过一个插件系统实现:源、过程和目的地。</p><p id="44f8" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">默认情况下，Drupal 8包含三个迁移模块(migrate、migrate_drupal、migrate_drupal_ui ),可以帮助您从第6版或第7版进行简单的升级。此外，它需要Drupal 8的一个干净的空安装。我不得不承认，core的升级对于简单的网站来说非常合适。但这不是我们的案子。</p><p id="1335" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">假设我们必须将内容从Drupal 7中的一种内容类型“Blog”迁移到Drupal 8中的另一种内容类型——也称为“Blog ”,并迁移到现有的站点中。我们的第一次迁移很简单，所以不会有任何复杂的操作，所以数据将按原样迁移。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="f98d" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">如何为Drupal 7到Drupal 8的迁移开发一个迁移模块</h1><p id="56d1" class="pw-post-body-paragraph jh ji hu jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">让我们开始创建我们的第一个迁移模块。首先，我们需要建立一个到D7数据库的数据库连接，下面是settings.php的一个例子:</p><figure class="lp lq lr ls fq iv"><div class="bz el l di"><div class="mh mi l"/></div></figure><p id="5784" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">一旦建立了到旧站点的数据库连接，我们就可以启用必要的contrib模块并开始:</p><p id="9acd" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><em class="mj"> drush dl migrate_plus，migrate_tools </em></p><p id="f7c6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><em class="mj"> drush en migrate_plus，migrate_tools </em></p><p id="a80e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">像任何其他Drupal 8模块一样，我们需要添加yml.info文件，没什么特别的。</p><figure class="lp lq lr ls fq iv"><div class="bz el l di"><div class="mh mi l"/></div></figure><p id="e975" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">下一步，我们需要定义我们的映射。与D7不同，在D8中，映射是在中定义的配置实体。yml配置文件。与D7相比，它是建筑类的一个很好的替代品。我们将创建2个配置文件:迁移组配置和迁移本身配置。所有的配置文件都应该放在下面的“config/install”目录中，以便在安装模块的同时创建配置实体。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="cf4a" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">迁移组的定义</h1><p id="ecac" class="pw-post-body-paragraph jh ji hu jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">迁移组的配置文件的名称如下:“migrate _ plus . migration _ group . my MIG . yml”。我想注意到D8中的迁移组是由contrib模块“migrate_plus”提供的，所以我们所有的配置名称都以“migrate_plus”开头。“migrate_plus”表示这是一个组配置,“mymig”表示这是一个id。以下是带有注释的文件内容:</p><figure class="lp lq lr ls fq iv"><div class="bz el l di"><div class="mh mi l"/></div></figure><p id="f3f6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">一旦此配置将被安装并导入到数据库中，我们将在“管理/结构/迁移”页面上看到一个新的迁移组。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="8107" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">迁移和映射的定义</h1><p id="5f60" class="pw-post-body-paragraph jh ji hu jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">正如我所说，迁移也是一个配置文件。这是yml“migrate _ plus . migration . blog _ my MIG . yml”文件的第一部分，其中定义了id、迁移组等基本设置:</p><figure class="lp lq lr ls fq iv"><div class="bz el l di"><div class="mh mi l"/></div></figure><p id="040d" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在下面的部分，我们将设置一个源和一个目的地。Drupal core提供了一个用于源代码迁移的插件d7_node。此外，我们设置了需要从D7迁移的内容类型，在我们的例子中，它是“blog”。目标插件将是“实体:节点”:</p><figure class="lp lq lr ls fq iv"><div class="bz el l di"><div class="mh mi l"/></div></figure><p id="0c6f" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">当所有基本设置(如源和目的地)都设置好后，我们就可以进行映射了(定义过程)。这是基本节点属性迁移的简单映射。正如你所注意到的，它很容易阅读和理解。(当然，应该在D8中创建“博客”内容类型):</p><figure class="lp lq lr ls fq iv"><div class="bz el l di"><div class="mh mi l"/></div></figure><p id="ee33" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这就是编码部分，现在我们可以安装我们的模块，并将博客文章迁移到D8站点。在这里可以查看迁移状态:admin/structure/migrate/manage/my MIG/migrations。我通常使用Drush命令来运行迁移过程:</p><figure class="lp lq lr ls fq iv"><div class="bz el l di"><div class="mh mi l"/></div></figure><p id="525a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">或者</p><figure class="lp lq lr ls fq iv"><div class="bz el l di"><div class="mh mi l"/></div></figure></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="6896" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">充当故障检修员</h1><p id="9689" class="pw-post-body-paragraph jh ji hu jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">有时，您可以在完成迁移过程后看到以下消息:0已处理(0已创建，等等)。这条消息可能会让你困惑，但是有快速解释和解决方案。发生这种情况是因为您的迁移执行了一次，而您错过了它，所以您只需要使用以下命令回滚迁移:</p><figure class="lp lq lr ls fq iv"><div class="bz el l di"><div class="mh mi l"/></div></figure></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="b81d" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">结论</h1><p id="2f1d" class="pw-post-body-paragraph jh ji hu jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">现在我们已经了解了迁移API在Drupal 8中是如何工作的。您已经看到，在Drupal 8中没有Migrate模块的发行版并不是什么大事。首先，一些模块的特性被放入了Drupal core，而其他的在contrib项目中是可用的。</p><p id="d1d4" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">此外，我们还有一个如何构建迁移模块的示例。在以后的文章中，我们将更深入地了解如何构建复杂的定制迁移。</p><p id="13e3" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><em class="mj">原载于</em><a class="ae jg" href="https://goo.gl/66X6oE" rel="noopener ugc nofollow" target="_blank"><em class="mj">ADCI解决方案网站</em> </a> <em class="mj">。</em></p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><p id="04d2" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv">作者是</strong> <a class="ae jg" rel="noopener" href="/@usdv"> <strong class="jj hv">丹尼斯·乌索夫</strong> </a> <strong class="jj hv">，ADCI方案小组组长</strong></p><p id="8991" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">深入参与客户的业务流程让丹尼斯掌握了构建项目架构的技能。此外，他是一个非常多样化的性格，有几个爱好:拳击，弹低音吉他和口琴，看书。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><figure class="lp lq lr ls fq iv fe ff paragraph-image"><div class="ab fr cl mk"><img src="../Images/73bcb62bbfda355e913e5b86e2193e46.png" data-original-src="https://miro.medium.com/v2/format:webp/1*5kC2KhUXG-R8C8-59J1RCA.png"/></div></figure><p id="3ed5" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv">在社交网络上关注我们:</strong> <a class="ae jg" href="https://twitter.com/ADCISolutions" rel="noopener ugc nofollow" target="_blank"> Twitter </a> | <a class="ae jg" href="https://www.facebook.com/adcisolutions/" rel="noopener ugc nofollow" target="_blank">脸书</a> | <a class="ae jg" href="https://www.linkedin.com/company/adci-solutions/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a></p><div class="ml mm fm fo mn mo"><a rel="noopener follow" target="_blank" href="/drupal-stories-an-insiders-view/drupal-8-core-and-symfony-components-1de86638942b"><div class="mp ab ej"><div class="mq ab mr cl cj ms"><h2 class="bd hv fv z el mt eo ep mu er et ht dt translated">Drupal 8核心和Symfony组件</h2><div class="mv l"><h3 class="bd b fv z el mt eo ep mu er et ek translated">距离Drupal 8发布已经过去了很多时间。而不是仅仅使用面向钩子的范例和…</h3></div><div class="mw l"><p class="bd b gc z el mt eo ep mu er et ek translated">medium.com</p></div></div><div class="mx l"><div class="my l mz na nb mx nc ja mo"/></div></div></a></div></div></div>    
</body>
</html>