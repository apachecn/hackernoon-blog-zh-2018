<html>
<head>
<title>Migrating to the Dialogflow API v2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">迁移到Dialogflow API v2</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/migrating-to-the-dialogflow-api-v2-a65265b9e27f?source=collection_archive---------11-----------------------#2018-05-17">https://medium.com/hackernoon/migrating-to-the-dialogflow-api-v2-a65265b9e27f?source=collection_archive---------11-----------------------#2018-05-17</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="d310" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">访问</strong><a class="ae jp" href="https://www.mikenikles.com" rel="noopener ugc nofollow" target="_blank"><strong class="it hv">【https://www.mikenikles.com】</strong></a><strong class="it hv">获取我的最新博文。</strong></p><p id="7e10" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">2018年4月17日，<a class="ae jp" href="https://dialogflow.com/" rel="noopener ugc nofollow" target="_blank"> Dialogflow </a> API <a class="ae jp" href="https://blog.dialogflow.com/post/v2-and-enterprise-edition-generally-available/" rel="noopener ugc nofollow" target="_blank">的第2版正式发布</a>。这标志着始于2017年11月的测试阶段的结束。</p><blockquote class="jq"><p id="07a7" class="jr js hu bd jt ju jv jw jx jy jz jo ek translated">我们的API V2现在作为所有新的Dialogflow代理的默认API，所有新功能升级将只针对API V2发布。</p></blockquote><p id="6d4a" class="pw-post-body-paragraph ir is hu it b iu ka iw ix iy kb ja jb jc kc je jf jg kd ji jj jk ke jm jn jo hn dt translated">我记得在公告博客帖子中看到了上面的内容，告诉自己升级我的“<a class="ae jp" href="http://iou.mikenikles.com" rel="noopener ugc nofollow" target="_blank">我欠你的</a>”Google Assistant bot，作为了解新API的一种方式。上周末，我正是这样做的，这篇博文解释了我的方法。</p><h1 id="9ddb" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">目标受众</h1><p id="e008" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">这篇文章的重点是从使用API v2的现有Dialogflow项目迁移到新的API v2。</p><p id="6c13" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你是Dialogflow的新手，我推荐你从<a class="ae jp" href="https://dialogflow.com/docs/getting-started/basics" rel="noopener ugc nofollow" target="_blank">https://dialogflow.com/docs/getting-started/basics,</a>开始，它包含了创建Dialogflow项目的必要步骤。您不需要阅读本文的其余部分，因为v2现在是默认的API版本。</p><h1 id="c62b" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">API V1</h1><p id="2dfd" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">我最初从一个“<a class="ae jp" href="https://developers.google.com/actions/extending-the-assistant" rel="noopener ugc nofollow" target="_blank">对Google </a>的操作”项目开始，这意味着我的项目目录结构看起来像这样:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="e72c" class="lr kg hu ln b fv ls lt l lu lv">.firebaserc<br/>functions<br/>├── index.js<br/>└── package.json</span></pre><p id="235e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh lw lx ly ln b">index.js</code>文件包含我的机器人的实现逻辑，如下所示:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="a722" class="lr kg hu ln b fv ls lt l lu lv">// index.js<br/>const App = require("actions-on-google").DialogflowApp;</span><span id="e39d" class="lr kg hu ln b fv lz lt l lu lv">const welcome = app =&gt; {<br/>  app.ask('Welcome! How can I help you today?');<br/>}</span><span id="8c2b" class="lr kg hu ln b fv lz lt l lu lv">exports.iOweYou = functions.https.onRequest((request, response) =&gt; {<br/>  const app = new App({ request, response });</span><span id="9097" class="lr kg hu ln b fv lz lt l lu lv">  // Create the action map<br/>  let actionMap = new Map();<br/>  actionMap.set('input.welcome', welcome);<br/>  // ... custom actions added here</span><span id="8b2b" class="lr kg hu ln b fv lz lt l lu lv">  app.handleRequest(actionMap);<br/>});</span></pre><p id="f91e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">作为一个可视化的例子，API v1的设置如下所示:</p><figure class="li lj lk ll fq mb fe ff paragraph-image"><div class="fe ff ma"><img src="../Images/a9cf3e1661e73bcbec2a03d1bcb71e9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:642/format:webp/1*xqfT8c8ck9i2tlhKPj0arw.png"/></div></figure><h1 id="0b55" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">迁移指南</h1><p id="7fd2" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">如果你和我情况相似，想升级到v2，我强烈推荐你阅读https://dialogflow.com/docs/reference/v1-v2-migration-guide的官方迁移指南。</p><p id="4051" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我的机器人没有集成Slack、Skype或Dialogflow支持的任何其他集成。我需要迁移的只是实现端点。在迁移指南中有一章是专门针对这个用例的，并且列出了必要的步骤。如果您的bot启用了集成，请参考官方迁移指南了解详细信息。</p><p id="e63d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">总之，迁移实现端点需要您创建一个新的代理，导入v1代理(这样您就不必创建意图、实体等。从头开始)，在新代理上启用v2，升级您的实现代码，全部测试，发布到生产环境。</p><p id="2763" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在v2测试代理中，fulfillment webhook URL需要指向一个新的端点，也就是我们将要迁移到v2的端点。打开Dialogflow，选择您的v2测试代理，然后单击导航中的“实现”。在webhook的URL字段中，将<code class="eh lw lx ly ln b">V2</code>追加到已经填充的URL。</p><p id="2ec2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">到目前为止，我们已经有了一个v2代理，可以用来测试v2实现端点。少了什么？履行端点的实际v2。让我们从一个图表开始:</p><figure class="li lj lk ll fq mb fe ff paragraph-image"><div class="fe ff me"><img src="../Images/4124f1040c84b0982245985f178e5439.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*-2dXbUBovVO8blvKNhfYqw.png"/></div></figure><p id="e212" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">主<code class="eh lw lx ly ln b">index.js</code>文件导出两个函数。一个是服务于生产流量的原始<code class="eh lw lx ly ln b">iOweYou</code>，另一个是由我们升级到Dialogflow API v2的新测试代理使用的<code class="eh lw lx ly ln b">iOweYouV2</code>版本。</p><p id="f4c2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了保持条理，我建议您将v1代码提取到一个单独的<code class="eh lw lx ly ln b">index-v1.js</code>文件中，并为新代码创建一个<code class="eh lw lx ly ln b">index-v2.js</code>文件。</p><h2 id="0627" class="lr kg hu bd kh mf mg mh kl mi mj mk kp jc ml mm kt jg mn mo kx jk mp mq lb mr dt translated">Dialogflow实现库测试版</h2><p id="624d" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">作为迁移的一部分，我决定利用这个新的Node.js实现库。你可以在https://github.com/dialogflow/dialogflow-fulfillment-nodejs<a class="ae jp" href="https://github.com/dialogflow/dialogflow-fulfillment-nodejs" rel="noopener ugc nofollow" target="_blank">阅读更多相关内容并查看示例。</a></p><p id="ff67" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">虽然“我欠你”机器人目前只支持谷歌助手，但使用履行库是一个很好的起点，可以集成到8个聊天和语音平台。</p><h1 id="b654" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">API V2</h1><p id="54df" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">一旦<code class="eh lw lx ly ln b">index-v2.js</code>准备就绪并经过良好测试，就该将生产流量迁移到新的API了。鉴于v1和v2实现代码在单个文件中的分离，将生产流量迁移到v2是很简单的。下图概述了所需的内容:</p><figure class="li lj lk ll fq mb fe ff paragraph-image"><div class="fe ff me"><img src="../Images/48ce9104fc4b8530defabecbcaa5bda5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*lyjys92u1wXs1jjckrOQEA.png"/></div></figure><p id="d1db" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这些步骤包括:</p><ol class=""><li id="0c7e" class="ms mt hu it b iu iv iy iz jc mu jg mv jk mw jo mx my mz na dt translated">确保导出的<code class="eh lw lx ly ln b">iOweYou</code>属性加载了<code class="eh lw lx ly ln b">-v2</code>索引文件。</li><li id="41ff" class="ms mt hu it b iu nb iy nc jc nd jg ne jk nf jo mx my mz na dt translated">在Dialogflow中，打开生产代理并切换到API v2。</li><li id="004f" class="ms mt hu it b iu nb iy nc jc nd jg ne jk nf jo mx my mz na dt translated"><strong class="it hv">此时，生产中的bot运行在Dialogflow API v2上。</strong>我建议您像这样运行一段时间，监控日志，如果出现任何问题，恢复上面的步骤1和2，回滚到v1实现。</li><li id="0728" class="ms mt hu it b iu nb iy nc jc nd jg ne jk nf jo mx my mz na dt translated">一旦您感到满意，并且在您的对话中没有看到错误或遗漏，就可以安全地清理代码并删除<code class="eh lw lx ly ln b">index-v1.js</code>文件了。此时，您还可以在Dialogflow中删除您的测试代理。</li></ol><p id="b61f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">很简单，不是吗？</p><p id="996b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您有任何问题或建议，请留下评论，我会尽快回复您。</p></div></div>    
</body>
</html>