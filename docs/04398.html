<html>
<head>
<title>50x Faster Bitcoin Price Data Powered by MarketStore for AI Trading</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">由MarketStore支持的人工智能交易的比特币价格数据速度提高了50倍</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-achieve-50x-faster-bitcoin-price-data-queries-6864bed9349f?source=collection_archive---------11-----------------------#2018-05-24">https://medium.com/hackernoon/how-to-achieve-50x-faster-bitcoin-price-data-queries-6864bed9349f?source=collection_archive---------11-----------------------#2018-05-24</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="465f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们的上一篇文章“<a class="ae jp" href="https://blog.alpaca.markets/blog/2018/5/8/how-to-setup-bitcoin-historical-price-data-for-algo-trading-in-fiveminutes" rel="noopener ugc nofollow" target="_blank">如何在五分钟</a>内建立用于Algo交易的比特币历史价格数据”中，我们介绍了如何在五分钟内建立<a class="ae jp" href="https://hackernoon.com/tagged/bitcoin" rel="noopener ugc nofollow" target="_blank">比特币</a>价格数据，我们在开源的<a class="ae jp" href="https://github.com/alpacahq/marketstore" rel="noopener ugc nofollow" target="_blank"> MarketStore </a>上获得了很多很好的反馈和贡献。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/d8a84eeb57db55e604235393433d0682.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Puhl0i93nSzUeZx0hFjOEg.jpeg"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">Photo by <a class="ae jp" href="https://unsplash.com/photos/l75UcYjdiC0?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">chuttersnap</a> on <a class="ae jp" href="https://unsplash.com/search/photos/speed?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="945f" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">数据速度非常重要</h1><p id="c372" class="pw-post-body-paragraph ir is hu it b iu le iw ix iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo hn dt translated">今天，我想告诉您MarketStore使用相同数据的速度有多快，以便您可以看到使用令人惊叹的开源金融时间序列数据库的性能优势。</p><h2 id="764a" class="lj kh hu bd ki lk ll lm km ln lo lp kq jc lq lr ku jg ls lt ky jk lu lv lc lw dt translated">更快的数据意味着更多的回溯测试和更多的机器学习训练</h2><p id="e23e" class="pw-post-body-paragraph ir is hu it b iu le iw ix iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo hn dt translated">更快的数据意味着我们的交易算法需要更多的回溯测试和更多的机器学习训练。我们在这个领域看到了许多成功的基于机器学习的交易算法，但我们学到的关键点之一是<strong class="it hv">数据速度非常重要</strong>。这不仅对于回溯测试很重要，对于<strong class="it hv">训练人工智能风格的算法也很重要，因为它本质上需要一个迭代过程</strong>。</p><p id="2bb1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是另一篇一步一步带你看的文章。但是TL；博士，它真的很快。</p><h1 id="ce34" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">设置</h1><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff lx"><img src="../Images/33331bb65f45a56f8f6774d3865baa88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0_2I9Z0KCDgLeVwUa4pTtw.png"/></div></div></figure><p id="7f8a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上次，我们展示了如何使用MarketStore设置历史每日比特币价格数据。</p><p id="6dde" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这一次，我们使用称为后台工作器的相同机制存储所有分钟级别的历史价格，但是配置略有不同。</p><pre class="jr js jt ju fq ly lz ma mb aw mc dt"><span id="040d" class="lj kh hu lz b fv md me l mf mg">root_directory: /project/data/mktsdb<br/>listen_port: 5993<br/># timezone: "America/New_York"<br/>log_level: info<br/>queryable: true<br/>stop_grace_period: 0<br/>wal_rotate_interval: 5<br/>enable_add: true<br/>enable_remove: false<br/>enable_last_known: false<br/>triggers:<br/>  - module: ondiskagg.so<br/>    on: "*/1Min/OHLCV"<br/>    config:<br/>      destinations:<br/>        - 5Min<br/>        - 15Min<br/>        - 1H<br/>        - 1D<br/>bgworkers:<br/>  - module: gdaxfeeder.so<br/>    name: GdaxFetcher<br/>    config:<br/>      query_start: "2016-01-01 00:00"<br/>      base_timefame: “1Min”<br/>      symbols:<br/>        - BTC</span></pre><h2 id="e8a4" class="lj kh hu bd ki lk ll lm km ln lo lp kq jc lq lr ku jg ls lt ky jk lu lv lc lw dt translated">将近2.5年，有超过100万根棒线</h2><p id="653a" class="pw-post-body-paragraph ir is hu it b iu le iw ix iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo hn dt translated">与上次不同的是，从2016年1月1日开始，后台工作器配置为获取1分钟棒线数据，而不是1天棒线数据。也就是<strong class="it hv">差不多2.5年有100多万根棒线</strong>。您需要让服务器运行一天左右来填充所有数据，因为GDAX的历史价格API不允许您快速获取那么多数据点。</p><p id="e404" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">同样，数据提取工人小心地控制数据提取速度，以防API返回“速率限制”错误。所以你只需要睡一觉。</p><p id="c940" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里的附加配置称为“磁盘上聚合”触发器。它的作用是聚合较低分辨率的1分钟条形数据(此处为5分钟、15分钟、1小时和1天)。</p><h2 id="ea2f" class="lj kh hu bd ki lk ll lm km ln lo lp kq jc lq lr ku jg ls lt ky jk lu lv lc lw dt translated">检查较长的时间范围，以验证进/出信号</h2><p id="d3d9" class="pw-post-body-paragraph ir is hu it b iu le iw ix iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo hn dt translated">在一个典型的交易策略中，<strong class="it hv">你将需要检查更长的时间范围来验证进场/出场信号，即使你在分钟级别上工作</strong>。所以这是一个非常重要的特性。您需要非常复杂的LEFT JOIN查询来实现SQL中相同的时间窗口聚合。但是使用MarketStore，您所需要的只是配置文件中的这一小部分。</p><p id="3676" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们在本次测试中使用的机器是一台典型的Ubuntu虚拟机，配有8个英特尔至强处理器E5–2673 v3 @ 2.40 GHz、32GB内存和固态硬盘。</p><h1 id="a198" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">基准</h1><p id="8842" class="pw-post-body-paragraph ir is hu it b iu le iw ix iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo hn dt translated">我们将在<a class="ae jp" href="https://hackernoon.com/tagged/python" rel="noopener ugc nofollow" target="_blank"> python </a>中拥有一个DataFrame对象，它保存了自2016年1月以来来自服务器的比特币的所有分钟级历史价格数据。我们比较MarketStore和PostgreSQL。</p><h2 id="4af3" class="lj kh hu bd ki lk ll lm km ln lo lp kq jc lq lr ku jg ls lt ky jk lu lv lc lw dt translated"><em class="mh">不幸的是，这个领域的很多人都在使用某种SQL数据库</em></h2><p id="7116" class="pw-post-body-paragraph ir is hu it b iu le iw ix iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo hn dt translated">PostgreSQL并不真的是这种类型数据的存储库，但是不幸的是，这个领域的很多人都在使用某种SQL数据库来达到这个目的，因为没有其他选择。这就是我们建立MarketStore的原因。</p><p id="7aa3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">PostgreSQL端的比特币数据的表定义是这样的。</p><pre class="jr js jt ju fq ly lz ma mb aw mc dt"><span id="6b04" class="lj kh hu lz b fv md me l mf mg">btc=# \d prices<br/>             Table "public.prices"<br/> Column |            Type | Modifiers<br/>--------+-----------------------------+-----------<br/> t      | timestamp without time zone |<br/> open   | double precision            |<br/> high   | double precision            |<br/> low    | double precision            |<br/> close  | double precision            |<br/> volume | double precision            |</span></pre><p id="2ef0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">代码如下所示。</p><pre class="jr js jt ju fq ly lz ma mb aw mc dt"><span id="648a" class="lj kh hu lz b fv md me l mf mg"># For postgres<br/>def get_df_from_pg_one(conn, symbol):<br/>   tbl = f'"{symbol}"'<br/>   cur = conn.cursor()<br/>   # order by timestamp, so the client doesn’t have to do it<br/>   cur.execute(f"SELECT t, open, high, low, close, volume FROM {tbl} ORDER BY t")<br/>   times = []<br/>   opens = []<br/>   highs = []<br/>   lows = []<br/>   closes = []<br/>   volumes = []<br/>   for t, open, high, low, close, volume in cur.fetchall():<br/>       times.append(t)<br/>       opens.append(open)<br/>       highs.append(high)<br/>       lows.append(low)<br/>       closes.append(close)<br/>       volumes.append(volume)</span><span id="a459" class="lj kh hu lz b fv mi me l mf mg">   return pd.DataFrame(dict(<br/>       open=opens,<br/>       high=highs,<br/>       low=lows,<br/>       close=closes,<br/>       volume=volumes,<br/>   ), index=times)</span><span id="fa7d" class="lj kh hu lz b fv mi me l mf mg"># For MarketStore<br/>def get_df_from_mkts_one(symbol):<br/>   params = pymkts.Params(symbol, '1Min', 'OHLCV')<br/>   return pymkts.Client('http://localhost:6000/rpc'<br/>                        ).query(params).first().df()</span></pre><h2 id="e813" class="lj kh hu bd ki lk ll lm km ln lo lp kq jc lq lr ku jg ls lt ky jk lu lv lc lw dt translated">获取DataFrame对象不需要太多的客户端代码</h2><p id="21a2" class="pw-post-body-paragraph ir is hu it b iu le iw ix iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo hn dt translated">输入和输出基本相同，给出一个符号名，通过网络查询远程服务器，得到一个数据帧。MarketStore的一个强大优势是<strong class="it hv">您不需要太多的客户端代码来获取DataFrame对象</strong>，因为wire协议被设计为高效地给出一组数字。</p><h1 id="3a03" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">结果呢</h1><h2 id="f07f" class="lj kh hu bd ki lk ll lm km ln lo lp kq jc lq lr ku jg ls lt ky jk lu lv lc lw dt translated">首先，PostgreSQL</h2><pre class="jr js jt ju fq ly lz ma mb aw mc dt"><span id="ee0d" class="lj kh hu lz b fv md me l mf mg">%time df = example.get_df_from_pg_one(conn, 'prices')<br/>CPU times: user 8.11 s, sys: 414 ms, total: 8.53 s<br/>Wall time: 15.3 s</span></pre><h2 id="b05e" class="lj kh hu bd ki lk ll lm km ln lo lp kq jc lq lr ku jg ls lt ky jk lu lv lc lw dt translated">和市场商店</h2><pre class="jr js jt ju fq ly lz ma mb aw mc dt"><span id="2640" class="lj kh hu lz b fv md me l mf mg">%time df = example.get_df_from_mkts_one('BTC')<br/>CPU times: user 109 ms, sys: 69.5 ms, total: 192 ms<br/>Wall time: 291 ms</span></pre><p id="0498" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然，两种结果看起来都一样，如下图所示。</p><pre class="jr js jt ju fq ly lz ma mb aw mc dt"><span id="5738" class="lj kh hu lz b fv md me l mf mg">In [21]: df.head()<br/>Out[21]:<br/>                      open high low close   volume<br/>2016-01-01 00:00:00  430.35 430.39 430.35  430.39 0.0727<br/>2016-01-01 00:01:00  430.38 430.40 430.38  430.40 0.9478<br/>2016-01-01 00:02:00  430.40 430.40 430.40  430.40 1.6334<br/>2016-01-01 00:03:00  430.39 430.39 430.36  430.36 12.5663<br/>2016-01-01 00:04:00  430.39 430.39 430.39  430.39 1.9530</span><span id="fc4c" class="lj kh hu lz b fv mi me l mf mg">In [22]: df.shape<br/>Out[22]: (1198274, 5)</span></pre><h2 id="3ee2" class="lj kh hu bd ki lk ll lm km ln lo lp kq jc lq lr ku jg ls lt ky jk lu lv lc lw dt translated">50倍的差异</h2><p id="0edd" class="pw-post-body-paragraph ir is hu it b iu le iw ix iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo hn dt translated">当时一个比特币大约是430美元……无论如何，<strong class="it hv">你可以看到0.3秒和15秒之间的差异，这大约是50倍的差异</strong>。请记住，您可能需要一次又一次地获得相同的数据，用于不同类型的回溯测试和优化以及ML训练。</p><p id="b3c0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，你可能不仅想查询比特币，还想查询其他硬币、股票和法定货币，因为整个数据库通常不适合你的主内存。</p><h2 id="8b83" class="lj kh hu bd ki lk ll lm km ln lo lp kq jc lq lr ku jg ls lt ky jk lu lv lc lw dt translated">MarketStore的可扩展性优势</h2><p id="5899" class="pw-post-body-paragraph ir is hu it b iu le iw ix iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo hn dt translated">MarketStore可以非常高效地在一个查询中提供多个符号/时间范围，而使用PostgreSQL和其他关系数据库，您需要一次查询一个表，因此当您需要多个工具时，MarketStore还具有可伸缩性优势。</p><h2 id="22ff" class="lj kh hu bd ki lk ll lm km ln lo lp kq jc lq lr ku jg ls lt ky jk lu lv lc lw dt translated">查询美股7.7K符号</h2><p id="913c" class="pw-post-body-paragraph ir is hu it b iu le iw ix iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo hn dt translated">为了给这种力量一点感觉，下面是作为内部测试对美国股票的7.7K符号进行查询的结果。</p><pre class="jr js jt ju fq ly lz ma mb aw mc dt"><span id="be82" class="lj kh hu lz b fv md me l mf mg">%time dfs = example.get_dfs_from_pg(symbols)<br/>CPU times: user 52.9 s, sys: 2.33 s, total: 55.3 s<br/>Wall time: 1min 26s</span><span id="923d" class="lj kh hu lz b fv mi me l mf mg">%time dfs = example.get_dfs_from_mkts(symbols)<br/>CPU times: user 814 ms, sys: 313 ms, total: 1.13 s<br/>Wall time: 6.24 s</span></pre><p id="5a0a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">同样，数据量是相同的，在这种情况下，每个数据帧都不像比特币那样大，但扩展到大量工具时，差异是显著的(超过10倍)。你可以想象在现实生活中，这两个因素(每台仪器和多台仪器)会成倍增加数据成本。</p><h2 id="8337" class="lj kh hu bd ki lk ll lm km ln lo lp kq jc lq lr ku jg ls lt ky jk lu lv lc lw dt translated">羊驼一直在我们的生产中使用MarkStore</h2><p id="d24f" class="pw-post-body-paragraph ir is hu it b iu le iw ix iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo hn dt translated">羊驼一直在我们的生产中使用MarkStore，用于我们的专有客户和我们自己的algo交易用例。令人惊讶的是，这个软件对每个人都是免费的，我们利用这项技术来帮助我们的algo交易客户。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="mj mk l"/></div></figure></div><div class="ab cl ml mm hc mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="hn ho hp hq hr"><figure class="jr js jt ju fq jv fe ff paragraph-image"><a href="https://medium.com/automation-generation"><div class="fe ff ms"><img src="../Images/4d7d212ef68dd071daeaae0916d72f65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JgwdHnaQXAnW0LtrVSpdMA.png"/></div></a></figure><h2 id="0a5c" class="lj kh hu bd ki lk ll lm km ln lo lp kq jc lq lr ku jg ls lt ky jk lu lv lc lw dt translated">请关注<a class="ae jp" rel="noopener" href="/@alpacahq">羊驼</a>和<a class="ae jp" href="https://medium.com/automation-generation" rel="noopener">自动化世代</a>关于金融市场、算法交易、技术的新帖子。</h2><h2 id="175e" class="lj kh hu bd ki lk ll lm km ln lo lp kq jc lq lr ku jg ls lt ky jk lu lv lc lw dt translated">你可以找到我们<a class="ae jp" href="https://twitter.com/AlpacaHQ" rel="noopener ugc nofollow" target="_blank">@羊驼HQ </a>，如果你用twitter的话。</h2><figure class="jr js jt ju fq jv fe ff paragraph-image"><a href="https://medium.com/automation-generation"><div class="fe ff mt"><img src="../Images/cdfe4e1b3df7ff7b28e2474ff8dfef1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1xnDRs1aVpqUjToFRmk5Zw.png"/></div></a></figure></div><div class="ab cl ml mm hc mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="hn ho hp hq hr"><p id="0589" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你是一名黑客，并且可以创建一些在金融市场中工作的很酷的东西，请查看我们的项目"<a class="ae jp" href="https://alpaca.markets/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=strategy_list&amp;utm_content=part1" rel="noopener ugc nofollow" target="_blank">免佣金股票交易API </a>"，在那里我们免费提供简单的REST交易API和实时市场数据。</p><p id="8f8c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">经纪服务由FINRA/SIPC成员Alpaca Securities LLC(<a class="ae jp" href="https://alpaca.markets/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=strategy_list&amp;utm_content=part1" rel="noopener ugc nofollow" target="_blank">Alpaca . markets</a>)提供。羊驼证券有限责任公司是AlpacaDB，Inc .的全资子公司。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="mu mk l"/></div></figure></div></div>    
</body>
</html>