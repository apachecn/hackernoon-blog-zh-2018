<html>
<head>
<title>Iterative Terraform Development with Skaffold and Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Skaffold和Kubernetes进行迭代地形开发</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/iterative-terraform-development-with-skaffold-and-kubernetes-42cb6d60f7dc?source=collection_archive---------4-----------------------#2018-06-03">https://medium.com/hackernoon/iterative-terraform-development-with-skaffold-and-kubernetes-42cb6d60f7dc?source=collection_archive---------4-----------------------#2018-06-03</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="b92a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Kubernetes 和<strong class="it hv"> Terraform </strong>是两个众所周知的用于构建基础设施的基础开源工具。它们在性质和应用场景上有很大不同，但也有很多相似和交叉之处。我将跳过哲学方面，展示两种技术可以相互补充的实际例子。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/2d38c591112ee3bb1f4154de1c7f41d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FZ-Cv69KAMFrAc6XBu7Oew.png"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">cisco.com</figcaption></figure><p id="6862" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">什么是普遍？</strong></p><ul class=""><li id="fd30" class="kf kg hu it b iu iv iy iz jc kh jg ki jk kj jo kk kl km kn dt translated"><strong class="it hv">多用途</strong>和<strong class="it hv"> </strong>涵盖基础设施、应用和服务。</li><li id="72a7" class="kf kg hu it b iu ko iy kp jc kq jg kr jk ks jo kk kl km kn dt translated">提供<strong class="it hv">抽象</strong>并隐藏底层基础设施的复杂性。</li><li id="b93d" class="kf kg hu it b iu ko iy kp jc kq jg kr jk ks jo kk kl km kn dt translated"><strong class="it hv">云不可知</strong>并支持混合云开发。</li><li id="09be" class="kf kg hu it b iu ko iy kp jc kq jg kr jk ks jo kk kl km kn dt translated"><strong class="it hv">期望状态和</strong>允许关注最终结果，绕过中间步骤编程。</li></ul><h1 id="0096" class="kt ku hu bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq dt translated">开发经验</h1><p id="265b" class="pw-post-body-paragraph ir is hu it b iu lr iw ix iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo hn dt translated"><strong class="it hv">地形配置与Kubernetes清单</strong></p><p id="8ac5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在最低层次上，使用这两种工具的工作假设在<a class="ae lw" href="http://yaml.org" rel="noopener ugc nofollow" target="_blank"> YAML </a> / <a class="ae lw" href="https://github.com/hashicorp/hcl" rel="noopener ugc nofollow" target="_blank"> HCL </a>或<a class="ae lw" href="https://www.json.org" rel="noopener ugc nofollow" target="_blank"> JSON </a>中编写DSL清单，验证并提交它们以便使用<strong class="it hv"> terraform </strong>或<strong class="it hv">ku bectl</strong>CLI<strong class="it hv">T29】工具执行。虽然这种方法对于临时任务或“快速启动”很好，但它缺乏迭代部署、堆栈生命周期管理和第三方自动化重用。</strong></p><p id="472c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">模块和</strong> <a class="ae lw" href="http://www.helm.sh" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">舵</strong> </a> <strong class="it hv">包</strong></p><p id="8b73" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过使用具有terraform的公共<a class="ae lw" href="https://registry.terraform.io" rel="noopener ugc nofollow" target="_blank">注册表</a>的<a class="ae lw" href="https://www.terraform.io/docs/state/workspaces.html" rel="noopener ugc nofollow" target="_blank">工作空间</a>和<a class="ae lw" href="https://www.terraform.io/docs/modules/usage.html" rel="noopener ugc nofollow" target="_blank">模块</a>部分解决了上述限制。对于Kubernetes来说，它是通过使用<a class="ae lw" href="https://www.helm.sh" rel="noopener ugc nofollow" target="_blank">舵</a>和众多可用的<a class="ae lw" href="https://github.com/kubernetes/charts" rel="noopener ugc nofollow" target="_blank">图表</a>来改进的。然而，这一级别的开发假设花费大量的人工努力来完成工作并实现持续的部署。</p><p id="e25b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">开箱即用CI/CD </strong></p><p id="4447" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是最有趣的部分，与kubernetes相比，terraform <em class="lx"> opensource </em>生态系统缺少很多东西，你需要弄脏你的手来获得基本的CI/CD。</p><p id="7cfc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一些例子:</p><ul class=""><li id="ccc5" class="kf kg hu it b iu iv iy iz jc kh jg ki jk kj jo kk kl km kn dt translated"><strong class="it hv">管理secrets</strong>至关重要，因为你需要与不同的云平台API进行通信，你不能将敏感数据保存在代码中。虽然在Kubernetes中通过加密机密、<a class="ae lw" href="https://www.vaultproject.io/docs/auth/kubernetes.html" rel="noopener ugc nofollow" target="_blank">保险库集成</a>和<a class="ae lw" href="https://kubernetes.io/docs/concepts/extend-kubernetes/service-catalog/" rel="noopener ugc nofollow" target="_blank">服务目录</a>设计启用，但您需要花费一些宝贵的时间来集成到您的CI for terraform中。</li><li id="9bc4" class="kf kg hu it b iu ko iy kp jc kq jg kr jk ks jo kk kl km kn dt translated">开箱即用<strong class="it hv">自动化</strong>持续开发<strong class="it hv">开发和生产的工作流程</strong>。简单来说，terraform缺少类似于<a class="ae lw" href="https://github.com/GoogleContainerTools/skaffold" rel="noopener ugc nofollow" target="_blank"> skaffold </a>、<a class="ae lw" href="https://github.com/Azure/draft" rel="noopener ugc nofollow" target="_blank"> draft </a>、<a class="ae lw" href="https://github.com/hasura/gitkube" rel="noopener ugc nofollow" target="_blank"> gitkube </a>甚至<a class="ae lw" href="https://metaparticle.io" rel="noopener ugc nofollow" target="_blank"> metaparticle </a>的“Day 0”工具，这些工具实现了典型的开发流程，并形成了you管道的基础。</li></ul><h1 id="0772" class="kt ku hu bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq dt translated">如果我们可以使用Kubernetes工具来制作Terraform呢？</h1><p id="e2d6" class="pw-post-body-paragraph ir is hu it b iu lr iw ix iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo hn dt translated">除了利用最大和最大的生态系统之外，我们可以统一两者的工具和开发经验，因此，最小化维护工作。</p><h2 id="f1c3" class="ly ku hu bd kv lz ma mb kz mc md me ld jc mf mg lh jg mh mi ll jk mj mk lp ml dt translated">原型</h2><p id="b413" class="pw-post-body-paragraph ir is hu it b iu lr iw ix iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo hn dt translated">我已经创建了草案包，它说明了上述内容，并使用skaffold，helm自动化terraform开发，并内置了<a class="ae lw" href="https://www.packer.io/intro/index.html" rel="noopener ugc nofollow" target="_blank">打包器</a>、<a class="ae lw" href="https://www.vaultproject.io" rel="noopener ugc nofollow" target="_blank">金库</a>集成。本质上，每个地形的改变都会导致头盔版本的升级，并且可以很容易地与<a class="ae lw" href="https://itnext.io/jenkins-x-or-2-0-db17138b3ba2" rel="noopener ugc nofollow" target="_blank">詹金斯X </a>集成。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mm"><img src="../Images/e408c0800897710692f7dbdcc106a7ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I9u_ot8PNITsl-rIQXizCQ.png"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Jenkins X Terraform pipeline reference architecture</figcaption></figure><h1 id="59c8" class="kt ku hu bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq dt translated">快速入门</h1><p id="8e54" class="pw-post-body-paragraph ir is hu it b iu lr iw ix iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo hn dt translated">先决条件:安装吃水，斯卡福德，头盔，库伯内特斯</p><p id="8f59" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">克隆存储库并安装草稿包:</p><pre class="jq jr js jt fq mn mo mp mq aw mr dt"><span id="43a1" class="ly ku hu mo b fv ms mt l mu mv">git clone <a class="ae lw" href="https://github.com/odzhu/infrapack.git" rel="noopener ugc nofollow" target="_blank">https://github.com/odzhu/infrapack.git</a><br/>cd infrapack<br/>cd tests/ &amp;&amp; make addpack</span></pre><p id="2e09" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用skaffold根据示例代码运行Packer和Terraform构建和部署</p><pre class="jq jr js jt fq mn mo mp mq aw mr dt"><span id="34e9" class="ly ku hu mo b fv ms mt l mu mv">make test</span></pre><p id="8750" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在发动机罩下，它将:</p><ol class=""><li id="0663" class="kf kg hu it b iu iv iy iz jc kh jg ki jk kj jo mw kl km kn dt translated">创建临时目录并复制样本terraform和packer代码。</li><li id="5e20" class="kf kg hu it b iu ko iy kp jc kq jg kr jk ks jo mw kl km kn dt translated">使用舵图执行草图创建和获取代码。</li><li id="82f1" class="kf kg hu it b iu ko iy kp jc kq jg kr jk ks jo mw kl km kn dt translated">构建和部署。</li></ol><pre class="jq jr js jt fq mn mo mp mq aw mr dt"><span id="61e3" class="ly ku hu mo b fv ms mt l mu mv">NAME:   infrapack<br/>LAST DEPLOYED: Wed May 30 18:58:11 2018<br/>NAMESPACE: default<br/>STATUS: DEPLOYED</span><span id="e76b" class="ly ku hu mo b fv mx mt l mu mv">RESOURCES:<br/>==&gt; v1/ServiceAccount<br/>NAME                 SECRETS  AGE<br/>infrapack-infrapack  1        0s</span><span id="4bcb" class="ly ku hu mo b fv mx mt l mu mv">==&gt; v1/Role<br/>NAME                    AGE<br/>state-writer-infrapack  0s</span><span id="a390" class="ly ku hu mo b fv mx mt l mu mv">==&gt; v1/RoleBinding<br/>NAME                    AGE<br/>state-writer-infrapack  0s</span><span id="ca09" class="ly ku hu mo b fv mx mt l mu mv">==&gt; v1/Job<br/>NAME                  DESIRED  SUCCESSFUL  AGE<br/>infrapack-infrapack1  1        0           0s</span><span id="ec19" class="ly ku hu mo b fv mx mt l mu mv">==&gt; v1/Pod(related)<br/>NAME                        READY  STATUS   RESTARTS  AGE<br/>infrapack-infrapack1-97r8t  0/1    Pending  0         0s</span><span id="a4b5" class="ly ku hu mo b fv mx mt l mu mv">==&gt; v1/Secret<br/>NAME             TYPE    DATA  AGE<br/>state-infrapack  Opaque  1     0s</span><span id="c94a" class="ly ku hu mo b fv mx mt l mu mv">==&gt; v1/ConfigMap<br/>NAME                DATA  AGE<br/>scripts-infrapack1  3     0s</span><span id="9505" class="ly ku hu mo b fv mx mt l mu mv">Deploy complete in 585.116428ms<br/>0 tests$ helm list<br/>NAME      REVISION UPDATED                  STATUS   CHART      NAMESPACE<br/>infrapack 1        Wed May 30 18:58:11 2018 DEPLOYED hcl-v0.1.0 default</span></pre><p id="1090" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">切换到临时目录并启动skaffold。</p><pre class="jq jr js jt fq mn mo mp mq aw mr dt"><span id="7508" class="ly ku hu mo b fv ms mt l mu mv">cd /tmp/sandbox/ &amp;&amp; skaffold dev</span></pre><p id="ff44" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该环境已准备好沙盒，任何代码更改将自动应用，您可以检查舵释放的细节！</p></div></div>    
</body>
</html>