<html>
<head>
<title>Monitor your HTTPS certificate expiry with this script</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用此脚本监控您的HTTPS证书到期时间</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/monitor-your-https-certificate-expiry-with-this-script-1338bf5acfe9?source=collection_archive---------33-----------------------#2018-06-04">https://medium.com/hackernoon/monitor-your-https-certificate-expiry-with-this-script-1338bf5acfe9?source=collection_archive---------33-----------------------#2018-06-04</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="e90f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">去年除夕，我接到客户的电话。他们说他们的网站被病毒感染了，没有人能访问它。</p><p id="27e4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我的客户经营着一家果汁店，他不知道网络在技术上是如何工作的，所以我放弃了“病毒”问题，但他说网站无法访问，所以我启动了手机中的Firefox，看到了<code class="eh jp jq jr js b">Your connection is not secure</code>页面。</p><p id="d47a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">自从Let's <a class="ae jt" href="https://hackernoon.com/tagged/encrypt" rel="noopener ugc nofollow" target="_blank"> Encrypt </a>发布测试版以来，我一直用它将我和我客户的所有网站转换成通过<a class="ae jt" href="https://hackernoon.com/tagged/https" rel="noopener ugc nofollow" target="_blank"> HTTPS </a>的安全连接。我已经按照<a class="ae jt" href="https://certbot.eff.org/" rel="noopener ugc nofollow" target="_blank"> certbot </a>的指示建立了一个cron来定期更新证书，但是它曾经每隔一段时间就会失败，因为我没有更新python包，或者类似的事情。Let's Encrypt非常友好，可以在过期前发送邮件，但初始安装是由一名员工完成的，因此邮件会发送到她的地址。</p><p id="d9f2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因为那天是12月31日，我在一个聚会上，没有靠近我的机器的地方，我可以用ssh进入服务器并杀死这个怪物。我的手机上有JuiceSSH，我用它登录到服务器(感谢上帝我已经按照授权添加了我的密钥)，更新了包并更新了证书。</p><p id="3dfa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">与此同时，我周围的人从10开始倒数。</p><h1 id="bb2e" class="ju jv hu bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated">不宣誓</h1><p id="8f6b" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">这甚至不是第一次发生这种情况，所以我当时就决定，我要自己解决这个问题。我小心翼翼地选择不把它作为我的新年决心，否则明年我还会讲同样的故事。</p><p id="8eb2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，在1月1日，我写了一个Ruby脚本(一分钟后会有更多内容)并不断改进它，以捕捉HTTPS安装的各种危险信号，包括证书是否被吊销、受<a class="ae jt" href="https://security.googleblog.com/2017/09/chromes-plan-to-distrust-symantec.html" rel="noopener ugc nofollow" target="_blank">赛门铁克混乱</a>影响、自签名或超过/接近到期日期、验证信任链等。该脚本最终被转换成一个名为<a class="ae jt" href="https://monitorcertificates.com/" rel="noopener ugc nofollow" target="_blank"> Monitor Certificates </a>的web应用程序，但现在让我们回到脚本上来。</p><h1 id="c5ee" class="ju jv hu bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated">获取证书</h1><p id="eac4" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">您需要做的第一件事是从一个域获取证书。令人惊讶的是，这很难实现。我是用Ruby发出请求的<code class="eh jp jq jr js b"><a class="ae jt" href="https://github.com/jnunemaker/httparty/" rel="noopener ugc nofollow" target="_blank">HTTParty</a></code>的忠实粉丝，但不幸的是我找不到让它返回证书的方法。</p><p id="4ea9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以我向下一层抽象，使用了<code class="eh jp jq jr js b">Net::HTTP</code>。要获得证书，你必须跑步</p><pre class="kx ky kz la fq lb js lc ld aw le dt"><span id="2a0b" class="lf jv hu js b fv lg lh l li lj">require 'net/http'<br/>require 'openssl'<br/><br/>domain_name = "example.com"<br/><br/>uri = URI::HTTPS.build(host: domain_name)<br/>response = Net::HTTP.start(uri.host, uri.port, :use_ssl =&gt; true)<br/>cert = response.peer_cert</span></pre><p id="7a3e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这在<code class="eh jp jq jr js b">cert</code>变量中给了你一个证书对象。该变量属于<code class="eh jp jq jr js b">OpenSSL::X509::Certificate</code>类型。这些被称为<a class="ae jt" href="https://en.wikipedia.org/wiki/X.509" rel="noopener ugc nofollow" target="_blank"> X.509证书</a>，它们是公钥证书的标准。</p><p id="d4ef" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">X.509证书为我们提供了许多关于证书的详细信息，包括谁颁发的、何时颁发的、何时到期、如何发现证书是否被吊销，以及大量其他有用的信息。</p><h1 id="43f6" class="ju jv hu bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated">查找到期日期</h1><p id="fb75" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">要找到证书失效的日期，你只需要打电话给<code class="eh jp jq jr js b">cert.not_after</code>。这将返回一个Time对象，它告诉我们证书何时到期。</p><p id="fee7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，如果您希望在证书到期前的2周内每天都收到通知，那么您的脚本将如下所示</p><pre class="kx ky kz la fq lb js lc ld aw le dt"><span id="8e7a" class="lf jv hu js b fv lg lh l li lj">require 'net/http'<br/>require 'openssl'<br/><br/>domain_name = "example.com"<br/><br/>uri = URI::HTTPS.build(host: domain_name)<br/>response = Net::HTTP.start(uri.host, uri.port, :use_ssl =&gt; true)<br/>cert = response.peer_cert<br/><br/>two_weeks = 14 * 86400 # 14 * One Day<br/><br/>if Time.now + two_weeks &gt; cert.not_after<br/>  # send reminders<br/>end</span></pre><h1 id="a5f5" class="ju jv hu bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated">提醒你自己</h1><p id="a7b3" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">你可以用很多东西来发送这些提醒。我现在已经在<a class="ae jt" href="https://monitorcertificates.com/" rel="noopener ugc nofollow" target="_blank">我的应用</a>中实现了<a class="ae jt" href="https://hackernoon.com/tagged/sms" rel="noopener ugc nofollow" target="_blank">短信</a>、邮件(发给多人)、Slack和Stride。</p><p id="d163" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我有一些朋友使用这个脚本向他们自己推送手机通知(使用Pusher)，网页通知，<a class="ae jt" href="https://hackernoon.com/tagged/greckboard" rel="noopener ugc nofollow" target="_blank"> Geckoboard </a>更新，添加到待办事项列表，添加到Trello板，等等。任何交流平台都是公平的游戏。</p><p id="fa2b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">例如，如果你在Mac上，有一个<a class="ae jt" href="https://apple.stackexchange.com/questions/57412/how-can-i-trigger-a-notification-center-notification-from-an-applescript-or-shel/115373#115373" rel="noopener ugc nofollow" target="_blank">简洁的小命令</a>可以用来给自己发送通知。</p><p id="bd60" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，我将在脚本中包含该命令，以便向我们发送通知。</p><pre class="kx ky kz la fq lb js lc ld aw le dt"><span id="85b1" class="lf jv hu js b fv lg lh l li lj">require 'net/http'<br/>require 'openssl'<br/><br/>domain_name = "example.com"<br/><br/>uri = URI::HTTPS.build(host: domain_name)<br/>response = Net::HTTP.start(uri.host, uri.port, :use_ssl =&gt; true)<br/>cert = response.peer_cert<br/><br/>two_weeks = 14 * 86400 # 14 * One Day<br/><br/>if Time.now + two_weeks &gt; cert.not_after<br/>  time_remaining = (cert.not_after - Time.now)<br/>  days_remaining = time_remaining / 86400<br/><br/>  `osascript -e 'display notification "Certificate for #{domain_name} will expire in #{days_remaining.to_i} days. Please renew soon." with title "#{domain_name}"'`<br/>end</span></pre><p id="4f72" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我删除了<code class="eh jp jq jr js b">if</code>条件并运行脚本，今天的输出如下所示</p><figure class="kx ky kz la fq ll fe ff paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="fe ff lk"><img src="../Images/a46ab9d2e86e0c21b9745583680d2957.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tbkfupwjSb5TiiI8iMadNQ.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">This is what the notification looks like today.</figcaption></figure><p id="122e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在你需要做的就是将它添加到你的crontab中，当你的证书即将更新时，它会不断提醒你。</p><h1 id="13ad" class="ju jv hu bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated">结论</h1><p id="6e32" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">显然，我给你看的这个脚本不是最优雅的软件，但是它完成了任务。如果您想要监视多个域，只需将脚本转换成一个方法，并对您的数组<code class="eh jp jq jr js b">domain_names</code>的每个元素运行该方法。</p><p id="e5b9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们只是触及了表面，但这是构建您的监控基础架构和更多功能的坚实开端，以确保您的证书没有被吊销，或者如果是付费证书，谁是发行者。</p><p id="7b3b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我已经在我的应用程序中添加了所有这些和更多内容，以帮助了解HTTPS问题。</p><p id="f70c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">希望这能对像我这样的人有所帮助，他们不断破坏他们的“让我们加密”自动化，或者忘记了证书需要更新，管理人员忘记告诉你他们正在从供应商那里收到邮件来发布新的证书。😁</p><p id="e6fe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">编码快乐！</p><figure class="kx ky kz la fq ll"><div class="bz el l di"><div class="lw lx l"/></div></figure></div></div>    
</body>
</html>