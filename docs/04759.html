<html>
<head>
<title>SSH Tunneling — The black magic for data science</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SSH隧道——数据科学的魔法</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/the-ssh-black-magic-for-data-science-acd6f65e8528?source=collection_archive---------16-----------------------#2018-06-05">https://medium.com/hackernoon/the-ssh-black-magic-for-data-science-acd6f65e8528?source=collection_archive---------16-----------------------#2018-06-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="058a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">作为一名数据科学家，在你的生活中，很多时候你会希望<strong class="it hv"> <em class="jp">向世界</em> </strong>公开一个本地服务。这可能是一个Jupyter或RStudio服务，你可以在那里运行你的实验，或者是一个Tensorboard服务，你可以在那里检查训练过程，或者是一个很酷的聊天机器人服务，你刚刚建立。如果你曾经挣扎着配置所有的NAT、VPN、防火墙来远程访问你的服务，那么你并不孤单。我花了2年多的时间才认识了<a class="ae jq" href="https://vimeo.com/54505525" rel="noopener ugc nofollow" target="_blank">宋承宪黑魔法</a>。神奇的是，无论您的网络设置如何，您都可以从任何地方<em class="jp">连接到本地服务器上的任何服务。</em></p><p id="35ea" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">与SSH只是一个安全的shell(正如它的名字错误地暗示的那样)的普遍看法不同，SSH远不止于此。除了shell之外，SSH也是一个重要的传输协议，Git、SVN、SFTP、SCP…都是基于它构建的。SSH也是一个连接转发器，这是这篇文章中所有神奇之处的来源。</p><p id="6093" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这篇文章中，我假设您有一个<strong class="it hv">服务器，</strong>在其中运行多个服务，比如端口8888上的Jupyter和端口8787上的RStudio。现在您想从一个<strong class="it hv">客户端</strong>访问这些服务，这个客户端可能是一台从未知网络连接到互联网的笔记本电脑。根据您对服务器本地网络的控制，此问题有多种解决方案。如果你不关心SSH，只想要一个在任何情况下都有效的简单解决方案，我建议你直接进入<strong class="it hv">场景3 </strong>。</p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><h2 id="a44c" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated">场景1:您可以控制网关路由器。</h2><p id="4658" class="pw-post-body-paragraph ir is hu it b iu kt iw ix iy ku ja jb jc kv je jf jg kw ji jj jk kx jm jn jo hn dt translated">在这种情况下，您的<strong class="it hv">服务器</strong>位于一个<strong class="it hv">网关路由器</strong>之后，该路由器拥有一个全局(公共)IP，您拥有完全控制权。如果你生活在斯堪的纳维亚国家，这种设置是很常见的，那里每台家用路由器都有一个全球IP。如果您的服务器是EC2虚拟机，这种情况也适用，因为每个EC2实例都有公共IP，您可以控制它的防火墙(即它的安全组)。下图演示了这种情况。</p><figure class="kz la lb lc fq ld fe ff paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="fe ff ky"><img src="../Images/27631184ef596188a3cb32fd46d3dac8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SX2CtZNZZ84XW_JcuELDrQ.png"/></div></div><figcaption class="lk ll fg fe ff lm ln bd b be z ek">Scenario 1: Server is behind a controllable Gateway with global IP</figcaption></figure><ul class=""><li id="55ff" class="lo lp hu it b iu iv iy iz jc lq jg lr jk ls jo lt lu lv lw dt translated"><strong class="it hv"> <em class="jp">一般人会怎么做:</em> </strong>假设你的网关有公网IP 193.71.x.x，你的服务器有本地IP 192.168.1.2。人们通常会使用网关的<strong class="it hv"> NAT表</strong>来设置端口转发，如下图所示。如您所见，流向路由器端口22、8888、8787的流量分别被转发到服务器(192.168.1.2)的端口22、8888和8787。几乎所有(无线)路由器都有NAT表。如果您的服务器是EC2实例，您可以在它的安全组中添加入站流量规则。</li></ul><figure class="kz la lb lc fq ld fe ff paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="fe ff lx"><img src="../Images/2eb247651da991a7f8b81be974e4222e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yDlzqO68TIx2y6n8afBoVQ.png"/></div></div><figcaption class="lk ll fg fe ff lm ln bd b be z ek">Scenario 1 NAT solution: on the router, set up the NAT table to forward external traffic to the server. On the client, you can access Jupyter through the link ‘193.71.x.x:8888'</figcaption></figure><ul class=""><li id="76d8" class="lo lp hu it b iu iv iy iz jc lq jg lr jk ls jo lt lu lv lw dt translated"><strong class="it hv"> <em class="jp">您可以做什么:</em></strong>NAT解决方案工作正常，直到您厌倦了每次启动新服务时都要修改NAT表(或安全组)。使用SSH本地端口转发，您需要转发的唯一端口是SSH端口。一旦您可以ssh到您的服务器，任何其他流量都可以通过这个“SSH隧道”，如下图所示。</li></ul><figure class="kz la lb lc fq ld fe ff paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="fe ff ly"><img src="../Images/b29ffa082be4c948af97e3ac9d9d840e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GbT1Q2k_pGYcN5AJ9n85mg.png"/></div></div><figcaption class="lk ll fg fe ff lm ln bd b be z ek">Scenario 1 SSH tunneling solution. From the client, set up SSH Local Port Forwarding. On the client you can access Jupyter through ‘localhost:8888’</figcaption></figure><p id="af71" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">假设您已经将ssh端口转发到您的服务器，并且从客户端，您可以通过运行$ ssh 193.71.x.x来SSH到服务器，然后您可以在您的客户端上运行下面的神奇命令<strong class="it hv">来访问您的Jupyter。</strong></p><pre class="kz la lb lc fq lz ma mb mc aw md dt"><span id="d991" class="jy jz hu ma b fv me mf l mg mh">ssh -L 8888:localhost:8888 193.71.x.x</span></pre><p id="573d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该命令基本意思是:“当我访问localhost:8888时，请转发到SSH服务器的端口8888”。如果想知道是怎么回事，添加选项<strong class="it hv"> <em class="jp"> -v </em> </strong>。如果不需要通常的SSH shell，可以添加选项- <strong class="it hv"> N </strong>。现在你可以在你的客户端浏览器上输入<!-- --> localhost:8888 <!-- -->并访问服务器上的Jupyter服务。同样的方法可以用于RStudio或任何其他服务。如果你的客户端有Windows，你可以像这里的解释的那样设置Putty SSH隧道。</p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><h2 id="7433" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated">场景2:您无法控制网关路由器。</h2><p id="a3c4" class="pw-post-body-paragraph ir is hu it b iu kt iw ix iy ku ja jb jc kv je jf jg kw ji jj jk kx jm jn jo hn dt translated">在这种情况下，您的服务器位于您无法控制的本地网络中。</p><figure class="kz la lb lc fq ld fe ff paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="fe ff mi"><img src="../Images/6de05156cea1426c4c0908286f7aaa65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xBXFYR4kNqt4Uu-UZwLZ7Q.png"/></div></div><figcaption class="lk ll fg fe ff lm ln bd b be z ek">Scenario 2: Server is behind an uncontrollable Gateway</figcaption></figure><ul class=""><li id="43d6" class="lo lp hu it b iu iv iy iz jc lq jg lr jk ls jo lt lu lv lw dt translated"><strong class="it hv"> <em class="jp">人们通常做什么:</em> </strong>如果你的服务器位于一个大机构的内网，你可以要求你的网络管理员为你提供VPN接入。然而，当然，你通常不想分享你的VPN接入给你的客户，让他尝试你的酷聊天机器人。再者，如果你的服务器在家里，而你又没有认真到自己架设VPN怎么办。你们中的一些人可能会考虑TeamViewer，这是一个不错的选择。然而，长时间在TeamViewer上编码是痛苦的，有时是不稳定的。</li><li id="2a2d" class="lo lp hu it b iu mj iy mk jc ml jg mm jk mn jo lt lu lv lw dt translated"><strong class="it hv"> <em class="jp">您可以做什么:</em> </strong>如果您有一个拥有公共IP的远程服务器(比如EC2实例)，您可以使用SSH远程端口转发(反向隧道)。下图演示了发生的情况:</li></ul><figure class="kz la lb lc fq ld fe ff paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="fe ff mo"><img src="../Images/72848efa03723a1b4c73fdc5bbf5d3b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IfDfJeH1ZQY5ZU0IBIGdAA.png"/></div></div><figcaption class="lk ll fg fe ff lm ln bd b be z ek">Scenario 2 SSH Remote Port Forwarding : on the target Server, open a SSH Reverse Tunnel to RemoteServer. Traffic to the RemoteServer will be forwarded accordingly to the target Server.</figcaption></figure><p id="883f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这种方法中，我们打开一个反向隧道，这样到RemoteServer的流量就可以转发到目标服务器。要建立反向隧道，请在目标服务器上运行以下命令:</p><pre class="kz la lb lc fq lz ma mb mc aw md dt"><span id="5116" class="jy jz hu ma b fv me mf l mg mh">ssh -R 8888:localhost:8888 193.72.x.x</span></pre><p id="3feb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该命令基本上是说“当任何人访问远程服务器的端口8888(本例中为193.72.x.x)时，请转发到从我的机器(目标服务器)访问的URL localhost:8888”。现在，在任何客户端上，您都可以在浏览器上打开<a class="ae jq" href="http://193.72.x.x:8888" rel="noopener ugc nofollow" target="_blank"> 193.72.x.x:8888 </a>，访问目标服务器上运行的Jupyter服务。当然，您必须能够从您的客户端连接到RemoteServer的端口8888，这可以通过上面场景1中提到的方法来实现。请注意，您必须将选项<code class="eh mp mq mr ma b">GatewayPorts yes</code>添加到远程服务器上的<code class="eh mp mq mr ma b">/etc/ssh/sshd_config </code>文件中。你可以在这里查看详情<a class="ae jq" href="https://blog.trackets.com/2014/05/17/ssh-tunnel-local-and-remote-port-forwarding-explained-with-examples.html" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="c0f1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你觉得这种方法太不可行，那你就对了。幸运的是，有第三方服务为你做所有的艰苦工作，所以你不必知道SSH的存在。</p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><h2 id="f014" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated">场景3:您想向世界公开您的本地服务，现在！</h2><p id="0a2d" class="pw-post-body-paragraph ir is hu it b iu kt iw ix iy ku ja jb jc kv je jf jg kw ji jj jk kx jm jn jo hn dt translated"><a class="ae jq" href="https://ngrok.com/" rel="noopener ugc nofollow" target="_blank"> Ngrok </a>就是你要找的服务。在幕后，ngrok使用SSH远程端口转发将对其远程服务器的请求转发到您的目标服务器。然后它给你一个链接，你可以从任何地方访问它的远程服务器上的服务。</p><figure class="kz la lb lc fq ld fe ff paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="fe ff mo"><img src="../Images/bc86b8b43fa2aadfedb4f2f1c2bf00f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OBNbvLxAESaQTEqWdqBCGw.png"/></div></div><figcaption class="lk ll fg fe ff lm ln bd b be z ek">Scenario 3: just use ngrok (or other alternatives)</figcaption></figure><p id="83e2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用ngrok非常简单。您可以从这里下载ngrok <a class="ae jq" href="https://dashboard.ngrok.com/get-started" rel="noopener ugc nofollow" target="_blank">，然后在您的服务器上运行以下命令:</a></p><pre class="kz la lb lc fq lz ma mb mc aw md dt"><span id="25ee" class="jy jz hu ma b fv me mf l mg mh">./ngrok http 8888</span></pre><p id="be46" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，您会看到类似这样的内容:</p><figure class="kz la lb lc fq ld fe ff paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="fe ff ms"><img src="../Images/8bab493cd69773461658405ebfb2b9b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wRwE1iU8fgYH7gU9xXAVTA.png"/></div></div><figcaption class="lk ll fg fe ff lm ln bd b be z ek">A typical ngrok output</figcaption></figure><p id="14f1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您看到链接<a class="ae jq" href="https://1faa4894.ngrok.io" rel="noopener ugc nofollow" target="_blank">https://1fa a4894 . ngrok . io</a>现在被转发到您的localhost:8888。现在，您可以从任何地方打开该链接，并访问服务器端口8888上的服务(在本例中是Jupyter)。请注意，默认服务器在美国，所以如果你在其他地区，如欧盟，你应该添加选项<code class="eh mp mq mr ma b">-region eu</code>。</p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><h2 id="744f" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated">长话短说:</h2><p id="9ed8" class="pw-post-body-paragraph ir is hu it b iu kt iw ix iy ku ja jb jc kv je jf jg kw ji jj jk kx jm jn jo hn dt translated">SSH有一个魔力，可以让您向外界公开本地机器上的服务，而不管您的网络设置如何。然而，如果你不关心魔法，那么去<a class="ae jq" href="https://ngrok.com/" rel="noopener ugc nofollow" target="_blank">https://ngrok.com/</a>解决你的问题。</p><p id="0d35" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注意:这篇文章中的所有可视化都托管在<a class="ae jq" href="https://github.com/Nikasa1889/MediumBlogs" rel="noopener ugc nofollow" target="_blank"> github </a>上。</p></div></div>    
</body>
</html>