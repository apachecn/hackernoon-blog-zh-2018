<html>
<head>
<title>7 Different Ways to Use ES Modules Today!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">今天使用ES模块的7种不同方式！</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/7-different-ways-to-use-es-modules-today-fc552254ebf4?source=collection_archive---------0-----------------------#2018-06-06">https://medium.com/hackernoon/7-different-ways-to-use-es-modules-today-fc552254ebf4?source=collection_archive---------0-----------------------#2018-06-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/f6c73df32055ac2481d61fc20c4d8815.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aD_qqVrfbzIoa4ppFEcoNA.jpeg"/></div></div></figure><p id="a3af" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">es模块是JavaScript的未来，但与开发人员竞相利用的许多其他es@next特性(主要得益于像<a class="ae ka" href="https://babeljs.io/" rel="noopener ugc nofollow" target="_blank"> babel </a>这样的构建工具)不同，与现有的NPM模块一起使用ES模块要困难得多。</p><p id="b81e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">本教程的目的是提供一组完整的例子，说明编写es模块的不同方法，同时不丢失与当今NPM上存在的大量commonjs模块库的互操作性。</p><p id="83c3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在开始之前，对es模块和CommonJS格式之间的区别有一个坚实的理解是很重要的。如果你还没有，请在继续之前查看一下<a class="kb kc gr" href="https://medium.com/u/c845cd91bc98?source=post_page-----fc552254ebf4--------------------------------" rel="noopener" target="_blank">吉尔·塔亚尔</a>的精彩博文<a class="ae ka" rel="noopener" href="/@giltayar/native-es-modules-in-nodejs-status-and-future-directions-part-i-ee5ea3001f71"/>。</p><div class="kd ke fm fo kf kg"><a rel="noopener follow" target="_blank" href="/@giltayar/native-es-modules-in-nodejs-status-and-future-directions-part-i-ee5ea3001f71"><div class="kh ab ej"><div class="ki ab kj cl cj kk"><h2 class="bd hv fv z el kl eo ep km er et ht dt translated">NodeJS中的本地ES模块:现状和未来方向，第一部分</h2><div class="kn l"><h3 class="bd b fv z el kl eo ep km er et ek translated">ES模块即将来到NodeJS。它们实际上已经在这里了，在一面实验模块的旗帜后面。我最近给了一个…</h3></div><div class="ko l"><p class="bd b gc z el kl eo ep km er et ek translated">medium.com</p></div></div><div class="kp l"><div class="kq l kr ks kt kp ku ja kg"/></div></div></a></div><h2 id="379c" class="kv kw hu bd kx ky kz la lb lc ld le lf jn lg lh li jr lj lk ll jv lm ln lo lp dt translated">目标</h2><p id="abfb" class="pw-post-body-paragraph jc jd hu je b jf lq jh ji jj lr jl jm jn ls jp jq jr lt jt ju jv lu jx jy jz hn dt translated">本教程中的每种方法都必须满足以下要求:</p><ul class=""><li id="3c73" class="lv lw hu je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md dt translated">生成有效的npm模块</li><li id="9523" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">支持相同的一致功能</li><li id="981f" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">可在Node.js和浏览器环境中使用</li><li id="cd97" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">从NPM导入至少一个现有的commonjs模块</li><li id="6d8e" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">在本地导入至少一个es模块源文件</li><li id="95a4" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">包括至少一个单元测试</li></ul><h2 id="c197" class="kv kw hu bd kx ky kz la lb lc ld le lf jn lg lh li jr lj lk ll jv lm ln lo lp dt translated">功能</h2><p id="8495" class="pw-post-body-paragraph jc jd hu je b jf lq jh ji jj lr jl jm jn ls jp jq jr lt jt ju jv lu jx jy jz hn dt translated">我们的示例NPM模块的功能有点做作，但它应该触及所有主要的痛点，相信我，有很多这样的问题…</p><blockquote class="mk ml mm"><p id="040b" class="jc jd mj je b jf jg jh ji jj jk jl jm mn jo jp jq mo js jt ju mp jw jx jy jz hn dt translated">每种方法都将定义一个带有单个默认导出的NPM模块，<code class="eh mq mr ms mt b">async getImageDimensions(input)</code>，它接收一个图像并返回它的<code class="eh mq mr ms mt b">{ width, height }</code>。</p></blockquote><p id="deb9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">展示如何为Node.js和浏览器捆绑语义稍有不同的模块:</p><ul class=""><li id="f057" class="lv lw hu je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md dt translated">节点版本支持将<code class="eh mq mr ms mt b">input</code>作为<code class="eh mq mr ms mt b">string</code>，它可以是本地路径、http url或数据url。</li><li id="742c" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">浏览器版本支持将<code class="eh mq mr ms mt b">input</code>作为<code class="eh mq mr ms mt b">string</code> URL或<code class="eh mq mr ms mt b">HTMLImageElement</code>。</li></ul><p id="4f34" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">两个版本都为<code class="eh mq mr ms mt b">{ width: number, height: number }</code>返回一个<code class="eh mq mr ms mt b">Promise</code>。</p></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><h1 id="dd96" class="nb kw hu bd kx nc nd ne lb nf ng nh lf ni nj nk li nl nm nn ll no np nq lo nr dt translated">方法</h1><p id="2bda" class="pw-post-body-paragraph jc jd hu je b jf lq jh ji jj lr jl jm jn ls jp jq jr lt jt ju jv lu jx jy jz hn dt translated">我们将从一个简单的ES模块开始，通过一系列越来越复杂的示例方法，所有这些方法都旨在定义相同的基本模块。你可以在GitHub <a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules" rel="noopener ugc nofollow" target="_blank">这里</a>跟随7种方法的源代码！</p></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><h2 id="cd5e" class="kv kw hu bd kx ky kz la lb lc ld le lf jn lg lh li jr lj lk ll jv lm ln lo lp dt translated">1.天真的方法</h2><p id="edc8" class="pw-post-body-paragraph jc jd hu je b jf lq jh ji jj lr jl jm jn ls jp jq jr lt jt ju jv lu jx jy jz hn dt translated">我们的<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/1-naive" rel="noopener ugc nofollow" target="_blank">第一种方法</a>是对支持我们功能的ES模块的最简单的使用。这种方法被<em class="mj">打破</em>，仅作为一个示例起点。以下是Node.js代码的核心:</p><figure class="ns nt nu nv fq iv"><div class="bz el l di"><div class="nw nx l"/></div><figcaption class="ny nz fg fe ff oa ob bd b be z ek">Approach #1 <a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/blob/master/1-naive/index.js" rel="noopener ugc nofollow" target="_blank">index.js</a></figcaption></figure><figure class="ns nt nu nv fq iv"><div class="bz el l di"><div class="nw nx l"/></div><figcaption class="ny nz fg fe ff oa ob bd b be z ek">Approach #1 <a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/blob/master/1-naive/lib/load-image.js" rel="noopener ugc nofollow" target="_blank">load-image.js</a></figcaption></figure><p id="472b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该功能非常简单，但理解起来很重要，因为下面所有的例子都将使用<em class="mj">完全相同的代码</em>。下面是相应的浏览器代码:</p><figure class="ns nt nu nv fq iv"><div class="bz el l di"><div class="nw nx l"/></div><figcaption class="ny nz fg fe ff oa ob bd b be z ek">Approach #1 <a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/blob/master/1-naive/browser.js" rel="noopener ugc nofollow" target="_blank">browser.js</a></figcaption></figure><figure class="ns nt nu nv fq iv"><div class="bz el l di"><div class="nw nx l"/></div><figcaption class="ny nz fg fe ff oa ob bd b be z ek">Approach #1 <a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/blob/master/1-naive/lib/browser-load-image.js" rel="noopener ugc nofollow" target="_blank">browser-load-image.js</a></figcaption></figure><p id="6657" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这种方法中，我们为es模块使用普通的<code class="eh mq mr ms mt b">.js</code>文件扩展名，并且没有翻译。</p><p id="b5aa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这相对简单明了，但打破了我们的几个模块目标:</p><ul class=""><li id="80f4" class="lv lw hu je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md dt translated">在node.js中不可用，因为它的<code class="eh mq mr ms mt b">main</code>字段是es模块，而它应该是commonjs文件。</li><li id="a471" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">不能通过webpack或rollup在浏览器中使用，因为它的<code class="eh mq mr ms mt b">browser</code>字段是一个es模块，而它应该是一个commonjs文件。</li><li id="606f" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">这种方法的唯一优点是简单，如果您只是在私有模块上工作，这可能已经足够好了。</li><li id="1819" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">警告:除非您使用严格的本地或私有模块，否则我们强烈建议您不要在实践中使用这种方法。这是一个从commonjs过渡到ES模块时不要做什么的例子，如果你使用这种方法公开发布一个模块，JavaScript之神会发现并羞辱你。</li><li id="c616" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">不幸的是，虽然es模块在未来几年越来越受欢迎，我相信这个问题会得到解决，但是npm生态系统中并没有任何东西可以阻止你发布这样的坏模块。</li></ul></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><h2 id="9a22" class="kv kw hu bd kx ky kz la lb lc ld le lf jn lg lh li jr lj lk ll jv lm ln lo lp dt translated">2.纯巴别塔方法</h2><p id="4619" class="pw-post-body-paragraph jc jd hu je b jf lq jh ji jj lr jl jm jn ls jp jq jr lt jt ju jv lu jx jy jz hn dt translated">这个<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/2-babel" rel="noopener ugc nofollow" target="_blank">方法</a>使用<a class="ae ka" href="https://babeljs.io/" rel="noopener ugc nofollow" target="_blank"> babel </a>和<a class="ae ka" href="https://babeljs.io/docs/plugins/preset-env/" rel="noopener ugc nofollow" target="_blank"> babel-preset-env </a>将所有Node.js和浏览器源文件传输到<code class="eh mq mr ms mt b">dist/</code>中。</p><figure class="ns nt nu nv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/911f321ac3d4c91fd61575ebe30a582e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QGztzZNwcLuGawLxkU1RwA.png"/></div></div></figure><p id="9c41" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这种方法的核心是package.json中的<strong class="je hv">构建</strong>脚本:</p><figure class="ns nt nu nv fq iv"><div class="bz el l di"><div class="nw nx l"/></div><figcaption class="ny nz fg fe ff oa ob bd b be z ek">Approach #2 excerpt from <a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/2-babel" rel="noopener ugc nofollow" target="_blank">package.json</a></figcaption></figure><ul class=""><li id="85a1" class="lv lw hu je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md dt translated">源文件以<code class="eh mq mr ms mt b">.mjs</code>结尾</li><li id="34a2" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">设置相对简单</li><li id="6e19" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">Babel将所有源文件传输到ES5和commonjs</li><li id="b9e4" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">测试是在transpiled源代码上运行的，这使得调试稍微有些困难</li><li id="a138" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">目前，我们的<code class="eh mq mr ms mt b">main</code>和<code class="eh mq mr ms mt b">browser</code>是支持<code class="eh mq mr ms mt b">node &gt;= 4</code>(或者我们在babel-preset-env配置中指定的任何内容)的commonjs导出，而<code class="eh mq mr ms mt b">module</code>导出是支持<code class="eh mq mr ms mt b">node &gt;=8</code>的es模块，因为它使用了<code class="eh mq mr ms mt b">async await</code>。</li><li id="91b6" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">不幸的是，AFAIK，package.json <code class="eh mq mr ms mt b">engines</code>不支持指定<code class="eh mq mr ms mt b">main</code>支持某个节点版本，而<code class="eh mq mr ms mt b">module</code>支持不同的模块版本，我甚至认为这是一个糟糕的做法。</li><li id="c0e9" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">为了解决这个问题，我们可以像这里一样指定最低节点版本为<code class="eh mq mr ms mt b">node &gt;= 8</code>，或者添加第二个babel步骤，将节点版本传输到esm文件夹，尽管我觉得这有点笨拙。</li></ul></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><h2 id="0538" class="kv kw hu bd kx ky kz la lb lc ld le lf jn lg lh li jr lj lk ll jv lm ln lo lp dt translated">3.ESM+汇总方法</h2><p id="7085" class="pw-post-body-paragraph jc jd hu je b jf lq jh ji jj lr jl jm jn ls jp jq jr lt jt ju jv lu jx jy jz hn dt translated">这个<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/3-esm-rollup" rel="noopener ugc nofollow" target="_blank">方法</a>使用<a class="ae ka" href="https://github.com/standard-things/esm" rel="noopener ugc nofollow" target="_blank"> esm </a> for Node.js和<a class="ae ka" href="https://babeljs.io/" rel="noopener ugc nofollow" target="_blank"> babel </a> + <a class="ae ka" href="https://rollupjs.org/guide/en" rel="noopener ugc nofollow" target="_blank"> rollup </a>编译浏览器源文件。</p><figure class="ns nt nu nv fq iv"><div class="bz el l di"><div class="oc nx l"/></div><figcaption class="ny nz fg fe ff oa ob bd b be z ek"><a class="ae ka" href="https://github.com/standard-things/esm" rel="noopener ugc nofollow" target="_blank">esm</a> is amazing!</figcaption></figure><figure class="ns nt nu nv fq iv"><div class="bz el l di"><div class="nw nx l"/></div><figcaption class="ny nz fg fe ff oa ob bd b be z ek">Approach #3 <a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/blob/master/3-esm-rollup/main.js" rel="noopener ugc nofollow" target="_blank">main.js</a> node commonjs entrypoint which loads the esm <a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/blob/master/3-esm-rollup/module.mjs" rel="noopener ugc nofollow" target="_blank">module.mjs</a> via <a class="ae ka" href="https://github.com/standard-things/esm" rel="noopener ugc nofollow" target="_blank">esm</a>.</figcaption></figure><figure class="ns nt nu nv fq iv"><div class="bz el l di"><div class="nw nx l"/></div><figcaption class="ny nz fg fe ff oa ob bd b be z ek">Approach #3 <a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/blob/master/3-esm-rollup/rollup.config.js" rel="noopener ugc nofollow" target="_blank">ollup.config.js</a> for compiling the browser version to bundled commonjs.</figcaption></figure><ul class=""><li id="cc37" class="lv lw hu je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md dt translated">源文件以<code class="eh mq mr ms mt b">.mjs</code>结尾(唯一的例外是commonjs入口点<code class="eh mq mr ms mt b">main.js)</code></li><li id="fdd2" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">支持所有三个目标<code class="eh mq mr ms mt b">main</code> <code class="eh mq mr ms mt b">module</code>和<code class="eh mq mr ms mt b">browser</code></li><li id="204f" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">编译的唯一目标是<code class="eh mq mr ms mt b">browser</code>，这使得调试Node.js版本更加容易</li><li id="57e6" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">还要注意，我们在<a class="ae ka" href="https://github.com/avajs/ava" rel="noopener ugc nofollow" target="_blank"> ava </a>单元测试配置中需要<a class="ae ka" href="https://github.com/standard-things/esm" rel="noopener ugc nofollow" target="_blank"> esm </a></li></ul></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><h2 id="f575" class="kv kw hu bd kx ky kz la lb lc ld le lf jn lg lh li jr lj lk ll jv lm ln lo lp dt translated">4.ESM+Webpack方法</h2><p id="a99a" class="pw-post-body-paragraph jc jd hu je b jf lq jh ji jj lr jl jm jn ls jp jq jr lt jt ju jv lu jx jy jz hn dt translated">这种<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/4-esm-webpack" rel="noopener ugc nofollow" target="_blank">方法</a>使用<a class="ae ka" href="https://github.com/standard-things/esm" rel="noopener ugc nofollow" target="_blank"> esm </a> for Node.js和<a class="ae ka" href="https://babeljs.io/" rel="noopener ugc nofollow" target="_blank">babel</a>+<a class="ae ka" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank">web pack</a>编译浏览器源文件。它与前面的方法相同，只是它关闭了webpack的rollup。</p><figure class="ns nt nu nv fq iv"><div class="bz el l di"><div class="nw nx l"/></div><figcaption class="ny nz fg fe ff oa ob bd b be z ek">Approach #4 <a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/blob/master/4-esm-webpack/webpack.config.js" rel="noopener ugc nofollow" target="_blank">webpack.config.js</a> for compiling the browser version to bundled commonjs.</figcaption></figure><ul class=""><li id="429f" class="lv lw hu je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md dt translated">源文件以<code class="eh mq mr ms mt b">.mjs</code>结尾(唯一的例外是commonjs入口点<code class="eh mq mr ms mt b">main.js)</code></li><li id="7dd8" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">支持全部三个目标<code class="eh mq mr ms mt b">main</code> <code class="eh mq mr ms mt b">module</code>和<code class="eh mq mr ms mt b">browser</code></li><li id="0cc9" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">编译的唯一目标是<code class="eh mq mr ms mt b">browser</code>，这使得调试Node.js版本更加容易</li><li id="9fb7" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">还要注意，我们在<a class="ae ka" href="https://github.com/avajs/ava" rel="noopener ugc nofollow" target="_blank"> ava </a>单元测试配置中需要<a class="ae ka" href="https://github.com/standard-things/esm" rel="noopener ugc nofollow" target="_blank"> esm </a></li></ul></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><h2 id="068d" class="kv kw hu bd kx ky kz la lb lc ld le lf jn lg lh li jr lj lk ll jv lm ln lo lp dt translated">5.纯累积方法</h2><p id="4a8d" class="pw-post-body-paragraph jc jd hu je b jf lq jh ji jj lr jl jm jn ls jp jq jr lt jt ju jv lu jx jy jz hn dt translated">这个<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/5-rollup" rel="noopener ugc nofollow" target="_blank">方法</a>使用<a class="ae ka" href="https://babeljs.io/" rel="noopener ugc nofollow" target="_blank"> babel </a> + <a class="ae ka" href="https://rollupjs.org/guide/en" rel="noopener ugc nofollow" target="_blank"> rollup </a>编译所有Node.js和浏览器源文件。这种方法从<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/3-esm-rollup" rel="noopener ugc nofollow" target="_blank">方法#3 </a>中获取汇总配置，并通过为browser和Node.js目标提供单独的汇总配置而更进一步。</p><figure class="ns nt nu nv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff od"><img src="../Images/43e9da237643b7256e6b2ddfcf3d8e2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Am5hoqyrZvoJopjruvpfTg.jpeg"/></div></div></figure><p id="c69b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">不包括冗余配置，直接检查源代码<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/5-rollup" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><ul class=""><li id="6721" class="lv lw hu je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md dt translated">源文件以<code class="eh mq mr ms mt b">.mjs</code>结尾</li><li id="31d3" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">支持所有三个目标<code class="eh mq mr ms mt b">main</code> <code class="eh mq mr ms mt b">module</code>和<code class="eh mq mr ms mt b">browser</code></li><li id="7600" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">这三个目标都是通过rollup编译的，Node.js和浏览器有两个独立的配置</li><li id="0b15" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">这是我们第一个支持<code class="eh mq mr ms mt b">node &gt;= 4</code>(或者我们在babel-preset-env配置中指定的任何东西)而不是<code class="eh mq mr ms mt b">node &gt;= 8</code>的模块</li><li id="9d10" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">源映射与编译后的目标一起生成</li></ul></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><h2 id="c83e" class="kv kw hu bd kx ky kz la lb lc ld le lf jn lg lh li jr lj lk ll jv lm ln lo lp dt translated">6.纯Webpack方法</h2><p id="4c4f" class="pw-post-body-paragraph jc jd hu je b jf lq jh ji jj lr jl jm jn ls jp jq jr lt jt ju jv lu jx jy jz hn dt translated">这个<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/6-webpack" rel="noopener ugc nofollow" target="_blank">方法</a>使用<a class="ae ka" href="https://babeljs.io/" rel="noopener ugc nofollow" target="_blank">babel</a>+<a class="ae ka" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank">web pack</a>编译所有Node.js和浏览器源文件。这种方法采用了来自<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/4-esm-webpack" rel="noopener ugc nofollow" target="_blank">方法#4 </a>的webpack配置，并通过为browser和Node.js目标提供单独的webpack配置而更进一步。</p><figure class="ns nt nu nv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff oe"><img src="../Images/62d35f21af974070d1f0f79c8ccf44b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R6aEDmNiJ9Ud0M6Nj-btoQ.png"/></div></div></figure><p id="2949" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">警告</strong>:该方法目前是一个损坏的WIP，其输出行为不正确。所有其他方法都按预期工作。</p><p id="23db" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">不包括冗余配置，直接检查源代码<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/5-rollup" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><ul class=""><li id="5dbe" class="lv lw hu je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md dt translated">源文件以<code class="eh mq mr ms mt b">.mjs</code>结尾</li><li id="5419" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">支持所有三个目标<code class="eh mq mr ms mt b">main</code>、<code class="eh mq mr ms mt b">module</code>和<code class="eh mq mr ms mt b">browser</code></li><li id="aa8d" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">遗憾的是，<strong class="je hv"> webpack不支持输出es模块目标</strong> ( <a class="ae ka" href="https://github.com/webpack/webpack/issues/2933" rel="noopener ugc nofollow" target="_blank">问题</a>)。</li><li id="fc04" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated"><code class="eh mq mr ms mt b">main</code>和<code class="eh mq mr ms mt b">browser</code>目标已编译，但<code class="eh mq mr ms mt b">module</code>目标因该问题无法编译。</li><li id="0af6" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">支持<code class="eh mq mr ms mt b">node &gt;= 8</code>，而<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/blob/master/5-rollup" rel="noopener ugc nofollow" target="_blank">汇总</a>版本也能够通过编译<code class="eh mq mr ms mt b">module</code>目标来支持<code class="eh mq mr ms mt b">node &gt;= 4</code>。</li><li id="8e9e" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">除非你有一个好的特定于项目的理由来使用webpack而不是rollup，否则我强烈建议使用rollup来捆绑ES6模块库(至少在这个webpack问题得到解决之前)。</li></ul></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><h2 id="9379" class="kv kw hu bd kx ky kz la lb lc ld le lf jn lg lh li jr lj lk ll jv lm ln lo lp dt translated">7.打字稿方法</h2><p id="2280" class="pw-post-body-paragraph jc jd hu je b jf lq jh ji jj lr jl jm jn ls jp jq jr lt jt ju jv lu jx jy jz hn dt translated">这个<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/7-typescript" rel="noopener ugc nofollow" target="_blank">方法</a>使用<a class="ae ka" href="https://www.typescriptlang.org/" rel="noopener ugc nofollow" target="_blank">类型脚本</a>来传输所有Node.js和浏览器源文件。</p><figure class="ns nt nu nv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff of"><img src="../Images/e96db1f5e2141162cb8906371c5e8c8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4XCtOrhMBk-YMhSGLaUMOw.png"/></div></div></figure><figure class="ns nt nu nv fq iv"><div class="bz el l di"><div class="nw nx l"/></div><figcaption class="ny nz fg fe ff oa ob bd b be z ek">TypeScript Approach #7 <a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/blob/master/7-typescript/src/index.ts" rel="noopener ugc nofollow" target="_blank">index.ts</a></figcaption></figure><figure class="ns nt nu nv fq iv"><div class="bz el l di"><div class="nw nx l"/></div><figcaption class="ny nz fg fe ff oa ob bd b be z ek">TypeScript Approach #7 <a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/blob/master/7-typescript/src/load-image.ts" rel="noopener ugc nofollow" target="_blank">load-image.ts</a></figcaption></figure><ul class=""><li id="1228" class="lv lw hu je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md dt translated">源文件以<code class="eh mq mr ms mt b">.ts</code>结尾</li><li id="2540" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">支持所有三个目标<code class="eh mq mr ms mt b">main</code> <code class="eh mq mr ms mt b">module</code>和<code class="eh mq mr ms mt b">browser</code></li><li id="4ba4" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">需要两次编译，一次用于目标<code class="eh mq mr ms mt b">commonjs</code>，一次用于目标<code class="eh mq mr ms mt b">esm</code></li><li id="2521" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">目前，commonjs用户需要添加默认的需求语句:<code class="eh mq mr ms mt b">require('npm-es-modules-7-typescript').default</code>。如果你知道如何防止这种情况，请告诉我。</li><li id="c62c" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">结果模块支持<code class="eh mq mr ms mt b">node &gt;= 4</code>(或者我们在<code class="eh mq mr ms mt b">tsconfig.json</code>中指定的任何东西)而不是<code class="eh mq mr ms mt b">node &gt;= 8</code></li><li id="b684" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">请注意，我对TypeScript相当陌生，所以如果我做了什么笨拙的事情，请让我知道。</li></ul><blockquote class="og"><p id="3b03" class="oh oi hu bd oj ok ol om on oo op jz ek translated">总的来说，如果您想最大限度地提高兼容性，使用TypeScript似乎是最干净、最经得起未来考验的方法。</p></blockquote></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><h1 id="fa7e" class="nb kw hu bd kx nc nd ne lb nf ng nh lf ni nj nk li nl nm nn ll no np nq lo nr dt translated">推荐</h1><p id="aeff" class="pw-post-body-paragraph jc jd hu je b jf lq jh ji jj lr jl jm jn ls jp jq jr lt jt ju jv lu jx jy jz hn dt translated">咻，好多JavaScripts啊…</p><p id="f5b9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在总结一下我从创建这个细目分类中学到的东西，以及我对编写自己的下一代NPM模块的实用建议:</p><ul class=""><li id="b578" class="lv lw hu je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md dt translated">如果你只关心Node.js的兼容性，而不关心浏览器的使用，并且想要一些非常简单的东西，那么要么现在使用标准的commonjs，要么使用<a class="ae ka" href="https://github.com/standard-things/esm" rel="noopener ugc nofollow" target="_blank"> esm </a>，就像<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/3-esm-rollup" rel="noopener ugc nofollow" target="_blank">方法#3 </a>一样，不使用汇总的东西。</li><li id="351b" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">如果你只关心Node.js的兼容性，而不是浏览器的使用，但也想支持Node.js的旧版本，那么使用<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/2-babel" rel="noopener ugc nofollow" target="_blank">纯巴别塔方法#2 </a>。</li><li id="ad0e" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">如果您只关心浏览器的使用，您可能可以通过编写ES模块而不使transpilation复杂化，因为任何现代前端工具链都会为您处理构建工作。</li><li id="181e" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">如果你既关心Node.js又关心浏览器兼容性，那么就使用<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/3-esm-rollup" rel="noopener ugc nofollow" target="_blank"> ESM+Rollup方法#3 </a>或<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/4-esm-webpack" rel="noopener ugc nofollow" target="_blank"> ESM+Webpack方法#4 </a>，这取决于你在Rollup和Webpack之间的偏好。依我看，对于库来说，Rollup是比webpack更好的选择，因为它更专注于处理库，而webpack试图做所有的事情。</li><li id="72b0" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">如果您既关心Node.js又关心浏览器兼容性，并且希望支持Node.js的旧版本，那么使用<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/5-rollup" rel="noopener ugc nofollow" target="_blank"> Pure Rollup方法#5 </a>。</li><li id="4b52" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated">最后，如果你想完全适应未来，并通过静态分析来提高代码质量，我强烈建议使用<a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules/tree/master/7-typescript" rel="noopener ugc nofollow" target="_blank">类型脚本方法#7 </a>，它可以处理所有之前的用例以及其他一些用例。</li></ul><h1 id="a9ca" class="nb kw hu bd kx nc oq ne lb nf or nh lf ni os nk li nl ot nn ll no ou nq lo nr dt translated">结论</h1><p id="3dce" class="pw-post-body-paragraph jc jd hu je b jf lq jh ji jj lr jl jm jn ls jp jq jr lt jt ju jv lu jx jy jz hn dt translated">我希望这个指南对你有所帮助！你可以在GitHub <a class="ae ka" href="https://github.com/transitive-bullshit/npm-es-modules" rel="noopener ugc nofollow" target="_blank">这里</a>找到所有的源代码，包括7种方法的可用模块。</p><p id="9d2e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">有关这个主题的更多信息，请查看以下资源:</p><ul class=""><li id="8051" class="lv lw hu je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md dt translated"><a class="ae ka" rel="noopener" href="/@giltayar/native-es-modules-in-nodejs-status-and-future-directions-part-i-ee5ea3001f71">NodeJS中的原生ES模块:现状和未来方向</a></li><li id="eec5" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated"><a class="ae ka" href="https://hacks.mozilla.org/2018/03/es-modules-a-cartoon-deep-dive/" rel="noopener ugc nofollow" target="_blank"> ES模块:由<a class="kb kc gr" href="https://medium.com/u/d3391efe481a?source=post_page-----fc552254ebf4--------------------------------" rel="noopener" target="_blank">林·克拉克</a>创作的卡通深潜</a></li><li id="6eff" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated"><a class="ae ka" href="http://2ality.com/2017/07/npm-packages-via-babel.html" rel="noopener ugc nofollow" target="_blank">基于巴别塔的npm包的最小设置</a></li><li id="ab24" class="lv lw hu je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md dt translated"><a class="ae ka" rel="noopener" href="/@kelin2025/so-you-wanna-use-es6-modules-714f48b3a953">如何编写和构建2018年的JS库</a>作者<a class="kb kc gr" href="https://medium.com/u/7d8e23d71c9d?source=post_page-----fc552254ebf4--------------------------------" rel="noopener" target="_blank"> Anton Kosykh </a></li></ul><p id="b6d3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">有没有我漏掉的方法或建议？请在评论中分享给我！❤️</p></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><h2 id="4a80" class="kv kw hu bd kx ky kz la lb lc ld le lf jn lg lh li jr lj lk ll jv lm ln lo lp dt translated">在你走之前…</h2><p id="e375" class="pw-post-body-paragraph jc jd hu je b jf lq jh ji jj lr jl jm jn ls jp jq jr lt jt ju jv lu jx jy jz hn dt translated">如果您喜欢这篇文章，请点击👏下面，并与他人分享，这样他们也可以享受它。</p><figure class="ns nt nu nv fq iv"><div class="bz el l di"><div class="ov nx l"/></div></figure></div></div>    
</body>
</html>