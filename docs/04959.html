<html>
<head>
<title>Contributing to GHC 1: Preparation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为GHC 1做出贡献:准备</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/contributing-to-ghc-1-preparation-c1f3a3cbe71b?source=collection_archive---------42-----------------------#2018-06-11">https://medium.com/hackernoon/contributing-to-ghc-1-preparation-c1f3a3cbe71b?source=collection_archive---------42-----------------------#2018-06-11</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="b6bc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在过去的几周里，我们看了一些不同的开源Haskell项目，比如<a class="ae jp" href="https://mmhaskell.com/blog/2018/5/28/hnix-enhancing-nix-with-haskell" rel="noopener ugc nofollow" target="_blank"> HNix </a>和<a class="ae jp" href="https://mmhaskell.com/blog/2018/6/4/bxit5i954uafn0n4gah3yrzcxnc3q6" rel="noopener ugc nofollow" target="_blank"> Codeworld </a>。本周，我们将开始关注Haskell生态系统中最大也是最重要的开源元素。这是<a class="ae jp" href="https://www.haskell.org/ghc/" rel="noopener ugc nofollow" target="_blank"> GHC </a>，格拉斯哥哈斯克尔编译器。没有GHC和许多志愿者的辛勤工作，Haskell就不会成为今天的语言。因此，在接下来的几周里，我们将探索建设的过程，并(希望)为GHC做出贡献。</p><p id="8d3f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我目前在Windows笔记本电脑上操作，这带来了许多挫折。让GHC在Windows上运行并不是一件容易的事情，有很多潜在的障碍。从好的方面来看，我认为这是一个机会，表明一个人即使在最不利的情况下也能有所贡献。因此，本文的大部分内容将集中在使用Windows的尝试上。下面有一节介绍了构建Mac和Linux的最重要的部分。我将跟随西蒙·佩顿·琼斯的这个指南，分享我自己的并发症。</p><p id="186e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，你需要先走，然后才能跑。如果你以前从未使用过Haskell，你必须先试用它来理解GHC！下载我们的<a class="ae jp" href="https://www.mmhaskell.com/beginners-checklist" rel="noopener ugc nofollow" target="_blank">初学者清单</a>开始吧！你也可以阅读我们的<a class="ae jp" href="https://www.mmhaskell.com/liftoff" rel="noopener ugc nofollow" target="_blank">起飞系列</a>来学习更多的语言基础知识。</p><h1 id="2082" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">MSYS</h1><p id="3929" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">Windows的主要复杂性在于，GHC的构建工具是为类似Unix的环境设计的。这些工具包括像<code class="eh kt ku kv kw b">autoconf</code>和<code class="eh kt ku kv kw b">make</code>这样的程序。并且它们不能在正常的Windows终端环境中工作。这意味着我们需要某种方式来模拟Windows中的Unix终端环境。对此有几种不同的选择。一个是<a class="ae jp" href="https://www.cygwin.com/" rel="noopener ugc nofollow" target="_blank"> Cygwin </a>，但是更受GHC支持的选项是<a class="ae jp" href="https://www.msys2.org/" rel="noopener ugc nofollow" target="_blank"> MSYS 2 </a>。所以我的第一步是安装这个程序。这个终端将应用“极简GNU for Windows”库，缩写为“MinGW”。</p><p id="2015" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">第一次安装时运行良好。然而，确实有那么几个时刻，我决定放弃一切，从头开始。重新安装确实带来了一个问题，我将分享。在一些情况下，当我决定重新开始时，我会运行安装程序，却发现一个错误<code class="eh kt ku kv kw b">bash.exe: permission denied</code>。发生这种情况是因为该程序的旧版本仍在一个进程上运行。你可以删除这个进程，或者重启你的机器来解决这个问题。</p><p id="367c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦MSys开始工作，你就要设置你的终端默认使用<code class="eh kt ku kv kw b">MinGW</code>程序。要做到这一点，您首先需要设置放置<code class="eh kt ku kv kw b">mingw</code>目录的路径:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="2fc3" class="lf jr hu kw b fv lg lh l li lj">echo “export PATH=/mingw&lt;bitness&gt;/bin:\$PATH” &gt;&gt; ~/.bash_profile</span></pre><p id="5160" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">根据您的系统，使用<code class="eh kt ku kv kw b">32</code>或<code class="eh kt ku kv kw b">64</code>作为<code class="eh kt ku kv kw b">&lt;bitness&gt;</code>。另外，不要忘记命令本身的引号！</p><h1 id="ccdd" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">包装准备</h1><p id="c160" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">我们的下一步将是为GHC准备所有必要的包裹。MSys 2使用了一个更老的叫做<code class="eh kt ku kv kw b">pacman</code>的包管理器，它的操作有点像<code class="eh kt ku kv kw b">apt-get</code>。首先，您需要使用以下命令更新您的包存储库:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="5612" class="lf jr hu kw b fv lg lh l li lj">pacman -Syuu</span></pre><p id="08d4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">按照SPJ描述中的说明，如果连接超时，您可能需要运行几次。我曾经遇到过这种情况。现在pacman开始工作了，你需要安装一系列程序和库来帮助构建GHC:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="340b" class="lf jr hu kw b fv lg lh l li lj">pacman -S --needed git tar bsdtar binutils autoconf make xz \<br/>    curl libtool automake python python2 p7zip patch ca-certificates \<br/>    mingw-w64-$(uname -m)-gcc mingw-w64-$(uname -m)-python3-sphinx \<br/>    mingw-w64-$(uname -m)-tools-git</span></pre><p id="80c0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个命令通常对我来说很好。我们需要的最后一项是<code class="eh kt ku kv kw b">alex</code>和<code class="eh kt ku kv kw b">happy</code>。这些是用于词法分析和语法分析的Haskell程序。我们要安装阴谋集团来做这件事。首先让我们为我们的系统设置几个变量:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="36fa" class="lf jr hu kw b fv lg lh l li lj">arch=x64_64 # could also be i386<br/>bitness=64  # could also be 32</span></pre><p id="1464" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们将获得一个预构建的GHC二进制文件，稍后我们将使用它来引导我们自己的构建:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="6b39" class="lf jr hu kw b fv lg lh l li lj">curl -L https://downloads.haskell.org/~ghc/8.2.2/ghc-8.2.2-${arch}-unknown-mingw32.tar.xz | tar -xJ -C /mingw${bitness} --strip-components=1</span></pre><p id="77d3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们要利用Cabal拿到那些包裹。我们将把他们(和阴谋集团)放在<code class="eh kt ku kv kw b">/usr/local/bin</code>中，因此我们将确保首先创建它:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="48bd" class="lf jr hu kw b fv lg lh l li lj">mkdir -p /usr/local/bin<br/>curl -L https://www.haskell.org/cabal/release/cabal-install-2.2.0.0/cabal-install-2.2.0.0-${arch}-unknown-mingw32.zip | bsdtar -xzf- -C /usr/local/bin</span></pre><p id="dbbc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们将更新我们的阴谋库，并获得<code class="eh kt ku kv kw b">alex</code>和<code class="eh kt ku kv kw b">happy</code>:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="b995" class="lf jr hu kw b fv lg lh l li lj">cabal update<br/>cabal install -j --prefix=/usr/local/bin alex happy</span></pre><p id="0afa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有一次运行这个命令时，我发现由于<code class="eh kt ku kv kw b">mtl</code>库的问题<code class="eh kt ku kv kw b">happy</code>无法安装。运行<code class="eh kt ku kv kw b">ghc-pkg check</code>命令时，我得到了这类错误:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="7585" class="lf jr hu kw b fv lg lh l li lj">Cannot find any of [“Control\\Monad\\Cont.hi”, “Control\\Monad\Cont.p_hi”, “Control\\Monad\\Cont.dyn_hi”]<br/>Cannot find any of [“Control\\Monad\\Cont\\Class.hi”, “Control\\Monad\Cont\\Class.p_hi”, “Control\\Monad\\Cont\\Class.dyn_hi”]</span></pre><p id="eaeb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我通过手动重新安装<code class="eh kt ku kv kw b">mtl</code>包解决了这个问题:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="edf1" class="lf jr hu kw b fv lg lh l li lj">cabal install -j --prefix=/usr/local/ mtl --reinstall</span></pre><p id="15ea" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">经过这一步，在<code class="eh kt ku kv kw b">ghc-pkg check</code>上没有错误，我可以毫无问题地安装<code class="eh kt ku kv kw b">happy</code>。</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="3288" class="lf jr hu kw b fv lg lh l li lj">cabal install -j --prefix=/usr/local/ happy<br/>Resolving dependencies…<br/>Configuring happy-1.19.9…<br/>Building happy-1.19.9…<br/>Installed happy-1.19.9</span></pre><h1 id="36f4" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">获取源代码并构建</h1><p id="f39e" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">现在我们的依赖项都已经设置好了，所以我们现在可以开始获取源代码了！为GHC做贡献的主要工作流程使用了一些其他工具，但是我们可以从Github开始。</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="5536" class="lf jr hu kw b fv lg lh l li lj">git clone --recursive git://git.haskell.org/ghc.git</span></pre><p id="d3a7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，您应该从<code class="eh kt ku kv kw b">ghc</code>目录运行<code class="eh kt ku kv kw b">./boot</code>命令。由于我的杀毒软件，这给我带来了一些特别严重的问题。它认定<code class="eh kt ku kv kw b">perl</code>对我的系统是一个现存的威胁，并把它扔进了病毒箱。您可能会看到类似这样的错误:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="80ae" class="lf jr hu kw b fv lg lh l li lj">sh: /usr/bin/autoreconf: /usr/bin/perl: bad interpreter: No such file or directory</span></pre><p id="b1db" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">甚至在将另一个版本的perl复制到该目录后，我看到了如下错误:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="3bbe" class="lf jr hu kw b fv lg lh l li lj">Could not locate Autom4te/ChannelDefs.pm in @INC (@INC contains /usr/share/autoconf C:/msys64/usr/lib .) at C:/msys64/usr/bin/autoreconf line 39</span></pre><p id="3416" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">实际上，<code class="eh kt ku kv kw b">@INC</code>路径应该有更多的条目！我花了一段时间(和几个完整的重做)才发现我的杀毒软件是这里的问题。一旦我把<code class="eh kt ku kv kw b">perl</code>从病毒箱里挖出来，一切都正常了。一旦<code class="eh kt ku kv kw b">boot</code>运行，你就差不多准备好了！您现在需要配置一切:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="cc00" class="lf jr hu kw b fv lg lh l li lj">./configure --enable-tarballs-autodownload</span></pre><p id="e084" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">额外选项仅在Windows上是必需的。最后，您将使用<code class="eh kt ku kv kw b">make</code>命令来构建一切。预计这将需要一段时间(12个小时，并为我计数！).一旦你熟悉了代码库，有几种不同的方法可以让你构建得更快。例如，您可以用几种不同的方式定制<code class="eh kt ku kv kw b">build.mk</code>文件。可以设置<code class="eh kt ku kv kw b">BuildFlavor=devel2</code>，也可以设置<code class="eh kt ku kv kw b">stage=2</code>。后者将跳过编译器的第一阶段。</p><p id="0804" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您也可以从子目录而不是主目录运行<code class="eh kt ku kv kw b">make</code>。这只会构建子组件，而不是完整的编译器。最后，还有一个<code class="eh kt ku kv kw b">make fast</code>命令，它将跳过许多依赖项的构建。</p><h1 id="7624" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">Mac和Linux</h1><p id="dc37" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">我不会在这里深入讨论Mac和Linux的指令，因为我还没有机会亲自尝试。但是由于这些系统对开发者友好的特性，它们可能比Windows有更少的问题。</p><p id="5e9d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">例如，在Linux上，您实际上可以通过使用Docker容器来完成大部分设置。首先下载源代码，然后运行docker命令:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="4b2e" class="lf jr hu kw b fv lg lh l li lj">&gt;&gt; sudo docker run --rm -i -t -v `pwd`:/home/ghc gregweber/ghc-haskell-dev /bin/bash</span></pre><p id="3b5b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在Mac上，你需要安装一些与windows类似的程序，但没有必要使用像MSys这样的终端模拟器。如果你已经有了基本的开发工具和一个GHC和阴谋集团的工作版本，事情可能会很简单:</p><pre class="kx ky kz la fq lb kw lc ld aw le dt"><span id="06c9" class="lf jr hu kw b fv lg lh l li lj">&gt;&gt; brew install autoconf automake<br/>&gt;&gt; cabal install alex happy haddock<br/>&gt;&gt; sudo easy_install pip<br/>&gt;&gt; sudo pip install sphinx</span></pre><p id="0070" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">更多详情，请点击<a class="ae jp" href="https://ghc.haskell.org/trac/ghc/wiki/Building/Preparation/MacOSX" rel="noopener ugc nofollow" target="_blank">这里</a>。但是一旦你设置好了，你将会遵循和Windows一样的<code class="eh kt ku kv kw b">boot</code>、<code class="eh kt ku kv kw b">configure</code>和<code class="eh kt ku kv kw b">make</code>指令。</p><h1 id="d990" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">结论</h1><p id="aa51" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">这就结束了我们对GHC的第一次观察。光是建造它就有大量的工作要做！但是下周我们将开始研究一些我们能对GHC做的最简单的修改。这样，我们可以开始了解代码库是如何工作的。</p><p id="d333" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你没有写过Haskell，就很难体会到GHC的辉煌！从下载我们的<a class="ae jp" href="https://www.mmhaskell.com/beginners-checklist" rel="noopener ugc nofollow" target="_blank">初学者清单</a>和阅读我们的<a class="ae jp" href="https://www.mmhaskell.com/liftoff" rel="noopener ugc nofollow" target="_blank">起飞系列</a>开始吧！</p></div></div>    
</body>
</html>