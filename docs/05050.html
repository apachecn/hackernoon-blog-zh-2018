<html>
<head>
<title>Mastering MongoDB — Faster elections during rolling maintenance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">掌握MongoDB —滚动维护期间更快的选择</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/mongodb-faster-elections-a567ae5416f5?source=collection_archive---------9-----------------------#2018-06-15">https://medium.com/hackernoon/mongodb-faster-elections-a567ae5416f5?source=collection_archive---------9-----------------------#2018-06-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="0d13" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在<a class="ae jp" href="https://hackernoon.com/tagged/mongodb" rel="noopener ugc nofollow" target="_blank"> MongoDB </a> <a class="ae jp" href="https://docs.mongodb.com/manual/replication/" rel="noopener ugc nofollow" target="_blank">副本集</a>中的维护/升级通常以滚动方式执行。滚动维护/升级流程要求您一次对一个<a class="ae jp" href="https://docs.mongodb.com/manual/core/replica-set-members/#secondaries" rel="noopener ugc nofollow" target="_blank"> <em class="jq">次级</em> </a>进行维护，最后由<a class="ae jp" href="https://docs.mongodb.com/manual/core/replica-set-members/#primary" rel="noopener ugc nofollow" target="_blank"> <em class="jq">初级</em> </a>成员进行维护。</p><blockquote class="jr js jt"><p id="63aa" class="ir is jq it b iu iv iw ix iy iz ja jb ju jd je jf jv jh ji jj jw jl jm jn jo hn dt translated"><em class="hu">当你</em>退出<em class="hu">初选时，所有符合条件的二级选举将举行新的初选。在选出新的主数据库之前，</em> <a class="ae jp" href="https://hackernoon.com/tagged/database" rel="noopener ugc nofollow" target="_blank"> <em class="hu">数据库</em> </a> <em class="hu">不可用于写入。因此，“在执行滚动维护/升级时，您将如何快速选择新的主服务器？”</em></p></blockquote><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff jx"><img src="../Images/bec3888bae16dc43dfb2591b39cf7923.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NZ0QacuKUy2RY9tU"/></div></div><figcaption class="kj kk fg fe ff kl km bd b be z ek">Photo by <a class="ae jp" href="https://unsplash.com/@anniebolin?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">annie bolin</a> on <a class="ae jp" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="c8bf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是多部分系列中的许多文章之一，<a class="ae jp" rel="noopener" href="/p/mastering-mongodb-5544e16df023">掌握MongoDB —一天一个技巧</a>，专为您创建，通过学习<em class="jq">‘一天一个技巧’</em>来掌握<a class="ae jp" href="https://www.mongodb.com" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>。在几篇系列文章中，我将给出各种提示来帮助您回答上述问题。</p><p id="ba6a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本文讨论了滚动维护、没有<em class="jq">主</em>的含义、快速选举新的<em class="jq">主</em>所需的步骤以及该方法的利与弊。</p></div><div class="ab cl kn ko hc kp" role="separator"><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks"/></div><div class="hn ho hp hq hr"><h1 id="1f1c" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">掌握—滚动维护</h1><p id="4119" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">MongoDB通过副本集提供数据库的冗余和高可用性。副本集不仅可以帮助数据库从节点故障/网络分区中快速恢复，还可以让您在不影响高可用性的情况下执行维护任务。</p><p id="4b7f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">保持高可用性并能够执行维护的关键是“滚动维护”；一次对一个次级<em class="jq">进行维护</em></p><ul class=""><li id="5ef4" class="lx ly hu it b iu iv iy iz jc lz jg ma jk mb jo mc md me mf dt translated">在<em class="jq">辅助服务器</em>上停止MongoDB进程/服务</li><li id="d5b6" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">在服务器上执行所需的维护/升级</li><li id="4a80" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">在服务器上启动MongoDB进程/服务</li><li id="a595" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">等待服务器上的MongoDB赶上操作日志</li><li id="acfb" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">在副本集中的其他辅助节点上重复上述操作</li></ul><p id="ffb2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">给定一个具有3个MongoDB服务器的副本集— mon01 <em class="jq">(主服务器)、</em> mon02 <em class="jq">(辅助服务器)</em>和mon03 <em class="jq">(辅助服务器)，</em>滚动维护过程通常需要</p><ul class=""><li id="22e3" class="lx ly hu it b iu iv iy iz jc lz jg ma jk mb jo mc md me mf dt translated">在<em class="jq">辅助</em>服务器<code class="eh ml mm mn mo b">mon03</code>上执行维护</li><li id="1475" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">在另一个<em class="jq">辅助</em>服务器<code class="eh ml mm mn mo b">mon02</code>上执行维护</li><li id="0601" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated"><em class="jq">降级</em>主<em class="jq">服务器</em>，<code class="eh ml mm mn mo b">mon01</code></li><li id="c487" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">等待新的<em class="jq">初选</em>选出，比如说<code class="eh ml mm mn mo b">mon02</code></li><li id="c231" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">对原<em class="jq">主</em>服务器<code class="eh ml mm mn mo b">mon01</code>进行维护</li></ul><p id="fbbc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有关滚动升级的更多详细信息，请阅读Bryan Reinero的<a class="ae jp" href="https://www.mongodb.com/blog/post/your-ultimate-guide-to-rolling-upgrades" rel="noopener ugc nofollow" target="_blank">滚动升级终极指南</a>。</p><h1 id="04e8" class="ku kv hu bd kw kx mp kz la lb mq ld le lf mr lh li lj ms ll lm ln mt lp lq lr dt translated">没有初选的影响</h1><p id="c5f3" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">默认情况下，两种读/写操作都在主服务器上执行。您可以使用<em class="jq">辅助</em>读取首选项来读取<em class="jq">辅助</em>中的一个。然而，<em class="jq">主服务器</em>是副本集中唯一接收写操作的成员。因此，在副本集中始终有一个主副本是至关重要的。</p><p id="1031" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当一个<em class="jq">主</em>不可用/不能被大多数<em class="jq">次</em>到达时，所有合格的<em class="jq">次</em>将为一个新的<em class="jq">主</em>进行选举。在选择新的主服务器之前，源自客户端驱动程序的所有写入和读取(在主服务器上)操作将等待<em class="jq">主服务器</em>可用和/或超时。因此，迅速选举出主要候选人很重要，这样等待主要候选人的操作数量就很少。</p><h1 id="27bd" class="ku kv hu bd kw kx mp kz la lb mq ld le lf mr lh li lj ms ll lm ln mt lp lq lr dt translated">如何快速选出新的初选</h1><p id="b31c" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">如果主服务器意外终止和/或面临来自大多数服务器的网络连接问题，辅助服务器可以在错过心跳10秒后请求选举。所以需要一些时间。</p><h2 id="48cc" class="mu kv hu bd kw mv mw mx la my mz na le jc nb nc li jg nd ne lm jk nf ng lq nh dt translated">逐步退出初选</h2><p id="6f38" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">关闭主服务器会加快故障切换过程。因此建议<em class="jq">降低</em>主节点来强制触发选举，而不是<em class="jq">关闭</em>主节点<em class="jq">主节点</em>并让<em class="jq">从节点</em>发现无法到达的主节点。我敢打赌，你们大多数人已经在使用这种方法了。所以，让我们回顾一下初选前你可以利用的其他一些技巧。</p><h2 id="e229" class="mu kv hu bd kw mv mw mx la my mz na le jc nb nc li jg nd ne lm jk nf ng lq nh dt translated">仅使一个辅助节点可被选择</h2><p id="7d07" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">如果其中一个辅助节点上的复制延迟较低，那么您可以主动选择它作为下一次选举的唯一辅助节点。通常，您会选择一个具有以下特征的辅助节点</p><ul class=""><li id="8955" class="lx ly hu it b iu iv iy iz jc lz jg ma jk mb jo mc md me mf dt translated">低复制延迟</li><li id="53ff" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">低网络延迟</li><li id="3204" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">与当前主服务器相似的优先级</li><li id="d293" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">或者具有次高优先级成员</li></ul><p id="1cf0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">假设您想要将一个<em class="jq">辅助</em>服务器<code class="eh ml mm mn mo b">mon02</code>固定为下一个<em class="jq">主服务器</em>，那么您可以通过在其上运行<code class="eh ml mm mn mo b">rs.freeze(60)</code>来使<em class="jq">辅助</em>服务器<code class="eh ml mm mn mo b">mon03</code>在60秒内没有资格成为<em class="jq">主服务器</em>。这将使选举更快，因为当你让服务器<code class="eh ml mm mn mo b">mon01</code>下台<em class="jq">时，辅助服务器</em><code class="eh ml mm mn mo b">mon02</code>是唯一可当选的<em class="jq">主服务器</em>。</p><h2 id="da3c" class="mu kv hu bd kw mv mw mx la my mz na le jc nb nc li jg nd ne lm jk nf ng lq nh dt translated">降低设置。electionTimeoutMillis</h2><p id="94f3" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">检测副本集的主副本何时不可访问的默认时间限制是10秒。通过将<code class="eh ml mm mn mo b">settings.electionTimeoutMillis</code>减少到比如说2秒，你可以更快地进行检测和选举。</p><h1 id="76da" class="ku kv hu bd kw kx mp kz la lb mq ld le lf mr lh li lj ms ll lm ln mt lp lq lr dt translated">加快选举的步骤总结</h1><p id="5504" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">我总结了以下步骤，以便在维护期间更快地进行选择。请在生产环境中运行它们之前进行测试。</p><ul class=""><li id="1908" class="lx ly hu it b iu iv iy iz jc lz jg ma jk mb jo mc md me mf dt translated">确定您希望它成为下一个主服务器的服务器</li><li id="b944" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">在所有其他辅助设备上执行<code class="eh ml mm mn mo b">rs.freeze(60)</code></li><li id="c84c" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">在副本集配置上设置<code class="eh ml mm mn mo b">settings.electionTimeoutMillis=2000</code></li><li id="a567" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">在当前主节点上执行<code class="eh ml mm mn mo b">rs.stepDown()</code></li><li id="70bb" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">等待新的初选被选出</li><li id="3185" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">重置新主设备上的<code class="eh ml mm mn mo b">settings.electionTimeoutMillis=10000</code></li></ul><h1 id="236d" class="ku kv hu bd kw kx mp kz la lb mq ld le lf mr lh li lj ms ll lm ln mt lp lq lr dt translated">该方法的利弊</h1><p id="3e2a" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">假设以上所有的建议对你都很有效。你可能想知道-</p><blockquote class="ni"><p id="3281" class="nj nk hu bd nl nm nn no np nq nr jo ek translated">“如果降低选举时间有助于加快选举，那么我为什么不能一直保持低选举时间呢？”</p></blockquote><p id="9e94" class="pw-post-body-paragraph ir is hu it b iu nt iw ix iy nu ja jb jc nv je jf jg nw ji jj jk nx jm jn jo hn dt translated">很棒的问题！在滚动维护期间，您的应用程序可能会面临流量减少。最重要的是，您正在密切监视所有服务器，并手动将一个<em class="jq">辅助服务器</em>锁定为下一个<em class="jq">主服务器</em>。因此，在那个时刻，您可以使用较低的electionTimeoutMillis值。</p><p id="5a35" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jq">但是，将electionTimeoutMillis设置为较低的值不仅会导致更快的故障转移，还会对主节点或网络速度慢或不稳定的敏感度增加产生负面影响。</em></p><p id="2f65" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当出现短暂的网络连接问题时，这可能会导致过多的选举。相反，将electionTimeoutMillis设置为较大的值会使您的副本集更能适应短暂的网络中断，但也会导致平均故障转移时间变慢。</p><p id="f5ad" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">底线是YMMV您需要测试各种electionTimeoutMillis值，并选择更适合您的值。或者保留默认值10秒。</p><blockquote class="ni"><p id="c1f8" class="nj nk hu bd nl nm nn no np nq nr jo ek translated"><em class="ns">无论您做什么，“永远不要将electionTimeoutMillis设置为小于您的两个成员之间的往返网络延迟时间的值。”</em></p></blockquote><h1 id="8f1d" class="ku kv hu bd kw kx mp kz la lb mq ld le lf ny lh li lj nz ll lm ln oa lp lq lr dt translated">动手实验练习</h1><p id="985d" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">本实验练习帮助您了解在滚动维护期间快速选择新主节点所需的步骤。</p><h2 id="e880" class="mu kv hu bd kw mv mw mx la my mz na le jc nb nc li jg nd ne lm jk nf ng lq nh dt translated">设置环境</h2><p id="4583" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">首先，你需要一个玩耍的环境。我已经在AWS中创建了3个RHEL 7.5版实例，你也可以在本地主机上使用服务器的<code class="eh ml mm mn mo b">/etc/hosts</code>条目来运行它们。如果您已经有一个MongoDB v3.6副本集环境，您可以跳过这一步。</p><p id="f7cb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下载并解压MongoDB v3.6二进制文件，启动MongoDB服务器监听绑定端口27000上的所有IP。</p><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ob oc l"/></div><figcaption class="kj kk fg fe ff kl km bd b be z ek">A bash script with download MongoDB v3.6.5 and start mongod on port 27000</figcaption></figure><h2 id="861a" class="mu kv hu bd kw mv mw mx la my mz na le jc nb nc li jg nd ne lm jk nf ng lq nh dt translated">启动副本集</h2><p id="7367" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">使用服务器<code class="eh ml mm mn mo b">mon01</code>上的上述主机启动MongoDB副本集</p><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ob oc l"/></div><figcaption class="kj kk fg fe ff kl km bd b be z ek">A bash script to initiate a replica set with 3 hosts we created earlier</figcaption></figure><h2 id="5cbb" class="mu kv hu bd kw mv mw mx la my mz na le jc nb nc li jg nd ne lm jk nf ng lq nh dt translated">显示副本集配置和状态</h2><p id="4b07" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">请注意分别来自<code class="eh ml mm mn mo b">rs.config()</code>和<code class="eh ml mm mn mo b">rs.status()</code>的输出。它们帮助您确定当前的<code class="eh ml mm mn mo b">settings.electionTimeoutMillis: 10000</code>，并根据<code class="eh ml mm mn mo b">priority</code>、<code class="eh ml mm mn mo b">optime</code>、<code class="eh ml mm mn mo b">lastHeartbeat</code>和<code class="eh ml mm mn mo b">pingMs</code>中的值选择一个<em class="jq">次级</em>作为下一个<em class="jq">初级</em>。</p><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ob oc l"/></div><figcaption class="kj kk fg fe ff kl km bd b be z ek">A JavaScript method to show the replica set configuration settings</figcaption></figure><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ob oc l"/></div><figcaption class="kj kk fg fe ff kl km bd b be z ek">A JavaScript method to show the replica set status information</figcaption></figure><h2 id="8402" class="mu kv hu bd kw mv mw mx la my mz na le jc nb nc li jg nd ne lm jk nf ng lq nh dt translated">选择潜在的下一个初选</h2><p id="946d" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated"><code class="eh ml mm mn mo b">rs.status()</code>和<code class="eh ml mm mn mo b">db.printSlaveReplication()</code>命令显示，两个<em class="jq">次级</em>、<code class="eh ml mm mn mo b">mon02</code>和<code class="eh ml mm mn mo b">mon03</code>都在<em class="jq">主</em>、<code class="eh ml mm mn mo b">mon01</code>的操作日志条目上。然而，<code class="eh ml mm mn mo b">pingMs</code>显示<code class="eh ml mm mn mo b">mon02</code>比<code class="eh ml mm mn mo b">mon03</code>更靠近<code class="eh ml mm mn mo b">mon01</code>。因此，您可以选择<code class="eh ml mm mn mo b">mon02</code>作为下一个潜在的初选，同时退出当前初选。</p><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ob oc l"/></div><figcaption class="kj kk fg fe ff kl km bd b be z ek">A JavaScript function to show the database printSlaveReplicationInfo command output</figcaption></figure><h2 id="f609" class="mu kv hu bd kw mv mw mx la my mz na le jc nb nc li jg nd ne lm jk nf ng lq nh dt translated">冻结其他次级</h2><p id="e1ae" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">基于上述<code class="eh ml mm mn mo b">pingMs</code>，我们不希望服务器<code class="eh ml mm mn mo b">mon03</code>被选为<em class="jq">主服务器</em>。所以，运行下面的命令来阻止它在下一届选举中竞争。</p><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ob oc l"/></div><figcaption class="kj kk fg fe ff kl km bd b be z ek">A JavaScript method invoking rs.freeze to make the replica set member ineligible to become primary</figcaption></figure><h2 id="c78d" class="mu kv hu bd kw mv mw mx la my mz na le jc nb nc li jg nd ne lm jk nf ng lq nh dt translated">设置electionTimeoutMillis并逐步退出初选</h2><p id="7bea" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">在当前主服务器<code class="eh ml mm mn mo b">mon01</code>上重新配置副本集设置的electionTimeoutMillis。最后执行命令<code class="eh ml mm mn mo b">rs.stepDown()</code>强制触发选举，选举<code class="eh ml mm mn mo b">mon02</code>为下一届<em class="jq">初选</em>。</p><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ob oc l"/></div><figcaption class="kj kk fg fe ff kl km bd b be z ek">A JavaScript code to set the electionTimeoutMillis to 2 seconds and stepDown the primary</figcaption></figure><p id="c217" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可能会注意到，新的主服务器在大约2秒内可用，而默认情况下为10-12秒。各台机器上的以下<em class="jq"> mongod.log </em>文件显示<code class="eh ml mm mn mo b">mon02</code>到主服务器的转换在大约2秒内完成。</p><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ob oc l"/></div><figcaption class="kj kk fg fe ff kl km bd b be z ek">A bash script to show the transition of mon02 from Secondary to Primary</figcaption></figure><h2 id="68db" class="mu kv hu bd kw mv mw mx la my mz na le jc nb nc li jg nd ne lm jk nf ng lq nh dt translated">在新的主服务器上重置electionTimeoutMillis</h2><p id="05cb" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">一旦选择了新的主节点，请将electionTimeoutMillis恢复为默认值，以避免在短暂的网络连接问题期间频繁进行选举。</p><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ob oc l"/></div><figcaption class="kj kk fg fe ff kl km bd b be z ek">A JavaScript code to reset the electionTimeoutMillis back to its default value</figcaption></figure><h1 id="0d28" class="ku kv hu bd kw kx mp kz la lb mq ld le lf mr lh li lj ms ll lm ln mt lp lq lr dt translated">摘要</h1><p id="5881" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">我想提醒重要的一点——</p><blockquote class="ni"><p id="1ec4" class="nj nk hu bd nl nm nn no np nq nr jo ek translated"><em class="ns">尽管MongoDB数据库应用程序在选举期间高度可用于从辅助节点读取数据，但在选举主节点之前，数据库不可用于写入数据。因此，务必确保主映像尽早可用，以满足您的写入SLA要求。</em></p></blockquote><p id="9495" class="pw-post-body-paragraph ir is hu it b iu nt iw ix iy nu ja jb jc nv je jf jg nw ji jj jk nx jm jn jo hn dt translated">根据这里讨论的技巧，你可以在3秒钟内选出新的初选。如果您的应用程序每秒处理大约10，000次操作，那么您将有大约30，000次操作在新的主服务器上等待。现在，您可能想知道—“<em class="jq">当所有30，000个操作同时冲击新的主服务器时，我可以采取什么措施来确保数据库服务器不会瘫痪</em>？”</p><p id="5a56" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">同样，这是一个很好的问题，但这是另一天的主题。希望你今天在通往“<a class="ae jp" rel="noopener" href="/p/mastering-mongodb-5544e16df023">掌握MongoDB——一天一个技巧</a>”的道路上学到了一些新东西。</p></div><div class="ab cl kn ko hc kp" role="separator"><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks"/></div><div class="hn ho hp hq hr"><h1 id="1bfe" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">以前的文章</h1><ul class=""><li id="6723" class="lx ly hu it b iu ls iy lt jc od jg oe jk of jo mc md me mf dt translated">掌握MongoDB — <a class="ae jp" href="https://hackernoon.com/mastering-mongodb-one-tip-a-day-series-5544e16df023" rel="noopener ugc nofollow" target="_blank">一天一个技巧系列</a> <br/>专为掌握MongoDB而打造的系列文章</li><li id="c06e" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">提示# 003: <a class="ae jp" rel="noopener" href="/@shyam.arjarapu/mongodb-transactions-5654cdb8fd24">事务</a> <br/>许多人期待已久、最想拥有的功能终于到来了</li><li id="8939" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">技巧# 002: <a class="ae jp" rel="noopener" href="/@shyam.arjarapu/mongodb-createrole-e1ca1346d3bb"> createRole </a> <br/>如何防止有人掉你的收藏？</li><li id="202a" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">技巧# 001:<a class="ae jp" rel="noopener" href="/p/mongodb-currentop-18fe2f9dbd68">current top</a><br/>彻底了解MongoDB服务器上当前正在执行的操作</li></ul><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="og oc l"/></div></figure></div></div>    
</body>
</html>