<html>
<head>
<title>Build a chat app using ASP.NET</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨ASPå»ºç«‹ä¸€ä¸ªèŠå¤©åº”ç”¨ç¨‹åºã€‚ç½‘</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/hackernoon/build-a-chat-app-using-asp-net-b6804d0bf794?source=collection_archive---------5-----------------------#2018-06-18">https://medium.com/hackernoon/build-a-chat-app-using-asp-net-b6804d0bf794?source=collection_archive---------5-----------------------#2018-06-18</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><blockquote class="ir is it"><p id="3b58" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">è¦é˜…è¯»æœ¬æ•™ç¨‹ï¼Œéœ€è¦å¯¹C#å’ŒjQueryæœ‰åŸºæœ¬çš„äº†è§£ã€‚</p></blockquote><p id="01d6" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æˆ‘ä»¬å½“ä»Šæ—¶ä»£çš„äº¤æµä¸»è¦æ˜¯æ•°å­—åŒ–çš„ï¼Œè€Œæœ€æµè¡Œçš„æ•°å­—åŒ–äº¤æµå½¢å¼æ˜¯å³æ—¶é€šè®¯ã€‚</p><p id="af54" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ä¸€äº›åº”ç”¨ç¨‹åºåŒ…æ‹¬æŸç§å½¢å¼çš„èŠå¤©å·¥å…·ï¼Œå¦‚Slackæˆ–è„¸ä¹¦ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†è€ƒè™‘å¦‚ä½•ä½¿ç”¨C# .NETæ„å»ºä¸€ä¸ªèŠå¤©åº”ç”¨ç¨‹åºã€‚</p><p id="4670" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">è¦å®Œæˆæœ¬æ•™ç¨‹ï¼Œæ‚¨éœ€è¦:</p><ul class=""><li id="56ce" class="jw jx hu ix b iy iz jc jd jt jy ju jz jv ka js kb kc kd ke dt translated">Visual Studioï¼Œä¸€ä¸ªå¹¿æ³›ç”¨äºæ„å»ºçš„IDEã€‚NETé¡¹ç›®ã€‚ç‚¹å‡»æŸ¥çœ‹å®‰è£…è¯¦æƒ…<a class="ae kf" href="https://www.visualstudio.com/" rel="noopener ugc nofollow" target="_blank">ã€‚</a></li><li id="a0a2" class="jw jx hu ix b iy kg jc kh jt ki ju kj jv kk js kb kc kd ke dt translated">C#åŸºç¡€çŸ¥è¯†ã€‚</li><li id="b88b" class="jw jx hu ix b iy kg jc kh jt ki ju kj jv kk js kb kc kd ke dt translated">çš„åŸºæœ¬çŸ¥è¯†ã€‚å‡€MVCã€‚</li><li id="c66e" class="jw jx hu ix b iy kg jc kh jt ki ju kj jv kk js kb kc kd ke dt translated">JavaScript (jQuery)åŸºç¡€çŸ¥è¯†ã€‚</li></ul><figure class="km kn ko kp fq kq fe ff paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="fe ff kl"><img src="../Images/75640600f1a9d1a88b1e41b1bc4dbdf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jSFxKlmzi0fgPLgk.gif"/></div></div></figure><h1 id="95f9" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">è®¾ç½®æˆ‘ä»¬çš„èŠå¤©é¡¹ç›®</h1><p id="7960" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf jt lx ji jj ju ly jm jn jv lz jq jr js hn dt translated">ä½¿ç”¨æˆ‘ä»¬çš„Visual Studio IDEï¼Œæˆ‘ä»¬å°†æŒ‰ç…§<strong class="ix hv">æ–°å»ºé¡¹ç›®</strong>å‘å¯¼åˆ›å»ºæˆ‘ä»¬çš„èŠå¤©é¡¹ç›®ã€‚</p><p id="f58f" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æˆ‘ä»¬å°†:</p><ul class=""><li id="6bf1" class="jw jx hu ix b iy iz jc jd jt jy ju jz jv ka js kb kc kd ke dt translated">å°†C#è®¾ä¸ºæˆ‘ä»¬è¦ä½¿ç”¨çš„è¯­è¨€ã€‚</li><li id="98b8" class="jw jx hu ix b iy kg jc kh jt ki ju kj jv kk js kb kc kd ke dt translated">é€‰æ‹©ã€‚NET MVCé¡¹ç›®ä½œä¸ºæ¨¡æ¿ã€‚</li><li id="67c0" class="jw jx hu ix b iy kg jc kh jt ki ju kj jv kk js kb kc kd ke dt translated">å¡«å†™é¡¹ç›®åç§°ï¼Œä¾‹å¦‚HeyChatã€‚</li><li id="1ff2" class="jw jx hu ix b iy kg jc kh jt ki ju kj jv kk js kb kc kd ke dt translated">å¡«å†™è§£å†³æ–¹æ¡ˆåç§°ï¼Œå³åº”ç”¨ç¨‹åºåç§°ã€‚</li></ul><figure class="km kn ko kp fq kq fe ff paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="fe ff ma"><img src="../Images/eec1ced5bdbd0bf26a2b015a15a2a69f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jBcNmHtqo6xeSJvd.gif"/></div></div></figure><h1 id="8efb" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">åˆ›å»ºæˆ‘ä»¬çš„èŠå¤©åº”ç”¨</h1><h1 id="672d" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">å®šä¹‰é¡µé¢å’Œè·¯çº¿</h1><p id="5cfa" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf jt lx ji jj ju ly jm jn jv lz jq jr js hn dt translated">å‡ºäºæœ¬æ•™ç¨‹çš„ç›®çš„ï¼Œæˆ‘ä»¬çš„èŠå¤©åº”ç”¨ç¨‹åºå°†ç”±2ä¸ªé¡µé¢ç»„æˆ:</p><ul class=""><li id="8bab" class="jw jx hu ix b iy iz jc jd jt jy ju jz jv ka js kb kc kd ke dt translated">é¦–é¡µâ€”â€”ç”¨æˆ·æ³¨å†Œçš„åœ°æ–¹ã€‚</li><li id="3f83" class="jw jx hu ix b iy kg jc kh jt ki ju kj jv kk js kb kc kd ke dt translated">èŠå¤©è§†å›¾â€”ç”¨æˆ·åœ¨è¿™é‡Œé€‰æ‹©ä¸€ä¸ªè”ç³»äººå¹¶äº¤æ¢æ¶ˆæ¯ã€‚</li></ul><p id="8d3c" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ä¸ºäº†å®ç°è¿™äº›è§‚ç‚¹ï¼Œæˆ‘ä»¬å°†éœ€è¦ä»¥ä¸‹é€”å¾„:</p><ul class=""><li id="03d0" class="jw jx hu ix b iy iz jc jd jt jy ju jz jv ka js kb kc kd ke dt translated">å‘ˆç°é¦–é¡µçš„è·¯çº¿ã€‚</li><li id="84f5" class="jw jx hu ix b iy kg jc kh jt ki ju kj jv kk js kb kc kd ke dt translated">å®ç°ç™»å½•çš„è·¯å¾„ã€‚</li><li id="e497" class="jw jx hu ix b iy kg jc kh jt ki ju kj jv kk js kb kc kd ke dt translated">å‘ˆç°èŠå¤©é¡µé¢çš„è·¯å¾„ã€‚</li></ul><blockquote class="ir is it"><p id="a43d" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><em class="hu">ğŸ’¡è¿™äº›è·¯ç”±ä»…å‘ˆç°è§†å›¾å¹¶å®ç°ç”¨æˆ·ç™»å½•ã€‚æˆ‘ä»¬ä¼šç»§ç»­å¢åŠ æ›´å¤šçš„è·¯çº¿ã€‚</em></p></blockquote><p id="e908" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">å°†è¿™äº›è·¯çº¿æ·»åŠ åˆ°æˆ‘ä»¬çš„<code class="eh mb mc md me b">RouteConfig.cs</code>æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†å¾—åˆ°:</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="ab24" class="mj ky hu me b fv mk ml l mm mn">routes.MapRoute(<br/>        name: "Home",<br/>        url: "",<br/>        defaults: new { controller = "Home", action = "Index" }<br/>    );</span><span id="d7ea" class="mj ky hu me b fv mo ml l mm mn">    routes.MapRoute(<br/>        name: "Login",<br/>        url: "login",<br/>        defaults: new { controller = "Auth", action = "Login" }<br/>    );</span><span id="0af5" class="mj ky hu me b fv mo ml l mm mn">    routes.MapRoute(<br/>        name: "ChatRoom",<br/>        url: "chat",<br/>        defaults: new { controller = "Chat", action="Index"}<br/>    );</span></pre><p id="61d3" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">è¿™äº›è·¯çº¿å®šä¹‰è§„å®šäº†è·¯çº¿æ¨¡å¼å’Œå¤„ç†å®ƒçš„<strong class="ix hv">æ§åˆ¶å™¨</strong>å’Œ<strong class="ix hv">åŠ¨ä½œ</strong>ã€‚</p><blockquote class="ir is it"><p id="58b6" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><em class="hu">ğŸ’¡ç”¨Visual Studioåˆ›å»ºæˆ‘ä»¬çš„é¡¹ç›®ä¼šè‡ªåŠ¨åˆ›å»ºå¸¦æœ‰</em> <code class="eh mb mc md me b"><em class="hu">Index</em></code> <em class="hu">åŠ¨ä½œçš„</em> <code class="eh mb mc md me b"><em class="hu">HomeContoller.cs</em></code> <em class="hu">æ–‡ä»¶ã€‚æˆ‘ä»¬å°†ç”¨å®ƒä½œä¸ºå›å®¶çš„è·¯çº¿ã€‚</em></p></blockquote><p id="bfa0" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">åœ¨æˆ‘ä»¬çš„<code class="eh mb mc md me b">HomeController.cs</code>ä¸­ï¼Œæˆ‘ä»¬å°†å‘ˆç°é¦–é¡µï¼Œç”¨æˆ·å¯ä»¥ç”¨å®ƒç™»å½•:</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="2141" class="mj ky hu me b fv mk ml l mm mn">//HomeController.cs</span><span id="2b8d" class="mj ky hu me b fv mo ml l mm mn">    // ...<br/>    Using System.Web.Mvc;<br/>    // ...<br/>    public class HomeController : Controller<br/>    {<br/>        public ActionResult Index()<br/>        {<br/>            if ( Session["user"] != null ) {<br/>                return Redirect("/chat");<br/>            }</span><span id="2633" class="mj ky hu me b fv mo ml l mm mn">            return View();<br/>        }<br/>    }</span></pre><blockquote class="ir is it"><p id="0c95" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><em class="hu">ğŸ’¡å‡½æ•°</em> <code class="eh mb mc md me b"><em class="hu">View</em></code> <em class="hu">åˆ›å»ºä¸€ä¸ªæˆ‘ä»¬è¿”å›çš„è§†å›¾å“åº”ã€‚å½“å®ƒè¢«è°ƒç”¨æ—¶ï¼ŒC#å¯»æ‰¾è°ƒç”¨æ§åˆ¶å™¨ç±»çš„é»˜è®¤è§†å›¾ã€‚è¯¥é»˜è®¤è§†å›¾æ˜¯åœ¨è§†å›¾ç›®å½•ä¸­æ‰¾åˆ°çš„</em> <code class="eh mb mc md me b"><em class="hu">index.cshtml</em></code> <em class="hu">æ–‡ä»¶ï¼Œè¯¥ç›®å½•ä¸æ§åˆ¶å™¨åŒåï¼Œå³HomeControllerç±»çš„é»˜è®¤è§†å›¾å°†æ˜¯</em> <code class="eh mb mc md me b"><em class="hu">Views/Home/index.cshtml</em></code> <em class="hu">æ–‡ä»¶ã€‚</em></p></blockquote><h1 id="3d49" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">å»ºç«‹æˆ‘ä»¬çš„æ•°æ®åº“</h1><p id="13bb" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf jt lx ji jj ju ly jm jn jv lz jq jr js hn dt translated">ä¸ºäº†å®ç°æˆ‘ä»¬çš„ç™»å½•åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°æ®åº“æ¥å­˜å‚¨ç”¨æˆ·ã€‚æœ‰å‡ ä¸ªæ•°æ®åº“é©±åŠ¨ç¨‹åºå¯ä¾›é€‰æ‹©ï¼Œä½†æ˜¯åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨MySQLæ•°æ®åº“é©±åŠ¨ç¨‹åºå’Œä¸€ä¸ªåä¸ºå®ä½“æ¡†æ¶çš„. NET ORMã€‚</p><p id="74d8" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æˆ‘ä»¬å°†ä»é€šè¿‡NuGetå®‰è£…<code class="eh mb mc md me b">MySql.Data.Entities</code>åŒ…å¼€å§‹ã€‚NETçš„åŒ…ç®¡ç†å™¨)ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†é€šè¿‡NuGetå®‰è£…<strong class="ix hv">å®ä½“æ¡†æ¶</strong>åŒ…ï¼Œä¸ºæˆ‘ä»¬æä¾›ORMåŠŸèƒ½ã€‚</p><blockquote class="ir is it"><p id="d383" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><em class="hu">ğŸ’¡è¦ä½¿ç”¨NuGetå®‰è£…è½¯ä»¶åŒ…ï¼Œè¯·åœ¨æˆ‘ä»¬çš„é¡¹ç›®è§£å†³æ–¹æ¡ˆä¸­å³é”®å•å‡»packagesæ–‡ä»¶å¤¹ã€‚é€‰æ‹©</em> <code class="eh mb mc md me b"><em class="hu">Add Package</em></code> <em class="hu">é€‰é¡¹ï¼›å¹¶æœç´¢å’Œé€‰æ‹©æ‚¨æƒ³è¦çš„åŒ…ã€‚</em></p></blockquote><p id="3134" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ä¸€æ—¦æˆ‘ä»¬çš„åŒ…è¢«å®‰è£…ï¼Œæˆ‘ä»¬å°†å¼€å§‹è®¾ç½®æˆ‘ä»¬çš„æ•°æ®åº“è¿æ¥å’Œé€šä¿¡ã€‚</p><p id="2b46" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">é¦–å…ˆï¼Œæˆ‘ä»¬å°†æŠŠæ•°æ®åº“è¿æ¥å‡­è¯æ·»åŠ åˆ°è§£å†³æ–¹æ¡ˆæ–‡ä»¶å¤¹ä¸­çš„<code class="eh mb mc md me b">Web.config</code>æ–‡ä»¶ä¸­ã€‚åœ¨<code class="eh mb mc md me b">Web.config</code>ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ :</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="1550" class="mj ky hu me b fv mk ml l mm mn">&lt;connectionStrings&gt;<br/>        &lt;add name="YourConnectionName" connectionString="Server=localhost;Database=database_name;Uid=root;Pwd=YourPassword;" providerName="MySql.Data.MySqlClient" /&gt;<br/>    &lt;/connectionStrings&gt;</span></pre><blockquote class="ir is it"><p id="d82d" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><em class="hu"> âš ï¸æ‚¨éœ€è¦ç”¨å®é™…å€¼æ•°æ®åº“å€¼æ›¿æ¢ä¸Šé¢ä»£ç ç‰‡æ®µä¸­çš„å ä½ç¬¦å€¼ã€‚</em></p></blockquote><p id="d0db" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated"><code class="eh mb mc md me b">Web.config</code>æ–‡ä»¶æ˜¯ä¸€ä¸ª<strong class="ix hv"> XML </strong>æ–‡ä»¶ï¼Œä¸Šé¢çš„<code class="eh mb mc md me b">connectionStrings</code>å…ƒç´ å°†è¢«æ·»åŠ åˆ°æ–‡ä»¶çš„<code class="eh mb mc md me b">configuration</code>å…ƒç´ ä½“ä¸­ã€‚</p><p id="00e1" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª<code class="eh mb mc md me b">Models</code>æ–‡ä»¶å¤¹(ä¸<code class="eh mb mc md me b">Controllers</code>åœ¨åŒä¸€æ–‡ä»¶å¤¹çº§åˆ«)ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºæˆ‘ä»¬çš„æ¨¡å‹ç±»â€”â€”è¿™ä¸ªç±»ä»£è¡¨äº†æˆ‘ä»¬çš„è¡¨ã€‚å¯¹äºç™»å½•ç‰¹æ€§ï¼Œæˆ‘ä»¬å°†åˆ›å»º<code class="eh mb mc md me b">User.cs</code>æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªç±»æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ æ¨¡å‹çš„å±æ€§:</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="2efa" class="mj ky hu me b fv mk ml l mm mn">// File: User.cs file</span><span id="d459" class="mj ky hu me b fv mo ml l mm mn">    using System;<br/>    using System.Collections.Generic;<br/>    namespace HeyChat.Models<br/>    {<br/>        public class User<br/>        {<br/>            public User()<br/>            {<br/>            }</span><span id="a7c5" class="mj ky hu me b fv mo ml l mm mn">            public int id { get; set; }<br/>            public string name { get; set; }<br/>            public DateTime created_at { get; set; }<br/>        }<br/>    }</span></pre><blockquote class="ir is it"><p id="0898" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><em class="hu">ğŸ’¡è¦åˆ›å»ºä¸€ä¸ªæ¨¡å‹ç±»ï¼Œå³å‡»æ¨¡å‹æ–‡ä»¶å¤¹ï¼Œé€‰æ‹©</em> <code class="eh mb mc md me b"><em class="hu">Add</em></code> <em class="hu">å’Œ</em> <code class="eh mb mc md me b"><em class="hu">New File</em></code> <em class="hu">é€‰é¡¹ï¼Œç„¶ååœ¨</em> <code class="eh mb mc md me b"><em class="hu">Empty Class</em></code> <em class="hu">é€‰é¡¹ä¸­å¡«å…¥ç±»åã€‚</em></p></blockquote><p id="ea26" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æˆ‘ä»¬çš„<code class="eh mb mc md me b">User</code>æ¨¡å‹ä¸ºæˆ‘ä»¬çš„usersè¡¨å®šä¹‰äº†å”¯ä¸€æ ‡è¯†IDã€ç”¨æˆ·åå’Œç”¨æˆ·çš„åˆ›å»ºæ—¥æœŸã€‚</p><p id="83db" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æœ€åï¼Œæˆ‘ä»¬å°†æ·»åŠ æ•°æ®åº“ä¸Šä¸‹æ–‡ç±»ã€‚è¿™ä¸ªç±»è¯»å…¥æˆ‘ä»¬åœ¨<code class="eh mb mc md me b">Web.config</code>æ–‡ä»¶ä¸­å®šä¹‰çš„æ•°æ®åº“è¿æ¥é…ç½®ï¼Œå¹¶è·å–å®ƒåº”è¯¥åº”ç”¨é…ç½®çš„æ¨¡å‹ç±»(æ•°æ®é›†)ã€‚</p><p id="a593" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æˆ‘ä»¬å°†åœ¨æˆ‘ä»¬çš„<code class="eh mb mc md me b">Models</code>æ–‡ä»¶å¤¹ä¸­åˆ›å»ºæˆ‘ä»¬çš„ä¸Šä¸‹æ–‡ç±»ï¼Œéµå¾ªåˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºç±»çš„ç›¸åŒæ­¥éª¤ï¼Œæˆ‘ä»¬å°†å®ƒå‘½åä¸º<code class="eh mb mc md me b">ChatContext.cs</code>ã€‚åœ¨å…¶ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ ä»¥ä¸‹å†…å®¹:</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="aa6b" class="mj ky hu me b fv mk ml l mm mn">// File: ChatContext.cs</span><span id="e29b" class="mj ky hu me b fv mo ml l mm mn">    using System;<br/>    using System.Data.Entity;<br/>    namespace HeyChat.Models<br/>    {<br/>        public class ChatContext: DbContext<br/>        {<br/>            public ChatContext() : base("YourConnectionName")<br/>            {<br/>            }</span><span id="bf7a" class="mj ky hu me b fv mo ml l mm mn">            public static ChatContext Create()<br/>            {<br/>                return new ChatContext();<br/>            }</span><span id="1192" class="mj ky hu me b fv mo ml l mm mn">            public DbSet&lt;User&gt; Users { get; set; }<br/>        }<br/>    }</span></pre><blockquote class="ir is it"><p id="02d7" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><em class="hu">ğŸ’¡æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ä»£ç ä¼˜å…ˆçš„æ–¹æ³•å®ç°å®ä½“æ¡†æ¶ORMã€‚è¿™ç§æ–¹æ³•åŒ…æ‹¬ç¼–å†™å®šä¹‰æ¨¡å‹(è¡¨)çš„ä»£ç ï¼Œè€Œä¸éœ€è¦ä»»ä½•ç°æœ‰çš„æ•°æ®åº“æˆ–è¡¨ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œå½“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»£ç è¢«æ‰§è¡Œæ—¶ï¼Œæ•°æ®åº“å’Œè¡¨å°†è¢«åˆ›å»ºã€‚</em></p></blockquote><h1 id="8086" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">ç™»å½•æˆ‘ä»¬çš„ç”¨æˆ·</h1><p id="4885" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf jt lx ji jj ju ly jm jn jv lz jq jr js hn dt translated">ç”±äºæˆ‘ä»¬çš„æ•°æ®åº“è¿æ¥å’Œæ¨¡å‹(å°½ç®¡éšç€æˆ‘ä»¬çš„æ·±å…¥ï¼Œå¯èƒ½ä¼šå¼•å…¥æ›´å¤šçš„æ¨¡å‹)å·²ç»åˆ›å»ºï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­æˆ‘ä»¬çš„ç™»å½•åŠŸèƒ½ã€‚</p><p id="2d9e" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ä»<code class="eh mb mc md me b">HomeController</code>å‘ˆç°çš„é¦–é¡µå°†åŒ…å«ä¸€ä¸ªæ¥å—ç”¨æˆ·åçš„è¡¨å•ã€‚æ­¤è¡¨å•å°†æäº¤ç»™<code class="eh mb mc md me b">/`</code>ç™»å½•<code class="eh mb mc md me b">route which we defined earlier. Following our route definition, this request will be handled by the</code> AuthController <code class="eh mb mc md me b">and its</code>ç™»å½•`æ“ä½œæ–¹æ³•ã€‚</p><p id="d08e" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æˆ‘ä»¬å°†åˆ›å»º<code class="eh mb mc md me b">AuthController</code>ç±»ï¼Œå¹¶æ·»åŠ ç”¨äºå­˜å‚¨æˆ–æ£€ç´¢ç”¨æˆ·è¯¦ç»†ä¿¡æ¯çš„ä»£ç ã€‚å­˜å‚¨æˆ–æ£€ç´¢çš„é€‰é¡¹å°†åŸºäºç”¨æˆ·åæ˜¯å¦å·²ç»å­˜åœ¨äºæˆ‘ä»¬çš„<code class="eh mb mc md me b">Users</code>è¡¨ä¸­ã€‚<code class="eh mb mc md me b">AuthController</code>çš„ä»£ç å¦‚ä¸‹:</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="4eff" class="mj ky hu me b fv mk ml l mm mn">// File: AuthController</span><span id="6e98" class="mj ky hu me b fv mo ml l mm mn">    // ...<br/>    using HeyChat.Models;<br/>    public class AuthController : Controller<br/>    {<br/>        [HttpPost]<br/>        public ActionResult Login()<br/>        {<br/>            string user_name = Request.Form["username"];</span><span id="9377" class="mj ky hu me b fv mo ml l mm mn">            if (user_name.Trim() == "") {<br/>                return Redirect("/");<br/>            }</span><span id="5dde" class="mj ky hu me b fv mo ml l mm mn">            using (var db = new Models.ChatContext()) {</span><span id="e5c8" class="mj ky hu me b fv mo ml l mm mn">                User user = db.Users.FirstOrDefault(u =&gt; u.name == user_name);</span><span id="b99f" class="mj ky hu me b fv mo ml l mm mn">                if (user == null) {<br/>                    user = new User { name = user_name };</span><span id="5125" class="mj ky hu me b fv mo ml l mm mn">                    db.Users.Add(user);<br/>                    db.SaveChanges();<br/>                }</span><span id="3488" class="mj ky hu me b fv mo ml l mm mn">                Session["user"] = user;<br/>            }</span><span id="67fb" class="mj ky hu me b fv mo ml l mm mn">            return Redirect("/chat");<br/>        }<br/>    }</span></pre><p id="d257" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªåç§°æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå­˜åœ¨ï¼Œæˆ‘ä»¬æ£€ç´¢ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°è®°å½•ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯åˆ†é…åˆ°ä¸€ä¸ª<code class="eh mb mc md me b">session</code>å¯¹è±¡ä¸­ï¼Œä¾›æ•´ä¸ªåº”ç”¨ç¨‹åºä½¿ç”¨ã€‚æœ€åï¼Œæˆ‘ä»¬å°†ç”¨æˆ·é‡å®šå‘åˆ°èŠå¤©é¡µé¢ã€‚</p><h1 id="7639" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">å‘ˆç°èŠå¤©é¡µé¢</h1><p id="ff92" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf jt lx ji jj ju ly jm jn jv lz jq jr js hn dt translated">å¤§å¤šæ•°èŠå¤©åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªç‰¹ç‚¹æ˜¯èƒ½å¤Ÿé€‰æ‹©å’Œè°èŠå¤©ã€‚å‡ºäºæœ¬æ•™ç¨‹çš„ç›®çš„ï¼Œæˆ‘ä»¬å°†å‡è®¾æ‰€æœ‰æ³¨å†Œç”¨æˆ·å¯ä»¥äº’ç›¸èŠå¤©ï¼Œå› æ­¤æˆ‘ä»¬çš„èŠå¤©é¡µé¢å°†æä¾›ä¸å­˜å‚¨åœ¨æˆ‘ä»¬æ•°æ®åº“ä¸­çš„ä»»ä½•ç”¨æˆ·èŠå¤©çš„å¯èƒ½æ€§ã€‚</p><p id="aa0c" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">å‰é¢ï¼Œæˆ‘ä»¬å®šä¹‰äº†æˆ‘ä»¬çš„èŠå¤©è·¯çº¿ï¼Œå¹¶å°†å…¶åˆ†é…ç»™äº†<code class="eh mb mc md me b">ChatController</code>ç±»åŠå…¶<code class="eh mb mc md me b">Index</code>åŠ¨ä½œæ–¹æ³•ã€‚</p><p id="4228" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">è®©æˆ‘ä»¬åˆ›å»º<code class="eh mb mc md me b">ChatController</code>å¹¶å®ç°åŒ…å«å¯ç”¨è”ç³»äººçš„èŠå¤©é¡µé¢çš„å‘ˆç°ã€‚å°†ä¸‹é¢çš„ä»£ç ç²˜è´´åˆ°<code class="eh mb mc md me b">ChatController</code>ä¸­:</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="6aae" class="mj ky hu me b fv mk ml l mm mn">// File: ChatController</span><span id="859f" class="mj ky hu me b fv mo ml l mm mn">    // ...<br/>    using HeyChat.Models;</span><span id="13bf" class="mj ky hu me b fv mo ml l mm mn">    namespace HeyChat.Controllers<br/>    {<br/>        public class ChatController : Controller<br/>        {<br/>            public ActionResult Index()<br/>            {<br/>                if (Session["user"] == null) {<br/>                    return Redirect("/");<br/>                }</span><span id="7300" class="mj ky hu me b fv mo ml l mm mn">                var currentUser = (Models.User) Session["user"];</span><span id="8a8b" class="mj ky hu me b fv mo ml l mm mn">                using ( var db = new Models.ChatContext() ) {</span><span id="509f" class="mj ky hu me b fv mo ml l mm mn">                    ViewBag.allUsers = db.Users.Where(u =&gt; u.name != currentUser.name )<br/>                                     .ToList();<br/>                }<br/></span><span id="3a63" class="mj ky hu me b fv mo ml l mm mn">                ViewBag.currentUser = currentUser;<br/></span><span id="2771" class="mj ky hu me b fv mo ml l mm mn">                return View ();<br/>            }<br/>        }<br/>    }</span></pre><p id="9e6e" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ä¸ºäº†è·å¾—å¯ç”¨çš„è”ç³»äººï¼Œæˆ‘ä»¬è¯»å–æ•°æ®åº“ä¸­é™¤å½“å‰ç”¨æˆ·ä¹‹å¤–çš„æ‰€æœ‰ç”¨æˆ·ã€‚ä½¿ç”¨<code class="eh mb mc md me b">ViewBag</code>å°†è¿™äº›ç”¨æˆ·ä¼ é€’åˆ°æˆ‘ä»¬çš„å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬è¿˜ä½¿ç”¨<code class="eh mb mc md me b">ViewBag</code>ä¼ é€’å½“å‰ç”¨æˆ·ã€‚</p><p id="bab1" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å°†æ‰€æœ‰å¯ç”¨çš„è”ç³»äººæ£€ç´¢åˆ°äº†<code class="eh mb mc md me b">ViewBag</code>å¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºç”¨äºå‘ç”¨æˆ·æ˜¾ç¤ºè¿™äº›è”ç³»äººå’ŒèŠå¤©é¡µé¢å…¶ä½™éƒ¨åˆ†çš„æ ‡è®°ã€‚ä¸ºäº†åˆ›å»ºæˆ‘ä»¬èŠå¤©é¡µé¢çš„è§†å›¾æ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨<code class="eh mb mc md me b">Views</code>æ–‡ä»¶å¤¹ä¸­åˆ›å»ºäº†ä¸€ä¸ª<code class="eh mb mc md me b">Chat</code>æ–‡ä»¶å¤¹ã€‚</p><p id="ec76" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æ¥ä¸‹æ¥å³å‡»<code class="eh mb mc md me b">Chat</code>æ–‡ä»¶å¤¹ï¼Œé€‰æ‹©é€‰é¡¹<code class="eh mb mc md me b">Add</code> â†’ <code class="eh mb mc md me b">Views</code>ï¼Œé€‰æ‹©Razoræ¨¡æ¿å¼•æ“ï¼Œå‘½åæ–‡ä»¶<code class="eh mb mc md me b">index.cshtml</code>ã€‚å°†ä¸‹é¢çš„ä»£ç ç²˜è´´åˆ°æ–‡ä»¶ä¸­:</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="096b" class="mj ky hu me b fv mk ml l mm mn">&lt;!DOCTYPE html&gt;<br/>    &lt;html&gt;<br/>      &lt;head&gt;<br/>        &lt;title&gt;pChat &amp;mdash; Private Chatroom&lt;/title&gt;<br/>        &lt;link rel="stylesheet" href="@Url.Content("~/Content/app.css")"&gt;<br/>      &lt;/head&gt;<br/>      &lt;body&gt;<br/>        &lt;!-- Navigation Bar --&gt;<br/>        &lt;nav class="navbar navbar-inverse"&gt;<br/>          &lt;div class="container-fluid"&gt;<br/>            &lt;div class="navbar-header"&gt;<br/>              &lt;a class="navbar-brand" href="#"&gt;pChat - @ViewBag.currentUser.name &lt;/a&gt;<br/>            &lt;/div&gt;<br/>            &lt;ul class="nav navbar-nav navbar-right"&gt;<br/>              &lt;li&gt;&lt;a href="#"&gt;Log Out&lt;/a&gt;&lt;/li&gt;<br/>            &lt;/ul&gt;<br/>          &lt;/div&gt;<br/>        &lt;/nav&gt;<br/>        &lt;!-- / Navigation Bar --&gt;<br/>        &lt;div class="container"&gt;<br/>          &lt;div class="row"&gt;<br/>            &lt;div class="col-xs-12 col-md-3"&gt;<br/>              &lt;aside class="main visible-md visible-lg"&gt;<br/>                &lt;div class="row"&gt;<br/>                  &lt;div class="col-xs-12"&gt;<br/>                    &lt;div class="panel panel-default users__bar"&gt;<br/>                      &lt;div class="panel-heading users__heading"&gt;<br/>                        Contacts (@ViewBag.allUsers.Count)<br/>                      &lt;/div&gt;<br/>                      &lt;div class="__no__chat__"&gt;<br/>                          &lt;p&gt;Select a contact to chat with&lt;/p&gt;<br/>                      &lt;/div&gt;<br/>                      &lt;div class="panel-body users__body"&gt;<br/>                        &lt;ul id="contacts" class="list-group"&gt;</span><span id="ecf8" class="mj ky hu me b fv mo ml l mm mn">                        @foreach( var user in @ViewBag.allUsers ) {<br/>                            &lt;a class="user__item contact-@user.id" href="#" data-contact-id="@user.id" data-contact-name="@user.name"&gt;<br/>                                &lt;li&gt;<br/>                                  &lt;div class="avatar"&gt;<br/>                                     &lt;img src="@Url.Content("~/Content/no_avatar.png")"&gt;<br/>                                  &lt;/div&gt;<br/>                                  &lt;span&gt;@user.name&lt;/span&gt;<br/>                                  &lt;div class="status-bar"&gt;&lt;/div&gt;<br/>                                &lt;/li&gt;<br/>                            &lt;/a&gt;<br/>                        }<br/>                        &lt;/ul&gt;<br/>                      &lt;/div&gt;<br/>                    &lt;/div&gt;<br/>                  &lt;/div&gt;<br/>                &lt;/div&gt;<br/>              &lt;/aside&gt;<br/></span><span id="c4ff" class="mj ky hu me b fv mo ml l mm mn">            &lt;/div&gt;<br/>            &lt;div class="col-xs-12 col-md-9 chat__body"&gt;<br/>              &lt;div class="row"&gt;<br/>                &lt;div class="col-xs-12"&gt;<br/>                  &lt;ul class="list-group chat__main"&gt;</span><span id="7bc7" class="mj ky hu me b fv mo ml l mm mn">                  &lt;/ul&gt;<br/>                &lt;/div&gt;<br/>                &lt;div class="chat__type__body"&gt;<br/>                  &lt;div class="chat__type"&gt;<br/>                    &lt;textarea id="msg_box" placeholder="Type your message"&gt;&lt;/textarea&gt;<br/>                    &lt;button class="btn btn-primary" id="sendMessage"&gt;Send&lt;/button&gt;<br/>                  &lt;/div&gt;<br/>                &lt;/div&gt;<br/>                &lt;div class="chat__typing"&gt;<br/>                  &lt;span id="typerDisplay"&gt;&lt;/span&gt;<br/>                &lt;/div&gt;<br/>              &lt;/div&gt;<br/>            &lt;/div&gt;<br/>          &lt;/div&gt;<br/>        &lt;/div&gt;<br/>        &lt;script src="@Url.Content("~/Content/app.js")"&gt;&lt;/script&gt;<br/>      &lt;/body&gt;<br/>    &lt;/html&gt;</span></pre><blockquote class="ir is it"><p id="9e14" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><em class="hu">ğŸ’¡</em><a class="ae kf" href="mailto:`@Url.Content" rel="noopener ugc nofollow" target="_blank"><em class="hu">` @ç½‘å€ã€‚å†…å®¹</em></a><em class="hu">(" ~/Content/app . CSS ")</em><code class="eh mb mc md me b"><em class="hu">and</em></code><em class="hu">@ Urlã€‚Content(" ~/Content/app . js ")</em><code class="eh mb mc md me b"><em class="hu">load some previously bundled JavaScript and CSS dependencies such as jQuery and Bootstrap from our</em></code><em class="hu">Content `æ–‡ä»¶å¤¹ã€‚</em></p></blockquote><p id="910a" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">åœ¨æˆ‘ä»¬çš„è§†å›¾æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªä¾§è¾¹æ ï¼Œå¹¶éå†ä¼ é€’ç»™<code class="eh mb mc md me b">ViewBag</code>çš„ç”¨æˆ·ï¼Œä½¿ç”¨Razorçš„<code class="eh mb mc md me b">@foreach</code>æŒ‡ä»¤æ¥æŒ‡ç¤ºå¯ç”¨çš„è”ç³»äººã€‚æˆ‘ä»¬è¿˜æ·»åŠ äº†ä¸€ä¸ªæ–‡æœ¬åŒºåŸŸæ¥è¾“å…¥å’Œå‘é€æ¶ˆæ¯ç»™è¿™äº›è”ç³»äººã€‚</p><h1 id="58a6" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">é€‰æ‹©è”ç³»äººå’Œå‘é€ä¿¡æ¯</h1><p id="515f" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf jt lx ji jj ju ly jm jn jv lz jq jr js hn dt translated">å½“æˆ‘ä»¬çš„ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªè”ç³»äººè¿›è¡ŒèŠå¤©æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›æ£€ç´¢ç”¨æˆ·å’Œæ‰€é€‰è”ç³»äººä¹‹é—´ä»¥å‰çš„æ¶ˆæ¯ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç”¨äºå­˜å‚¨ç”¨æˆ·é—´æ¶ˆæ¯çš„è¡¨å’Œè¿™ä¸ªè¡¨çš„æ¨¡å‹ã€‚</p><p id="4e93" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">è®©æˆ‘ä»¬åœ¨<code class="eh mb mc md me b">Models</code>æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º<code class="eh mb mc md me b">Conversations</code>çš„æ¨¡å‹ã€‚å®ƒå°†ç”±å”¯ä¸€çš„<code class="eh mb mc md me b">id</code>ã€<code class="eh mb mc md me b">sender_id</code>ã€<code class="eh mb mc md me b">receiver_id</code>ã€<code class="eh mb mc md me b">message</code>ã€<code class="eh mb mc md me b">status</code>å’Œ<code class="eh mb mc md me b">created_at</code>æ—¥æœŸç»„æˆã€‚è¯¥æ¨¡å‹çš„ä»£ç å¦‚ä¸‹:</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="7a55" class="mj ky hu me b fv mk ml l mm mn">// File: Conversation.cs</span><span id="230a" class="mj ky hu me b fv mo ml l mm mn">    using System;<br/>    namespace HeyChat.Models<br/>    {<br/>        public class Conversation<br/>        {<br/>            public Conversation()<br/>            {<br/>                status = messageStatus.Sent;<br/>            }</span><span id="7b2f" class="mj ky hu me b fv mo ml l mm mn">            public enum messageStatus<br/>            {<br/>                Sent, <br/>                Delivered<br/>            }</span><span id="dfc7" class="mj ky hu me b fv mo ml l mm mn">            public int id { get; set; }<br/>            public int sender_id { get; set; }<br/>            public int receiver_id { get; set; }<br/>            public string message { get; set; }<br/>            public messageStatus status { get; set; }<br/>            public DateTime created_at { get; set; }<br/>        }<br/>    }</span></pre><p id="319b" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">åˆ›å»ºå®Œ<code class="eh mb mc md me b">Conversation</code>æ¨¡å‹åï¼Œæˆ‘ä»¬å°†æŠŠå®ƒæ·»åŠ åˆ°<code class="eh mb mc md me b">ChatContext</code>æ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="8717" class="mj ky hu me b fv mk ml l mm mn">// File: ChatContext.cs<br/>    using System;<br/>    using System.Data.Entity;</span><span id="0c50" class="mj ky hu me b fv mo ml l mm mn">    namespace HeyChat.Models<br/>    {<br/>        public class ChatContext: DbContext<br/>        {<br/>            public ChatContext() : base("MySqlConnection")<br/>            {<br/>            }</span><span id="d511" class="mj ky hu me b fv mo ml l mm mn">            public static ChatContext Create()<br/>            {<br/>                return new ChatContext();<br/>            }</span><span id="0f65" class="mj ky hu me b fv mo ml l mm mn">            public DbSet&lt;User&gt; Users { get; set; }<br/>            public DbSet&lt;Conversation&gt; Conversations { get; set; }<br/>        }<br/>    }</span></pre><p id="44cd" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ä¸ºäº†æ£€ç´¢è¿™äº›æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°†ä¸º<code class="eh mb mc md me b">/contact`</code> /conversations/{contact} `åˆ›å»ºä¸€æ¡è·¯ç”±ã€‚è¯¥è·¯ç”±å°†æ¥å—è”ç³»äººIDï¼Œæ£€ç´¢å½“å‰ç”¨æˆ·å’Œè”ç³»äººä¹‹é—´çš„æ¶ˆæ¯ï¼Œç„¶ååœ¨JSONå“åº”ä¸­è¿”å›æ¶ˆæ¯ã€‚</p><p id="4ea8" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ç”±<code class="eh mb mc md me b">ConversationWithContact</code>åŠ¨ä½œæ–¹æ³•ä¸­çš„<code class="eh mb mc md me b">ChatController</code>å¤„ç†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="2840" class="mj ky hu me b fv mk ml l mm mn">//ChatController.cs</span><span id="82de" class="mj ky hu me b fv mo ml l mm mn">    ...<br/>    public JsonResult ConversationWithContact(int contact)<br/>    {<br/>        if (Session["user"] == null)<br/>        {<br/>            return Json(new { status = "error", message = "User is not logged in" });<br/>        }</span><span id="8382" class="mj ky hu me b fv mo ml l mm mn">        var currentUser = (Models.User)Session["user"];</span><span id="e8ab" class="mj ky hu me b fv mo ml l mm mn">        var conversations = new List&lt;Models.Conversation&gt;();</span><span id="1109" class="mj ky hu me b fv mo ml l mm mn">        using (var db = new Models.ChatContext())<br/>        {<br/>            conversations = db.Conversations.<br/>                              Where(c =&gt; (c.receiver_id == currentUser.id <br/>                                  &amp;&amp; c.sender_id == contact) || <br/>                                  (c.receiver_id == contact <br/>                                  &amp;&amp; c.sender_id == currentUser.id))<br/>                              .OrderBy(c =&gt; c.created_at)<br/>                              .ToList();<br/>        }</span><span id="acc0" class="mj ky hu me b fv mo ml l mm mn">        return Json(<br/>            new { status = "success", data = conversations }, <br/>            JsonRequestBehavior.AllowGet<br/>        );<br/>    }</span></pre><p id="c868" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ç°åœ¨æˆ‘ä»¬æœ‰äº†æ£€ç´¢æ—§æ¶ˆæ¯çš„è·¯å¾„ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€äº›jQueryæ¥é€‰æ‹©ç”¨æˆ·ã€è·å–æ¶ˆæ¯å¹¶åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå®ƒä»¬ã€‚åœ¨æˆ‘ä»¬çš„è§†å›¾æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª<code class="eh mb mc md me b">script</code>æ ‡ç­¾æ¥ä¿å­˜JavaScriptå’ŒjQueryå‡½æ•°ã€‚åœ¨å…¶ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ :</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="bfb1" class="mj ky hu me b fv mk ml l mm mn">...<br/>    &lt;script&gt;<br/>    let currentContact = null; // Holds current contact<br/>    let newMessageTpl = <br/>    `&lt;div&gt;<br/>        &lt;div id="msg-{{id}}" class="row __chat__par__"&gt;<br/>          &lt;div class="__chat__"&gt;<br/>            &lt;p&gt;{{body}}&lt;/p&gt;<br/>            &lt;p class="delivery-status"&gt;Delivered&lt;/p&gt;<br/>          &lt;/div&gt;<br/>        &lt;/div&gt;<br/>     &lt;/div&gt;`;<br/>    ...<br/>    // select contact to chat with<br/>    $('.user__item').click( function(e) {<br/>        e.preventDefault();</span><span id="ad21" class="mj ky hu me b fv mo ml l mm mn">        currentContact = {<br/>            id: $(this).data('contact-id'),<br/>            name: $(this).data('contact-name'),<br/>        };</span><span id="c78b" class="mj ky hu me b fv mo ml l mm mn">        $('#contacts').find('li').removeClass('active');</span><span id="2336" class="mj ky hu me b fv mo ml l mm mn">        $('#contacts .contact-' + currentContact.id).find('li').addClass('active');<br/>        getChat(currentContact.id);<br/>    });</span><span id="69c5" class="mj ky hu me b fv mo ml l mm mn">    // get chat data        <br/>    function getChat( contact_id ) {<br/>        $.get("/contact/conversations/" + contact_id )<br/>         .done( function(resp) {         <br/>            var chat_data = resp.data || [];<br/>            loadChat( chat_data );         <br/>         });<br/>    }</span><span id="1806" class="mj ky hu me b fv mo ml l mm mn">    //load chat data into view<br/>    function loadChat( chat_data ) {</span><span id="5b41" class="mj ky hu me b fv mo ml l mm mn">        chat_data.forEach( function(data) {<br/>            displayMessage(data);<br/>        });</span><span id="f412" class="mj ky hu me b fv mo ml l mm mn">        $('.chat__body').show();<br/>        $('.__no__chat__').hide();<br/>    }</span><span id="50f3" class="mj ky hu me b fv mo ml l mm mn">    function displayMessage( message_obj ) {<br/>        const msg_id = message_obj.id;<br/>        const msg_body = message_obj.message;</span><span id="9b03" class="mj ky hu me b fv mo ml l mm mn">        let template = $(newMessageTpl).html();</span><span id="55ce" class="mj ky hu me b fv mo ml l mm mn">        template = template.replace("{{id}}", msg_id);<br/>        template = template.replace("{{body}}", msg_body);</span><span id="419c" class="mj ky hu me b fv mo ml l mm mn">        template = $(template);</span><span id="f7ee" class="mj ky hu me b fv mo ml l mm mn">        if ( message_obj.sender_id == @ViewBag.currentUser.id ) {<br/>            template.find('.__chat__').addClass('from__chat');<br/>        } else {<br/>            template.find('.__chat__').addClass('receive__chat');<br/>        }</span><span id="ad97" class="mj ky hu me b fv mo ml l mm mn">        if ( message_obj.status == 1 ) {<br/>            template.find('.delivery-status').show();<br/>        }</span><span id="5695" class="mj ky hu me b fv mo ml l mm mn">        $('.chat__main').append(template);<br/>    }</span></pre><p id="548c" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æ—¢ç„¶é€‰æ‹©ä¸€ä¸ªè”ç³»äººå¯ä»¥æ£€ç´¢ä»¥å‰çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬éœ€è¦ç”¨æˆ·èƒ½å¤Ÿå‘é€æ–°æ¶ˆæ¯ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè·¯ç”±ï¼Œè¯¥è·¯ç”±æ¥å—æ­£åœ¨å‘é€çš„æ¶ˆæ¯å¹¶å°†å…¶ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œç„¶åä½¿ç”¨ä¸€äº›jQueryä»<code class="eh mb mc md me b">textarea</code>å­—æ®µä¸­è¯»å–æ¶ˆæ¯æ–‡æœ¬å¹¶å‘é€åˆ°è¯¥è·¯ç”±ã€‚</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="08be" class="mj ky hu me b fv mk ml l mm mn">//RouteConfig.cs</span><span id="c513" class="mj ky hu me b fv mo ml l mm mn">    ...<br/>    routes.MapRoute(<br/>        name: "SendMessage",<br/>        url: "send_message",<br/>        defaults: new { controller = "Chat", action = "SendMessage" }<br/>    );</span></pre><p id="d678" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æ ¹æ®<code class="eh mb mc md me b">RouteConfig</code>æ–‡ä»¶è§„å®šï¼Œè¯¥è·¯çº¿å°†ç”±<code class="eh mb mc md me b">ChatController</code>çš„<code class="eh mb mc md me b">SendMessage</code>åŠ¨ä½œæ–¹å¼å¤„ç†ã€‚</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="ffb8" class="mj ky hu me b fv mk ml l mm mn">//ChatController.cs</span><span id="cdf3" class="mj ky hu me b fv mo ml l mm mn">    ...<br/>    [HttpPost]<br/>    public JsonResult SendMessage() <br/>    {<br/>        if (Session["user"] == null)<br/>        {<br/>            return Json(new { status = "error", message = "User is not logged in" });<br/>        }</span><span id="aeda" class="mj ky hu me b fv mo ml l mm mn">        var currentUser = (User)Session["user"];</span><span id="c18b" class="mj ky hu me b fv mo ml l mm mn">        string socket_id = Request.Form["socket_id"];</span><span id="73e0" class="mj ky hu me b fv mo ml l mm mn">        Conversation convo = new Conversation<br/>        {<br/>            sender_id = currentUser.id,<br/>            message = Request.Form["message"],<br/>            receiver_id = Convert.ToInt32(Request.Form["contact"])<br/>        };</span><span id="3a47" class="mj ky hu me b fv mo ml l mm mn">        using ( var db = new Models.ChatContext() ) {<br/>            db.Conversations.Add(convo);<br/>            db.SaveChanges();<br/>        }</span><span id="244a" class="mj ky hu me b fv mo ml l mm mn">        return Json(convo);<br/>    }</span></pre><h1 id="c870" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">æ·»åŠ å®æ—¶åŠŸèƒ½</h1><p id="da1f" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf jt lx ji jj ju ly jm jn jv lz jq jr js hn dt translated">èŠå¤©åº”ç”¨ç¨‹åºæœ‰å‡ ä¸ªéœ€è¦å®æ—¶åŠŸèƒ½çš„ç‰¹æ€§ï¼Œå…¶ä¸­åŒ…æ‹¬:</p><ul class=""><li id="67bf" class="jw jx hu ix b iy iz jc jd jt jy ju jz jv ka js kb kc kd ke dt translated">æ¥æ”¶å®æ—¶å‘é€çš„æ¶ˆæ¯ã€‚</li><li id="e9fc" class="jw jx hu ix b iy kg jc kh jt ki ju kj jv kk js kb kc kd ke dt translated">æ”¶åˆ°å³å°†å“åº”çš„é€šçŸ¥â€”â€”â€œç”¨æˆ·æ­£åœ¨è¾“å…¥â€åŠŸèƒ½ã€‚</li><li id="beba" class="jw jx hu ix b iy kg jc kh jt ki ju kj jv kk js kb kc kd ke dt translated">æ­£åœ¨è·å–é‚®ä»¶ä¼ é€’çŠ¶æ€ã€‚</li><li id="e5ac" class="jw jx hu ix b iy kg jc kh jt ki ju kj jv kk js kb kc kd ke dt translated">è”ç³»äººç¦»çº¿æˆ–åœ¨çº¿æ—¶çš„å³æ—¶é€šçŸ¥ã€‚</li></ul><p id="5958" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ä¸ºäº†å®ç°è¿™äº›åŠŸèƒ½ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a class="ae kf" href="http://pusher.com" rel="noopener ugc nofollow" target="_blank">æ¨æ†</a>ã€‚è¦ç»§ç»­ï¼Œè®©æˆ‘ä»¬å‰å¾€æ¨åŠ¨å™¨<a class="ae kf" href="https://dashboard.pusher.com/" rel="noopener ugc nofollow" target="_blank">ä»ªè¡¨æ¿</a>å¹¶åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚å¦‚æœä½ æ²¡æœ‰å¸å·ï¼Œä½ å¯ä»¥å…è´¹æ³¨å†Œã€‚ç”¨è¦æ±‚çš„ä¿¡æ¯å¡«å†™åˆ›å»ºåº”ç”¨ç¨‹åºè¡¨å•ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨NuGetåœ¨C#ä»£ç ä¸­å®‰è£…<strong class="ix hv"> Pusher Server </strong>åŒ…ã€‚</p><p id="b5a7" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ä¸ºäº†å®ç°æˆ‘ä»¬æ‰€è¯´çš„ä¸€äº›å®æ—¶ç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿåœ¨å®¢æˆ·ç«¯è§¦å‘äº‹ä»¶ã€‚ä¸ºäº†åœ¨è¿™ä¸ªåº”ç”¨ç¨‹åºä¸­è§¦å‘å®¢æˆ·ç«¯äº‹ä»¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç§æœ‰é€šé“ã€‚</p><p id="6286" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">å½“è”ç³»äººè¢«é€‰ä¸­æ—¶ï¼Œæˆ‘ä»¬å°†åˆ›å»ºæˆ‘ä»¬çš„ç§äººé¢‘é“ã€‚è¯¥é€šé“å°†ç”¨äºåœ¨ç™»å½•ç”¨æˆ·å’Œä»–æ­£åœ¨å‘é€æ¶ˆæ¯çš„è”ç³»äººä¹‹é—´ä¼ è¾“æ¶ˆæ¯ã€‚</p><p id="dc3c" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ç§æœ‰é€šé“éœ€è¦æ¥è‡ªæœåŠ¡å™¨ç«¯ä»£ç çš„è®¤è¯ç«¯ç‚¹å¯ç”¨ï¼Œå› ä¸ºå½“é€šé“è¢«å®ä¾‹åŒ–æ—¶ï¼Œæ¨é€å™¨å°†å°è¯•è®¤è¯å®¢æˆ·ç«¯å¯¹é€šé“çš„æœ‰æ•ˆè®¿é—®ã€‚</p><p id="0fff" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">Pusherè®¤è¯è¯·æ±‚çš„é»˜è®¤è·¯ç”±æ˜¯<code class="eh mb mc md me b">/pusher/auth</code>ï¼Œå› æ­¤æˆ‘ä»¬å°†åˆ›å»ºè¯¥è·¯ç”±å¹¶å®æ–½è®¤è¯ã€‚</p><p id="2be6" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">é¦–å…ˆï¼Œåœ¨æˆ‘ä»¬çš„<code class="eh mb mc md me b">RouteConfig.cs</code>æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ è·¯çº¿å®šä¹‰:</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="3767" class="mj ky hu me b fv mk ml l mm mn">routes.MapRoute(<br/>        name: "PusherAuth",<br/>        url:  "pusher/auth",<br/>        defaults: new { controller = "Auth", action = "AuthForChannel"}<br/>    );</span></pre><p id="8a3f" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ç„¶åï¼Œæ­£å¦‚æˆ‘ä»¬ä¸Šé¢æ‰€å®šä¹‰çš„ï¼Œåœ¨<code class="eh mb mc md me b">AuthController</code>ç±»æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»º<code class="eh mb mc md me b">AuthForChannel</code>åŠ¨ä½œæ–¹æ³•å¹¶æ·»åŠ :</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="45de" class="mj ky hu me b fv mk ml l mm mn">public JsonResult AuthForChannel(string channel_name, string socket_id)<br/>    {<br/>        if (Session["user"] == null)<br/>        {<br/>            return Json(new { status = "error", message = "User is not logged in" });<br/>        }<br/>        var currentUser = (Models.User)Session["user"];</span><span id="6907" class="mj ky hu me b fv mo ml l mm mn">        var options = new PusherOptions();<br/>        options.Cluster = "PUSHER_APP_CLUSTER";</span><span id="8441" class="mj ky hu me b fv mo ml l mm mn">        var pusher = new Pusher(<br/>        "PUSHER_APP_ID",<br/>        "PUSHER_APP_KEY",<br/>        "PUSHER_APP_SECRET", options);</span><span id="ca5f" class="mj ky hu me b fv mo ml l mm mn">        if (channel_name.IndexOf(currentUser.id.ToString()) == -1)<br/>        {<br/>            return Json(<br/>              new { status = "error", message = "User cannot join channel" }<br/>            );<br/>        }</span><span id="bfad" class="mj ky hu me b fv mo ml l mm mn">        var auth = pusher.Authenticate(channel_name, socket_id);</span><span id="ca52" class="mj ky hu me b fv mo ml l mm mn">        return Json(auth);<br/>    }</span></pre><p id="d355" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æˆ‘ä»¬çš„èº«ä»½éªŒè¯ç«¯ç‚¹ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œæ¥å—å®¢æˆ·æœºçš„é€šé“åå’Œå¥—æ¥å­—IDï¼Œå®ƒä»¬æ˜¯ç”±Pusheråœ¨è¿æ¥å°è¯•æ—¶å‘é€çš„ã€‚</p><blockquote class="ir is it"><p id="172e" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><em class="hu">ğŸ’¡æˆ‘ä»¬å°†ä½¿ç”¨å¯¹è¯å‚ä¸è€…(å³å‘é€è€…å’Œæ¥æ”¶è€…)çš„idæ¥å‘½åæˆ‘ä»¬çš„ç§æœ‰é€šé“ã€‚æˆ‘ä»¬å°†ç”¨å®ƒæ¥é™åˆ¶æ¶ˆæ¯å‘ä¸åœ¨ç‰¹å®šå¯¹è¯ä¸­çš„Messengeråº”ç”¨ç¨‹åºçš„å…¶ä»–ç”¨æˆ·ä¼ æ’­ã€‚</em></p></blockquote><p id="4817" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ä½¿ç”¨ã€‚NETåº“ï¼Œæˆ‘ä»¬é€šè¿‡ä¼ é€’é€šé“åå’Œå¥—æ¥å­—IDæ¥éªŒè¯ç”¨æˆ·ã€‚ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡JSONè¿”å›èº«ä»½éªŒè¯çš„ç»“æœå¯¹è±¡ã€‚</p><p id="8f18" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æœ‰å…³å®¢æˆ·æ´»åŠ¨å’Œç§äººæ¸ é“çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ¨æ‰‹<a class="ae kf" href="https://pusher.com/docs/client_api_guide/client_presence_channels" rel="noopener ugc nofollow" target="_blank">æ–‡æ¡£</a>ã€‚</p><blockquote class="ir is it"><p id="ab15" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><em class="hu">ğŸ’¡å®¢æˆ·ç«¯äº‹ä»¶åªèƒ½ç”±ç§æœ‰é€šé“æˆ–å­˜åœ¨é€šé“è§¦å‘ã€‚</em></p></blockquote><p id="d1da" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">åœ¨è§†å›¾çš„è„šæœ¬éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å®ä¾‹åŒ–ç§æœ‰é€šé“çš„å˜é‡ã€‚æˆ‘ä»¬è¿˜å°†è°ƒæ•´æˆ‘ä»¬çš„è”ç³»äººé€‰æ‹©ç‰‡æ®µï¼Œä»¥åˆ›å»ºå‘é€æ¶ˆæ¯ã€è¾“å…¥å’Œå‘é€é€šçŸ¥çš„æ¸ é“:</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="d7fa" class="mj ky hu me b fv mk ml l mm mn">...<br/>    &lt;script&gt;<br/>    ...</span><span id="2395" class="mj ky hu me b fv mo ml l mm mn">    let currentContact = null; // Holds contact currently being chatted with<br/>    let socketId = null;<br/>    let currentconversationChannel = null;<br/>    let conversationChannelName = null;</span><span id="d81a" class="mj ky hu me b fv mo ml l mm mn">    //Pusher client side setup<br/>    const pusher = new Pusher('PUSHER_APP_ID', {<br/>        cluster:'PUSHER_APP_CLUSTER'<br/>    });</span><span id="a699" class="mj ky hu me b fv mo ml l mm mn">    pusher.connection.bind('connected', function() {<br/>      socketId = pusher.connection.socket_id;<br/>    });</span><span id="9995" class="mj ky hu me b fv mo ml l mm mn">    // select contact to chat with<br/>    $('.user__item').click( function(e) {<br/>        e.preventDefault();</span><span id="d46d" class="mj ky hu me b fv mo ml l mm mn">        currentContact = {<br/>            id: $(this).data('contact-id'),<br/>            name: $(this).data('contact-name'),<br/>        };</span><span id="b3e4" class="mj ky hu me b fv mo ml l mm mn">        if ( conversationChannelName ) {<br/>            pusher.unsubscribe( conversationChannelName );<br/>        }</span><span id="1b50" class="mj ky hu me b fv mo ml l mm mn">        conversationChannelName = getConvoChannel( <br/>                                      (@ViewBag.currentUser.id * 1) ,  <br/>                                      (currentContact.id * 1) <br/>                                  );</span><span id="adf8" class="mj ky hu me b fv mo ml l mm mn">        currentconversationChannel = pusher.subscribe(conversationChannelName);</span><span id="b966" class="mj ky hu me b fv mo ml l mm mn">        bind_client_events();</span><span id="e0f3" class="mj ky hu me b fv mo ml l mm mn">        $('#contacts').find('li').removeClass('active');</span><span id="fad2" class="mj ky hu me b fv mo ml l mm mn">        $('#contacts .contact-' + currentContact.id).find('li').addClass('active');<br/>        getChat(currentContact.id);<br/>    });</span><span id="102a" class="mj ky hu me b fv mo ml l mm mn">    function getConvoChannel(user_id, contact_id) {<br/>        if ( user_id &gt; contact_id ) {<br/>            return 'private-chat-' + contact_id + '-' + user_id;<br/>        }</span><span id="b26b" class="mj ky hu me b fv mo ml l mm mn">        return 'private-chat-' + user_id + '-' + contact_id;<br/>    }</span><span id="b22c" class="mj ky hu me b fv mo ml l mm mn">    function bind_client_events(){<br/>      //bind private channel events here  </span><span id="c790" class="mj ky hu me b fv mo ml l mm mn">      currentconversationChannel.bind("new_message", function(msg) {<br/>          //add code here<br/>      });</span><span id="e5a3" class="mj ky hu me b fv mo ml l mm mn">      currentconversationChannel.bind("message_delivered", function(msg) {<br/>          $('#msg-' + msg.id).find('.delivery-status').show();<br/>      });<br/>    }</span></pre><p id="c4d1" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">æˆ‘ä»¬è¿˜å°†ç”¨äºè¿æ¥é€šé“çš„<code class="eh mb mc md me b">socket_id</code>ä¿å­˜åœ¨ä¸€ä¸ªå˜é‡ä¸­ã€‚è¿™ä¸ªä»¥åä¼šæ´¾ä¸Šç”¨åœºçš„ã€‚</p><h2 id="c8ac" class="mj ky hu bd kz mp mq mr ld ms mt mu lh jt mv mw ll ju mx my lp jv mz na lt nb dt translated">æ¥æ”¶å®æ—¶å‘é€çš„æ¶ˆæ¯</h2><p id="4591" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf jt lx ji jj ju ly jm jn jv lz jq jr js hn dt translated">ä¹‹å‰ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªè·¯ç”±æ¥ä¿å­˜ä½œä¸ºç”¨æˆ·å’Œè”ç³»äººä¹‹é—´çš„å¯¹è¯å‘é€çš„æ¶ˆæ¯ã€‚</p><p id="b899" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ä½†æ˜¯ï¼Œåœ¨ä¿å­˜è¿™äº›æ¶ˆæ¯åï¼Œæˆ‘ä»¬å¸Œæœ›å°†è¿™äº›æ¶ˆæ¯æ·»åŠ åˆ°ç”¨æˆ·å’Œè”ç³»äººçš„å±å¹•ä¸Šã€‚</p><p id="f385" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œåœ¨æˆ‘ä»¬çš„C#ä»£ç ä¸­ï¼Œåœ¨å­˜å‚¨æ¶ˆæ¯åï¼Œæˆ‘ä»¬å°†é€šè¿‡Pusherç§æœ‰é€šé“è§¦å‘ä¸€ä¸ªäº‹ä»¶ã€‚ç„¶åï¼Œæˆ‘ä»¬çš„å®¢æˆ·å°†ç›‘å¬è¿™äº›äº‹ä»¶ï¼Œå¹¶é€šè¿‡å°†å®ƒä»¬æºå¸¦çš„æ¶ˆæ¯æ·»åŠ åˆ°å±å¹•ä¸Šæ¥å“åº”å®ƒä»¬ã€‚</p><p id="245f" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">åœ¨æˆ‘ä»¬çš„<code class="eh mb mc md me b">ChatController</code>ç±»æ–‡ä»¶ä¸­ï¼Œä¿å­˜å¯¹è¯åæˆ‘ä»¬å°†æ·»åŠ ä»¥ä¸‹å†…å®¹:</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="93db" class="mj ky hu me b fv mk ml l mm mn">private Pusher pusher;</span><span id="700d" class="mj ky hu me b fv mo ml l mm mn">    //class constructor<br/>    public ChatController() <br/>    {<br/>        var options = new PusherOptions();<br/>        options.Cluster = "PUSHER_APP_CLUSTER";</span><span id="0125" class="mj ky hu me b fv mo ml l mm mn">        pusher = new Pusher(<br/>           "PUSHER_APP_ID",<br/>           "PUSHER_APP_KEY",<br/>           "PUSHER_APP_SECRET",<br/>           options<br/>       );<br/>    }</span><span id="4ed2" class="mj ky hu me b fv mo ml l mm mn">    [HttpPost]<br/>    public JsonResult SendMessage() <br/>    {<br/>        if (Session["user"] == null)<br/>        {<br/>            return Json(new { status = "error", message = "User is not logged in" });<br/>        }</span><span id="9ff0" class="mj ky hu me b fv mo ml l mm mn">        var currentUser = (User)Session["user"];</span><span id="66fb" class="mj ky hu me b fv mo ml l mm mn">        string socket_id = Request.Form["socket_id"];</span><span id="fd25" class="mj ky hu me b fv mo ml l mm mn">        Conversation convo = new Conversation<br/>        {<br/>            sender_id = currentUser.id,<br/>            message = Request.Form["message"],<br/>            receiver_id = Convert.ToInt32(Request.Form["contact"])<br/>        };</span><span id="f478" class="mj ky hu me b fv mo ml l mm mn">        using ( var db = new Models.ChatContext() ) {<br/>            db.Conversations.Add(convo);<br/>            db.SaveChanges();<br/>        }</span><span id="1141" class="mj ky hu me b fv mo ml l mm mn">        var conversationChannel = getConvoChannel( currentUser.id, contact);</span><span id="d416" class="mj ky hu me b fv mo ml l mm mn">        pusher.TriggerAsync(<br/>          conversationChannel,<br/>          "new_message",<br/>          convo,<br/>          new TriggerOptions() { SocketId = socket_id });</span><span id="0d3a" class="mj ky hu me b fv mo ml l mm mn">        return Json(convo);<br/>    }</span><span id="4a70" class="mj ky hu me b fv mo ml l mm mn">    private String getConvoChannel(int user_id, int contact_id)<br/>    {<br/>        if (user_id &gt; contact_id)<br/>        {<br/>            return "private-chat-" + contact_id + "-" + user_id;<br/>        }</span><span id="2cc6" class="mj ky hu me b fv mo ml l mm mn">        return "private-chat-" + user_id + "-" + contact_id;<br/>    }</span></pre><p id="9746" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">ä¸ºäº†åˆ©ç”¨PusheræœåŠ¡å™¨ç«¯åŠŸèƒ½ï¼Œæˆ‘ä»¬å°†æŠŠ<code class="eh mb mc md me b">using PusherServer;</code>æ·»åŠ åˆ°æ§åˆ¶å™¨æ–‡ä»¶çš„é¡¶éƒ¨ã€‚</p><blockquote class="ir is it"><p id="f7ac" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><em class="hu">ğŸ’¡æˆ‘ä»¬åœ¨å‘é€æ¶ˆæ¯æ—¶æ¥å—äº†ç”¨æˆ·çš„</em> <code class="eh mb mc md me b"><em class="hu">socket_id</em></code> <em class="hu">ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šå‘é€è€…å¯ä»¥å…äºæ”¶å¬ä»–ä»¬å¹¿æ’­çš„äº‹ä»¶ã€‚</em></p></blockquote><p id="e9d9" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">åœ¨æˆ‘ä»¬çœ‹æ¥ï¼Œæˆ‘ä»¬å°†ç›‘å¬<code class="eh mb mc md me b">new_message</code>äº‹ä»¶ï¼Œå¹¶ä½¿ç”¨å®ƒå‘æˆ‘ä»¬çš„è§†å›¾æ·»åŠ æ–°æ¶ˆæ¯ã€‚</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="9f3e" class="mj ky hu me b fv mk ml l mm mn">//index.cshtml</span><span id="4a77" class="mj ky hu me b fv mo ml l mm mn">    ...<br/>    &lt;script&gt;<br/>    ...<br/>    //Send button's click event<br/>    $('#sendMessage').click( function() {<br/>        $.post("/send_message", {<br/>            message: $('#msg_box').val(),<br/>            contact: currentContact.id,<br/>            socket_id: socketId,<br/>        }).done( function (data) {<br/>            //display the message immediately on the view of the sender<br/>            displayMessage(data); <br/>            $('#msg_box').val('');<br/>        });<br/>    });</span><span id="7e0b" class="mj ky hu me b fv mo ml l mm mn">    function bind_client_events(){<br/>        //listening to the message_sent event by the message's recipient<br/>        currentconversationChannel.bind("new_message", function(msg) {<br/>                if ( msg.receiver_id == @ViewBag.currentUser.id ) {<br/>                    displayMessage(msg);<br/>                }<br/>        });<br/>    }</span></pre><h2 id="124b" class="mj ky hu bd kz mp mq mr ld ms mt mu lh jt mv mw ll ju mx my lp jv mz na lt nb dt translated">å®ç°æ‰“å­—æŒ‡ç¤ºå™¨åŠŸèƒ½</h2><p id="40c4" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf jt lx ji jj ju ly jm jn jv lz jq jr js hn dt translated">æ­¤åŠŸèƒ½ä½¿ç”¨æˆ·æ„è¯†åˆ°å¯¹è¯æ˜¯æ´»åŠ¨çš„ï¼Œå¹¶ä¸”æ­£åœ¨é”®å…¥å“åº”ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†ç›‘å¬æ¶ˆæ¯æ–‡æœ¬åŒºåŸŸçš„<code class="eh mb mc md me b">keyup</code>äº‹ä»¶ï¼Œå½“è¿™ä¸ª<code class="eh mb mc md me b">keyup</code>äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬å°†è§¦å‘ä¸€ä¸ªåä¸º<code class="eh mb mc md me b">client-is-typing</code>çš„å®¢æˆ·ç«¯äº‹ä»¶ã€‚</p><pre class="km kn ko kp fq mf me mg mh aw mi dt"><span id="02ba" class="mj ky hu me b fv mk ml l mm mn">// index.cshtml</span><span id="af22" class="mj ky hu me b fv mo ml l mm mn">    function bind_client_events(){<br/>        currentconversationChannel.bind("client-is-typing", function(data) {<br/>            if ( data.user_id == currentContact.id &amp;&amp; <br/>                 data.contact_id == @ViewBag.currentUser.id  ) {</span><span id="1724" class="mj ky hu me b fv mo ml l mm mn">                $('#typerDisplay').text( currentContact.name + ' is typing...');</span><span id="5612" class="mj ky hu me b fv mo ml l mm mn">                $('.chat__typing').fadeIn(100, function() {<br/>                    $('.chat__type__body').addClass('typing_display__open');<br/>                }).delay(1000).fadeOut(300, function(){<br/>                    $('.chat__type__body').removeClass('typing_display__open');<br/>                });<br/>            }<br/>        });</span><span id="f1ef" class="mj ky hu me b fv mo ml l mm mn">        ...<br/>    }</span><span id="9c15" class="mj ky hu me b fv mo ml l mm mn">    //User is typing<br/>    var isTypingCallback = function() {<br/>        chatChannel.trigger("client-is-typing", {<br/>            user_id: @ViewBag.currentUser.id,<br/>            contact_id: currentContact.id,<br/>        });<br/>    };</span><span id="dec0" class="mj ky hu me b fv mo ml l mm mn">    $('#msg_box').on('keyup',isTypingCallback);<br/>    ...</span></pre><h1 id="928a" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">ç»“è®º</h1><p id="3b66" class="pw-post-body-paragraph iu iv hu ix b iy lv ja jb jc lw je jf jt lx ji jj ju ly jm jn jv lz jq jr js hn dt translated">åœ¨jQueryçš„å¸®åŠ©ä¸‹ï¼Œæˆ‘ä»¬ç”¨C#æ„å»ºäº†ä¸€ä¸ªèŠå¤©åº”ç”¨ç¨‹åºï¼Œå¹¶ä½¿ç”¨Pusherå®ç°äº†ä¸€äº›èŠå¤©åº”ç”¨ç¨‹åºä¸­å¸¸è§çš„å®æ—¶ç‰¹æ€§ã€‚</p><p id="e468" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">è¿™ä¸ªå¸–å­æœ€æ—©å‘å¸ƒç»™<a class="ae kf" href="https://pusher.com/tutorials/chat-aspnet/" rel="noopener ugc nofollow" target="_blank">æ¨æ‰‹</a>ã€‚</p></div></div>    
</body>
</html>