<html>
<head>
<title>Overcome X-Ray’s issue for Lambda debugging</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">克服X射线对Lambda调试的问题</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/overcome-x-rays-issue-for-debugging-892498b14346?source=collection_archive---------19-----------------------#2018-06-18">https://medium.com/hackernoon/overcome-x-rays-issue-for-debugging-892498b14346?source=collection_archive---------19-----------------------#2018-06-18</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="5bf6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Twitter称，追踪是可观察性的支柱之一。<a class="ae jp" href="https://hackernoon.com/tagged/aws" rel="noopener ugc nofollow" target="_blank"> AWS </a> X射线帮助您了解分布式应用的概况，找到瓶颈并调整其关键路径。此外，它还为您提供了跟踪请求的能力，因此您可以看到任何单个请求在进入您的应用程序时经历了哪个过程。AWS X-Ray可能是调试无服务器应用程序的强大工具，但是它仍然不成熟，还有很多需要改进的地方。其中之一是关于它的调试能力和它如何显示错误。</p><p id="1233" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将用一个简单的无服务器应用程序来解释我的观点，如下所示:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/682b6a3633d935be42f64024086025b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cgMyJ_KbqhxDNK4m1OfItg.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">Architecture of my example application</figcaption></figure><p id="31f2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://hackernoon.com/tagged/lambda" rel="noopener ugc nofollow" target="_blank"> Lambda </a>函数下载图像，保存到s3桶中，并将context.awsRequestId记录到Dynamodb表中。然而，后一部分是一个容易出错的操作:Lambda函数随机选择一个重复的分区键，随后Dynamodb抛出ConditionalCheckFailedException。如果错误直接从AWS资源发出，通常会显示在子段的异常部分。错误跟踪看起来是这样的:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff kg"><img src="../Images/d529d2550b2b55a66874489b5cc0e052.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2tUQtWb8jqe4RE2cZl6MBw.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">AWS::Lambda::Function segment is generated by lambda function and error is reflected in the trace</figcaption></figure><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff kh"><img src="../Images/3b651d70d5171496e0453ef54479c76e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PD-elW5yNG9Jga_uzL18cw.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">By clicking on DynamoDb subsegment, you can see the error trace in the Exceptions part</figcaption></figure><p id="21cf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但情况并非总是如此；x射线不会将您的自定义错误传播到跟踪中。这些类型的错误可能经常发生在应用程序的不同部分，随后，您将看到您的跟踪没有错误，异常部分为空，即使发生了错误！这种无错跟踪并没有给你带来太多的帮助，为了调试，你应该仔细检查你的日志。我联系了X射线支持部门，他们已经意识到了这个问题，希望他们将来能解决这个问题。然而，我想出了一个变通办法，目前，这是克服这个问题的唯一方法:如果您创建自定义子段，您可以传播您的自定义错误！然后，您可以注入一个错误对象或附加一个注释。以下是您可以使用的片段:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ki kj l"/></div></figure><p id="376f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它使您的错误跟踪看起来像这样:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff kk"><img src="../Images/ba8943c482e9b33de4083900e3fe22c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_9qVjPVw7JlruSE1X0aPow.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">Custom error is injected into the custom segment and is visible in the trace</figcaption></figure><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff kl"><img src="../Images/7dcfb944aff357b4c986af330ed05d63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HHdGpkuBdUBjPfppUh0Z9Q.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">If you inject an error object into your custom subsegment, you are able to see the trace</figcaption></figure><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff km"><img src="../Images/7542ec3178cf8dc395f3475b0b04de81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5r5sRg_UkLDTiRq1vcFH7A.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">You can put your error type as annotation, and then you can filter out races based on their error type</figcaption></figure><p id="b6ba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，您可以在过滤器表达式的帮助下搜索有问题的跟踪:</p><ol class=""><li id="b065" class="kn ko hu it b iu iv iy iz jc kp jg kq jk kr jo ks kt ku kv dt translated">您可以筛选出带有特定注释的跟踪，例如:annotation . error = " customer error 1 "</li></ol><p id="3252" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">2.您可以借助复杂的关键字过滤出具有下游问题/错误的跟踪，例如:service(" service-name "){ error = true }</p><p id="79f7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以选择将服务名留空。</p><p id="5771" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这种解决方法有一个缺点；您应该总是创建一个额外的子段来包含您的错误，这使它看起来像一个肮脏的工作区。但是让我们期待AWS尽快解决这个问题吧！</p><p id="7079" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意:</p><ol class=""><li id="c4a6" class="kn ko hu it b iu iv iy iz jc kp jg kq jk kr jo ks kt ku kv dt translated">x射线<a class="ae jp" href="https://en.wiktionary.org/wiki/categorizes" rel="noopener ugc nofollow" target="_blank">将</a>客户端(4xx系列错误)归类为错误，服务器端错误(5xx系列错误)归类为故障。</li><li id="74df" class="kn ko hu it b iu kw iy kx jc ky jg kz jk la jo ks kt ku kv dt translated">2.您可以查看<a class="ae jp" href="https://docs.aws.amazon.com/xray-sdk-for-nodejs/latest/reference/" rel="noopener ugc nofollow" target="_blank"> X-Ray SDK for Nodejs </a>来找出创建子分段的不同方法</li></ol><p id="c66b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以在这里看到我和x光支持团队<a class="ae jp" href="https://forums.aws.amazon.com/thread.jspa?threadID=282800&amp;tstart=0" rel="noopener ugc nofollow" target="_blank">的全部对话。</a></p><p id="5ce3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">感谢阅读。如果您有任何意见或问题，请告诉我。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lb kj l"/></div></figure></div></div>    
</body>
</html>