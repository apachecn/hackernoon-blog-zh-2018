<html>
<head>
<title>Elephant in the Room: Database Backup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">房间里的大象:数据库备份</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/elephant-in-the-room-database-backup-574da50e6d88?source=collection_archive---------15-----------------------#2018-06-19">https://medium.com/hackernoon/elephant-in-the-room-database-backup-574da50e6d88?source=collection_archive---------15-----------------------#2018-06-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/7040c5a300661646a6de7c3707e83aca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tm3culOnUMproMU2I6j58w.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Photo by <a class="ae jg" href="https://unsplash.com/photos/A7fqqy2JkaE?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Alexandre Chambon</a></figcaption></figure><blockquote class="jh ji jj"><p id="f8e4" class="jk jl jm jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hn dt translated">披露:<a class="ae jg" href="https://bit.ly/2lk2sCG" rel="noopener ugc nofollow" target="_blank"> <strong class="jn hv">歧</strong> </a> <strong class="jn hv">，</strong>开发商marketplace，此前曾赞助黑客正午。<a class="ae jg" href="https://bit.ly/2lk2sCG" rel="noopener ugc nofollow" target="_blank"> <strong class="jn hv">使用code HACKERNOON2018获得任何服务10美元优惠。</strong> </a></p></blockquote><p id="2ad8" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">我们已经看过很多次了。然而，它仍然定期发生，好像这个慢性问题没有永久的治疗方法。</p><p id="5fa5" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">大约9年前，<a class="ae jg" href="https://en.wikipedia.org/wiki/Danger_Hiptop" rel="noopener ugc nofollow" target="_blank"> Sidekick </a>，一款当时流行的T-Mobile智能手机，<a class="ae jg" href="https://en.wikipedia.org/wiki/2009_Sidekick_data_loss" rel="noopener ugc nofollow" target="_blank">在云端丢失了所有用户数据</a>，导致80万用户无法访问他们自己的个人数据，如电子邮件、笔记、联系人、日历和照片。</p><p id="3733" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">后来，微软决定停止云服务，并最终停止销售该设备。</p><p id="e908" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">结果，一个庞大的企业及其生态系统不复存在。这是云计算历史上最大的灾难。</p><p id="49ba" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated"><a class="ae jg" href="https://about.gitlab.com/2017/02/10/postmortem-of-database-outage-of-january-31/" rel="noopener ugc nofollow" target="_blank"> GitLab还遭遇了</a>故障恢复程序，当时一名工程师在他们的主数据库上运行<code class="eh km kn ko kp b">rm -rf /important-data</code>，意外删除了错误服务器上的一个目录。</p><blockquote class="jh ji jj"><p id="9041" class="jk jl jm jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hn dt translated">旁注:赞扬他们的透明度！GitLab提供了房间里大象的完整图片和解剖结构，这在野外或临床环境中很难得到。他们的尸检具有巨大的教育价值。</p></blockquote><p id="8233" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">引用自<a class="ae jg" href="https://www.theregister.co.uk/2017/02/01/gitlab_data_loss/" rel="noopener ugc nofollow" target="_blank">现场笔记</a>:</p><blockquote class="kq"><p id="68dd" class="kr ks hu bd kt ku kv kw kx ky kz ki ek translated">换句话说，在部署的5种备份/复制技术中，没有一种能够可靠地工作，也没有一种是一开始就设置好的。</p></blockquote><p id="7ad4" class="pw-post-body-paragraph jk jl hu jn b jo la jq jr js lb ju jv kj lc jy jz kk ld kc kd kl le kg kh ki hn dt translated">5层冗余中有5层失效？对于一家当时筹集了2500多万美元的公司来说，这怎么可能呢？</p><p id="c95e" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">一定有我们所有人都可以学习的东西。让我们深入研究一下。</p><h1 id="f6b3" class="lf lg hu bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc dt translated">那是怎么发生的？</h1><p id="0e65" class="pw-post-body-paragraph jk jl hu jn b jo md jq jr js me ju jv kj mf jy jz kk mg kc kd kl mh kg kh ki hn dt translated"><a class="ae jg" href="https://www.backblaze.com/blog/the-3-2-1-backup-strategy/" rel="noopener ugc nofollow" target="_blank">3–2–1备份</a>是系统管理员公认的信条，这意味着至少要有3份数据副本，其中2份在本地但在不同的设备上，至少1份在异地。</p><p id="66e1" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">GitLab遵循这一原则，在本地快照和热备用的基础上进行异地备份。除了他们<em class="jm">认为他们做到了。</em></p><ul class=""><li id="dbf4" class="mi mj hu jn b jo jp js jt kj mk kk ml kl mm ki mn mo mp mq dt translated">【PostgreSQL主机之间的复制用于故障转移目的，而不是用于灾难恢复。(当出现错误或人为错误时，它不会有所帮助——它只会立即复制错误。)</li><li id="504b" class="mi mj hu jn b jo mr js ms kj mt kk mu kl mv ki mn mo mp mq dt translated">Azure磁盘快照在文件服务器上运行，但不在数据库上运行。无论如何，恢复速度太慢，在一个这样的案例中，恢复一个快照需要一个多星期。</li><li id="d8f0" class="mi mj hu jn b jo mr js ms kj mt kk mu kl mv ki mn mo mp mq dt translated"><strong class="jn hv"> LVM快照</strong>每24小时拍摄一次，但幸运的是，其中一个快照是在停机前大约6小时手动拍摄的，最终选择从该快照进行恢复。</li><li id="b7b7" class="mi mj hu jn b jo mr js ms kj mt kk mu kl mv ki mn mo mp mq dt translated">使用cron和<code class="eh km kn ko kp b">pg_dump</code>的常规<strong class="jn hv">异地备份</strong>已经<strong class="jn hv">无声地失败</strong>，产生的文件只有几个字节大小。S3桶是空的，而且没有最近的备份被发现在任何地方。</li><li id="4521" class="mi mj hu jn b jo mr js ms kj mt kk mu kl mv ki mn mo mp mq dt translated">针对任何cronjob失败启用了通知，但是<a class="ae jg" href="https://dmarc.org/" rel="noopener ugc nofollow" target="_blank"> SMTP认证</a>在cronjobs上不活动，导致所有通知电子邮件被收件人拒绝。这意味着他们从未意识到备份失败，直到为时已晚。</li></ul><p id="f2f6" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">如果你认为这是样本量为1的边缘情况，请继续阅读。</p><p id="3112" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">你可能不熟悉<strong class="jn hv">空备份</strong>位，但实际上这很常见。</p><p id="9990" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">当服务器与客户端不兼容时，PostgreSQL和MySQL的备份工具(<code class="eh km kn ko kp b">pg_dump</code>和<code class="eh km kn ko kp b">mysqldump</code>)会无声地失败，产生几乎(但不是完全)空的转储。</p><p id="863c" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">我甚至<a class="ae jg" href="https://bugs.mysql.com/bug.php?id=67507" rel="noopener ugc nofollow" target="_blank">报告了这个问题，并建议自己对MySQL进行修复</a>。</p><blockquote class="jh ji jj"><p id="be87" class="jk jl jm jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hn dt translated">如果您只是cp / tar / rsync数据库文件，您很可能得到完全损坏的数据，除非您首先关闭数据库。详情见<a class="ae jg" href="https://www.postgresql.org/docs/10/static/backup-file.html" rel="noopener ugc nofollow" target="_blank">此处</a>。</p></blockquote><p id="6204" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">当您第一次编写cron脚本时，一切都正常，但是几个月或几年后，随着您的业务增长、扩展和升级系统的某些部分，它将停止工作。</p><p id="65f1" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">最糟糕的部分？就在你需要它们的时候，你发现没有备份。</p><p id="9bbb" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated"><strong class="jn hv">任何有足够经验的系统管理员在其职业生涯中都曾多次目睹cronjobs默默无闻地失败。</strong></p><p id="e5c8" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">GitLab能够从停机前6小时拍摄的LVM快照中恢复，但如果是存储设备的物理损坏呢？LVM快照不会有帮助，因为快照保存在同一个物理磁盘中。</p><blockquote class="jh ji jj"><p id="06ab" class="jk jl jm jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hn dt translated">顺便说一下，你知道攻击者可以通过<a class="ae jg" href="https://thehackernews.com/2018/05/hard-drive-failure-hack.html" rel="noopener ugc nofollow" target="_blank">播放超声波来破坏你的硬盘</a>吗？</p></blockquote><p id="13fb" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">如果没有异地备份，他们会留下一个空白数据库，从第一天起就丢失所有客户数据。</p><p id="f268" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">如果你正在亚马逊RDS上使用数据库快照，或者使用<a class="ae jg" href="https://m.do.co/c/815fd3260251" rel="noopener ugc nofollow" target="_blank"> DigitalOcean </a>或<a class="ae jg" href="https://www.linode.com/?r=3f9f0a7f1107a6d1ef1b88a247657f010604fdc6" rel="noopener ugc nofollow" target="_blank"> Linode </a>的备份功能，了解它们的局限性，并记住备份保存在同一个物理磁盘上。它们不是用于灾难恢复的。</p><p id="47bb" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">到目前为止，您已经了解到即使在云计算时代，异地备份也是必须的。但与此同时，很难检测备份何时正在运行，而只是进行空转储。</p><p id="80f5" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">最佳实践是什么？</p><h1 id="0c9f" class="lf lg hu bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc dt translated">接受任何东西都可能破碎</h1><p id="498f" class="pw-post-body-paragraph jk jl hu jn b jo md jq jr js me ju jv kj mf jy jz kk mg kc kd kl mh kg kh ki hn dt translated">如果您是一家小型企业，无力聘请专门的开发人员和/或数据库管理员定期手动测试恢复程序，您能做些什么吗？</p><p id="c7e0" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">有太多可能的例外，你无法提前做好准备，这将打破cronjob。例如，你无法知道所有东西的未来版本会发生什么。</p><p id="eb63" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">系统升级是最临时的、一次性的程序之一，不能一概而论，很难为这种事情设定操作规则。</p><p id="4e87" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">当出现问题时，最后一招似乎是可靠的通知。</p><p id="25dc" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">但是<strong class="jn hv">“没有消息就是好消息”并不适用于</strong>当通知系统也可能崩溃的时候，正如GitLab的案例所示。</p><p id="e637" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">解决方案？除了实时的错误通知之外，以合理的频率发送备份报告，这不会造成“通知盲”，但会让您在停止接收它们时注意到。每周或每月一次是明智的。还要确保检测转储文件大小变化中的标准偏差异常。</p><p id="13b1" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">或者你可以注册<a class="ae jg" href="https://dumper.io/" rel="noopener ugc nofollow" target="_blank"> Dumper </a>，它就是这么做的。</p><figure class="mx my mz na fq iv fe ff paragraph-image"><div class="fe ff mw"><img src="../Images/c8130f0d5db215af72c25e11035bcb3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:688/format:webp/1*rRACf-VJkJKMpbq7H57MWw.png"/></div></figure><h1 id="a5cf" class="lf lg hu bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc dt translated">即使备份看起来很好…</h1><p id="88a9" class="pw-post-body-paragraph jk jl hu jn b jo md jq jr js me ju jv kj mf jy jz kk mg kc kd kl mh kg kh ki hn dt translated">最后，即使您有一个工作的异地备份，也有转储可能被破坏的情况，直到您实际恢复数据库并浏览数据时，您才能注意到这一点。</p><p id="b067" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">例如，<code class="eh km kn ko kp b">mysqldump</code>将根据客户的字符集和您最喜欢的表情符号进行转储，例如🍣和🍺在<code class="eh km kn ko kp b">utf8mb4</code>可能会被破坏，由备份中的<code class="eh km kn ko kp b">?</code>替换。如果你从未检查过，现在就去做。设置<code class="eh km kn ko kp b">--default-character-set=binary</code>选项即可——不客气。</p><p id="e73d" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">或者，如果您错过了<code class="eh km kn ko kp b">--single-transaction</code>选项，您可能会有不一致的备份(例如，物品易手，但资金未转移)，即使您定期手动测试恢复程序，也不容易发现这些备份。</p><p id="6b02" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">当您的数据集增长到每天执行完整的逻辑转储太慢的程度时，您需要考虑归档WAL/binlog以实现增量备份和时间点恢复。(稍后详细介绍—注册我们的邮件列表！)</p><p id="aeda" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated">是的，我知道这听起来很疯狂。这也是为什么我建造了<a class="ae jg" href="https://dumper.io/" rel="noopener ugc nofollow" target="_blank">Dumper</a>——备份不应该这么难。</p></div><div class="ab cl nb nc hc nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="hn ho hp hq hr"><p id="548c" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv kj jx jy jz kk kb kc kd kl kf kg kh ki hn dt translated"><em class="jm">如果你想阅读更多这样的内容，请访问</em> <a class="ae jg" href="https://blog.dumper.io/" rel="noopener ugc nofollow" target="_blank"> <em class="jm"> Dumper博客</em> </a> <em class="jm">并订阅邮件列表。也可以在Twitter上</em> <a class="ae jg" href="https://twitter.com/@kenn" rel="noopener ugc nofollow" target="_blank"> <em class="jm">关注我</em> </a> <em class="jm">。除非你100%确定你的备份脚本在工作，否则请查看</em> <a class="ae jg" href="https://dumper.io/" rel="noopener ugc nofollow" target="_blank"> <em class="jm">转储器</em> </a> <em class="jm">，异地备份即服务。</em></p></div></div>    
</body>
</html>