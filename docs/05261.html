<html>
<head>
<title>Understanding the React Native bridge concept</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解React本机桥的概念</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/understanding-react-native-bridge-concept-e9526066ddb8?source=collection_archive---------1-----------------------#2018-06-22">https://medium.com/hackernoon/understanding-react-native-bridge-concept-e9526066ddb8?source=collection_archive---------1-----------------------#2018-06-22</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="b3be" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">以及为什么它的建筑是一流的。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/fbe84f6d6865884083eb8e8ed7553c82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SluXAlSPIxxWjwUsiqD2Kw.png"/></div></div></figure><p id="de4f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">React Native通常被描述为一个游戏改变者，它允许在移动环境中运行JavaScript代码。它的主要优势在于，它不像其他竞争对手(<a class="ae kb" href="https://phonegap.com/" rel="noopener ugc nofollow" target="_blank"> Phonegap </a>、<a class="ae kb" href="https://ionicframework.com/" rel="noopener ugc nofollow" target="_blank"> Ionic </a>、<a class="ae kb" href="https://cordova.apache.org/" rel="noopener ugc nofollow" target="_blank">Cordova</a>……)那样依赖<a class="ae kb" href="https://developer.telerik.com/featured/what-is-a-webview/" rel="noopener ugc nofollow" target="_blank"> webviews </a>，而是依赖于不同平台提供的实际真实素材。默认情况下，它内置了对所有本地视图和组件的访问，以及对大约70个特定设备API的访问(<a class="ae kb" href="https://facebook.github.io/react-native/docs/native-modules-ios.html" rel="noopener ugc nofollow" target="_blank">您可以扩展它</a>)。</p><p id="2213" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">编写React原生应用时，我们构建原生ui。这是关键点，我们创建<code class="eh kc kd ke kf b">UIView</code>实例，就像我们使用特定于平台的语言一样:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kg"><img src="../Images/22b91e2d8a3ef50bdcb3be0e30a423d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jio8QkXkT__6VsdEnSzszQ.png"/></div></div><figcaption class="kh ki fg fe ff kj kk bd b be z ek"><a class="ae kb" href="https://github.com/facebook/react-native/blob/master/React/Views/RCTView.h#L19" rel="noopener ugc nofollow" target="_blank">RCTView implements UIView</a></figcaption></figure><p id="7ace" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我对这个框架的第一个假设是这样的:</p><blockquote class="kl km kn"><p id="49b5" class="ir is ko it b iu iv iw ix iy iz ja jb kp jd je jf kq jh ji jj kr jl jm jn jo hn dt translated">他们可能会从JS代码中创建一个<a class="ae kb" rel="noopener" href="/@jotadeveloper/abstract-syntax-trees-on-javascript-534e33361fc7"> AST </a>，并对其进行转换，使其可以在多种设备上运行。</p></blockquote><p id="469b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将是有意义的，这实际上是G <a class="ae kb" href="https://docs.google.com/presentation/d/1cw7A4HbvM_Abv320rVgPVGiUP2msVs7tfGbkgdrTy0I/edit" rel="noopener ugc nofollow" target="_blank"> oogle/Flutter </a>在构建应用程序时所做的事情(使用<a class="ae kb" href="https://www.dartlang.org/" rel="noopener ugc nofollow" target="_blank"> Dartlang </a>)。但这不是当地人的反应方式。</p><p id="9e75" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这种方法的主要问题是针对基于JavaScript代码的编译平台意味着创建新的编译器。我不知道任何现有的工具接受JavaScript作为入口代码，能够为每个目标平台生成代码。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ks"><img src="../Images/48f79c3b44707f85e9a2f37adcf67629.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bf7U0_eRo_342L3I51gyPQ.png"/></div></div><figcaption class="kh ki fg fe ff kj kk bd b be z ek">NB: some have tried but only for mobile development with opinionated approaches</figcaption></figure><p id="a01e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是目前存在的是针对它们自己的特定平台的编译器。例如，我们有接受Java / Kotlin代码并以Android平台为目标的编译器，或以iOS平台为目标的Obj-C / Swift。它有许多针对不同语言和目标的编译器。他们工作出色，因为<strong class="it hv">他们被设计为</strong>为他们创造优化的人工制品。</p><p id="8c4d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">React Native的构建方式是<strong class="it hv">使用现有的编译器:</strong></p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kt"><img src="../Images/37d85e5144d85fc2663e70b6115dd12a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sucxk9LMqW9booBv4f02cg.png"/></div></div></figure><p id="424a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它采用真正开放的架构构建，不仅允许代码在移动设备上运行，还允许在其他平台上运行:</p><ul class=""><li id="9c95" class="ku kv hu it b iu iv iy iz jc kw jg kx jk ky jo kz la lb lc dt translated"><a class="ae kb" href="https://github.com/kusti8/proton-native" rel="noopener ugc nofollow" target="_blank">桌面应用</a></li><li id="6723" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated"><a class="ae kb" href="https://facebook.github.io/react-360/" rel="noopener ugc nofollow" target="_blank">虚拟现实</a></li><li id="dc63" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated"><a class="ae kb" href="https://news.ycombinator.com/item?id=16198843" rel="noopener ugc nofollow" target="_blank">更多更</a></li></ul><p id="c3ce" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它也可以与其他框架一起使用:</p><ul class=""><li id="6cc0" class="ku kv hu it b iu iv iy iz jc kw jg kx jk ky jo kz la lb lc dt translated"><a class="ae kb" href="https://github.com/alibaba/weex" rel="noopener ugc nofollow" target="_blank"> Weex </a>，一个<a class="ae kb" href="https://github.com/vuejs/vue" rel="noopener ugc nofollow" target="_blank"> Vuejs </a>的React原生端口。</li><li id="6a10" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">一个定制的<a class="ae kb" href="https://github.com/angular/react-native-renderer" rel="noopener ugc nofollow" target="_blank">角度渲染器，允许在设备中运行ng应用，带有React Native </a>。</li></ul><p id="ce2d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">那么这个团队是如何通过使用现有的工具和编译器来构建这样一个平台和框架不可知的框架的呢？</p><h1 id="f97f" class="li lj hu bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf dt translated">多个领域相互作用，仅此而已</h1><p id="27ef" class="pw-post-body-paragraph ir is hu it b iu mg iw ix iy mh ja jb jc mi je jf jg mj ji jj jk mk jm jn jo hn dt translated">让我们退一步，看看React Native的大图。</p><p id="cebf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">React Native涉及两个领域，JavaScript领域和原生领域。他们都能够共享信息。它们使用“桥”进行通信，这无疑是React原生架构的核心，提供了如此多的灵活性。</p><p id="3504" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">桥的概念是为这两个世界之间的双向和异步通信提供一种方式。这里重要的是，它们完全是用不同的技术编写的，但是<strong class="it hv">它们能够通信。</strong></p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ml"><img src="../Images/e71e6c18d5f1320c4421cee00c31c0fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JT_Smf1u3fJTBY8ev9WAzg.png"/></div></div><figcaption class="kh ki fg fe ff kj kk bd b be z ek">JS threads communicates with the native ones through the bridge</figcaption></figure><h1 id="9a57" class="li lj hu bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf dt translated">记住你的后端</h1><p id="df91" class="pw-post-body-paragraph ir is hu it b iu mg iw ix iy mh ja jb jc mi je jf jg mj ji jj jk mk jm jn jo hn dt translated">让我们回忆一下我们用多服务通信编写分布式后端应用程序的时候。</p><p id="a236" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们如何管理两个在语言/平台层面上完全不同的服务之间的通信？</p><p id="2c41" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们使用可互操作的语言，如JSON或XML，我们依赖异步协议，如AMQP(或任何其他协议)。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mm"><img src="../Images/a655d9ea06d724e5153c201f284254a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9PsB7QpiXxg7bnmzS1UgCg.png"/></div></div><figcaption class="kh ki fg fe ff kj kk bd b be z ek">Bidirectional communications between heterogeneous services</figcaption></figure><p id="eab3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果我们希望这两个服务进行通信，我们依赖于消息队列。第一个服务将一些命令推入队列，另一个服务必须在可能的时候执行这些命令<em class="ko"/>。</p><p id="13fa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">React Native的行为方式相同。JavaScript领域发送异步JSON消息，描述本机部分应该完成的动作。</p><p id="d353" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">例如，JavaScript端将发送关于必须由本机端创建的视图的信息。当本地端准备好时，它将有效地创建视图:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mn"><img src="../Images/edca9380f9b5ac9576f20fd54573c1bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UHBv6Ctmm6n6xV0iED8zqA.png"/></div></div><figcaption class="kh ki fg fe ff kj kk bd b be z ek">JavaScript sends commands asynchronously to the Native side for view management, with JSON</figcaption></figure><p id="8f66" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在React Native中，桥支持消息代理角色，处理两个不同世界之间的异步命令。</p><p id="c98e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它提供了多种可能性:</p><ul class=""><li id="3a09" class="ku kv hu it b iu iv iy iz jc kw jg kx jk ky jo kz la lb lc dt translated">因为它是异步的，所以它是非阻塞的，因此允许在屏幕上进行平滑的视图管理(大约6O fps是React本机的黄金目标)</li><li id="f61b" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">由于它是解耦的，并且基于可互操作的语言，它对其他框架和渲染系统<strong class="it hv">非常开放，只要它们尊重React本地桥命令接口</strong></li></ul><p id="c9f8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">桥的语言越是无处不在，越是通用，可能性就越多……而它<strong class="it hv">的确是</strong>！</p><h1 id="4879" class="li lj hu bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf dt translated">桥接实现</h1><p id="ae5d" class="pw-post-body-paragraph ir is hu it b iu mg iw ix iy mh ja jb jc mi je jf jg mj ji jj jk mk jm jn jo hn dt translated"><a class="ae kb" href="https://github.com/facebook/react-native/blob/81860c59c3453429bb4e70da2c372c92e66e134c/ReactCommon/cxxreact/NativeToJsBridge.cpp#L29" rel="noopener ugc nofollow" target="_blank">这个桥是用C/C++构建的，因此可以在多种平台、操作系统等上运行...</a></p><p id="ccaa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它将<a class="ae kb" href="https://developer.apple.com/documentation/javascriptcore" rel="noopener ugc nofollow" target="_blank"> Apple JavaScriptCore框架</a>嵌入其中，公开API以访问实际的JavacriptCore VM功能。很多人在Obj-C和Swift世界上使用这些API。但是有一个C API，Obj-C那个其实只是一个包装器。</p><p id="c531" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">考虑到这一点，JavaScript代码可以在C/C++程序中运行。它可以注入变量、函数和声明全局变量来增强JavaScript现有代码。React Native依靠这种魔力使JavaScript与本地世界通信，从而<a class="ae kb" href="https://github.com/facebook/react-native/blob/52f431b4bb29062abd8ce20e01a4e60b47151a80/Libraries/BatchedBridge/MessageQueue.js#L254" rel="noopener ugc nofollow" target="_blank">触发C/C++世界中的动作。</a></p><p id="3b1f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="ko">在JavaScript代码中注入东西也意味着函数可以由C/C++代码执行。</em></p><p id="5200" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个图表快速总结了JavaScript世界如何处理C/C++世界:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mo"><img src="../Images/d56993aac6b700df9d88e70e47202a98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a6tsmWbB6JtgnOWy7Hyx0A.png"/></div></div><figcaption class="kh ki fg fe ff kj kk bd b be z ek">The JS code is managed by the JSCore framework</figcaption></figure><h1 id="9737" class="li lj hu bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf dt translated">本土的一面</h1><p id="aec7" class="pw-post-body-paragraph ir is hu it b iu mg iw ix iy mh ja jb jc mi je jf jg mj ji jj jk mk jm jn jo hn dt translated">原生端的通信是“最容易”的部分。</p><p id="82f9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">先说iOS平台。由于Obj-C是C语言的扩展，所以它可以与C语言进行本地通信。这样，桥梁和Swift / Obj-C世界之间的交流就变得简单而自然。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mp"><img src="../Images/f7e78b837919469586063192df97b772.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OhI5FguDjCJiMHGkyRUcwg.png"/></div></div><figcaption class="kh ki fg fe ff kj kk bd b be z ek">High level diagram of JS interacting with iOS world</figcaption></figure><p id="1c60" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在Android上，我们需要依靠<a class="ae kb" href="https://docs.oracle.com/javase/8/docs/technotes/guides/jni/" rel="noopener ugc nofollow" target="_blank"> Java本地接口</a>来与桥对话。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mq"><img src="../Images/a1ab0bca3fd99a745bc05826ce338504.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q16vcoe7CRolZLOCoG5_Pg.png"/></div></div><figcaption class="kh ki fg fe ff kj kk bd b be z ek">High level diagram of JS interacting with Android world</figcaption></figure><p id="b941" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里有一个旧的，但非常棒和深刻的帖子，解释了桥是如何在iOS上实现的<a class="ae kb" href="https://tadeuzagallo.com/blog/react-native-bridge/" rel="noopener ugc nofollow" target="_blank">，作者是塔德乌·扎加洛</a>。</p><p id="749d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="ko">如果您对React Native internals还有其他问题，请告诉我。我会尽力提供我所知道的关于这个话题的一切。</em></p><p id="6a4f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">感谢我的朋友@ Zenika和@M6Web 的评论！</p></div></div>    
</body>
</html>