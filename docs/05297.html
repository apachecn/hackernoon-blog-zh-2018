<html>
<head>
<title>A simple introduction to Python’s asyncio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python的asyncio简单介绍</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/a-simple-introduction-to-pythons-asyncio-595d9c9ecf8c?source=collection_archive---------0-----------------------#2018-06-24">https://medium.com/hackernoon/a-simple-introduction-to-pythons-asyncio-595d9c9ecf8c?source=collection_archive---------0-----------------------#2018-06-24</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/5bc8129ba2dd5550923130567a0d6b3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R4HzblupF0U1sgfCqH9SUg.png"/></div></div></figure><div class=""/><blockquote class="jc"><p id="c8f5" class="jd je if bd jf jg jh ji jj jk jl jm ek translated">这是对Python中的asyncio库的简明扼要的基本原则介绍。</p></blockquote><p id="9d6b" class="pw-post-body-paragraph jn jo if jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj jm hn dt translated">如果您已经来到这里，您可能听说过诸如异步、并发和并行这样的词。在我们开始使用asyncio之前，让我们快速了解一些关于这些单词的基本知识(通过例子)，这样我们就有了一个坚实的基础。</p><p id="1083" class="pw-post-body-paragraph jn jo if jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated"><strong class="jp ig">并发</strong>是<strong class="jp ig"> </strong>就像在单核CPU上运行两个线程。来自每个线程的指令可以交错，但是在任何给定的时间，两个线程中只有一个在积极地取得进展。</p><p id="b452" class="pw-post-body-paragraph jn jo if jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated"><strong class="jp ig">并行</strong>就像在多核CPU的不同内核上同时运行两个线程。</p><blockquote class="kp kq kr"><p id="8ce6" class="jn jo ks jp b jq kk js jt ju kl jw jx kt km ka kb ku kn ke kf kv ko ki kj jm hn dt translated">值得注意的是，并行意味着并发，而不是相反。</p></blockquote><p id="dfae" class="pw-post-body-paragraph jn jo if jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">异步是一个更高层次的编程概念，你启动某个任务，并决定当你没有那个任务的结果时，你最好做一些其他的工作而不是等待。</p><blockquote class="kp kq kr"><p id="1825" class="jn jo ks jp b jq kk js jt ju kl jw jx kt km ka kb ku kn ke kf kv ko ki kj jm hn dt translated">当你异步地做事情时，根据定义，你意味着这些事情之间的并发性。</p></blockquote><h2 id="6e25" class="kw kx if bd ky kz la lb lc ld le lf lg jy lh li lj kc lk ll lm kg ln lo lp lq dt translated">为什么要异步编程？</h2><p id="db7a" class="pw-post-body-paragraph jn jo if jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj jm hn dt translated">你说我们为什么要写异步程序——因为它可以让你的程序性能提高很多很多倍。假设您有一台运行应用的单核机器。您收到一个请求，您需要进行两次数据库查询来完成该请求。每个查询需要50毫秒的时间。对于同步程序，只有在完成第一个请求(总时间为100毫秒)后，才能发出第二个请求。使用异步程序，您可以一个接一个地执行这两个查询——总时间为50毫秒。</p><h1 id="1363" class="lw kx if bd ky lx ly lz lc ma mb mc lg md me mf lj mg mh mi lm mj mk ml lp mm dt translated">阿辛西奥</h1><p id="3b23" class="pw-post-body-paragraph jn jo if jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj jm hn dt translated">Asyncio是关于用Python编写异步程序的。Asyncio是一部美妙的交响乐，它将一个<strong class="jp ig">事件循环</strong>、<strong class="jp ig">任务</strong>和<strong class="jp ig">协程</strong>完美地结合在一起——它会让你哭泣。</p><h2 id="3546" class="kw kx if bd ky kz la lb lc ld le lf lg jy lh li lj kc lk ll lm kg ln lo lp lq dt translated">事件循环</h2><p id="0108" class="pw-post-body-paragraph jn jo if jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj jm hn dt translated">这就是让这一切成为可能的原因——一个简单的循环，就是这样。嗯不是<em class="ks">那么简单</em>。但它是这样工作的。事件循环是交响乐的指挥者。它一个接一个地运行<em class="ks">任务</em>。在任何给定时间，只有一个任务在运行。</p><p id="2f82" class="pw-post-body-paragraph jn jo if jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">可以想象，活动任务压力很大，因为其他任务正在等待轮到它们。因此，当活动任务发出阻塞调用(比如网络请求)并且无法继续时，它会将控制权交还给事件循环，并意识到其他任务可能会更好地利用事件循环的时间。它还告诉事件循环它被阻塞的确切原因，以便当网络响应到来时，事件循环可以考虑给它时间再次运行。</p><blockquote class="kp kq kr"><p id="656f" class="jn jo ks jp b jq kk js jt ju kl jw jx kt km ka kb ku kn ke kf kv ko ki kj jm hn dt translated">事件循环时间非常宝贵。如果你没有进步，你应该退出这个循环，这样别人也能进步。事件循环是进度的度量。</p></blockquote><h2 id="b11e" class="kw kx if bd ky kz la lb lc ld le lf lg jy lh li lj kc lk ll lm kg ln lo lp lq dt translated">协程和任务</h2><p id="e086" class="pw-post-body-paragraph jn jo if jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj jm hn dt translated">协同例程(合作例程)是交响乐的关键元素。当协同程序没有任何有用的事情可做时，正是协同程序和它们的协作性质使得能够放弃对事件循环的控制。协程是子程序概念的有状态概括。</p><p id="3689" class="pw-post-body-paragraph jn jo if jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">子程序是你的老式函数或方法。您调用子例程来执行计算。您可以再次调用它，但是它不会在两次调用之间保持状态。每次调用都是全新的，并且执行相同的计算。</p><p id="e1d3" class="pw-post-body-paragraph jn jo if jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">另一方面，协程是一个可爱的有状态的小部件。它看起来像一个子例程，但是它在两次执行之间维护状态。换句话说，当协程“返回”(放弃控制权)时，这仅仅意味着它已经<strong class="jp ig">暂停了</strong>它的执行(带有一些保存的状态)。因此，当您随后“调用”(控制)协程时，可以说协程已经<strong class="jp ig">恢复了</strong>它的执行(从保存状态)。</p><blockquote class="kp kq kr"><p id="e254" class="jn jo ks jp b jq kk js jt ju kl jw jx kt km ka kb ku kn ke kf kv ko ki kj jm hn dt translated">协程看起来像一个普通的函数，但是在它们的行为中，它们是有状态的对象，有类似于<code class="eh mn mo mp mq b">resume()</code>和<code class="eh mn mo mp mq b">pause()</code>的方法。</p></blockquote><p id="439f" class="pw-post-body-paragraph jn jo if jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">在Python 3.5+中，<strong class="jp ig">协程暂停自身的方式</strong>是使用<code class="eh mn mo mp mq b">await</code>关键字。在一个协程内部，当您<code class="eh mn mo mp mq b">await</code>在另一个协程上时，您离开事件循环并调度等待的协程立即运行<strong class="jp ig"/>。也就是说，协程内的<code class="eh mn mo mp mq b">await other_coroutine</code>将暂停它，并调度协程<code class="eh mn mo mp mq b">other_coroutine</code>立即运行。</p><blockquote class="kp kq kr"><p id="0dc5" class="jn jo ks jp b jq kk js jt ju kl jw jx kt km ka kb ku kn ke kf kv ko ki kj jm hn dt translated">请注意，事件循环不会抢占正在运行的协程。只有协程程序可以暂停自己。</p></blockquote><p id="eb7e" class="pw-post-body-paragraph jn jo if jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">下面是一个非常简单的例子<em class="ks"> (Python 3.5+) </em>关于协程如何相互协作。我们将使用一个预定义的协程<code class="eh mn mo mp mq b">asyncio.sleep</code>来帮助我们模拟这个例子中的阻塞任务，但是它可以是现实世界场景中的任何东西，比如网络请求、数据库查询等等。</p><p id="75c1" class="pw-post-body-paragraph jn jo if jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">注意，<strong class="jp ig">代码在单线程</strong>中运行，然而，输出将具有交错的打印语句。发生这种情况是因为当一个协程被阻塞时，它会退出循环，这样另一个就可以运行了(耶！用asyncio进行异步编程)。</p><figure class="mr ms mt mu fq hw"><div class="bz el l di"><div class="mv mw l"/></div><figcaption class="mx my fg fe ff mz na bd b be z ek">python run coroutine_example.py</figcaption></figure><p id="72f7" class="pw-post-body-paragraph jn jo if jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">需要注意的几点</p><ul class=""><li id="05d5" class="nb nc if jp b jq kk ju kl jy nd kc ne kg nf jm ng nh ni nj dt translated">调用协程定义<strong class="jp ig">并不执行它</strong>。它初始化一个<em class="ks">协程对象</em>。你<code class="eh mn mo mp mq b">await</code>在<em class="ks">协程对象</em>上，而不是<em class="ks">协程定义</em>上你可以在上面的<code class="eh mn mo mp mq b">line 8</code>和<code class="eh mn mo mp mq b">line 17</code>中看到。</li><li id="e2e9" class="nb nc if jp b jq nk ju nl jy nm kc nn kg no jm ng nh ni nj dt translated"><strong class="jp ig">事件循环直接运行任务</strong>，而不是<em class="ks">协程对象</em>。任务是围绕<em class="ks">协程对象</em>的包装器。当你写<code class="eh mn mo mp mq b">await coroutine_object</code>的时候，你实际上安排了一个包装器任务在事件循环<strong class="jp ig">上立即运行</strong>。</li><li id="e1e7" class="nb nc if jp b jq nk ju nl jy nm kc nn kg no jm ng nh ni nj dt translated"><code class="eh mn mo mp mq b">asyncio.sleep</code>也是一个协同程序，由asyncio库提供。<code class="eh mn mo mp mq b">asyncio.sleep(2)</code>用值2秒初始化协程对象。当你使用它时，你就把事件循环的控制权交给了它。睡眠协程很聪明，不会阻塞循环。它立即释放控制，简单地要求循环在指定时间后唤醒它。当时间到期时，它被交还控制权，并立即返回，从而解除对其调用方的阻塞(在上面的示例中为<code class="eh mn mo mp mq b">coroutine_1</code>或<code class="eh mn mo mp mq b">coroutine_2</code>)。</li><li id="f140" class="nb nc if jp b jq nk ju nl jy nm kc nn kg no jm ng nh ni nj dt translated">上面的例子有三种不同类型的协程运行在事件循环上— <code class="eh mn mo mp mq b">coroutine_1</code>、<code class="eh mn mo mp mq b">coroutine_2</code>和<code class="eh mn mo mp mq b">asyncio.sleep</code>。然而，四个不同的任务在循环中运行，对应于以下协程对象:调度在<code class="eh mn mo mp mq b">line 25</code>的<code class="eh mn mo mp mq b">coroutine_1()</code>和<code class="eh mn mo mp mq b">coroutine_2()</code>、调度在<code class="eh mn mo mp mq b">line 8</code>的<code class="eh mn mo mp mq b">asyncio.sleep(4)</code>和调度在<code class="eh mn mo mp mq b">line 17</code>的<code class="eh mn mo mp mq b">asyncio.sleep(5)</code>。</li><li id="a37f" class="nb nc if jp b jq nk ju nl jy nm kc nn kg no jm ng nh ni nj dt translated">在循环中调度任务的另一种方式(尽管不是立即)是使用<code class="eh mn mo mp mq b"><a class="ae np" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.ensure_future" rel="noopener ugc nofollow" target="_blank">ensure_future()</a></code>或<code class="eh mn mo mp mq b"><a class="ae np" href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.AbstractEventLoop.create_task" rel="noopener ugc nofollow" target="_blank">AbstractEventLoop.create_task()</a></code>方法，这两种方法都接受协程对象。最后的示例代码演示了这些方法。</li></ul><h2 id="f57b" class="kw kx if bd ky kz la lb lc ld le lf lg jy lh li lj kc lk ll lm kg ln lo lp lq dt translated">一个更现实但简单的例子</h2><figure class="mr ms mt mu fq hw"><div class="bz el l di"><div class="mv mw l"/></div><figcaption class="mx my fg fe ff mz na bd b be z ek">python run asyncio_example.py</figcaption></figure><h2 id="6661" class="kw kx if bd ky kz la lb lc ld le lf lg jy lh li lj kc lk ll lm kg ln lo lp lq dt translated">阿彻萨伯的蟒蛇</h2><p id="6005" class="pw-post-body-paragraph jn jo if jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj jm hn dt translated">在ArchSaber，我们的目标之一一直是从客户的应用程序代码中挖掘深刻的见解。我们的许多客户依赖于我们的Python APM解决方案。因此，我们尽最大努力去理解这门语言及其框架的复杂性。我们自己非常依赖Python——我们的许多分析引擎和ML代码都是用Python编写的，通过它我们可以对客户的生产问题进行实时根本原因分析。</p><blockquote class="jc"><p id="470c" class="jd je if bd jf jg nq nr ns nt nu jm ek translated">感谢阅读。如果你喜欢这个帖子，请订阅并分享。</p></blockquote><figure class="nv nw nx ny nz hw"><div class="bz el l di"><div class="oa mw l"/></div></figure></div></div>    
</body>
</html>