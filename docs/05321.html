<html>
<head>
<title>Scaling Effectively: when Kubernetes met Celery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有效扩展:当库本内特斯遇到芹菜</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/https-medium-com-talperetz24-scaling-effectively-when-kubernetes-met-celery-e6abd7ce4fed?source=collection_archive---------3-----------------------#2018-06-25">https://medium.com/hackernoon/https-medium-com-talperetz24-scaling-effectively-when-kubernetes-met-celery-e6abd7ce4fed?source=collection_archive---------3-----------------------#2018-06-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="eeaf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt jp translated">这是一个关于<strong class="it hv">软件</strong>T4】架构的故事，是一个关于个人之痒和可扩展性的故事。像任何好的科技故事一样，它始于一个摇摇欲坠的架构。</p></div><div class="ab cl jy jz hc ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hn ho hp hq hr"><p id="c42f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在<a class="kf kg gr" href="https://medium.com/u/3352818b2dd1?source=post_page-----e6abd7ce4fed--------------------------------" rel="noopener" target="_blank"> Panorays </a>，我们帮助大型企业衡量其供应商的安全状况。但是我不打算和你谈论整个第三方<a class="ae kh" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank">安全</a> <a class="ae kh" href="https://hackernoon.com/tagged/management" rel="noopener ugc nofollow" target="_blank">管理</a>的盛况。我们来谈谈我们的架构和流程。</p><p id="7d1c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt jp translated"><span class="l jq jr js bm jt ju jv jw jx di">在</span>开头，有bash。<br/>管理虚拟机的脚本。很多剧本。</p><ul class=""><li id="1ebb" class="ki kj hu it b iu iv iy iz jc kk jg kl jk km jo kn ko kp kq dt translated">我们评估的每家公司都有一个虚拟机实例。</li><li id="91be" class="ki kj hu it b iu kr iy ks jc kt jg ku jk kv jo kn ko kp kq dt translated">每个虚拟机都执行<strong class="it hv">顺序批处理作业</strong>，模拟黑客生命周期的整个侦察阶段。</li><li id="8f93" class="ki kj hu it b iu kr iy ks jc kt jg ku jk kv jo kn ko kp kq dt translated">公司级并行是通过启动更多虚拟机来实现的。</li><li id="b6c0" class="ki kj hu it b iu kr iy ks jc kt jg ku jk kv jo kn ko kp kq dt translated">我们通过Cron &amp; Bash构建了一个内部编排系统(想象一下那有多有趣……)。</li></ul><p id="7b4a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">问题:</p><ul class=""><li id="9ed9" class="ki kj hu it b iu iv iy iz jc kk jg kl jk km jo kn ko kp kq dt translated"><strong class="it hv">平行度</strong>是在公司层面，而不是在工作层面。</li><li id="b3b6" class="ki kj hu it b iu kr iy ks jc kt jg ku jk kv jo kn ko kp kq dt translated">这个过程并不透明。</li><li id="093a" class="ki kj hu it b iu kr iy ks jc kt jg ku jk kv jo kn ko kp kq dt translated">服务器<strong class="it hv">利用率</strong>很低。</li><li id="3d47" class="ki kj hu it b iu kr iy ks jc kt jg ku jk kv jo kn ko kp kq dt translated"><strong class="it hv">手动</strong>触发</li></ul><h1 id="91f0" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">运输者的崛起</h1><figure class="lv lw lx ly fq lz fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff lu"><img src="../Images/f647c8783feeee4d8944810676aa3802.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r6VX5egi8sI1XKSPY9a5-g.png"/></div></div><figcaption class="mg mh fg fe ff mi mj bd b be z ek">The Transporter</figcaption></figure><blockquote class="mk"><p id="5a8f" class="ml mm hu bd mn mo mp mq mr ms mt jo ek translated">一个动态工作流引擎，用于创建工作流并将其作为Kubernetes作业执行。</p></blockquote><p id="6c54" class="pw-post-body-paragraph ir is hu it b iu mu iw ix iy mv ja jb jc mw je jf jg mx ji jj jk my jm jn jo hn dt translated">基于容器的架构使得运输器既有足够的灵活性来单独配置工作，又有足够的效率来扩展。</p><p id="62b1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">根据工作流依赖关系，它在可能的情况下倾向于<strong class="it hv">并行</strong>，并为完全自动化的<strong class="it hv">流水线提供REST API。</strong></p><figure class="lv lw lx ly fq lz fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff mz"><img src="../Images/b84a3eb3210cef7e1380715a9ed92cc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C_yth7x1NsCI4GyzEC0xfQ.png"/></div></div><figcaption class="mg mh fg fe ff mi mj bd b be z ek">Standing on the Shoulders of Giants</figcaption></figure><p id="358e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每当有新公司加入平台时，就会自动触发运输商的API。然后，Transporter根据预定义的工作流，并行或顺序地将作业部署到kubernetes。</p><figure class="lv lw lx ly fq lz fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff na"><img src="../Images/e9e9dd3d442cea37f78efe3f3f2b4da9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1kRy9fZFks0xudv9bBcTOA.png"/></div></div><figcaption class="mg mh fg fe ff mi mj bd b be z ek">Overview</figcaption></figure><p id="fb87" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">与原始传输器一样，传输器遵循一些简单的规则:</p><figure class="lv lw lx ly fq lz fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff nb"><img src="../Images/ae939dd238d4011ffd89f107aed47f37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n_ObeYjpwpK1pQ_qrwwZDA.png"/></div></div><figcaption class="mg mh fg fe ff mi mj bd b be z ek">The Rules</figcaption></figure><h2 id="c458" class="nc kx hu bd ky nd ne nf lc ng nh ni lg jc nj nk lk jg nl nm lo jk nn no ls np dt translated">交易就是交易</h2><p id="e1fa" class="pw-post-body-paragraph ir is hu it b iu nq iw ix iy nr ja jb jc ns je jf jg nt ji jj jk nu jm jn jo hn dt translated">运输商的交易是你定义工作流程，运输商会让它发生。<br/>但是为了定义一个工作流，我们首先需要定义一个作业。</p><p id="52af" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们的例子中，<strong class="it hv">作业</strong>相当于运行一个<a class="ae kh" href="https://www.docker.com/what-container" rel="noopener ugc nofollow" target="_blank">码头集装箱</a>。<br/>一组这些作业是一个<strong class="it hv">阶段</strong>，一个阶段可以是顺序的或并行的。<br/>一个<strong class="it hv">工作流</strong>是一系列阶段。</p><p id="b7cb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我们可以享受并行，同时仍然遵循一些规则。</p><figure class="lv lw lx ly fq lz fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff nv"><img src="../Images/12ffef69055ecd1c437766d3c6140607.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oBUzZKWnFuI3UtlqOmflYg.png"/></div></div><figcaption class="mg mh fg fe ff mi mj bd b be z ek">Workflow Example</figcaption></figure><h2 id="02ac" class="nc kx hu bd ky nd ne nf lc ng nh ni lg jc nj nk lk jg nl nm lo jk nn no ls np dt translated">永远不要做出无法兑现的承诺</h2><p id="8997" class="pw-post-body-paragraph ir is hu it b iu nq iw ix iy nr ja jb jc ns je jf jg nt ji jj jk nu jm jn jo hn dt translated">传输器利用了一个<em class="nw">分布式任务队列架构</em>。<br/>在这种架构中，任务被传输到队列中，工人从队列中消费任务并执行这些任务。<br/>这种架构使得<strong class="it hv">重试</strong>失败的任务、<br/>设置<strong class="it hv">超时、</strong>设置<strong class="it hv">优先级</strong>、<strong class="it hv">将</strong>任务安排在以后。</p><p id="b820" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们发送<strong class="it hv">通知</strong>来提醒工作流的开始、成功和失败。</p><figure class="lv lw lx ly fq lz fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff nx"><img src="../Images/f19cf63d9261a85cf2869d154aa4bd84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CNAsbjZJ3P6Or-SrhCI0HQ.png"/></div></div><figcaption class="mg mh fg fe ff mi mj bd b be z ek">Distributed Task Queue Architecture</figcaption></figure><h2 id="a9e7" class="nc kx hu bd ky nd ne nf lc ng nh ni lg jc nj nk lk jg nl nm lo jk nn no ls np dt translated">在后台</h2><p id="6ab9" class="pw-post-body-paragraph ir is hu it b iu nq iw ix iy nr ja jb jc ns je jf jg nt ji jj jk nu jm jn jo hn dt translated">现在，我们已经准备好将它们连接在一起了—<br/>transporter提供端点来操作<strong class="it hv">工作流</strong> <br/>在幕后，工作流被转换成<a class="ae kh" href="http://www.celeryproject.org/" rel="noopener ugc nofollow" target="_blank"> Celery </a>任务。<br/>我们使用芹菜链和芹菜组来设置依赖关系。<br/>这些任务根据依赖关系传输到队列。<br/>在另一边，芹菜工消耗队列<br/>中的任务，并部署相应的<a class="ae kh" href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/" rel="noopener ugc nofollow" target="_blank">kubernetjob</a>。<br/>结果——根据工作相关性完成工作流程。</p><p id="fb96" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了方便起见，我们还添加了端点来控制<strong class="it hv">工人</strong>。<br/>正在运行的工作线程数量限制了可以同时运行的作业数量。</p><figure class="lv lw lx ly fq lz fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff ny"><img src="../Images/bf7ad9978f258cf0aad8413225cf8a0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RiW1LzRdZn5NewVkYN83Eg.png"/></div></div></figure><h2 id="42f2" class="nc kx hu bd ky nd ne nf lc ng nh ni lg jc nj nk lk jg nl nm lo jk nn no ls np dt translated">切勿打开(包装)容器</h2><p id="5c00" class="pw-post-body-paragraph ir is hu it b iu nq iw ix iy nr ja jb jc ns je jf jg nt ji jj jk nu jm jn jo hn dt translated">我们新的<strong class="it hv">部署</strong>流程包括安全研究人员构建<a class="ae kh" href="https://docs.docker.com/engine/reference/commandline/images/" rel="noopener ugc nofollow" target="_blank"> docker映像</a>并将其推送到<a class="kf kg gr" href="https://medium.com/u/4f3f4ee0f977?source=post_page-----e6abd7ce4fed--------------------------------" rel="noopener" target="_blank"> Google Cloud </a>注册表。<br/>传输器根据工作流程和定义每个作业版本的<a class="ae kh" href="https://kubernetes-v1-4.github.io/docs/user-guide/configmap/" rel="noopener ugc nofollow" target="_blank">配置图</a>传输相应的作业。Kubernetes是实际执行底层docker容器的引擎。</p><figure class="lv lw lx ly fq lz fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff nz"><img src="../Images/e08d0294c391a14b815ac1e522555ab5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TirZ6FPX6CUv_YUdntJIHA.png"/></div></div><figcaption class="mg mh fg fe ff mi mj bd b be z ek">Updating Jobs</figcaption></figure><h2 id="ee8b" class="nc kx hu bd ky nd ne nf lc ng nh ni lg jc nj nk lk jg nl nm lo jk nn no ls np dt translated">没有名字</h2><p id="4e4f" class="pw-post-body-paragraph ir is hu it b iu nq iw ix iy nr ja jb jc ns je jf jg nt ji jj jk nu jm jn jo hn dt translated">首先，我们将<a class="ae kh" href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/" rel="noopener ugc nofollow" target="_blank">kubernetjob</a>名称设置为与原始作业名称相同，并在末尾附加一个唯一的标识符。</p><figure class="lv lw lx ly fq lz fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff oa"><img src="../Images/e6809ce3e91a2c76196810d19006ca31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W6h7kJZFh-tunyeC8I0h5w.png"/></div></div><figcaption class="mg mh fg fe ff mi mj bd b be z ek">How <strong class="bd ob">Not </strong>to Name a Job</figcaption></figure><p id="83cf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就是我们如何发现一些<strong class="it hv"> Kubernetes命名限制</strong>:</p><figure class="lv lw lx ly fq lz fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff oc"><img src="../Images/69b6036706eb04713ad78f30751a2dd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TE-TAHjle-P2XtCenpe1qQ.png"/></div></div></figure><p id="2a0f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">第一个是用于验证名称的正则表达式作业名称基本上是由破折号或下划线分隔的字母数字字符<br/>我们发现了第二个限制——最大字符数<br/>多亏了我们的安全研究人员，他们喜欢长而过于详细的名称</p><p id="e821" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> #1提示</strong> -名称的唯一标识符。<br/>但我们仍然想知道最初的工作名称和公司名称，这让我想到了—<br/><strong class="it hv">【2号提示】</strong>—标签。到处都是标签。</p><h1 id="51c6" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">我们考虑的框架</h1><p id="8eb3" class="pw-post-body-paragraph ir is hu it b iu nq iw ix iy nr ja jb jc ns je jf jg nt ji jj jk nu jm jn jo hn dt translated">在实现我们自己的工作流引擎之前，我们检查了一些现有的解决方案。</p><ul class=""><li id="6a62" class="ki kj hu it b iu iv iy iz jc kk jg kl jk km jo kn ko kp kq dt translated"><a class="ae kh" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank">气流</a> -气流很大。它的工作原理是将python文件渲染成代表工作流的Dag。<br/>如果您有一个在运行前确定的静态工作流，您希望像ETL流一样执行，我建议尝试使用气流解决方案。Airflow的问题在于动态工作流——看看这个<a class="ae kh" href="https://stackoverflow.com/questions/41517798/proper-way-to-create-dynamic-workflows-in-airflow" rel="noopener ugc nofollow" target="_blank">在栈溢出时在airflow中创建动态工作流的正确方法</a>。<br/>我们决定不使用它的原因是我们需要生成动态工作流，它会根据我们的REST API请求而变化。</li><li id="c4f3" class="ki kj hu it b iu kr iy ks jc kt jg ku jk kv jo kn ko kp kq dt translated"><a class="ae kh" href="https://cloud.google.com/pubsub/docs/overview" rel="noopener ugc nofollow" target="_blank">Google Pub/Sub</a>——是Google的pub sub解决方案，我们没有使用它，因为它需要在所有“工作”方面进行大量的代码更改。</li><li id="a522" class="ki kj hu it b iu kr iy ks jc kt jg ku jk kv jo kn ko kp kq dt translated">你可以查看这个<a class="ae kh" href="https://www.fullstackpython.com/task-queues.html" rel="noopener ugc nofollow" target="_blank">任务队列帖子</a>以获得更多选择。</li></ul><h1 id="6caf" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">下一步是什么？</h1><p id="9ff2" class="pw-post-body-paragraph ir is hu it b iu nq iw ix iy nr ja jb jc ns je jf jg nt ji jj jk nu jm jn jo hn dt translated"><strong class="it hv"> UI </strong> —我们希望添加一个UI，以便于对活动和已完成的工作流进行监控和故障排除。</p><p id="16fb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通用化——如果我们把传送器做得更通用一点，也许我们可以把它作为开源软件发布。</p><h1 id="51ad" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">行动呼吁</h1><p id="5b3d" class="pw-post-body-paragraph ir is hu it b iu nq iw ix iy nr ja jb jc ns je jf jg nt ji jj jk nu jm jn jo hn dt translated">如果您有一个用例涉及到根据某些依赖关系运行批处理作业(例如数据采集、Web爬行系统)，并且您对使用<strong class="it hv">传输器</strong>进行扩展感兴趣，请<strong class="it hv">评论</strong>或<strong class="it hv">联系</strong>让我知道。</p><p id="e09f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你喜欢这篇文章，请按下鼓掌键👏🏽如果你对接下来的帖子感兴趣，一定要关注我</p><p id="d2a5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">中:</strong><a class="ae kh" rel="noopener" href="/@talperetz24"><strong class="it hv">https://medium.com/@talperetz24</strong></a><strong class="it hv"><br/>推特:</strong><a class="ae kh" href="https://twitter.com/talperetz24" rel="noopener ugc nofollow" target="_blank"><strong class="it hv">https://twitter.com/talperetz24</strong></a><strong class="it hv"><br/>领英:</strong><a class="ae kh" href="https://www.linkedin.com/in/tal-per/" rel="noopener ugc nofollow" target="_blank"><strong class="it hv">https://www.linkedin.com/in/tal-per/</strong></a></p><figure class="lv lw lx ly fq lz"><div class="bz el l di"><div class="od oe l"/></div></figure></div></div>    
</body>
</html>