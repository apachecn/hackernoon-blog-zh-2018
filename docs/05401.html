<html>
<head>
<title>How to Create a Workflow in Apache Airflow to Track Disease Outbreaks in India</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Apache Airflow中创建工作流来跟踪印度的疾病爆发</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-create-a-workflow-in-apache-airflow-to-track-disease-outbreaks-in-india-fd145575efa4?source=collection_archive---------13-----------------------#2018-06-27">https://medium.com/hackernoon/how-to-create-a-workflow-in-apache-airflow-to-track-disease-outbreaks-in-india-fd145575efa4?source=collection_archive---------13-----------------------#2018-06-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><blockquote class="ir is it"><p id="697d" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">我最初为<a class="ae jt" href="https://blog.socialcops.com/technology/data-science/apache-airflow-disease-outbreaks-india/" rel="noopener ugc nofollow" target="_blank"> SocialCops工程博客</a>写了这篇文章。</p></blockquote><p id="0d97" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">听到“气流”这个词时，你首先想到的是什么？数据工程，对吧？我想这是有原因的。你很可能会在每一篇讨论数据工程的博客文章中发现气流。</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff jx"><img src="../Images/04feeeebbaea96253b9957e7984b6367.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SJYEdGnpKTF9R6C2LB-zjw.jpeg"/></div></div></figure><p id="80b0" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated"><a class="ae jt" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Airflow </a>是一个工作流管理平台。简单来说，你可以把它想成cron，但是用了类固醇！它是由Airbnb的Maxime Beauchemin于2014年10月创办的。从第一次提交开始，Airflow就是开源的。不到一年后，它被搬进了Airbnb Github。从那时起，它已经成为数据工程生态系统中至关重要的一部分。</p><p id="ece2" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">一年多来，我们一直使用气流在我们的内部系统之间移动数据，在此期间，我们创建了许多ETL(提取-转换-加载)管道。在本帖中，我们将详细讨论其中一个管道，并向您展示设置步骤。</p><p id="241c" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated"><em class="iw">注意:我们不会讨论如何设置气流。你可以看看千里眼</em>  <em class="iw">的一个很棒的博客。</em></p><h1 id="c1e8" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">为什么要用气流？</h1><ul class=""><li id="4bfc" class="lh li hu ix b iy lj jc lk ju ll jv lm jw ln js lo lp lq lr dt translated"><strong class="ix hv">依赖管理:</strong>工作流可以定义为有向无环图(DAG)。Airflow将确保定义的任务一个接一个地执行，管理任务之间的依赖关系。</li><li id="3511" class="lh li hu ix b iy ls jc lt ju lu jv lv jw lw js lo lp lq lr dt translated"><strong class="ix hv">可扩展</strong> : Airflow提供了多种操作符，它们是工作流的构建块。PythonOperator就是一个例子，您可以使用它来编写将作为工作流的一部分运行的自定义Python代码。</li><li id="466e" class="lh li hu ix b iy ls jc lt ju lu jv lv jw lw js lo lp lq lr dt translated"><strong class="ix hv">可扩展</strong> : Celery，这是一个分布式任务队列，可以作为一个执行器来扩展你的工作流的执行。</li><li id="4169" class="lh li hu ix b iy ls jc lt ju lu jv lv jw lw js lo lp lq lr dt translated">开源:它正在Apache软件基金会孵化，这意味着它被积极地维护着。</li></ul><h1 id="4c00" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">IDSP:疾病数据来源</h1><p id="3eb9" class="pw-post-body-paragraph iu iv hu ix b iy lj ja jb jc lk je jf ju lx ji jj jv ly jm jn jw lz jq jr js hn dt translated">即使开放数据门户出现在多个领域，处理它们提供的数据集也很困难。在我们努力识别并帮助预防T21的疾病爆发时，我们遇到了一个如此困难的数据来源。</p><p id="71a6" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated"><a class="ae jt" href="https://mohfw.gov.in/" rel="noopener ugc nofollow" target="_blank">卫生和家庭事务部</a> (MHRD)运行着<a class="ae jt" href="http://www.idsp.nic.in/" rel="noopener ugc nofollow" target="_blank">综合疾病监测规划</a> (IDSP)计划，该计划在全印度的分区&amp;村一级识别疾病暴发。根据这一计划，MHRD以PDF文档的形式发布每周疫情数据。</p><p id="3edd" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">众所周知，pdf文件很难抓取并整合到数据科学工作流中，但只要看看IDSP PDFs文件就知道了。它们中的数据可能看起来是一种很好的表格格式，但是这些年来他们已经改变了表格格式，并且可能会继续这样做。我们还遇到了文档中的小故障，比如不同的表格被连接在一起，表格流出页面，甚至表格中的表格！</p><h1 id="4552" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">设置ETL管道</h1><p id="2ee7" class="pw-post-body-paragraph iu iv hu ix b iy lj ja jb jc lk je jf ju lx ji jj jv ly jm jn jw lz jq jr js hn dt translated">对于弄清楚我们的管道中涉及的步骤没有印象分。我们(<strong class="ix hv"> E </strong>)从IDSP网站提取pdf，(<strong class="ix hv"> T </strong>)将pdf转换成CSV文件，然后(<strong class="ix hv"> L </strong>)将这些CSV文件数据加载到一个存储中。</p><h1 id="a86b" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">约定</h1><p id="28df" class="pw-post-body-paragraph iu iv hu ix b iy lj ja jb jc lk je jf ju lx ji jj jv ly jm jn jw lz jq jr js hn dt translated">让我们现在建立一些公约，因为没有秩序，无政府状态将接踵而至！每个有向无环图应该有一个唯一的标识符。我们可以使用一个ID，它描述了我们的DAG正在做什么，再加上一个版本号。让我们将我们的DAG命名为idsp_v1。</p><p id="09bc" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated"><em class="iw">注意:我们从</em> <a class="ae jt" href="https://cwiki.apache.org/confluence/display/AIRFLOW/Common+Pitfalls" rel="noopener ugc nofollow" target="_blank"> <em class="iw">气流“常见陷阱”文档</em> </a> <em class="iw">中借用了这个命名约定。当您必须更改DAG的开始日期和计划间隔，同时保留旧版本的计划历史时，它会很方便。请务必查看此链接，了解其他常见的陷阱。</em></p><p id="3bf8" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">我们还将定义一个基本目录，用于保存所有DagRuns中的数据。你会问，DagRun是什么？它只是你的DAG在时间上的一个实例。我们还将为每个DagRun创建一个新目录。</p><p id="1035" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">这里有一个requirements.txt文件，您可以用它来安装依赖项。</p><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ma mb l"/></div></figure><h1 id="8dcf" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">如何DAG</h1><p id="e14c" class="pw-post-body-paragraph iu iv hu ix b iy lj ja jb jc lk je jf ju lx ji jj jv ly jm jn jw lz jq jr js hn dt translated">在Airflow中，dag被定义为Python文件。它们必须放置在<code class="eh mc md me mf b">dag_folder</code>内，这可以在气流配置文件中定义。基于我们上面定义的ETL步骤，让我们创建我们的DAG。</p><p id="26d4" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">我们将使用气流PythonOperator定义三个任务。您需要使用<code class="eh mc md me mf b">python_callable</code>关键字参数将包含任务逻辑的Python函数传递给每个操作符。现在在一个<strong class="ix hv"> utils.py </strong>文件中将这些定义为虚拟函数。我们稍后会逐一介绍。</p><p id="76d5" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">我们还将使用<code class="eh mc md me mf b">set_downstream</code>方法将它们链接在一起。这将定义我们的任务执行的顺序。请注意，我们还没有定义将在任务内部运行的逻辑，但是我们的DAG已经准备好运行了！</p><p id="450c" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">看看DAG文件。我们已经将<code class="eh mc md me mf b">schedule_interval</code>设置为<code class="eh mc md me mf b">0 0 * * 2</code>。是的，你猜对了——这是一个cron字符串。这意味着我们的DAG将在每周二上午12点运行。气流调度可能有点混乱，所以我们建议你查看<a class="ae jt" href="https://airflow.apache.org/scheduler.html#scheduling-triggers" rel="noopener ugc nofollow" target="_blank">气流文档</a>以了解它是如何工作的。</p><p id="abe2" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">我们还将<code class="eh mc md me mf b">provide_context</code>设置为<code class="eh mc md me mf b">True</code>，因为我们希望气流通过DagRun的上下文(想想元数据，比如dag_id、execution_date等。)作为关键字参数添加到我们的任务函数中。</p><p id="1711" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated"><em class="iw">注意:我们将使用来自上下文的execution_date(这是一个Python datetime对象)将气流传递到我们的函数中，以创建一个新的目录，就像我们上面讨论的那样，来存储DagRun的数据。</em></p><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ma mb l"/></div></figure><p id="1598" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">此时，您可以通过在命令行上执行<code class="eh mc md me mf b">airflow trigger_dag idsp_v1</code>来创建DAG运行。确保在创建DagRun之前转到Airflow UI并取消暂停DAG。DagRun应该是成功的，因为我们的任务只是虚拟函数。</p><p id="a7bc" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">现在我们已经准备好了DAG文件，让我们看看将在我们的任务中运行的逻辑。</p><p id="11b3" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated"><em class="iw">注意:在传递给PythonOperator的函数中，打印到标准输出</em> <em class="iw">的所有内容都可以在Airflow UI上看到。只需在相应运营商的DAG节点中单击查看日志。</em></p><h1 id="4ede" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">抓取IDSP网站</h1><p id="563a" class="pw-post-body-paragraph iu iv hu ix b iy lj ja jb jc lk je jf ju lx ji jj jv ly jm jn jw lz jq jr js hn dt translated">IDSP网站几乎每周都会发布一份新的PDF文档(有些滞后)。我们不能每次发布一个新的pdf文件就把所有的pdf文件都删掉。相反，我们将不得不保存我们最后刮到的PDF的周数。</p><p id="0d19" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">我们可以在每个DagRun结束时将此状态存储在基本目录中的CSV文件中，并在另一个Dag run开始时引用它。看一下刮码。这里没有什么新奇的东西，只是使用<em class="iw">请求</em>和<em class="iw"> lxml </em>的普通web抓取。</p><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ma mb l"/></div></figure><p id="9f24" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated"><em class="iw">注意:在生产中，我们不运行气流内部的刮码。它运行在一个单独的服务上，除了运行这些刮刀之外，该服务还可以连接到REST/SOAP API来提取数据。这为我们提供了一个中心位置来安排和跟踪数据是如何被拉入我们的平台的。任务逻辑被替换为对数据导出服务的调用。</em></p><h1 id="a404" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">抓取pdf</h1><p id="0950" class="pw-post-body-paragraph iu iv hu ix b iy lj ja jb jc lk je jf ju lx ji jj jv ly jm jn jw lz jq jr js hn dt translated">耶！既然我们有了新的pdf，我们就可以着手清理它们了。我们将使用<em class="iw"> pdfminer </em>来完成这项工作。</p><p id="42f4" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">但是首先，让我指出PDF是表格数据最差的格式。PDF包含PDF查看者在2D平面的特定X，Y坐标上以所需字体放置文本的说明。如果我们只需要从PDF中获取文本，这没有关系，但是如果我们需要完整地获取表格结构的表格数据，这就变得很困难。我们在这里使用一个简单的试探法来获取这些数据。</p><p id="2b1d" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">首先，我们使用<em class="iw"> pdfminer </em>提取所有文本对象。一个文本对象包含一个字符串和一个浮点坐标元组，它描述了字符串的位置。然后，我们按照X和Y递增的顺序对所有这些对象进行排序。现在，从最后一行开始，所有这些文本对象都是以行为主的格式。我们可以根据它们在x轴上的投影将它们分组到不同的列中，从而丢弃跨越多列的任何对象。我们可以删除第一列和最后一列，因为它们在这篇文章中没有任何用处。</p><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ma mb l"/></div></figure><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff mg"><img src="../Images/bcf7c43e663c20a344d43e96aa1594bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eGYiG5CwNqCZ8Lcc.png"/></div></div></figure><p id="dd0e" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">瞧，我们有桌子了！它仍然不能使用，但需要一些小清洗。我们把这个作为练习留给你。很容易在代码中定义一些规则来将上面的CSV转换成更干净的东西，如下所示。</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff mh"><img src="../Images/0db850767bde73f05c144c1f8c3b2fab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SDRHOyMm8uBXvl8B.png"/></div></div></figure><p id="0430" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">您可以将这个清理代码添加为另一个PythonOperator或同一个<code class="eh mc md me mf b">scrape_pdf</code>操作符。如果您不习惯使用Python，而是想使用R，那么您可以使用BashOperator来调用您的R脚本。扩展性FTW！</p><p id="ee72" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated"><em class="iw">注意:使用单一工具很难在所有类型的PDF上获得100%的表格刮擦准确性。我们可以用各种试探法来解决问题，希望得到最好的结果。通常需要清洁步骤。</em></p><p id="93fa" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated"><em class="iw">当我们在准备IDSP数据集的过程中，使用所有以前年份的pdf时，我们找不到任何可以解决这个问题的工具/库。我们尝试了很多开源工具像</em> <a class="ae jt" href="https://tabula.technology/" rel="noopener ugc nofollow" target="_blank"> <em class="iw"> Tabula </em> </a> <em class="iw">，以及闭源工具像</em><a class="ae jt" href="https://pdftables.com/" rel="noopener ugc nofollow" target="_blank"><em class="iw">pdf tables</em></a><em class="iw">都没有成功。</em></p><p id="423d" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated"><em class="iw">这让我们开发了自己的库，它使用图像识别和一系列试探法来尝试解决PDF表格抓取问题。它在许多PDF类型上给了我们一个可接受的刮擦精度，包括IDSP类型。一旦我们将它插入到我们的数据清理产品中，</em> <a class="ae jt" href="https://socialcops.com/transform/" rel="noopener ugc nofollow" target="_blank"> <em class="iw">转换</em> </a> <em class="iw">，我们最终可以将PDF数据转换成完全干净的CSV格式。</em></p><p id="57b6" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated"><strong class="ix hv"> <em class="iw">更新(2018年10月5日):</em> </strong> <em class="iw">我们发布了</em> <a class="ae jt" href="https://blog.socialcops.com/technology/engineering/camelot-python-library-pdf-data/" rel="noopener ugc nofollow" target="_blank"> <em class="iw"> Camelot，一个帮助任何人从pdf</em></a><em class="iw">中提取表格数据的Python库。你可以在这个</em> <a class="ae jt" href="https://gist.github.com/vinayak-mehta/e5949f7c2410a0e12f25d3682dc9e873" rel="noopener ugc nofollow" target="_blank"> <em class="iw"> Jupyter笔记本中找到这篇博文中提供的使用Camelot的代码版本。</em>T15】</a></p><h1 id="0c41" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">管理收集的数据</h1><p id="05b0" class="pw-post-body-paragraph iu iv hu ix b iy lj ja jb jc lk je jf ju lx ji jj jv ly jm jn jw lz jq jr js hn dt translated">现在我们有了一个干净的CSV，我们可以将它添加到我们的主IDSP数据集。该操作符只包含一个for循环，它将页面CSV追加到我们的主CSV数据集。我们可以在这里使用<a class="ae jt" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank"> pandas </a>,但是我们不想仅仅为这个append添加另一个需求。</p><figure class="jy jz ka kb fq kc"><div class="bz el l di"><div class="ma mb l"/></div></figure><p id="bda7" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">在内部，我们的ETL管道并没有就此停止。我们通过实体识别系统传递之前删除的“评论”栏中的文本，这为我们提供了疫情发生的地理位置列表。然后，这将用于向我们的团队和客户发送警报。</p><h1 id="48ae" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">从这里你能去哪里？</h1><p id="f570" class="pw-post-body-paragraph iu iv hu ix b iy lj ja jb jc lk je jf ju lx ji jj jv ly jm jn jw lz jq jr js hn dt translated">恭喜你。你有一个定期更新的疾病爆发数据集！现在该由你来决定如何使用它了。<em class="iw">咳嗽</em>预测分析<em class="iw">咳嗽。</em>你可以替换刮码从其他任何网站刮数据，写到run目录，插上PDF刮算子(如果你刮的数据是PDF格式的)，或者插上一堆自己的算子做任何事情。</p><p id="f8bb" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">你可以在这里找到这个练习<a class="ae jt" href="https://github.com/socialcopsdev/airflow_blog" rel="noopener ugc nofollow" target="_blank">的完整代码报告。</a></p><p id="2595" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">如果你真的扩展了这条DAG，请发<a class="ae jt" href="https://twitter.com/social_cops" rel="noopener ugc nofollow" target="_blank">微博给我们</a>。我们很想听听你做了什么！</p><p id="0eeb" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf ju jh ji jj jv jl jm jn jw jp jq jr js hn dt translated">抓住数据！</p></div></div>    
</body>
</html>