<html>
<head>
<title>Build a Google Home App with PubNub Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">建立一个具有PubNub功能的Google Home应用程序</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/build-a-google-home-app-with-pubnub-functions-10188479699d?source=collection_archive---------14-----------------------#2018-06-30">https://medium.com/hackernoon/build-a-google-home-app-with-pubnub-functions-10188479699d?source=collection_archive---------14-----------------------#2018-06-30</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/be63bc8bcb76a4b17b71870199fff730.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QZp6dfcYICJ_h02i.png"/></div></div></figure><div class=""/><p id="2ad0" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">人工智能驱动的语音应用程序已经成为最近智能家居运动的关键角色。借助谷歌的Dialogflow，开发者可以快速创建对话式应用，为用户完成任务提供便利。然而，Dialogflow没有提供的是一个易于实现的服务器，它允许开发人员使用用户数据执行某些功能。</p><p id="a611" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这个演示中，我们将利用PubNub函数和Dialogflow来创建一个示例应用程序，根据用户当前的心情为他们播放正确的音乐。Dialogflow不提供任何分析用户语音输入情绪的手段，但通过PubNub函数和我们的<a class="ae ka" href="https://www.pubnub.com/docs/blocks-catalog/amazon-comprehend" rel="noopener ugc nofollow" target="_blank">Amazon imperstand BLOCK</a>，开发人员可以轻松分析用户语音输入的情绪，并根据结果执行特定的操作。</p><figure class="kb kc kd ke fq hw"><div class="bz el l di"><div class="kf kg l"/></div><figcaption class="kh ki fg fe ff kj kk bd b be z ek">Demo of MoodTunes</figcaption></figure><h1 id="55a0" class="kl km if bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li dt translated">教程概述</h1><p id="bcaa" class="pw-post-body-paragraph jc jd if je b jf lj jh ji jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz hn dt translated">一旦我们的演示应用MoodTunes被激活，它会问用户“嘿，怎么了？”用户将用一两句话来描述他们的整体情绪。然后，该应用程序将获得用户的语音输入，并对其进行分析，以使用理解块来确定用户的情绪。</p><p id="f111" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最后，它会将情绪分为真正积极、稍微积极、稍微消极或真正消极。下图显示了应用程序的结构和测试响应。</p><figure class="kb kc kd ke fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lo"><img src="../Images/3bb27813a25c3b927ef8d6d363a57ddf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bG0JRGEclqbqACkp.png"/></div></div></figure><h1 id="e764" class="kl km if bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li dt translated">初始设置</h1><p id="a469" class="pw-post-body-paragraph jc jd if je b jf lj jh ji jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz hn dt translated">我们的第一步将是在<a class="ae ka" href="https://console.dialogflow.com/" rel="noopener ugc nofollow" target="_blank"> Dialogflow控制台</a>上创建一个新的<strong class="je ig">代理</strong>。代理是你的应用程序的术语，因为它帮助用户执行某个动作。</p><p id="4775" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们命名我们的代理<strong class="je ig">情绪曲调</strong>。</p><p id="6a06" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">默认情况下，这个新代理将有两个意图:<strong class="je ig">默认回退意图</strong>和<strong class="je ig">默认欢迎意图</strong>。把意图想象成当用户说出某个短语时触发的整个对话的一个特定部分。当用户通过说出“与(座席名称)交谈”来调用您的应用程序时，会触发默认的欢迎意图；当用户说出应用程序不理解或未经培训无法响应的内容时，会触发默认的回退意图。</p><p id="8856" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对于我们的演示，我们将只使用两个意图:默认的欢迎意图和另一个我们将创建的名为<strong class="je ig"> Get_Emotion的意图。</strong>在我们默认的欢迎意图中，我们将添加一个标准的文本响应“嘿，怎么了？”，这将提示用户用一两句话描述他们的感受。</p><figure class="kb kc kd ke fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lp"><img src="../Images/b719bb1fb254c95393d0081558d0e5f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9mmTt2jEFjHjGe5g.png"/></div></div></figure><p id="04a1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这个新的演讲将会引发我们新的情绪。要创建新的意向，请单击控制台侧面导航栏上的加号按钮。我们希望我们的用户能够说出任何没有特定模式的句子来触发我们的Get_Emotion意图。因此，我们必须在意图的训练短语部分中指定这一点。我们将通过单击<strong class="je ig">"图标</strong>将其更改为<strong class="je ig"> @图标</strong>，然后键入<strong class="je ig"> @sys.any:any来完成此操作。</strong></p><figure class="kb kc kd ke fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lq"><img src="../Images/a658eea82e274921fcafeda7420ca327.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W1nfCmitZ5tVz4Wb.png"/></div></div></figure><p id="c04d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最后，我们必须向下滚动到fulfillment部分，并单击切换按钮<strong class="je ig">为Get_Emotion意图启用webhook调用</strong>。webhook调用将允许我们在Dialogflow应用程序和PubNub functions服务器之间建立连接，这样我们的功能就可以在用户描述他们的感受后被激活。</p><p id="9e33" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在我们将前往<a class="ae ka" href="https://admin.pubnub.com/" rel="noopener ugc nofollow" target="_blank"> PubNub管理仪表板</a>，创建一个名为MoodTunes的新项目。在这个新项目中，我们将导航到侧栏并单击functions。这里，我们将创建一个名为<strong class="je ig">音乐播放器</strong>的模块，并在该模块中创建一个<strong class="je ig"> onRequest </strong>函数，我们称之为<strong class="je ig"> playmusic </strong>。单击复制URL按钮复制函数的路径。然后，我们会将此URL粘贴到我们的Dialogflow应用程序的fulfillment选项卡中，在Webhook下显示URL的位置。</p><figure class="kb kc kd ke fq hw fe ff paragraph-image"><div class="fe ff lr"><img src="../Images/e9d8a470ec79aee62cf81e1fb1658470.png" data-original-src="https://miro.medium.com/v2/resize:fit:778/format:webp/0*WfrQAUnp54tGjjse.png"/></div></figure><figure class="kb kc kd ke fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ls"><img src="../Images/68aaafccba3f50aafb2a19512736e5f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*78osgFSzd2Ijhqbr.png"/></div></div></figure><p id="6c1c" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，我们已经成功地设置了我们的Dialogflow应用程序，并通过webhook将其连接到我们的PubNub函数。在本教程的剩余部分，我们将在PubNub函数编辑器中编写应用程序的JavaScript代码。</p><h1 id="8291" class="kl km if bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li dt translated">PubNub函数</h1><p id="bb1e" class="pw-post-body-paragraph jc jd if je b jf lj jh ji jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz hn dt translated">我们可以将PubNub函数分解为三个部分。</p><ol class=""><li id="fbd4" class="lt lu if je b jf jg jj jk jn lv jr lw jv lx jz ly lz ma mb dt translated">从Dialogflow接收webhook请求</li><li id="aeda" class="lt lu if je b jf mc jj md jn me jr mf jv mg jz ly lz ma mb dt translated">处理来自请求的数据</li><li id="f752" class="lt lu if je b jf mc jj md jn me jr mf jv mg jz ly lz ma mb dt translated">正在形成发送到对话流的响应</li></ol><p id="83f9" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我们的PubNub函数中，我们有两个参数，<code class="eh mh mi mj mk b">request</code>和<code class="eh mh mi mj mk b">response</code>。来自Dialogflow的请求将采用JSON的形式，它包含我们必须提取的用户语音输入。根据Google的文档，JSON请求的结构如下所示。</p><figure class="kb kc kd ke fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ml"><img src="../Images/d967e03a3c0bcc02139ec55fac665b4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wmzVEdc5V6IsHeNR.png"/></div></div></figure><p id="362b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了从这个请求中获得queryText值，我们必须首先解析它的主体，使它采用正确的JSON格式。我们将使用<code class="eh mh mi mj mk b">JSON.parse()</code>来做到这一点。既然它是正确的JSON格式，我们可以提取<code class="eh mh mi mj mk b">queryResult</code>值，然后提取<code class="eh mh mi mj mk b">queryText</code>值。这显示在下面的行中。</p><pre class="kb kc kd ke fq mm mk mn mo aw mp dt"><span id="206e" class="mq km if mk b fv mr ms l mt mu">var text = JSON.parse(request.body).queryResult.queryText;</span></pre><p id="902e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，我们有了对用户语音输入的引用，下一步是处理这些数据。我们将通过将它传递到我们的Amazon理解块中来实现这一点。要将块添加到项目中，请单击加号按钮，系统会提示您将函数添加到模块中。我们将我们的函数命名为<strong class="je ig">Amazon understand</strong>，并将事件类型设置为<strong class="je ig"> onRequest </strong>。然后将URL路径设置为<strong class="je ig"> amazoncomprehend </strong>。默认的Amazon understand块代码是针对发布前处理程序的。然而，我们希望我们的块是一个OnRequest处理程序，所以将这个<a class="ae ka" href="https://github.com/kaushikravikumar/MoodTunes/blob/master/amazoncomprehend-function.js" rel="noopener ugc nofollow" target="_blank">代码</a>复制并粘贴到您的编辑器中。</p><figure class="kb kc kd ke fq hw fe ff paragraph-image"><div class="fe ff mv"><img src="../Images/ed2b98de876e899220290974f300a7f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/0*iiA_lqlvu8QzOMbu.png"/></div></figure><figure class="kb kc kd ke fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mw"><img src="../Images/e7d354c98cc7f31879061cd4d84a3b36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0WpRgU0kK6yVI4a-.png"/></div></div></figure><p id="b1e8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，如果您还没有AWS帐户，我们将创建一个。我们需要获得以下凭证:理解<strong class="je ig">访问密钥</strong>和<strong class="je ig">秘密密钥</strong> ( <a class="ae ka" href="https://docs.aws.amazon.com/comprehend/latest/dg/comprehend-api-permissions-ref.html" rel="noopener ugc nofollow" target="_blank">在此了解如何</a>)。一旦我们有了这些凭证，我们将把它们输入到PubNub的<strong class="je ig"> My Secrets </strong>键值存储中。你可以在你的模块视图的左侧一个标有“我的秘密”的大按钮中找到它访问密钥的密钥必须是<strong class="je ig"> AWS_access_key </strong>，秘密密钥的密钥必须是<strong class="je ig"> AWS_secret_key </strong>。然后输入相应的值并点击<strong class="je ig">保存</strong>，这样您就知道您的凭证在您的功能代码中的vault reference是正确的。</p><p id="4320" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">设置好Amazon understand函数后，我们现在必须使用PubNub函数提供的<strong class="je ig"> xhr模块</strong>向它发出HTTP请求。使用<code class="eh mh mi mj mk b">xhr.fetch</code>方法，我们可以向指定的URL发出HTTP请求，同时传递一个定义了类型、主体参数和头参数的对象。从Amazon understand函数上的copy URL按钮获取URL，并将其存储在变量<code class="eh mh mi mj mk b">amazon_url</code>中。在下面的代码中，我们的<code class="eh mh mi mj mk b">amazon_request_options</code>为HTTP请求定义了必要的参数。</p><p id="0fcc" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们在键中传递我们想要分析的文本，<code class="eh mh mi mj mk b">speechInput</code>。我们还必须在名为<code class="eh mh mi mj mk b">comprehend</code>的字段中指定键<code class="eh mh mi mj mk b">language</code>和<code class="eh mh mi mj mk b">location</code>。语言就是文本所在的语言(en代表英语)，位置是请求中保存要分析的文本的键的名称(在我们的例子中是speechInput)。我们还必须指定POST请求的类型，作为<code class="eh mh mi mj mk b">method</code>键的值。将amazon_url和amazon_request_options对象传递到xhr.fetch方法中，我们使用一个承诺来获得对HTTP请求的JSON响应，一旦它准备好了。</p><figure class="kb kc kd ke fq hw"><div class="bz el l di"><div class="mx kg l"/></div></figure><p id="2c55" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">既然我们已经将我们的响应存储在变量<code class="eh mh mi mj mk b">sentiment_response</code>中，我们现在必须解析它，这样我们就可以获得用户语音输入的积极程度。JSON响应的主体应该包含一个字段<code class="eh mh mi mj mk b">sentiment</code>，该字段将包含键<code class="eh mh mi mj mk b">SentimentScore</code>，该键将包含键<code class="eh mh mi mj mk b">Positive</code>。如果您使用控制台记录响应的主体，就可以看到这一点。因此，为了获得这个从0到1的数值来显示用户语音输入的积极程度，我们必须使用下面的代码行。</p><figure class="kb kc kd ke fq hw"><div class="bz el l di"><div class="mx kg l"/></div></figure><p id="8297" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，我们将使用这个值和if-else逻辑来选择为用户播放哪首歌曲。如前所述，如果<code class="eh mh mi mj mk b">positive_measure</code>大于0.75，我们将播放我们真正积极的歌曲。在0.5到0.75之间的情况下，我们就放我们稍微积极一点的歌。如果它在0.25和0.5之间，我们将播放我们稍微消极的歌曲，如果它小于0.25，我们播放我们真正消极的歌曲。相应的歌曲都存放在我的GitHub项目中，位于下面代码片段所示的URL下。</p><figure class="kb kc kd ke fq hw"><div class="bz el l di"><div class="mx kg l"/></div></figure><p id="d6df" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">完成对用户语音输入的分析后，我们为应用程序的最后一步做好了准备，这就是形成发送到Dialogflow的响应。在这个响应中，我们需要传递将在Google Home设备上播放正确歌曲的URL。按照Google文档中的规定，该响应必须类似于以下格式。</p><figure class="kb kc kd ke fq hw fe ff paragraph-image"><div class="fe ff my"><img src="../Images/481fa10a94daa7a8bb55546f2ada5c26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/0*yL6ZMIsxPj4z2Daw.png"/></div></figure><p id="ee8e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我们的例子中，键<code class="eh mh mi mj mk b">expectUserResponse</code>的值应该为false，因为音乐的播放是用户与我们应用程序对话的结束。此外，我们将有我们的<code class="eh mh mi mj mk b">simpleResponse</code>，让用户知道他们的音乐正在播放。我们还将包括一个<code class="eh mh mi mj mk b">mediaResponse</code>字段，它将包含一个<code class="eh mh mi mj mk b">mediaObjects</code>数组，带有键<code class="eh mh mi mj mk b">name</code>、<code class="eh mh mi mj mk b">description</code>和<code class="eh mh mi mj mk b">contentUrl</code>。</p><p id="c56b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">按键名称和描述将用于音乐播放器视图，当用户在带有显示屏的谷歌助手设备上使用我们的应用程序时，该视图会显示出来。contentUrl将是我们要播放的歌曲的Url(我们将把它设置为我们之前设置的变量song_url)。根据Google的文档，在richResponse中，我们必须包含一个<code class="eh mh mi mj mk b">suggestions</code>数组。然而，由于它与我们的应用程序无关，我们将把它作为一个空数组。这个JSON响应必须是一个字符串，因为<code class="eh mh mi mj mk b">response.send</code>只接受字符串，所以我们将使用方法<code class="eh mh mi mj mk b">JSON.stringify</code>。这些都显示在下面的代码中。</p><figure class="kb kc kd ke fq hw"><div class="bz el l di"><div class="mx kg l"/></div></figure><h1 id="ff51" class="kl km if bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li dt translated">恭喜你。</h1><p id="3f67" class="pw-post-body-paragraph jc jd if je b jf lj jh ji jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz hn dt translated">现在，我们已经通过Dialogflow webhook请求获得了用户的语音输入，使用PubNub函数的Amazon intensive块分析了它的情绪，并形成了播放符合用户情绪的歌曲的响应，我们已经完成了MoodTunes。</p><p id="214f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您正在测试您的应用程序，请确保您已经启动了您的功能模块，以便服务器端代码能够实时运行和部署。为了在Google Home设备上测试你的应用，确保你已经完成了这些<a class="ae ka" href="https://developers.google.com/actions/smarthome/testing-deploying" rel="noopener ugc nofollow" target="_blank">步骤</a>。点击这里查看<a class="ae ka" href="https://github.com/kaushikravikumar/MoodTunes" rel="noopener ugc nofollow" target="_blank">完整源代码</a>。</p></div></div>    
</body>
</html>