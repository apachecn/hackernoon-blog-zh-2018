<html>
<head>
<title>Quickly spin up an AWS EKS Kubernetes cluster using CloudFormation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CloudFormation快速启动AWS EKS Kubernetes集群</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/quickly-spin-up-an-aws-eks-kubernetes-cluster-using-cloudformation-3d59c56b292e?source=collection_archive---------3-----------------------#2018-07-02">https://medium.com/hackernoon/quickly-spin-up-an-aws-eks-kubernetes-cluster-using-cloudformation-3d59c56b292e?source=collection_archive---------3-----------------------#2018-07-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="9571" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">现在AWS <a class="ae jj" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank"> EKS </a>已经全面上市，是时候试一试了…</h2></div><figure class="jl jm jn jo fq jp fe ff paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="fe ff jk"><img src="../Images/8455117c19b134c27a9edd09c3783c6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QFp_axJSQoKRqVkMOrzuxg.png"/></div></div></figure><p id="8aee" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">我使用AWS弹性集装箱服务(<a class="ae jj" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank"> ECS </a>)已经有几年了，我非常喜欢Docker和集装箱管理。滚动部署、微服务、CI/CD管道等等……有什么不喜欢的？</p><p id="bada" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">虽然Kubernetes 似乎是容器管理的大赢家……现在AWS <a class="ae jj" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank"> EKS </a>已经普遍推出，是时候尝试一下了。</p><p id="3e94" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">所以我就这么做了。</p><p id="a85a" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">在本教程中，我将向您展示如何使用CloudFormation快速启动AWS EKS Kubernetes集群。</p><p id="1f3b" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">代码如下:</p><ul class=""><li id="4cb1" class="ks kt hu jy b jz ka kc kd kf ku kj kv kn kw kr kx ky kz la dt translated"><a class="ae jj" href="https://github.com/thestacks-io/eks-cluster" rel="noopener ugc nofollow" target="_blank">https://github.com/thestacks-io/eks-cluster</a></li><li id="3c96" class="ks kt hu jy b jz lb kc lc kf ld kj le kn lf kr kx ky kz la dt translated"><a class="ae jj" href="https://github.com/thestacks-io/eks-microservice" rel="noopener ugc nofollow" target="_blank">https://github.com/thestacks-io/eks-microservice</a></li></ul><p id="0cb1" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">首先让我们启动EKS集群，然后我们可以部署我们的第一个微服务。</p><h1 id="eb34" class="lg lh hu bd li lj lk ll lm ln lo lp lq ja lr jb ls jd lt je lu jg lv jh lw lx dt translated">先决条件</h1><p id="109f" class="pw-post-body-paragraph jw jx hu jy b jz ly iv kb kc lz iy ke kf ma kh ki kj mb kl km kn mc kp kq kr hn dt translated">在开始之前，我们需要设置一些帐户和命令行实用程序:</p><ul class=""><li id="f355" class="ks kt hu jy b jz ka kc kd kf ku kj kv kn kw kr kx ky kz la dt translated"><a class="ae jj" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> AWS账户</a></li><li id="917c" class="ks kt hu jy b jz lb kc lc kf ld kj le kn lf kr kx ky kz la dt translated"><a class="ae jj" href="https://console.aws.amazon.com/ec2/v2/home" rel="noopener ugc nofollow" target="_blank"> EC2密钥对</a> —如果您还没有EC2密钥对，请创建一个。</li><li id="66d1" class="ks kt hu jy b jz lb kc lc kf ld kj le kn lf kr kx ky kz la dt translated"><a class="ae jj" href="https://cim.sh/" rel="noopener ugc nofollow" target="_blank"> cim.sh </a> — <code class="eh md me mf mg b">npm install -g cim</code></li><li id="6ae4" class="ks kt hu jy b jz lb kc lc kf ld kj le kn lf kr kx ky kz la dt translated"><a class="ae jj" href="https://docs.aws.amazon.com/cli/latest/userguide/installing.html" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a> —亚马逊EKS要求AWS CLI版本至少为1.15.32</li><li id="2243" class="ks kt hu jy b jz lb kc lc kf ld kj le kn lf kr kx ky kz la dt translated"><a class="ae jj" href="https://docs.aws.amazon.com/eks/latest/userguide/getting-started.html?shortFooter=true#eks-prereqs" rel="noopener ugc nofollow" target="_blank">kube CTL&amp;heptio-authenticator-AWS</a></li></ul><h1 id="656e" class="lg lh hu bd li lj lk ll lm ln lo lp lq ja lr jb ls jd lt je lu jg lv jh lw lx dt translated">AWS EKS集群</h1><p id="c744" class="pw-post-body-paragraph jw jx hu jy b jz ly iv kb kc lz iy ke kf ma kh ki kj mb kl km kn mc kp kq kr hn dt translated">分叉这个回购，在本地克隆。<a class="ae jj" href="https://github.com/thestacks-io/eks-cluster" rel="noopener ugc nofollow" target="_blank">https://github.com/thestacks-io/eks-cluster</a></p><p id="e7f1" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">这个项目包含3个CloudFormation脚本。它们必须按顺序创建，因为它们相互依赖:</p><ol class=""><li id="a71f" class="ks kt hu jy b jz ka kc kd kf ku kj kv kn kw kr mh ky kz la dt translated">VPC</li><li id="d953" class="ks kt hu jy b jz lb kc lc kf ld kj le kn lf kr mh ky kz la dt translated">库伯内特斯集群(EKS)</li><li id="0278" class="ks kt hu jy b jz lb kc lc kf ld kj le kn lf kr mh ky kz la dt translated">工作节点(EC2)</li></ol><h2 id="e67a" class="mi lh hu bd li mj mk ml lm mm mn mo lq kf mp mq ls kj mr ms lu kn mt mu lw mv dt translated">VPC</h2><p id="6496" class="pw-post-body-paragraph jw jx hu jy b jz ly iv kb kc lz iy ke kf ma kh ki kj mb kl km kn mc kp kq kr hn dt translated">这就创建了亚马逊虚拟私有云，我们的Kubernetes集群将在其中运行。</p><blockquote class="mw mx my"><p id="467a" class="jw jx mz jy b jz ka iv kb kc kd iy ke na kg kh ki nb kk kl km nc ko kp kq kr hn dt translated"><em class="hu">亚马逊虚拟专用云(亚马逊VPC)允许您提供AWS云的逻辑隔离部分，您可以在您定义的虚拟网络中启动AWS资源。</em></p></blockquote><p id="5bd7" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">更新<a class="ae jj" href="https://github.com/thestacks-io/eks-cluster/blob/master/vpc/_cim.yml" rel="noopener ugc nofollow" target="_blank"> vpc/_cim.yml </a>文件并添加您的<code class="eh md me mf mg b">KeyPairName</code> CloudFormation输入参数。还要记下堆栈名称。这需要作为其他CloudFormation脚本的输入参数。这就是我们在脚本之间共享基础设施的方式。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="d5fd" class="mi lh hu mg b fv nh ni l nj nk">cd vpc<br/>cim stack-up</span></pre><h2 id="4002" class="mi lh hu bd li mj mk ml lm mm mn mo lq kf mp mq ls kj mr ms lu kn mt mu lw mv dt translated">串</h2><p id="b440" class="pw-post-body-paragraph jw jx hu jy b jz ly iv kb kc lz iy ke kf ma kh ki kj mb kl km kn mc kp kq kr hn dt translated">这就创建了我们的工作节点将与之关联的<a class="ae jj" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank"> AWS Kubernetes EKS集群</a>。</p><blockquote class="mw mx my"><p id="4511" class="jw jx mz jy b jz ka iv kb kc kd iy ke na kg kh ki nb kk kl km nc ko kp kq kr hn dt translated"><em class="hu">针对Kubernetes的亚马逊弹性容器服务(亚马逊EKS)使得在AWS上使用Kubernetes来部署、管理和扩展容器化应用变得容易。</em></p></blockquote><p id="c2d1" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">确保<a class="ae jj" href="https://github.com/thestacks-io/eks-cluster/blob/master/cluster/_cim.yml" rel="noopener ugc nofollow" target="_blank"> cluster/_cim.yml </a>中的<code class="eh md me mf mg b">VPCStack</code>输入参数与VPC堆栈中的堆栈名称相匹配。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="00c2" class="mi lh hu mg b fv nh ni l nj nk">cd cluster<br/>cim stack-up</span></pre><p id="ab74" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">记录<code class="eh md me mf mg b">ClusterName</code>和<code class="eh md me mf mg b">ClusterEndpoint</code>输出，因为在接下来的几个步骤中需要它们。</p><p id="bc20" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">同时登录你的aws账户，记录你的新AWS<a class="ae jj" href="https://console.aws.amazon.com/eks/home" rel="noopener ugc nofollow" target="_blank">EKS</a>Kubernetes Base64编码的CA证书。在后面的步骤中也需要它。</p><h2 id="117e" class="mi lh hu bd li mj mk ml lm mm mn mo lq kf mp mq ls kj mr ms lu kn mt mu lw mv dt translated">节点</h2><p id="4f92" class="pw-post-body-paragraph jw jx hu jy b jz ly iv kb kc lz iy ke kf ma kh ki kj mb kl km kn mc kp kq kr hn dt translated">这创建了将运行我们的Kubernetes容器的<a class="ae jj" href="https://aws.amazon.com/ec2/" rel="noopener ugc nofollow" target="_blank"> EC2 </a>节点。</p><blockquote class="mw mx my"><p id="f3b4" class="jw jx mz jy b jz ka iv kb kc kd iy ke na kg kh ki nb kk kl km nc ko kp kq kr hn dt translated"><em class="hu">亚马逊弹性计算云(Amazon EC2)是一种在云中提供安全、可调整计算能力的web服务。它旨在使开发人员更容易进行网络规模的云计算。</em></p></blockquote><p id="7321" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">将上一步的<code class="eh md me mf mg b">ClusterName</code>输出复制到<a class="ae jj" href="https://github.com/thestacks-io/eks-cluster/blob/master/nodes/_cim.yml" rel="noopener ugc nofollow" target="_blank"> nodes/_cim.yml </a>中相应的<code class="eh md me mf mg b">ClusterName</code>参数中。还要确保<code class="eh md me mf mg b">KeyName</code>、<code class="eh md me mf mg b">VPCStack</code>和<code class="eh md me mf mg b">EKSStack</code>参数正确。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="d9f1" class="mi lh hu mg b fv nh ni l nj nk">cd nodes<br/>cim stack-up</span></pre><p id="b465" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">记录<code class="eh md me mf mg b">NodeInstanceRole</code>输出，因为稍后会用到。</p><h1 id="0713" class="lg lh hu bd li lj lk ll lm ln lo lp lq ja lr jb ls jd lt je lu jg lv jh lw lx dt translated">客户端设置</h1><p id="803e" class="pw-post-body-paragraph jw jx hu jy b jz ly iv kb kc lz iy ke kf ma kh ki kj mb kl km kn mc kp kq kr hn dt translated">一旦所有的栈都建立起来，就该配置本地环境来连接到新的Kubernetes集群了。我们还必须配置您的工作节点，并将它们与您的集群相关联。</p><p id="ecce" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated"><a class="ae jj" href="https://docs.aws.amazon.com/eks/latest/userguide/getting-started.html#eks-configure-kubectl" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/eks/latest/user guide/getting-started . html # eks-configure-ku bectl</a></p><h2 id="f785" class="mi lh hu bd li mj mk ml lm mm mn mo lq kf mp mq ls kj mr ms lu kn mt mu lw mv dt translated">为亚马逊EKS配置kubectl</h2><p id="7bbf" class="pw-post-body-paragraph jw jx hu jy b jz ly iv kb kc lz iy ke kf ma kh ki kj mb kl km kn mc kp kq kr hn dt translated">我们需要配置<code class="eh md me mf mg b">kubectl</code>，以便它知道如何认证和连接到您的新AWS EKS Kubernetes集群。</p><p id="7cf9" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated"><code class="eh md me mf mg b">kubectl</code>使用名为<code class="eh md me mf mg b">kubeconfig</code>的配置文件来存储集群信息。</p><p id="b98c" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">要创建kubeconfig文件:</p><p id="1553" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">1.)创建默认的<code class="eh md me mf mg b">~/.kube</code>目录，如果它还不存在的话。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="bab3" class="mi lh hu mg b fv nh ni l nj nk">mkdir -p ~/.kube</span></pre><p id="f0c8" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">2.)打开您最喜欢的文本编辑器，将下面的kubeconfig代码块复制到其中。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="dfbb" class="mi lh hu mg b fv nh ni l nj nk">apiVersion: v1<br/>clusters:<br/>- cluster:<br/>    server: &lt;endpoint-url&gt;<br/>    certificate-authority-data: &lt;base64-encoded-ca-cert&gt;<br/>  name: kubernetes<br/>contexts:<br/>- context:<br/>    cluster: kubernetes<br/>    user: aws<br/>  name: aws<br/>current-context: aws<br/>kind: Config<br/>preferences: {}<br/>users:<br/>- name: aws<br/>  user:<br/>    exec:<br/>      apiVersion: client.authentication.k8s.io/v1alpha1<br/>      command: heptio-authenticator-aws<br/>      args:<br/>        - "token"<br/>        - "-i"<br/>        - "&lt;cluster-name&gt;"<br/>        # - "-r"<br/>        # - "&lt;role-arn&gt;"<br/>      # env:<br/>        # - name: AWS_PROFILE<br/>        #   value: "&lt;aws-profile&gt;"</span></pre><p id="5c52" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">3.)用为集群创建的端点URL替换<code class="eh md me mf mg b">&lt;endpoint-url&gt;</code>。这将是来自组合仪表堆栈的<code class="eh md me mf mg b">ClusterEndpoint</code>输出。</p><p id="5ff2" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">4.)用为集群创建的certificateAuthority.data替换<code class="eh md me mf mg b">&lt;base64-encoded-ca-cert&gt;</code>。登录到您的aws帐户，并从您的新EKS集群中复制这个值。</p><p id="aa25" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">5.)用您的集群名称替换<code class="eh md me mf mg b">&lt;cluster-name&gt;</code>。这将是来自集群堆栈的<code class="eh md me mf mg b">ClusterName</code>输出。</p><p id="e22b" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">6.)(可选)要让Heptio authenticator承担一个角色来执行集群操作(而不是默认的AWS凭据提供者链)，请取消注释-r和<code class="eh md me mf mg b">&lt;role-arn&gt;</code>行，并替换一个IAM角色ARN来供您的用户使用。</p><p id="5e6d" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">7.)(可选)要让Heptio authenticator始终使用特定命名的AWS凭据配置文件(而不是默认的AWS凭据提供程序链)，请取消对env行的注释，并用要使用的配置文件名称替换<code class="eh md me mf mg b">&lt;aws-profile&gt;</code>。</p><p id="8393" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">8.)将文件保存到默认的kubectl文件夹，文件名中包含您的集群名称。例如，如果您的集群名称是<code class="eh md me mf mg b">&lt;cluster-name&gt;</code>，则将文件保存到~/。kube/config- <code class="eh md me mf mg b">&lt;cluster-name&gt;</code>。</p><p id="457b" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">9.)将该文件路径添加到您KUBECONFIG环境变量中，以便kubectl知道在哪里查找您的集群配置。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="cdf8" class="mi lh hu mg b fv nh ni l nj nk">export KUBECONFIG=$KUBECONFIG:~/.kube/config-&lt;cluster-name&gt;</span></pre><p id="b8b8" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">10.)(可选)将配置添加到shell初始化文件中，以便在打开shell时对其进行配置。</p><p id="6527" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">11.)测试您的配置。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="cf63" class="mi lh hu mg b fv nh ni l nj nk">kubectl get svc</span></pre><p id="d112" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">输出:</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="dd48" class="mi lh hu mg b fv nh ni l nj nk">NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE<br/>svc/kubernetes   ClusterIP   10.100.0.1   &lt;none&gt;        443/TCP   1m</span></pre><p id="c3b8" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">太棒了。现在你的<code class="eh md me mf mg b">kubectl</code>配置好了！</p><p id="5335" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">接下来，我们需要让工作节点加入您的集群。</p><h2 id="9b03" class="mi lh hu bd li mj mk ml lm mm mn mo lq kf mp mq ls kj mr ms lu kn mt mu lw mv dt translated">允许工作节点加入您的群集</h2><p id="987f" class="pw-post-body-paragraph jw jx hu jy b jz ly iv kb kc lz iy ke kf ma kh ki kj mb kl km kn mc kp kq kr hn dt translated">下载、编辑和应用AWS验证器配置图:</p><p id="0434" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">1.)下载配置图。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="1a6d" class="mi lh hu mg b fv nh ni l nj nk">curl -O <a class="ae jj" href="https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-06-05/aws-auth-cm.yaml" rel="noopener ugc nofollow" target="_blank">https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-06-05/aws-auth-cm.yaml</a></span></pre><p id="523a" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">2.)用你最喜欢的文本编辑器打开文件。用您在前面的过程中记录的<code class="eh md me mf mg b">NodeInstanceRole</code>值替换<arn of="" instance="" role="" profile="">片段，并保存文件。</arn></p><p id="3513" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">这将是来自节点堆栈的<code class="eh md me mf mg b">NodeInstanceRole</code>输出。</p><p id="b42d" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">重要的</p><blockquote class="mw mx my"><p id="62a8" class="jw jx mz jy b jz ka iv kb kc kd iy ke na kg kh ki nb kk kl km nc ko kp kq kr hn dt translated"><em class="hu">不要修改该文件中的任何其他行。</em></p></blockquote><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="9fa2" class="mi lh hu mg b fv nh ni l nj nk">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: aws-auth<br/>  namespace: kube-system<br/>data:<br/>  mapRoles: |<br/>    - rolearn: &lt;ARN of instance role (not instance profile)&gt;<br/>      username: system:node:{{EC2PrivateDNSName}}<br/>      groups:<br/>        - system:bootstrappers<br/>        - system:nodes</span></pre><p id="df37" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">3.)应用配置。此命令可能需要几分钟才能完成。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="3512" class="mi lh hu mg b fv nh ni l nj nk">kubectl apply -f aws-auth-cm.yaml</span></pre><p id="11a7" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">4.)观察节点的状态，并等待它们达到就绪状态。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="c159" class="mi lh hu mg b fv nh ni l nj nk">kubectl get nodes --watch</span></pre><p id="3a32" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">祝贺您，您的新AWS EKS Kubernetes集群已经准备就绪。</p><p id="cc86" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">现在是时候部署我们的第一个微服务了。</p><h1 id="38fa" class="lg lh hu bd li lj lk ll lm ln lo lp lq ja lr jb ls jd lt je lu jg lv jh lw lx dt translated">微服务Web应用</h1><p id="aabe" class="pw-post-body-paragraph jw jx hu jy b jz ly iv kb kc lz iy ke kf ma kh ki kj mb kl km kn mc kp kq kr hn dt translated">分叉这个回购，在本地克隆。<a class="ae jj" href="https://github.com/thestacks-io/eks-microservice" rel="noopener ugc nofollow" target="_blank">https://github.com/thestacks-io/eks-microservice</a></p><p id="04df" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">我们的微服务web应用程序是一个简单的express.js框架。我们使用<a class="ae jj" href="https://aws.amazon.com/codepipeline/" rel="noopener ugc nofollow" target="_blank"> CodePipeline </a>、<a class="ae jj" href="https://aws.amazon.com/codebuild/" rel="noopener ugc nofollow" target="_blank"> CodeBuild </a>和<a class="ae jj" href="https://aws.amazon.com/ecr/" rel="noopener ugc nofollow" target="_blank"> ECR </a>来构建、测试、发布和部署应用到我们新的Kubernetes集群。</p><h2 id="f672" class="mi lh hu bd li mj mk ml lm mm mn mo lq kf mp mq ls kj mr ms lu kn mt mu lw mv dt translated">微服务堆栈</h2><p id="b598" class="pw-post-body-paragraph jw jx hu jy b jz ly iv kb kc lz iy ke kf ma kh ki kj mb kl km kn mc kp kq kr hn dt translated">1.)更新<a class="ae jj" href="https://github.com/thestacks-io/eks-microservice/blob/master/_cim.yml" rel="noopener ugc nofollow" target="_blank"> _cim.yml </a>中的输入参数。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="881e" class="mi lh hu mg b fv nh ni l nj nk">parameters:<br/>    AppName: 'eks-test'<br/>    GitHubOwner: 'thestacks-io'<br/>    GitHubRepo: 'eks-microservice'<br/>    GitHubToken: '${kms.decrypt(AQICAHgiu9XuQb...mJrnw==)}'</span></pre><p id="cb25" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">你需要更换<code class="eh md me mf mg b">GitHubOwner</code>、<code class="eh md me mf mg b">GitHubRepo</code>和<code class="eh md me mf mg b">GitHubToken</code>。按照以下步骤加密您的<code class="eh md me mf mg b">GitHubToken</code>。点击<a class="ae jj" href="https://github.com/settings/tokens" rel="noopener ugc nofollow" target="_blank">这里</a>获取你的<a class="ae jj" href="https://github.com/settings/tokens" rel="noopener ugc nofollow" target="_blank"> Github个人访问令牌</a>。您的令牌将需要以下权限<code class="eh md me mf mg b"><em class="mz">admin:repo_hook, repo</em></code> <em class="mz">。</em></p><p id="dbe8" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">加密机密:</p><p id="915b" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">为了保护你的配置秘密，比如你的GitHub令牌，我们需要先创建一个KMS密钥。</p><ul class=""><li id="f132" class="ks kt hu jy b jz ka kc kd kf ku kj kv kn kw kr kx ky kz la dt translated">打开AWS控制台到<a class="ae jj" href="https://aws.amazon.com/kms/" rel="noopener ugc nofollow" target="_blank"> KMS </a>并创建一个新的KMS密钥。</li><li id="69cf" class="ks kt hu jy b jz lb kc lc kf ld kj le kn lf kr kx ky kz la dt translated">安装<a class="ae jj" href="https://github.com/ddffx/kms-cli" rel="noopener ugc nofollow" target="_blank">https://github.com/ddffx/kms-cli</a>并设置AWS环境变量。</li><li id="f9dc" class="ks kt hu jy b jz lb kc lc kf ld kj le kn lf kr kx ky kz la dt translated">如下所述对每个字符串进行加密。</li><li id="c9fe" class="ks kt hu jy b jz lb kc lc kf ld kj le kn lf kr kx ky kz la dt translated">将加密的字符串添加到<a class="ae jj" href="https://github.com/thestacks-io/eks-microservice/blob/master/_cim.yml" rel="noopener ugc nofollow" target="_blank"> _cim.yml </a>中。格式为<code class="eh md me mf mg b">${kms.decrypt(&lt;encreted string&gt;)}</code></li></ul><p id="9da8" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">如何加密:</p><p id="fada" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">创建一个名为<code class="eh md me mf mg b">encrypt.json</code>的文件</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="a33c" class="mi lh hu mg b fv nh ni l nj nk">{<br/>  "keyId" : "&lt;your kms key id&gt;",<br/>  "plainText": "&lt;your client id&gt;",<br/>  "awsRegion": "&lt;aws region&gt;",<br/>  "awsProfile": "&lt;aws profile"<br/>}</span></pre><p id="cfc2" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">使用此命令执行加密:<code class="eh md me mf mg b">kms-cli encrypt --file encrypt.json</code></p><p id="5ecc" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">2.)现在我们已经准备好部署我们的堆栈了。</p><p id="f0a0" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">部署堆栈。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="9ee4" class="mi lh hu mg b fv nh ni l nj nk">cim stack-up</span></pre><p id="a61e" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">一旦映像构建完成并放入ECR，我们就可以部署我们的微服务。</p><p id="a370" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">记录<code class="eh md me mf mg b">ECRUrl</code>堆栈输出参数，因为我们将在下一步中用到它。</p><p id="3e89" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">3.)配置并创建Kubernetes部署。</p><p id="2e29" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">更新<a class="ae jj" href="https://github.com/thestacks-io/eks-microservice/blob/master/eks-deployment.yml" rel="noopener ugc nofollow" target="_blank"> eks-deployment.yml </a>文件，替换<code class="eh md me mf mg b">&lt;ecr-url&gt;</code>和<code class="eh md me mf mg b">&lt;image-version&gt;</code>。这两个都可以在你的<a class="ae jj" href="https://aws.amazon.com/ecr/" rel="noopener ugc nofollow" target="_blank"> ECR </a>控制台中找到。<code class="eh md me mf mg b">&lt;image-version&gt;</code>是触发新映像的提交散列的前8个字符。</p><p id="9a09" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">现在您的<a class="ae jj" href="https://github.com/thestacks-io/eks-microservice/blob/master/eks-deployment.yml" rel="noopener ugc nofollow" target="_blank"> eks-deployment.yml </a>文件已经准备好了，我们可以创建Kubernetes部署了。</p><p id="06a5" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">创建Kubernetes部署:</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="4b4e" class="mi lh hu mg b fv nh ni l nj nk">kubectl create -f eks-deployment.yml</span></pre><p id="bd2d" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">检查你的吊舱的状态。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="4486" class="mi lh hu mg b fv nh ni l nj nk">kubectl get pods</span></pre><p id="6af9" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">4.)创建Kumbernetes服务。</p><p id="b5fe" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">创建Kubernetes服务(pods的路由)</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="025e" class="mi lh hu mg b fv nh ni l nj nk">kubectl create -f eks-service.yml</span></pre><p id="87ec" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">这将创建一个经典的负载平衡器，您可以使用它来访问您的web应用程序。如果愿意，您还可以使用负载平衡器url来创建Route53 DNS路由。</p><p id="48e6" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">获取域。可能需要几分钟才能获得IP地址。</p><pre class="jl jm jn jo fq nd mg ne nf aw ng dt"><span id="a031" class="mi lh hu mg b fv nh ni l nj nk">kubectl get services -o wide</span></pre><p id="5f51" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">导航到您的新域以查看您的express.js微服务。</p><p id="100c" class="pw-post-body-paragraph jw jx hu jy b jz ka iv kb kc kd iy ke kf kg kh ki kj kk kl km kn ko kp kq kr hn dt translated">如果您在本教程中有任何问题，请告诉我。谢谢，祝你好运。我希望你喜欢它。</p></div></div>    
</body>
</html>