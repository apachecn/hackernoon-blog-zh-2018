<html>
<head>
<title>Easily deploy your Sinatra app to DigitalOcean with Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Docker轻松将您的Sinatra应用程序部署到DigitalOcean</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/easily-deploy-your-sinatra-app-to-digitalocean-with-docker-293b71ea7350?source=collection_archive---------6-----------------------#2018-07-03">https://medium.com/hackernoon/easily-deploy-your-sinatra-app-to-digitalocean-with-docker-293b71ea7350?source=collection_archive---------6-----------------------#2018-07-03</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/b7df61082f94e64820ea583a360fa984.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fWwTV1czR-JzdVpG7Sv6MQ.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Credit: <a class="ae jg" href="https://www.digitalocean.com/products/droplets/" rel="noopener ugc nofollow" target="_blank">DigitalOcean</a></figcaption></figure><p id="c056" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">作为一名web开发人员，在我职业生涯的最初几年，我不需要学习太多关于服务器维护的知识。在部署我自己的个人应用程序时，Heroku是我最好的朋友。几个命令行界面命令，我有一个活的网站。没有麻烦。</p><p id="15d9" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">然而，当我加入DigitalOcean时，我很快意识到这需要改变。我将参与维护基础设施和建设管道。一开始这很吓人，但我决心要学。</p><p id="e756" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">虽然在生产服务器上工作给了我实践经验，但我发现有一些实践方法不会将数百万美元置于危险之中。</p><p id="6b4e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">就在那时，我产生了将我的<a class="ae jg" href="http://www.sunli.co" rel="noopener ugc nofollow" target="_blank">个人网站</a>从Heroku转移到数字海洋<a class="ae jg" href="https://www.digitalocean.com/products/droplets/" rel="noopener ugc nofollow" target="_blank"> Droplet </a>的想法。有什么更好的做法？这是一个小型静态网站，使用Sinatra进行一些轻量级路由。我觉得部署起来不会太难。</p><p id="6984" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">注意:我正在进行一些网站维护，所以当你读到这篇文章时，我的网站可能无法运行。</p><p id="2b28" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">有一个警告。作为一个懒惰的开发者，我喜欢Heroku的易用性。为了实现这种迁移，我需要找到一种方法，只用一个CLI命令就能启动我的网站。这样，无论何时我做了更改，我都可以在几分钟内更新网站。</p><p id="8aee" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">幸运的是，有了<code class="eh kg kh ki kj b">docker-compose</code>，这是可能的。</p><p id="cb3c" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在这篇文章中，我将讨论如何在一个<a class="ae jg" href="https://www.phusionpassenger.com/" rel="noopener ugc nofollow" target="_blank">乘客</a>应用服务器和<a class="ae jg" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank"> Nginx </a>的帮助下，使用Docker将我的网站部署到一个DigitalOcean Droplet上，以提供我的静态文件。</p><p id="9855" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最终，您将拥有部署和更新自己的Sinatra应用程序所需的工具，只需一个命令<code class="eh kg kh ki kj b">docker-compose up</code>。</p><figure class="kk kl km kn fq iv"><div class="bz el l di"><div class="ko kp l"/></div></figure><p id="6cdc" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><em class="kf">注意:如果你对Docker不熟悉，这是一项让在容器中运行应用程序变得非常容易的服务。Docker如何工作以及虚拟机和容器之间的区别超出了本文的范围。如果你很好奇，可以在这里阅读</em><a class="ae jg" href="https://blog.netapp.com/blogs/containers-vs-vms/" rel="noopener ugc nofollow" target="_blank"><em class="kf"/></a><em class="kf">。</em></p><p id="bbfd" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><em class="kf">另外，我从</em> <a class="ae jg" href="http://coding.jandavid.de/2016/02/12/dockerized-databases-with-sinatra/" rel="noopener ugc nofollow" target="_blank"> <em class="kf">其他</em> </a> <em class="kf"> </em> <a class="ae jg" href="https://www.phusionpassenger.com/library/walkthroughs/deploy/" rel="noopener ugc nofollow" target="_blank"> <em class="kf">教程</em> </a> <em class="kf">中整理了很多这方面的信息。虽然我添加了额外的信息并简化了许多步骤，但如果您遇到了困难，请参考它们以获取更多信息。</em></p></div><div class="ab cl kq kr hc ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="hn ho hp hq hr"><h1 id="5b28" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">先决条件</h1><p id="9a88" class="pw-post-body-paragraph jh ji hu jj b jk lv jm jn jo lw jq jr js lx ju jv jw ly jy jz ka lz kc kd ke hn dt translated">将Sinatra应用程序轻松部署到DigitalOcean需要一些前期步骤:</p><ul class=""><li id="56ef" class="ma mb hu jj b jk jl jo jp js mc jw md ka me ke mf mg mh mi dt translated"><a class="ae jg" href="https://cloud.digitalocean.com" rel="noopener ugc nofollow" target="_blank">创建数字海洋账户和API密钥</a></li><li id="bca8" class="ma mb hu jj b jk mj jo mk js ml jw mm ka mn ke mf mg mh mi dt translated">用一个<a class="ae jg" href="https://www.phusionpassenger.com/library/deploy/config_ru.html#sinatra" rel="noopener ugc nofollow" target="_blank"> config.ru文件</a>构建一个Sinatra应用</li><li id="021c" class="ma mb hu jj b jk mj jo mk js ml jw mm ka mn ke mf mg mh mi dt translated">将<a class="ae jg" href="https://rubygems.org/gems/passenger/versions/5.0.30" rel="noopener ugc nofollow" target="_blank">乘客</a>宝石添加到你的宝石档案中</li><li id="6536" class="ma mb hu jj b jk mj jo mk js ml jw mm ka mn ke mf mg mh mi dt translated">安装<a class="ae jg" href="https://docs.docker.com/install/" rel="noopener ugc nofollow" target="_blank">对接</a>、<a class="ae jg" href="https://docs.docker.com/machine/install-machine/" rel="noopener ugc nofollow" target="_blank">对接机</a>和<a class="ae jg" href="https://docs.docker.com/compose/install/#install-compose" rel="noopener ugc nofollow" target="_blank">对接机</a></li></ul><h2 id="ccbd" class="mo ky hu bd kz mp mq mr ld ms mt mu lh js mv mw ll jw mx my lp ka mz na lt nb dt translated"><strong class="ak">为什么是Docker-Machine？</strong></h2><p id="8a74" class="pw-post-body-paragraph jh ji hu jj b jk lv jm jn jo lw jq jr js lx ju jv jw ly jy jz ka lz kc kd ke hn dt translated">如果你的机器上已经安装了docker，你可能看不到安装<code class="eh kg kh ki kj b">docker-machine</code>的必要。然而，我们将在远程虚拟机上运行我们的容器。我们将使用<code class="eh kg kh ki kj b">docker-machine</code>来帮助我们管理它。</p><p id="5849" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">一旦你具备了所有必要的先决条件，我们就可以开始了。</p><h1 id="d535" class="kx ky hu bd kz la nc lc ld le nd lg lh li ne lk ll lm nf lo lp lq ng ls lt lu dt translated">1.旋转一滴</h1><p id="f0cd" class="pw-post-body-paragraph jh ji hu jj b jk lv jm jn jo lw jq jr js lx ju jv jw ly jy jz ka lz kc kd ke hn dt translated">该流程的第一步是启动我们将托管应用的虚拟机(VM)。DigitalOcean使用他们的云仪表板使这变得非常简单。然而，使用<code class="eh kg kh ki kj b">docker-machine</code>还有一种更简单的方法。</p><p id="1db4" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">先决条件之一是创建一个数字海洋API密钥。有了这些，你可以用一个简单的命令创建一个数字海洋水滴:</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="615d" class="mo ky hu kj b fv nl nm l nn no">docker-machine create --driver digitalocean --digitalocean-access-token &lt;your API Key&gt; &lt;droplet name&gt;</span></pre><p id="9566" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我将API令牌保存为环境变量<code class="eh kg kh ki kj b">DO_TOKEN</code>，因此我的命令如下所示:</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="4f6c" class="mo ky hu kj b fv nl nm l nn no">docker-machine create --driver digitalocean --digitalocean-access-token $DO_TOKEN personal-site</span></pre><p id="8d39" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">正如您在终端上看到的输出，这是创建一个Droplet，并代表您给它分配一个ssh密钥。你甚至可以在你的数字海洋仪表板上看到它。</p><figure class="kk kl km kn fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff np"><img src="../Images/a8221db49c5b180bd32d3c8d63e35dc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JyaCmqzmT3f9n_Omw3WZaQ.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The default configuration is a 1 GB Ubuntu Droplet in the New York datacenter. <a class="ae jg" href="https://docs.docker.com/machine/drivers/digital-ocean/" rel="noopener ugc nofollow" target="_blank">Use additional flags</a> if you have different configuration needs.</figcaption></figure><p id="fcfd" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">从这里，您应该能够ssh到虚拟机:</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="9d09" class="mo ky hu kj b fv nl nm l nn no">docker-machine ssh &lt;droplet name&gt;</span></pre><p id="9af8" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您应该会发现自己在VM中的一个shell上。它看起来会像这样:</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="8a18" class="mo ky hu kj b fv nl nm l nn no">root@&lt;droplet name&gt;:~#</span></pre><p id="321c" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">创建的默认Droplet有1 GB的内存和Ubuntu 16.04.4操作系统。对于一个小app来说，这个应该没问题。如果你的应用需要不同的东西，<a class="ae jg" href="https://docs.docker.com/machine/drivers/digital-ocean/" rel="noopener ugc nofollow" target="_blank">使用额外的标志</a>。</p><h1 id="7429" class="kx ky hu bd kz la nc lc ld le nd lg lh li ne lk ll lm nf lo lp lq ng ls lt lu dt translated">2.创建Dockerfile文件</h1><p id="5c08" class="pw-post-body-paragraph jh ji hu jj b jk lv jm jn jo lw jq jr js lx ju jv jw ly jy jz ka lz kc kd ke hn dt translated">关于如何在VM中手动配置Nginx和Passenger，Passenger有一个<a class="ae jg" href="https://www.phusionpassenger.com/library/walkthroughs/deploy/ruby/" rel="noopener ugc nofollow" target="_blank">深度教程</a>。这是一个漫长而彻底的过程，但是如果你更喜欢手动操作的话，这也是可行的。</p><p id="8081" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们可以通过使用Docker来避免所有这些步骤。</p><p id="9709" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">为了在我们的应用程序中使用Docker，我们需要包含一个Docker文件。乘客提供了各种<a class="ae jg" href="https://github.com/phusion/passenger-docker#image_variants" rel="noopener ugc nofollow" target="_blank">基础图像</a>，我们可以在此基础上进行构建。因为我的个人网站使用的是Ruby 2 . 3 . 3版本，所以我选择了<code class="eh kg kh ki kj b">phusion/passenger-ruby23</code>基本映像。</p><p id="0f60" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们可以通过将基础映像包含在docker文件中来获取它。</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="8c52" class="mo ky hu kj b fv nl nm l nn no">FROM phusion/passenger-ruby23:0.9.33</span></pre><p id="b7c5" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><em class="kf">注:截至本文发布时，</em> <code class="eh kg kh ki kj b"><em class="kf">0.9.33</em></code> <em class="kf">版本是</em> <code class="eh kg kh ki kj b"><em class="kf">phusion/passenger</em></code> <em class="kf">基础文件的最新稳定版本。最好包含一个特定的版本，而不是</em> <code class="eh kg kh ki kj b"><em class="kf">latest</em></code> <em class="kf">，这样你的应用就不会出现重大更新。</em></p><p id="6234" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">接下来，我们要为Docker设置正确的环境，运行Passenger的init脚本，并启用Nginx:</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="0d23" class="mo ky hu kj b fv nl nm l nn no"># Set correct environment variables.<br/>ENV HOME /root<br/><br/># Use baseimage-docker's init process.<br/>CMD ["/sbin/my_init"]</span><span id="9db4" class="mo ky hu kj b fv nq nm l nn no"># Enable Nginx (it is disabled by default)<br/>RUN rm -f /etc/service/nginx/down</span></pre><p id="5329" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">接下来，我们要删除默认的Nginx配置，并添加我们自己的配置。</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="5828" class="mo ky hu kj b fv nl nm l nn no">RUN rm /etc/nginx/sites-enabled/default<br/>ADD app.conf /etc/nginx/sites-enabled/app.conf</span></pre><p id="f976" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果您不确定这个<code class="eh kg kh ki kj b">app.conf</code>文件来自哪里，也不用担心。我们还没有创建它。我们将在下一节中讨论这一点。</p><p id="c503" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">下面几行需要一些解释:</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="769d" class="mo ky hu kj b fv nl nm l nn no">WORKDIR /home/app/&lt;app name&gt;<br/>COPY --chown=app:app . .<br/>RUN bundle install</span></pre><p id="6221" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">第一行告诉Docker创建目录<code class="eh kg kh ki kj b">/home/app/&lt;your app name&gt;</code>并移动到其中。和跑步是一样的:</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="94cc" class="mo ky hu kj b fv nl nm l nn no">RUN mkdir /home/app/&lt;app name&gt;<br/>RUN cd /home/app/&lt;app name&gt;</span></pre><p id="2456" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">为什么把我们的应用放在<code class="eh kg kh ki kj b">/home/app</code>里面？根据乘客-码头工人自述:</p><blockquote class="nr ns nt"><p id="d94e" class="jh ji kf jj b jk jl jm jn jo jp jq jr nu jt ju jv nv jx jy jz nw kb kc kd ke hn dt translated">[Passenger base]映像有一个UID为9999、主目录为<code class="eh kg kh ki kj b">/home/app</code>的<code class="eh kg kh ki kj b">app</code>用户。您的应用程序应该以这个用户的身份运行。尽管Docker本身提供了与主机操作系统的某种隔离，但在没有root权限的情况下运行应用程序是一种良好的安全实践。</p><p id="91fc" class="jh ji kf jj b jk jl jm jn jo jp jq jr nu jt ju jv nv jx jy jz nw kb kc kd ke hn dt translated">你的应用应该放在/home/app里面。</p><p id="d054" class="jh ji kf jj b jk jl jm jn jo jp jq jr nu jt ju jv nv jx jy jz nw kb kc kd ke hn dt translated">注意:当复制您的应用程序时，确保通过调用<code class="eh kg kh ki kj b">COPY --chown=app:app /local/path/of/your/app /home/app/webapp</code>将应用程序目录的所有权设置为<code class="eh kg kh ki kj b">app</code></p></blockquote><p id="b89c" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">乘客基本映像被配置为作为<code class="eh kg kh ki kj b">app</code>用户在<code class="eh kg kh ki kj b">/home/app</code>目录下运行。这就是为什么我们有这条线:</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="b06e" class="mo ky hu kj b fv nl nm l nn no">COPY --chown=app:app . .</span></pre><p id="df11" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">它将我们的应用程序文件复制到Docker容器中，同时让<code class="eh kg kh ki kj b">app</code>用户拥有我们的应用程序目录。然后我们运行<code class="eh kg kh ki kj b">bundle install</code>从我们的<code class="eh kg kh ki kj b">Gemfile.</code>安装gem依赖项</p><p id="e566" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最后，剩下的就是清理我们的图像中的任何多余文件，以保持其较小的大小并易于部署。</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="05c2" class="mo ky hu kj b fv nl nm l nn no">RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</span></pre><p id="50a5" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最后，你的docker文件应该是这样的(我把<code class="eh kg kh ki kj b">personalSite</code>换成了<code class="eh kg kh ki kj b">&lt;app name&gt;</code>，因为那是我的应用程序的名字):</p><figure class="kk kl km kn fq iv"><div class="bz el l di"><div class="nx kp l"/></div></figure><h1 id="a657" class="kx ky hu bd kz la nc lc ld le nd lg lh li ne lk ll lm nf lo lp lq ng ls lt lu dt translated">3.用<code class="eh kg kh ki kj b">app.conf</code>配置Nginx</h1><p id="e98f" class="pw-post-body-paragraph jh ji hu jj b jk lv jm jn jo lw jq jr js lx ju jv jw ly jy jz ka lz kc kd ke hn dt translated">因为我们在应用程序中使用Nginx，所以让我们来设置它。如果您以前使用过Unicorn或Puma，您可能习惯于长配置文件。乘客为我们处理所有的代理样板文件，所以我们的<code class="eh kg kh ki kj b">app.conf</code>不需要复杂。</p><p id="d7a0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我的看起来像这样:</p><figure class="kk kl km kn fq iv"><div class="bz el l di"><div class="nx kp l"/></div></figure><p id="f266" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">不必将这个文件命名为<code class="eh kg kh ki kj b">app.conf</code>。我这么做只是为了简单。</p><p id="eae9" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在<code class="eh kg kh ki kj b">server</code>块的底部，我们传入一些乘客数据。<code class="eh kg kh ki kj b">passenger_user</code>字段告诉Nginx将在虚拟机上运行应用程序的用户名。</p><p id="794e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">从上一节我们知道这个用户是<code class="eh kg kh ki kj b">app</code>。我们还知道应用程序目录的位置在<code class="eh kg kh ki kj b">/home/app</code>里面。这就是我把<code class="eh kg kh ki kj b">root</code>值指向<code class="eh kg kh ki kj b">/home/app/personalSite/public</code>的原因。<code class="eh kg kh ki kj b">personalSite</code>是我的应用程序的名称，<code class="eh kg kh ki kj b">public</code>是我的静态文件文件夹。</p><p id="e57e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最后，<code class="eh kg kh ki kj b">passenger_ruby</code>字段告诉乘客应该使用哪个版本的Ruby来运行应用程序。因为我的网站使用Ruby 2.3.3，所以我使用的是<code class="eh kg kh ki kj b">/usr/bin/ruby2.3</code>二进制。</p><p id="ce88" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">Passenger自带了四个主要版本的Ruby可供选择:</p><ul class=""><li id="3264" class="ma mb hu jj b jk jl jo jp js mc jw md ka me ke mf mg mh mi dt translated"><code class="eh kg kh ki kj b">/usr/bin/ruby2.1</code></li><li id="77a6" class="ma mb hu jj b jk mj jo mk js ml jw mm ka mn ke mf mg mh mi dt translated"><code class="eh kg kh ki kj b">/usr/bin/ruby2.2</code></li><li id="f967" class="ma mb hu jj b jk mj jo mk js ml jw mm ka mn ke mf mg mh mi dt translated"><code class="eh kg kh ki kj b">/usr/bin/ruby2.3</code></li><li id="9ba8" class="ma mb hu jj b jk mj jo mk js ml jw mm ka mn ke mf mg mh mi dt translated"><code class="eh kg kh ki kj b">/usr/bin/ruby2.4</code></li></ul><p id="91b0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">选择最适合您应用的产品。</p><p id="e7e9" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">包含了<code class="eh kg kh ki kj b">app.conf</code>文件后，您的项目目录将如下所示:</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="ecb8" class="mo ky hu kj b fv nl nm l nn no">$ tree .<br/>.<br/>├── Dockerfile<br/>├── Gemfile<br/>├── Gemfile.lock<br/>├── Rakefile<br/>├── config.ru<br/>├── lib<br/>|  └── removed for brevity...<br/>├── public<br/>|  └── removed for brevity...<br/>├──app.rb<br/>├──views<br/>|  └── removed for brevity...<br/>└── app.conf</span></pre><p id="acae" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">此时，我们已经拥有了在Docker上运行应用程序所需的所有文件。在您的终端中运行这些命令，亲自查看:</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="4d79" class="mo ky hu kj b fv nl nm l nn no"># This points our local Docker client at your remote machine<br/><strong class="kj hv">eval $(docker-machine env &lt;droplet name&gt;)</strong></span><span id="f3c5" class="mo ky hu kj b fv nq nm l nn no"># This will build and run your docker container<br/><strong class="kj hv">docker build -t &lt;image name&gt; . &amp;&amp; docker run -p 80:80 &lt;image name&gt;</strong></span></pre><p id="442b" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您可以通过在浏览器中键入Droplet所在的IP地址来查看您的应用程序。您可以通过查看您的DigitalOcean仪表盘或询问<code class="eh kg kh ki kj b">docker-machine</code>来找到IP地址:</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="e579" class="mo ky hu kj b fv nl nm l nn no">docker-machine ip &lt;machine name&gt;</span></pre><h1 id="6ab0" class="kx ky hu bd kz la nc lc ld le nd lg lh li ne lk ll lm nf lo lp lq ng ls lt lu dt translated">4.(可选)安装docker-compose.yml</h1><p id="eaa5" class="pw-post-body-paragraph jh ji hu jj b jk lv jm jn jo lw jq jr js lx ju jv jw ly jy jz ka lz kc kd ke hn dt translated">由于我们的应用程序已经可以在Docker上运行，这是一个可选步骤。然而，Docker Compose可以进一步简化部署过程。</p><p id="ccc9" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">Docker Compose旨在帮助协调多个容器的复杂部署。然而，即使我的网站很小，它也能让我用一个简单的<code class="eh kg kh ki kj b">docker-compose up</code>来运行我的应用程序。</p><p id="67cc" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果你想做同样的事情，添加一个简单的<code class="eh kg kh ki kj b">docker-compose.yml</code>文件到你的项目报告中。</p><figure class="kk kl km kn fq iv"><div class="bz el l di"><div class="nx kp l"/></div></figure><p id="925b" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这个文件将VM上的端口<code class="eh kg kh ki kj b">80</code>映射到Docker容器的端口<code class="eh kg kh ki kj b">80</code>。于是有了<code class="eh kg kh ki kj b">80:80</code>。通俗地说，这意味着任何在端口<code class="eh kg kh ki kj b">80</code>上访问你的Droplet的人都将被定向到你的Docker容器上的应用。</p><p id="40cd" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这很重要。如果不将这两个端口映射在一起，您的应用程序将与互联网隔离，没有人能够访问它。</p><p id="6988" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">属性给出了包含Dockerfile的目录的相对路径。因为Dockerfile在主目录中，所以相对路径是<code class="eh kg kh ki kj b">.</code>。最后，您的应用程序的名称出现在<code class="eh kg kh ki kj b">&lt;app name&gt;</code>部分。</p><p id="ecbe" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这个例子<code class="eh kg kh ki kj b">docker-compose.yml</code>对于一个简单的Sinatra应用就足够了。如果你需要一个更复杂的设置，比如附加一个数据库，我会推荐Jan David的教程。</p><p id="a58b" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">有了这个文件，您应该能够使用<code class="eh kg kh ki kj b">docker-compose up</code>运行您的应用程序。如果您想在后台运行应用程序，使其不占用您的终端，只需添加<code class="eh kg kh ki kj b">-d</code>标志。</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="2fdf" class="mo ky hu kj b fv nl nm l nn no">docker-compose up -d</span></pre><h1 id="5870" class="kx ky hu bd kz la nc lc ld le nd lg lh li ne lk ll lm nf lo lp lq ng ls lt lu dt translated">5.获取一个域并配置名称服务器</h1><p id="5eb1" class="pw-post-body-paragraph jh ji hu jj b jk lv jm jn jo lw jq jr js lx ju jv jw ly jy jz ka lz kc kd ke hn dt translated">有了运行的应用程序，是时候把你的域名指向数字海洋的域名服务器了。</p><p id="c3f0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果你还没有域名，有很多供应商可供选择。如果你不挑剔，可以从<a class="ae jg" href="http://www.dot.tk" rel="noopener ugc nofollow" target="_blank"> dot.tk </a>免费得到一个。</p><figure class="kk kl km kn fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ny"><img src="../Images/dc3741436b75e13d0a8c790e529b5579.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K_Y3Z6jX4d0CnGawT9-k9Q.png"/></div></div></figure><p id="52d2" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">对于付费域名，我一般用<a class="ae jg" href="https://www.godaddy.com/" rel="noopener ugc nofollow" target="_blank"> GoDaddy </a>。</p><figure class="kk kl km kn fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nz"><img src="../Images/6aa867be0a9a401bb4201880354a4aa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NHYBRuOBjTkKBFuMZ_Sxqg.png"/></div></div></figure><p id="4cdb" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">拥有一个域名还不够。它没有指向任何东西。这就是域名服务器的用武之地。一旦你有了自己的域名，进入数字海洋仪表板上的<a class="ae jg" href="https://cloud.digitalocean.com/networking/domains" rel="noopener ugc nofollow" target="_blank">网络</a>标签，将域名添加到你的账户中。</p><p id="211e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您现在应该能够看到DigitalOcean提供的三个名称服务器。</p><figure class="kk kl km kn fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff oa"><img src="../Images/6e1dbabbe81dacf638c2d4c48b8b8807.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KZpwBo1Wp_O1BvcdbgLtRQ.png"/></div></div></figure><p id="4be1" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">回到你购买域名的地方(dot.tk，Godaddy等)并将它们添加到你的DNS配置中。</p><figure class="kk kl km kn fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ob"><img src="../Images/bed7dd94ab7b072193c687a1e8c1e1c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B6SdHYVRMIQkR1UPpPISnA.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">dot.tk</figcaption></figure><figure class="kk kl km kn fq iv fe ff paragraph-image"><div class="fe ff oc"><img src="../Images/0e985f66f7d9991c3104cebcd9b438d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/1*QIdelqcut-ZkWUvHcvvC2Q.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Godaddy</figcaption></figure><p id="0a59" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我还建议将<code class="eh kg kh ki kj b">www</code>和<code class="eh kg kh ki kj b">@</code> A记录添加到DigitalOcean dashboard中的您的域中，并将它们指向运行您的应用程序的droplet。最后，您的域名的DNS记录应该看起来像这样</p><figure class="kk kl km kn fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff od"><img src="../Images/751e4592c59f054a7c8f2875efebc8fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9CUUi2by1MDc2Txt-p7Pww.png"/></div></div></figure><p id="9177" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">DNS是一个棘手的问题。如果你在设置域名服务器或记录方面有任何问题，请查看这些<a class="ae jg" href="https://www.digitalocean.com/community/tutorials/how-to-point-to-digitalocean-nameservers-from-common-domain-registrars" rel="noopener ugc nofollow" target="_blank">有用的</a> <a class="ae jg" href="https://www.digitalocean.com/community/tutorials/an-introduction-to-digitalocean-dns" rel="noopener ugc nofollow" target="_blank">教程</a>。</p></div><div class="ab cl kq kr hc ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="hn ho hp hq hr"><p id="549a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这就是了。按照这些步骤，你应该很快就能拥有一个小型的Sinatra。最好的一点是，如果您对您的站点进行了更改，并希望在尽可能短的停机时间内进行更新，只需运行:</p><pre class="kk kl km kn fq nh kj ni nj aw nk dt"><span id="70db" class="mo ky hu kj b fv nl nm l nn no">docker-compose up -d --build</span></pre><p id="81f5" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果将来你需要复习，但不想再次阅读整篇文章，我在<a class="ae jg" href="https://gist.github.com/sunny-b/04e0fb63854798961952810a1e121516" rel="noopener ugc nofollow" target="_blank">要点</a>中列出了本教程的所有示例文件。您还可以在我个人网站的repo 上看到我如何在生产环境中使用这些文件。由于我不是Docker专家，如果您发现任何错误，请让我知道！</p><p id="75ac" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">所以你自己试试吧，在下面的评论里告诉我效果如何！</p><p id="e62b" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">永远不要停止督促自己学习新东西。编码快乐！</p><p id="deaf" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><a class="ae jg" rel="noopener" href="/subscribe/@SunnyB"> <em class="kf">订阅我的个人资料</em> </a> <em class="kf">如果您想在我上传新故事时收到通知。</em></p></div></div>    
</body>
</html>