<html>
<head>
<title>One-shot containers with Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器的一次性容器</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/one-shot-containers-with-serverless-10794f68fc16?source=collection_archive---------11-----------------------#2018-07-05">https://medium.com/hackernoon/one-shot-containers-with-serverless-10794f68fc16?source=collection_archive---------11-----------------------#2018-07-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/dd7f3f611e2afc00d0d22f7a506b8a27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e530ehvEkd3D1l4Nog3qhw.jpeg"/></div></div></figure><p id="2f80" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您是否遇到过类似以下用例的短期容器:</p><ul class=""><li id="c665" class="ka kb hu je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated">批处理和ETL(提取、转换和加载)作业。</li><li id="3bc4" class="ka kb hu je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">数据库备份和复制。</li><li id="96ec" class="ka kb hu je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">用于生成学习和训练模型的机器学习算法。</li><li id="6dcf" class="ka kb hu je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">集成和健全性测试。</li><li id="f456" class="ka kb hu je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">网络爬虫。</li></ul><p id="56ad" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您想知道如何定期部署容器或响应事件吗？答案是通过使用Lambda本身，这个想法是通过让Lambda函数从构建服务器触发容器的部署。下图说明了如何实施这一过程:</p><figure class="kp kq kr ks fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ko"><img src="../Images/36739f0037d8d0135c9ecd07dec7dace.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gbGERbJlphQ04rNxKmtVEw.png"/></div></div></figure><p id="a12b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我在Go中编写了一个简单的应用程序，使用sleep方法模拟一个短时间的过程:</p><figure class="kp kq kr ks fq iv"><div class="bz el l di"><div class="kt ku l"/></div></figure><p id="64ee" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">由于<strong class="je hv"> Go </strong>是一种编译语言，我使用了Docker的多阶段构建特性，用下面的<strong class="je hv">Docker文件</strong>构建了一个轻量级的Docker映像:</p><figure class="kp kq kr ks fq iv"><div class="bz el l di"><div class="kt ku l"/></div></figure><p id="2f7c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，我在Jenkins中有一个简单的CI/CD工作流，下面是用于构建管道的<strong class="je hv"> Jenkinsfile </strong>:</p><figure class="kp kq kr ks fq iv"><div class="bz el l di"><div class="kt ku l"/></div></figure><p id="0a72" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">流水线执行的一个例子如下:</p><figure class="kp kq kr ks fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kv"><img src="../Images/49c6844d40fc18206611d0f30872e8ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7KK5l3uo5rpE2tkXAOkduw.png"/></div></div></figure><p id="66ee" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，对应用程序的所有更改都将触发Jenkins上的新构建，该构建将构建新的Docker映像，将该映像推送到私有注册表，并将新的Docker映像部署到Swarm集群:</p><figure class="kp kq kr ks fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kw"><img src="../Images/31573cd4d9c96cfde02eaecb361a8da2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FO83OAAiXx0_TGGUg0Wldg.png"/></div></div></figure><p id="5738" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果在其中一个集群管理器上发出"<em class="kx"> docker服务日志APP_NAME" </em>，您的应用程序应该可以正常工作:</p><figure class="kp kq kr ks fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ky"><img src="../Images/70e4384c1861b524608fbccf5b0ba48a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wUjoeafJ5QdfHIXnyjqVeg.png"/></div></div></figure><p id="e8ac" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在我们的应用程序已经准备好了，让我们使用Lambda函数让它每天早上8点执行。下面是将在每次调用函数时执行的<em class="kx">入口点</em>(处理程序):</p><figure class="kp kq kr ks fq iv"><div class="bz el l di"><div class="kt ku l"/></div></figure><p id="622b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它使用Jenkins API来触发部署流程作业。</p><p id="c50a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在定义了函数，使用下面的shell脚本创建以下内容:</p><ul class=""><li id="829b" class="ka kb hu je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated">构建一个部署包(<em class="kx">)。zip </em>文件)。</li><li id="5c74" class="ka kb hu je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">创建一个IAM角色，拥有将日志推送到CloudWatch的权限。</li><li id="23a7" class="ka kb hu je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">从部署包创建一个基于Go的Lambda函数。</li><li id="3d52" class="ka kb hu je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">创建将在每天上午8点执行的CloudWatch事件规则。</li><li id="80bb" class="ka kb hu je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">让CloudWatch事件调用Lambda函数。</li></ul><figure class="kp kq kr ks fq iv"><div class="bz el l di"><div class="kt ku l"/></div></figure><p id="a7d7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">因此，将按如下方式创建Lambda函数:</p><figure class="kp kq kr ks fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kz"><img src="../Images/7ecb0494dce1514a4faf2e3b70d0fe21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zMcam5YD29-mla6imCkxvg.png"/></div></div></figure><p id="a206" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要测试它，您可以从Lambda控制台或使用以下AWS CLI命令手动调用它:</p><figure class="kp kq kr ks fq iv"><div class="bz el l di"><div class="kt ku l"/></div></figure><p id="eb5e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Jenkins中应该会触发新的部署，您的应用程序应该会再次部署:</p><figure class="kp kq kr ks fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff la"><img src="../Images/06948d2f53c0d5dd3e9d39821cdbab5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g7vL_Ubc9-73vAue5LqUXA.png"/></div></div></figure><p id="ef4e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">就这样，这是一个关于如何将<strong class="je hv">无服务器</strong>与<strong class="je hv">容器</strong>一起使用的快速示例，您可以更进一步，使用Lambda函数在您的<strong class="je hv">Swarm</strong>/<strong class="je hv">Kubernetes</strong>集群中横向扩展/纵向扩展您的服务，方法是使用CloudWatch事件来处理预期的计划事件(节假日、黑色星期五……)，或者使用其他AWS管理的服务(如API Gateway)来响应传入的客户端请求。</p><p id="aabf" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="kx">完整代码可以在我的</em> <a class="ae lb" href="https://github.com/mlabouardy/lambda-oneshot-container" rel="noopener ugc nofollow" target="_blank"> <em class="kx"> GitHub </em> </a> <em class="kx">上找到。请务必在下面留下您的评论、反馈或建议，或者直接在Twitter上与我联系</em><a class="ae lb" href="https://twitter.com/mlabouardy" rel="noopener ugc nofollow" target="_blank"><strong class="je hv"><em class="kx">@</em></strong><em class="kx">mlabouardy</em></a><em class="kx">。</em></p></div></div>    
</body>
</html>