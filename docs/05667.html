<html>
<head>
<title>Terraform with AWS Assume Role</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有AWS的地形承担角色</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/terraform-with-aws-assume-role-21567505ea98?source=collection_archive---------2-----------------------#2018-07-06">https://medium.com/hackernoon/terraform-with-aws-assume-role-21567505ea98?source=collection_archive---------2-----------------------#2018-07-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/20b7ae20c61e9c70ffcc75a41b4a8d68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EKs1TF4X13Sn_bqC2sd-YA.png"/></div></div></figure><p id="8ff2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为不同的环境使用不同的AWS帐户现在是一种最佳实践，这样我们就可以完全隔离所有的环境。</p><p id="8972" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在上图[复制自segment.io博客]中，Ops AWS帐户是其余AWS帐户的入口点。这意味着我们不需要开发、试运行和生产AWS帐户上的用户，而是可以使用AWS STS并承担引导/访问AWS服务的角色。</p><h2 id="fd7c" class="ka kb hu bd kc kd ke kf kg kh ki kj kk jn kl km kn jr ko kp kq jv kr ks kt ku dt translated">优势？</h2><p id="242a" class="pw-post-body-paragraph jc jd hu je b jf kv jh ji jj kw jl jm jn kx jp jq jr ky jt ju jv kz jx jy jz hn dt translated">通过为不同的环境使用单独的AWS帐户</p><ol class=""><li id="b9b5" class="la lb hu je b jf jg jj jk jn lc jr ld jv le jz lf lg lh li dt translated">资源分离和隔离。</li><li id="099c" class="la lb hu je b jf lj jj lk jn ll jr lm jv ln jz lf lg lh li dt translated">集中访问位置。</li></ol><p id="cb3e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">还有更多…..</p><h2 id="b082" class="ka kb hu bd kc kd ke kf kg kh ki kj kk jn kl km kn jr ko kp kq jv kr ks kt ku dt translated"><strong class="ak">先决条件？</strong></h2><p id="bcb2" class="pw-post-body-paragraph jc jd hu je b jf kv jh ji jj kw jl jm jn kx jp jq jr ky jt ju jv kz jx jy jz hn dt translated">4个AWS帐户，并确保为根帐户启用MFA。</p><p id="41ee" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注意:我们也可以设置2个AWS账户，但在本帖中，我们考虑4个AWS账户。</p><p id="4429" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们给出4个AWS帐户的名称，我们将在帖子中提到。</p><ol class=""><li id="c66d" class="la lb hu je b jf jg jj jk jn lc jr ld jv le jz lf lg lh li dt translated">ops[跳转AWS账户或者我称之为Bastion AWS账户]</li><li id="9dbe" class="la lb hu je b jf lj jj lk jn ll jr lm jv ln jz lf lg lh li dt translated">开发AWS帐户</li><li id="0bbd" class="la lb hu je b jf lj jj lk jn ll jr lm jv ln jz lf lg lh li dt translated">暂存AWS帐户</li><li id="d8be" class="la lb hu je b jf lj jj lk jn ll jr lm jv ln jz lf lg lh li dt translated">生产AWS帐户</li></ol><p id="7b7b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh lo lp lq lr b">ops</code>账号作为跳转点和集中登录。组织中的每个人都可以拥有一个IAM帐户。</p><p id="a7cf" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">其他环境有一组IAM角色可以在它们之间切换。这意味着我们的管理员帐户只有一个登录点，一个限制访问的地方。</p><p id="42da" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">例如，Anay可以访问所有三个环境，但是Abhi只能访问dev。但他们都是通过<code class="eh lo lp lq lr b">ops</code>账号登录的。</p><p id="69f8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们不用复杂的IAM设置来限制访问，而是可以根据环境轻松锁定用户，并根据<em class="ls">角色对他们进行分组。</em>从界面使用每个帐户就像切换当前活动角色一样简单。</p><p id="777d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦我们获得AWS帐户，下面是我们需要执行的所有步骤</p><ol class=""><li id="6b02" class="la lb hu je b jf jg jj jk jn lc jr ld jv le jz lf lg lh li dt translated">在Ops AWS帐户中创建IAM用户。像anay，abhi等</li><li id="2df1" class="la lb hu je b jf lj jj lk jn ll jr lm jv ln jz lf lg lh li dt translated">在所有3个(开发、试运行和生产)AWS客户中创建角色，并附加一些政策，或使其成为拥有特定AWS访问资源的组的一部分。</li><li id="45d6" class="la lb hu je b jf lj jj lk jn ll jr lm jv ln jz lf lg lh li dt translated">创建角色时，请确保在运营和开发、运营和筹备、运营和生产AWS帐户之间添加信任关系。</li></ol><figure class="lu lv lw lx fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lt"><img src="../Images/4dd96004e8b61f9909acad2736c922e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nsU9MoPRO2rEY9Y7NcBFkA.png"/></div></div></figure><p id="0b6b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">4.在运营转移帐户中创建一个用户，该用户必须有权承担开发、转移和生产帐户的角色。下面是您可以附加到用户以承担角色的示例策略。</p><pre class="lu lv lw lx fq ly lr lz ma aw mb dt"><span id="f01e" class="ka kb hu lr b fv mc md l me mf">{<br/> “Version”: “2012–10–17”,<br/> “Statement”: [<br/> {<br/> “Effect”: “Allow”,<br/> “Action”: “sts:AssumeRole”,<br/> “Resource”: “arn:aws:iam::123545678:role/rolename”<br/> }<br/> ]<br/>}</span></pre><p id="67d7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦用户创建了aws-cli，请在要运行terraform的主机服务器上进行配置(也可以在本地机器上进行配置)。</p><p id="e4bf" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我在这里假设您的系统上有terraform最新版本的二进制文件，并使用terraform承担角色</p><pre class="lu lv lw lx fq ly lr lz ma aw mb dt"><span id="d098" class="ka kb hu lr b fv mc md l me mf">provider "aws" {<br/>  assume_role {<br/>    role_arn     = "arn:aws:iam::ACCOUNT_ID:role/ROLE_NAME"<br/>    session_name = "SESSION_NAME"<br/>    external_id  = "EXTERNAL_ID"<br/>  }<br/>}</span></pre><p id="2a16" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，只需在状态文件中添加下面两行，用于您想要引导的模块。</p><pre class="lu lv lw lx fq ly lr lz ma aw mb dt"><span id="3bd8" class="ka kb hu lr b fv mc md l me mf">    role_arn     = "arn:aws:iam::ACCOUNT_ID:role/ROLE_NAME"<br/>    profile      = "my_profile_name"    </span></pre><p id="6128" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您现在可以安全地运行Terraform了！</p></div></div>    
</body>
</html>