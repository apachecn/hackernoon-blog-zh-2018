<html>
<head>
<title>Keep Your Logs Close And Your Code Closer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让你的日志和代码保持一致</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/keep-your-logs-close-and-your-code-closer-9cc25bf9d413?source=collection_archive---------8-----------------------#2018-07-08">https://medium.com/hackernoon/keep-your-logs-close-and-your-code-closer-9cc25bf9d413?source=collection_archive---------8-----------------------#2018-07-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="5dfc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们来谈谈web应用程序和日志记录。对于大多数人来说，当谈到日志分析或日志事件时，Apache日志格式是第一个想到的日志事件的好例子。但是Apache日志内容足以理解您的系统中正在发生的事情吗？让我们仔细看看。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/e663537ed218b9fad7fe051a457dc040.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qaUPNEbqVtB1244OKb_Rhg.png"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Custom output of Apache access log</figcaption></figure><p id="1efa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当向web服务器发送一个普通的GET请求时，一切似乎都很完美。对于以下请求</p><pre class="jq jr js jt fq kf kg kh ki aw kj dt"><span id="fc93" class="kk kl hu kg b fv km kn l ko kp">GET /index.php?page_id=1 HTTP/1.1<br/>Host: www.unionselect1.eu</span></pre><p id="4389" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您将在Apache访问日志中看到适当的事件描述:</p><pre class="jq jr js jt fq kf kg kh ki aw kj dt"><span id="65ff" class="kk kl hu kg b fv km kn l ko kp">423.619.551.990 — — [06/Jul/2018:14:31:52 +0300] "GET /index.php?page_id=1 HTTP/1.1" 200 795 "-" "-"</span></pre><p id="7f39" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">起初，这看起来相当不错:您有时间戳、发出请求的IP地址、访问过的URI，甚至还有被请求页面的ID。还是你？</p><p id="00a9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要了解日志记录是否足够，您首先必须了解您的应用程序及其在您的环境中的实现。为了说明我的例子，我将在web应用程序中使用流行的<a class="ae kq" href="https://en.wikipedia.org/wiki/LAMP_%28software_bundle%29" rel="noopener ugc nofollow" target="_blank">灯</a>设置和<a class="ae kq" href="https://www.php.net/" rel="noopener ugc nofollow" target="_blank"> PHP </a>参数处理。</p><p id="0b2b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一个常见的错误是使用$_REQUEST关联数组而不是GET或POST数组来获取发送到页面的参数。我不会深入讨论这些差异，也不会谈论<a class="ae kq" href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_%28CSRF%29" rel="noopener ugc nofollow" target="_blank"> CSRF </a>以及这种方法可能给你的应用或客户带来的其他伤害。我只关注日志部分。</p><p id="476e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了说明我的示例，我创建了一个包含以下内容的网页:</p><pre class="jq jr js jt fq kf kg kh ki aw kj dt"><span id="48ad" class="kk kl hu kg b fv km kn l ko kp">&lt;?php<br/>printf("Current page ID is %d", intval($_REQUEST['page_id']) ); <br/>?&gt;</span></pre><p id="293d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">作为最后一个请求的结果，页面上的输出应该是:“当前页面ID是1”。到目前为止一切顺利，对吧？</p><p id="852c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们提出另一个请求。这次让我们执行一个POST请求:</p><pre class="jq jr js jt fq kf kg kh ki aw kj dt"><span id="cc6f" class="kk kl hu kg b fv km kn l ko kp">POST /index.php?page_id=1 HTTP/1.1<br/>Host: www.unionselect1.eu<br/>Content-Length: 9<br/>Content-Type: application/octet-stream application/x-www-form-urlencoded</span><span id="6038" class="kk kl hu kg b fv kr kn l ko kp">page_id=2</span></pre><p id="3d38" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">并检查日志文件中的相应条目。该事件如下:</p><pre class="jq jr js jt fq kf kg kh ki aw kj dt"><span id="79a3" class="kk kl hu kg b fv km kn l ko kp">423.619.551.990 — — [06/Jul/2018:14:40:13 +0300] "POST /index.php?page_id=1 HTTP/1.1" 200 795 "-" "-"</span></pre><p id="b665" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，页面上的输出告诉我们“当前页面ID是2”。为什么页面上的页面ID与访问日志事件中的不同？似乎使用了POST参数，但是为什么呢？我会说的，但首先。</p><p id="22b9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们如何获得日志的正确信息，也就是说，我们如何记录应用程序使用的正确的page_id？一种方法是记录POST参数。这将为我们提供完整的有效负载，但这可能会在日志记录方面给你带来额外的开销(例如，当记录POST-ed的文件内容时)，或者在将所有POST请求参数(包括用户名、密码、信用卡号等)保存到日志文件时，可能会产生合规性问题。但是这是可行的，例如使用参数过滤。这能解决问题吗？</p><p id="439a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们试试另一个例子:</p><pre class="jq jr js jt fq kf kg kh ki aw kj dt"><span id="d242" class="kk kl hu kg b fv km kn l ko kp">POST /index.php?page_id=1 HTTP/1.1<br/>Host: www.unionselect1.eu<br/>Cookie: page_id=3<br/>Content-Length: 9<br/>Content-Type: application/octet-stream application/x-www-form-urlencoded</span><span id="25c9" class="kk kl hu kg b fv kr kn l ko kp">page_id=2</span></pre><p id="24de" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这一次，我把饼干加到了等式中。是的，您是对的:日志文件仍然显示</p><pre class="jq jr js jt fq kf kg kh ki aw kj dt"><span id="f28e" class="kk kl hu kg b fv km kn l ko kp">423.619.551.990 — — [06/Jul/2018:14:44:05 +0300] "POST /index.php?page_id=1 HTTP/1.1" 200 795 "-" "-"</span></pre><p id="fbb7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是这次页面上的输出显示“当前页面ID是3”。似乎这一次，应用程序使用了Cookie值。</p><p id="36c4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一个解决方案是记录所有的cookie参数，但是记录的数量只会增加，这对您有帮助吗？如果在某个时候您要查看日志，您仍然需要了解应用程序使用了哪些参数。</p><p id="d84c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了说明，这里有一个小测验:下面的请求会在页面上显示什么，您会在日志事件中找到什么？</p><pre class="jq jr js jt fq kf kg kh ki aw kj dt"><span id="a8ff" class="kk kl hu kg b fv km kn l ko kp">POST /index.php?page_id=1&amp;page_id=4 HTTP/1.1<br/>Host: www.unionselect1.eu<br/>Content-Length: 29<br/>Content-Type: application/octet-stream application/x-www-form-urlencoded</span><span id="665e" class="kk kl hu kg b fv kr kn l ko kp">page_id=2&amp;page_id=5</span></pre><p id="5e99" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="ks">(提示:页面显示5) </em></p><p id="a94f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是这个怎么样？</p><pre class="jq jr js jt fq kf kg kh ki aw kj dt"><span id="24ff" class="kk kl hu kg b fv km kn l ko kp">POST /index.php?page_id=1&amp;page_id=4 HTTP/1.1<br/>Host: www.unionselect1.eu<br/>Cookie: page_id=3; page_id=6<br/>Content-Length: 19<br/>Content-Type: application/octet-stream application/x-www-form-urlencoded</span><span id="18e1" class="kk kl hu kg b fv kr kn l ko kp">page_id=2&amp;page_id=5</span></pre><p id="6f65" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="ks">(提示:不是6，是3) </em></p><h1 id="7306" class="kt kl hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated"><strong class="ak">等等，这是什么巫术！？！</strong></h1><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff lq"><img src="../Images/70bf009473981cbe3e6a3ab6b40f0834.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*AKEFwwb5JQyxw3qmc2BuPQ.jpeg"/></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Generated at <a class="ae kq" href="https://imgflip.com/memegenerator/Jackie-Chan-WTF" rel="noopener ugc nofollow" target="_blank">https://imgflip.com/memegenerator/Jackie-Chan-WTF</a></figcaption></figure><p id="3b73" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">回答Jackie:这与三个因素有关:</p><ol class=""><li id="257d" class="lr ls hu it b iu iv iy iz jc lt jg lu jk lv jo lw lx ly lz dt translated">事实上，代码使用了前面提到的$_REQUEST数组，该数组结合了GET、POST和COOKIE数组，从而使您能够从同一个数组中访问所有请求参数。</li><li id="b579" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">PHP.ini中的“request_order”参数描述了PHP寄存器获取、发布和Cookie变量到$_REQUEST数组中的顺序。</li><li id="5592" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">PHP.ini中的“variables_order”设置了EGPCS(环境、Get、Post、Cookie和服务器)变量解析的顺序。</li></ol><p id="f413" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">换句话说:糟糕的软件开发实践和应用服务器配置的结合可能会导致这样一种情况，即记录的信息可能没有表达应用程序的行为。相同的代码在不同的服务器上可以有不同的工作方式，这取决于PHP在服务器上的配置，使用不同的请求参数(取决于它们的顺序)。</p><h1 id="b08b" class="kt kl hu bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated"><strong class="ak">有什么解决办法？</strong></h1><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mf"><img src="../Images/6be5b2fb6115d743e769267638bf5971.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-UpUtKEzUtDWX9Ja7aFUTQ.jpeg"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">By secretlondon123 (originally posted to Flickr as way out) [CC BY-SA 2.0], via Wikimedia Commons</figcaption></figure><ol class=""><li id="f433" class="lr ls hu it b iu iv iy iz jc lt jg lu jk lv jo lw lx ly lz dt translated">在应用程序中使用日志记录，并记录程序实际使用的输入值。登录Apache也是一个好主意(例如，记录带有意外输入值的攻击等)，但是如果您想了解应用程序中正在发生的事情，您必须登录应用程序级别并尽可能接近数据处理。</li><li id="b8ba" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">一个朋友曾经告诉我:“<em class="ks">一个好的程序做它应该做的事情。一个安全的程序只做它应该做的事情。只使用预期的参数作为输入值，并且只使用来自预期来源的参数。因此，在需要GET和POST时，不要使用REQUEST，而是使用GET和POST。</em></li><li id="5f7a" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">了解您的系统，了解您的设置，并在实践中测试您的实施。当您正在解决一个事件并且已经在分析日志时，没有时间去弄清楚“哪个参数做了什么”。你必须事先知道你的应用程序是如何工作的。</li></ol></div></div>    
</body>
</html>