<html>
<head>
<title>Image Thumbnail in Elixir using ImageMagick</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用ImageMagick的Elixir中的图像缩略图</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/image-thumbnail-in-elixir-using-imagemagick-215b8ab5f23f?source=collection_archive---------34-----------------------#2018-07-16">https://medium.com/hackernoon/image-thumbnail-in-elixir-using-imagemagick-215b8ab5f23f?source=collection_archive---------34-----------------------#2018-07-16</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/da4d043eda4039676c35984ba0e5d617.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8qqv4m3idvI9ranFEC6taw.jpeg"/></div></div></figure><p id="1c39" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当你处理图像时，你离不开缩略图。对于大图像，缩略图为我们提供了一种浏览图像的方式，而不用担心图像的实际大小，也不用等待它完成下载，这样我们就可以看到图像的全部内容。</p><p id="7dc4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们的整个附件功能已经准备就绪，我们已经找到了Elixir/Phoenix world中唯一可用的选项— <a class="ae ka" href="https://github.com/talklittle/thumbnex" rel="noopener ugc nofollow" target="_blank"> Thumbnex </a>，用于生成缩略图。除了生成缩略图之外，一切都很好。Thumbnex出现以下错误:</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="4ee3" class="kk kl hu kg b fv km kn l ko kp"><br/> ** (ErlangError) Erlang error: :enoent<br/> (elixir) lib/system.ex:622: System.cmd(“ffprobe”, [“-show_format”, “/var/folders/k2/37ht7xpx4g1fswv0cn003gp80000gp/T/plug-1531/multipart-739416–202247–1”], [stderr_to_stdout: true])<br/> lib/ffprobe.ex:47: FFprobe.format/1<br/> lib/thumbnex/animations.ex:6: Thumbnex.Animations.duration/1<br/> lib/thumbnex.ex:35: Thumbnex.create_thumbnail/3</span></pre><p id="18dd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">只是给你一些背景<code class="eh kq kr ks kg b">Thumbnex</code> hex包使用ImageMagick和<code class="eh kq kr ks kg b">FFmpeg</code>来操纵图像和媒体文件生成缩略图。</p><p id="e398" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">ImageMagick是一个命令行工具，用于调整大小、翻转、镜像、旋转、扭曲、剪切和变换图像。我们可以用<code class="eh kq kr ks kg b">sudo apt-get imagemagick</code>把它安装在我们的机器上。</p><p id="794c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">FFmpeg 也是一个命令行工具，可以处理视频、音频和其他多媒体文件。</p><p id="d52e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">由于我们最感兴趣的是图像缩略图生成，ImageMagick可以帮助我们在内部做到这一点。但是这篇博客将帮助你从Elixir开始使用上述工具。</p></div><div class="ab cl kt ku hc kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hn ho hp hq hr"><p id="ca88" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">回到上面的错误，这个错误与<code class="eh kq kr ks kg b">ffprobe</code>有关，它是FFmpeg提供的一个工具，用于打印与媒体文件相关的信息。最初，我认为这可能与我的系统有关，所以我在另一台机器上尝试了一下，它抛出了同样的错误。此外，我不能相信这个prod。</p><p id="c393" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所以我开始寻找其他方法来完成同样的任务。不幸的是，我找不到任何其他生成缩略图的十六进制包。</p><p id="dc18" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">于是我继续探索，自己动手。所以第一步是使用ImageMagick()从命令行生成缩略图。所以我找到了<a class="ae ka" href="http://www.imagemagick.org/Usage/thumbnails" rel="noopener ugc nofollow" target="_blank">这个方便的命令</a>，它的作用是:</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="5968" class="kk kl hu kg b fv km kn l ko kp"><br/>convert -define jpeg:size=500x180 trackive-staging/attachments/scope.id/sample.jpeg -auto-orient -thumbnail 250x90 -unsharp 0x.5 sample_thumb.jpeg<br/><br/>Note: Make sure you have ImageMagick installed on your machine.</span></pre><p id="9e60" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh kq kr ks kg b">-thumbnail</code> -它会调整图片大小，删除所有的个人资料和评论数据，使其变小。</p><p id="b3fd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh kq kr ks kg b">-define jpeg:size=</code> —用于设置原始图像的初始尺寸，该尺寸已被设置为最终图像尺寸的两倍，以使其清晰可见且看起来不模糊。它用于避免对大型输入图像进行操作。</p><p id="e9ce" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh kq kr ks kg b">-auto-orient</code> —用于将图像设置为正确的方向。如果图像来自相机，这很有帮助。</p><p id="9ae2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh kq kr ks kg b">- unsharp</code>——因此，在<code class="eh kq kr ks kg b">-thumbnail</code>调整大小操作后，你可以通过稍微锐化图像(使用<code class="eh kq kr ks kg b">-unsharp</code>)来改善上述结果。</p><p id="46f5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在<code class="eh kq kr ks kg b">-thumbnail</code>后指定所需的缩略图尺寸。</p><p id="f1cc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">上面的命令应该给我们所需的图像缩略图。一旦完成，我们将有兴趣使用Elixir以编程方式完成它。</p><p id="1494" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在Elixir中，<a class="ae ka" href="https://hexdocs.pm/elixir/System.html#cmd/3" rel="noopener ugc nofollow" target="_blank"> System.cmd </a>可以直接与主机系统交互，这意味着我们传递给这个函数的任何命令都在本地命令行上执行。现在我们知道了这个命令，并且知道了如何以编程方式运行它来生成动态图像缩略图。</p></div><div class="ab cl kt ku hc kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hn ho hp hq hr"><p id="9d8c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">因此，可以直接用于从原始图像获取缩略图的最终灵丹妙药代码如下:</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="6bbd" class="kk kl hu kg b fv km kn l ko kp"><br/>defmodule Image.Transformer do<br/> def transform(original_file, operation \\ “convert”) do<br/>    #1 get thumbnail file name<br/>    thumb_path = generate_thumb_file(original_file)<br/> <br/>    #2 generate thumbnail by passing appropriate parameters<br/>    System.cmd(operation, operation_commands(original_file_path, thumb_path))<br/> <br/>    #3 return the generated thumbnail<br/>    thumb_path<br/> end</span><span id="2fc1" class="kk kl hu kg b fv la kn l ko kp"> defp generate_thumb_file(original_file) do<br/>    original_file<br/>    |&gt; String.replace(“.”, “_thumb.”)<br/> end</span><span id="3cac" class="kk kl hu kg b fv la kn l ko kp"> defp operation_commands(original_file_path, thumb_path, size \\ “250x90”) do<br/>    [<br/>     “-define”,<br/>     “jpeg:size=500x180”,<br/>     original_file_path,<br/>     “-auto-orient”,<br/>     “-thumbnail”,<br/>     size,<br/>     “-unsharp”,<br/>     “0x.5”,<br/>     thumb_path<br/>    ]<br/> end<br/>end</span></pre><p id="747b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先，我们获取原始图像文件，并为其缩略图生成一个文件名。因此，如果文件名是<code class="eh kq kr ks kg b">sample.jpeg</code>，那么缩略图文件名将是<code class="eh kq kr ks kg b">sample_thumb.jpeg</code>。</p><p id="9b20" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后，我们使用<code class="eh kq kr ks kg b">System.cmd</code>在主机上运行ImageMagick命令。</p><p id="b5e3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">由于我们将缩略图文件名传递给了<code class="eh kq kr ks kg b">convert</code>命令，那就是我们的文件新生成的文件。检查原始图像文件目录以确认是否生成了缩略图。</p><p id="38e7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我把这个加入了我的GitHub要点。<br/><a class="ae ka" href="https://gist.github.com/trojanh/319d8c01b3c4c139bd1df930ea1c5d48" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/trojanh/319 D8 c 01 B3 C4 c 139 BD 1 df 930 ea 1c 5d 48</a></p><p id="2d91" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您知道ImageMagick，您知道Elixir，使用ImageMagick(或任何其他工具，如FFmpeg)的任何操作都可以轻松地从这个文件进行任何转换。</p><p id="7aec" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">编辑:似乎这个错误是因为我的机器上安装了损坏的<code class="eh kq kr ks kg b">FFmpeg</code>。因此，从命令行重新安装FFmpeg将解决Thumbnex的问题。</p></div></div>    
</body>
</html>