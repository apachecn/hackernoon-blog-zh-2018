<html>
<head>
<title>K8 Istio little Deep Dive</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8是一个小深潜</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/k8-istio-deep-dive-c0773a204e82?source=collection_archive---------7-----------------------#2018-07-21">https://medium.com/hackernoon/k8-istio-deep-dive-c0773a204e82?source=collection_archive---------7-----------------------#2018-07-21</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="7944" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我一直在玩<strong class="it hv"> Istio </strong>大多是出口，但今天我想写的是<strong class="it hv">入口</strong>。</p><p id="9e14" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">基本上<strong class="it hv">Istio</strong>Ingres是一些代理(<strong class="it hv">特使</strong>)，它们相互交谈以处理一般的访问、节流和应用程序路由。</p><p id="8f9d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">关于<strong class="it hv"> istio </strong>方法真正有趣的是sidecar注入，想象你正在运行一个容器execs <strong class="it hv"> nginx </strong> (port80 )S</p><p id="6691" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> istio </strong>所做的是"<strong class="it hv">注入</strong>一个sidecar容器，它运行在同一个pod上，这意味着与<strong class="it hv">特权</strong>模式和<strong class="it hv"> NET_ADMIN </strong>功能共享内核网络名称空间。</p><p id="441f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过这种方式，他们可以保证对服务或相互tls进行全面跟踪。</p><p id="7eb1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">简单来说，它看起来像这样:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/d985850e032e552f2f8e4c3790562b72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OiYNhTf7RW-24-JweVouyQ.png"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Istio workflow</figcaption></figure><p id="a8ae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这与传统的nginx入口有很大的不同，nginx入口与一个可向pod提供iptables的服务对话，例如:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kf"><img src="../Images/888c30eefe55736e994c07a3ff810fbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rojQsepl0KiquUh6XMb6-A.png"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">nginx ingress workflow</figcaption></figure><p id="8086" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">那么主要区别是什么呢？这个容器叫做istio-proxy，它拦截T21流量，我对它拦截流量的方式特别感兴趣。</p><p id="c347" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">提示是当你看到:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kg"><img src="../Images/ab74a0e55b65b29f9c53f7b9945dc2ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oHNRBZ5uZqhFRcBSpYnTLA.png"/></div></div></figure><p id="355e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这意味着在内核名称空间所代表的struct net(或pod)中，这个容器需要有<strong class="it hv">特权</strong>并拥有<strong class="it hv"> NET_ADMIN </strong>，如果您管理ti <strong class="it hv"> SOCK </strong>选项，如<strong class="it hv"> IP_TRANSPARENT </strong>或管理IPTables规则，而不是针对kube主机，而是针对绑定pod的struct net，这一点尤其重要。</p><p id="e336" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，如果您在8000上创建了使用nginx侦听的pod，并为其注入了istioctl，那么边车上的iptables将看起来像这样(注意，您必须在启用特权模式的情况下输入它<strong class="it hv">docker exec—privileged-it 75375 F8 d4c 98 bash)</strong></p><pre class="jq jr js jt fq kh ki kj kk aw kl dt"><span id="198a" class="km kn hu ki b fv ko kp l kq kr">root@nginx-847679bd76-mj4sw:~# iptables -t nat -S<br/>-P PREROUTING ACCEPT<br/>-P INPUT ACCEPT<br/>-P OUTPUT ACCEPT<br/>-P POSTROUTING ACCEPT<br/>-N ISTIO_INBOUND<br/>-N ISTIO_OUTPUT<br/>-N ISTIO_REDIRECT<br/>-A PREROUTING -p tcp -j ISTIO_INBOUND<br/>-A OUTPUT -p tcp -j ISTIO_OUTPUT<br/>-A ISTIO_INBOUND -p tcp -m tcp --dport 80 -j ISTIO_REDIRECT<br/>-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -j ISTIO_REDIRECT<br/>-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN<br/>-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN<br/>-A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN<br/>-A ISTIO_OUTPUT -j ISTIO_REDIRECT<br/>-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001</span></pre><p id="e840" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在很明显，这是将所有传入流量重定向到80到150001，这是istio-proxy的bonud，envoy做到了这一点，它会将流量发送到nginx(80)。</p><p id="f42c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">netstat显示:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ks"><img src="../Images/3f89fc2acac6cf492baf349c49ca4a45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aJKiZJc88ty68OJBEKyU_g.png"/></div></div></figure><p id="b176" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">15001在那里，让我们看看tcpdump:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kt"><img src="../Images/a13603edcaed800a5648657a80c48750.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gFYo2iF5MutrK1ga0pDebg.png"/></div></div></figure><p id="4cd5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，最初有流量到达端口80，但它被重定向到本地主机:15001，这是特使，下一步实际上是将流量发送到nginx itelf，这就是为什么我们看到一个双"<strong class="it hv"> HEAD </strong>"请求，一个发送到特使(由iptales强制)，一个发送到nginx。</p><p id="d03c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">稍后我会再写一些关于如何设置所有入口元素的内容。</p></div></div>    
</body>
</html>