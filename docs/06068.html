<html>
<head>
<title>Managing Separate AWS Accounts 🌗Automating, Deploying &amp; Securing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">管理单独的AWS帐户🌗自动化、部署和保护</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/managing-seperate-aws-accounts-iam-deployments-e7e3ca038d53?source=collection_archive---------9-----------------------#2018-07-23">https://medium.com/hackernoon/managing-seperate-aws-accounts-iam-deployments-e7e3ca038d53?source=collection_archive---------9-----------------------#2018-07-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/e0fb887883762b89940baee8e73fe475.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W-zmvX8FXTXSVJtu2fqhXA.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">An account for every color of the rainbow</figcaption></figure><p id="ff05" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">拥有独立的AWS帐户是最近的开发运营热潮，以美化我们的工具包(当然不包括kubernetes ),这是有充分理由的！分离AWS帐户来管理环境甚至产品是一个好主意。如果做得好，这是另一种能帮助你晚上入睡的东西。好处是:</p><ul class=""><li id="a142" class="ke kf hu ji b jj jk jn jo jr kg jv kh jz ki kd kj kk kl km dt translated"><strong class="ji hv">安全！</strong>跨AWS帐户的关注点分离意味着完全不同的IAM用户、角色&amp; API密钥集合。现在，您的生产帐户将最终不会向您的每个开发人员公开。</li><li id="421b" class="ke kf hu ji b jj kn jn ko jr kp jv kq jz kr kd kj kk kl km dt translated"><strong class="ji hv">开发速度快，开发者轻松！</strong>开发者只会怕碰生产账号里的东西。这意味着您的其他帐户不会膨胀，同时还能拆分其他环境。这是低估了，开发商将能够发挥&amp;建立更多！<strong class="ji hv">为每个人创造发展机会！</strong></li><li id="2b4a" class="ke kf hu ji b jj kn jn ko jr kp jv kq jz kr kd kj kk kl km dt translated"><strong class="ji hv">计费</strong>。你可以停止支付AWS账单的2%来分析你的账单。您可以使用内置的<a class="ae ks" href="https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/consolidated-billing.html" rel="noopener ugc nofollow" target="_blank">合并计费</a>，明确了解每个环境的财务状况。</li></ul><p id="c390" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我将向您展示Avoss如何处理他们的多帐户设置，重点关注<strong class="ji hv">部署、安全&amp;开发人员访问</strong>。</p><p id="9955" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">但是要注意！银弹是不存在的，多账户有它自己的权衡！学习IAM需要时间，迁移到多个账户将是一件令人头疼的事情。</p><p id="5816" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">旁注* </strong>如果你没有使用某种基础设施作为代码解决方案，运行一个多AWS帐户设置将会非常困难&amp;繁琐。在Avoss的这篇博文&amp;中，我们使用了<a class="ae ks" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank">云信息</a>。如果你想把基础设施作为代码来研究，我在上一篇博客文章<a class="ae ks" href="https://hackernoon.com/your-infrastructure-as-code-cloudformation-vs-terraform-34ec5fb5f044" rel="noopener ugc nofollow" target="_blank">cloud formation Vs terra form</a>中做了一个比较。</p><h2 id="b885" class="kt ku hu bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln dt translated">IAM和部署</h2><p id="f68e" class="pw-post-body-paragraph jg jh hu ji b jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd hn dt translated">你的第一期杂志将会是《我是谁》。谁有权访问什么？一切是如何部署的？怎么才能减少访问！ARHH不要提交访问键(是的，我们都做过)！让人应接不暇。</p><p id="6bac" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们多环境客户的<strong class="ji hv">目标是:</strong></p><ul class=""><li id="0a05" class="ke kf hu ji b jj jk jn jo jr kg jv kh jz ki kd kj kk kl km dt translated">你的生产账户应该没有松散的API密匙。</li><li id="437a" class="ke kf hu ji b jj kn jn ko jr kp jv kq jz kr kd kj kk kl km dt translated">开发人员应该仍然能够拥有对生产的完全<strong class="ji hv">读取权限</strong>，但是变化应该在您的持续集成中发生。</li></ul><p id="4ae4" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">我们可以两者兼得。</strong>或者至少只有两个API键，如果您的持续集成运行在AWS基础设施之外的话。</p><h2 id="aac5" class="kt ku hu bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln dt translated">我们开始吧</h2><p id="1096" class="pw-post-body-paragraph jg jh hu ji b jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd hn dt translated">我知道这会让您感到畏缩，但是首先我们必须手动创建一个用户或角色。除非有我不知道的事情，否则必须手动创建用户或角色，以创建将启动您的部署的第一个初始用户或角色。唯一的另一种情况是使用您的根凭证，这绝对是不行的☠️.这必须在每个环境中完成。</p><p id="3fbc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">手动创建的用户或角色将用于为每个环境中的所有部署创建其余的IAM角色和权限。这给了我们一些优势，你所有的IAM角色和权限，将很容易被看到&amp;服从代码审查。再加上持续集成，角色和权限将很好地在您的所有客户中滚动。</p><p id="1003" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">但是<strong class="ji hv">这听起来可能有点吓人</strong>，给一个手动创建的用户或角色权限来执行你整个帐户的所有权限&amp;角色！哇，这太可怕了，但是我们可以采取适当的措施来确保这些权限尽可能地锁定。其次，如果您在AWS内部使用持续集成解决方案，您可以让<a class="ae ks" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html#roles-usingrole-ec2instance-roles" rel="noopener ugc nofollow" target="_blank"> EC2实例承担</a>部署角色&amp;拥有我向您的生产帐户承诺的零API密钥。让您的部署无比安全。</p><p id="9063" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">下面是手动创建的用户或角色的附加策略。</p><figure class="lt lu lv lw fq iv"><div class="bz el l di"><div class="lx ly l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Tight policies of the manually created User or Role</figcaption></figure><p id="8126" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">你会注意到</p><ul class=""><li id="e7d5" class="ke kf hu ji b jj jk jn jo jr kg jv kh jz ki kd kj kk kl km dt translated">它<strong class="ji hv">只能执行你特别命名的特定堆栈</strong></li><li id="2da4" class="ke kf hu ji b jj kn jn ko jr kp jv kq jz kr kd kj kk kl km dt translated">它只能<strong class="ji hv">创建您指定的特定用户&amp;特定角色</strong></li></ul><p id="620c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这意味着，即使这个角色或用户受到威胁，攻击者也需要知道您的<strong class="ji hv">确切堆栈名称</strong>、<strong class="ji hv">角色</strong>和/或<strong class="ji hv"> IAM用户</strong>。如果你想变得非常硬核，你可以在这些名字中加入一些随机垃圾。现在安全了！</p><p id="047e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">好了，现在我们有了一个可以创建更多角色的用户，我们要去哪里？到一个API密匙不存在的地方&amp;我们有最大的安全性。<a class="ae ks" href="https://youtu.be/EgqUJOudrcM?t=36s" rel="noopener ugc nofollow" target="_blank"> <strong class="ji hv">涅槃。</strong>T25】</a></p><figure class="lt lu lv lw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lz"><img src="../Images/0c495d4cc8a4e47ab0ce33b695685b43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xk4XKDq4UVevUD2dIB7fOA.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">This scenario repeats over every AWS account you wish to use for deployments</figcaption></figure><p id="dc83" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在这个图的中心是<code class="eh ma mb mc md b">${env}-roles-stack.yml</code>，你可以在这里检查<a class="ae ks" href="https://gist.github.com/nathanmalishev/12e0857ae2946a84849c7b8f83d9dcac" rel="noopener ugc nofollow" target="_blank">。这就是您的其余IAM角色&amp;权限的来源。</a></p><p id="001e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这个<code class="eh ma mb mc md b">${env}-roles-stack.yaml</code>创建了一个特定的部署用户或角色&amp;特定的角色，它只能针对特定的栈执行。这与我们手动创建的用户或角色非常相似，除了每个未来的部署角色还指定了可以承担它的确切内容，无论是CloudFormation还是部署用户或角色。当您的基础设施被分解时，这一点非常有效。</p><figure class="lt lu lv lw fq iv"><div class="bz el l di"><div class="lx ly l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">A brief look at <a class="ae ks" href="https://gist.github.com/nathanmalishev/12e0857ae2946a84849c7b8f83d9dcac" rel="noopener ugc nofollow" target="_blank">${env}-roles-stack.yml</a>, for the full example</figcaption></figure><p id="0971" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">你会注意到角色和用户之间的关系是双向的。该角色被明确告知只能由用户承担。虽然我们告诉用户它被允许承担角色&amp;还被允许执行特定的CloudFormation堆栈，但这需要角色。替代从用户处承担角色的方法是将角色传递给CloudFormation栈&amp;在角色上指定只允许CloudFormation承担该角色。</p><p id="e7ab" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这意味着，如果攻击者在这一点上损害我们的部署CI，他们将再次需要角色的<strong class="ji hv">确切名称、</strong>和<strong class="ji hv">确切堆栈名称</strong> &amp;，无论该角色是被<strong class="ji hv">传递给某个服务还是被假定为</strong>。</p><figure class="lt lu lv lw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff me"><img src="../Images/64bfd96bc0ad231f7ac419788cbabae3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7oslvwPYhkIRmaaOpB3RAg.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Assuming the deployment role, when passing the role isn’t available</figcaption></figure><figure class="lt lu lv lw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mf"><img src="../Images/a098daf10f6eb0b329cb7b46ba550a45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kg2KrHTNusMJDzIBOS-WKw.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Passing roles to CloudFormation via command line when available</figcaption></figure><p id="cdcc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这很好&amp;非常安全的部署，但是多个AWS帐户发生了什么呢！</p><figure class="lt lu lv lw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mg"><img src="../Images/ac5d96249440b650a5c4f7b08b4642c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FwqK9cTcUabUvHntzfHnig.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The deployment to Multiple AWS Accounts or Environments</figcaption></figure><p id="d19c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这些管道中的每一个的部署都在您的AWS环境中复制。对于每个AWS帐户，都有一组部署角色&amp;一个共享的CloudFormation模板。您的持续集成应该处理部署的输入参数，如帐户详细信息、环境名称、区域等。而且这个图没有理由不能涉及你希望的那么多的账户！这很容易扩展，因为每个环境只有一个部署用户。</p><p id="0d01" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">本次部署的另一个注意事项</strong>。如果您将角色传递给CloudFormation堆栈以在执行时假设，您必须确保这些角色对于所述堆栈的任何未来修改都是存在的。包括删除，如果它不存在，CloudFormation就没有一个执行堆栈的角色！</p><h2 id="3e3d" class="kt ku hu bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln dt translated">再告诉我一次，为什么所有这些努力都是值得的？</h2><p id="b0fb" class="pw-post-body-paragraph jg jh hu ji b jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd hn dt translated"><strong class="ji hv">非常安全！</strong>首先，您的第一道防线必须妥协，无论是手动创建的用户/角色，还是部署用户/角色。然后，攻击者必须弄清楚这些权限是与云信息相关的，并且只能针对某些角色对某些堆栈执行。如果他们碰巧知道堆栈名称，&amp; role部署角色应被锁定，这样爆炸半径仅影响该部分基础架构。</p><p id="c4f6" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">现在，如果您在这个过程中只使用了角色，那么您将有<strong class="ji hv">实际上零个API键</strong>部署过程。唯一的攻击可能来自接管您的受损EC2实例并继承该角色的人。这是不太可能的，尤其是如果您正在利用虚拟专用网络并保护您的实例！</p><h2 id="42e8" class="kt ku hu bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln dt translated">我能进入生产吗？</h2><p id="d577" class="pw-post-body-paragraph jg jh hu ji b jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd hn dt translated"><strong class="ji hv">是的！</strong>你可以像平常一样通过<strong class="ji hv"> web控制台&amp;命令行</strong>访问！您猜对了，您通过<code class="eh ma mb mc md b"><a class="ae ks" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_permissions-to-switch.html" rel="noopener ugc nofollow" target="_blank">switching roles</a> </code>从您的开发帐户授予您的生产帐户的访问权限。</p><p id="0fb7" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在您的生产帐户中，您创建了一个角色，拥有您想要的所有权限(但要严格限制！记住这是生产！).然后，您必须编辑<code class="eh ma mb mc md b">Trust Relationship</code>以允许您的开发帐户承担该角色。在您的开发帐户中，您可以创建一个策略并将其附加到所需的用户或组。该策略仅具有能够在您的生产帐户中承担角色的功能。</p><p id="2981" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然后你可以填写这个便捷的链接，它会提示你切换角色屏幕<code class="eh ma mb mc md b">https://signin.aws.amazon.com/switchrole?roleName=&lt;role_name&gt;&amp;account=&lt;target_account&gt;</code>。在您切换角色后，如果您有权限，您将能够像平常一样浏览UI。</p><figure class="lt lu lv lw fq iv fe ff paragraph-image"><div class="fe ff mh"><img src="../Images/b7d1e18a3fcd532eec69d03188d543bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:852/format:webp/1*GpqN8pbma3hb0j0Zs-B50Q.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Console UI after switching roles</figcaption></figure><p id="63bb" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这是无缝的&amp;很容易来回切换。除了它更容易，你甚至不必键入另一个密码！更好的是，您可以使用CLI来<code class="eh ma mb mc md b">assume-role</code>并像平常一样使用命令行！</p><h2 id="9936" class="kt ku hu bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln dt translated"><strong class="ak">合并计费</strong></h2><p id="111d" class="pw-post-body-paragraph jg jh hu ji b jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd hn dt translated">最后但同样重要的是，对于那些没看过的人来说。如果您将您的帐户设置为一个组织，您可以免费访问<a class="ae ks" href="https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/consolidated-billing.html" rel="noopener ugc nofollow" target="_blank">合并计费</a>。合并计费提供了每个帐户的价格分割，让您清楚地了解您的财务AWS健康状况！不仅如此，成本浏览器还了解你的每一个关联账户&amp;你可以把它应用到你的过滤器中，而不仅仅是依赖标签。</p><figure class="lt lu lv lw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mi"><img src="../Images/bb3a76c874b22cb566479aec16fdc7d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z7yeZk8bc2juRYiS9fcL2g.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">An example of what consolidated billing looks like</figcaption></figure><p id="40dc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">感谢阅读！如果你走到这一步，一定要留下掌声！</strong></p></div></div>    
</body>
</html>