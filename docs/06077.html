<html>
<head>
<title>Monitor and handle exceptions like a boss in angularjs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">像angularjs中的boss一样监控和处理异常</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/monitor-and-handle-exceptions-like-a-boss-in-angularjs-c5b034404fad?source=collection_archive---------18-----------------------#2018-07-23">https://medium.com/hackernoon/monitor-and-handle-exceptions-like-a-boss-in-angularjs-c5b034404fad?source=collection_archive---------18-----------------------#2018-07-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/d2e1c946ab62d656092b6585969b9496.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lQDZ3LDJf5bKwvLtocFGJw.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Photo by <a class="ae jg" href="https://unsplash.com/photos/PG3NsaGpY3s?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">rawpixel</a> on <a class="ae jg" href="https://unsplash.com/search/photos/computer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="7e1d" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated"><strong class="ak">我为什么要写这个</strong></h1><p id="7479" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">有时候，您可能希望能够更好地控制您的错误记录系统。您可能会考虑为angularjs应用程序实现一个异常处理机制，但是阻止您的可能是您必须编写的大量代码。此外，为了将代码包装到异常处理机制中，您可能需要进行大量的重构。</p><h1 id="b1fc" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">问题是</h1><p id="0e02" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">让我们从分析一些您可能已经编写或在您的应用程序中遇到的代码开始。</p><figure class="le lf lg lh fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ld"><img src="../Images/f5e0ab9a880eadbcc0b775645ceb070e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PpzudUcNWNDOcsmd2yWKHA.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="https://gist.github.com/saurabhpati/fca91e9a51861502e6ff2802074ea45d" rel="noopener ugc nofollow" target="_blank">suspiciousController.js</a></figcaption></figure><p id="b55a" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">你可以在这里查看上面的代码<a class="ae jg" href="https://gist.github.com/saurabhpati/fca91e9a51861502e6ff2802074ea45d" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="0201" class="ln ji hu bd jj lo lp lq jn lr ls lt jr kq lu lv jv ku lw lx jz ky ly lz kd ma dt translated">简单解释一下:</h2><p id="8756" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">这个控制器有一个功能<code class="eh mb mc md me b">doImportantStuff </code>，它主要调用<code class="eh mb mc md me b">suspiciousService</code>的一个服务<code class="eh mb mc md me b">doVeryImportantStuff</code>。options对象只是告诉服务是否抛出异常。如果是真的，它抛出一个JavaScript异常，这个异常不会在catch块中处理，因为catch块本质上是promise的拒绝处理程序。只有当承诺在服务中被拒绝时，它才会被执行，而不是在抛出异常时。</p><p id="7c23" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">如果你想知道<code class="eh mb mc md me b">suspiciousService.js</code>长什么样。在这里。</p><figure class="le lf lg lh fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mf"><img src="../Images/0faed1eb4f4d62c1cd7214b6f759cb55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2SC6wM8UPmNoc0GWzHe-_A.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="https://gist.github.com/saurabhpati/2921d9762d1a0d2f0a86aa720ec11566" rel="noopener ugc nofollow" target="_blank">suspicousService.js</a></figcaption></figure><p id="65ac" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">你可以在这里查看代码<a class="ae jg" href="https://gist.github.com/saurabhpati/2921d9762d1a0d2f0a86aa720ec11566" rel="noopener ugc nofollow" target="_blank"/></p><p id="43a1" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">现在，一个更实用的方法是将您的控制器代码包装在一个try catch块中，这意味着您的代码将如下所示。</p><figure class="le lf lg lh fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mg"><img src="../Images/ff912fa6b09a848f077b82b80252e6c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u7FEZdjtyyzVo81q7JujaQ.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="https://gist.github.com/saurabhpati/83ad684ff478091ccce338811505d865" rel="noopener ugc nofollow" target="_blank">A pragmatic suspiciousController</a></figcaption></figure><p id="f0cb" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">你可以在这里查看上面的代码<a class="ae jg" href="https://gist.github.com/saurabhpati/83ad684ff478091ccce338811505d865" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="5e0e" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">现在，您的JavaScript异常将被捕获并记录下来，如果您有一个从API中公开的端点来记录客户端错误，那么您可以向API提交错误，API会将它们记录到数据库中。</p><h1 id="34d3" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">这个想法</h1><p id="c52b" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">如果您在想，为什么首先要将客户端异常记录到数据库中呢？你可以把它作为一个插件来实现，例如，想象一下这样一种情况，你无法理解某个特定用户出了什么问题，因为他使用了你的应用程序可能不完全支持的特定浏览器/操作系统/机器等。因此，您可以暂时打开这个数据库记录前端异常<em class="mh">设置</em>或<em class="mh">标志</em>，并让用户重复这些步骤，将<em class="mh">设置</em>设为“关闭”，瞧！您将确切地了解由于用户使用特定的浏览器/操作系统/机器或由于用户面临特定问题的任何原因而导致该用户出错的信息。</p><p id="93b4" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">没有必要花费无数的时间去弄清楚你写的代码哪里出错了。只需注入一个错误日志记录服务，将您的异常提交给数据库，您将获得修复该错误所需的内容。如果您的应用程序运行在像<a class="ae jg" href="https://docs.microsoft.com/en-us/outlook/add-ins/quick-start?tabs=visual-studio" rel="noopener ugc nofollow" target="_blank"> <em class="mh"> Outlook桌面加载项</em> </a>这样无法调试的环境中，这就变得尤为重要。</p><p id="09bc" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">所有这些听起来不错，但仍然有一个小问题。</p><p id="6aea" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">还记得我们将代码包装在try catch块中吗？我们需要对所有的控制器都这样做。这太恶心了。那一点也不整洁。它散发着不想要的和丑陋的代码。现在，您可能希望通过将try catch块应用到您的服务来解决这个问题，因为这是异常真正重要的地方，如果发生异常，应该记录并知道。举个例子，如果主页出了问题，但是其他页面工作正常，并且您的所有服务都插入了异常处理，那么最有可能的原因就是<code class="eh mb mc md me b">homeController.js</code>文件(或者您用于主页的任何控制器)。</p><p id="586f" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">在这种情况下，<code class="eh mb mc md me b">suspiciousService.js</code>看起来会像这样</p><figure class="le lf lg lh fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mi"><img src="../Images/7d45e4c5e5ede8df2a6e857113aa7db7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u3-hbOrwc0DFc1asO8eA0Q.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">suspiciousService.js</figcaption></figure><p id="12b2" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">但是，即使我们把catch块从我们的控制器转移到我们的服务中，它仍然是令人讨厌的！在没有其他出路之前，没有人愿意在他们清醒的头脑中编写这种代码，不是吗？angularjs的猫里可能有什么东西可以救我们。</p><h1 id="455b" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">解决方案:输入$exceptionHandler</h1><p id="58c8" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">angularjs有一个<code class="eh mb mc md me b"><a class="ae jg" href="https://docs.angularjs.org/api/ng/service/$exceptionHandler" rel="noopener ugc nofollow" target="_blank">$exceptionHandler</a></code>服务，您可以使用它来委托在那里处理所有未捕获的异常。然而，<code class="eh mb mc md me b">$exceptionHandler</code>的默认实现将它委托给<code class="eh mb mc md me b"><a class="ae jg" href="https://docs.angularjs.org/api/ng/service/$log#error" rel="noopener ugc nofollow" target="_blank">$log.error</a></code>，后者将它记录到浏览器控制台。这不是我们想要的。我们需要将这个错误发送到我们的API，它将记录到数据库或电子邮件/通知某人。这意味着我们需要修改<code class="eh mb mc md me b">$exceptionHandler</code>的实现</p><h1 id="2547" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">API端点</h1><p id="abff" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">在我们修改<code class="eh mb mc md me b">$exceptionHandler</code>之前，让我们看一下将异常记录到数据库中的日志服务。如果您现在不太关注API端点，可以跳过这一部分。为了文章的完整性，我已经包括了这一点。</p><p id="4693" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">我已经使用<a class="ae jg" href="https://docs.microsoft.com/en-us/aspnet/core/tutorials/first-web-api?view=aspnetcore-2.1" rel="noopener ugc nofollow" target="_blank"> dot net core API </a>实现了这一点，如果你愿意，你可以使用<a class="ae jg" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> node </a>和<a class="ae jg" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> express </a>做同样的事情。</p><p id="3f80" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated"><code class="eh mb mc md me b">LogService.cs</code>是一个有作用域的服务，只有在遇到记录异常的请求时才会被创建。</p><p id="c9d5" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated"><a class="ae jg" href="https://gist.github.com/saurabhpati/5cef411b8db8fdd916bcc243353df0c8" rel="noopener ugc nofollow" target="_blank"><em class="mh">logservice . cs</em></a></p><figure class="le lf lg lh fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mj"><img src="../Images/4cfbcf810991674f3870f1dd960141c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BsTFrY9_APfHyjeM_dCXIw.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">LogService.cs</figcaption></figure><p id="7328" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated"><a class="ae jg" href="https://gist.github.com/saurabhpati/5cef411b8db8fdd916bcc243353df0c8" rel="noopener ugc nofollow" target="_blank"><em class="mh">logs controller . cs</em></a></p><figure class="le lf lg lh fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mk"><img src="../Images/1384f0db960bc42d079744cb0fef8a37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YQ8d0kq5ZFXH2mudvpqelQ.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">LogsController.cs</figcaption></figure><h1 id="04b3" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">修改$exceptionHandler</h1><p id="05a8" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc hn dt translated">按照我们的用例，我们以这种<em class="mh">方式修改$exceptionHandler。</em></p><p id="88f4" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated"><a class="ae jg" href="https://gist.github.com/saurabhpati/415050b92f3b5b6e3591332c33462f3f" rel="noopener ugc nofollow" target="_blank"><em class="mh">$异常处理程序</em> </a> <em class="mh"> : </em></p><figure class="le lf lg lh fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ml"><img src="../Images/f21a25e29af6042b3bb73838e9b0e206.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gxnMEP60xX0c4PZo2eF-zw.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Implementing your own $exceptionHandler</figcaption></figure><p id="af69" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">你可以在这里查看代码<a class="ae jg" href="https://gist.github.com/saurabhpati/415050b92f3b5b6e3591332c33462f3f" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="9895" class="jh ji hu bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dt translated">结论</h1><ul class=""><li id="6c2e" class="mm mn hu kh b ki kj km kn kq mo ku mp ky mq lc mr ms mt mu dt translated">如果你查看任何网络调试工具，如<a class="ae jg" href="https://www.telerik.com/fiddler" rel="noopener ugc nofollow" target="_blank"> fiddler </a>或<a class="ae jg" href="https://code.tutsplus.com/articles/chrome-dev-tools-networking-and-the-console--net-28167" rel="noopener ugc nofollow" target="_blank">浏览器</a>，你可以看到细节被提交给服务器。</li></ul><figure class="le lf lg lh fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mv"><img src="../Images/b5b3693ec1a6824438e30cb96272368f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I-IVmBBpbd0viTdjNoPmmA.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Exception Submitted to Server.</figcaption></figure><ul class=""><li id="449d" class="mm mn hu kh b ki li km lj kq mw ku mx ky my lc mr ms mt mu dt translated">随着try catch块的消失，我们的控制器和服务变得更加干净。</li><li id="58c6" class="mm mn hu kh b ki mz km na kq nb ku nc ky nd lc mr ms mt mu dt translated">所有未捕获的异常都被处理和报告，并且可以根据需要打开和关闭。</li><li id="76df" class="mm mn hu kh b ki mz km na kq nb ku nc ky nd lc mr ms mt mu dt translated">我们已经转向更有效的异常处理机制，该机制可靠、灵活、可维护，更重要的是，它让我们能够在用户选择的时间处理他们已经记录或报告的错误。</li></ul></div><div class="ab cl ne nf hc ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="hn ho hp hq hr"><p id="e78c" class="pw-post-body-paragraph kf kg hu kh b ki li kk kl km lj ko kp kq lk ks kt ku ll kw kx ky lm la lb lc hn dt translated">如果你已经读到这里，感谢你阅读它。我会关注这篇文章的任何反馈或建议。</p></div></div>    
</body>
</html>