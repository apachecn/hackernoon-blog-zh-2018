<html>
<head>
<title>Painlessly managing long running processes in your views using Ruby on Rails</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Ruby on Rails轻松管理视图中长时间运行的流程</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/painlessly-managing-long-running-processes-in-your-views-using-ruby-on-rails-a83f57b51c31?source=collection_archive---------19-----------------------#2018-07-23">https://medium.com/hackernoon/painlessly-managing-long-running-processes-in-your-views-using-ruby-on-rails-a83f57b51c31?source=collection_archive---------19-----------------------#2018-07-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/95265418447d1c28669c3707743bf14d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hIGdvHPeKLqfCK4F"/></div></div></figure><p id="d2bc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在Rails的<a class="ae ka" href="https://hackernoon.com/tagged/ruby" rel="noopener ugc nofollow" target="_blank"> Ruby </a>中，目前还没有方便的或者自然的方式将信息从后端直接传输到视图中。当试图在后端传输关于长时间运行的进程的进度的信息时(例如图像的处理)，这尤其不方便。可以简单地使用JavaScript每隔几秒/几分钟发出一次XHR/获取请求来请求更新的信息，但这与其说是一个实际的解决方案，不如说是一种变通方法。</p><p id="0964" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这个问题已经被其他开发人员探索过了(例如<a class="ae ka" href="https://tg.pl/drab" rel="noopener ugc nofollow" target="_blank">托马兹·格里什凯维奇在他关于“长生不老药”的单调</a>的工作中)，普遍的共识似乎是使用WebSockets或SSEs来轻松可靠地将信息从后端实时转发到前端。</p><p id="f0b9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">虽然Ruby on Rails确实为WebSockets提供了一个名为Action Cable的框架，但它并没有提供一种方便的方式来在流程状态改变时进行前端修改(这需要编写一个新的前端和后端代码集合)。此外，还需要为每个用户创建和管理单独的频道，以便将信息传递给他们。总的来说，这个过程是漫长的，需要标准化。</p><p id="c38c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了解决这些问题，Ruby on Rails有一个前端框架叫做<a class="ae ka" href="https://fie.eranpeer.co" rel="noopener ugc nofollow" target="_blank"> fie </a>，它通过一个永久的WebSocket连接在视图和后端之间同步应用程序的状态。如果你还没有使用过<a class="ae ka" href="https://fie.eranpeer.co" rel="noopener ugc nofollow" target="_blank"> fie </a>，你可以使用“<a class="ae ka" href="https://fie.eranpeer.co/start" rel="noopener ugc nofollow" target="_blank">快速入门</a>将它安装到你的应用程序中，然后按照我之前发布的一个简单的教程进行操作，这个教程的标题是“<a class="ae ka" href="https://hackernoon.com/make-a-slideshow-using-ruby-on-rails-in-50-lines-of-code-and-no-javascript-9fdf0a88ec9d" rel="noopener ugc nofollow" target="_blank">在没有JavaScript的情况下使用Ruby on Rails制作幻灯片”。</a></p></div><div class="ab cl kb kc hc kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hn ho hp hq hr"><figure class="kj kk kl km fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ki"><img src="../Images/88caeb49424ef6efdff32b8b2483b19f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*4yHNIZDkPnO0Wau1nU-sxQ.gif"/></div></div><figcaption class="kn ko fg fe ff kp kq bd b be z ek">The Result</figcaption></figure><p id="f8a4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们深入研究如何在<a class="ae ka" href="https://fie.eranpeer.co" rel="noopener ugc nofollow" target="_blank">域</a>中模拟和管理长时间运行的流程。</p><p id="098b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你可能已经知道<a class="ae ka" href="https://fie.eranpeer.co/guide#commander" rel="noopener ugc nofollow" target="_blank">命令器</a>，它们被<a class="ae ka" href="https://fie.eranpeer.co" rel="noopener ugc nofollow" target="_blank"> fie </a>使用，就像Ruby on Rails使用控制器一样。然而，由于长时间运行的进程是由位于<a class="ae ka" href="https://fie.eranpeer.co" rel="noopener ugc nofollow" target="_blank"> fie的</a> commanders外部的活动作业框架处理的，<a class="ae ka" href="https://fie.eranpeer.co" rel="noopener ugc nofollow" target="_blank"> fie </a>有另一个名为<code class="eh kr ks kt ku b"><a class="ae ka" href="https://fie.eranpeer.co/guide#manipulator" rel="noopener ugc nofollow" target="_blank">Manipulator</a></code>的特性，它为您的类注入了操纵用户视图状态的能力，就像commander一样。</p><p id="e53d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">通过将<code class="eh kr ks kt ku b"><a class="ae ka" href="https://fie.eranpeer.co/guide#manipulator" rel="noopener ugc nofollow" target="_blank">Manipulator</a></code>包含在您的类中，您为它们提供了对基本<a class="ae ka" href="https://fie.eranpeer.co" rel="noopener ugc nofollow" target="_blank"> fie </a> commander方法的访问，这些方法包括用于查看和更改共享状态的<code class="eh kr ks kt ku b">state</code>、<code class="eh kr ks kt ku b">execute_js_function</code>用于从后端执行JavaScript函数，以及<code class="eh kr ks kt ku b">commander_exists?</code>用于验证您想要操作其状态的commander/client是否仍然存在。</p><p id="9ed0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">重新创建上面GIF中显示的示例的第一步是在控制器中定义实例变量(或整体状态),如下所示:</p><figure class="kj kk kl km fq iv"><div class="bz el l di"><div class="kv kw l"/></div></figure><p id="44af" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如您所见，创建了两个实例变量，并将用于以下目的:</p><ul class=""><li id="0d5d" class="kx ky hu je b jf jg jj jk jn kz jr la jv lb jz lc ld le lf dt translated"><code class="eh kr ks kt ku b">@long_job_progress</code>跟踪我们模拟的长时间运行的作业的进度，在初始化时该进度为0/100。</li><li id="5c73" class="kx ky hu je b jf lg jj lh jn li jr lj jv lk jz lc ld le lf dt translated"><code class="eh kr ks kt ku b">@is_long_job_running</code>，验证长时间运行的作业当前是否正在运行。如果我们不跟踪作业是否已经在运行，我们就有让相同的作业同时运行多次的风险，特别是如果视图不阻止用户出于这样或那样的原因多次触发它。</li></ul><p id="53d2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在控制器中初始化状态后，下一步是创建视图，向用户显示长时间运行的作业的进度:</p><figure class="kj kk kl km fq iv"><div class="bz el l di"><div class="kv kw l"/></div></figure><p id="0117" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">根据作业是否已经运行，视图可能会显示两种情况中的一种(在<code class="eh kr ks kt ku b">@is_long_job_running</code>实例变量中表示)。</p><ol class=""><li id="2d60" class="kx ky hu je b jf jg jj jk jn kz jr la jv lb jz ll ld le lf dt translated">如果作业已经在运行，用户将会看到一个进度条，它等于<code class="eh kr ks kt ku b">@long_job_progress</code>实例变量的当前值和最大值100。因此，随着<code class="eh kr ks kt ku b">@long_job_progress</code>值的改变，进度条也会改变。</li><li id="6b38" class="kx ky hu je b jf lg jj lh jn li jr lj jv lk jz ll ld le lf dt translated">如果作业已经完成或尚未开始，用户将只看到一个按钮，提示他们开始长时间运行的作业。如果用户点击按钮，命令方法<code class="eh kr ks kt ku b">start_long_job</code>将被触发。</li></ol><p id="b341" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">由于该按钮当前正在触发我们的commander中一个名为<code class="eh kr ks kt ku b">start_long_job</code>的方法，并且它还不存在，我们将创建它。它应该是这样的:</p><figure class="kj kk kl km fq iv"><div class="bz el l di"><div class="kv kw l"/></div></figure><p id="07a4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先，如果作业当前正在运行，该方法简单地退出(通过空返回)。否则，<code class="eh kr ks kt ku b">@long_job_progress</code>的值被重置为0，并且通过将<code class="eh kr ks kt ku b">@is_long_job_running</code>的值修改为真来将长作业设置为正在运行。然后，实际的作业通过它的<code class="eh kr ks kt ku b">perform_later</code>方法被设置为异步运行。我们还将指挥官的标识符<code class="eh kr ks kt ku b">@connection_uuid</code>传递给作业，以便指挥官可以操纵我们的指挥官/视图的状态。</p><p id="14e8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在让我们创建我们一直在等待的零件，实际的<strong class="je hv">作业</strong>(在app/jobs文件夹中):</p><figure class="kj kk kl km fq iv"><div class="bz el l di"><div class="kv kw l"/></div></figure><p id="81c7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先需要注意的是，我们包含了从<code class="eh kr ks kt ku b">Manipulator</code>到<code class="eh kr ks kt ku b">include Fie::Manipulator</code>的模块，以便能够访问修改作业状态所必需的方法。</p><p id="4f8a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦我们包含了<code class="eh kr ks kt ku b">Fie::Manipulator</code>，下一步就是定义我们的作业的执行方法，该方法接受命令/视图的标识符<code class="eh kr ks kt ku b">connection_uuid</code>作为参数。为了让<code class="eh kr ks kt ku b">Fie::Manipulator</code>中包含的方法起作用，我们需要将实例变量<code class="eh kr ks kt ku b">@fie_connection_uuid</code>定义为等于我们想要操作其状态的commander/view的<code class="eh kr ks kt ku b">connection_uuid</code>。这样做之后，我们可以创建一个名为<code class="eh kr ks kt ku b">is_job_finished</code>的lambda文本，它将告诉我们作业的进度是否超过100。</p><p id="fe6e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">根据作业是否已完成运行(意味着客户端断开连接或作业以≥ 100的进度完成)，作业将完成两个操作之一。</p><ol class=""><li id="db8b" class="kx ky hu je b jf jg jj jk jn kz jr la jv lb jz ll ld le lf dt translated">如果客户端仍处于连接状态(通过<code class="eh kr ks kt ku b">commander_exists?</code>方法验证)并且作业仍在运行(通过调用<code class="eh kr ks kt ku b">is_job_running</code>验证)，<code class="eh kr ks kt ku b">@long_process_progress</code>的值增加10，等待1秒后，作业再次运行。用户会看到他们的进度条变得更加完整。</li><li id="c08f" class="kx ky hu je b jf lg jj lh jn li jr lj jv lk jz ll ld le lf dt translated">否则，<code class="eh kr ks kt ku b">@is_long_job_running</code>的值被设置为假，这将通知应用程序的所有其他部分作业已经完成运行。当他们的进度条再次转换成按钮时，用户会看到这一点。</li></ol><p id="e770" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你可以在https://fie.eranpeer.co/showcase#long-running-job的<a class="ae ka" href="https://fie.eranpeer.co/showcase#long-running-job" rel="noopener ugc nofollow" target="_blank">试试这个例子。</a></p><blockquote class="lm ln lo"><p id="6faa" class="jc jd lp je b jf jg jh ji jj jk jl jm lq jo jp jq lr js jt ju ls jw jx jy jz hn dt translated">访问项目页面:<a class="ae ka" href="https://fie.eranpeer.co" rel="noopener ugc nofollow" target="_blank">https://fie.eranpeer.co</a>或<a class="ae ka" href="https://github.com/raen79/fie" rel="noopener ugc nofollow" target="_blank">https://github.com/raen79/fie</a></p><p id="8994" class="jc jd lp je b jf jg jh ji jj jk jl jm lq jo jp jq lr js jt ju ls jw jx jy jz hn dt translated">联系我或提问:<a class="ae ka" href="mailto:eran.peer79@gmail.com" rel="noopener ugc nofollow" target="_blank">eran.peer79@gmail.com</a>或<a class="ae ka" href="https://gitter.im/rails-fie" rel="noopener ugc nofollow" target="_blank">https://gitter.im/rails-fie</a></p></blockquote><figure class="kj kk kl km fq iv"><div class="bz el l di"><div class="lt kw l"/></div></figure></div></div>    
</body>
</html>