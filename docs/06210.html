<html>
<head>
<title>How to add a realtime audit trail to your Laravel project</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何给你的Laravel项目添加实时审计跟踪</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-add-a-realtime-audit-trail-to-your-laravel-project-a2fa70411c88?source=collection_archive---------14-----------------------#2018-07-26">https://medium.com/hackernoon/how-to-add-a-realtime-audit-trail-to-your-laravel-project-a2fa70411c88?source=collection_archive---------14-----------------------#2018-07-26</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="7bb1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">审计线索是对数据模型所做的所有更改的记录。模型是可以存储在数据库中的任何实体，例如用户或产品。审计条目通常包含有关变更类型(创建、更新或删除)、<em class="jp">谁</em>进行了变更，以及<em class="jp">何时</em>进行了变更的信息。审计追踪通常用于大型应用程序中，在这些应用程序中，需要跟踪一个或多个模型随时间的变化。</p><p id="c822" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本教程中，我们将为一个简单的股票应用程序设置一个可供管理员访问的审计跟踪仪表板。我们的仪表板将实时更新，让我们可以随时看到更新。这是我们应用程序的预览:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/22b46a8dca63478b8a0892fd5e49fe55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qfBM7OTzcrCyLgS-.gif"/></div></div></figure><h1 id="ffcf" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">先决条件</h1><ol class=""><li id="8dc7" class="la lb hu it b iu lc iy ld jc le jg lf jk lg jo lh li lj lk dt translated">PHP 7.1.3或更高版本</li><li id="80dd" class="la lb hu it b iu ll iy lm jc ln jg lo jk lp jo lh li lj lk dt translated">设计者</li><li id="8b75" class="la lb hu it b iu ll iy lm jc ln jg lo jk lp jo lh li lj lk dt translated">推销账户。在这里创建一个<a class="ae lq" href="http://pusher.com/signup" rel="noopener ugc nofollow" target="_blank"/>。</li></ol><h1 id="537f" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">设置</h1><p id="796a" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated">我们将从我构建的一个小型股票管理应用程序开始。您可以通过运行以下命令从GitHub克隆项目:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="ab0a" class="lz kd hu lv b fv ma mb l mc md">git clone <a class="ae lq" href="https://github.com/shalvah/stockt.git" rel="noopener ugc nofollow" target="_blank">https://github.com/shalvah/stockt.git</a></span></pre><p id="242e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您也可以直接从<a class="ae lq" href="https://github.com/shalvah/stockt/archive/master.zip" rel="noopener ugc nofollow" target="_blank">这个链接下载源代码。</a></p><p id="cb85" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后<code class="eh me mf mg lv b">cd</code>进入项目文件夹并安装依赖项:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="accb" class="lz kd hu lv b fv ma mb l mc md">composer install</span></pre><p id="8aef" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，将<code class="eh me mf mg lv b">.env.example</code>复制到一个名为<code class="eh me mf mg lv b">.env</code>的新文件中。运行以下命令生成应用程序加密密钥:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="aa69" class="lz kd hu lv b fv ma mb l mc md">php artisan key:generate</span></pre><p id="7780" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，在<code class="eh me mf mg lv b">database</code>目录中创建一个名为<code class="eh me mf mg lv b">database.sqlite</code>的文件，并运行以下命令来设置和填充数据库:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="4102" class="lz kd hu lv b fv ma mb l mc md">php artisan migrate --seed</span></pre><h1 id="0149" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">创建审计仪表板</h1><p id="7424" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated">我们将使用<a class="ae lq" href="http://laravel-auditing.com/" rel="noopener ugc nofollow" target="_blank"> laravel-auditing </a>包来处理审计。让我们安装软件包:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="d8ee" class="lz kd hu lv b fv ma mb l mc md">composer require owen-it/laravel-auditing</span></pre><p id="62ab" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，我们将发布审计表的数据库迁移并运行它们:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="2d1d" class="lz kd hu lv b fv ma mb l mc md">php artisan auditing:install<br/>php artisan migrate</span></pre><p id="dca6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将审核产品的变更。让我们配置我们的产品模型，以便审计包可以跟踪它。在您的<code class="eh me mf mg lv b">Product</code>型号(<code class="eh me mf mg lv b">app/Models/Product.php</code>)中:</p><ul class=""><li id="fd15" class="la lb hu it b iu iv iy iz jc mh jg mi jk mj jo mk li lj lk dt translated"><code class="eh me mf mg lv b">use</code>的<code class="eh me mf mg lv b">OwenIt\Auditing\Auditable</code>特质</li><li id="b544" class="la lb hu it b iu ll iy lm jc ln jg lo jk lp jo mk li lj lk dt translated"><code class="eh me mf mg lv b">implement</code><code class="eh me mf mg lv b">OwenIt\Auditing\Contracts\Auditable</code>界面:</li></ul><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="1b45" class="lz kd hu lv b fv ma mb l mc md">&lt;?php<br/>    <br/>    namespace App\Models;<br/>    <br/>    use Illuminate\Database\Eloquent\Model;<br/>    use OwenIt\Auditing\Contracts\Auditable;<br/>    <br/>    class Product extends Model implements Auditable<br/>    {<br/>      use \OwenIt\Auditing\Auditable;<br/>    <br/>      // ...<br/>    }</span></pre><p id="c692" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，每当对产品进行更改时，更改的详细信息将记录在<code class="eh me mf mg lv b">audits</code>表中。</p><p id="10c6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们需要对我们的审计配置做一个小小的改变，这样<code class="eh me mf mg lv b">Audit</code>模型就可以正确地映射到我们的<code class="eh me mf mg lv b">User</code>模型。这将使我们能够编写像<code class="eh me mf mg lv b">$audit→user→name</code>这样的代码来检索做出更改的用户的名字。在文件<code class="eh me mf mg lv b">config/audit.php</code>中，用我们的用户模型的类名(<code class="eh me mf mg lv b">App\Models\User::class</code>)替换<code class="eh me mf mg lv b">user</code>数组中<code class="eh me mf mg lv b">model</code>的值</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="5e48" class="lz kd hu lv b fv ma mb l mc md">'user' =&gt; [<br/>      'primary_key' =&gt; 'id',<br/>      'foreign_key' =&gt; 'user_id',<br/>        <br/>      // replace the line below<br/>      'model'       =&gt; App\User::class,<br/>        <br/>      // with this<br/>      'model'       =&gt; App\Models\User::class,<br/>    ],</span></pre><p id="27ae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，转到审计仪表板。首先，我们将创建一个只允许管理员用户查看页面的中间件。创建一个名为<code class="eh me mf mg lv b">AllowOnlyAdmin</code>的文件。php在<code class="eh me mf mg lv b">app/Http/Middleware</code>中有如下内容:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="353d" class="lz kd hu lv b fv ma mb l mc md">&lt;?php<br/>    <br/>    namespace App\Http\Middleware;<br/>    <br/>    use Closure;<br/>    use Illuminate\Support\Facades\Auth;<br/>    <br/>    class AllowOnlyAdmin<br/>    {<br/>        public function handle($request, Closure $next)<br/>        {<br/>            if (Auth::user()-&gt;is_admin) {<br/>                return $next($request);<br/>            }<br/>            <br/>            abort(403);<br/>        }<br/>    }</span></pre><p id="cb4a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，在<code class="eh me mf mg lv b">routes/web.php</code>的末尾添加审核路线:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="4b73" class="lz kd hu lv b fv ma mb l mc md">Route::get('audits', 'AuditController@index')<br/>    -&gt;middleware('auth', \App\Http\Middleware\AllowOnlyAdmin::class);</span></pre><p id="12db" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们创建控制器。我们将生成文件<code class="eh me mf mg lv b">app/Http/Controllers/AuditController</code>。php通过运行:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="a05b" class="lz kd hu lv b fv ma mb l mc md">php artisan make:controller AuditController</span></pre><p id="25ec" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在<code class="eh me mf mg lv b">AuditController</code>类中创建一个<code class="eh me mf mg lv b">index</code>方法，内容如下:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="d06f" class="lz kd hu lv b fv ma mb l mc md">public function index()<br/>{<br/>    $audits = \OwenIt\Auditing\Models\Audit::with('user')<br/>        -&gt;orderBy('created_at', 'desc')-&gt;get();<br/>    return view('audits', ['audits' =&gt; $audits]);<br/>}</span></pre><p id="5952" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们为我们的审计构建视图。创建包含以下内容的文件<code class="eh me mf mg lv b">resources/views/audits.blade.php</code>:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="e4d5" class="lz kd hu lv b fv ma mb l mc md"><a class="ae lq" href="http://twitter.com/extends" rel="noopener ugc nofollow" target="_blank">@extends</a>('layouts.app')<br/>    <br/>    <a class="ae lq" href="http://twitter.com/section" rel="noopener ugc nofollow" target="_blank">@section</a>('content')<br/>      &lt;div class="container"&gt;<br/>        &lt;table class="table" &gt;<br/>          &lt;thead class="thead-dark"&gt;<br/>            &lt;tr&gt;<br/>              &lt;th scope="col"&gt;Model&lt;/th&gt;<br/>              &lt;th scope="col"&gt;Action&lt;/th&gt;<br/>              &lt;th scope="col"&gt;User&lt;/th&gt;<br/>              &lt;th scope="col"&gt;Time&lt;/th&gt;<br/>              &lt;th scope="col"&gt;Old Values&lt;/th&gt;<br/>              &lt;th scope="col"&gt;New Values&lt;/th&gt;<br/>            &lt;/tr&gt;<br/>          &lt;/thead&gt;<br/>          &lt;tbody id="audits"&gt;<br/>            <a class="ae lq" href="http://twitter.com/foreach" rel="noopener ugc nofollow" target="_blank">@foreach</a>($audits as $audit)<br/>              &lt;tr&gt;<br/>                &lt;td&gt;{{ $audit-&gt;auditable_type }} (id: {{ $audit-&gt;auditable_id }})&lt;/td&gt;<br/>                &lt;td&gt;{{ $audit-&gt;event }}&lt;/td&gt;<br/>                &lt;td&gt;{{ $audit-&gt;user-&gt;name }}&lt;/td&gt;<br/>                &lt;td&gt;{{ $audit-&gt;created_at }}&lt;/td&gt;<br/>                &lt;td&gt;<br/>                  &lt;table class="table"&gt;<br/>                    <a class="ae lq" href="http://twitter.com/foreach" rel="noopener ugc nofollow" target="_blank">@foreach</a>($audit-&gt;old_values as $attribute =&gt; $value)<br/>                      &lt;tr&gt;<br/>                        &lt;td&gt;&lt;b&gt;{{ $attribute }}&lt;/b&gt;&lt;/td&gt;<br/>                        &lt;td&gt;{{ $value }}&lt;/td&gt;<br/>                      &lt;/tr&gt;<br/>                    <a class="ae lq" href="http://twitter.com/endforeach" rel="noopener ugc nofollow" target="_blank">@endforeach</a><br/>                  &lt;/table&gt;<br/>                &lt;/td&gt;<br/>                &lt;td&gt;<br/>                  &lt;table class="table"&gt;<br/>                    <a class="ae lq" href="http://twitter.com/foreach" rel="noopener ugc nofollow" target="_blank">@foreach</a>($audit-&gt;new_values as $attribute =&gt; $value)<br/>                      &lt;tr&gt;<br/>                        &lt;td&gt;&lt;b&gt;{{ $attribute }}&lt;/b&gt;&lt;/td&gt;<br/>                        &lt;td&gt;{{ $value }}&lt;/td&gt;<br/>                      &lt;/tr&gt;<br/>                    <a class="ae lq" href="http://twitter.com/endforeach" rel="noopener ugc nofollow" target="_blank">@endforeach</a><br/>                  &lt;/table&gt;<br/>                &lt;/td&gt;<br/>              &lt;/tr&gt;<br/>            <a class="ae lq" href="http://twitter.com/endforeach" rel="noopener ugc nofollow" target="_blank">@endforeach</a><br/>          &lt;/tbody&gt;<br/>        &lt;/table&gt;<br/>    <br/>      &lt;/div&gt;<br/>    <a class="ae lq" href="http://twitter.com/endsection" rel="noopener ugc nofollow" target="_blank">@endsection</a></span></pre><p id="5a0b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以通过运行以下命令来启动您的应用程序:</p><p id="4371" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh me mf mg lv b">php artisan serve</code></p><p id="5cf5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后在<a class="ae lq" href="http://localhost:8000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8000 </a>上访问你的app。这个<code class="eh me mf mg lv b">stockt</code>应用有两个默认用户:一个管理员用户(Administrator，<a class="ae lq" href="mailto:admin@stockt.test" rel="noopener ugc nofollow" target="_blank"> admin@stockt.test </a>)和一个普通用户(John Doe，<a class="ae lq" href="mailto:john@stockt.test" rel="noopener ugc nofollow" target="_blank"> john@stockt.test </a>)。(两个密码:<code class="eh me mf mg lv b">secret</code>)以John Doe和管理员的身份登录您的应用程序，并对主页上显示的一些产品进行更改。然后以管理员身份访问<a class="ae lq" href="http://localhost:8000/audits" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/audits</a>查看所有用户所做的所有更改列表。</p><h1 id="2c52" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">实时显示新审计</h1><p id="2bc0" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated">现在我们已经让我们的审计仪表板工作，但我们需要重新加载页面，每当我们希望看到任何新的变化。这就是我们由Pusher驱动的实时功能的用武之地。我们来实施吧。</p><p id="7aec" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，我们将在后端设置Pusher。安装推杆拉韦尔组件:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="1d8a" class="lz kd hu lv b fv ma mb l mc md">composer require pusher/pusher-http-laravel <br/>php artisan vendor:publish --provider="Pusher\Laravel\PusherServiceProvider"</span></pre><p id="014c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">编辑您的<code class="eh me mf mg lv b">config/pusher.php</code>,使其看起来像这样:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="74b2" class="lz kd hu lv b fv ma mb l mc md">'connections' =&gt; [<br/>      'main' =&gt; [<br/>        'auth_key' =&gt; env('PUSHER_APP_KEY'),<br/>        'secret' =&gt; env('PUSHER_APP_SECRET'),<br/>        'app_id' =&gt; env('PUSHER_APP_ID'),<br/>        'options' =&gt; [<br/>          'cluster' =&gt; env('PUSHER_APP_CLUSTER'),<br/>        ],<br/>        'host' =&gt; null,<br/>        'port' =&gt; null,<br/>        'timeout' =&gt; null,<br/>      ],<br/>    ],</span></pre><p id="3ed0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">登录<a class="ae lq" href="http://app.pusher.com/" rel="noopener ugc nofollow" target="_blank">您的Pusher仪表盘</a>并创建一个新应用。从<strong class="it hv">应用密钥</strong>部分复制您的应用凭证，并将其添加到您的<code class="eh me mf mg lv b">.env</code>文件中:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="3864" class="lz kd hu lv b fv ma mb l mc md">PUSHER_APP_ID=your-app-id<br/>PUSHER_APP_KEY=your-app-key<br/>PUSHER_APP_SECRET=your-app-secret<br/>PUSHER_APP_CLUSTER=your-app-cluster</span></pre><blockquote class="ml mm mn"><p id="d11c" class="ir is jp it b iu iv iw ix iy iz ja jb mo jd je jf mp jh ji jj mq jl jm jn jo hn dt translated"><em class="hu">注意:Laravel有时会缓存旧的配置，因此为了让项目看到您的新配置值，您可能需要运行命令</em> <code class="eh me mf mg lv b"><em class="hu">php artisan config:clear</em></code></p></blockquote><p id="ad3d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每当创建一个新的审计时，<code class="eh me mf mg lv b">laravel-auditing</code>包就会触发一个名为<code class="eh me mf mg lv b">Audited</code>的事件。我们将监听这个事件，并在Pusher上触发一个<code class="eh me mf mg lv b">new-audit</code>事件。我们的前端将监听这个事件，并向表中添加新的审计项。</p><p id="3326" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">创建事件监听器，<code class="eh me mf mg lv b">app/Listeners/AuditedListener.php</code>，内容如下:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="626e" class="lz kd hu lv b fv ma mb l mc md"> &lt;?php<br/>    <br/>    namespace App\Listeners;<br/>    <br/>    use OwenIt\Auditing\Events\Audited;<br/>    use Pusher\Laravel\Facades\Pusher;<br/>    <br/>    class AuditedListener<br/>    {<br/>      public function handle(Audited $event)<br/>      {<br/>        $audit = $event-&gt;audit-&gt;toArray();<br/>        $audit['user_name'] = $event-&gt;audit-&gt;user-&gt;name;<br/>        Pusher::trigger('audits', 'new-audit', ['audit' =&gt; $audit]);<br/>      }<br/>    }</span></pre><p id="597b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，我们将在<code class="eh me mf mg lv b">app/Providers/EventServiceProvider.php</code>中注册事件监听器:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="9eb8" class="lz kd hu lv b fv ma mb l mc md">class EventServiceProvider extends ServiceProvider<br/>    {<br/>      protected $listen = [<br/>          \OwenIt\Auditing\Events\Audited::class =&gt; [<br/>              \App\Listeners\AuditedListener::class<br/>              ]<br/>      ];<br/>    <br/>      // ...<br/>    }</span></pre><p id="7431" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是我们将用来处理该事件的代码。我们拉进<code class="eh me mf mg lv b">pusher-js</code>库，订阅<code class="eh me mf mg lv b">audits</code>频道并绑定到<code class="eh me mf mg lv b">new-audit</code>事件。当一个事件进来时，我们建立一个新的行并将其插入到表的顶部。将代码添加到您的<code class="eh me mf mg lv b">resources/views/audits.blade.php</code>的末尾:</p><pre class="jr js jt ju fq lu lv lw lx aw ly dt"><span id="4947" class="lz kd hu lv b fv ma mb l mc md">&lt;script src="<a class="ae lq" href="https://js.pusher.com/4.2/pusher.min.js" rel="noopener ugc nofollow" target="_blank">https://js.pusher.com/4.2/pusher.min.js</a>"&gt;&lt;/script&gt;<br/>    &lt;script&gt;<br/>      var socket = new Pusher("your-app-key", {<br/>          cluster: 'your-app-cluster',<br/>      });<br/>      socket.subscribe('audits')<br/>          .bind('new-audit', function (data) {<br/>              var audit = data.audit;<br/>              var $modelCell = $('&lt;td&gt;').text(audit.auditable_type + '(id: ' + audit.auditable_id + ')');<br/>              var $eventCell = $('&lt;td&gt;').text(audit.event);<br/>              var $userCell = $('&lt;td&gt;').text(audit.user_name);<br/>              var $timeCell = $('&lt;td&gt;').text(audit.created_at);<br/>    <br/>              function createSubTable(values) {<br/>                var $table = $('&lt;table&gt;').addClass('table');<br/>                  for (attribute in values) {<br/>                    $table.append(<br/>                      $('&lt;tr&gt;').append(<br/>                        $('&lt;td&gt;').text(attribute),<br/>                        $('&lt;td&gt;').text(values[attribute])<br/>                      )<br/>                    );<br/>                  }<br/>                  return $table;<br/>              }<br/>    <br/>              var $oldValuesTable = createSubTable(audit.old_values)<br/>              var $newValuesTable = createSubTable(audit.new_values)<br/>    <br/>              var $oldValuesCell = $('&lt;td&gt;').append($oldValuesTable);<br/>              var $newValuesCell = $('&lt;td&gt;').append($newValuesTable);<br/>    <br/>              $newRow = $('&lt;tr&gt;').append(<br/>                $modelCell,<br/>                $eventCell,<br/>                $userCell,<br/>                $timeCell,<br/>                $oldValuesCell,<br/>                $newValuesCell<br/>              );<br/>              $('#audits').prepend($newRow);<br/>          });<br/>    &lt;/script&gt;</span></pre><p id="163a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将<code class="eh me mf mg lv b">your-app-key</code>和<code class="eh me mf mg lv b">your-app-cluster</code>替换为您的Pusher app密钥和集群，我们就完成了！</p><p id="d229" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们测试一下这个应用程序。如前所述启动您的应用程序。在一个浏览器中以John Doe的身份登录，在另一个浏览器中以Administrator的身份登录，这样就可以维护并发会话。尝试以John Doe的身份更改某些产品，同时以管理员的身份查看控制面板。这些更改应该会实时显示在仪表板上。</p><h1 id="177f" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">结论</h1><p id="7945" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated">在本文中，我们向现有应用程序添加了一个审计仪表板。我们已经通过在审计发生时在仪表板上显示审计来添加实时功能。感谢Laravel和Pusher，我们能够以最小的压力实现这些目标。你可以在<a class="ae lq" href="http://github.com/shalvah/stockt-audited" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上查看完整应用的源代码。</p></div><div class="ab cl mr ms hc mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="hn ho hp hq hr"><p id="224c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">原载于</em> <a class="ae lq" href="https://pusher.com/tutorials/realtime-audit-trail-laravel" rel="noopener ugc nofollow" target="_blank"> <em class="jp">推手的博客</em> </a> <em class="jp">。</em></p></div></div>    
</body>
</html>