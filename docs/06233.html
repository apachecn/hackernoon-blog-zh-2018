<html>
<head>
<title>How we spent 30k USD in Firebase in less than 72 hours</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们如何在不到72小时的时间内在Firebase上花费了3万美元</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-we-spent-30k-usd-in-firebase-in-less-than-72-hours-307490bd24d?source=collection_archive---------0-----------------------#2018-07-27">https://medium.com/hackernoon/how-we-spent-30k-usd-in-firebase-in-less-than-72-hours-307490bd24d?source=collection_archive---------0-----------------------#2018-07-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="0822" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://vaki.co/vaki/UnaVacaPorDeLaCalle" rel="noopener ugc nofollow" target="_blank"> #UnaVacaPorDeLaCalle </a>成为哥伦比亚最大的众筹活动，仅两天时间就募集到了超过此前纪录3倍的资金！这也成为历史上最大的政治众筹活动之一。</p><div class="jq jr fm fo js jt"><a href="https://www.larepublica.co/internet-economy/el-crowfunding-alternativa-hasta-para-la-financiacion-electoral-2734522" rel="noopener  ugc nofollow" target="_blank"><div class="ju ab ej"><div class="jv ab jw cl cj jx"><h2 class="bd hv fv z el jy eo ep jz er et ht dt translated">众筹，选举融资的另一种选择</h2><div class="ka l"><h3 class="bd b fv z el jy eo ep jz er et ek translated">在哥伦比亚有13个在线金融平台Francisco rin con-frin con @ lare publica . com . co…</h3></div><div class="kb l"><p class="bd b gc z el jy eo ep jz er et ek translated">www.larepublica.co</p></div></div></div></a></div><h2 id="e60a" class="kc kd hu bd ke kf kg kh ki kj kk kl km jc kn ko kp jg kq kr ks jk kt ku kv kw dt translated"><strong class="ak">瓦基的巨大成功</strong></h2><p id="1b91" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo hn dt translated">就在活动发布48小时后，我们已经创下了许多记录。该活动筹集的资金是当时哥伦比亚最高纪录的3倍。我们达到了200多万次会议，访问了2000多万个页面，收到了15000多个支持。这相当于平均有1000名用户活跃在该网站上，并且每分钟收集超过20个支持。</p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="fe ff lc"><img src="../Images/dde78fd8e035be5b6c11230ee268341b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pHR-MNFFUeGy5hk6mtwNng.png"/></div></div></figure><p id="7a87" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这对我们来说是一个巨大的成功，我们的工程团队非常自豪和高兴，我们像病毒一样传播，我们的网站每一秒都在运行。那一刻，我们一边庆祝，一边密切关注数据分析。</p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="fe ff lo"><img src="../Images/4cadb90b95e5cb0470a8f0edcff1ebf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X_7Cv03VjYmpBnF0WouKPQ.jpeg"/></div></div></figure><p id="a4e1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该应用程序正在运行，所有的支持者都能够支持，社交网络上的评论是，该应用程序使支持变得非常简单。我们非常自豪:)</p><figure class="ld le lf lg fq lh"><div class="bz el l di"><div class="lp lq l"/></div></figure><p id="c12b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们不想在网站上有这么多用户的情况下发布任何新功能，所以我们决定将Angular V.6和我们正在开发的lazzy合并，这是一个很好的工作时间，我们说。网站加载速度开始变慢，有些用户花了30多秒才加载完页面。太奇怪了。我们的团队对此感到不舒服，我们无法理解是什么导致了这种情况，现在我们有了全新版本的Angular代码，可能还有生产中的许多其他错误。</p><p id="6421" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们的团队开始匆忙发布这个新版本，重构几乎所有东西，尽可能地延迟加载。我们做了现场重构。这是一个巨大的风险，我们希望这个活动是完美的，所以我们做到了！在仅仅一天半的时间里，我们的团队就完成了新版本的第一次发布。经过一些测试后，看起来重构有助于应用程序的速度，但没有我们想要的那么快。我们的目标是在3秒钟内加载，但它并不像我们预期的那样工作。这是我们第一次发现Firebase中有可以改进的地方。</p><p id="074b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当我们访问Firebase仪表板时，我们意识到，有这么多的访问者和支持，我们的Firestore服务不仅仅是超载，而是我们欠了谷歌<strong class="it hv">一大笔债，我们在短短72小时内就花了30，356.56美元！</strong></p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="fe ff lr"><img src="../Images/8c93f2aa78ab118ff5cd1ba4176bd133.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7s3mCDpN3kA4XFtp8ZSpxA.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">Our billing dashboard afterwards</figcaption></figure><h2 id="4cda" class="kc kd hu bd ke kf kg kh ki kj kk kl km jc kn ko kp jg kq kr ks jk kt ku kv kw dt translated"><strong class="ak">一个代价高昂的代码错误</strong></h2><p id="3a18" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo hn dt translated">自从活动发布以来，在接下来的48小时里，我们使用了Firestore的大量资源，我们的账单达到了35，000美元！！！我们向Firestore发出了超过460亿次请求。是的，十亿美元。</p><p id="0a38" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由于我们在2017年参与了NXTP实验室加速计划，我们的账户上有一笔25，000美元的谷歌云拨款，因此我们当时的债务“只有”10，000美元。真正的问题是，谷歌云服务每小时要多花600美元。那时我们有两个选择:关闭网站停止收费，或者用桌上的钱钟开始调试每一行代码。我们选择第二个。</p><p id="ab37" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们不知道在哪里可以优化请求。我们认为，如果我们使用Firebase作为我们的主机提供商，我们的公司不会盈利，我们已经开始担心需要将我们的数据带到其他地方。在我们的生命只剩下几个小时的时候，我们找到了线！只是一行糟糕的代码导致了如此多的请求(和成本):<em class="lw"> this.loadPayments() </em></p><p id="0919" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了理解这一点，让我解释一下我们的架构是如何工作的。我们在Firestore上有两个主要系列:<em class="lw"> Vakis </em>和<em class="lw"> Payments </em>。<em class="lw"> Vakis </em>拥有包含每个Vaki数据的文档，而<em class="lw"> Payments </em>拥有包含每个用户付款数据的文档。</p><p id="513f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们的功能之一是向用户显示一个Vaki实时获得的金钱和支持者的总数。所以我们有两个在客户端加载这些信息的服务，v <em class="lw"> akis.ts </em>和<em class="lw"> payments.ts. </em></p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="fe ff lx"><img src="../Images/50c74a158e8d3a01462ecca48d05f4a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FwYU1Suii90hGlODHfFubg.png"/></div></div></figure><p id="3cd1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每次付款被批准后，我们都会用新的总数更新Vaki文档中的值。所以我们只需要读取集合<em class="lw"> Vakis </em>来打印这些信息。但是，我们最大的错误是忽略了这一点，并通过读取收款金额来计算总数。</p><p id="304f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每次我们调用服务<em class="lw"> vakis.ts </em>时，在构造函数方法上是调用服务<em class="lw"> payments.ts </em>的行<em class="lw"> this.loadPayments() </em>，并且通过该服务我们打印Vaki的信息。这意味着，对于我们网站的每个访问者，我们需要调用每个支付文档，以查看Vaki的支持数量或收集的总数。在我们应用程序的每个页面上！</p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="fe ff lx"><img src="../Images/4f83928a8a0bb16454800825c13ba37c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mQ8C2IeO5SxhQA2T5AKrnw.png"/></div></div></figure><p id="9f99" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这意味着我们网站的每个会话读取的文档数量与我们的支付数量相同。#UnaVacaPorDeLaCalle获得了超过16000个支持者，所以:200万个会话x 16,000个文档=在不到48小时内对Firestore的请求超过400亿次。</p><h2 id="7038" class="kc kd hu bd ke kf kg kh ki kj kk kl km jc kn ko kp jg kq kr ks jk kt ku kv kw dt translated">谷歌理解并激励我们！</h2><p id="a3e1" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo hn dt translated">在我们修复了这个代码错误并停止收费后，我们联系了谷歌，让他们了解情况，看看我们是否可以申请他们为创业公司提供的下一笔资助。我们告诉他们，我们花光了几天前获得的全部25000美元赠款，并看到了在谷歌云服务上申请100000美元赠款的机会。我们联系了谷歌开发团队Latam，告诉他们刚刚发生了什么。他们允许我们申请下一笔拨款，谷歌批准了，在与他们会面后，他们让我们用这笔拨款支付账单。</p><p id="c3b2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我们非常感谢谷歌，不仅因为它有一个像Firebase一样的令人敬畏的“后端即服务”，而且因为它让我们有200万个会话，每分钟60次支持和数十亿次请求，而不会让我们的网站宕机。此外，他们明白像我们这样的错误可能发生在一家<a class="ae jp" href="https://hackernoon.com/tagged/startup" rel="noopener ugc nofollow" target="_blank">初创公司</a>成长的时候，一些代价高昂的错误可能会危及未来的大公司。</p><h2 id="31c5" class="kc kd hu bd ke kf kg kh ki kj kk kl km jc kn ko kp jg kq kr ks jk kt ku kv kw dt translated">结论</h2><p id="7b06" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo hn dt translated">在发布之前，技术团队调试对服务器的每个请求是非常重要的。分析请求和数据传输的数量是否有意义，以及您的公司是否愿意承担大流量主机的成本。否则，你将会陷入循环，或者不优化的请求，导致巨额的账单或者网站瘫痪。</p><p id="6299" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，如果你是一家使用任何精益方法快速启动、快速失败、快速学习的初创公司，请小心，技术敏捷性和技术完美性不是好朋友，你需要在它们之间找到一个良好的平衡，以防止代价高昂的错误，但仍然尽可能快地推进你的业务。</p><p id="0419" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">谢谢Google，谢谢Karen，Paco和Martín(团队Google开发者Latam)，谢谢NXTP Labs。没有你们，我们将无法忍受我们的第一次病毒式运动👊</p></div><div class="ab cl ly lz hc ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="hn ho hp hq hr"><p id="c400" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="lw">感谢Juan Pablo Muriel、Katharine Vander Laan、Laura Cardona、Santiago Jaramillo和Vaki团队阅读并评论本文草稿。</em></p><figure class="ld le lf lg fq lh"><div class="bz el l di"><div class="mf lq l"/></div></figure></div></div>    
</body>
</html>