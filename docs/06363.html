<html>
<head>
<title>Malware Analysis using Osquery | Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Osquery的恶意软件分析|第1部分</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/malware-analysis-using-osquery-part-1-78f5f617cc19?source=collection_archive---------14-----------------------#2018-07-31">https://medium.com/hackernoon/malware-analysis-using-osquery-part-1-78f5f617cc19?source=collection_archive---------14-----------------------#2018-07-31</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="faeb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Sysmon和Osquery等工具有助于检测端点上的异常行为。这些工具通过记录多种类型的事件，让我们能够很好地了解终端上发生的情况，我们可以将这些事件转发给SIEM或其他关联系统进行分析。</p><p id="f699" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这个博客系列中，我们将分析不同的恶意软件家族，查看端点上生成的事件类型，以及我们如何使用Osquery来检测它们。</p><h1 id="16a4" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">开始吧！</h1><p id="c22b" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">让我们从分析著名的<a class="ae jp" href="https://blog.trendmicro.com/trendlabs-security-intelligence/new-emotet-hijacks-windows-api-evades-sandbox-analysis/" rel="noopener ugc nofollow" target="_blank"> Emotet </a>银行木马开始，这是一个针对许多国家和公司部门的持续威胁(<a class="ae jp" href="https://www.symantec.com/blogs/threat-intelligence/evolution-emotet-trojan-distributor" rel="noopener ugc nofollow" target="_blank">emo Tet</a>的演变)。下载者通过电子邮件网络钓鱼传播，并使用恶意的Office宏下载恶意软件。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff kt"><img src="../Images/16c0f9396d4957875f271d6143e0bdea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1KuUBBvuuG1UDUOj"/></div></div></figure><p id="84c7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">文件示例:</p><p id="ac9b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://app.any.run/tasks/b30d3215-a238-415e-ba7d-a884e1505758" rel="noopener ugc nofollow" target="_blank">https://app . any . run/tasks/b30d 3215-a238-415 e-ba7d-a884e 1505758</a></p><p id="8c86" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://www.virustotal.com/#/file/c932d54a9ef3c645a28b7d8de9747fc6c06fc23c6d65c036da4eae4d778a81db" rel="noopener ugc nofollow" target="_blank">https://www . virus total . com/#/file/c 932d 54 a 9 ef 3c 645 a 28 b 7d 8 de 9747 fc 6 c 06 fc 23 c 6d 65 c 036 da 4 ea E4 d 778 a 81 db</a></p><p id="4790" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如我们在沙盒报告中看到的，Office宏使用一个编码命令执行PowerShell来下载有效负载。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div class="fe ff lf"><img src="../Images/aa9e5db20343687cb8cdd156d9f147a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/0*884WZqZngtQpSNQ1"/></div></figure><p id="c8ca" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果我们在安装了Osquery的环境中运行示例，我们可以构建一个查询来从powershell_events表中检索PowerShell生成的事件。Osquery读取Microsoft-Windows-PowerShell event log通道，所以需要<a class="ae jp" href="https://www.fireeye.com/blog/threat-research/2016/02/greater_visibilityt.html" rel="noopener ugc nofollow" target="_blank">启用</a>脚本块日志记录。</p><p id="7e46" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们可以看到编码的PowerShell命令以及解码命令后生成的脚本文本代码。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff lg"><img src="../Images/429eeafcc4b3da4acd6d0920eb0c39e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6_zAydeClqTExHck"/></div></div></figure><p id="c221" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">PowerShell下载有效负载后，Osquery可以记录任何进程打开的套接字连接。我们可以在process_open_socket表和processes表之间进行简单的连接，以查看哪些进程正在进行网络连接。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff lh"><img src="../Images/aad93c5b2236570540b7830ddef0c2e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yjbV3CedjU_ctOpb"/></div></div></figure><p id="017a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有趣的是，在下载有效载荷的过程中，可以看到哪些文件被写入了磁盘。为此，我们可以查询存储一些有用字段的文件表(<a class="ae jp" href="https://osquery.io/schema/3.2.6#file" rel="noopener ugc nofollow" target="_blank">文件表模式</a>)。这个表需要一个WHERE条件来返回结果，所以我们可以添加一些过滤器，例如像<em class="li">用户</em>目录和在过去100秒内创建的文件。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff lj"><img src="../Images/859ebb2f402b15f2c8beb0269d87315b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*N9GG4wFjLA2qMHOJ"/></div></div></figure><p id="9f29" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">从PowerShell下载的文件是一个Emotet dropper，它提取最终的有效负载并执行它(squarectx.exe)。现在，让我们查询系统运行进程。与上面类似，我们可以连接用户表来查看用户名列。为了看得更清楚，省略了一些行。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff lk"><img src="../Images/386f9de3b65a089b12765165a63041ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IsFpP5r7wfSYQSTj"/></div></div></figure><p id="bff9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们知道Emotet恶意软件正在我们的环境中运行，并且可能正在做恶意的事情，所以让我们寻找恶意软件活动的迹象。为此，我们重用上面使用的查询来查看系统进程的网络连接。在这里，我们可以检测到与命令和控制服务器的通信。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff lh"><img src="../Images/69b417f280cff0d28a16357279a27cb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8sek7d2V1lWG3wBN"/></div></div></figure><p id="ab68" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如我们所见，使用Osquery等工具分析恶意软件并提取有价值的信息是可能的，这些工具为我们提供了丰富的系统事件可见性。</p><h1 id="d864" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">AlienVault如何使用Osquery</h1><p id="1242" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">Osquery允许您从端点检索大量事件和有用信息。这对于调查<a class="ae jp" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank">安全</a>事件以及对您关键资产的威胁搜寻活动非常有帮助。</p><p id="a34c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">AlienVault通过AlienVault代理利用Osquery在USM Anywhere和Open Threat Exchange中搜索威胁。</p><p id="6368" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">AlienVault代理是一个轻量级、适应性强的端点代理，基于Osquery，由AlienVault维护。在USM Anywhere中，AlienVault代理支持持续的端点监控，使用内置的AlienVault威胁情报来自动执行端点查询和威胁检测以及其他网络和云安全事件。这使得USM Anywhere能够提供端点检测和响应(EDR)、文件完整性监控(FIM)以及丰富的端点遥测功能，这些功能对于完整有效的威胁检测、响应和合规性至关重要。</p><p id="240c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在<a class="ae jp" href="https://www.alienvault.com/products/usm-anywhere/demo" rel="noopener ugc nofollow" target="_blank"> USM Anywhere在线演示</a>中亲自体验一下。</p><p id="8045" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">4月，AlienVault推出了Endpoint Threat Hunter，这是开放威胁交换(OTX)中基于AlienVault代理的免费威胁扫描服务。OTX终端威胁猎人允许任何人确定他们的终端是否感染了最新的恶意软件或其他威胁，方法是手动扫描他们的终端是否存在OTX编目的危害指标(IOC)。</p><p id="e087" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">免费使用OTX端点威胁猎人:<a class="ae jp" href="https://otx.alienvault.com/endpoint-threat-hunter/welcome" rel="noopener ugc nofollow" target="_blank">https://otx.alienvault.com/endpoint-threat-hunter/welcome</a></p><p id="23bf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">以下是我们如何使用OTX端点威胁猎人在分析系统上检测到Emotet感染的示例。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff ll"><img src="../Images/24190e5ff777c2b5b61b117f787a59a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7wU2_oTQj3DoPe3a"/></div></div></figure><p id="9898" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本博客系列的下一篇文章中，我们将看到其他恶意软件家族，并探索如何检测活动，如系统持久性和许多其他技术。</p><p id="3de4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">敬请期待！</p><p id="2b96" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">“使用Osquery的恶意软件分析|第2部分”@ n0dec https://hackernoon.com/malware-analysis-using-</p><h1 id="8d09" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">附录</h1><p id="cca8" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated"><strong class="it hv">查询</strong></p><p id="d923" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">select time，script _ text from powershell _ events；</p><p id="ce79" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">select processes.name，process _ open _ sockets . remote _ address，process _ open _ sockets . remote _ port from process _ open _ sockets LEFT JOIN process _ open _ sockets . PID = processes . PID WHERE process _ open _ sockets . remote _ port！= 0和processes.name！= '';</p><p id="67d3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">select path，size，from file其中path如' C:\Users\%% '和mtime &gt;(select local _ time from time)-100和filename！= '.'；</p><p id="25e3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">select processes.pid，users.username，processes . path from processes LEFT JOIN users ON processes . uid = users . uid WHERE processes . path！= '';</p><p id="d56b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">文件</strong></p><p id="8fae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">c 932d 54 a 9 ef 3c 645 a 28 b 7d 8 de 9747 fc 6 c 06 fc 23 c 6d 65 c 036 da 4 EAE 4d 778 a 81 db</p><p id="c6aa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">9f 6325 ebce 797 b5 ceec 1 bbf 32 e 61 AEC 8 FBE 8 b 650</p><p id="5387" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">124 d03b 86227 bbf 282 f0f 567 AE 11858 e</p><p id="6a5c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">bafc 6731 EFD 63 f 57 c 89653 b 24 ba 532 AC 1 e 96d 259993 c8 F3 d 96d 26 E1 cf 6 CD 57d 3</p><p id="9e9c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> DNS请求</strong></p><p id="885f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">萨莫蒂查</p><p id="1fc2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">okane-mikata.com</p><p id="b07a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">连接</strong></p><p id="905c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt">81.169.145.82</p><p id="8ffd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt">112.78.117.29</p><p id="1fad" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt">184.186.78.177</p><p id="acf1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt">74.139.102.161</p><p id="d08f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> OTX </strong></p><div class="lm ln fm fo lo lp"><a href="https://otx.alienvault.com/browse/pulses?q=emotet" rel="noopener  ugc nofollow" target="_blank"><div class="lq ab ej"><div class="lr ab ls cl cj lt"><h2 class="bd hv fv z el lu eo ep lv er et ht dt translated">搜索脉冲“emo Tet”-alien fault-公开威胁交换</h2><div class="lw l"><h3 class="bd b fv z el lu eo ep lv er et ek translated">了解最新的在线威胁。共享和协作开发威胁情报。保护你自己和…</h3></div><div class="lx l"><p class="bd b gc z el lu eo ep lv er et ek translated">otx.alienvault.com</p></div></div></div></a></div><figure class="ku kv kw kx fq ky"><div class="bz el l di"><div class="ly lz l"/></div></figure></div></div>    
</body>
</html>