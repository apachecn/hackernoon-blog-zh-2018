<html>
<head>
<title>Build a Smart, Automated IoT Plant Irrigation System with Raspberry Pi and PubNub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Raspberry Pi和PubNub构建智能、自动化的物联网植物灌溉系统</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/build-a-smart-automated-iot-plant-irrigation-system-with-raspberry-pi-and-pubnub-b9b7b41d36c?source=collection_archive---------37-----------------------#2018-08-07">https://medium.com/hackernoon/build-a-smart-automated-iot-plant-irrigation-system-with-raspberry-pi-and-pubnub-b9b7b41d36c?source=collection_archive---------37-----------------------#2018-08-07</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="a538" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">随着物联网和云计算的兴起，我们的技术变得越来越互联，我们不仅造福了我们的生活，也造福了我们的星球。智能农业席卷了整个世界，因为农民们已经学会了拥抱物联网世界，而不是拒绝它。这些农民已经能够精确地监控他们的产品状况以及控制他们的每一毫升资源。</p><p id="7494" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">像<a class="ae jp" href="https://illuminumgreenhouses.com/" rel="noopener ugc nofollow" target="_blank"> Illuminum温室</a>这样的农业科技公司已经能够解决快速增长的人口对可持续食品和农业的需求问题；</p><blockquote class="jq"><p id="481b" class="jr js hu bd jt ju jv jw jx jy jz jo ek translated"><em class="ka">“我们利用当地可用的材料和太阳能传感器，为小农户建造负担得起的现代温室，并安装自动化滴灌套件。”</em></p><p id="f891" class="jr js hu bd jt ju jv jw jx jy jz jo ek translated"><em class="ka">-肯尼亚Illuminum温室</em></p></blockquote><p id="65c0" class="pw-post-body-paragraph ir is hu it b iu kb iw ix iy kc ja jb jc kd je jf jg ke ji jj jk kf jm jn jo hn dt translated">随着世界人口即将达到100亿，我们需要更多地采用技术、保守的方法来养活大众，物联网是必由之路。</p><p id="e663" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们在PubNub与许多农业技术公司合作，如智能拖拉机、气候监测等等。我们甚至写了一些文章，展示如何将云计算的力量用于智能农业。</p><p id="1b20" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">至于这个项目的灵感，我们已经创建了这个演示项目，展示了如何使用我们的实时数据基础设施来创建自我维持的植物系统。</p><figure class="kg kh ki kj fq kk"><div class="bz el l di"><div class="kl km l"/></div></figure><h1 id="d98f" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">你需要什么</h1><ul class=""><li id="94fa" class="ll lm hu it b iu ln iy lo jc lp jg lq jk lr jo ls lt lu lv dt translated"><a class="ae jp" href="https://www.aliexpress.com/item/Mini-Micro-Submersible-Motor-Pump-New-Water-Pumps-DC-3-6V-120L-H-Low/32692496265.html?src=google&amp;albslr=220353225&amp;isdl=y&amp;aff_short_key=UneMJZVf&amp;source=%7Bifdyn:dyn%7D%7Bifpla:pla%7D%7Bifdbm:DBM&amp;albch=DID%7D&amp;src=google&amp;albch=shopping&amp;acnt=708-803-3821&amp;isdl=y&amp;albcp=653153647&amp;albag=34728528644&amp;slnk=&amp;trgt=61865531738&amp;plac=&amp;crea=en32692496265&amp;netw=g&amp;device=c&amp;mtctp=&amp;aff_platform=google&amp;gclid=EAIaIQobChMI3-Kc_LS93AIViNdkCh2ZrgyxEAQYASABEgJatPD_BwE&amp;gclsrc=aw.ds" rel="noopener ugc nofollow" target="_blank">3-6V水泵</a></li><li id="ee6d" class="ll lm hu it b iu lw iy lx jc ly jg lz jk ma jo ls lt lu lv dt translated"><a class="ae jp" href="https://www.amazon.com/gp/product/B0002AQI9K/ref=pe_370960_293375560_em_1p_8_ti" rel="noopener ugc nofollow" target="_blank">硅胶管</a></li><li id="9fdc" class="ll lm hu it b iu lw iy lx jc ly jg lz jk ma jo ls lt lu lv dt translated">5V电源(手机充电线即可)</li><li id="8587" class="ll lm hu it b iu lw iy lx jc ly jg lz jk ma jo ls lt lu lv dt translated"><a class="ae jp" href="https://www.raspberrypi.org/products/raspberry-pi-3-model-b/" rel="noopener ugc nofollow" target="_blank">树莓派3 </a></li><li id="3e7b" class="ll lm hu it b iu lw iy lx jc ly jg lz jk ma jo ls lt lu lv dt translated"><a class="ae jp" href="https://www.google.com/shopping/product/11256644188417662406?q=A0Song+Am2302&amp;biw=1440&amp;bih=826&amp;prds=paur:ClkAsKraX-pK2DSJ2AEkYZ4QBdLXkt0WgYTXFnxoN92cYq21EhvWHLbDsahr2rsU6ncjVUkzSwFNECAhDNd4iGaH0cjjDB8UQpCBQSOkAHmUUv49FAankCKUARIZAFPVH71LKgKLnt2Ahhq_JYbszLZ5jId6ug&amp;sa=X&amp;ved=0ahUKEwil79yJtvTbAhUqqlkKHRGYD2sQ8wIIgQI" rel="noopener ugc nofollow" target="_blank">温度/湿度传感器</a></li><li id="75df" class="ll lm hu it b iu lw iy lx jc ly jg lz jk ma jo ls lt lu lv dt translated"><a class="ae jp" href="https://www.sparkfun.com/products/13637" rel="noopener ugc nofollow" target="_blank">土壤湿度传感器</a></li></ul><h1 id="dd79" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">设置</h1><h1 id="71f0" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">接线</h1><p id="5a8f" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">首先，如果你没有专用的5V电源，你可以很容易地用旧手机充电线做一个。简单地说，剪断手机适配器的头部，剥去大约5英寸的橡胶外壳，露出电线。</p><p id="be44" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">电线会很脆弱，所以将一些母头线焊接到裸露的电话电缆线上会是一个好主意。</p><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="fe ff me"><img src="../Images/7fd5d5e9119429b24719078b3b9bfb13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SxRGsuHTHNj2QYcu.jpg"/></div></div></figure><p id="6da6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将是一个好主意，这样做也为泵的暴露电线。</p><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="fe ff ml"><img src="../Images/dc8cca64b013bfcf91fabaf23df75957.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G6Ms1I6iekdPrWLh.jpg"/></div></div></figure><p id="9413" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你担心硅胶管无法密封在泵上，你可以在管口周围涂上热胶水来创造一个完美的密封。</p><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="fe ff ml"><img src="../Images/5cc0b502749363d04e764bdabad5b310.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*buH48Cd27KIBnrvd.jpg"/></div></div></figure><p id="a4f2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在您已经准备好开始连接您的组件了！按照这个图，并确保您插入额外的公-公电线到我们之前焊接的母接头，以将所有东西连接在一起。</p><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="fe ff ml"><img src="../Images/974e2b37e2d25a25bc77e8c4245f5493.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2geX1uGM2oJgoSuA.png"/></div></div></figure><p id="3caf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，我们在电路中使用了一个继电器，因为Raspberry Pi只能安全地承受3.3V以下的输入电压，因此，我们需要隔离5V电源，以免损坏Pi。</p><h1 id="72de" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">五金器具</h1><h1 id="7bfe" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">泵</h1><p id="df18" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">该泵是一种潜水式水泵，这意味着它必须完全浸没在蓄水池中才能抽水。因此，对于这个项目，您将需要在任何时候都在植物旁边留出一个碗(或任何方法的蓄水池)。</p><p id="d129" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="mm">注意:只要RPI上没有水，电线末端弄湿也没关系！</em></p><h1 id="3928" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">DHT传感器</h1><p id="6331" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">DHT11 temp/hum sensory是一款标准传感器，除了与您的工厂处于同一环境之外，不需要安装在任何特定的位置。由于温度和湿度在5英尺半径范围内变化不大，因此可以将传感器插入RPI，而不是紧挨着植物。</p><h1 id="5e40" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">土壤湿度传感器</h1><p id="e495" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">土壤湿度传感器是一个标准的湿度传感器，在潮湿时输出电压，在干燥时不输出电压。您可以使用传感器上的电位计来调节传感器的灵敏度。</p><h1 id="188e" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">让我们开始编码吧！</h1><p id="ea6a" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">在你做任何事情之前，确保你<a class="ae jp" href="https://dashboard.pubnub.com/signup" rel="noopener ugc nofollow" target="_blank">注册了一个免费的PubNub账户</a>，这样我们就不会遇到任何问题。</p><h1 id="0584" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">步骤1:启用SSH</h1><p id="5745" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">安全外壳协议(SSH)允许用户通过wifi从他们的计算机远程访问他们的Raspberry Pi终端。如果辅以GitHub，用户可以将代码从他们的计算机推送到一个远程存储库，SSH到Pi终端，并以无线方式提取代码。这允许更快和更平滑的开发过程。</p><p id="e41f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要在RPI上启用SSH，<a class="ae jp" href="https://www.raspberrypi.org/documentation/remote-access/ssh/" rel="noopener ugc nofollow" target="_blank">按照简单快速的说明进行操作。</a></p><h1 id="a625" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">步骤2:下载设备库和依赖项</h1><p id="5b40" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">虽然我们可能有3个器件，但我们只需要读取其中2个器件的模拟电压。泵只需要在GPIO开关上操作。因此，我们只需要为温度/湿度传感器和土壤湿度传感器提取专用设备库。</p><p id="0fe5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">注意:</strong>记住，这些库必须通过SSH进入您的设备并运行下面的命令安装到RPI上。</p><h2 id="c4cd" class="mn ko hu bd kp mo mp mq kt mr ms mt kx jc mu mv lb jg mw mx lf jk my mz lj na dt translated">DHT温度湿度传感器</h2><p id="d645" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">在您的项目目录中，克隆并输入传感器的代码库。</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="eb68" class="mn ko hu nc b fv ng nh l ni nj">git clone <a class="ae jp" href="https://github.com/adafruit/Adafruit_Python_DHT.git" rel="noopener ugc nofollow" target="_blank">https://github.com/adafruit/Adafruit_Python_DHT.git</a> cd Adafruit_Python_DHT</span></pre><p id="8678" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">安装一些Python依赖项。</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="839b" class="mn ko hu nc b fv ng nh l ni nj">sudo apt-get upgrade <br/>sudo apt-get install build-essential python-dev</span></pre><p id="a898" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，安装传感器的库。</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="5869" class="mn ko hu nc b fv ng nh l ni nj">sudo python setup.py install</span></pre><p id="6fdb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将编译库的代码并将其安装在您的设备上，这样任何Python程序都可以访问Adafruit_DHT python模块。</p><p id="e263" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您想快速测试传感器以查看传感器是否工作，请输入以下命令:</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="610c" class="mn ko hu nc b fv ng nh l ni nj">cd examples sudo ./AdafruitDHT.py 2302 4</span></pre><p id="27eb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您应该会看到类似如下的读数:</p><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div class="fe ff nk"><img src="../Images/4d762d97234d4b35387b6c7e6a55f12c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/0*3PxXKWTO8H_nDUgT.jpg"/></div></figure><h2 id="4be1" class="mn ko hu bd kp mo mp mq kt mr ms mt kx jc mu mv lb jg mw mx lf jk my mz lj na dt translated">Raspberry Pi GPIO库</h2><p id="3b0d" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">对于我们的潜水泵，我们需要从RPI操作一个1或0的<strong class="it hv">输出</strong>电压来打开它。相反，土壤湿度传感器根据是湿还是干给RPI一个<strong class="it hv">输入</strong>电压1或0。这两种功能都需要使用RPI的GPIO引脚。</p><p id="b3ec" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由于我们将用Python编码，安装GPIO Zero库将会很有用，这将允许我们进行简单的函数调用来激活管脚。</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="e4c5" class="mn ko hu nc b fv ng nh l ni nj">sudo apt install python-gpiozero</span></pre><h1 id="41f9" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">步骤3:用PubNub函数构建你的应用程序</h1><p id="902b" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">这个项目的完整代码位于这个参考库:<a class="ae jp" href="https://github.com/Cakhavan/IoT_Plant" rel="noopener ugc nofollow" target="_blank">https://github.com/Cakhavan/IoT_Plant</a></p><p id="9003" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，让我们导入我们的库和其他依赖项来启用设备和PubNub功能</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="4f64" class="mn ko hu nc b fv ng nh l ni nj">#Device Libraries <br/>import sys <br/>import Adafruit_DHT from gpiozero <br/>import LED, Button from time <br/>import sleep </span><span id="0de2" class="mn ko hu nc b fv nl nh l ni nj">#PubNub <br/>import pubnub from pubnub.pnconfiguration <br/>import PNConfiguration from pubnub.pubnub <br/>import PubNub from pubnub.callbacks <br/>import SubscribeCallback from pubnub.enums <br/>import PNOperationType, PNStatusCategory</span></pre><p id="a674" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，我们需要将传感器和泵初始化为它们对应的RPI pin号</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="1e23" class="mn ko hu nc b fv ng nh l ni nj">#Pump is connected to GPIO4 as an LED <br/>pump = LED(4) </span><span id="09a2" class="mn ko hu nc b fv nl nh l ni nj">#DHT Sensor (model type 22) is connected to GPIO17 <br/>sensor = 22 <br/>pin = 17</span><span id="9b3a" class="mn ko hu nc b fv nl nh l ni nj">#Soil Moisture sensor is connected to GPIO14 as a button <br/>soil = Button(14)</span></pre><p id="9176" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注意:由于泵需要发送on或off的输出电压(就像我们通常对LED做的那样)，我们将其初始化为一个LED实例。此外，我们将土壤湿度传感器初始化为一个按钮，因为当潮湿时，它会发出1的连续输入电压(就像按住按钮一样)。</p><p id="f514" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为程序第一次启动时设置一些初始条件也是一个好主意:一个标志变量将程序的状态切换到自动模式或手动模式，并在程序启动时关闭泵。</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="954c" class="mn ko hu nc b fv ng nh l ni nj">#flag variable to toggle between Auto and Manual mode <br/>flag = 1 </span><span id="b8ba" class="mn ko hu nc b fv nl nh l ni nj">#always make sure the program starts with the pump turned off<br/>#(conventions are backwards for the pump i.e. .on()=='off' and #.off()=='on') </span><span id="7bdb" class="mn ko hu nc b fv nl nh l ni nj">pump.on()</span></pre><p id="b166" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了确保我们的物联网工厂能够与客户端通信，我们需要启用PubNub的双向发布订阅功能。为了确保我们可以接收消息，我们需要添加一个侦听器来处理传入的消息，并声明一个订阅来侦听特定的通道。</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="ddfd" class="mn ko hu nc b fv ng nh l ni nj">class MySubscribeCallback(SubscribeCallback):<br/>    def status(self, pubnub, status):<br/>        pass<br/>        # The status object returned is always related to subscribe but could contain<br/>        # information about subscribe, heartbeat, or errors<br/>        # use the operationType to switch on different options<br/>        if status.operation == PNOperationType.PNSubscribeOperation \<br/>                or status.operation == PNOperationType.PNUnsubscribeOperation:<br/>            if status.category == PNStatusCategory.PNConnectedCategory:<br/>                pass<br/>                # This is expected for a subscribe, this means there is no error or issue whatsoever<br/>            elif status.category == PNStatusCategory.PNReconnectedCategory:<br/>                pass<br/>                # This usually occurs if subscribe temporarily fails but reconnects. This means<br/>                # there was an error but there is no longer any issue<br/>            elif status.category == PNStatusCategory.PNDisconnectedCategory:<br/>                pass<br/>                # This is the expected category for an unsubscribe. This means there<br/>                # was no error in unsubscribing from everything<br/>            elif status.category == PNStatusCategory.PNUnexpectedDisconnectCategory:<br/>                pass<br/>                # This is usually an issue with the internet connection, this is an error, handle<br/>                # appropriately retry will be called automatically<br/>            elif status.category == PNStatusCategory.PNAccessDeniedCategory:<br/>                pass<br/>                # This means that PAM does allow this client to subscribe to this<br/>                # channel and channel group configuration. This is another explicit error<br/>            else:<br/>                pass<br/>                # This is usually an issue with the internet connection, this is an error, handle appropriately<br/>                # retry will be called automatically<br/>        elif status.operation == PNOperationType.PNSubscribeOperation:<br/>            # Heartbeat operations can in fact have errors, so it is important to check first for an error.<br/>            # For more information on how to configure heartbeat notifications through the status<br/>            # PNObjectEventListener callback, consult &lt;link to the PNCONFIGURATION heartbeart config&gt;<br/>            if status.is_error():<br/>                pass<br/>                # There was an error with the heartbeat operation, handle here<br/>            else:<br/>                pass<br/>                # Heartbeat operation was successful<br/>        else:<br/>            pass<br/>            # Encountered unknown status type<br/> <br/>    def presence(self, pubnub, presence):<br/>        pass  # handle incoming presence data<br/> <br/>    def message(self, pubnub, message):<br/>        if message.message == 'ON':<br/>        global flag<br/>        flag = 1<br/>        elif message.message == 'OFF':<br/>      global flag<br/>      flag = 0<br/>        elif message.message == 'WATER':<br/>        pump.off()<br/>        sleep(5)<br/>        pump.on()<br/> <br/> <br/>pubnub.add_listener(MySubscribeCallback())<br/>pubnub.subscribe().channels('ch1').execute()Then, to enable sending out messages, we declare a publisher callback</span><span id="e7d0" class="mn ko hu nc b fv nl nh l ni nj">def publish_callback(result, status): pass</span></pre><p id="5b2b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我们需要一种方法来检查我们的传感器是湿的还是干的。由于我们将土壤传感器声明为一个按钮，函数调用“is _ held”只是意味着我们应该检查土壤传感器何时输出连续的“1”(是干的)。</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="63f6" class="mn ko hu nc b fv ng nh l ni nj">def get_status():<br/>  #Soil sensor acts as button. is_held == sensor outputting a 1 for dryness<br/>  if soil.is_held: <br/>    print("dry")<br/>    return True<br/>  else:<br/>    print("wet")<br/>    return False</span></pre><p id="150c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，让我们实现我们程序的实质。我们将需要RPI连续轮询来检查传感器数据，因此让我们实现一个连续的while循环:</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="e9af" class="mn ko hu nc b fv ng nh l ni nj">while True:</span></pre><p id="b80e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们现在需要设置状态条件，检查标志变量是1还是0(也就是自动模式还是手动模式)</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="eb1e" class="mn ko hu nc b fv ng nh l ni nj">if flag == 1: <br/>#to be implemented<br/>elif flag == 0: <br/>#to be implemented</span></pre><p id="0b5d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就像我们之前做的一样，让我们从DHT传感器获取数据，并将其打印到终端</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="ffb5" class="mn ko hu nc b fv ng nh l ni nj">if flag == 1:    <br/>     # Try to grab a sensor reading.  Use the read_retry method which will retry up<br/>     # to 15 times to get a sensor reading (waiting 2 seconds between each retry).<br/>     humidity, temperature = Adafruit_DHT.read_retry(sensor, pin)<br/>     DHT_Read = ('Temp={0:0.1f}*  Humidity=                              {1:0.1f}%'.format(temperature, humidity))<br/>     print(DHT_Read)</span></pre><p id="bba4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我们可以将这些数据发布到PubNub，供未来的物联网使用。我们将在一个特定的通道上发布，所以让我们发布到一个名为“ch2”的东西，因为“ch1”是为监听标志变量而保留的。</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="ad48" class="mn ko hu nc b fv ng nh l ni nj">pubnub.publish().channel('ch2').message([DHT_Read]).async(publish_callback)</span></pre><p id="09d2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后检查土壤传感器的状态，并相应地打开或关闭泵</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="48ec" class="mn ko hu nc b fv ng nh l ni nj">wet = get_status()<br/>if wet == True:<br/>    print("turning on")<br/>    pump.off()<br/>    sleep(5)<br/>    print("pump turning off")<br/>    pump.on()<br/>    sleep(1)<br/>else:<br/>    pump.on()<br/>sleep(1)</span></pre><p id="edc9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注意:记住。在()和上。off()方法调用</p><p id="da9d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，让我们实现手动模式elif条件，这只是确保泵总是关闭的</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="2312" class="mn ko hu nc b fv ng nh l ni nj">elif flag == 0: <br/>     pump.on()<br/>     sleep(3)</span></pre><h1 id="0e6c" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">步骤4:如何上传您的代码</h1><p id="e3e7" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">就像我们在上一节中讨论的Git的使用一样，您应该总是将您的代码提交到您的存储库中，然后将它拉到您的Raspberry Pi中。该过程始终遵循以下顺序</p><p id="5135" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">1.)将您的代码保存在您的计算机上</p><p id="4da2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">2.)使用以下命令将它提交给云</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="8811" class="mn ko hu nc b fv ng nh l ni nj">git add . <br/>git commit -m "updates" <br/>git push</span></pre><p id="5e85" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">3.)SSH到您的RPI，cd到正确的目录</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="747b" class="mn ko hu nc b fv ng nh l ni nj">ssh pi@&lt;YOUR IP ADDRESS&gt; <br/>cd &lt;your directory&gt;</span></pre><p id="f866" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">4.)从云中取出代码并运行它</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="9493" class="mn ko hu nc b fv ng nh l ni nj">git pull python Plant.py</span></pre><h1 id="b6bb" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">步骤5:创建客户端</h1><p id="6f36" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">我们现在将创建一个前端HTML页面来与我们的物联网工厂进行交互，然后在步骤6中可视化其数据。我们将构建类似这样的东西。</p><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="fe ff nm"><img src="../Images/535008ba101bf8f4eabc8a76286c6544.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tigCGYf4GjLxYP2F.png"/></div></div></figure><p id="138a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，让我们从将设备置于自动状态、手动模式状态或水厂状态的3个按钮开始。这将通过让每个按钮发布一条消息来完成，工厂将相应地改变其标志变量。</p><p id="bb6a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们首先给我们的页面一个标题</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="f353" class="mn ko hu nc b fv ng nh l ni nj">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>  &lt;body&gt;<br/>            &lt;h1&gt;IoT Plant&lt;/h1&gt;<br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="eb50" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在HTML文件的主体中，插入3个按钮，用PubNub SDK发布消息，如下所示</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="2caa" class="mn ko hu nc b fv ng nh l ni nj">&lt;button type="button" onclick="publish('ON')"&gt;Auto Mode ON&lt;/button&gt;<br/>&lt;button type="button" onclick="publish('OFF')"&gt;Auto Mode OFF&lt;/button&gt;<br/>&lt;button type="button" onclick="publish('WATER')"&gt;Water Plant&lt;/button&gt;</span></pre><p id="cb99" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这些按钮下面，让我们的网站不断更新屏幕，显示步骤4中“ch2”通道发布的准确温度和湿度数据。为了做到这一点，我们给一个<p>标签一个名为“sensorData”的id，这样程序就可以在以后使用“getElementByID”和“changeInnerElement”函数调用注入</p><p>标签的内容。一会儿你就会明白我在说什么了。</p></p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="cd9e" class="mn ko hu nc b fv ng nh l ni nj">&lt;p id="sensorData"&gt;Temperature and Humidity Data&lt;/p&gt;</span></pre><p id="d092" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在让我们导入PubNub JavaScript SDK，以便实际使用“publish”方法和其他方法。</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="abe6" class="mn ko hu nc b fv ng nh l ni nj">&lt;script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.20.2.js"&gt;&lt;/script&gt;</span></pre><p id="58c4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后用API键实例化一个PubNub实例</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="650b" class="mn ko hu nc b fv ng nh l ni nj">var pubnub = new PubNub({<br/>  publishKey : 'YOUR PUB KEY',<br/>  subscribeKey : 'YOUR SUB KEY',<br/>  });</span></pre><p id="e931" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后创建一个发布回调，将按钮数据发布到RPI。注意我们如何为按钮数据保留“ch1 ”,为RPI数据保留“ch2”。</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="e77d" class="mn ko hu nc b fv ng nh l ni nj">function publish(a){<br/>  var publishConfig = <br/>    {<br/>      channel : "ch1",<br/>      message : a<br/>    };<br/>    pubnub.publish(publishConfig, function(status, response){<br/>      console.log(status, response);<br/>    });<br/>      <br/>  }</span></pre><p id="2906" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，我们实例化一个监听器和订阅者来获取RPI传感器数据。注意使用前面介绍的“getElementById”和“innerHTML”函数调用的那一行。这允许我们获取任何PubNub消息，并用相应的id标签更新屏幕上的任何变量。这对实时物联网仪表盘来说太棒了！</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="ed7d" class="mn ko hu nc b fv ng nh l ni nj">pubnub.addListener({<br/>    message: function(m) {<br/>        // handle message<br/>        var channelName = m.channel; // The channel for which the message belongs<br/>        var channelGroup = m.subscription; // The channel group or wildcard subscription match (if exists)<br/>        var pubTT = m.timetoken; // Publish timetoken<br/>        var msg = m.message; // The Payload<br/>        var publisher = m.publisher; //The Publisher<br/>        //inject the sensor data msg into the sensorData tag declared earlier for real-time updates<br/>        document.getElementById("sensorData").innerHTML = msg;<br/>        console.log(msg)<br/>    },<br/>    presence: function(p) {<br/>        // handle presence<br/>        var action = p.action; // Can be join, leave, state-change or timeout<br/>        var channelName = p.channel; // The channel for which the message belongs<br/>        var occupancy = p.occupancy; // No. of users connected with the channel<br/>        var state = p.state; // User State<br/>        var channelGroup = p.subscription; //  The channel group or wildcard subscription match (if exists)<br/>        var publishTime = p.timestamp; // Publish timetoken<br/>        var timetoken = p.timetoken;  // Current timetoken<br/>        var uuid = p.uuid; // UUIDs of users who are connected with the channel<br/>    },<br/>    status: function(s) {<br/>        var affectedChannelGroups = s.affectedChannelGroups;<br/>        var affectedChannels = s.affectedChannels;<br/>        var category = s.category;<br/>        var operation = s.operation;<br/>    }<br/>});<br/>pubnub.subscribe({<br/>    channels: ['ch2'],<br/>    <br/>});</span></pre><h1 id="371f" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">步骤6:用PubNub EON绘制你的输入数据</h1><p id="d090" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">现在是我们项目中最炫最酷的部分:<a class="ae jp" href="https://www.pubnub.com/developers/eon/" rel="noopener ugc nofollow" target="_blank"> EON </a>！PubNub EON允许用户通过放下脚本标签来轻松呈现实时数据图。</p><p id="3dab" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过将EON整合到我们的项目中，我们将得到类似这样的东西</p><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div class="fe ff nn"><img src="../Images/e5143aadae38a8cf6cc2a7400eccdd4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*CoDu29gDMnfuNoev.gif"/></div></figure><h2 id="cbd7" class="mn ko hu bd kp mo mp mq kt mr ms mt kx jc mu mv lb jg mw mx lf jk my mz lj na dt translated">HTML设置</h2><p id="bfe1" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">因为此时您很可能已经打开了HTML页面，所以让我们先从这里开始实现EON。</p><p id="7fbb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要将PubNub EON添加到任何HTML页面，只需在您的主体中添加这个div标记，它将注入实际的图表</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="7473" class="mn ko hu nc b fv ng nh l ni nj">&lt;div id="chart"&gt;&lt;/div&gt;</span></pre><p id="db21" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后导入脚本标签SDK</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="848c" class="mn ko hu nc b fv ng nh l ni nj">&lt;script src="<a class="ae jp" href="https://pubnub.github.io/eon/v/eon/1.0.0/eon.js" rel="noopener ugc nofollow" target="_blank">https://pubnub.github.io/eon/v/eon/1.0.0/eon.js</a>"&gt;&lt;/script&gt;<br/>&lt;link rel="stylesheet" href="<a class="ae jp" href="https://pubnub.github.io/eon/v/eon/1.0.0/eon.css" rel="noopener ugc nofollow" target="_blank">https://pubnub.github.io/eon/v/eon/1.0.0/eon.css</a>"/&gt;</span></pre><p id="79f2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后订阅你将要发布数据的eon-chart频道</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="0a2f" class="mn ko hu nc b fv ng nh l ni nj">eon.chart({<br/>        channels: ['eon-chart'],<br/>        history: true,<br/>        flow: true,<br/>        pubnub: pubnub,<br/>        generate: {<br/>          bindto: '#chart',<br/>          data: {<br/>            labels: false<br/>          }<br/>        }<br/>      });</span></pre><p id="a47a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就是这样！就这么简单！</p><p id="c883" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，让我们实现最后一步，即格式化传感器的发布者，以便EON知道如何绘制数据。</p><h2 id="6b39" class="mn ko hu bd kp mo mp mq kt mr ms mt kx jc mu mv lb jg mw mx lf jk my mz lj na dt translated">Python设置</h2><p id="72c3" class="pw-post-body-paragraph ir is hu it b iu ln iw ix iy lo ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">这部分就更简单了。就两行啊！</p><p id="4806" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">回到你的Plant.py python代码。现在，为了用python正确地发布到eon-chart API，您需要创建一个这种类型的字典</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="9c0e" class="mn ko hu nc b fv ng nh l ni nj">dictionary = {"eon": {"DATA NAME": DATA, "DATA 2 NAME": DATA 2 etc...}}</span></pre><p id="91a5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以在我们的例子中，我们的字典看起来像这样</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="d4af" class="mn ko hu nc b fv ng nh l ni nj">dictionary = {"eon": {"Temperature": temperature, "Humidity": humidity}}</span></pre><p id="886a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将此粘贴到将传感器数据发布到ch2的那一行的正上方。</p><p id="b7fd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们需要将这本字典发布到我们的图表将要读取的通道。在我们的例子中，eon-chart频道。</p><pre class="kg kh ki kj fq nb nc nd ne aw nf dt"><span id="d587" class="mn ko hu nc b fv ng nh l ni nj">pubnub.publish().channel("eon-chart").message(dictionary).async(publish_callback)</span></pre><p id="f2e0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就对了。你已经成功地创造了一个自我维持的系统来永远保存生命…..直到你需要重新装满水。</p></div><div class="ab cl no np hc nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="hn ho hp hq hr"><p id="5a4e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="mm">最初发表于</em><a class="ae jp" href="https://www.pubnub.com/blog/smart-automated-iot-plant-irrigation-system-raspberry-pi-pubnub/" rel="noopener ugc nofollow" target="_blank">T5【www.pubnub.com】</a><em class="mm">。</em></p></div></div>    
</body>
</html>