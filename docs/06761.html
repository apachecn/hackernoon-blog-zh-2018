<html>
<head>
<title>Reverse Engineering The Medium App (and making all stories in it free)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">对Medium应用程序进行逆向工程(并使其中的所有故事免费)</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/dont-publish-yet-reverse-engineering-the-medium-app-and-making-all-stories-in-it-free-48c8f2695687?source=collection_archive---------1-----------------------#2018-08-12">https://medium.com/hackernoon/dont-publish-yet-reverse-engineering-the-medium-app-and-making-all-stories-in-it-free-48c8f2695687?source=collection_archive---------1-----------------------#2018-08-12</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="4585" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上周我意识到距离我在这里的最后一篇文章已经过去一年了。我喜欢写自己的故事，就像我喜欢阅读别人的一样，但前提是我认为它们足够有趣，老实说，这是一个很高的标准。我最近一直在对Android应用程序进行逆向工程，所以我试图想出一个可能涉及该领域的项目，同时让Medium上的读者感兴趣。</p><p id="2692" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">反转中型Android应用程序可能很酷，但出于什么目的呢？经过一番思考后，我认为一个不错的目标可能是制作一个改进版的应用程序，它可以过滤掉会员需要的故事。</p><p id="2372" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因为Medium向新访问者免费提供前三个故事，所以过滤需要会员资格的故事就像让它们免费一样简单，所以让我们在我们的新应用中这样做:)</p><p id="4635" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们要做的是:</p><ul class=""><li id="d045" class="jp jq hu it b iu iv iy iz jc jr jg js jk jt jo ju jv jw jx dt translated">获取应用程序源代码。</li><li id="c3d9" class="jp jq hu it b iu jy iy jz jc ka jg kb jk kc jo ju jv jw jx dt translated">修改它，使媒体的后端API免费为我们提供故事。</li><li id="3cf1" class="jp jq hu it b iu jy iy jz jc ka jg kb jk kc jo ju jv jw jx dt translated">重新编译一切，安装被篡改的应用。</li></ul></div><div class="ab cl kd ke hc kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="hn ho hp hq hr"><h1 id="da42" class="kk kl hu bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">获取应用源代码</h1><p id="00f0" class="pw-post-body-paragraph ir is hu it b iu li iw ix iy lj ja jb jc lk je jf jg ll ji jj jk lm jm jn jo hn dt translated">所有的Android应用程序都是从APKs (Android包)安装的。Android操作系统使用这种包文件格式来分发和安装移动应用程序，它包含所有的应用程序资源、资产、证书等，包括应用程序源代码——包含Dalvik字节码的Dex文件。Dalvik字节码由Dalvik虚拟机<strong class="it hv"> </strong>执行，它类似于Java虚拟机，但针对手机的硬件和需求进行了优化。Dalvik虚拟机是一个负责在Android操作系统上执行程序的机器，你可以把它看作是一个针对手机环境优化的伟大而高效的机器。</p><p id="b92a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们可以很容易地从我们的APK中提取Dex文件(即使使用WinRAR，APK也是从ZIP扩展而来的包文件格式)，但是字节码指令不是人类可读的。使用smali/Baksmali(汇编器/反汇编器),我们可以将我们的Dex文件转换成Smali文件，Smali文件是用类似汇编的语法编写的(仍然是低级的，但肯定可读)。</p><p id="d869" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有了Smali文件后，我们可以将它们转换回Java文件，但只取得了部分成功。一些原因可能包括开发人员使用混淆器(这种工具意味着使逆向工程过程更加困难)。尽管如此，我们还是会尽可能地分解，因为这确实有助于理解一个应用程序的功能。</p><p id="5093" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae ln" href="https://ibotpeaches.github.io/Apktool/" rel="noopener ugc nofollow" target="_blank"> Apktool </a>和<a class="ae ln" href="https://github.com/skylot/jadx" rel="noopener ugc nofollow" target="_blank"> Jadx </a>是帮助我们做到以上的两个很棒的工具。Apktool生成Smali文件，Jadx试图为这些美味的Java文件付出额外的努力。</p><figure class="lp lq lr ls fq lt fe ff paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="fe ff lo"><img src="../Images/139cfc25630b278ff8eeae1617a5712f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0XTW6AuTVPjwDhF3m6f0jA.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">(From left to right) Java, Smali, and Dex, representing a code section that handles clap requests</figcaption></figure><h1 id="c4eb" class="kk kl hu bd km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld mi lf lg lh dt translated">让所有的故事免费</h1><p id="5782" class="pw-post-body-paragraph ir is hu it b iu li iw ix iy lj ja jb jc lk je jf jg ll ji jj jk lm jm jn jo hn dt translated">Medium向新访问者免费提供三个故事，并使用存储在访问者设备上的会话cookie来识别访问者。用新的cookie替换会话cookie意味着成为一个新的访问者，正如Medium的服务器所看到的那样(你可以通过打开一个新的匿名窗口来浏览Medium来测试它)。</p><p id="a7c5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，如果我们所有的获取故事的HTTP请求都是在没有会话cookie的情况下发送的，我们应该总是得到新访问者的待遇，并成功地接收每个故事。</p><p id="542a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在夜间浏览了应用程序源代码之后，我发现通过编辑OkHttp提供的默认cookie存储类可以很容易地完成上述工作。OkHttp是Android和Java应用的Http库，Medium Android应用就是用它开发的。据我在他们的文档上看到的，这是一个非常酷的库，支持很多功能。除此之外，它还提供了一个名为JavaNetCookieJar的简洁类，在构造OkHttp客户端实例时可以引用这个类来使它们持久地存储cookies。Medium也在内部使用它。</p><p id="5f7a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">获取故事的API调用是以<code class="eh mj mk ml mm b">/_/api/posts/{postId}</code>的形式，我们不要为这些请求提供cookies。下图显示了我们将对JavaNetCookieJar进行的修改。你可以在这里看到这个类的最初实现<a class="ae ln" href="https://github.com/square/okhttp/blob/master/okhttp-urlconnection/src/main/java/okhttp3/JavaNetCookieJar.java" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="lp lq lr ls fq lt fe ff paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="fe ff mn"><img src="../Images/befa4894f968a949ab39c8ded6cd2831.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m423jCi3yMcU5bwfSjou-A.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">^https:\\/\\/api\\.medium\\.com\\/_\\/api\\/posts\\/[^\\/]+$ is a regular expression escaped as a Java string, that matches URLs with the pattern for fetching stories shown above</figcaption></figure><h1 id="39ea" class="kk kl hu bd km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld mi lf lg lh dt translated">编译修改后的应用程序</h1><p id="ab59" class="pw-post-body-paragraph ir is hu it b iu li iw ix iy lj ja jb jc lk je jf jg ll ji jj jk lm jm jn jo hn dt translated">如前所述，我们无法完全获得Java中的一个应用程序源代码。因此，为了能够重新编译我们的应用程序，我们需要在汇编级别进行所有的更改(我们确实有应用程序的完整汇编源代码)。</p><p id="786e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对汇编文件进行修改听起来很恶心，但其实也没那么糟糕。尤其是如果我们说的是Java字节码汇编(Java虚拟机和Dalvik虚拟机都有比较高级的指令集，这里不是LC-3或者x86)。</p><p id="0976" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这些是对应于我们想要添加的先前Java语句的Smali指令:</p><figure class="lp lq lr ls fq lt"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="565f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不要担心理解它们，但如果你有一些低级语言的背景知识并试图理解那些指令，我应该告诉你v2是Java源代码中名为“url”的变量，cond_4是代码段的标签，它使函数返回一个空的cookies列表。</p><p id="8250" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们将这些行添加到应用程序源代码之后，我们需要重新编译所有内容。我们将再次使用Apktool，这一次是为了构建一个Smali文件的APK。现在我们有了一个修改过的APK，让我们快速的签署它(使用每个Android应用程序都需要经历的正常签署过程),我们就完成了！</p><h1 id="e2df" class="kk kl hu bd km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld mi lf lg lh dt translated">额外收获:增加一个新的设置选项</h1><p id="2add" class="pw-post-body-paragraph ir is hu it b iu li iw ix iy lj ja jb jc lk je jf jg ll ji jj jk lm jm jn jo hn dt translated">与我们已经做的类似，我添加了一个新的设置选项来启用和禁用我们的更改。只是添加了一些条件语句，复制了现有的设置代码，并将它们紧密地结合在一起。我们的新应用程序出来相当不错，看看下面吧！</p><figure class="lp lq lr ls fq lt fe ff paragraph-image"><div class="fe ff mq"><img src="../Images/a743bc6ce1417d55b815be4366e2362c.png" data-original-src="https://miro.medium.com/v2/resize:fit:634/1*Kn1j50RZsyEekhImg1d5cg.gif"/></div></figure></div><div class="ab cl kd ke hc kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="hn ho hp hq hr"><p id="ff54" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我最喜欢的写作方式是专注于事物的高层次方面，而不需要过多解释技术性的东西(比如我传递给Apktool的参数)。然而，如果你想学习本帖中介绍的实际技能，我列出了一些我最喜欢的资源:</p><p id="7142" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae ln" href="https://sushi2k.gitbooks.io/the-owasp-mobile-security-testing-guide/content/0x05c-Reverse-Engineering-and-Tampering.html" rel="noopener ugc nofollow" target="_blank">参考逆向工程Android应用</a></p><p id="e52f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae ln" href="https://github.com/JesusFreke/smali/wiki/Registers" rel="noopener ugc nofollow" target="_blank">斯马利寄存器解释</a></p><p id="7118" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae ln" href="https://github.com/JesusFreke/smali/wiki/TypesMethodsAndFields" rel="noopener ugc nofollow" target="_blank">小种类、方法、领域说明</a></p><p id="9bc8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae ln" href="http://pallergabor.uw.hu/androidblog/dalvik_opcodes.html" rel="noopener ugc nofollow" target="_blank">达尔维克操作码</a></p><p id="ef92" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我可能还应该提到，中型应用程序是相当容易逆转，事情变得更加复杂时，开发人员真的不希望你逆转他们的应用程序。然而，这些技术上的困难通常会带来回报——未打补丁的漏洞会因为这些困难而隐藏起来。在我的经验中，移动应用程序中的bug相当常见，在大公司的产品中也是如此(例如，我最近在Zynga的热门游戏“Draw Something”中发现了一个授予无限量游戏币的bug。我被添加到他们的<a class="ae ln" href="https://www.zynga.com/security/whitehats" rel="noopener ugc nofollow" target="_blank"> Whitehats页面</a>。</p><p id="0024" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">希望你喜欢我们的小项目，我当然喜欢:)</p><p id="ee29" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">中等请不要起诉🙏🙏🙏这一切都是为了教育目的。</p><h2 id="69cf" class="mr kl hu bd km ms mt mu kq mv mw mx ku jc my mz ky jg na nb lc jk nc nd lg ne dt translated"><strong class="ak">更新—故事的第二部分是</strong> <a class="ae ln" href="https://medium.freecodecamp.org/cache-deception-how-i-discovered-a-vulnerability-in-medium-and-helped-them-fix-it-31cec2a3938b" rel="noopener ugc nofollow" target="_blank"> <strong class="ak">这里是</strong> </a></h2></div></div>    
</body>
</html>