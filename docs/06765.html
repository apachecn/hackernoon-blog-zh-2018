<html>
<head>
<title>Ethernaut Lvl 1 Walkthrough: how to abuse the Fallback function</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ethernaut Lvl 1演练:如何滥用回退功能</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/ethernaut-lvl-1-walkthrough-how-to-abuse-the-fallback-function-118057b68b56?source=collection_archive---------5-----------------------#2018-08-12">https://medium.com/hackernoon/ethernaut-lvl-1-walkthrough-how-to-abuse-the-fallback-function-118057b68b56?source=collection_archive---------5-----------------------#2018-08-12</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="057d" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated"><em class="jj">这是一款</em> <a class="ae jk" rel="noopener" href="/@nicolezhu"> <em class="jj">深度系列</em> </a> <em class="jj">围绕</em> <a class="ae jk" href="https://openzeppelin.org/" rel="noopener ugc nofollow" target="_blank"> <em class="jj">齐柏林</em> </a> <em class="jj">团队的</em> <a class="ae jk" href="https://ethernaut.zeppelin.solutions/" rel="noopener ugc nofollow" target="_blank"> <em class="jj">智能契约安全拼图</em> </a> <em class="jj">。我会给你直接的资源和你需要的关键概念来100%自己解决这些难题。</em></h2></div><figure class="jm jn jo jp fq jq fe ff paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="fe ff jl"><img src="../Images/70e6414c0a2a851228f345c107f63ded.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XqTqAFIdjL4ETc6Liuqwhw.png"/></div></div></figure><p id="89f3" class="pw-post-body-paragraph jx jy hu jz b ka kb iv kc kd ke iy kf kg kh ki kj kk kl km kn ko kp kq kr ks hn dt translated">这个级别要求你利用一个实现很差的<code class="eh kt ku kv kw b">fallback</code>函数来控制别人的智能合约。</p></div><div class="ab cl kx ky hc kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hn ho hp hq hr"><h1 id="a2b9" class="le lf hu bd lg lh li lj lk ll lm ln lo ja lp jb lq jd lr je ls jg lt jh lu lv dt translated">什么是回退功能</h1><p id="b73c" class="pw-post-body-paragraph jx jy hu jz b ka lw iv kc kd lx iy kf kg ly ki kj kk lz km kn ko ma kq kr ks hn dt translated">如果你想让你的智能合同从其他合同和钱包接收以太网，最好的做法是实现一个简单的函数。</p><blockquote class="mc"><p id="b4bd" class="md me hu bd mf mg mh mi mj mk ml ks ek translated">回退功能使智能合约能够像钱包一样发挥作用。</p></blockquote><p id="c140" class="pw-post-body-paragraph jx jy hu jz b ka mm iv kc kd mn iy kf kg mo ki kj kk mp km kn ko mq kq kr ks hn dt translated">如果我有你的钱包地址，我可以不经你允许给你寄乙醚。在大多数情况下，您可能也希望为您的智能合同启用这种易于支付的功能。这样，其他合同/钱包可以发送以太到你的合同，而不必知道你的ABI或具体的功能名称。</p><blockquote class="mr ms mt"><p id="8a95" class="jx jy mb jz b ka kb iv kc kd ke iy kf mu kh ki kj mv kl km kn mw kp kq kr ks hn dt translated">注意:没有退路，或已知的支付功能，智能合约只能接收乙醚:I)作为采矿奖金，或ii)作为另一个具有<a class="ae jk" href="http://solidity.readthedocs.io/en/v0.4.21/introduction-to-smart-contracts.html#self-destruct" rel="noopener ugc nofollow" target="_blank">自毁</a>的合约的备份钱包。</p></blockquote><p id="05c9" class="pw-post-body-paragraph jx jy hu jz b ka kb iv kc kd ke iy kf kg kh ki kj kk kl km kn ko kp kq kr ks hn dt translated"><strong class="jz hv">问题是</strong>当开发者在回退函数内部实现关键逻辑<em class="mb">时。</em></p><p id="3cca" class="pw-post-body-paragraph jx jy hu jz b ka kb iv kc kd ke iy kf kg kh ki kj kk kl km kn ko kp kq kr ks hn dt translated">这种不良做法包括:改变合同所有权、转移资金等。在回退函数中:</p><figure class="jm jn jo jp fq jq fe ff paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="fe ff mx"><img src="../Images/f2589b51347f82ef247527a9c10855dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yhqQ9Hcmlu7tIJ65KxMV4w.png"/></div></div><figcaption class="my mz fg fe ff na nb bd b be z ek">Bad practice: you should not reassign contract ownership in a fallback function</figcaption></figure><p id="1498" class="pw-post-body-paragraph jx jy hu jz b ka kb iv kc kd ke iy kf kg kh ki kj kk kl km kn ko kp kq kr ks hn dt translated">这一关展示了你是如何让你的合同被滥用的，因为<strong class="jz hv">任何人都可以触发回退功能</strong>。</p><h1 id="7bf9" class="le lf hu bd lg lh nc lj lk ll nd ln lo ja ne jb lq jd nf je ls jg ng jh lu lv dt translated">触发回退功能的方式</h1><p id="d21a" class="pw-post-body-paragraph jx jy hu jz b ka lw iv kc kd lx iy kf kg ly ki kj kk lz km kn ko ma kq kr ks hn dt translated">任何人都可以通过以下方式调用回退功能:</p><ol class=""><li id="da51" class="nh ni hu jz b ka kb kd ke kg nj kk nk ko nl ks nm nn no np dt translated">调用合同中不存在的函数，或者</li><li id="1c75" class="nh ni hu jz b ka nq kd nr kg ns kk nt ko nu ks nm nn no np dt translated">调用函数<strong class="jz hv">而没有传入所需的数据</strong>，或者</li><li id="475e" class="nh ni hu jz b ka nq kd nr kg ns kk nt ko nu ks nm nn no np dt translated">向合同发送<strong class="jz hv">乙醚</strong>乙醚<strong class="jz hv">无任何数据</strong></li></ol></div><div class="ab cl kx ky hc kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hn ho hp hq hr"><h1 id="89c7" class="le lf hu bd lg lh li lj lk ll lm ln lo ja lp jb lq jd lr je ls jg lt jh lu lv dt translated">详细演练</h1><p id="5a28" class="pw-post-body-paragraph jx jy hu jz b ka lw iv kc kd lx iy kf kg ly ki kj kk lz km kn ko ma kq kr ks hn dt translated">在Fallback.sol中有两个地方，作为<code class="eh kt ku kv kw b">msg.sender</code>，你可以成为契约的<strong class="jz hv">所有者</strong>:</p><figure class="jm jn jo jp fq jq"><div class="bz el l di"><div class="nv nw l"/></div></figure><p id="f00c" class="pw-post-body-paragraph jx jy hu jz b ka kb iv kc kd ke iy kf kg kh ki kj kk kl km kn ko kp kq kr ks hn dt translated">第一个选项要求您将<code class="eh kt ku kv kw b">1000000000000000000000 wei</code>或<code class="eh kt ku kv kw b">1000 Ether</code>发送到这个智能合同。</p><p id="68e7" class="pw-post-body-paragraph jx jy hu jz b ka kb iv kc kd ke iy kf kg kh ki kj kk kl km kn ko kp kq kr ks hn dt translated">你可能没有5个小时来慢慢地从Ropsten水龙头请求1000个乙醚，在最初的几次请求后，它会严重地限制你。所以让我们退回到<code class="eh kt ku kv kw b">fallback</code>选项。</p><h2 id="f848" class="nx lf hu bd lg ny nz oa lk ob oc od lo kg oe of lq kk og oh ls ko oi oj lu ok dt translated"><strong class="ak">注意回退功能有两个要求:</strong></h2><pre class="jm jn jo jp fq ol kw om on aw oo dt"><span id="75ba" class="nx lf hu kw b fv op oq l or os">require(msg.value &gt; 0 &amp;&amp; contributions[msg.sender] &gt; 0);</span></pre><ul class=""><li id="db05" class="nh ni hu jz b ka kb kd ke kg nj kk nk ko nl ks ot nn no np dt translated">您的帐户地址需要在过去向该合同捐赠过乙醚</li><li id="12f8" class="nh ni hu jz b ka nq kd nr kg ns kk nt ko nu ks ot nn no np dt translated">您的获胜回退函数调用需要包含一些以太值</li></ul><h2 id="5ce9" class="nx lf hu bd lg ny nz oa lk ob oc od lo kg oe of lq kk og oh ls ko oi oj lu ok dt translated">使用<a class="ae jk" href="http://remix.ethereum.org/" rel="noopener ugc nofollow" target="_blank">混音IDE </a>:</h2><ol class=""><li id="5db8" class="nh ni hu jz b ka lw kd lx kg ou kk ov ko ow ks nm nn no np dt translated">将合同代码粘贴到UI中。这给了混音匹配的ABI工作。</li><li id="f235" class="nh ni hu jz b ka nq kd nr kg ns kk nt ko nu ks nm nn no np dt translated">确保你给了Remix完整的导入路径。Ethernaut为其dApp提供了Remix无法识别的短路径:</li></ol><pre class="jm jn jo jp fq ol kw om on aw oo dt"><span id="e2ed" class="nx lf hu kw b fv op oq l or os">import 'github.com/OpenZeppelin/zeppelin-solidity/contracts/ownership/Ownable.sol';<br/></span></pre><p id="90ee" class="pw-post-body-paragraph jx jy hu jz b ka kb iv kc kd ke iy kf kg kh ki kj kk kl km kn ko kp kq kr ks hn dt translated">3.通过<code class="eh kt ku kv kw b">instance</code>地址加载合同，检索您现有的合同实例:</p><figure class="jm jn jo jp fq jq fe ff paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="fe ff ox"><img src="../Images/fc2dd4434b0b3dc5b7704221ac119c9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8jn9OFlZW8RV_I6Mns1pMw.png"/></div></div><figcaption class="my mz fg fe ff na nb bd b be z ek">Check ‘instance’ inside the console for your address. 0xb9bcfd… is my instance address.</figcaption></figure><p id="0802" class="pw-post-body-paragraph jx jy hu jz b ka kb iv kc kd ke iy kf kg kh ki kj kk kl km kn ko kp kq kr ks hn dt translated">4.使用<code class="eh kt ku kv kw b">contribute</code>函数向契约捐赠少量的乙醚。确保您从您的<code class="eh kt ku kv kw b">player</code>账户地址捐款。</p><p id="1acd" class="pw-post-body-paragraph jx jy hu jz b ka kb iv kc kd ke iy kf kg kh ki kj kk kl km kn ko kp kq kr ks hn dt translated"><strong class="jz hv">注意:</strong><code class="eh kt ku kv kw b">contribute()</code>函数有条件语句:<code class="eh kt ku kv kw b">require(msg.value &lt; 0.001 ether);</code></p><p id="245d" class="pw-post-body-paragraph jx jy hu jz b ka kb iv kc kd ke iy kf kg kh ki kj kk kl km kn ko kp kq kr ks hn dt translated">确保你的贡献<code class="eh kt ku kv kw b">value</code>小于0.001乙醚。</p><figure class="jm jn jo jp fq jq fe ff paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="fe ff oy"><img src="../Images/46f6ed880ac0024490ec3c4e1c330a4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X6w6RHL6eY8fWSweQ2A8gw.png"/></div></div><figcaption class="my mz fg fe ff na nb bd b be z ek">Check that you’re donating from your `player` wallet address</figcaption></figure><p id="f208" class="pw-post-body-paragraph jx jy hu jz b ka kb iv kc kd ke iy kf kg kh ki kj kk kl km kn ko kp kq kr ks hn dt translated">5.最后，在<code class="eh kt ku kv kw b">value</code>字段中添加任意值，并触发<code class="eh kt ku kv kw b">(fallback)</code>函数。</p><figure class="jm jn jo jp fq jq fe ff paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="fe ff oz"><img src="../Images/9a3d283292b80e8e41203e0a0888d8ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F73Vvk6BRTMFVhH9ofITtA.jpeg"/></div></div></figure><p id="a883" class="pw-post-body-paragraph jx jy hu jz b ka kb iv kc kd ke iy kf kg kh ki kj kk kl km kn ko kp kq kr ks hn dt translated">在控制台中，通过键入<code class="eh kt ku kv kw b">await contract.owner();</code>检查您现在是否拥有合同</p></div><div class="ab cl kx ky hc kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hn ho hp hq hr"><h2 id="2773" class="nx lf hu bd lg ny nz oa lk ob oc od lo kg oe of lq kk og oh ls ko oi oj lu ok dt translated">如果使用控制台(非混音):</h2><p id="0b90" class="pw-post-body-paragraph jx jy hu jz b ka lw iv kc kd lx iy kf kg ly ki kj kk lz km kn ko ma kq kr ks hn dt translated">您可以通过控制台发送事务来触发回退功能，效果相同:</p><pre class="jm jn jo jp fq ol kw om on aw oo dt"><span id="70b1" class="nx lf hu kw b fv op oq l or os">contract.sendTransaction({<br/>  from: player,<br/>  value: toWei(...)<br/>})</span><span id="568c" class="nx lf hu kw b fv pa oq l or os">// Make sure you leave the "data:" field empty</span></pre><h1 id="c35c" class="le lf hu bd lg lh nc lj lk ll nd ln lo ja ne jb lq jd nf je ls jg ng jh lu lv dt translated">关键安全要点</h1><ul class=""><li id="dca1" class="nh ni hu jz b ka lw kd lx kg ou kk ov ko ow ks ot nn no np dt translated">如果你实现了回退功能，<strong class="jz hv">保持简单</strong></li><li id="850d" class="nh ni hu jz b ka nq kd nr kg ns kk nt ko nu ks ot nn no np dt translated">使用回退功能<strong class="jz hv">将支付事件发送到交易日志</strong></li><li id="8bd9" class="nh ni hu jz b ka nq kd nr kg ns kk nt ko nu ks ot nn no np dt translated">使用回退功能<strong class="jz hv">检查简单的条件要求</strong></li><li id="fa30" class="nh ni hu jz b ka nq kd nr kg ns kk nt ko nu ks ot nn no np dt translated"><strong class="jz hv">在使用回退函数更改合同所有权、转移资金、支持低级函数调用等之前，请三思而行</strong>。</li></ul></div><div class="ab cl kx ky hc kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hn ho hp hq hr"><h1 id="fd2d" class="le lf hu bd lg lh li lj lk ll lm ln lo ja lp jb lq jd lr je ls jg lt jh lu lv dt translated">更多级别</h1><div class="pb pc fm fo pd pe"><a href="https://hackernoon.com/ethernaut-lvl-0-walkthrough-abis-web3-and-how-to-abuse-them-d92a8842d71b" rel="noopener  ugc nofollow" target="_blank"><div class="pf ab ej"><div class="pg ab ph cl cj pi"><h2 class="bd hv fv z el pj eo ep pk er et ht dt translated">Ethernaut Lvl 0演练:ABIs、Web3以及如何滥用它们</h2><div class="pl l"><h3 class="bd b fv z el pj eo ep pk er et ek translated">让智能合同做它不想做的事情…</h3></div><div class="pm l"><p class="bd b gc z el pj eo ep pk er et ek translated">hackernoon.com</p></div></div><div class="pn l"><div class="po l pp pq pr pn ps jv pe"/></div></div></a></div><div class="pb pc fm fo pd pe"><a rel="noopener follow" target="_blank" href="/@nicolezhu/ethernaut-lvl-2-walkthrough-how-simple-developer-errors-become-big-mistakes-b705ff00a62f"><div class="pf ab ej"><div class="pg ab ph cl cj pi"><h2 class="bd hv fv z el pj eo ep pk er et ht dt translated">Ethernaut Lvl 2辐射演练:简单的开发人员错误如何变成大错误</h2><div class="pl l"><h3 class="bd b fv z el pj eo ep pk er et ek translated">这是一个围绕齐柏林团队的智能合同安全难题的深入系列。我会给你直接的资源…</h3></div><div class="pm l"><p class="bd b gc z el pj eo ep pk er et ek translated">medium.com</p></div></div><div class="pn l"><div class="pt l pp pq pr pn ps jv pe"/></div></div></a></div></div></div>    
</body>
</html>