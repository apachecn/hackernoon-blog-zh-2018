<html>
<head>
<title>AWS Events Analysis with ELK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ELK的AWS事件分析</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/aws-events-analysis-with-elk-4a2d9ee9232f?source=collection_archive---------11-----------------------#2018-08-12">https://medium.com/hackernoon/aws-events-analysis-with-elk-4a2d9ee9232f?source=collection_archive---------11-----------------------#2018-08-12</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="f40b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">记录您的AWS环境活动是必须的。它可以帮助您持续监控环境的安全性，并实时检测可疑或不良活动。因此，节省了数千美元。幸运的是，AWS提供了一个名为<strong class="it hv"> CloudTrail </strong>的解决方案，可以让你实现这一点。它记录所有AWS区域中的所有事件，并在单个S3存储桶中记录每个API调用。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/0b8b9c40a4a98a188436d87289ef33e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RsYYJLB9H8gAQTIotI8qXA.png"/></div></div></figure><p id="601f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">从那里，您可以使用流行的日志堆栈ELK ( <strong class="it hv"> Elasticsearch </strong>、<strong class="it hv">Logstash</strong>&amp;<strong class="it hv">Kibana</strong>)来设置分析管道，以便在单个动态仪表板中读取、解析、索引和可视化这些日志，甚至采取相应的行动:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kb"><img src="../Images/d18e4af02b2675154e18746264d814ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y1KNbfvS7B0Yw6ssnsiGDg.png"/></div></div></figure><p id="2289" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，创建一个安装并预配置了ELK组件的AMI。AMI将基于Ubuntu映像:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="e00b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了提供AMI，我们将使用以下shell脚本:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="043d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在模板定义好了，用<strong class="it hv"> Packer </strong>烘焙一个新的AMI:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="4bcb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦创建了AMI，使用<strong class="it hv"> Terraform </strong>基于AMI创建一个新的EC2实例。确保向实例授予S3权限，以便能够从bucket中读取CloudTrail日志:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="5fbb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">发出以下命令来配置基础架构:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="bf3e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">返回AWS管理控制台，导航到CloudTrail，并单击“<strong class="it hv">创建踪迹</strong>”按钮:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ke"><img src="../Images/252341bc01daca8f316692cb5e058d15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_Ewak_HHo-5oHNVZ"/></div></div></figure><p id="d586" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为其命名，并将踪迹应用于所有AWS区域:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ke"><img src="../Images/ea3465914868465c6ef76403f84821e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*B1QsGcjDC_MO6JJf"/></div></div></figure><p id="ff07" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">点击“<strong class="it hv">创建</strong>”，轨迹应创建如下:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kf"><img src="../Images/6e27b6a22a03c599cd78015f17a68d2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bdwLxYmdb1p2Lmq-"/></div></div></figure><p id="1eeb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，将Logstash配置为定期读取CloudTrail日志。<strong class="it hv"> geoip </strong>过滤器根据<em class="kg"> sourceipAddress </em>字段添加IP地址的地理位置信息。然后，它会自动将日志存储到Elasticsearch:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="9bde" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了使更改生效，使用下面的命令重新启动Logstash:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="ea14" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">应该在elastic search(<a class="ae kh" href="http://ip:9200/_cat/indices?v" rel="noopener ugc nofollow" target="_blank"><em class="kg">http://IP:9200/_ cat/indexes)上创建一个新的索引？v </em> </a></p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ki"><img src="../Images/db92d42d1464509dc898d536ee17bfa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*REUVhgphrVEWgDNd"/></div></div></figure><p id="afc6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在Kibana上，创建一个与用于存储日志的索引格式相匹配的新索引模式:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ke"><img src="../Images/eb6b79112d61f7803d7b441cb7742bcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dOYVURKpRgqcDhLc"/></div></div></figure><p id="bdd3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">创建索引后，我们可以开始探索我们的CloudTrail事件:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ke"><img src="../Images/9138f3d97b9fc83ebe347729b31c38bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nBdD-lU_3ImfoLhU"/></div></div></figure><p id="0d34" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们已经在Elasticsearch内部处理了数据，让我们构建一些图表。我们将使用Kibana中的地图可视化来监控对AWS环境的地理访问:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ke"><img src="../Images/d340517fb3156d7c1702ba852ab72e9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NFIwjN1qmf6OjF3q"/></div></div></figure><p id="d6d3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，您可以看到从何处访问环境:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ke"><img src="../Images/dc41872a9c5491b00fb44e14ba77097c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OR36STgsPZkhNMsu"/></div></div></figure><p id="cc0c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，创建更多小部件来显示关于用户身份、用户代理和用户采取的操作的信息。大概是这样的:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ke"><img src="../Images/02e02036ade71406612f56e908ab6acf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z9jpjra2_kSrGMI3"/></div></div></figure><p id="4479" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以更进一步，根据特定事件(有人从未定义的位置访问您的环境)设置警报，以便接近实时地发出警报。</p><p id="bee2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kg">完整代码可以在我的</em> <a class="ae kh" href="https://github.com/mlabouardy/lambda-oneshot-container" rel="noopener ugc nofollow" target="_blank"> <em class="kg"> GitHub </em> </a> <em class="kg">上找到。请务必在下面留下您的评论、反馈或建议，或者直接在Twitter上与我联系</em><a class="ae kh" href="https://twitter.com/mlabouardy" rel="noopener ugc nofollow" target="_blank"><strong class="it hv"><em class="kg">@</em></strong><em class="kg">mlabouardy</em></a><em class="kg">。</em></p></div></div>    
</body>
</html>