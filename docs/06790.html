<html>
<head>
<title>A Redux State organization proposal</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个冗余的国家组织提案</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/a-redux-state-organization-proposal-a93f3d79a6d2?source=collection_archive---------9-----------------------#2018-08-13">https://medium.com/hackernoon/a-redux-state-organization-proposal-a93f3d79a6d2?source=collection_archive---------9-----------------------#2018-08-13</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="72a3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当使用Redux时，很难开始组织你的状态。我已经看到我的许多学生在需要的时候不断添加房产。这种疯狂的策略可能会导致你有一个巨大的国家造成的可怕的技术债务。</p><p id="1220" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">例如，当遵循该策略时，您可能会得到如下结果:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/565e8eaecf2499783ea5a2d32081d533.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G8wSnNpNCjHYiQJMUb32CQ.png"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Try to imagine this but with almost 50 properties, and larger lists.</figcaption></figure><p id="3e4a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我在上面的状态中发现的问题是所有属性都是混合的。</p><ul class=""><li id="375f" class="kf kg hu it b iu iv iy iz jc kh jg ki jk kj jo kk kl km kn dt translated"><code class="eh ko kp kq kr b">auth_token</code>将主要集中使用:一个<code class="eh ko kp kq kr b">ApiClient</code>服务或中间件。</li><li id="d4e6" class="kf kg hu it b iu ks iy kt jc ku jg kv jk kw jo kk kl km kn dt translated"><code class="eh ko kp kq kr b">movies</code>是一个实体列表。它将用于整个应用程序，以呈现应用程序提供的信息。</li><li id="f03c" class="kf kg hu it b iu ks iy kt jc ku jg kv jk kw jo kk kl km kn dt translated"><code class="eh ko kp kq kr b">fetching</code>是一个表示性的标志，我们将在一个特定的视图(组件)中使用它，例如为了显示一个加载微调器。</li></ul><p id="8780" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们可以从<strong class="it hv">量级</strong>的角度来看属性是如何混合的——因为<code class="eh ko kp kq kr b">movies</code>(数据)与<code class="eh ko kp kq kr b">fetching</code>(标志)<strong class="it hv"> </strong>和<strong class="it hv">用法</strong>的重要性不同——因为它们在完全不同的地方和时间使用。</p><p id="a23b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这两点可能会影响设计，<strong class="it hv">一个混乱的状态组织可能会影响我们选择器的模块化(</strong> <code class="eh ko kp kq kr b"><strong class="it hv">mapStateToProps</strong></code> <strong class="it hv">)。</strong></p><h1 id="1ded" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">建议的解决方案</h1><p id="4084" class="pw-post-body-paragraph ir is hu it b iu lv iw ix iy lw ja jb jc lx je jf jg ly ji jj jk lz jm jn jo hn dt translated">经过一些尝试，我想出了一个解决上述问题的国家组织。它非常灵活，适合不同结构的项目。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ma"><img src="../Images/c2083ef788e4f28a22871e6663e3aee6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4QcyMBnuvKJzCHjH5jroPg.png"/></div></div></figure><p id="5119" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用<code class="eh ko kp kq kr b">combineReducers</code>创建该状态，以定义由不同减速器控制的独立状态部分。注意，我使用了<a class="ae mb" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Object_initializer#New_notations_in_ECMAScript_2015" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">的简写属性名</strong> </a> <strong class="it hv"> </strong>来定义对象的属性:<code class="eh ko kp kq kr b">authentication</code>是<code class="eh ko kp kq kr b">authentication: authentication</code>的简写，是我稍后将描述的第二个reducer函数。</p><h2 id="4af2" class="mc ky hu bd kz md me mf ld mg mh mi lh jc mj mk ll jg ml mm lp jk mn mo lt mp dt translated"><strong class="ak">认证还原器</strong></h2><p id="b39d" class="pw-post-body-paragraph ir is hu it b iu lv iw ix iy lw ja jb jc lx je jf jg ly ji jj jk lz jm jn jo hn dt translated">身份验证缩减器旨在存储和控制与当前登录用户相关的所有数据。如果您的应用中没有任何身份验证策略，您可以跳过这一部分。在其中，您可以保存像当前用户对象、auth令牌这样的东西。这非常有用，例如，当您希望记住会话时，因为它可以在创建存储时持久化和预加载。这里有一个非常酷的教程<a class="ae mb" href="https://egghead.io/lessons/javascript-redux-persisting-the-state-to-the-local-storage" rel="noopener ugc nofollow" target="_blank">丹·阿布拉莫夫的</a>解释了如何轻松做到这一点。</p><p id="9ea2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该还原程序将监听与认证相关的特定动作类型:<code class="eh ko kp kq kr b">SIGN_IN_SUCCESS</code> <code class="eh ko kp kq kr b">SIGN_UP_SUCCESS</code> <code class="eh ko kp kq kr b">LOG_OUT</code> …</p><h2 id="a494" class="mc ky hu bd kz md me mf ld mg mh mi lh jc mj mk ll jg ml mm lp jk mn mo lt mp dt translated">实体缩减器</h2><p id="07a2" class="pw-post-body-paragraph ir is hu it b iu lv iw ix iy lw ja jb jc lx je jf jg ly ji jj jk lz jm jn jo hn dt translated">这是减速器最特别的部分。我们习惯于看到基于<code class="eh ko kp kq kr b">action.type</code>上的巨大<code class="eh ko kp kq kr b">switch</code>的reducers，以及状态转换列表。但是这个程序将用不到20行代码来控制我们前端的整个数据集。</p><p id="4b31" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个想法是，状态的这个属性存储了一个本地数据库，其中包含我们必须处理的所有实体，这些实体是在某个时候从后端提供给我们的。假设我们继续以电影为例，那么这可能是一种状态:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mq"><img src="../Images/45e8c37304427f3bbf6e5eb5711ce1ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2_HzWXYE7cn0rTafV1HubA.png"/></div></div></figure><p id="4088" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如你所看到的，状态被分成不同的实体组，这些组不是数组，而是带有与每个实体的每个对象的id相关的键的对象。这样可以避免重复。<strong class="it hv">主要思想是，这将作为一个迷你本地关系数据库</strong>:没有什么是重复的，但被引用。通过避免嵌套，我们使得<strong class="it hv">更容易关联数据并避免不一致</strong>。</p><p id="a7bb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您的数据都是本地的，那么用这种方式管理它不会有问题，但是如果您使用的是API，它很可能会以嵌套的方式提供数据。为了将数据处理成我们的格式，您可以使用<a class="ae mb" href="https://github.com/paularmstrong/normalizr" rel="noopener ugc nofollow" target="_blank"> normalizr </a>。经过一些配置，就可以扁平化调用函数<code class="eh ko kp kq kr b">normalize</code>。它将返回一个具有两个属性的对象:<code class="eh ko kp kq kr b">entities</code>和<code class="eh ko kp kq kr b">result</code>。实体将是以我们的格式提取和规范化的数据；结果将是您刚才获取的根实体的id的关系。</p><p id="a5b6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">实体！多巧啊，哈？实际上，不是。我从<a class="ae mb" href="https://github.com/reduxjs/redux/tree/master/examples/real-world" rel="noopener ugc nofollow" target="_blank"> Redux的真实世界示例</a>中获得了这种模式，它使用Github的API，在此之后规范化它的数据。</p><p id="03f2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由于这种格式，我们可以编写一个缩减器，只用几行代码就可以控制状态的整个<code class="eh ko kp kq kr b">entities</code>部分</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mr"><img src="../Images/7442561283c5f9ac2bcdbe0dc6cb558e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hh9Gv0Hf9D1s7MYUtOL8bA.png"/></div></div></figure><p id="8979" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每次我们的动作包含属性<code class="eh ko kp kq kr b">entities</code>，它将与我们当前状态的实体值合并。</p><blockquote class="ms mt mu"><p id="bcd4" class="ir is mv it b iu iv iw ix iy iz ja jb mw jd je jf mx jh ji jj my jl jm jn jo hn dt translated">警告:这个reducer只是在数据到来时添加或覆盖数据，没有理由从我们的状态中删除数据。有些人可能会说这是不必要的，因为删除可以被视为对元素的<code class="eh ko kp kq kr b">delete</code>标志的修改(软删除)。你怎么想呢?有什么改进这个案子的建议吗？大家在评论里辩论一下吧！</p></blockquote><h2 id="95b9" class="mc ky hu bd kz md me mf ld mg mh mi lh jc mj mk ll jg ml mm lp jk mn mo lt mp dt translated">页面缩减器</h2><p id="745d" class="pw-post-body-paragraph ir is hu it b iu lv iw ix iy lw ja jb jc lx je jf jg ly ji jj jk lz jm jn jo hn dt translated">酷！我们所有的数据都被自动处理并合并到国家！但是我们应该小心:我们的数据存储在对象中，没有数组，所以没有顺序。</p><p id="0b24" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们应该保持后端提供的结果的顺序，他们可能会花费大量的资源(所以钱💸)来决定电影呈现给每个用户的顺序(网飞，有人？).但是通过规范化它们，我们忽略了这个顺序。这就是为什么normalizr也给了我们<code class="eh ko kp kq kr b">results</code>，一个代表获取资源的id关系。</p><p id="bfc9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你获取了一个ID为<code class="eh ko kp kq kr b">101</code>的电影(API响应一个对象)？<code class="eh ko kp kq kr b">results</code>属性将为<code class="eh ko kp kq kr b">101</code>；获取id为<code class="eh ko kp kq kr b">101</code>和<code class="eh ko kp kq kr b">100</code>的电影数组(API发送数组)？<code class="eh ko kp kq kr b">results</code>将此数组<code class="eh ko kp kq kr b">[101,100]</code>(保持顺序)。请参见下面的示例:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mz"><img src="../Images/54711875834882df274f691026402a6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XzfjcHGWSlChXNyOmgRf-g.png"/></div></div></figure><p id="bd1e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注意，原来的响应是一个电影数组，规范化对象的<code class="eh ko kp kq kr b">results</code>属性也是一个数组，保持原来的顺序。</p><p id="21fe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">entities reducer中没有空间容纳这个<code class="eh ko kp kq kr b">results</code>数组，所以我们必须将它放在另一个地方:页面reducer。页面缩减器是关于不同页面需要的局部变量，以呈现其信息。元素数组，加载标志，如果不使用redux-form，可能是表单数据。基本思想是，当entities reducers保存来自资源的数据时，<strong class="it hv"> pages reducer存储与呈现屏幕</strong>相关的数据。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff na"><img src="../Images/3ed4bf1d6f5937fdf71d6fb87a7e0244.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8EN8ypN8yHTTI7D_BSRmWQ.png"/></div></div></figure><p id="1d0a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如您所看到的，当将状态映射到容器中的属性时，我们创建了一个数组，将结果(<code class="eh ko kp kq kr b">state.pages.boxOffice.myListMovies</code>，id列表)中的所有元素映射到<code class="eh ko kp kq kr b">entities</code>中的实际数据。</p><p id="de1c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个想法是将<code class="eh ko kp kq kr b">state.pages</code>属性再次分割成一组你在应用程序中显示的所有页面。例如，路由反应路由器加载的每个组件。</p><h1 id="9c80" class="kx ky hu bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">包扎</h1><p id="2f40" class="pw-post-body-paragraph ir is hu it b iu lv iw ix iy lw ja jb jc lx je jf jg ly ji jj jk lz jm jn jo hn dt translated">这种结构将帮助您轻松扩展数据驱动的应用程序。如果你必须添加其他类型的实体，这不会影响页面的结构。如果您想添加另一个以不同方式加载现有实体的屏幕，您可以使用pages reducer，而不必担心数据控制。所有这些都将帮助我们遵循简单的真理来源原则，这将帮助您在开发过程中避免许多问题。</p><p id="48c4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将来，我想用这种模式来写Redux的重选。</p><p id="1eba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我知道你在评论中的想法，让我们讨论更好的做法或修改。</p><p id="3a45" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">编码快乐！</p></div></div>    
</body>
</html>