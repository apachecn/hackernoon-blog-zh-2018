<html>
<head>
<title>Migrating the Silverlight Toolkit TreeView control to UWP and the Uno Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Silverlight Toolkit TreeView控件迁移到UWP和Uno平台</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/migrating-the-silverlight-toolkit-treeview-control-into-the-uwp-and-the-uno-platform-25db9b175fec?source=collection_archive---------13-----------------------#2018-08-15">https://medium.com/hackernoon/migrating-the-silverlight-toolkit-treeview-control-into-the-uwp-and-the-uno-platform-25db9b175fec?source=collection_archive---------13-----------------------#2018-08-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/c2e9214ace63d9968336c5bdd00f9ce9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xQB6_aQLdS6Bm3moF8RVxA.png"/></div></div></figure><blockquote class="jc jd je"><p id="ac4c" class="jf jg jh ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">你可以在<a class="ae ke" href="https://github.com/nventive/Uno.UI.Toolkit.SL" rel="noopener ugc nofollow" target="_blank"> Uno中找到这篇文章的</a> <code class="eh kf kg kh ki b"><a class="ae ke" href="https://github.com/nventive/Uno.UI.Toolkit.SL/tree/master/Uno.UI.Toolkit.SL/Controls/TreeView" rel="noopener ugc nofollow" target="_blank">TreeView</a></code>的代码<a class="ae ke" href="https://github.com/nventive/Uno.UI.Toolkit.SL/tree/master/Uno.UI.Toolkit.SL/Controls/TreeView" rel="noopener ugc nofollow" target="_blank">。UI.Toolkit.SL </a>存储库，我们将在其中添加新的控件，并在控件可用时接受它们的贡献。</p></blockquote></div><div class="ab cl kj kk hc kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hn ho hp hq hr"><p id="661e" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt kt translated"><span class="l ku kv kw bm kx ky kz la lb di">在</span>这个博客系列文章中，我们将讨论<a class="ae ke" href="https://github.com/MicrosoftArchive/SilverlightToolkit" rel="noopener ugc nofollow" target="_blank">Silverlight Toolkit TreeView control</a><a class="ae ke" href="https://github.com/MicrosoftArchive/SilverlightToolkit/tree/master/Release/Silverlight4/Source/Controls/TreeView" rel="noopener ugc nofollow" target="_blank">TreeView control</a>到UWP和<a class="ae ke" href="https://github.com/nventive/Uno" rel="noopener ugc nofollow" target="_blank"> Uno Platform </a>的代码迁移，这是一个广泛应用于许多商业应用程序的控件，至今仍在使用。</p><p id="a536" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">这包括最初可能工作也可能不工作的部分功能，以及在必要时必须在Uno平台中进行的修改，以符合UWP。虽然Uno平台包含了Spring Creators Update (17134)的所有API，但是这些API中有许多还没有实现，可能还有一些被Silverlight <code class="eh kf kg kh ki b">TreeView</code>控件使用。</p><p id="c2cc" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">此外，这个练习的重点是从Silverlight代码库完成一个迁移过程，因为在UWP已经有一个现有的<code class="eh kf kg kh ki b">TreeView</code>控件API。在撰写本文时，UWP <code class="eh kf kg kh ki b">TreeView</code>还没有在Uno平台上实现，迁移这个Silverlight控件也不是一个选项，因为这些API有很大的不同，而且不直接兼容。</p><h1 id="752f" class="lc ld hu bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz dt translated">导入Silverlight TreeView控件源</h1><p id="c0e6" class="pw-post-body-paragraph jf jg hu ji b jj ma jl jm jn mb jp jq kq mc jt ju kr md jx jy ks me kb kc kd hn dt translated">要从Silverlight迁移控件，需要做一些事情:</p><ul class=""><li id="3d61" class="mf mg hu ji b jj jk jn jo kq mh kr mi ks mj kd mk ml mm mn dt translated">使用来自<a class="ae ke" href="https://marketplace.visualstudio.com/items?itemName=nventivecorp.uno-platform-addin" rel="noopener ugc nofollow" target="_blank"> Uno平台VS Addin </a>的跨平台库模板创建一个跨目标项目</li><li id="8a0b" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated">用UWP名称空间替换Silverlight名称空间，并有选择地导入<code class="eh kf kg kh ki b">TreeView</code>源文件和依赖项</li><li id="0ba6" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated">为略有变化的API调整代码</li><li id="cd33" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated">暂时注释掉发生重大变化的API的代码。</li><li id="3bf7" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated">调整XAML</li></ul><h2 id="2375" class="mt ld hu bd le mu mv mw li mx my mz lm kq na nb lq kr nc nd lu ks ne nf ly ng dt translated">跨目标项目创建</h2><p id="3d0d" class="pw-post-body-paragraph jf jg hu ji b jj ma jl jm jn mb jp jq kq mc jt ju kr md jx jy ks me kb kc kd hn dt translated">为了能够以可重用的方式构建控件，在NuGet包中，我们需要使用Uno Platform VS Addin创建一个跨平台的库，它可以针对Windows (uap10.0)、iOS、Android和WebAssembly进行所有配置。</p><p id="506e" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">这个项目将包含<code class="eh kf kg kh ki b">TreeView</code>正常运行所需的所有XAML文件和C#源文件。它使用了优秀的<a class="ae ke" href="https://github.com/onovotny/MSBuildSdkExtras" rel="noopener ugc nofollow" target="_blank"> MSBuild。Sdk.Extras </a> msbuild扩展使用新的和改进的<em class="jh"> sdk风格的</em>项目格式，以最少的努力跨越目标库，并简化NuGet包的创建。</p><p id="55bb" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">然后可以使用项目的上下文菜单<a class="ae ke" href="https://docs.microsoft.com/en-us/nuget/quickstart/create-and-publish-a-package-using-visual-studio#run-the-pack-command" rel="noopener ugc nofollow" target="_blank"> Pack选项</a>创建一个可安装的NuGet包。</p><h2 id="8832" class="mt ld hu bd le mu mv mw li mx my mz lm kq na nb lq kr nc nd lu ks ne nf ly ng dt translated">导入源</h2><p id="7ab8" class="pw-post-body-paragraph jf jg hu ji b jj ma jl jm jn mb jp jq kq mc jt ju kr md jx jy ks me kb kc kd hn dt translated">导入源代码的过程有些简单。微软，在其所有的XAML版本中，保持了许多API的签名兼容。这意味着在大多数情况下，<a class="ae ke" href="https://github.com/nventive/Uno.UI.Toolkit.SL/commit/d4da7a8ff33da6c9d45bebafa8c8ca65f6182612#diff-b35234eeeb3bdb81d82b850985bf37b3L9" rel="noopener ugc nofollow" target="_blank">简单地将名称空间</a>从<code class="eh kf kg kh ki b">System.Windows</code>更改为<code class="eh kf kg kh ki b">Windows.UI</code>就能使代码与UWP兼容。</p><p id="d6cb" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">以下是一些例子:</p><ul class=""><li id="3d00" class="mf mg hu ji b jj jk jn jo kq mh kr mi ks mj kd mk ml mm mn dt translated"><code class="eh kf kg kh ki b">System.Windows.Controls</code>-&gt;-<code class="eh kf kg kh ki b">Windows.UI.Xaml.Controls</code></li><li id="01b3" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated"><code class="eh kf kg kh ki b">System.Windows.Input</code>-&gt;-<code class="eh kf kg kh ki b">Windows.Devices.Input</code></li><li id="a3bf" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated"><code class="eh kf kg kh ki b">System.Windows.Media</code>-&gt;-<code class="eh kf kg kh ki b">Windows.UI.Xaml.Media</code></li></ul><p id="693a" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">这里简化迁移的一个技巧是临时删除交叉目标项目中的所有非windows目标，只保留<code class="eh kf kg kh ki b">uap10.0</code>。这有助于将编译错误限制在UWP API中，并避免可能发生的一些API差异，包括iOS/Android/Wasm目标。一旦构建了Windows目标，添加回其他目标将允许进行特殊的调整(如果有的话)。</p><p id="546f" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">代码导入的大部分练习是关于通过逐个导入文件来大量使用智能感知，从<code class="eh kf kg kh ki b">TreeView.cs</code>开始并删除所有红色的曲线。<code class="eh kf kg kh ki b">TreeView</code>控件使用<code class="eh kf kg kh ki b">TreeViewItem</code>，后者使用<code class="eh kf kg kh ki b">HeaderedItemsControl</code>等...</p><p id="18e6" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">在第一次更改名称空间并导入相关文件之后，我们得到了一组自包含的C#源文件，但还没有编译。</p><h2 id="d6d4" class="mt ld hu bd le mu mv mw li mx my mz lm kq na nb lq kr nc nd lu ks ne nf ly ng dt translated">针对略有变化的API进行调整</h2><p id="09f4" class="pw-post-body-paragraph jf jg hu ji b jj ma jl jm jn mb jp jq kq mc jt ju kr md jx jy ks me kb kc kd hn dt translated">当试图解决从UWP迁移时的API差异时，在调整名称空间之后，第一个低悬挂点是稍微不同的那些。例如，可能是成员可见性差异，或者只是名称更新。</p><p id="dd79" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">一些例子:</p><ul class=""><li id="cbfb" class="mf mg hu ji b jj jk jn jo kq mh kr mi ks mj kd mk ml mm mn dt translated"><code class="eh kf kg kh ki b">FrameworkElement.OnApplyTemplate</code>已从<code class="eh kf kg kh ki b">public</code>移至<code class="eh kf kg kh ki b">protected</code></li><li id="a743" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated"><code class="eh kf kg kh ki b">PropertyMetadata</code>没有只包含一个<code class="eh kf kg kh ki b">PropertyChangedCallback</code>参数的构造函数</li><li id="5b35" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated"><code class="eh kf kg kh ki b">GeneralTransform.Transform</code>称为<code class="eh kf kg kh ki b">GeneralTransform.TransformPoint</code></li><li id="9969" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated"><code class="eh kf kg kh ki b">Binding</code>不包含将字符串路径作为参数的构造函数</li><li id="c349" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated"><code class="eh kf kg kh ki b">Control.Focus</code>现在需要一个<code class="eh kf kg kh ki b">FocusState</code>参数</li></ul><p id="184c" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">这些都很容易调整，UWP的运行时行为有了很大的改变，与Silverlight的相同。</p><h2 id="426f" class="mt ld hu bd le mu mv mw li mx my mz lm kq na nb lq kr nc nd lu ks ne nf ly ng dt translated">ItemsControl的情况。OnItemsChanged</h2><p id="dea8" class="pw-post-body-paragraph jf jg hu ji b jj ma jl jm jn mb jp jq kq mc jt ju kr md jx jy ks me kb kc kd hn dt translated"><code class="eh kf kg kh ki b">ItemsControl.OnItemsChanged</code>有一个显著的变化，方法不再存在了。这是控件行为的一个非常重要的部分，用于创建操纵<code class="eh kf kg kh ki b">TreeViewItem</code>实例并将它们链接到<code class="eh kf kg kh ki b">TreeView</code>实例。移除此方法的代码会使控件不可用。</p><p id="5f97" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">这个方法可以被<code class="eh kf kg kh ki b">ItemsControl.Items.VectorChanged</code>事件替代，但不能完全替代。Silverlight中的<code class="eh kf kg kh ki b">ItemsControl</code>基于提供<code class="eh kf kg kh ki b">NotifyCollectionChangedAction</code>属性的<code class="eh kf kg kh ki b">ObservableCollection</code>，而UWP中的<code class="eh kf kg kh ki b">ItemsCollection</code>基于<code class="eh kf kg kh ki b">ObservableVector</code>。这个新的实现明显没有提供<code class="eh kf kg kh ki b">Replace</code>动作，而是先提高<code class="eh kf kg kh ki b">ItemRemoved</code>再提高<code class="eh kf kg kh ki b">ItemInserted</code>。</p><p id="eed8" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">在这种情况下，我们必须删除处理<code class="eh kf kg kh ki b">NotifyCollectionChangedAction.Replace</code>的部分，只保留<code class="eh kf kg kh ki b">Remove</code>、<code class="eh kf kg kh ki b">Reset</code>和<code class="eh kf kg kh ki b">Insert</code>。新的API也不提供被通知的项目，这意味着我们必须直接使用<code class="eh kf kg kh ki b">Items</code>属性。</p><h2 id="496f" class="mt ld hu bd le mu mv mw li mx my mz lm kq na nb lq kr nc nd lu ks ne nf ly ng dt translated">暂时注释掉不兼容的功能</h2><p id="78e5" class="pw-post-body-paragraph jf jg hu ji b jj ma jl jm jn mb jp jq kq mc jt ju kr md jx jy ks me kb kc kd hn dt translated">在其他情况下，API有很大的不同，为了更好地理解代码，我们现在将把它们注释掉。其中包括键盘支持、部分鼠标支持、本地化和对等自动化相关支持。</p><p id="a1fc" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">UWP提供对这些特性的支持，不是作为虚拟方法，而是作为不直接与Silverlight实现兼容的事件。我们将在本系列的后面部分研究这些特性。</p><h2 id="9d2f" class="mt ld hu bd le mu mv mw li mx my mz lm kq na nb lq kr nc nd lu ks ne nf ly ng dt translated">调整XAML</h2><p id="9d99" class="pw-post-body-paragraph jf jg hu ji b jj ma jl jm jn mb jp jq kq mc jt ju kr md jx jy ks me kb kc kd hn dt translated">向UWP迁移的另一部分是为了适应XAML。语法是相同的，但部分不同:</p><ul class=""><li id="9ebf" class="mf mg hu ji b jj jk jn jo kq mh kr mi ks mj kd mk ml mm mn dt translated">自定义名称空间语法现在使用<code class="eh kf kg kh ki b">using:</code>而不是<code class="eh kf kg kh ki b">clr-namespace:</code>，在许多情况下，简单地用另一个替换一个就足够了</li><li id="d293" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated">与<code class="eh kf kg kh ki b">VisualStateManager</code>相关的类现在位于默认的xml名称空间中，这意味着不再需要<code class="eh kf kg kh ki b">vsm:</code>名称空间。</li><li id="29e0" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated"><code class="eh kf kg kh ki b">system</code>名称空间现在是<code class="eh kf kg kh ki b">x:</code>名称空间的一部分</li></ul><p id="4073" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">我们还将注释掉对<code class="eh kf kg kh ki b">Cursor</code>调整的支持，因为属性没有直接映射到UWP。</p><h1 id="8a2d" class="lc ld hu bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz dt translated">创建示例应用程序</h1><p id="4f91" class="pw-post-body-paragraph jf jg hu ji b jj ma jl jm jn mb jp jq kq mc jt ju kr md jx jy ks me kb kc kd hn dt translated">为了能够测试导入的代码，我们可以使用<a class="ae ke" href="https://github.com/nventive/Uno/blob/908f302660569bcc9f7065bb6fea5e9b9c62e141/doc/blog" rel="noopener ugc nofollow" target="_blank">Uno平台VS Addin </a>创建一个示例应用程序，引用我们导入的项目并添加一个简单的示例，如下所示:</p><pre class="nh ni nj nk fq nl ki nm nn aw no dt"><span id="5f69" class="mt ld hu ki b fv np nq l nr ns">&lt;controls:TreeView Margin="5"&gt;<br/>	&lt;controls:TreeViewItem Header="Controls"&gt;<br/>	&lt;controls:TreeViewItem Header="AutoCompleteBox"&gt;<br/>		&lt;controls:TreeViewItem Header="Properties" /&gt;<br/>	&lt;/controls:TreeViewItem&gt;<br/>	&lt;controls:TreeViewItem Header="Expander" /&gt;<br/>		&lt;controls:TreeViewItem Header="NumericUpDown" /&gt;<br/>	&lt;/controls:TreeViewItem&gt;<br/>	&lt;controls:TreeViewItem Header="Layout"&gt;<br/>		&lt;controls:TreeViewItem Header="DockPanel" /&gt;<br/>		&lt;controls:TreeViewItem Header="WrapPanel" /&gt;<br/>		&lt;controls:TreeViewItem Header="Viewbox" /&gt;<br/>	&lt;/controls:TreeViewItem&gt;<br/>	&lt;controls:TreeViewItem Header="Charting"&gt;<br/>		&lt;controls:TreeViewItem Header="ColumnSeries" /&gt;<br/>		&lt;controls:TreeViewItem Header="LineSeries" /&gt;<br/>		&lt;controls:TreeViewItem Header="PieSeries" /&gt;<br/>	&lt;/controls:TreeViewItem&gt;<br/>&lt;/controls:TreeView&gt;</span></pre><p id="9a32" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">并且先在Windows上测试，然后是iOS、Android和WebAssembly。</p><h1 id="3a25" class="lc ld hu bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz dt translated">后续步骤</h1><p id="1e31" class="pw-post-body-paragraph jf jg hu ji b jj ma jl jm jn mb jp jq kq mc jt ju kr md jx jy ks me kb kc kd hn dt translated">运行该示例时，有几件事很突出:</p><ul class=""><li id="3d31" class="mf mg hu ji b jj jk jn jo kq mh kr mi ks mj kd mk ml mm mn dt translated"><code class="eh kf kg kh ki b">TreeView</code>正在正确显示内容</li><li id="7dfc" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated">节点可以适当地展开和折叠</li><li id="aeb1" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated">节点旁边的图示符会改变一次状态，但不会以动画形式返回</li><li id="f5e3" class="mf mg hu ji b jj mo jn mp kq mq kr mr ks ms kd mk ml mm mn dt translated">关于在UWP已经被废弃的<code class="eh kf kg kh ki b">ItemContainerGenerator</code>有一些例外。</li></ul><p id="12d8" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju kr jw jx jy ks ka kb kc kd hn dt translated">我们将在本系列的下一部分中讨论这些内容。</p></div><div class="ab cl kj kk hc kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hn ho hp hq hr"><figure class="nh ni nj nk fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nt"><img src="../Images/329b8a3927009df234efaf210a19a1d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UeYulj197DUiNl7YlK1kzQ.png"/></div></div></figure></div></div>    
</body>
</html>