<html>
<head>
<title>erverlessFrom the trenches</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">没有战壕</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/serverless-multi-cloud-from-the-trenches-50a615ba234c?source=collection_archive---------17-----------------------#2018-08-21">https://medium.com/hackernoon/serverless-multi-cloud-from-the-trenches-50a615ba234c?source=collection_archive---------17-----------------------#2018-08-21</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><h1 id="408c" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated"><strong class="ak">无服务器多云</strong></h1><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/96c6dc0f43b69cec81511c371b5cc3c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*V4nTQFrlUH6_g5kY"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">“photo of two orange flying biplanes” by <a class="ae kf" href="https://unsplash.com/@ampalmer?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Andrew Palmer</a> on <a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="fc31" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">来自战壕系列</h1><ul class=""><li id="1350" class="kg kh hu ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated"><a class="ae kf" href="https://hackernoon.com/serverless-testing-from-the-trenches-790e77301c74" rel="noopener ugc nofollow" target="_blank">战壕中的无服务器测试</a></li><li id="6184" class="kg kh hu ki b kj ky kl kz kn la kp lb kr lc kt ku kv kw kx dt translated">来自战壕的无服务器云计算</li><li id="5dd7" class="kg kh hu ki b kj ky kl kz kn la kp lb kr lc kt ku kv kw kx dt translated"><a class="ae kf" href="https://hackernoon.com/development-flow-in-serverless-environment-from-the-trenches-d42021b7aef0" rel="noopener ugc nofollow" target="_blank">战壕中无服务器环境下的开发流程</a></li></ul><h1 id="88fa" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">正确的决定</h1><p id="2b58" class="pw-post-body-paragraph ld le hu ki b kj kk lf lg kl km lh li kn lj lk ll kp lm ln lo kr lp lq lr kt hn dt translated">我在想我是否做了一个好的选择。创建一个<a class="ae kf" href="https://hackernoon.com/tagged/serverless" rel="noopener ugc nofollow" target="_blank">无服务器</a> <a class="ae kf" href="https://hackernoon.com/tagged/architecture" rel="noopener ugc nofollow" target="_blank">架构</a>结合两个云提供商看起来很疯狂。我最担心的是两个平台之间的集成。然而，令人惊讶的是，我发现集成是容易的部分；以自动化的方式供应它们要困难得多，最终成为棘手的部分。</p><p id="ea3a" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">根据最新的<a class="ae kf" href="https://serverless.com/blog/2018-serverless-community-survey-huge-growth-usage/" rel="noopener ugc nofollow" target="_blank">无服务器框架调查，</a>超过四分之一的受访者使用两家或更多的云提供商。当我考虑使用多云环境的结果和旅程时，使用两个或更多的云提供商是有意义的。每个云提供商都有自己的优势。例如，谷歌以其人工智能和移动支持而闻名，那么为什么不使用这些功能呢？</p><blockquote class="lx ly lz"><p id="adc8" class="ld le ma ki b kj ls lf lg kl lt lh li mb lu lk ll mc lv ln lo md lw lq lr kt hn dt translated"><a class="ae kf" href="https://twitter.com/hashtag/Serverless?src=hash" rel="noopener ugc nofollow" target="_blank"/>无服务器，就其最纯粹的形式而言，意味着将任何与您的核心业务无关的事情外包给外部方，如VCS、CI、计算引擎、ML等。专注于你最擅长的事情。</p></blockquote><h1 id="56ef" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">我们的使用案例</h1><p id="063c" class="pw-post-body-paragraph ld le hu ki b kj kk lf lg kl km lh li kn lj lk ll kp lm ln lo kr lp lq lr kt hn dt translated">我们的系统由两个主要部分组成:收集数据并上传到摘要的移动客户端和摘要数据、更新移动数据库并发送推送通知的后端。</p><p id="113d" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">对于移动部分，我们选择Firebase作为我们的“工具”它提供崩溃报告(令人惊讶的Crashlytics)、分析和推送通知，我们以前有过很好的经验。因此，对我们来说，这是显而易见的。两个主要组件仍然开放，我们不知道选择什么—身份验证还是移动数据库。</p><p id="f6c4" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">本来我们选的是<a class="ae kf" href="https://auth0.com/" rel="noopener ugc nofollow" target="_blank"> Auth0 </a>。我们喜欢它天真地与<a class="ae kf" href="https://hackernoon.com/tagged/google" rel="noopener ugc nofollow" target="_blank">谷歌</a>云和<a class="ae kf" href="https://hackernoon.com/tagged/aws" rel="noopener ugc nofollow" target="_blank"> AWS </a>对话，但移动设备上的认证UI不如<a class="ae kf" href="https://github.com/firebase/FirebaseUI-Android/blob/master/auth/README.md" rel="noopener ugc nofollow" target="_blank"> Firebase提供的那个</a>，特别是通过短信登录而不需要任何短信许可的能力。对我们来说，这个选择是一个巨大的胜利。最后，我们更喜欢同一个包中的组件。此外，Firebase已经集成到我们的系统中，所以我们简单地添加了身份验证和Firestore。</p><h2 id="fff9" class="me is hu bd it mf mg mh ix mi mj mk jb kn ml mm jf kp mn mo jj kr mp mq jn mr dt translated">证明</h2><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff ms"><img src="../Images/4cbfd38def0c0fe9719fd323ddfcf3b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/1*MPLppYJznHqd4R_9nVI3eQ.png"/></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Using Lambda for authentication</figcaption></figure><ol class=""><li id="a2f0" class="kg kh hu ki b kj ls kl lt kn mt kp mu kr mv kt mw kv kw kx dt translated">一切从注册开始，我们使用基于SMS的注册。</li><li id="77aa" class="kg kh hu ki b kj ky kl kz kn la kp lb kr lc kt mw kv kw kx dt translated">如果注册成功，令牌将保存在设备的内部存储器中。</li><li id="aca2" class="kg kh hu ki b kj ky kl kz kn la kp lb kr lc kt mw kv kw kx dt translated">身份验证Lambda接收令牌作为有效负载的一部分，并对Firebase进行API调用以验证令牌。</li><li id="a84e" class="kg kh hu ki b kj ky kl kz kn la kp lb kr lc kt mw kv kw kx dt translated">如果令牌验证成功，一个<a class="ae kf" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/PresignedUrlUploadObject.html" rel="noopener ugc nofollow" target="_blank">预签名的POST URL </a>将返回给客户端。</li><li id="470e" class="kg kh hu ki b kj ky kl kz kn la kp lb kr lc kt mw kv kw kx dt translated">使用该URL，客户端能够上传收集的数据。</li></ol><p id="44a5" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">下面的要点演示了一个装饰器，您可以将它放在任何API调用中，以验证该令牌是有效的Firebase令牌。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mx my l"/></div></figure><p id="43f7" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">想了解更多关于S3的酷用法，请继续阅读</p><div class="mz na fm fo nb nc"><a href="https://hackernoon.com/s3-the-best-of-2-worlds-92576f23c000" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab ej"><div class="ne ab nf cl cj ng"><h2 class="bd hv fv z el nh eo ep ni er et ht dt translated">S3两个世界中最好的</h2><div class="nj l"><h3 class="bd b fv z el nh eo ep ni er et ek translated">S3不仅仅可以用来存储数据。查看扩展其功能的新方法。</h3></div><div class="nk l"><p class="bd b gc z el nh eo ep ni er et ek translated">hackernoon.com</p></div></div><div class="nl l"><div class="nm l nn no np nl nq jz nc"/></div></div></a></div><p id="c33c" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">我会在这里等你。</p><h2 id="9d9f" class="me is hu bd it mf mg mh ix mi mj mk jb kn ml mm jf kp mn mo jj kr mp mq jn mr dt translated"><strong class="ak">更新移动数据库</strong></h2><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff nr"><img src="../Images/ec3e115ecbde0befeb77e8be59000580.png" data-original-src="https://miro.medium.com/v2/resize:fit:1050/format:webp/1*SsOBaS60Pux1ijDPPxW1rA.png"/></div></figure><p id="3966" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">以前，mobile DB(简称MD)被认为是任何值得尊敬的BaaS(后端即服务)平台的主干，它允许任何移动设备将信息保存在云中，通常是NoSql数据库。当移动到无服务器时，一个主要的模式转变是移动到更丰富的客户端，例如，客户端在他们那边做更多的事情，而不是简单的表示层。我们的MD Firestore保存了后端执行的数据消化和每个设备配置的摘要。</p><p id="6811" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">在我们的例子中，S3充当一个队列。您只需在bucket中放入一条消息，其中包含相关的设备ID、您希望作为json文档写入的数据片段以及Firestore中的路径。Lambda函数获取消息，然后写入或更新Firestore中的相关字段。</p><p id="477c" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">对于不熟悉Firestore的人来说，Firestore可能包含一个文档或文档集合，每个文档可能包含另一个文档集合。这种结构允许您构建复杂的层次结构。在我们的例子中，在Firestore的根目录下，我们保存了一个名为<code class="eh ns nt nu nv b">users</code>的集合，每个用户都由一个惟一的ID标识，这个ID又暗示了文档名。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff nw"><img src="../Images/a82b24a269073cfef61a93d28708fa24.png" data-original-src="https://miro.medium.com/v2/resize:fit:910/format:webp/1*545__780PKA1uAIYfrQsCA.png"/></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Firestore hierarchy</figcaption></figure><p id="cc96" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">该过程的一个关键部分是访问权限。您不希望系统中的所有设备都访问彼此的内容。我们使用一个共享的设备标识符，它是在设备第一次成功注册时创建的；请注意，设备标识符不是用于身份验证的令牌。允许每个设备访问其设备标识符下的任何文档或集合。Firestore将该标识符作为其权限规则的一部分公开，因此您可以使用类似下面的要点来允许每设备读取。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mx my l"/></div></figure><h1 id="f8ea" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">部署</h1><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nx"><img src="../Images/c3b25deb31c9f63c837a9873ec6f9071.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2NXmKiNDJpTNfl1m"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">This Is Tough by <a class="ae kf" href="https://unsplash.com/@vegasphotog?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Robert Baker</a> on <a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="6fcc" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">众所周知，当从一个简单的单一云功能转移到多个云功能时，无服务器的世界非常困难。现在，再加入一家云提供商，事情就变得非常棘手了。我们的要求非常简单:允许每个开发人员在真正的云环境中部署完整的产品。</p><div class="mz na fm fo nb nc"><a href="https://hackernoon.com/serverless-testing-from-the-trenches-790e77301c74" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab ej"><div class="ne ab nf cl cj ng"><h2 class="bd hv fv z el nh eo ep ni er et ht dt translated">战壕中的无服务器测试</h2><div class="nj l"><h3 class="bd b fv z el nh eo ep ni er et ek translated">无服务器测试范例快速概述</h3></div><div class="nk l"><p class="bd b gc z el nh eo ep ni er et ek translated">hackernoon.com</p></div></div><div class="nl l"><div class="ny l nn no np nl nq jz nc"/></div></div></a></div><p id="d93e" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">我们的流程分为四个部分:</p><ul class=""><li id="38ff" class="kg kh hu ki b kj ls kl lt kn mt kp mu kr mv kt ku kv kw kx dt translated">为AWS和Firebase中的每个开发人员创建帐户。</li><li id="9ee7" class="kg kh hu ki b kj ky kl kz kn la kp lb kr lc kt ku kv kw kx dt translated">在AWS和Firebase上提供资源。</li><li id="0f2e" class="kg kh hu ki b kj ky kl kz kn la kp lb kr lc kt ku kv kw kx dt translated">推送代码更改。</li><li id="5658" class="kg kh hu ki b kj ky kl kz kn la kp lb kr lc kt ku kv kw kx dt translated">更新Firestore规则。</li></ul><p id="b53d" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">我将跳过任何与AWS相关的内容，专注于Firebase。</p><p id="183a" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">目前，Firebase的最大问题是无法自动创建和供应资源。未来情况可能会有所变化，但现在，这一过程是手动的:</p><ul class=""><li id="19bf" class="kg kh hu ki b kj ls kl lt kn mt kp mu kr mv kt ku kv kw kx dt translated">转到<a class="ae kf" href="https://firebase.google.com/`" rel="noopener ugc nofollow" target="_blank">https://firebase.google.com/</a>并点击登录。</li><li id="25d2" class="kg kh hu ki b kj ky kl kz kn la kp lb kr lc kt ku kv kw kx dt translated">添加新项目。</li><li id="4f71" class="kg kh hu ki b kj ky kl kz kn la kp lb kr lc kt ku kv kw kx dt translated">点击<a class="ae kf" href="https://user-images.githubusercontent.com/33550454/37566168-d4ceb7b4-2abd-11e8-8cad-38dc09e40c45.png" rel="noopener ugc nofollow" target="_blank">小齿轮</a>并选择<code class="eh ns nt nu nv b">project settings</code>然后选择<code class="eh ns nt nu nv b">SERVICE ACCOUNTS</code></li><li id="6f70" class="kg kh hu ki b kj ky kl kz kn la kp lb kr lc kt ku kv kw kx dt translated">选择<code class="eh ns nt nu nv b">Firebase Admin SDK</code>并下载私钥。后端将使用该密钥对Firebase进行身份验证。</li><li id="7fcf" class="kg kh hu ki b kj ky kl kz kn la kp lb kr lc kt ku kv kw kx dt translated">接下来是数据库配置。进入左边面板的数据库，选择<code class="eh ns nt nu nv b">Create database</code>。选择<code class="eh ns nt nu nv b">Start in lock mode</code>，我们稍后会更新规则。</li></ul><p id="9b87" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">完成后，安装<a class="ae kf" href="https://firebase.google.com/docs/cli/" rel="noopener ugc nofollow" target="_blank"> Firebase CLI </a>和<strong class="ki hv">确保登录</strong></p><h2 id="71f3" class="me is hu bd it mf mg mh ix mi mj mk jb kn ml mm jf kp mn mo jj kr mp mq jn mr dt translated">更新Firestore规则</h2><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mx my l"/></div></figure><p id="db5c" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">对于那些已经忘记的人来说，规则是用来限制访问的。移动设备只能访问属于自己的文档。更新规则脚本以两种模式运行。第一个使每个开发人员能够手动更新他们自己的环境。他们只需提供应用程序名称。第二个由CI环境使用，其中提供了一个特殊的身份验证令牌来完成完全相同的任务。</p><h1 id="354d" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">鳍状物</h1><p id="8f95" class="pw-post-body-paragraph ld le hu ki b kj kk lf lg kl km lh li kn lj lk ll kp lm ln lo kr lp lq lr kt hn dt translated">作为一名开发人员，多个云提供商为您提供了最好的一切，让您能够选择最适合您工作的无服务器解决方案。现在，整个过程中的致命弱点是以无缝方式创建开发环境的能力。这是一个工具的问题，我相信随着时间的推移会有所改善。</p><p id="2ab2" class="pw-post-body-paragraph ld le hu ki b kj ls lf lg kl lt lh li kn lu lk ll kp lv ln lo kr lw lq lr kt hn dt translated">让我们听一听您在多云计算环境中的更多体验。与我们分享。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="nz my l"/></div></figure></div></div>    
</body>
</html>