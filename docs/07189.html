<html>
<head>
<title>Airflow, Meta Data Engineering, and a Data Platform for the World’s Largest Democracy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">世界上最大的民主国家的气流、元数据工程和数据平台</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/airflow-meta-data-engineering-and-a-data-platform-for-the-worlds-largest-democracy-3b49a3efd5e8?source=collection_archive---------1-----------------------#2018-08-25">https://medium.com/hackernoon/airflow-meta-data-engineering-and-a-data-platform-for-the-worlds-largest-democracy-3b49a3efd5e8?source=collection_archive---------1-----------------------#2018-08-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><blockquote class="ir is it"><p id="96b9" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">我最初为<a class="ae jt" href="https://blog.socialcops.com/technology/engineering/airflow-meta-data-engineering-disha/" rel="noopener ugc nofollow" target="_blank"> SocialCops工程博客</a>写了这篇文章。</p></blockquote><figure class="jv jw jx jy fq jz fe ff paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="fe ff ju"><img src="../Images/68eb229c8c5eb6ad3ad55115ecf0438c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0uIC1_An9TbTrK_o6VBwGg.jpeg"/></div></div><figcaption class="kg kh fg fe ff ki kj bd b be z ek">Photo by <a class="ae jt" href="https://unsplash.com/photos/a9KHeyRyFJU?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">arihant daga</a> on <a class="ae jt" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="d5e2" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">在我们<a class="ae jt" href="https://blog.socialcops.com/technology/data-science/apache-airflow-disease-outbreaks-india/" rel="noopener ugc nofollow" target="_blank">关于Apache Airflow </a>的上一篇文章中，我们提到了它是如何席卷数据工程生态系统的。我们还讨论了如何使用它在我们的内部系统之间移动数据，并解释了我们创建内部工作流的步骤。ETL工作流(e)从网站提取pdf，(t)将它们转换为CSV，以及(l)将CSV加载到商店。我们还简要介绍了使用Airflow平台可以解决的ETL用例的范围。</p><p id="195a" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">在本帖中，我们将讨论Airflow的“动态”原则之一如何提供<a class="ae jt" href="https://confluence.atlassian.com/bamboo/what-is-configuration-as-code-894743909.html" rel="noopener ugc nofollow" target="_blank">配置代码</a>作为自动化工作流生成的强大构造。我们还将讨论这如何帮助我们使用气流为DISHA供电，DISHA是一个国家数据平台，印度<a class="ae jt" href="https://en.wikipedia.org/wiki/Member_of_Parliament,_Lok_Sabha" rel="noopener ugc nofollow" target="_blank">国会议员</a>和<a class="ae jt" href="https://en.wikipedia.org/wiki/Member_of_the_Legislative_Assembly_(India)" rel="noopener ugc nofollow" target="_blank">国会议员</a>在这里监控42个国家级计划的进展。最后，我们将简要讨论我们对当今公共数据技术项目的一些思考。</p><h1 id="29e4" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">为什么是气流？</h1><p id="49a9" class="pw-post-body-paragraph iu iv hu ix b iy ll ja jb jc lm je jf kk ln ji jj kl lo jm jn km lp jq jr js hn dt translated">回顾一下<a class="ae jt" href="https://blog.socialcops.com/technology/data-science/apache-airflow-disease-outbreaks-india/" rel="noopener ugc nofollow" target="_blank">之前的帖子</a>，Airflow是由Airbnb的Maxime Beauchemin创建的工作流管理平台。一年多来，我们一直使用Airflow在生产中设置批处理数据工作流，在此期间，我们发现以下几点非常有用，其中一些也是其核心原则。</p><ul class=""><li id="57c7" class="lq lr hu ix b iy iz jc jd kk ls kl lt km lu js lv lw lx ly dt translated"><strong class="ix hv">动态</strong>:工作流可以定义为Python文件(DAG文件)中的<a class="ae jt" href="https://en.wikipedia.org/wiki/Directed_acyclic_graph" rel="noopener ugc nofollow" target="_blank">有向无环图</a> (DAG)，使得复杂工作流的动态生成成为可能。</li></ul><figure class="jv jw jx jy fq jz fe ff paragraph-image"><div class="fe ff lz"><img src="../Images/efba80127db7adc76a1729495a829969.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*B5KZ7SlkP7bYyPWXknlphw.png"/></div><figcaption class="kg kh fg fe ff ki kj bd b be z ek">An <a class="ae jt" href="https://airflow.apache.org/concepts.html" rel="noopener ugc nofollow" target="_blank">Airflow DAG</a></figcaption></figure><ul class=""><li id="8fde" class="lq lr hu ix b iy iz jc jd kk ls kl lt km lu js lv lw lx ly dt translated"><strong class="ix hv">可扩展</strong>:有很多开箱即用的操作符！操作符是工作流的组成部分，每个操作符执行特定的功能。例如，PythonOperator允许您使用Python定义工作流中每个任务内部运行的逻辑！</li><li id="809c" class="lq lr hu ix b iy ma jc mb kk mc kl md km me js lv lw lx ly dt translated"><strong class="ix hv">可伸缩</strong>:您的工作流中的任务可以由多个Celery workers使用CeleryExecutor并行执行。</li><li id="ac68" class="lq lr hu ix b iy ma jc mb kk mc kl md km me js lv lw lx ly dt translated"><strong class="ix hv">开源</strong>:该项目正在Apache软件基金会孵化，并被积极维护。它还有一个活动的<a class="ae jt" href="https://gitter.im/apache/incubator-airflow" rel="noopener ugc nofollow" target="_blank"> Gitter room </a>。</li></ul><p id="511d" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">此外，Airflow还附带了一个web界面，为您提供工作流执行所需的所有上下文，包括每个任务的状态(运行、成功、失败等)。)到任务生成的日志！</p><h1 id="e350" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">静态代码的问题是</h1><p id="aa2d" class="pw-post-body-paragraph iu iv hu ix b iy ll ja jb jc lm je jf kk ln ji jj kl lo jm jn km lp jq jr js hn dt translated">在SocialCops，我们已经观察到了一个使用web服务从各种系统中提取数据的重复用例，作为我们ETL工作流的一个组成部分。推进这项任务的方法之一是编写Python代码，可以使用PythonOperator将数据集成到工作流中。让我们看一个非常基本的DAG文件来说明这一点。</p><figure class="jv jw jx jy fq jz"><div class="bz el l di"><div class="mf mg l"/></div></figure><p id="7c4c" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">正如您所看到的，<code class="eh mh mi mj mk b">PythonOperator</code>可以通过使用<code class="eh mh mi mj mk b">python_callable</code>关键字参数指定包含您的Python代码的函数的名称来实例化。然后可以使用Airflow API的<code class="eh mh mi mj mk b">set_downstream</code>和<code class="eh mh mi mj mk b">set_upstream</code>方法链接多个实例化的操作符。</p><p id="78e6" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">在上面的DAG文件中，<code class="eh mh mi mj mk b">extract</code>函数用一个查询参数向<a class="ae jt" href="http://httpbin.org/" rel="noopener ugc nofollow" target="_blank">httpbin.org</a>发出一个GET请求。Web服务在请求限制(如果它们同时支持多个请求)、查询参数、响应格式等方面可能有所不同。因为为每个web服务编写定制的Python代码对于任何维护代码的人来说都是一场噩梦，所以我们决定构建一个Python库(我们称之为magon，因为它是数据的磁石)，它接受描述特定web服务的JSON配置作为输入，并使用一组预定义的查询获取数据。但是这仅仅解决了我们问题的一半。</p><p id="b128" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">在我们的<a class="ae jt" href="https://blog.socialcops.com/technology/data-science/apache-airflow-disease-outbreaks-india/" rel="noopener ugc nofollow" target="_blank">上一篇文章</a>和上面的DAG文件示例中，我们可以通过编写对<code class="eh mh mi mj mk b">set_downstream</code>和<code class="eh mh mi mj mk b">set_upstream</code>方法的静态调用来将操作符链接在一起，因为工作流非常基本。但是想象一下定义了1000个操作符的DAG文件的可读性。你必须是一个专家才能推断出运算符之间的关系。此外，团队中的每个人(包括不以Python为主要语言的人)都不知道如何编写DAG文件，手动编写它们会重复且低效。</p><h1 id="3493" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">元数据工程</h1><p id="c187" class="pw-post-body-paragraph iu iv hu ix b iy ll ja jb jc lm je jf kk ln ji jj kl lo jm jn km lp jq jr js hn dt translated">在他的演讲“<a class="ae jt" href="https://www.youtube.com/watch?v=23_1WlxGGM4" rel="noopener ugc nofollow" target="_blank">用Apache Airflow </a>推进数据工程模式”中，Airflow的作者Maxime Beauchemin解释了数据工程师应该如何在他们的工作中找到共同的模式(动态构建工作流的方法)，并围绕它们构建框架和服务。他给出了一些这种模式的例子，其中之一就是AutoDAG。这是Airbnb内部开发的一个Airflow插件，用于自动创建DAG，允许只需要运行预定的SQL查询(而不想创建工作流)的用户在web界面上创建查询。</p><p id="8aa6" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">寻找模式包括识别工作流的构建块，并基于静态配置将它们链接起来。查看我们在上一节中展示的DAG文件，并尝试识别构造块。它只有三个组件，可以模拟成一个<a class="ae jt" href="https://en.wikipedia.org/wiki/YAML" rel="noopener ugc nofollow" target="_blank"> YAML </a>配置。</p><figure class="jv jw jx jy fq jz"><div class="bz el l di"><div class="mf mg l"/></div></figure><p id="e7de" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">这是一个很基本的例子。更详细的话，你应该看看<a class="ae jt" href="http://docs.pachyderm.io/en/latest/reference/pipeline_spec.html" rel="noopener ugc nofollow" target="_blank"> Pachyderm </a>和<a class="ae jt" href="http://docs.digdag.io/workflow_definition.html" rel="noopener ugc nofollow" target="_blank"> Digdag </a>是如何建模他们的工作流规范的，他们使用这些规范来动态生成工作流。</p><p id="2b1f" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">这使得我们现在可以轻松地编写一个<em class="iw">单个</em> DAG文件，该文件可以接受一堆YAML配置，并通过链接具有相同标识符的操作符来动态构建DAG(在本例中，为了简单起见，我们使用了数字1)。此外，团队中任何想要创建工作流的人都可以编写一个YAML，这使得人们可以很容易地定义机器可读的配置。一旦您找到了一种基于配置创建DAG的方法，您就可以构建一个界面，让用户无需编写配置就可以构建DAG，这让任何希望创建工作流的人都很容易！</p><figure class="jv jw jx jy fq jz"><div class="bz el l di"><div class="mf mg l"/></div></figure><p id="8e28" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">对于DISHA，我们需要通过web服务从源系统中提取方案数据，然后使用T和l进行跟踪。在原子级别上，我们的工作流可以分为:</p><ul class=""><li id="e46e" class="lq lr hu ix b iy iz jc jd kk ls kl lt km lu js lv lw lx ly dt translated">PythonOperator，通过使用Magneton(我们开发的Python库)从源系统中提取数据。</li><li id="09f9" class="lq lr hu ix b iy ma jc mb kk mc kl md km me js lv lw lx ly dt translated">BashOperator对提取的数据运行基于R或Python(T)的转换，如清理、整形和标准化跨数据集的地理。</li><li id="66d1" class="lq lr hu ix b iy ma jc mb kk mc kl md km me js lv lw lx ly dt translated">PythonOperator将转换后的数据加载到我们的数据仓库中，<a class="ae jt" href="https://socialcops.com/visualize/" rel="noopener ugc nofollow" target="_blank"> Visualize </a>可以在数据仓库中运行分析查询。</li><li id="7d14" class="lq lr hu ix b iy ma jc mb kk mc kl md km me js lv lw lx ly dt translated">此外，我们使用PythonOperator添加了松弛时间和电子邮件提醒。</li></ul><p id="2f2d" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">识别这种模式让我们能够自动创建DAG。使用web界面，任何人现在都可以添加上述三个基本任务所需的配置。这有助于我们在我们的小团队中分配建立工作流的工作，他们中的大多数人只习惯于使用R。很快，每个人都在编写R脚本并构建复杂的工作流，如下图所示。</p><figure class="jv jw jx jy fq jz fe ff paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="fe ff ml"><img src="../Images/f3eab6a2b29a5ddb664540bfc9210c8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I2321H2U0PLzWECh3UdYgA.jpeg"/></div></div></figure><p id="a298" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">Airflow web界面使项目利益相关者可以轻松管理复杂的工作流(如上所示)，因为他们可以检查工作流的状态并准确定位失败的步骤，查看失败任务的日志，解决问题，然后通过重试失败的任务来恢复工作流。让任务<a class="ae jt" href="https://en.wikipedia.org/wiki/Idempotence" rel="noopener ugc nofollow" target="_blank">幂等</a>是处理重试的好方法。(注意:重试也可以在Airflow中自动进行。)</p><h1 id="db0a" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">迪沙概述</h1><blockquote class="ir is it"><p id="473e" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">“迪沙是迈向良好治理的关键一步，通过它我们将能够集中监控一切。这将使我们能够有效地监控这个国家的每一个村庄。— 印度总理纳伦德拉·莫迪</p></blockquote><p id="e3f9" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">地区发展协调和监测委员会于2016年成立<a class="ae jt" href="http://pib.nic.in/newsite/mbErel.aspx?relid=147922" rel="noopener ugc nofollow" target="_blank">。目标是在中央、邦和地方行政委员会政府之间进行协调，以便成功和及时地实施关键计划(如国家农村生计任务、Pradhan Mantri Awaas Yojana和Swachh Bharat任务)。为了监控方案并做出数据驱动的实施决策，利益相关者需要获得关于方案的有意义的见解。这需要集成包含方案数据的不同系统。</a></p><p id="01da" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">去年，我们与农村发展部(MoRD)和国家信息中心(NIC)合作创建了DISHA dashboard，由总理于10月份在T2启动。DISHA仪表板帮助议员、立法议会议员和地区官员跟踪不同中央部委在其各自地区和选区的旗舰计划的执行情况。</p><figure class="jv jw jx jy fq jz"><div class="bz el l di"><div class="mm mg l"/></div></figure><p id="364a" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">早在2017年10月，仪表板就有6个方案的数据，并于2018年8月更新，以显示总共22个方案的数据。在其最后阶段，仪表板将统一来自42个旗舰计划的数据，以帮助利益相关者找到生命、宇宙和一切的答案。来自20个部委的数据将第一次打破各自为政的局面，汇集到一个地方，为超过20亿卢比的政府预算带来问责。20万卢比！</p><p id="86bc" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">DISHA会议每季度在<a class="ae jt" href="http://pib.nic.in/newsite/mbErel.aspx?relid=147922" rel="noopener ugc nofollow" target="_blank">举行一次，委员会成员在会上确保所有计划都按照指导方针执行，调查执行过程中的违规行为，并密切审查分配资金的流向。如上所示的工作流已经自动地将数据从方案数据库流向DISHA仪表板，用方案的最新数据定期更新仪表板。这对委员会成员很有用，因为他们可以通过检查每个方案的性能并确定优先事项和差距领域来计划会议议程。</a></p><p id="bb01" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated"><em class="iw">观看总理讲述他如何使用迪沙仪表板监控普拉丹·曼特里·阿瓦斯·约纳</em> <a class="ae jt" href="https://blog.socialcops.com/inside-sc/announcements/pm-narendra-modi-monitoring-pmay-disha-dashboard/" rel="noopener ugc nofollow" target="_blank"> <em class="iw">这里</em> </a> <em class="iw">。</em></p><h1 id="22b8" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">走向更好的公共技术</h1><p id="7560" class="pw-post-body-paragraph iu iv hu ix b iy ll ja jb jc lm je jf kk ln ji jj kl lo jm jn km lp jq jr js hn dt translated">数据提取是一个更大的难题的一部分，叫做<a class="ae jt" href="https://en.wikipedia.org/wiki/Data_integration" rel="noopener ugc nofollow" target="_blank">数据整合</a>(从不同的系统，以你想要的方式获得你想要的数据到一个单一的地方)，人们从20世纪80年代早期<a class="ae jt" href="https://dl.acm.org/citation.cfm?id=1500483" rel="noopener ugc nofollow" target="_blank">开始就一直在研究这个问题</a>。由于系统是异构的，集成不同的数据系统可能相当复杂；这意味着它们可以在实现方式、数据存储方式以及与其他系统的交互方式上有所不同，从而形成信息孤岛。</p><p id="ea39" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">为了成功地从另一个系统中提取数据，交易双方首先需要就如何共享数据的模式达成一致。正如我们发现的，考虑到不同数据系统的异构性，这可能是项目中最耗时的部分。尽管到目前为止，我们已经成功地将22个数据源集成在一起，但是如果有一个在所有部门之间存储和共享数据的标准，我们花费在获取正确格式的数据以及每个方案所需的变量上的时间就会节省下来。</p><p id="b57f" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">在他的文章“<a class="ae jt" rel="noopener" href="/a-r-g-o/bringing-wall-street-technology-to-bear-on-public-service-delivery-26f8d794c1d5">让华尔街和美国军队承担公共服务交付</a>”中，ARGO实验室<a class="ae jt" href="http://www.argolabs.org/" rel="noopener ugc nofollow" target="_blank">的Varun Adibhatla</a>谈到了“信息交换协议”。他称之为行话，能够在相当大的范围内共享标准化数据或说一种通用语言。他在这里进一步解释说，在20世纪90年代，华尔街的金融机构聚集在一起，同意用一种通用的交易语言进行交流。这导致了FIX协议的产生，它允许他们快速共享数据。他提到，像FIX协议这样的数据标准并不是华尔街独有的，而是存在于贸易和商业的几乎每个领域。</p><blockquote class="ir is it"><p id="9bc8" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><strong class="ix hv">“一个由以目的为导向的公共技术专家组成的小团队，利用低成本设备、数据和决策方面的进步以及适当的支持，就可以构建和维护公共的数字基础设施。”— </strong> Varun Adibhatla在<a class="ae jt" rel="noopener" href="/a-r-g-o/bringing-wall-street-technology-to-bear-on-public-service-delivery-26f8d794c1d5">“让华尔街和美国军队承担公共服务的交付。”</a></p></blockquote><p id="97ee" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kk jh ji jj kl jl jm jn km jp jq jr js hn dt translated">随着我们向数字印度迈进，我们需要从根本上改变追求卓越的思维模式和当今公共技术的设置方式。我们需要一个跨越公共服务的标准化数据基础设施，帮助各部委和部门快速相互共享数据，并与公众共享数据。需要培训和雇佣具有硅谷级别技术才能的新一代公务员。印度央行已经有了一名政府首席经济顾问和一名首席财务官。是时候为印度任命一位首席数据官了！</p></div></div>    
</body>
</html>