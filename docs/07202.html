<html>
<head>
<title>Encoding AV1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编码AV1</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/encoding-av1-700b6ee4210?source=collection_archive---------5-----------------------#2018-08-26">https://medium.com/hackernoon/encoding-av1-700b6ee4210?source=collection_archive---------5-----------------------#2018-08-26</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/8703b67b3b9b03396e6aa5b0bb9f3867.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*283_CWzq00o0uWPgYu0E_Q.png"/></div></div></figure><p id="3bc1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ka">本文介绍了两款支持AV1的工具，以及AV1格式背后的一些技术细节及其在ffmpeg中的支持。</em></p></div><div class="ab cl kb kc hc kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hn ho hp hq hr"><p id="2a65" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我很高兴地宣布，我的两个WebM转换器，<a class="ae ki" href="https://github.com/Kagami/webm.py" rel="noopener ugc nofollow" target="_blank"> webm.py </a>(命令行)和<a class="ae ki" href="https://github.com/Kagami/boram" rel="noopener ugc nofollow" target="_blank"> boram </a>(图形)现在支持编码到新的AV1视频格式，相应地从版本0.12.0和0.5.0开始。他们都在所有三个主要平台(Windows，macOS，Linux)上工作，并且涵盖了视频点播编码的典型用例。</p><h2 id="c226" class="kj kk hu bd kl km kn ko kp kq kr ks kt jn ku kv kw jr kx ky kz jv la lb lc ld dt translated">AV1</h2><p id="5c4f" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">如果你还没有听说过，AV1是一种免版税的现代视频编码格式，旨在提供比受专利保护的H.265 (HEVC)更好的质量。它是由谷歌、Mozilla和网飞等大型It公司合作开发的，名为<a class="ae ki" href="https://aomedia.org" rel="noopener ugc nofollow" target="_blank"> AOMedia </a>，于今年3月首次稳定发布。</p><p id="dd3d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以在本文<a class="ae ki" href="https://jmvalin.ca/papers/AV1_tools.pdf" rel="noopener ugc nofollow" target="_blank">中了解AV1中使用的技术</a>，这里提供了与竞争解决方案的一些测试比较<a class="ae ki" href="https://aomedia.org/news/av1-test-results/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="da76" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">AV1的压缩效率和计划的硬件支持看起来棒极了，它应该真的有利于添加到任何现代转换器。所以我继续前进，并立即在我的工具中实现支持，尽管它仍然是一项前沿技术。</p><h2 id="87a9" class="kj kk hu bd kl km kn ko kp kq kr ks kt jn ku kv kw jr kx ky kz jv la lb lc ld dt translated">工具</h2><p id="4abd" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">第一个工具webm.py是用Python编写的，它为ffmpeg提供了简单的包装和有用的默认值。例如，如果您想要达到特定的目标文件大小，您不必处理两次运行命令进行二次编码或手动计算比特率。webm.py会帮你做到。</p><p id="5c82" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">webm.py的另一个优点是，它可以在Python 2和3中工作(Python 2通常是今天安装在计算机上的唯一Python)，除了在<code class="eh lj lk ll lm b">PATH</code>中的ffmpeg可执行文件和包含在单个源文件中之外，没有任何依赖关系。因此，只需将该文件放在您想要的任何机器上，就可以立即开始使用。</p><p id="1dba" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是，如果您有可用的pip，通过运行</p><pre class="ln lo lp lq fq lr lm ls lt aw lu dt"><span id="9ff3" class="kj kk hu lm b fv lv lw l lx ly">pip install webm</span></pre><p id="82d7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您将安装最新的稳定版本以及方便的<code class="eh lj lk ll lm b">webm </code>命令。(确保选中Python for Windows installer中的<code class="eh lj lk ll lm b">Add to PATH</code>选项。)</p><p id="dcf6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">webm.py提供了命令行界面，因此它主要用于批量编码或在服务器上使用。然而，它也有互动模式的剪切和作物使用脚本化的mpv播放器。要编码AV1视频，只需运行</p><pre class="ln lo lp lq fq lr lm ls lt aw lu dt"><span id="4737" class="kj kk hu lm b fv lv lw l lx ly">webm -i in.mkv -av1</span></pre><figure class="ln lo lp lq fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lz"><img src="../Images/b3a5701bf4a158e2c243fe4a881e6719.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wh-wcYhJt3_ykEwLTTptrw.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">webm.py</figcaption></figure><p id="a43d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它将使用默认质量的两遍模式。要查看所有可用选项的运行情况</p><pre class="ln lo lp lq fq lr lm ls lt aw lu dt"><span id="bc92" class="kj kk hu lm b fv lv lw l lx ly">webm --help</span></pre><p id="daa7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请注意，您需要来自git的ffmpeg，并在您的<code class="eh lj lk ll lm b">PATH</code>中支持AV1以使其工作。此外，需要的补丁很少(稍后会详细介绍)，所以我建议您从Windows和macOS上的<a class="ae ki" href="https://github.com/Kagami/boram/releases" rel="noopener ugc nofollow" target="_blank"> boram版本</a>中获取ffmpeg二进制文件(它们位于解压缩的归档文件的<code class="eh lj lk ll lm b">resources/app</code>子目录中),并从Linux上的源代码进行编译。</p></div><div class="ab cl kb kc hc kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hn ho hp hq hr"><p id="8759" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">第二个工具boram为编码提供了用户友好的图形界面，并支持基本的编辑选项，如缩放、裁剪、去交错等。它还包装了ffmpeg，并使用电子框架用JavaScript编写。</p><blockquote class="me mf mg"><p id="92b5" class="jc jd ka je b jf jg jh ji jj jk jl jm mh jo jp jq mi js jt ju mj jw jx jy jz hn dt translated">如果你感兴趣的话，可以看看Electron的<a class="ae ki" href="https://github.com/Kagami/mpv.js" rel="noopener ugc nofollow" target="_blank"> mpv.js </a>组件，它允许boram打开任何视频格式，不限于Chrome支持的格式。</p></blockquote><p id="b0b4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在此下载您平台的最新版本<a class="ae ki" href="https://github.com/Kagami/boram/releases" rel="noopener ugc nofollow" target="_blank">，解压并运行。界面和控制应该是不言自明的，只要确保在编解码器标签选择AV1编解码器。</a></p><figure class="ln lo lp lq fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mk"><img src="../Images/e8da247618b4b09b617de23153438796.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Xwi6Omt8X_QMVtPOtLRAA.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">boram</figcaption></figure><h2 id="7dd3" class="kj kk hu bd kl km kn ko kp kq kr ks kt jn ku kv kw jr kx ky kz jv la lb lc ld dt translated">玩家支持</h2><p id="fb6a" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">WebM格式传统上是针对Web平台的，那么有哪些浏览器可以播放呢？根据caniuse网站的消息，AV1在最新的火狐每夜的<code class="eh lj lk ll lm b">media.av1.enabled</code>旗帜下得到支持，并且在Chrome 69+中开箱即用。不幸的是还没有在Edge和Safari中。不多，但足够在野外玩了。</p><p id="54cd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在桌面播放器中，至少VLC和Windows版mpv支持AV1格式的视频。</p><h2 id="0f1b" class="kj kk hu bd kl km kn ko kp kq kr ks kt jn ku kv kw jr kx ky kz jv la lb lc ld dt translated">FFmpeg补丁</h2><p id="b950" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">如前所述，转换器包装ffmpeg可执行文件，因为它是视频处理和编码的强大框架。然而，由于这种格式的新颖性，ffmpeg现在还不太支持AV1。所以我不得不为它写几个补丁。</p><p id="fefb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">第一个是利用编码并行性。AV1的参考编码器被称为<a class="ae ki" href="https://aomedia.googlesource.com/aom" rel="noopener ugc nofollow" target="_blank"> libaom </a>，需要注意的是，它基本上是基于libvpx代码，VP8和VP9格式的参考编码器。libvpx目前为VP9提供了两种多线程编码机制:<code class="eh lj lk ll lm b">-tile-columns</code>和<code class="eh lj lk ll lm b">-row-mt</code>。</p><p id="80bf" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh lj lk ll lm b">-tile-columns</code>基本上是将您的视频划分为独立的编码单元——瓦片——并在不同的内核上同时处理它们，以利用多核CPU。</p><figure class="ln lo lp lq fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ml"><img src="../Images/2f47bbf39e3fa60932c269ddc618ccda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zcCVSriT0PQma9e6-xJw7A.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">tile-columns schematic</figcaption></figure><p id="bed3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">ffmpeg还不支持AV1的<code class="eh lj lk ll lm b">-tile-columns</code>,但是补丁是微不足道的:</p><pre class="ln lo lp lq fq lr lm ls lt aw lu dt"><span id="7cee" class="kj kk hu lm b fv lv lw l lx ly">diff --git a/libavcodec/libaomenc.c b/libavcodec/libaomenc.c<br/>index 9431179886..55cb7ff72e 100644<br/>--- a/libavcodec/libaomenc.c<br/>+++ b/libavcodec/libaomenc.c<br/>@@ -68,6 +68,8 @@ typedef struct AOMEncoderContext {<br/>     int static_thresh;<br/>     int drop_threshold;<br/>     int noise_sensitivity;<br/>+    int tile_columns;<br/>+    int tile_rows;<br/> } AOMContext;<br/> <br/> static const char *const ctlidstr[] = {<br/>@@ -75,6 +77,8 @@ static const char *const ctlidstr[] = {<br/>     [AOME_SET_CQ_LEVEL]         = "AOME_SET_CQ_LEVEL",<br/>     [AOME_SET_ENABLEAUTOALTREF] = "AOME_SET_ENABLEAUTOALTREF",<br/>     [AOME_SET_STATIC_THRESHOLD] = "AOME_SET_STATIC_THRESHOLD",<br/>+    [AV1E_SET_TILE_COLUMNS]     = "AV1E_SET_TILE_COLUMNS",<br/>+    [AV1E_SET_TILE_ROWS]        = "AV1E_SET_TILE_ROWS",<br/>     [AV1E_SET_COLOR_RANGE]      = "AV1E_SET_COLOR_RANGE",<br/>     [AV1E_SET_COLOR_PRIMARIES]  = "AV1E_SET_COLOR_PRIMARIES",<br/>     [AV1E_SET_MATRIX_COEFFICIENTS] = "AV1E_SET_MATRIX_COEFFICIENTS",<br/>@@ -449,6 +453,11 @@ static av_cold int aom_init(AVCodecContext *avctx,<br/>     if (ctx-&gt;crf &gt;= 0)<br/>         codecctl_int(avctx, AOME_SET_CQ_LEVEL,          ctx-&gt;crf);<br/> <br/>+    if (ctx-&gt;tile_columns &gt;= 0)<br/>+        codecctl_int(avctx, AV1E_SET_TILE_COLUMNS, ctx-&gt;tile_columns);<br/>+    if (ctx-&gt;tile_rows &gt;= 0)<br/>+        codecctl_int(avctx, AV1E_SET_TILE_ROWS, ctx-&gt;tile_rows);<br/>+<br/>     codecctl_int(avctx, AV1E_SET_COLOR_PRIMARIES, avctx-&gt;color_primaries);<br/>     codecctl_int(avctx, AV1E_SET_MATRIX_COEFFICIENTS, avctx-&gt;colorspace);<br/>     codecctl_int(avctx, AV1E_SET_TRANSFER_CHARACTERISTICS, avctx-&gt;color_trc);<br/>@@ -746,6 +755,8 @@ static const AVOption options[] = {<br/>     { "static-thresh",    "A change threshold on blocks below which they will be skipped by the encoder", OFFSET(static_thresh), AV_OPT_TYPE_INT, { .i64 = 0 }, 0, INT_MAX, VE },<br/>     { "drop-threshold",   "Frame drop threshold", offsetof(AOMContext, drop_threshold), AV_OPT_TYPE_INT, {.i64 = 0 }, INT_MIN, INT_MAX, VE },<br/>     { "noise-sensitivity", "Noise sensitivity", OFFSET(noise_sensitivity), AV_OPT_TYPE_INT, {.i64 = 0 }, 0, 4, VE},<br/>+    { "tile-columns", "Number of tile columns to use, log2", OFFSET(tile_columns), AV_OPT_TYPE_INT, {.i64 = -1}, -1, 6, VE},<br/>+    { "tile-rows", "Number of tile rows to use, log2", OFFSET(tile_rows), AV_OPT_TYPE_INT, {.i64 = -1}, -1, 6, VE},<br/>     { NULL }<br/> };</span></pre><p id="b5cd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这还增加了<code class="eh lj lk ll lm b">-tile-rows</code>选项，由于AV1中图块行之间的可配置预测依赖性，该选项可用于更多的并行化。libaom的最新<a class="ae ki" href="https://aomedia.googlesource.com/aom/+/0e4a0986b9ca8704f4d8f5845d183ee283a0900d^!/" rel="noopener ugc nofollow" target="_blank">补丁</a>支持该特性。</p><p id="c93b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在libvpx VP9中，我们有<code class="eh lj lk ll lm b">-row-mt</code>选项来使用基于块行的线程方法在单列图块中启用<a class="ae ki" href="https://groups.google.com/a/webmproject.org/forum/#!topic/codec-devel/oiHjgEdii2U" rel="noopener ugc nofollow" target="_blank">多线程。几天前，libaom也增加了</a><a class="ae ki" href="https://aomedia.googlesource.com/aom/+/0ec03a4c128a53cc1275c376503fea1fe7723f82^!/" rel="noopener ugc nofollow" target="_blank">和</a>，但是目前没有什么有趣的东西，基本上是别名<code class="eh lj lk ll lm b">-tile-columns</code>。</p><p id="ed08" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在WebM文件中启用AV1支持需要第二个补丁。这也很简单:</p><pre class="ln lo lp lq fq lr lm ls lt aw lu dt"><span id="6939" class="kj kk hu lm b fv lv lw l lx ly">diff --git a/libavformat/matroskaenc.c b/libavformat/matroskaenc.c<br/>index 09a62e1922..76cb124221 100644<br/>--- a/libavformat/matroskaenc.c<br/>+++ b/libavformat/matroskaenc.c<br/>@@ -1296,11 +1296,12 @@ static int mkv_write_track(AVFormatContext *s, MatroskaMuxContext *mkv,<br/> <br/>     if (mkv-&gt;mode == MODE_WEBM &amp;&amp; !(par-&gt;codec_id == AV_CODEC_ID_VP8 ||<br/>                                     par-&gt;codec_id == AV_CODEC_ID_VP9 ||<br/>+                                    par-&gt;codec_id == AV_CODEC_ID_AV1 ||<br/>                                     par-&gt;codec_id == AV_CODEC_ID_OPUS ||<br/>                                     par-&gt;codec_id == AV_CODEC_ID_VORBIS ||<br/>                                     par-&gt;codec_id == AV_CODEC_ID_WEBVTT)) {<br/>         av_log(s, AV_LOG_ERROR,<br/>-               "Only VP8 or VP9 video and Vorbis or Opus audio and WebVTT subtitles are supported for WebM.\n");<br/>+               "Only VP8 or VP9 or AV1 video and Vorbis or Opus audio and WebVTT subtitles are supported for WebM.\n");<br/>         return AVERROR(EINVAL);<br/>     }</span></pre><p id="e2ec" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在WebM中对AV1的支持被推迟了一点，因为libaom的WebM muxer还没有更新到最新的规格，详见<a class="ae ki" href="https://bugs.chromium.org/p/aomedia/issues/detail?id=2027" rel="noopener ugc nofollow" target="_blank">这个bug </a>。但是FFmpeg已经做了正确的事情，所以它制作的WebM视频应该没有问题。</p><p id="fa50" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你也可以使用<a class="ae ki" href="https://en.wikipedia.org/wiki/ISO_base_media_file_format" rel="noopener ugc nofollow" target="_blank"> MP4容器</a>来存储你的AV1视频(为此将<code class="eh lj lk ll lm b">-f mp4</code>选项传递给ffmpeg)。它已经可以在最新的Chrome和Firefox上运行了。另一方面，Matroska容器(几乎与WebM相同，但有更多的功能，可以通过<code class="eh lj lk ll lm b">-f matroska</code>启用)只能在Chrome中工作，并且由于其解复用器的限制，不能在Firefox中工作。</p><p id="e139" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我把两个补丁都发送到ffmpeg-devel邮件列表，但是他们还没有被接受。然而，boram的Windows和macOS版本包括已经应用了补丁的ffmpeg二进制文件，因此一切都可以开箱即用。如果你想自己构建ffmpeg，请看下一节。</p><h2 id="3d32" class="kj kk hu bd kl km kn ko kp kq kr ks kt jn ku kv kw jr kx ky kz jv la lb lc ld dt translated">FFmpeg版本</h2><p id="ad10" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">我为我的工具编译ffmpeg的定制版本，因为它让我能够控制编码器和特性的包含。这也有助于极大地减少发布版本的下载量。</p><p id="e6f0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在Windows上，我使用awesome<a class="ae ki" href="https://github.com/jb-alvarado/media-autobuild_suite" rel="noopener ugc nofollow" target="_blank">media-autobuild _ suite</a>脚本，它支持ffmpeg和许多其他工具的编译。只需按照自述文件和安装向导中的说明进行操作。</p><p id="e7e4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要应用上述补丁，请在<code class="eh lj lk ll lm b">if do_vcs <a class="ae ki" href="https://git.ffmpeg.org/ffmpeg.git" rel="noopener ugc nofollow" target="_blank">"https://git.ffmpeg.org/ffmpeg.git</a>"; then</code>行之后的<code class="eh lj lk ll lm b">build/media-suite_compile.sh</code>文件中添加以下代码:</p><pre class="ln lo lp lq fq lr lm ls lt aw lu dt"><span id="4452" class="kj kk hu lm b fv lv lw l lx ly">do_patch "<a class="ae ki" href="https://gist.github.com/Kagami/8d42f7b9d6c3d7e87a6da40b0fee10dc/raw/5f6cc9391e2796d2b2056cb15f90394cd8c7bcee/0001-lavc-libaomenc-Add-tile-columns-tile-rows.patch" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/Kagami/8d42f7b9d6c3d7e87a6da40b0fee10dc/raw/5f6cc9391e2796d2b2056cb15f90394cd8c7bcee/0001-lavc-libaomenc-Add-tile-columns-tile-rows.patch</a>" am<br/>do_patch "<a class="ae ki" href="https://gist.github.com/Kagami/8d42f7b9d6c3d7e87a6da40b0fee10dc/raw/5f6cc9391e2796d2b2056cb15f90394cd8c7bcee/0002-lavf-matroska-Allow-AV1-in-WebM.patch" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/Kagami/8d42f7b9d6c3d7e87a6da40b0fee10dc/raw/5f6cc9391e2796d2b2056cb15f90394cd8c7bcee/0002-lavf-matroska-Allow-AV1-in-WebM.patch</a>" am</span></pre><p id="ca2c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在macOS <a class="ae ki" href="https://brew.sh" rel="noopener ugc nofollow" target="_blank">上，自制软件</a>完成了几乎所有的工作，只需将<a class="ae ki" href="https://gist.github.com/Kagami/192705f026fd08bd904342788eb697c6/raw/d9fb96559449325c7df7c1f49232844f90b5375e/libaom.rb" rel="noopener ugc nofollow" target="_blank"> libaom.rb </a>和<a class="ae ki" href="https://gist.github.com/Kagami/192705f026fd08bd904342788eb697c6/raw/d9fb96559449325c7df7c1f49232844f90b5375e/ffmpeg.rb" rel="noopener ugc nofollow" target="_blank"> ffmpeg.rb </a>放入<code class="eh lj lk ll lm b">/usr/local/Homebrew/Library/Taps/homebrew/homebrew-core/Formula</code>目录并运行</p><pre class="ln lo lp lq fq lr lm ls lt aw lu dt"><span id="44e8" class="kj kk hu lm b fv lv lw l lx ly">brew install ffmpeg --HEAD --with-libvpx --with-libaom <!-- -->--with-libvorbis<!-- --> --with-opus<!-- --> --with-libass</span></pre><p id="a6ae" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在Linux上，遵循您将找到的任何最新的发行版说明，例如<a class="ae ki" href="https://trac.ffmpeg.org/wiki/CompilationGuide/Ubuntu" rel="noopener ugc nofollow" target="_blank">这个</a>。一定要跑</p><pre class="ln lo lp lq fq lr lm ls lt aw lu dt"><span id="d8e0" class="kj kk hu lm b fv lv lw l lx ly">wget <a class="ae ki" href="https://gist.github.com/Kagami/8d42f7b9d6c3d7e87a6da40b0fee10dc/raw/5f6cc9391e2796d2b2056cb15f90394cd8c7bcee/0001-lavc-libaomenc-Add-tile-columns-tile-rows.patch" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/Kagami/8d42f7b9d6c3d7e87a6da40b0fee10dc/raw/5f6cc9391e2796d2b2056cb15f90394cd8c7bcee/0001-lavc-libaomenc-Add-tile-columns-tile-rows.patch</a><br/>git am 0001-lavc-libaomenc-Add-tile-columns-tile-rows.patch<br/>wget <a class="ae ki" href="https://gist.github.com/Kagami/8d42f7b9d6c3d7e87a6da40b0fee10dc/raw/5f6cc9391e2796d2b2056cb15f90394cd8c7bcee/0002-lavf-matroska-Allow-AV1-in-WebM.patch" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/Kagami/8d42f7b9d6c3d7e87a6da40b0fee10dc/raw/5f6cc9391e2796d2b2056cb15f90394cd8c7bcee/0002-lavf-matroska-Allow-AV1-in-WebM.patch</a><br/>git am 0002-lavf-matroska-Allow-AV1-in-WebM.patch</span></pre><p id="59bf" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在带有ffmpeg源代码的目录中应用补丁。</p><h2 id="b88c" class="kj kk hu bd kl km kn ko kp kq kr ks kt jn ku kv kw jr kx ky kz jv la lb lc ld dt translated">rav1e</h2><p id="b779" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">AV1存在替代编码器，名为<a class="ae ki" href="https://github.com/xiph/rav1e" rel="noopener ugc nofollow" target="_blank"> rav1e </a>，用Rust编写。它还处于早期实验阶段，而且<a class="ae ki" href="https://github.com/xiph/rav1e/issues/472" rel="noopener ugc nofollow" target="_blank">还没有提供C API </a>，所以还不能嵌入到ffmpeg中。</p><p id="29b1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为什么我们不能从命令行使用rav1e呢？为什么我们需要ffmpeg？(这同样适用于aomenc CLI实用程序，它是libaom的一部分。)这完全是因为ffmpeg非常强大，所以您可以将任何视频文件作为输入传递给它，将视频、音频、字幕编码为任何格式和容器的组合，在它们之间进行过滤(缩放、去隔行、更改帧速率等)，并且使用一行shell就可以完成所有这些操作。</p><p id="a566" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">另一方面，rav1e和aomenc接受数量非常有限的格式(如<a class="ae ki" href="https://wiki.multimedia.cx/index.php?title=YUV4MPEG2" rel="noopener ugc nofollow" target="_blank"> YUV4MPEG2 </a>容器中的原始未压缩视频)，根本不可能有音频或过滤。典型的输入视频在MP4容器中会有H.264视频，因此为了将其传递给rav1e，您需要解压缩到单独的文件或动态解码并通过stdin传递，这是一个笨拙而混乱的过程。这就是为什么通过ffmpeg编码是首选方式。</p><p id="d330" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">此外，现在rav1e的重点是速度，所以最有用的测试目的。虽然事情发展很快，所以让我们希望在不久的将来，我们将有伟大的AV1替代编码器。</p><h2 id="582d" class="kj kk hu bd kl km kn ko kp kq kr ks kt jn ku kv kw jr kx ky kz jv la lb lc ld dt translated">未来的想法</h2><p id="1077" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">虽然你已经可以生产全功能的AV1编码，但还有几个方面需要改进，值得关注。</p><p id="05aa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">其中之一是aomenc命令为libaom提供了比ffmpeg接口多得多的编码器选项。这有可能为结果文件提供更好的压缩或更快的编码。希望ffmpeg最终能赶上并至少实现其中最重要的部分。</p><p id="f75a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">其次，现在libaom非常慢，所以要么编码非常耗时，要么影响压缩效率。例如，webm.py和boram都使用<code class="eh lj lk ll lm b">-cpu-used 4</code>速度参数，而<code class="eh lj lk ll lm b">-cpu-used 1</code>是默认值。libaom最终应该会变得更快，同样的事情发生在libvpx VP9编码器上，它在2013年非常慢。在最坏的情况下，我们仍然有rav1e作为b计划。</p><p id="43ef" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">第三，在libaom的构建配置中有几个<a class="ae ki" href="https://aomedia.googlesource.com/aom/+/10df8d1b586133d5c04ce8907cf2d23d43765521/build/cmake/aom_config_defaults.cmake#123" rel="noopener ugc nofollow" target="_blank">有趣的选项</a>，默认情况下没有启用。尝试它们可能会很有趣，以实现更好的压缩。</p></div></div>    
</body>
</html>