<html>
<head>
<title>Query a custom AutoML model with Cloud Functions and Firebase</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用云函数和Firebase查询自定义AutoML模型</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/make-predictions-on-a-custom-automl-model-with-cloud-functions-and-firebase-ec3868a1671b?source=collection_archive---------7-----------------------#2018-08-27">https://medium.com/hackernoon/make-predictions-on-a-custom-automl-model-with-cloud-functions-and-firebase-ec3868a1671b?source=collection_archive---------7-----------------------#2018-08-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="4d04" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你还没有听说过<a class="ae jp" href="http://m/automl/" rel="noopener ugc nofollow" target="_blank"> AutoML </a>，它是谷歌云上最新的ML产品，让你根据自己的数据建立定制的ML模型——不需要模型代码。它目前可用于图像、文本和翻译模型。有很多资源可以帮助你在AutoML中准备数据和训练模型，所以在这篇文章中，我想重点关注AutoML的预测(或服务)部分。</p><p id="9489" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将带您构建一个简单的web应用程序，在您训练好的模型上生成预测。它利用了Firebase和云功能，所以它完全是无服务器的(是的，我把<strong class="it hv">无服务器</strong>和<strong class="it hv"> ML </strong>放在同一个博客帖子里🙄).这是应用程序架构:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/96edffd13f06d528b74c5da1d7e2e37b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6gpbXVsbAWG6xOkjneUUYw.png"/></div></div></figure><p id="4703" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">想跳到代码吗？在<a class="ae jp" href="https://github.com/sararob/automl-api-demo" rel="noopener ugc nofollow" target="_blank">这个GitHub repo </a>里面都有。</p><h1 id="fbec" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">AutoML API</h1><p id="db8a" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">我特别兴奋地发现，除了为构建和训练模型提供完整的UI，<a class="ae jp" href="https://cloud.google.com/vision/automl/docs/reference/rest/" rel="noopener ugc nofollow" target="_blank"> AutoML还有一个API </a>，用于添加训练数据、部署模型、生成预测等等。假设您正在为您的模型众包训练数据:使用AutoML API，您可以动态地向项目的数据集中添加新数据，并定期训练您的模型的更新版本。我将在以后的帖子中讨论这个问题，这里我将重点讨论预测部分。</p><p id="8d32" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于这个演示，我们将构建一个web应用程序，用于在经过训练的AutoML Vision模型上生成预测(尽管它可以很容易地适应AutoML NL，因为它们使用相同的API)。我将要查询的特定模型可以<a class="ae jp" href="https://youtu.be/QU7_eU8HzAQ?t=16m33s" rel="noopener ugc nofollow" target="_blank">检测图像中云的类型</a>。在前端，用户将能够上传预测图像。我们的应用程序会将该图像上传到Firebase Storage，这将启动云功能。在函数内部，我们将调用AutoML API并将预测数据返回给我们的前端客户端。成品看起来是这样的:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff lf"><img src="../Images/73c5eeebe64f0e7623abaa5d76364bcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*T-tGYmaLl_2Te8I9rai3HQ.gif"/></div></div></figure><h1 id="dcf9" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">设置您的Firebase项目</h1><p id="93a1" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated"><a class="ae jp" href="https://firebase.google.com/" rel="noopener ugc nofollow" target="_blank"> Firebase </a>是让应用快速启动并运行的好方法，无需担心管理服务器。它提供了各种SDK，使得直接从客户端JavaScript上传图像、保存数据和验证用户变得容易。</p><p id="9574" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于这篇博文，我假设你已经有了一个训练有素的自动视觉模型，可以进行预测。下一步是将这个项目与Firebase关联起来。前往<a class="ae jp" href="https://console.firebase.google.com/" rel="noopener ugc nofollow" target="_blank"> Firebase控制台</a>并点击<strong class="it hv">添加项目</strong>。然后点击下拉菜单，选择您已经创建了AutoML模型的云项目。如果你以前从未使用过Firebase，你还需要<a class="ae jp" href="https://firebase.google.com/docs/cli/" rel="noopener ugc nofollow" target="_blank">安装CLI </a>。</p><p id="d1a3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，从<a class="ae jp" href="https://github.com/sararob/automl-api-demo" rel="noopener ugc nofollow" target="_blank">这个GitHub repo </a>和<code class="eh lg lh li lj b">cd</code>中克隆代码到你下载它的目录中。要在该目录中初始化Firebase，运行<code class="eh lg lh li lj b">firebase init</code>并在出现提示时选择Firestore、函数、托管和存储(本演示使用所有四个选项):</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff lk"><img src="../Images/81cdf0c8bfbe5cefcc8129511e29dc6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oM_NHzYol-oiim7rny6_oA.png"/></div></div></figure><p id="e32d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们准备好出发了。下一步，我们将设置和部署调用AutoML的云函数。</p><h1 id="e74e" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">Firebase的AutoML +云功能</h1><p id="6ea0" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">你可以独立于Firebase使用云功能，但由于我已经在我的应用程序中使用了这么多Firebase功能，我将利用方便的<a class="ae jp" href="https://firebase.google.com/docs/functions/" rel="noopener ugc nofollow" target="_blank"> Firebase SDK来实现云功能</a>。看一下<code class="eh lg lh li lj b"><a class="ae jp" href="https://github.com/sararob/automl-api-demo/blob/master/functions/index.js" rel="noopener ugc nofollow" target="_blank">functions/index.js</a></code>文件，更新顶部的3个变量来反映你的项目信息:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ll lm l"/></div></figure><p id="387b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们的云函数是在<code class="eh lg lh li lj b">exports.callCustomModel</code>中定义的。每当一个文件被添加到我们的存储桶时，我们使用<code class="eh lg lh li lj b">functions.storage.object().onFinalize()</code>来触发这个函数。下面是函数中发生的情况:</p><ol class=""><li id="93f9" class="ln lo hu it b iu iv iy iz jc lp jg lq jk lr jo ls lt lu lv dt translated">将图像下载到我们的云函数文件系统(我们可以使用<code class="eh lg lh li lj b">tmp/</code>目录来完成)</li><li id="28c6" class="ln lo hu it b iu lw iy lx jc ly jg lz jk ma jo ls lt lu lv dt translated">Base64编码图像，为自动预测请求做准备</li><li id="eb26" class="ln lo hu it b iu lw iy lx jc ly jg lz jk ma jo ls lt lu lv dt translated">使用方便的<a class="ae jp" href="https://github.com/googleapis/nodejs-automl" rel="noopener ugc nofollow" target="_blank"> nodejs-automl </a>包发出AutoML预测请求</li><li id="7e57" class="ln lo hu it b iu lw iy lx jc ly jg lz jk ma jo ls lt lu lv dt translated">编写对云Firestore的预测响应</li></ol><p id="498c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们可以用两行代码创建一个AutoML预测客户端:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ll lm l"/></div></figure><p id="3b89" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">进行AutoML预测的请求JSON如下所示:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ll lm l"/></div></figure><p id="a05a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们需要做的就是创建一个预测客户端并调用<code class="eh lg lh li lj b">predict()</code>来将它发送给AutoML API:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ll lm l"/></div></figure><p id="abc7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">是时候部署该功能了。从这个项目的根目录，运行<code class="eh lg lh li lj b">firebase deploy --only functions</code>。部署完成后，您可以通过导航到Firebase控制台的<strong class="it hv">存储</strong>部分并上传图像来测试它:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mb"><img src="../Images/bd7a3ff6b217fefb1c423571de5666f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QtVvDZfVw8IfFhworIeibw.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Uploading an image to Firebase Storage</figcaption></figure><p id="bf38" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，前往控制台的<strong class="it hv">功能</strong>部分查看日志。如果预测请求成功完成，您应该在日志中看到预测响应JSON:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff lf"><img src="../Images/d1c27ecae075f7aafc205645b577ca53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cZeWKQfzQsC7SGJOHXpO7Q.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Function logs</figcaption></figure><p id="a3f9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在函数内部，我们还将预测元数据写入<strong class="it hv"> Firestore </strong>，以便我们的应用程序可以在客户端显示这些数据。在Firestore控制台中，您应该可以看到保存在图像/集合中的元数据:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mg"><img src="../Images/e43a3b32139ee07aeac9382f6b05c894.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ywYnvRZcthuuhzIZ4ETdQg.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Prediction metadata in Cloud Firestore</figcaption></figure><p id="b4b9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">随着功能的工作，是时候设置应用程序前端了。</p><h1 id="48f5" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">把所有的放在一起</h1><p id="a1f5" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">要在本地测试前端，从项目的根目录运行命令<code class="eh lg lh li lj b">firebase serve</code>并导航到<code class="eh lg lh li lj b">localhost:5000</code>。点击右上角的<strong class="it hv">上传云照片</strong>按钮。如果您上传的图像从您的模型返回了一个预测，您应该会看到该预测显示在应用程序中。请记住，这个应用程序是为我的云探测器模型配置的，但您可以轻松地修改代码，使其适用于您自己的领域。上传照片时，请检查您的功能、Firestore和存储仪表盘，以确保一切正常。</p><p id="e2b0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，让我们利用Firebase托管来部署前端，这样我们就可以与其他人共享它了！部署应用程序就像运行命令<code class="eh lg lh li lj b">firebase deploy --only hosting</code>一样简单。当部署完成后，你的应用程序将在你自己的<code class="eh lg lh li lj b">firebaseapp.com</code>域中运行。</p><p id="40b6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就是这样！我们从一个完全无服务器技术的定制ML模型中获得预测。要深入了解这篇文章中涉及的所有细节，请查看以下资源:</p><ul class=""><li id="0c97" class="ln lo hu it b iu iv iy iz jc lp jg lq jk lr jo mh lt lu lv dt translated"><a class="ae jp" href="https://github.com/sararob/automl-api-demo" rel="noopener ugc nofollow" target="_blank">GitHub上的完整代码</a></li><li id="7a67" class="ln lo hu it b iu lw iy lx jc ly jg lz jk ma jo mh lt lu lv dt translated">自动语言<a class="ae jp" href="https://cloud.google.com/vision/automl/docs/" rel="noopener ugc nofollow" target="_blank">视觉</a>和自然语言<a class="ae jp" href="https://cloud.google.com/natural-language/automl/docs/" rel="noopener ugc nofollow" target="_blank">文档</a></li><li id="9388" class="ln lo hu it b iu lw iy lx jc ly jg lz jk ma jo mh lt lu lv dt translated"><a class="ae jp" href="https://firebase.google.com/docs/" rel="noopener ugc nofollow" target="_blank"> Firebase文档</a></li></ul><p id="65c5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请在评论中告诉我你的想法，或者在推特上通过<a class="ae jp" href="https://twitter.com/srobtweets" rel="noopener ugc nofollow" target="_blank"> @SRobTweets </a>找到我。</p></div></div>    
</body>
</html>