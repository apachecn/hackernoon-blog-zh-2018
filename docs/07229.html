<html>
<head>
<title>Running End to End tests as Google Cloud Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">作为谷歌云功能运行端到端测试</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/running-end-to-end-tests-as-google-cloud-functions-f5e34ffc3984?source=collection_archive---------13-----------------------#2018-08-27">https://medium.com/hackernoon/running-end-to-end-tests-as-google-cloud-functions-f5e34ffc3984?source=collection_archive---------13-----------------------#2018-08-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="0d55" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一切从这里开始:<a class="ae jp" href="https://cloud.google.com/blog/products/gcp/introducing-headless-chrome-support-in-cloud-functions-and-app-engine" rel="noopener ugc nofollow" target="_blank">谷歌宣布在其云功能服务</a>中支持浏览器。但是好吧，就一个浏览器。猜猜是哪个？你说的没错，是谷歌Chrome。无头铬合金。尽管如此，这个声明是巨大的，这可能是我们所知道的浏览器测试革命的开始。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/85a6cd5aaff3f13b1514bb2e6a00744d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XZmLA5TlzA6i01aGmGmXtQ.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek"><a class="ae jp" href="https://cloud.google.com/blog/products/gcp/introducing-headless-chrome-support-in-cloud-functions-and-app-engine" rel="noopener ugc nofollow" target="_blank">Announcement post</a></figcaption></figure><p id="5ebe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我来详细说明一下。Google中的云函数(类似AWS中的lambdas)是无服务器的无状态函数，你只需为它们实际执行的时间付费。在测试社区内部，人们对使用它们有着浓厚的兴趣。事实上，我们正在以同样的方式启动我们的浏览器——启动和停止，我们不想为测试不运行的时间付费！在此之前，很难让浏览器运行在云功能中，但现在谷歌安装了一个，所以我们准备尝试一下。它能成为游戏规则的改变者吗？</p><p id="ed17" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">谷歌推荐使用<a class="ae jp" href="https://github.com/GoogleChrome/puppeteer" rel="noopener ugc nofollow" target="_blank">木偶师</a>库来控制浏览器。木偶师本身并不是一个测试框架，所以为了编写和运行实际的测试，我们将使用<a class="ae jp" href="https://codecept.io" rel="noopener ugc nofollow" target="_blank"> CodeceptJS测试框架</a>。这个可以在各种后端运行测试，比如Selenium，但是也内置了对木偶师的支持。如果你以前从未遇到过CodeceptJS，可以查看我之前的帖子<a class="ae jp" href="https://hackernoon.com/effective-end-2-end-testing-in-javascript-with-codeceptjs-37c8d7d6a928" rel="noopener ugc nofollow" target="_blank">:“用CodeceptJS在JavaScript中进行有效的End 2 End测试”</a>。今天我们将尝试一些高级的东西:作为云函数运行功能测试。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff kg"><img src="../Images/caad447a2131d8841e596221bac83101.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_OZPYJAdq4IuOXmG5dGC2A.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek"><a class="ae jp" href="https://codecept.io" rel="noopener ugc nofollow" target="_blank">CodeceptJS testing framework</a></figcaption></figure><p id="c344" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先你需要在<a class="ae jp" href="https://console.cloud.google.com/project/_/logs?service=cloudfunctions.googleapis.com" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a>注册。即使你没有账户，创建一个也很容易，因为每个人都有谷歌账户。谷歌会问你要信用卡，但别担心，你一年可以花300美元，云功能包含在免费层中。创建帐户后，您需要<a class="ae jp" href="https://cloud.google.com/sdk/docs/quickstarts" rel="noopener ugc nofollow" target="_blank">安装<em class="kh"> gcloud </em>命令行</a>工具。</p><blockquote class="ki kj kk"><p id="ebd6" class="ir is kh it b iu iv iw ix iy iz ja jb kl jd je jf km jh ji jj kn jl jm jn jo hn dt translated">云功能免费层包括每月多达200万次调用和100万秒的免费计算时间</p></blockquote><p id="175a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在让我们做一些JavaScript的东西。让我们从制作包含codeceptjs和puppeteer库的<code class="eh ko kp kq kr b">package.json </code>文件开始:</p><pre class="jr js jt ju fq ks kr kt ku aw kv dt"><span id="120d" class="kw kx hu kr b fv ky kz l la lb">{<br/>  "name": "browserTest",<br/>  "main": "index.js",<br/>  "dependencies": {<br/>    "codeceptjs": "^1.3.3",<br/>    "puppeteer": "^1.6.2"<br/>  }<br/>}</span></pre><p id="1c30" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后运行<code class="eh ko kp kq kr b">npm install</code>。您不需要安装任何其他测试框架，比如Mocha，因为CodeceptJS已经提供了一个测试框架。它还内置了断言。</p><p id="bf7e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">与传统的<a class="ae jp" href="https://codecept.io/quickstart/" rel="noopener ugc nofollow" target="_blank"> CodeceptJS安装</a>(仍然可以完成)不同，我们不能在这里使用CodeceptJS CLI runner，因为Google希望在<code class="eh ko kp kq kr b">index.js</code>中使用纯JavaScript函数。CodeceptJS拥有用于<a class="ae jp" href="https://codecept.io/hooks/#custom-runner" rel="noopener ugc nofollow" target="_blank">创建自定义运行器</a>的API，我们将使用它来运行我们的测试。将这段代码复制粘贴到<code class="eh ko kp kq kr b">index.js:</code></p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lc ld l"/></div></figure><p id="abd5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这个设置中，我们为木偶师创建了配置(请注意在云中启动浏览器所需的<code class="eh ko kp kq kr b">--no-sandbox</code>选项)并创建了一个基本的报告器。然而，我们还没有创建任何测试！测试是从当前目录加载的带有<code class="eh ko kp kq kr b">*_test.js</code>后缀的独立文件。</p><p id="94d9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以我们来创造一个吧！我们将围绕GitHub做一个基本的测试，这就是为什么我把Puppeteer配置<code class="eh ko kp kq kr b">github.com</code>添加为基本URL值。因此一个名为<code class="eh ko kp kq kr b">github_test.js</code>的测试文件应该非常简单，但是要包含一些交互和断言。这是我准备的:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lc ld l"/></div></figure><p id="6ef1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kh">(有些命令我用</em> <code class="eh ko kp kq kr b"><em class="kh">retry()</em></code> <em class="kh">，因为页面可能还没有完全加载)</em></p><p id="834c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如您所见，您可以阅读测试并理解其输出。语法非常简单，没有不必要的CSS或XPath选择器。</p><p id="af6d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就是我们所有的测试。但是让我们回到我们的<code class="eh ko kp kq kr b">index.js</code>和名为<code class="eh ko kp kq kr b">browserTest</code>的主函数(这个名字将被Google使用)。但是在我们将它部署到云之前，让我们试着用<a class="ae jp" href="https://hackernoon.com/tagged/nodejs" rel="noopener ugc nofollow" target="_blank">节点在本地运行它:</a></p><pre class="jr js jt ju fq ks kr kt ku aw kv dt"><span id="0f8a" class="kw kx hu kr b fv ky kz l la lb">node -e 'require("./index").browserTest()'</span></pre><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff le"><img src="../Images/e6f036df5db6a0629ad7cc564987e353.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pojnDYZTnQNIU4A4IzfUrg.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">test is passed, the error is not related</figcaption></figure><p id="3b92" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您看到这样的输出，测试通过了，我们准备把它推到云中。</p><p id="ec5f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">执行以下命令:</p><pre class="jr js jt ju fq ks kr kt ku aw kv dt"><span id="f590" class="kw kx hu kr b fv ky kz l la lb">gcloud beta functions deploy browserTest --trigger-http --runtime nodejs8 --memory 1024MB</span></pre><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff lf"><img src="../Images/26cdf5152e89561426a468496f5b6ed9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_qk8-XxS-38XjHA4e_EUyQ.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">On first run you will be asked</figcaption></figure><p id="78d7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">第一次运行时，你会被要求启用谷歌云功能API。你需要同意这一点，并请<strong class="it hv">检查该项目的计费已启用</strong>。否则浏览器将无法访问外部网站。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff lg"><img src="../Images/ac013984e113ebd982d768a300f22b78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7AgWpBfqwAgmrPfOzp4Eng.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">The expected output</figcaption></figure><p id="f774" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦部署了该函数，就可以通过下一个命令来执行它:</p><pre class="jr js jt ju fq ks kr kt ku aw kv dt"><span id="c24d" class="kw kx hu kr b fv ky kz l la lb">gcloud beta functions call browserTest</span></pre><p id="450c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果一切正常，我们应该在几秒钟后看到以下响应:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff lh"><img src="../Images/db7ab892fe16f29935bc107eb9df8f0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/1*mKuN-0bKlqiF-Zwh-BVV4g.png"/></div></figure><p id="8895" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果没有——尝试重新运行函数或查看日志，Google也为我们提供了下一个命令:</p><pre class="jr js jt ju fq ks kr kt ku aw kv dt"><span id="3260" class="kw kx hu kr b fv ky kz l la lb">gcloud functions logs read</span></pre><p id="553f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">日志应该包含逐步编写的测试输出，如果有断言失败的话。如果发生了错误，很容易发现错误在哪里。例如，下面是日志中错误报告的样子:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff li"><img src="../Images/59c456cf5030d90bba5502f6eb7606d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AHtKgBvnoTenG2gKf0nJGw.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">But I hope you will get the successfully passing test, instead of this one</figcaption></figure><p id="c7a4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，让我们从终端切换到花哨的仪表板，查看关于云功能执行的详细报告。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff lj"><img src="../Images/3f1970561f041b6d45005a4fb658a1b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fYVsAtuK8sRVl8m2jvbF-g.png"/></div></div></figure><h1 id="380a" class="lk kx hu bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg dt translated">摘要</h1><p id="2b26" class="pw-post-body-paragraph ir is hu it b iu mh iw ix iy mi ja jb jc mj je jf jg mk ji jj jk ml jm jn jo hn dt translated">测试运行并开始得非常快。然而，在使用云函数进行测试之前，您需要考虑一些限制。最强的是<strong class="it hv">超时。</strong>默认情况下，谷歌<strong class="it hv">限制云功能的执行时间为1分钟</strong>，可以增加到9分钟，但不能超过9分钟。</p><p id="d3e8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这使得谷歌云还没有为复杂的长场景端到端测试做好准备。然而，谷歌云功能对于健康检查测试来说是完美的<strong class="it hv">。</strong>这样你就可以挑选测试子集，并通过Google Cloud不时地运行它们，以确保你的服务的可用性。如果你涵盖了最基本的功能，如登录、搜索等，并将这些测试部署到云中，它们总有一天会派上用场。</p><p id="2272" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">其他值得注意的限制是只读文件系统，预装Chrome，不能控制系统。但是<strong class="it hv">开始时间令人印象深刻</strong>定价模式非常有趣。我希望有一天谷歌会考虑增加超时时间，或者允许我们产生多个函数来作为云函数运行我们的测试。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="mm ld l"/></div></figure></div></div>    
</body>
</html>