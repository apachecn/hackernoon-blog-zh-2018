<html>
<head>
<title>Using the Stream Real-Time Firehose with AWS SQS, Lambda, and SNS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将流实时消防软管与自动气象站SQS、拉姆达和SNS一起使用</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/using-the-stream-real-time-firehose-with-aws-sqs-lambda-and-sns-25bbefef198a?source=collection_archive---------15-----------------------#2018-08-29">https://medium.com/hackernoon/using-the-stream-real-time-firehose-with-aws-sqs-lambda-and-sns-25bbefef198a?source=collection_archive---------15-----------------------#2018-08-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/49e9f305216019bf27c810800b92c8d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8y29YlBLcjeBEDDowqpvig.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">https://getstream.io/try-the-api</figcaption></figure><p id="96d3" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">流式传输使您能够使用SQS、webhooks或websockets近乎实时地收听费用变化。在本教程中，我们将讨论如何使用AWS<a class="ae ke" href="https://aws.amazon.com/sqs/" rel="noopener ugc nofollow" target="_blank">SQS</a>&amp;<a class="ae ke" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank">λ</a>来响应提要更新。</p><p id="44ca" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">虽然websockets是监听变化的首选方法，但是SQS通知在提要基础设施中有着特殊的地位。Stream在提供实时性的能力方面大放异彩，因为您可以与收到的结果进行交互。例如，您可以监听订阅源的变化，并通过向用户发送电子邮件来吸引他们购买，根据应用程序中采取的操作发送SMS消息，等等。</p><p id="7f8c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这篇文章的目标是让你带着对AWS SQS、Lambda，当然还有Stream的深刻理解离开。</p><blockquote class="kf kg kh"><p id="cf90" class="jg jh ki ji b jj jk jl jm jn jo jp jq kj js jt ju kk jw jx jy kl ka kb kc kd hn dt translated"><em class="hu">注意:为了确保你能从头到尾跟进，请创建一个帐户或确保你有使用上述服务的必要权限——我们不会在AWS内讨论权限。</em></p></blockquote><h1 id="7788" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">建立SQS</h1><p id="5ca0" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">设置AWS SQS相当简单。登录后，前往SQS页面。从那里，我们可以选择创建一个新队列。单击“立即开始”按钮。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lp"><img src="../Images/b4b683a423c29621719c6372601fb83b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hIlAB_uHf7OCXI3xFO8neg.png"/></div></div></figure><p id="e957" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">接下来，您将看到新队列的设置页面。对于名称，请将其设置为“STREAM”。然后，选择左边的选项(“标准队列”)。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lp"><img src="../Images/c3c763c37ccca09284b59ea4b4dfae24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*krj5US_LcMckOemw2m0-pw.png"/></div></div></figure><p id="0bfb" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">创建之后，我们需要为新创建的流队列指定权限。在本教程中，我们将向全世界开放它。</p><blockquote class="kf kg kh"><p id="7ed3" class="jg jh ki ji b jj jk jl jm jn jo jp jq kj js jt ju kk jw jx jy kl ka kb kc kd hn dt translated"><em class="hu">注意:千万不要这样做——我这样做只是为了举例。始终锁定您的服务，只让需要访问的应用程序和用户进入。😜</em></p></blockquote><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lp"><img src="../Images/820884a9ec79e4b1f938e3005d34ec1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FokIlHSBnMfsWNO9OiGhvQ.png"/></div></div></figure><p id="337c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">点击“添加权限”，你应该设置！</p><h1 id="b950" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">设置用于SQS的流</h1><p id="7a54" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">在开始之前，我们需要为Stream创建一个用户。我更喜欢创建一个单独的用户，这样我就可以更改权限；但是，如果您愿意，您可以自由使用现有的密钥和秘密(如果是这种情况，请跳过本节的第一部分)。</p><h1 id="3732" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">创建新的IAM用户和角色</h1><p id="5f86" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">该流程的第一步是前往AWS的<a class="ae ke" href="https://console.aws.amazon.com/iam" rel="noopener ugc nofollow" target="_blank"> IAM部分</a>。一旦你在那里，点击“用户”，然后“添加用户”。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lu"><img src="../Images/0b72156759a11a41925048221010d252.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BvKrnX-wyHs8pt-Gc6Opig.png"/></div></div></figure><p id="2748" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">对于“用户名”，输入“流”，对于“访问类型”，选择“编程访问”。单击“下一步”按钮继续下一步。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lu"><img src="../Images/0adb2213015d4a2787cef3672e9980b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SQ1JZEO9X43fHW5A49S8Ng.png"/></div></div></figure><p id="2835" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在上图中，您会注意到我们选择了<strong class="ji hv"> AmazonSQSFullAccess </strong>作为策略名称。这将确保您正在创建的用户能够访问SQS。除了将“组名”设置为“流”之外，您还需要做同样的事情。</p><blockquote class="kf kg kh"><p id="0d76" class="jg jh ki ji b jj jk jl jm jn jo jp jq kj js jt ju kk jw jx jy kl ka kb kc kd hn dt translated"><em class="hu">注意:您需要搜索该保单。为此，只需在搜索框中输入SQS。</em></p></blockquote><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lu"><img src="../Images/ad3a1fbbb6900ec15dc7f538bec9f2b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hLLJBSvqdt_g9FYfNJ-MXA.png"/></div></div></figure><p id="b437" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">创建“流”角色后，继续进入评审阶段。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lu"><img src="../Images/a4f357027546de814cd60ecbec4ceaec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bDMLgAsu6Y5DIBCsxYuCPA.png"/></div></div></figure><p id="f1c1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">最后，继续创建一个用户！</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lu"><img src="../Images/8600b4943eda6387cae75d30c8aabab4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ERv-pzJEihTCT0iD7G_ZBA.png"/></div></div></figure><p id="c1b9" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">复制“访问密钥ID”和“秘密访问密钥”——您将在下一步中需要它们。</p><h1 id="eef6" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">把它接到溪流上</h1><p id="d0f3" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">现在，让我们继续将我们的API密钥和秘密放入流仪表板，以便流后端知道将出站消息路由到哪里。</p><p id="202e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">步骤</strong>:</p><ol class=""><li id="f5bd" class="lv lw hu ji b jj jk jn jo jr lx jv ly jz lz kd ma mb mc md dt translated">转到<a class="ae ke" href="https://getstream.io/dashboard" rel="noopener ugc nofollow" target="_blank">流仪表盘</a></li><li id="3337" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">创建一个名为“user”的平面提要(确保启用通知)</li><li id="88ca" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">点击“用户”订阅源</li><li id="fe0f" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">通过单击标有“活动”的按钮启用SQS通知</li><li id="2a89" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">填写SQS网址、AWS密钥和AWS密码</li><li id="4418" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">点击右上角的保存按钮</li></ol><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mj"><img src="../Images/f10e1327b87cbd314566df684caea576.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mLQ_5HuNXKlekKIf_uezPw.png"/></div></div></figure><blockquote class="kf kg kh"><p id="1c54" class="jg jh ki ji b jj jk jl jm jn jo jp jq kj js jt ju kk jw jx jy kl ka kb kc kd hn dt translated"><em class="hu">注意:对于流SQS特性的完整解释，您可以在这里</em>  <em class="hu">查看文档</em> <a class="ae ke" href="https://getstream.io/docs/#realtime-sqs" rel="noopener ugc nofollow" target="_blank"> <em class="hu">。</em></a></p></blockquote><h1 id="b1dc" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">配置Lambda</h1><p id="d4ec" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">AWS Lambda lets将允许我们在不提供或管理服务器的情况下运行代码。这个服务对于解码作为有效载荷发送到SQS的base64编码的字符串来说很方便。一旦信息被解码，你可以做任何事情——发送短信、电子邮件等。</p><p id="3a52" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">让我们从设置Lambda开始。首先，你会想去AWS的Lambda部分(通过搜索栏很容易找到)。如果你是一个新用户，请完成这个简短的2分钟教程。如果你以前做过，那就直接加入吧。</p><p id="b879" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">第一步是创建一个新的Lambda函数，如下图所示。要复制我的配置，您需要执行以下操作:</p><ul class=""><li id="f596" class="lv lw hu ji b jj jk jn jo jr lx jv ly jz lz kd mk mb mc md dt translated">选择“从头开始创作”框</li><li id="ac43" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd mk mb mc md dt translated">将您的函数命名为“流”</li><li id="3862" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd mk mb mc md dt translated">将Node.js运行时更新到Node.js v8.10(已过时，但这是Lambda上可用的最新版本)</li><li id="56b9" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd mk mb mc md dt translated">将您的“角色”名称指定为“流”</li><li id="4f86" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd mk mb mc md dt translated">包括“SQS轮询器”权限</li></ul><p id="551c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">完成后，点击屏幕右下角的“创建功能”。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lp"><img src="../Images/539b556e033602381427ebba9f3e2066.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OrQNohhvS8ri_LXaGRMGsw.png"/></div></div></figure><p id="97e2" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">一切就绪！让我们继续下一步。如果成功，您应该会看到一个与此几乎相同的屏幕:</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lp"><img src="../Images/bf4f6291f549d5143fef2a310aa9dc92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kazo7j6b7payQZlNxkdv7Q.png"/></div></div></figure><p id="f760" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">为了允许Lambda函数访问SQS，需要进行一些小的配置。幸运的是，这一步只需要几次点击。</p><ol class=""><li id="2544" class="lv lw hu ji b jj jk jn jo jr lx jv ly jz lz kd ma mb mc md dt translated">在“设计者”部分下，点击可滚动部分中的“SQS”</li><li id="da3c" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">在“配置触发器”部分，搜索您的SQS队列(在我们的例子中，它将被命名为“流”)</li><li id="79ce" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">将批量保持在10</li><li id="e3a6" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">选中“启用触发器”</li><li id="c780" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">最后，点击“添加”</li></ol><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lp"><img src="../Images/84d3f9adde6ceb96115800f59b0c6676.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-a_t9hPcI_Q_qPbwQiiE_A.png"/></div></div></figure><h1 id="ac87" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">向Lambda发送SQS消息</h1><p id="eb88" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">为了将SQS连接到Lambda，我们将使用Lambda函数的ARN。最简单的方法是进入SQS页面，点击“队列操作”，然后点击“触发一个Lambda函数”。这样做会打开一个对话框。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ml"><img src="../Images/29a703ca76175757f4cb141e491b9d4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GSpJ3fiYMDcgooq7y0jkaA.png"/></div></div></figure><p id="3a31" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">从下拉菜单中选择“流”, Lambda函数ARN将自动填充。完成后点击“保存”。<em class="ki">连接完全启动并运行大约需要30秒到1分钟</em>。您可以在“Lambda Triggers”部分看到状态，如下图所示。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lu"><img src="../Images/85706e260493089d283739eb99a5a351.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kvAQCn7bihyKgLVtDHV3fw.png"/></div></div></figure><h1 id="ea6c" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">测试Lambda功能🐑</h1><p id="1b31" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">现在我们已经连接了SQS、Lambda和Stream，让我们运行一个端到端测试来确保消息到达Lambda函数。</p><p id="ae80" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在Lambda页面上，指定函数的内容如下:</p><figure class="lq lr ls lt fq iv"><div class="bz el l di"><div class="mm mn l"/></div></figure><p id="6a20" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然后点击右上角的“保存”按钮。</p><p id="c347" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">一旦你成功保存了你的Lambda代码，你将需要点击“Monitoring ”,这将带你到另一个页面。重定向后，单击“在CloudWatch中查看日志”。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mo"><img src="../Images/a87ba601e043671059fc6e8752282bc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9-2VZqA9u2DsZfzblLpXaQ.png"/></div></div></figure><p id="359b" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">回到您之前配置SQS设置的Stream dashboard。将会有一个标有“测试SQS”的便捷按钮。点击这个会发送一个测试载荷到SQS，<em class="ki">应该</em>然后转发到Lambda，在那里它会被登录到CloudWatch。咻！😅</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mo"><img src="../Images/535a58425fca7c5053ea450ed2a2839e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SmI-BdhMZrrHCZeXRwXtmQ.png"/></div></div></figure><p id="45cc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">您应该在有效负载中看到的是一个tweet活动的示例活动(如上所示)。如果CloudWatch中没有显示任何内容，请尝试重新加载。如果这不起作用，再次运行上面概述的步骤，以确保您已经检查了每个框。</p><h1 id="c8b5" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">将有效载荷输送到AWS SNS</h1><p id="d342" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">让我们对示例负载做一些事情。我打算建议我们使用AWS SNS将有效负载作为文本消息转发。要启用SNS，我们需要将<strong class="ji hv">amazonsfullaccess</strong>添加到流用户。为此，请回到AWS的IAM部分(<a class="ae ke" href="https://console.aws.amazon.com/iam" rel="noopener ugc nofollow" target="_blank">这里是</a>)。从那里，单击<strong class="ji hv">组&gt;流&gt;添加权限&gt;附加策略</strong>并从下拉菜单中选择<strong class="ji hv">amazonsfullaccess</strong>和<strong class="ji hv"> AWSLambdaFullAccess </strong>。选择后，单击右下角的“附加策略”。</p><p id="23c1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">您的权限现在应该是这样的:</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mo"><img src="../Images/c89ec2c41f00ffd096d43f0b69998d00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r5G6UKkLK5yVJX5vkZ0p0A.png"/></div></div></figure><p id="4ad5" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">流用户现在拥有SNS的权限，所以让我们继续设置它。前往AWS 的<a class="ae ke" href="https://console.aws.amazon.com/sns/" rel="noopener ugc nofollow" target="_blank"> SNS部分，点击“开始”。下面列出了后续步骤:</a></p><p id="6616" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">步骤:</strong></p><ol class=""><li id="67a4" class="lv lw hu ji b jj jk jn jo jr lx jv ly jz lz kd ma mb mc md dt translated">点击“创建主题”</li><li id="172c" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">将您的“主题名称”和“显示名称”设置为流，然后单击“创建主题”</li><li id="ab9d" class="lv lw hu ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">复制你的“话题ARN ”,因为你会需要它</li></ol><p id="07c9" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">接下来，我们需要修改我们的Lambda。正如你可能注意到的，在编辑器中修改Lambda代码是相当困难的——或者至少是在更大的范围内。相反，我建议在您的计算机上创建一个新的Node.js项目，并安装<a class="ae ke" href="https://www.npmjs.com/package/node-lambda" rel="noopener ugc nofollow" target="_blank"> node-lambda </a>。这个非常棒的小模块能够毫不费力地将Lambda设置、试运行、打包并部署到AWS。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mp"><img src="../Images/a9ee257a696ac1fad1e64a9e669c87a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cw2MHIJaxPTcao-8dkbdmA.png"/></div></div></figure><p id="474f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在您的本地机器上创建一个名为“stream”的目录，并移动到该目录中。一旦进入，运行命令“node-lambda setup ”, node-Lambda包将为您引导一个Lambda。运行安装程序后，最好忽略生成的<strong class="ji hv"> event.json </strong>和<strong class="ji hv">。env </strong>文件，以及<strong class="ji hv">.λ</strong></p><figure class="lq lr ls lt fq iv"><div class="bz el l di"><div class="mm mn l"/></div></figure><h1 id="b77c" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">复制并粘贴以下命令</h1><figure class="lq lr ls lt fq iv"><div class="bz el l di"><div class="mm mn l"/></div></figure><blockquote class="kf kg kh"><p id="f1ff" class="jg jh ki ji b jj jk jl jm jn jo jp jq kj js jt ju kk jw jx jy kl ka kb kc kd hn dt translated"><em class="hu">注意:对于那些不熟悉命令行的人，上面的命令会创建一个新文件(index.js)并安装我们需要的所有节点模块。</em></p></blockquote><p id="c696" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">按照终端中的提示完成。</p><h1 id="6299" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">修改您的package.json文件</h1><p id="b349" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">打开package.json并将脚本部分更改为:</p><figure class="lq lr ls lt fq iv"><div class="bz el l di"><div class="mm mn l"/></div></figure><h1 id="2107" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">打开。包络并修改您的关键点</h1><p id="8afc" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">在您生成的目录中，应该有一个<strong class="ji hv">。env </strong>文件并粘贴您的AWS凭证、角色ARN(您之前已经复制过了),并填充其余的参数以匹配您在AWS中的配置。我建议您指定以下设置:</p><figure class="lq lr ls lt fq iv"><div class="bz el l di"><div class="mm mn l"/></div></figure><h1 id="ca0c" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">更新index.js文件</h1><p id="b4a8" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">使用以下代码更新index.js文件:</p><figure class="lq lr ls lt fq iv"><div class="bz el l di"><div class="mm mn l"/></div></figure><blockquote class="kf kg kh"><p id="b485" class="jg jh ki ji b jj jk jl jm jn jo jp jq kj js jt ju kk jw jx jy kl ka kb kc kd hn dt translated"><em class="hu">注意:作为一个例子，我们仍然在记录Stream发送的内容。</em></p></blockquote><p id="00e8" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">最重要的是，部署您的代码！</p><figure class="lq lr ls lt fq iv"><div class="bz el l di"><div class="mm mn l"/></div></figure><h1 id="88de" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">修复SQS连接</h1><p id="5d27" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">当我们这一次部署时，它创建了一个称为“流开发”的Lambda，或者应该有，假设你按照指示去做。如果您没有将Lambda命名为“STREAM ”,请遵循您的命名约定。</p><p id="26e6" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">假设这是一个新的Lambda，我们将需要添加一个新的“触发器”。这和我们之前在帖子里做的一样，所以这里没有什么新东西。只需点击AWS Lambda页面左侧抽屉中的SQS(对于您的新Lambda)，并在必要时指定配置。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mq"><img src="../Images/34a2b94d4f4e51807ab8878cd066a82c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*16ml1uJVosWcfc4IHJS-dw.png"/></div></div></figure><h1 id="c5aa" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">将Lambda与SNS主题相关联</h1><p id="e97c" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">还记得我们创造的主题中的ARN吗？现在是使用它的时候了。打开你的。env文件，创建一个名为<strong class="ji hv"> AWS_SNS_TOPIC_ARN </strong>的新环境变量，并将值设置为您生成的SNS主题ARN。</p><h1 id="e4f2" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">创建您的产品升级和技术支持服务订阅</h1><p id="81c9" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">在我们总结和测试之前，我们需要为您的电话号码生成一个套餐。这可以在AWS控制面板的SNS部分完成。要创建订阅，请点击<strong class="ji hv">主题</strong> &gt; <strong class="ji hv">选择您现有的主题</strong>并点击“创建订阅”。将协议指定为SMS，并且端点应该是有效的E.164格式的电话号码(例如1–555–555–5555)。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mr"><img src="../Images/f888fc0f694865a041210285ec0137ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*veF1egqKfSC3Wspb_rGRwA.png"/></div></div></figure><h1 id="e35a" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">上传最终代码</h1><p id="0c48" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">这个SNS设置的倒数第二部分是上传一些更新的代码到你的Lambda函数。只需用下面的代码更新您的<strong class="ji hv"> index.js </strong>文件，并使用<strong class="ji hv"> yarn deploy </strong>命令将其推送到AWS。</p><figure class="lq lr ls lt fq iv"><div class="bz el l di"><div class="mm mn l"/></div></figure><h1 id="5c32" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">全部完成！</h1><p id="1606" class="pw-post-body-paragraph jg jh hu ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hn dt translated">恭喜你！您已经使用Stream、AWS SQS、Lambda和SNS设置了一个端到端测试，以便在提要发生事件时发送SMS消息(即使您是按下“测试SQS”按钮的人😉)</p><p id="d563" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我已经在GitHub上托管了回购，所以如果你遇到问题，请随意克隆它:<a class="ae ke" href="https://github.com/nparsons08/stream-sqs-lambda-sns" rel="noopener ugc nofollow" target="_blank">https://github.com/nparsons08/stream-sqs-lambda-sns</a></p><p id="fe74" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我也可以回答下面评论中的任何问题。</p><p id="0541" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">编码快乐！👋</p></div></div>    
</body>
</html>