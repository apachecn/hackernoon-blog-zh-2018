<html>
<head>
<title>5 steps to bring CoolStore’s Service Mesh to Azure Kubernetes Service (AKS)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将CoolStore的服务网格引入Azure Kubernetes服务(AKS)的5个步骤</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/5-steps-to-bring-coolstores-service-mesh-to-azure-kubernetes-service-aks-9cd1a5aa008a?source=collection_archive---------24-----------------------#2018-08-29">https://medium.com/hackernoon/5-steps-to-bring-coolstores-service-mesh-to-azure-kubernetes-service-aks-9cd1a5aa008a?source=collection_archive---------24-----------------------#2018-08-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/42b6c8f23b505ba20ba6e5c81fccae37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GOB0XzSmZc4pXx2CrAeW2A.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="https://pixabay.com/en/sailboats-race-yachts-yacht-racing-1375064/" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure></div><div class="ab cl jh ji hc jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hn ho hp hq hr"><h1 id="a5c5" class="jo jp hu bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl dt translated">第一句话</h1><p id="725c" class="pw-post-body-paragraph km kn hu ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj hn dt translated">如今，服务网格是一个前沿术语。我看到世界各地有很多人开始谈论这个话题。大约4个月前，我第一次开始看它，真的很惊讶。它能帮助我们构建一个复杂的微服务堆栈，让我继续关注它，这有多美好？</p><p id="cd60" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">据我们所知，为了用微服务方法来构建系统，伴随着许多令人头痛的问题，主要的事情是我们需要注意分布式计算的许多概念。每个人都知道分布式计算。在我个人看来，分布式系统在很多年前被创造出来后，在很长一段时间内都很难被采用。许多大公司，如推特、网飞、谷歌、亚马逊、微软……花费了大量的金钱和精力来寻找和构建简洁的解决方案。从那以后，出现了大量的库和工具。您可以搜索许多主题来讨论我们如何构建和使用这些解决方案和工具来避免微服务方法中的陷阱。只要谷歌一下微服务关键词，你就会相信我。</p><p id="9420" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">复杂的问题是通信、流量控制(路由)、安全和观察服务，即使你对如何实现它们了如指掌，也很难采用。“<a class="ae jg" href="https://istio.io/blog/2018/delayering-istio/delayering-istio/#don-t-optimize-layers-remove-them" rel="noopener ugc nofollow" target="_blank">不要优化图层，删除图层</a>”是我们现在听到很多的一个术语。但是如果我们不需要优化，而不是删除它，那又怎么样呢？这句话是相当时髦的话，但实际上，它是真实的，如果你跟进到这篇文章的结尾，你自己会发现它是多么容易。相信我！</p><p id="bbba" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">2017年，我们将推出许多工具和编排器，这在管理软件开发(基础设施即软件)的动态和灵活变化方面对我们有很大帮助。其中一些是Docker、Kubernetes、Istio……就在几天前，Istio发布了1.0.0版本，并承诺它们将成为服务网格世界中的重要工具，帮助我们轻松构建微服务堆栈。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lp"><img src="../Images/0a7d4ab507fc06114a0f33cf106a6b09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D77SdcT9mRHt_7fCDm3GUg.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="http://layer5.io/service-meshes/" rel="noopener ugc nofollow" target="_blank">http://layer5.io/service-meshes</a></figcaption></figure></div><div class="ab cl jh ji hc jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hn ho hp hq hr"><p id="8ed0" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">要从大的东西开始，我们需要先设置并运行小的东西，我从JBoss演示中心和Redhat演示中心选择了CoolStore项目来演示我所说的内容。这个项目完全是在Java栈中实现的。我借用这些想法，从零开始建立。NET Core 2.x和NodeJS因为的流行。NET在我的公司和一般在我的国家。</p><p id="1e1a" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">在本文的剩余部分，我们将把下面的Coolstore项目部署到AKS</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lu"><img src="../Images/2b947525b2abfba162a2060c2be7502c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sPIxhXMMhDnbtXSh06g6Ag.png"/></div></div></figure></div><div class="ab cl jh ji hc jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hn ho hp hq hr"><h1 id="3142" class="jo jp hu bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl dt translated">先决条件</h1><ul class=""><li id="36e5" class="lv lw hu ko b kp kq kt ku kx lx lb ly lf lz lj ma mb mc md dt translated">Windows 10</li><li id="48a6" class="lv lw hu ko b kp me kt mf kx mg lb mh lf mi lj ma mb mc md dt translated">Windows子系统Linux (WSL — Ubuntu OS)</li><li id="85c9" class="lv lw hu ko b kp me kt mf kx mg lb mh lf mi lj ma mb mc md dt translated">Windows docker(启用Kubernetes)</li><li id="0576" class="lv lw hu ko b kp me kt mf kx mg lb mh lf mi lj ma mb mc md dt translated">具有有效订阅的Azure帐户</li><li id="66a6" class="lv lw hu ko b kp me kt mf kx mg lb mh lf mi lj ma mb mc md dt translated">库贝特尔</li><li id="d688" class="lv lw hu ko b kp me kt mf kx mg lb mh lf mi lj ma mb mc md dt translated">舵</li><li id="ce72" class="lv lw hu ko b kp me kt mf kx mg lb mh lf mi lj ma mb mc md dt translated">istioctl</li><li id="d353" class="lv lw hu ko b kp me kt mf kx mg lb mh lf mi lj ma mb mc md dt translated">Azure CLI 2.0 (az)</li></ul></div><div class="ab cl jh ji hc jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hn ho hp hq hr"><h2 id="bf4b" class="mj jp hu bd jq mk ml mm ju mn mo mp jy kx mq mr kc lb ms mt kg lf mu mv kk mw dt translated"><strong class="ak">第一步:</strong>安装Docker for Windows，启用Kubernetes、Ubuntu WSL、kubectl、istioctl、helm和az</h2><p id="3cfd" class="pw-post-body-paragraph km kn hu ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj hn dt translated"><strong class="ko hv">第二步:</strong>创建coolstore AKS，启用RBAC。最少应有3个节点(istio试运行需要)</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mx"><img src="../Images/6ac029204312c3de87b7a7a9b646fc21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y5cENk7jPJQPWr3iESggGQ.png"/></div></div></figure><p id="f20d" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">并确保检查启用RBAC如下</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff my"><img src="../Images/e14c93af2fb8eb76032b5c797c451974.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lUHO_7Gtp9fmhn05A_JuXg.png"/></div></div></figure><p id="b60a" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">按照后续步骤完成集群的创建。它通常需要大约20到30分钟。</p><p id="ab2e" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">完成后，我们应该能够通过以下步骤访问仪表板</p><pre class="lq lr ls lt fq mz na nb nc aw nd dt"><span id="6aad" class="mj jp hu na b fv ne nf l ng nh">&gt; az aks get-credentials --resource-group coolstore --name coolstore<br/>&gt; kubectl proxy</span></pre><p id="7ec4" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">但是现在，您将无法访问Kubernetes仪表板。那么我们需要增加几个步骤</p><pre class="lq lr ls lt fq mz na nb nc aw nd dt"><span id="56c4" class="mj jp hu na b fv ne nf l ng nh">&gt; kubectl create clusterrolebinding kubernetes-dashboard -n kube-system --clusterrole=cluster-admin --serviceaccount=kube-system:kubernetes-dashboard</span></pre><p id="2c0c" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">随后获取令牌</p><pre class="lq lr ls lt fq mz na nb nc aw nd dt"><span id="4f3e" class="mj jp hu na b fv ne nf l ng nh">&gt; kubectl get secret $(kubectl get serviceaccount kubernetes-dashboard -n kube-system -o jsonpath="{.secrets[0].name}") -n kube-system -o jsonpath="{.data.token}" | base64 --decode</span></pre><p id="3af1" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">将令牌粘贴到登录页面作为<a class="ae jg" href="http://localhost:8001/api/v1/namespaces/kube-system/services/kubernetes-dashboard/proxy/#!/login" rel="noopener ugc nofollow" target="_blank">http://localhost:8001/API/v1/namespaces/kube-system/services/kubernetes-dashboard/proxy/#！/登录</a></p><p id="90db" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated"><strong class="ko hv">第三步:</strong>在AKS上安装Istio</p><p id="9654" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">由于现在helm的一些超时问题，所以我不能使用helm来安装，而是将其导出到yaml文件，然后使用kubectl在AKS上创建它。下载istio 1.0.0，然后压缩到机器上的某个地方。按照命令将其导出并部署到AKS</p><pre class="lq lr ls lt fq mz na nb nc aw nd dt"><span id="b130" class="mj jp hu na b fv ne nf l ng nh">&gt; helm template install/kubernetes/helm/istio --namespace istio-system &gt; istio-dump.yaml<br/>kubectl create -f istio-dump.yaml</span><span id="6982" class="mj jp hu na b fv ni nf l ng nh">&gt; kubectl create -f istio-dump.yaml</span></pre><p id="047c" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated"><strong class="ko hv">步骤4: </strong>在AKS上安装Coolstore</p><p id="d5ab" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">使用以下命令获取内部istio-ingress IP</p><pre class="lq lr ls lt fq mz na nb nc aw nd dt"><span id="1342" class="mj jp hu na b fv ne nf l ng nh">&gt; kubectl get services istio-ingressgateway -n istio-system -o=jsonpath={.spec.clusterIP}</span></pre><p id="25fa" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">创建内容如下的<code class="eh nj nk nl na b">values.aks.yaml</code></p><pre class="lq lr ls lt fq mz na nb nc aw nd dt"><span id="92f8" class="mj jp hu na b fv ne nf l ng nh">gateway:</span><span id="2f17" class="mj jp hu na b fv ni nf l ng nh">  ip: 10.0.106.82</span></pre><p id="da66" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">然后运行舵命令</p><pre class="lq lr ls lt fq mz na nb nc aw nd dt"><span id="ffe4" class="mj jp hu na b fv ne nf l ng nh">&gt; helm template deploys/charts/coolstore -f deploys/charts/coolstore/values.aks.yaml &gt; deploys/k8s/dev-all-in-one.aks.yaml</span></pre><p id="8854" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">最后，我们用这个命令注入sidecar</p><pre class="lq lr ls lt fq mz na nb nc aw nd dt"><span id="a404" class="mj jp hu na b fv ne nf l ng nh">&gt; istioctl kube-inject -f deploys/k8s/dev-all-in-one.aks.yaml | kubectl apply -f -</span></pre><p id="504b" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated"><strong class="ko hv">步骤5: </strong>放置主机文件的映射</p><p id="1800" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">使用以下命令获取istio入口上的外部IP</p><pre class="lq lr ls lt fq mz na nb nc aw nd dt"><span id="477e" class="mj jp hu na b fv ne nf l ng nh">&gt; kubectl get svc -n istio-system</span></pre><p id="4cc2" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">它应该打印出类似这样的内容</p><pre class="lq lr ls lt fq mz na nb nc aw nd dt"><span id="f546" class="mj jp hu na b fv ne nf l ng nh">...<br/>istio-ingressgateway       LoadBalancer   10.106.52.19     localhost     80:31380/TCP,443:31390/TCP,31400:31400/TCP,15011:32131/TCP,8060:30958/TCP,15030:31983/TCP,15031:30365/TCP   8d<br/>...</span></pre><p id="41db" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">然后，我们只需要将10.106.52.19复制到C:\ Windows \ System32 \ drivers \ etc \ hosts文件，如下所示</p><pre class="lq lr ls lt fq mz na nb nc aw nd dt"><span id="ac09" class="mj jp hu na b fv ne nf l ng nh">10.106.52.19 id.coolstore.aks<br/>10.106.52.19 api.coolstore.aks<br/>10.106.52.19 coolstore.aks</span></pre><p id="1f4d" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">从现在开始，我们可以通过<a class="ae jg" href="http://coolstore.aks" rel="noopener ugc nofollow" target="_blank"> http://coolstore.aks </a>访问网站，通过<a class="ae jg" href="http://id.coolstore.aks" rel="noopener ugc nofollow" target="_blank">http://id . cool store . aks</a>访问身份提供者，通过<a class="ae jg" href="http://api.coolstore.aks" rel="noopener ugc nofollow" target="_blank">http://api . cool store . aks</a>访问API网关</p><p id="53a1" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">假设我们访问http://API . cool store . aks/cart/swagger，那么我们应该看到</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nm"><img src="../Images/0719a0499421f893df038a6318c97133.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HhJ_a1WIXkc1wyn9SIn-7Q.png"/></div></div></figure><p id="59f0" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">以及<a class="ae jg" href="http://coolstore.aks" rel="noopener ugc nofollow" target="_blank">网站http://coolstore.aks </a></p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nm"><img src="../Images/a8aa2c25f1511ba5d2da45d9acbe9f44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wJ0bhx6fJJXHUUTM7JTD7w.png"/></div></div></figure><p id="05ca" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">你好。我们结束了。让我们探索并享受服务网格的世界。</p></div><div class="ab cl jh ji hc jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hn ho hp hq hr"><h1 id="769f" class="jo jp hu bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl dt translated">最后的想法</h1><p id="c300" class="pw-post-body-paragraph km kn hu ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj hn dt translated">2018年，我们有足够的工具来实现我们的梦想。我们有Docker来打包你的应用程序，这样我们就不用担心用哪种编程语言来实现应用程序了。这意味着我们在软件开发中具有可移植性。从现在开始，我们可以带来这个映像，并开始在任何平台上随时随地运行它(云原生应用)。但是，我们需要一些工具来控制和编排云原生平台中的容器。这就是库伯内特公司发挥作用的地方。我们有工具来控制和帮助我们编排我们的容器，以正确的方式扮演正确的角色，并根据我们在清单文件中定义的正确策略。最终是什么让它与众不同？服务网格将帮助您控制您的流量，保护通信，定义服务连接的方式，并从本质上观察您的活动。</p><p id="c2d3" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">我们将在未来几年看到服务网格的出现。还有我今年接下来的几篇关于这个话题的文章。</p><blockquote class="nn no np"><p id="7ed9" class="km kn nq ko b kp lk kr ks kt ll kv kw nr lm kz la ns ln ld le nt lo lh li lj hn dt translated"><em class="hu">本文的源代码可以在https://github.com/vietnam-devs/coolstore-microservices</em><a class="ae jg" href="https://github.com/vietnam-devs/coolstore-microservices" rel="noopener ugc nofollow" target="_blank"/>找到</p></blockquote><p id="3d25" class="pw-post-body-paragraph km kn hu ko b kp lk kr ks kt ll kv kw kx lm kz la lb ln ld le lf lo lh li lj hn dt translated">感谢阅读！如果你喜欢这篇文章，请点击👏符号，以便其他人可以看到它。</p></div></div>    
</body>
</html>