<html>
<head>
<title>Kerberoasting!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kerberoasting！</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/kerberoasting-f080cd03e8cd?source=collection_archive---------3-----------------------#2018-08-30">https://medium.com/hackernoon/kerberoasting-f080cd03e8cd?source=collection_archive---------3-----------------------#2018-08-30</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="934b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们在这里谈论一些旧的安全性。Kerberos！这是一对夫妇岁，但可悲的是仍然工作。Kerberos是windows和ad网络的身份验证系统。有一个漏洞可以让我们直接从域控制器获得加密不良的有价值的登录散列，这是在你有一个经过验证的用户时完成的，所以这不是主要的方法，但一旦你有了立足点，你就可以转向一个更有用的帐户。让我们简要分析一下kerberos是如何工作的，这是从<a class="ae jp" href="https://adsecurity.org/?p=3458" rel="noopener ugc nofollow" target="_blank">https://adsecurity.org/?p=3458</a>借来的</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/6f461df11b5278f05ba79dc3e6166de9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ven-WI5gTwYyuVlP-zayqg.png"/></div></div></figure><p id="8410" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">用户使用用户名和密码登录。</p><p id="20d2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">1a。密码转换为NTLM哈希，时间戳用哈希加密，并作为身份验证票(TGT)请求(AS-REQ)中的身份验证者发送到KDC。<br/> 1b。域控制器(KDC)检查用户信息(登录限制、组成员等)&amp;创建票据授予票据(TGT)。</p><p id="9c75" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">2.TGT经过加密、签名并交付给用户(AS-REP)。<em class="kc">只有域中的Kerberos服务(KRBTGT)可以打开和读取TGT数据。</em></p><p id="a2c2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> 3。当请求票据授予服务(TGS)票据(TGS-REQ)时，用户向DC出示TGT。DC打开TGT &amp;验证PAC校验和——如果DC可以打开票&amp;校验和检验，TGT =有效。TGT中的数据被有效地复制以创建TGS票证。</strong></p><p id="9de5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">4.TGS使用目标服务帐户的NTLM密码散列加密并发送给用户(TGS代表)。</p><p id="57a9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">5.用户通过适当的端口连接到托管服务的服务器，并提交TGS (AP-REQ)。该服务使用其NTLM密码散列来打开TGS票证。</p><p id="182a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">6.如果客户端要求相互身份验证(想想MS15–011:二月份添加UNC强化的组策略补丁)。</p><p id="8234" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">除非需要PAC验证(很少)，否则该服务接受TGS票证中的所有数据，而不与DC通信。</p><p id="83aa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好吧，那么让我们就在这里开始吧。我们将在装有powershell和active directory模块的windows平台上完成这项工作。<br/>返回结果将类似于“MSSQLSvc/adsmsdb 01 . ad security . org:1433”，那么“MSSQLSvc”就是SPN类型。SPN实际上是初始扫描的重要部分，因为我们希望找到特定类型的SPN。如:<br/>AGP server:往往对所有GPO拥有完全控制权。MSSQL/MSSQLSvc:对SQL服务器的管理权限，该服务器通常包含有趣的数据。<br/> FIMService:通常对多个AD林具有管理权限。<br/> STS:可以提供后门VMWare访问的VMWare SSO服务。<br/>要进行实际的查询，我们可以使用Get-ADUser cmdlet:</p><blockquote class="kd ke kf"><p id="d197" class="ir is kc it b iu iv iw ix iy iz ja jb kg jd je jf kh jh ji jj ki jl jm jn jo hn dt translated">get-aduser-filter { admin count-eq1 }-prop * | select name，created，passwordlastset，lastlogondate</p></blockquote><p id="f646" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们还可以使用PowerView的Get-NetUser cmdlet:</p><blockquote class="kd ke kf"><p id="b78a" class="ir is kc it b iu iv iw ix iy iz ja jb kg jd je jf kh jh ji jj ki jl jm jn jo hn dt translated">Get-NetUser -AdminCount |选择名称，创建时间，pwdlastset，lastlogon</p></blockquote><p id="c4f9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦我们有了一个SPN，我们就可以查询易受攻击的散列类型</p><blockquote class="kd ke kf"><p id="17e2" class="ir is kc it b iu iv iw ix iy iz ja jb kg jd je jf kh jh ji jj ki jl jm jn jo hn dt translated">$ SPN name = ' MSSQLSvc/adsmsdb 01 . ads security . org:1433 '<br/>Add-Type-assembly name System。IdentityModel <br/>新对象系统。identity model . tokens . Kerberos requestorsecuritytoken-argument list $ SPN name</p></blockquote><p id="5ebf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，我们可以使用“$ klist”来获取散列的列表，从那里我们可以使用mimikatz来导出。</p><blockquote class="kd ke kf"><p id="0e03" class="ir is kc it b iu iv iw ix iy iz ja jb kg jd je jf kh jh ji jj ki jl jm jn jo hn dt translated">$ mimikatz <br/> $ kerberos::列表/导出</p></blockquote><p id="5d4b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，我们只需将hash放入带有单词列表的hashcat中，就可以开始了。<br/>遗憾的是，这一漏洞已经存在4年多了，仍然存在。为了缓解这一问题，建议确保服务帐户密码超过25个字符(并且不容易被猜到)。此外，启用日志记录，然后将该日志信息放入SIEM，您可以在其中查找特定的“4769事件”和Ticket_Encryption_Type=0x17。祝你好运！</p><p id="7a9a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">链接:【https://adsecurity.org/?p=2293】https://adsecurity.org/?p=3466:“使用Kerberoast破解Kerberos TGS票证——利用Kerberos危害活动目录域”<br/>:“偷偷摸摸的持久性活动目录诡计#18:为以后的Kerberoast删除管理帐户上的SPN。”</p></div></div>    
</body>
</html>