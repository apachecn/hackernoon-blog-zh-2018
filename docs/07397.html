<html>
<head>
<title>The Ultimate ENS and ĐApp Tutorial</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ENS和应用程序终极教程</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/the-ultimate-ens-and-%C4%91app-tutorial-cc5c6f41b9c9?source=collection_archive---------30-----------------------#2018-08-30">https://medium.com/hackernoon/the-ultimate-ens-and-%C4%91app-tutorial-cc5c6f41b9c9?source=collection_archive---------30-----------------------#2018-08-30</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="2686" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">原载于</em><a class="ae jq" href="https://www.toptal.com/ethereum/ethereum-name-service-dapp-tutorial" rel="noopener ugc nofollow" target="_blank"><em class="jp">【www.toptal.com】</em></a><em class="jp">，作者</em> <a class="ae jq" href="https://www.toptal.com/resume/radek-ostrowski" rel="noopener ugc nofollow" target="_blank"> <em class="jp">拉德克·奥斯特罗夫斯基</em> </a> <em class="jp">。</em></p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/617c36579f585756bf58fb6c30cd2b62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j0p_vX2_ls2_I81-gfQf5w.png"/></div></div></figure><p id="bbc8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在区块链系列的前一篇文章中，我向您介绍了智能合同开发，但是没有涉及如何开发分布式应用程序(dapp，风格化的app)。这一次，我想集中讨论这一点。然而，为了使我们的工作更有意义，让我们建立一个服务，允许人们用一个区块链交易创建免费的以太坊子域。</p><p id="b04e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们从解释以太坊名称服务(ENS)开始这个应用教程。</p><h1 id="91e0" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">以太坊名称服务</h1><p id="acc8" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">ENS是区块链常用域名系统(DNS)的等价物。这两者都可以用电话簿来比喻。它们充当查找服务，将人类可读的名称翻译成它们的底层表示形式——在DNS和ENS的情况下，是计算机地址而不是电话号码。</p><p id="4cbd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">DNS将网站地址的域名转换为互联网协议(IP)地址。它们很容易被计算机理解，但对我们人类来说就不那么方便了。例如，在撰写本文时，<code class="eh lg lh li lj b">toptal.com</code>代表<code class="eh lg lh li lj b">35.186.228.167</code>——您更愿意记住并键入哪个？</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="f624" class="lo ke hu lj b fv lp lq l lr ls">$ ping toptal.com PING toptal.com (35.186.228.167): 56 data bytes</span></pre><p id="d3e6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">ENS服务于相同的目的，但不是IP地址，而是域被映射到以太坊地址，它是42个字符长。顶级ENS域名是<code class="eh lg lh li lj b">.eth</code>。</p><p id="83bc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有趣的是，相当于DNS的中央注册中心被表示为一组<a class="ae jq" href="https://www.toptal.com/ethereum-smart-contract" rel="noopener ugc nofollow" target="_blank">智能合同</a>。这些都是在以太坊区块链上以分布式的方式运行，“……这意味着它不会遭受DNS系统的不安全性。正如ENS网站所描述的那样，“你可以放心，你输入的名字是按照它们主人的意图工作的。”。</p><p id="7ec4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是ENS架构的高级概述。该服务的主干是ENS注册管理机构智能合同，它将域名的表示映射到ENS解析器的智能合同。这些地址依次映射到目标以太坊地址。看一下这个图，如果一个应用程序想要解析ENS地址<code class="eh lg lh li lj b">radek.freedomain.eth</code>，它将首先向ENS注册中心查询相应的ENS解析器，然后向解析器请求映射以太坊地址，解析器将以<code class="eh lg lh li lj b">0x0987...</code>作为响应。欲了解更多信息，请点击查看ENS文档<a class="ae jq" href="http://docs.ens.domains/en/latest/introduction.html" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/7be793fc0bcd993b0d7e157f25bf3132.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ITH-9elaZG6He_1T.png"/></div></div></figure><h1 id="4b85" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated"><code class="eh lg lh li lj b">.eth</code> ENS域</h1><p id="e934" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">ENS于2017年5月4日推出，目前(第一阶段)，其域名必须包含七个或更多字符。不可能使用有六个字符的<code class="eh lg lh li lj b">toptal.eth</code>，所以我们将使用我买的ENS域名:<code class="eh lg lh li lj b">freedomain.eth</code>。</p><p id="9b2f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">任何人都可以注册一个<code class="eh lg lh li lj b">.eth</code>域名，方法是在维克瑞拍卖过程中锁定一些以太网，该过程由部署的智能合同介导。拍卖分为两个阶段<code class="eh lg lh li lj b">bid</code>和<code class="eh lg lh li lj b">reveal</code>，分别持续三天和两天。</p><p id="1ebb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，域名拍卖必须在第一次出价的同时开始。一旦开始运行，任何人都可以出价。一旦第一阶段完成，新的出价不再被接受，然后参与者必须公开他们的出价。出价最高的获胜者只需匹配第二高的出价，其余的乙醚将被退还。所有剩下的参与者也会得到退款。但重要的是要注意，如果你不及时透露你的出价，你出价的乙醚就会丢失。</p><p id="b5f8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦你被确认为获胜者，你只需要<code class="eh lg lh li lj b">finalize</code>拍卖并设置<code class="eh lg lh li lj b">resolver</code>和<code class="eh lg lh li lj b">target</code>地址。简单？如果你是以太坊的新手，可能就没那么多了。有几个工具可以帮助你——比如<a class="ae jq" href="https://mycrypto.com/ens" rel="noopener ugc nofollow" target="_blank"> MyCrypto </a>、<a class="ae jq" href="https://www.myetherwallet.com/#ens" rel="noopener ugc nofollow" target="_blank">my ther wallet</a>和<a class="ae jq" href="https://manager.ens.domains/" rel="noopener ugc nofollow" target="_blank">ENS Manager</a>——但这仍然是一个多阶段的过程。(我也是刚刚发现<a class="ae jq" href="https://enslisting.com/" rel="noopener ugc nofollow" target="_blank"> ENSListing </a>，看起来更人性化一点。)</p><p id="7058" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">子域呢？它们更简单吗？让我们看一看。</p><h1 id="ae10" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">ENS子域</h1><p id="04c7" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">首先，子域有什么用？我的最佳猜测是，这与DNS中的子域名是一样的。它们还可以给用户更多的组织感觉，其中域代表组织，子域类似于电子邮件地址的结构:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="7e97" class="lo ke hu lj b fv lp lq l lr ls"><a class="ae jq" href="https://www.toptal.com/cdn-cgi/l/email-protection" rel="noopener ugc nofollow" target="_blank">[email protected]</a> =&gt; radek.freedomain.eth</span></pre><p id="fdd6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">目前由<a class="ae jq" href="https://tenzorum.org/" rel="noopener ugc nofollow" target="_blank"> Tenzorum项目</a>实现的一个新用例是使用你的子域作为用户名/登录以太坊应用程序。想象一下，有一个你已经玩了一段时间的App游戏。即使两个设备使用不同的密钥对，也可以在旅途中用笔记本电脑和手机上相同的登录信息继续玩游戏。这是如何实现的:</p><ul class=""><li id="0ea4" class="lt lu hu it b iu iv iy iz jc lv jg lw jk lx jo ly lz ma mb dt translated">使用您的子域登录应用程序，例如<code class="eh lg lh li lj b">radek.tenz-id.eth</code></li><li id="511b" class="lt lu hu it b iu mc iy md jc me jg mf jk mg jo ly lz ma mb dt translated">该应用程序要求您签署一条消息，以验证您是相应私钥的持有者</li><li id="d186" class="lt lu hu it b iu mc iy md jc me jg mf jk mg jo ly lz ma mb dt translated">该应用程序通过询问您的个人钱包智能合约来检查您是否有权登录。(你猜对了，ENS子域代表的登录是指向你个人钱包的地址。)</li></ul><p id="78b7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这样做的额外好处是，即使您丢失了设备(和设备上的私钥),您也可以继续玩游戏，因为您不会失去访问个人钱包的权限。</p><p id="cac2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">子域映射名称到地址的方式和域名完全一样，但是你不需要通过拍卖过程来创建一个。幸运的是，ENS子域名也没有最小长度限制。</p><p id="4909" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要注册一个子域，作为先决条件，你必须是该域的所有者。要创建或更新子域，您必须调用ENS注册中心智能合同上的<code class="eh lg lh li lj b">setSubnodeOwner</code>。一旦成功，与域相同的逻辑也适用:所有者必须设置<code class="eh lg lh li lj b">resolver</code>和<code class="eh lg lh li lj b">target</code>地址。</p><p id="a518" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果我们可以自动化这一过程并为用户简化这一过程，会怎么样？我已经创建了[一个智能合同，正是这样做的——前面提到的<code class="eh lg lh li lj b">EnsSubdomainFactory.sol</code>——允许任何人用一个区块链呼叫创建一个子域。然而，由于本文的重点是构建应用程序，我将把它留给您作为练习来研究。</p><h1 id="3ade" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">分布式应用程序</h1><p id="1b9c" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">App只是一个与区块链后端交互的前端网站。该网站必须在支持以太坊的浏览器上浏览，如<a class="ae jq" href="https://github.com/ethereum/mist" rel="noopener ugc nofollow" target="_blank">迷雾</a>、<a class="ae jq" href="https://www.parity.io/" rel="noopener ugc nofollow" target="_blank">奇偶性</a>或手机应用<a class="ae jq" href="https://www.cipherbrowser.com/" rel="noopener ugc nofollow" target="_blank">密码</a>；或者通过安装<a class="ae jq" href="https://www.toptal.com/ethereum/one-click-login-flows-a-metamask-tutorial" rel="noopener ugc nofollow" target="_blank"> MetaMask </a>插件。</p><p id="f449" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">与传统的后端服务器和数据库不同，读写调用是直接对以太坊区块链进行的。这些调用可以使用JSON RPC协议来完成，但幸运的是我们有一个库，它以一种开发人员友好的方式包装了这些调用。</p><p id="6072" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">认识Web3。在不同的编程语言中有几个版本，但我们将使用JavaScript版本，<a class="ae jq" href="https://github.com/ethereum/web3.js" rel="noopener ugc nofollow" target="_blank"> web3.js </a>。另外，<code class="eh lg lh li lj b">web3</code>实例是由浏览器注入的，或者在我们这里的方法中，是由元掩码插件注入的。</p><h1 id="5b71" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">HTML网站</h1><p id="4040" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">现在，我们可以开始着手如何构建一个应用程序了。在我们的例子中，我们所需要的只是一个包含五个元素的简单表单:</p><ul class=""><li id="5218" class="lt lu hu it b iu iv iy iz jc lv jg lw jk lx jo ly lz ma mb dt translated">子域名称的输入字段</li><li id="993f" class="lt lu hu it b iu mc iy md jc me jg mf jk mg jo ly lz ma mb dt translated">包含可用域的下拉列表</li><li id="e535" class="lt lu hu it b iu mc iy md jc me jg mf jk mg jo ly lz ma mb dt translated">子域新所有者的输入字段</li><li id="39e3" class="lt lu hu it b iu mc iy md jc me jg mf jk mg jo ly lz ma mb dt translated">目标地址的输入字段</li><li id="d79f" class="lt lu hu it b iu mc iy md jc me jg mf jk mg jo ly lz ma mb dt translated">提交按钮</li></ul><p id="1e92" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我用<a class="ae jq" href="https://getbootstrap.com/" rel="noopener ugc nofollow" target="_blank"> Bootstrap </a>给它增加了一点。(请记住，就UI功能而言，应用程序与任何其他web应用程序一样，所以我们不需要应用程序框架本身(<em class="jp"/>)——Bootstrap等常规web技术在这里做得非常好。)下面是它的样子:</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/bcf80b36949fdfc118704bc7222f94d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*81XdmRMPoG3_ym__.png"/></div></div></figure><p id="5791" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">只是一个普通的<a class="ae jq" href="https://github.com/radek1st/ens-subdomain-factory/blob/master/docs/index.html" rel="noopener ugc nofollow" target="_blank"> HTML网站</a>所以就不细说了。所有的神奇都发生在JavaScript文件<a class="ae jq" href="https://github.com/radek1st/ens-subdomain-factory/blob/master/docs/dapp.js" rel="noopener ugc nofollow" target="_blank"> dapp.js </a>中。</p><h1 id="d1d7" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">JavaScript和Web3</h1><p id="1d0e" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">要构建任何通用的应用程序，您需要的是:</p><ul class=""><li id="f874" class="lt lu hu it b iu iv iy iz jc lv jg lw jk lx jo ly lz ma mb dt translated">Web3实例(例如，具有元掩码提供程序)</li><li id="ca9b" class="lt lu hu it b iu mc iy md jc me jg mf jk mg jo ly lz ma mb dt translated">从区块链读取的方法(例如以太坊天平)</li><li id="f873" class="lt lu hu it b iu mc iy md jc me jg mf jk mg jo ly lz ma mb dt translated">给区块链写信的一种方式(如发送以太)</li><li id="937c" class="lt lu hu it b iu mc iy md jc me jg mf jk mg jo ly lz ma mb dt translated">读取智能合同的方式(例如，ENS域名所有者或ERC20令牌余额)</li><li id="b265" class="lt lu hu it b iu mc iy md jc me jg mf jk mg jo ly lz ma mb dt translated">写入智能合约的方法(例如，创建子域或转移ERC20令牌)</li></ul><p id="b154" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，为了让您的分散式应用程序与智能合约进行交互，您需要:</p><ul class=""><li id="d1b8" class="lt lu hu it b iu iv iy iz jc lv jg lw jk lx jo ly lz ma mb dt translated">应用程序二进制接口(ABI)</li><li id="7cab" class="lt lu hu it b iu mc iy md jc me jg mf jk mg jo ly lz ma mb dt translated">智能合约的部署地址</li></ul><p id="dea7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将依次介绍上述内容，并向您展示我们如何将它们应用到我们的应用程序中。</p><p id="b84a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">开发应用程序最便捷的方式是使用Firefox或Chrome的MetaMask插件。有关如何安装的说明，请重新阅读<a class="ae jq" href="https://www.toptal.com/ethereum-smart-contract/time-locked-wallet-truffle-tutorial#distributed-application-setup" rel="noopener ugc nofollow" target="_blank">上一篇文章</a>。</p><p id="5ac4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在撰写本文时，有两个相关的web3.js版本需要在开发去中心化的应用程序时考虑:0.20版本的<a class="ae jq" href="https://github.com/ethereum/wiki/wiki/JavaScript-API" rel="noopener ugc nofollow" target="_blank">和尚未完全发布但已经广泛使用的版本</a><a class="ae jq" href="http://web3js.readthedocs.io/en/1.0/" rel="noopener ugc nofollow" target="_blank"> 1.0.0版本的</a>。在本文中，我们使用的是后一个版本。</p><p id="6250" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对<code class="eh lg lh li lj b">web3</code>实例的检查发生在<code class="eh lg lh li lj b">initWeb3()</code>函数中。这也适用于即将到来的MetaMask <a class="ae jq" rel="noopener" href="/metamask/https-medium-com-metamask-breaking-change-injecting-web3-7722797916a8"> web3注入更改</a>:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="f711" class="lo ke hu lj b fv lp lq l lr ls">window.addEventListener('load', () =&gt; { // If web3 is not injected if (typeof web3 === 'undefined') { // Listen for provider injection window.addEventListener('message', ({ data }) =&gt; { if (data &amp;&amp; data.type &amp;&amp; data.type === 'ETHEREUM_PROVIDER_SUCCESS') { // Use injected provider web3 = new Web3(ethereum); // ... } else { // No web3 instance available. Show a popup // ... } }); // Request provider window.postMessage({ type: 'ETHEREUM_PROVIDER_REQUEST' }, '*'); } // If web3 is injected, use its provider else { web3 = new Web3(web3.currentProvider); // ... } });</span></pre><p id="acc4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果没有找到<code class="eh lg lh li lj b">web3</code>实例，我们可以向用户显示一个通知:</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/090b3682ea1ca1bb889c5a31df3688dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XMdbVp6tmdbUQL4p.png"/></div></div></figure><h2 id="5672" class="lo ke hu bd kf mh mi mj kj mk ml mm kn jc mn mo kr jg mp mq kv jk mr ms kz mt dt translated">与区块链互动</h2><p id="f8bb" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">首先，让我们获取当前加载的以太坊账户，正如在<code class="eh lg lh li lj b">loadAccount()</code>函数中所做的:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="b8f5" class="lo ke hu lj b fv lp lq l lr ls">web3.eth.getAccounts(function(error, accounts) { if (error) { // handle error } else { DApp.currentAccount = accounts[0]; // ... } });</span></pre><p id="8fe6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，我们可以用当前帐户的地址自动填充新所有者和目标的输入字段。</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/fab389f9f096909779fb7605a88b93bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*K6bdt18XCSZW2MP4.png"/></div></div></figure><p id="c35e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们的应用程序中，我们不需要与余额交互，但为了完整起见，下面是如何检查帐户余额:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="530e" class="lo ke hu lj b fv lp lq l lr ls">web3.eth.getBalance(DApp.currentAccount, function(error, ethBalance) { if (error) { // handle error } else { console.log("Eth balance", ethBalance); } });</span></pre><p id="3233" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">…以下是发送乙醚的方法:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="6a54" class="lo ke hu lj b fv lp lq l lr ls">web3.eth.sendTransaction( { from: DApp.currentAccount, to: receiverAddress, value: ethValue }, function(error, txHash) { if (error) { // handle error } else { console.log("Transaction hash", txHash); } } );</span></pre><p id="9068" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，您必须将<code class="eh lg lh li lj b">from</code>和<code class="eh lg lh li lj b">to</code>字段指定为以太网地址，以及您想要发送的以太网的<code class="eh lg lh li lj b">value</code>。这用卫来表示——比如<code class="eh lg lh li lj b">1000000000000000000</code>就是一个以太。</p><h2 id="b314" class="lo ke hu bd kf mh mi mj kj mk ml mm kn jc mn mo kr jg mp mq kv jk mr ms kz mt dt translated">与智能合约交互</h2><p id="248b" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">为了与智能合约进行交互，我们首先必须创建一个代理对象。为此，我们需要它的<a class="ae jq" href="https://solidity.readthedocs.io/en/develop/abi-spec.html" rel="noopener ugc nofollow" target="_blank">应用程序二进制接口</a> (ABI)，它指定了可用的操作。</p><p id="9baf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们还需要在区块链上部署智能合约的以太坊地址。</p><p id="0919" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在应用程序中，我们正在与一个智能契约进行交互，这是我们的<a class="ae jq" href="https://github.com/radek1st/ens-subdomain-factory/blob/master/contracts/EnsSubdomainFactory.sol" rel="noopener ugc nofollow" target="_blank"> EnsSubdomainFactory </a>:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="8f2f" class="lo ke hu lj b fv lp lq l lr ls">factoryAbi: [...], // Local factoryAddress: "0x9fbda871d559710256a2502a2517b794b482db40", ...</span></pre><p id="0cda" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">合同在<code class="eh lg lh li lj b">initContracts()</code>功能中发起:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="be57" class="lo ke hu lj b fv lp lq l lr ls">DApp.factoryContract = new web3.eth.Contract(DApp.factoryAbi, DApp.factoryAddress);</span></pre><p id="baf6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">设置完成后，我们终于可以打电话了。对于我们的用例，我们需要知道特定域和子域的当前所有者是谁，所以我们的<code class="eh lg lh li lj b">checkSubdomainOwner()</code>函数看起来是这样的:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="6314" class="lo ke hu lj b fv lp lq l lr ls">DApp.factoryContract.methods.subdomainOwner(subdomain, domain).call()</span></pre><p id="0e46" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注意，这是一个只读操作:我们使用的是<code class="eh lg lh li lj b">call()</code>函数，它可以自由执行——也就是说，它不消耗任何气体。</p><p id="ede3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就是我们的应用程序将如何显示给定的域名是可用的，被当前用户占用或拥有的:</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/ea5fd58eee9117e348d8b771bd7524d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HuqQMvBIjm-sEz4F.png"/></div></div></figure><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/4cdf4e7fccac53559f14ebd3ad0c0923.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ypSN8_3FmqNBhrRB.png"/></div></div></figure><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/a75fbc6bad2afab171f09e6415853909.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hJv2GzZlZFN3Tbe4.png"/></div></div></figure><p id="ab63" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们需要做的最后一个区块链调用是创建或更新子域。我们在<code class="eh lg lh li lj b">newSubdomain()</code>函数内部做这件事:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="de39" class="lo ke hu lj b fv lp lq l lr ls">DApp.factoryContract.methods.newSubdomain( subdomain, domain, owner, target).send( { gas: 150000, from: DApp.currentAccount }, function(error, txHash) { if (error) { // handle error } else { console.log("Transaction hash", txHash); } } );</span></pre><p id="0d72" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这一次，我们向函数传递四个参数:<code class="eh lg lh li lj b">subdomain</code>、<code class="eh lg lh li lj b">domain</code>、<code class="eh lg lh li lj b">owner</code>和<code class="eh lg lh li lj b">target</code>。它们不言自明。</p><p id="cc5a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注意，我们使用的是<code class="eh lg lh li lj b">send()</code>而不是<code class="eh lg lh li lj b">call()</code>。这是因为这是一个写操作，会改变区块链的状态，也会消耗一些乙醚气体。我们包含的一个额外参数是<code class="eh lg lh li lj b">gas</code>，它表示交易的气体限制。如果事务的执行成本超过了限制，我们希望它被恢复。</p><h2 id="e168" class="lo ke hu bd kf mh mi mj kj mk ml mm kn jc mn mo kr jg mp mq kv jk mr ms kz mt dt translated">监听事件</h2><p id="91c2" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">我们想知道我们的交易何时成功完成，并通知用户他们的子域可以使用了。</p><p id="f42d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">factory smart contract定义了一个在子域创建或更新时发出的事件:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="9af5" class="lo ke hu lj b fv lp lq l lr ls">event SubdomainCreated(address indexed creator, address indexed owner, string domain, string subdomain);</span></pre><p id="cf5c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">遵循<a class="ae jq" href="https://web3js.readthedocs.io/en/1.0/web3-eth-contract.html#events" rel="noopener ugc nofollow" target="_blank">web 3 . js文档</a>，我们应该能够做到这一点:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="1c5f" class="lo ke hu lj b fv lp lq l lr ls">DApp.factoryContract.once('SubdomainCreated', { filter: {creator: DApp.currentAccount} }, function(error, event){ if (error) { // handle error } else { // display a notification that the event happened } } );</span></pre><p id="3da8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">其中我们指定了我们想要监听的事件<code class="eh lg lh li lj b">SubdomainCreated</code>，并传递了<code class="eh lg lh li lj b">filter</code>参数，以便只监听将<code class="eh lg lh li lj b">creator</code>指定为我们的<code class="eh lg lh li lj b">DApp.currentAccount</code>的事件。不幸的是，MetaMask <a class="ae jq" href="https://github.com/MetaMask/metamask-extension/issues/3642" rel="noopener ugc nofollow" target="_blank">的当前版本还不支持web sockets </a>，web3.js 1.0事件需要web sockets。这可以在旧版本的web3.js中使用，但是语法不同。</p><p id="98e7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">作为一种变通方法，我们可以轮询交易收据，以检查它是否被挖掘，但为了简单起见，我们将只显示一个到Etherscan的ENS查找服务的链接，其中包含我们的新子域名的详细信息，例如<code class="eh lg lh li lj b">https://etherscan.io/enslookup?q=radek.freedomain.eth</code>，交易状态也可以在MetaMask窗口中找到。</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/65a45b3c1ab0142a278750aef8533374.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DjSxR7MRx_KFJMmM.png"/></div></div></figure><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/68e4e55a426672625d4194dc19588b6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EvL4gExRWzdbn8Fs.png"/></div></div></figure><p id="368f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就是我们完成简单应用程序所需的全部内容。对于完整的源代码，可以在这里随意挖掘<a class="ae jq" href="https://github.com/radek1st/ens-subdomain-factory" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="c716" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">本地运行</h1><p id="26ef" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">如果您想在本地使用代码，只需检查它并确保您安装了以下npm软件包:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="acf6" class="lo ke hu lj b fv lp lq l lr ls">npm i -g truffle npm i web3 lite-server eth-ens-namehash-ms</span></pre><p id="a55e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以用<a class="ae jq" href="http://truffleframework.com/" rel="noopener ugc nofollow" target="_blank">松露</a>启动本地测试网:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="7d99" class="lo ke hu lj b fv lp lq l lr ls">$ truffle develop … truffle(develop)&gt; migrate … truffle(develop)&gt; test Using network 'develop'. Contract: EnsSubdomainFactory ✓ creating new subdomain works (143ms) ✓ creating new subdomain fails when factory is not the owner of domain (47ms) ✓ updating subdomain works if done by current owner (215ms) ✓ creating new subdomain fails if it is already owned by someone else (197ms) ✓ transferring domain works (76ms) ✓ cannot transfer domains when locked (97ms) ✓ cannot transfer domains when not contract owner (55ms) ✓ checking for domain and subdomain owner works (138ms) 8 passing (2s)</span></pre><p id="1cad" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，通过取消注释<a class="ae jq" href="https://github.com/radek1st/ens-subdomain-factory/blob/master/docs/dapp.js" rel="noopener ugc nofollow" target="_blank"> dapp.js </a>中的一行，将工厂智能契约重新指向您的本地节点:</p><pre class="js jt ju jv fq lk lj ll lm aw ln dt"><span id="2f6e" class="lo ke hu lj b fv lp lq l lr ls">// Local factoryAddress: "0x9fbda871d559710256a2502a2517b794b482db40", // Ropsten // factoryAddress: "0xf9fa2ff44a474b6d20500969bda61c2827fbc6b6", // Mainnet // factoryAddress: "0xbd185de5172ca64eec3d8cc763883a68f9154cd6",</span></pre><p id="89d2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要启动web服务器，只需执行<code class="eh lg lh li lj b">npm run dev</code>，这将在<code class="eh lg lh li lj b">localhost:3000</code>启动您的浏览器。</p><p id="380c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注意，为了便于本地开发，我已经包含了ENS注册中心和解析器模拟契约。</p><h1 id="2949" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">以太坊网络上的结果</h1><p id="802d" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">合同部署到<br/><a class="ae jq" href="https://etherscan.io/address/0xbd185de5172ca64eec3d8cc763883a68f9154cd6" rel="noopener ugc nofollow" target="_blank">0x BD 185 de 5172 ca 64 EEC 3d 8 cc 763883 a 68 f 9154 CD 6</a>。</p><p id="7adc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们的生产应用程序网站位于<a class="ae jq" href="https://ens.startonchain.com/" rel="noopener ugc nofollow" target="_blank">https://ens.startonchain.com</a>。</p><p id="ef15" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">带有MIT许可证<a class="ae jq" href="https://github.com/radek1st/ens-subdomain-factory" rel="noopener ugc nofollow" target="_blank">的源代码可以在GitHub </a>上获得。</p><p id="e6a1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">声明:这是在主网上运行，不是testnet，所以你是在用真金白银操作。使用风险自担。</p><p id="2d69" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">值得注意的是，域所有者可以随时更改子域所有者——即使他们已经被分配。我们在智能合约中禁用了此选项，但是当您使用其他人的域时应该小心。</p><h1 id="23de" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">欢迎来到应用程序的世界</h1><p id="6a0b" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">在这篇App教程中，我已经涉及了以太坊名称服务(ENS)、web3.js、ABI、智能合约、元掩码、事务事件监听器，以及如何生成Truffle项目。这个应用做了一些有趣和有用的事情，让人们通过一次区块链交易创建免费的以太坊子域。结合<a class="ae jq" href="https://www.toptal.com/ethereum-smart-contract/time-locked-wallet-truffle-tutorial" rel="noopener ugc nofollow" target="_blank">我的智能合约教程</a>，我已经给了你足够的细节(希望还有灵感)让你创建自己的基于以太坊的区块链应用。祝你好运！</p><p id="da7b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">智能合同是在区块链节点上执行的计算机程序。智能合约可以执行任何计算、保存数据、定义业务规则，还可以像以太一样发送和接受本地货币。契约本质上是不可变的，除非被编程。</p><p id="1c3a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">互联网的域名系统(DNS)是一种分层的、分散的服务，将“toptal.com”等人性化域名转换为“35.186.228.167”等数字IP地址，互联网上的计算机需要这些地址来定位数据和提供网站等内容。</p><p id="3b46" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">以太坊名称服务(ENS)域相当于DNS域，它提供了一种分散且安全的方式来将人类记忆的文本转换成以太坊地址。ENS域目前以结尾。eth并有七个或更多的字符。他们可以在拍卖中购买，并可以有层次的子域。</p><p id="dabc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">App只是一个与区块链后端交互的前端网站(通常通过web3 ),而不是一个由服务器和数据库组成的传统后端。该网站必须在支持以太坊的浏览器上查看，如Mist、Parity或移动应用程序Cipher或者通过安装MetaMask插件。</p><p id="b847" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所有区块链在自然界都是分布式的，因为它们有独立的节点以分布式方式一起工作。然而，并不是所有的区块链都是分散的。如果有一家公司可以审查、改变或停止区块链的运作，那么有些就是集中的。</p><p id="5973" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">子域名是二级域名的一部分，但是被搜索引擎认为是独立的实体。它们可用于为不同的地区、语言、部门、用户类型或设备类型创建不同的网站。例如，example.com的专用移动版本可能使用m.example.com子域。</p></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><p id="1d8d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">最初发表于</em><a class="ae jq" href="https://www.toptal.com/ethereum/ethereum-name-service-dapp-tutorial" rel="noopener ugc nofollow" target="_blank"><em class="jp">【www.toptal.com】</em></a><em class="jp">。</em></p></div></div>    
</body>
</html>