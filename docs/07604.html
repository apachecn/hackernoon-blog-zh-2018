<html>
<head>
<title>Malware Analysis using Osquery | Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Osquery的恶意软件分析|第2部分</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/malware-analysis-using-osquery-part-2-69f08ec2ecec?source=collection_archive---------11-----------------------#2018-09-06">https://medium.com/hackernoon/malware-analysis-using-osquery-part-2-69f08ec2ecec?source=collection_archive---------11-----------------------#2018-09-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="9de0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本系列的第一部分中，我们看到了如何使用Osquery来分析和提取关于恶意软件行为的有价值的信息。在那篇文章中，我们跟踪了众所周知的Emotet loader的活动，这是一种流行的分发银行木马的工具。使用Osquery，我们能够发现它如何使用恶意的Microsoft Office文档感染系统，以及它如何提取和执行有效载荷。</p><p id="1259" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本帖中，我们将看到恶意软件使用的另一种常见技术，持久性。为此，我们将继续使用Osquery来浏览注册表和startup_items表。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/87b57b9b134dcaf99747def67d1f9364.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/0*9bu7JpReZfRDvkKA.png"/></div></figure><h2 id="b195" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated">注册表持久性</h2><p id="22dd" class="pw-post-body-paragraph ir is hu it b iu kt iw ix iy ku ja jb jc kv je jf jg kw ji jj jk kx jm jn jo hn dt translated">在这种情况下，我们将分析使用。NET框架，特别是一个<a class="ae jp" href="https://lmntrix.com/Lab/Lab_info.php?id=112" rel="noopener ugc nofollow" target="_blank">耸肩勒索软件</a>的样本。这种恶意软件加密用户的个人文档，并要求一定数量的比特币来恢复所有文件。</p><p id="0244" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://otx.alienvault.com/indicator/file/a554b92036fbbc1c5d1a7d8a4049b01c5b6b7b30f06843fcdccf1f2420dfd707" rel="noopener ugc nofollow" target="_blank">https://otx . alien fault . com/indicator/file/a 554 b 92036 FB BC 1c 5d 1 a 7d 8 a 4049 b 01 C5 b 6 b 7 b 30 f 06843 fcd CCF 1 f 2420 DFD 707</a></p><p id="470b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">用. NET调试器打开该示例，我们可以看到它首先在用户临时目录中创建了一个新文件，并在指向该文件的用户空间的“CurrentVersion\Run”注册表项中写入了一个新值。该恶意软件将在用户每次登录时执行。这是恶意软件下载者为了留在系统中而使用的一种常见的持久性机制。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/b4e209ef5c611f36ea3114f67fc3ac9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/0*APJczT4QjpkQCwbi.png"/></div></figure><p id="a2ee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果我们在Osquery环境中运行这个示例，我们可以使用几个查询很容易地检测到这个活动。例如，如果您还记得在本博客系列的第1部分中我们用来记录写入磁盘的文件的查询，我们也可以在这里使用它来检测植入用户临时目录的文件。我们只是搜索在过去100秒内写在用户目录上的文件。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff ky"><img src="../Images/7e8bc8c9976c551909ea004878e7d58a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/0*r7AKidZNOUC1Hm22.png"/></div></figure><p id="1d13" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，我们可以搜索在注册表配置单元中创建的新条目。为此，我们可以使用‘registry’Osquery表，它允许我们查询系统中的所有注册表条目。我们还可以使用“启动项目”表。第二个表包含一组预定义的路径，系统使用这些路径在启动时自动运行程序。运行下面的查询，我们可以看到恶意软件如何编写了一个新条目，指向通过第一个查询发现的“耸肩. exe”文件。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/56f584fd44eef0bd870f27758d3aa4e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/0*Jo8FpUYO_RW7fvWq.png"/></div></figure><p id="dd3a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">文件上也写着shrug.exe。NET框架，所以我们可以用调试器再次打开它，看到一些有趣的部分。该文件首先检查系统是否已经被感染。如果没有，它会创建一个同名的新注册表项来写入安装参数。</p><p id="f640" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://otx.alienvault.com/indicator/file/b14a57ad391d9ba5b2714dad4773118f118ed8d64b523466bb60f3b18336efc1" rel="noopener ugc nofollow" target="_blank">https://otx . alien fault . com/indicator/file/b 14 a 57 ad 391d 9 ba 5b 2714 dad 4773118 f 118 ed 8d 64 b 523466 bb 60 F3 b 18336 EFC 1</a></p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/0e67d3691461910ac43ed7847761a9a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/0*KQw-V4gsq_-MN2ch.png"/></div></figure><p id="f69f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这一次，我们可以使用注册表来查看注册表中是否创建了任何新条目。通过运行一个查询来搜索最近100秒内在HKEY _用户配置单元中创建的任何新键，就像我们之前对文件所做的那样，我们可以看到新的“耸肩”键。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/0998a3a6880072f84406a873421b4f8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/0*2b1EqGPBDc6ftmez.png"/></div></figure><p id="329c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要查看是否有任何值被添加到该键中，我们可以使用键路径来搜索注册表。通过查询之前的密钥路径，我们可以获得勒索软件用来存储数据的安装参数，如安装日期、受害者标识符，以及用于加密文件的密钥和初始化向量(IV)。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/c9b4eac7b24ed29f67800e70adc12897.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/0*GIWWuP7_9TsGo0X6.png"/></div></figure><p id="792d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注册表安装后，耸肩勒索软件发送一些数据到地址变量中存储的域。这个连接可以通过运行类似于<a class="ae jp" href="https://www.alienvault.com/blogs/labs-research/malware-analysis-using-osquery-part-1" rel="noopener ugc nofollow" target="_blank">第1部分</a>博文中使用的查询来发现，以查看与命令和控制服务器的通信。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/7ce62999318369b8821965d58bff2ab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/0*TtUIhEApm81JHzgr.png"/></div></figure><p id="3236" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，正如勒索软件通常所做的那样，它试图加密用户的所有个人文档。在这种情况下，我们可以在上图中看到它是如何开始加密整个“C:\”目录的。幸运的是，该活动会导致文件更改它们的修改时间戳，从而允许我们查询最近修改过的所有文件。查询将返回所有被勒索软件修改过的文件，我们可以看到，它们都有一个新的文件扩展名”。耸耸肩”。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff kz"><img src="../Images/3175e7217370d0fe3c59c2c5b1aebabb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/0*j3_G5I_QPYZifCaW.png"/></div></figure><h2 id="73d5" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated">计划的任务和服务</h2><p id="f02b" class="pw-post-body-paragraph ir is hu it b iu kt iw ix iy ku ja jb jc kv je jf jg kw ji jj jk kx jm jn jo hn dt translated">在Windows系统上获得持久性的另一种常见方法是创建计划任务或安装新服务。这些动作通常是由恶意软件执行的，Osquery有表来查询它们。</p><p id="3ac2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是一个石油钻塔恶意软件的例子。正如您在下表中看到的，在运行示例之后，已经创建了两个新的计划任务。Osquery可以通过查询scheduled_tasks表为我们提供这些信息。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/48c95eafbe30515f5d8b9fc3ddd13109.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/0*NulgoU4a3LlTu8R-.png"/></div></figure><p id="e19f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">服务表允许我们查看系统中安装了哪些服务。在运行安装恶意服务以获得持久性的恶意软件示例后，我们可以构建一个查询来返回这些结果，并查看有关新服务的所有详细信息。如您所见，我们已经检测到服务“检查更新”正在执行恶意的PowerShell脚本。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff kz"><img src="../Images/23e7bd05345a130076bad044e969f09e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/0*MjjRDxf8oBsy8aTB.png"/></div></figure><h2 id="1f1b" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated">AlienVault如何使用Osquery</h2><p id="aa84" class="pw-post-body-paragraph ir is hu it b iu kt iw ix iy ku ja jb jc kv je jf jg kw ji jj jk kx jm jn jo hn dt translated">通过使用Osquery，我们可以检测恶意软件威胁经常使用的许多机制和技术。在<a class="ae jp" href="https://www.alienvault.com/blogs/labs-research/malware-analysis-using-osquery-part-1" rel="noopener ugc nofollow" target="_blank">之前的博客</a>中，我们看到了如何一步一步地分析恶意软件感染。在这篇文章中，我们已经看到了如何捕捉持久性技巧。这在调查安全事件以及对您的关键资产进行威胁搜索时非常有用。</p><p id="2bc6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">AlienVault通过AlienVault代理利用Osquery在USM Anywhere和Open Threat Exchange中搜索威胁。</p><p id="4b93" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">AlienVault代理是一个轻量级、适应性强的端点代理，基于Osquery，由AlienVault维护。在USM Anywhere中，AlienVault代理支持持续的端点监控，使用内置的AlienVault威胁情报来自动执行端点查询和威胁检测，以及您的其他<a class="ae jp" href="https://hackernoon.com/tagged/network" rel="noopener ugc nofollow" target="_blank">网络</a>和云<a class="ae jp" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank">安全</a>事件。这使得USM Anywhere能够提供端点检测和响应(EDR)、文件完整性监控(FIM)以及丰富的端点遥测功能，这些功能对于完整有效的威胁检测、响应和合规性至关重要。</p><p id="b2de" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在<a class="ae jp" href="https://www.alienvault.com/products/usm-anywhere/demo" rel="noopener ugc nofollow" target="_blank"> USM Anywhere在线演示</a>中亲自体验一下。</p><p id="b68d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">4月，AlienVault推出了Endpoint Threat Hunter，这是开放威胁交换(OTX)中基于AlienVault代理的免费威胁扫描服务。OTX终端威胁猎人允许任何人确定他们的终端是否感染了最新的恶意软件或其他威胁，方法是手动扫描他们的终端是否存在OTX编目的危害指标(IOC)。</p><p id="4d55" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">免费使用OTX端点威胁猎人:<a class="ae jp" href="https://otx.alienvault.com/endpoint-threat-hunter/welcome" rel="noopener ugc nofollow" target="_blank">https://otx.alienvault.com/endpoint-threat-hunter/welcome</a></p><h1 id="2f50" class="la jz hu bd ka lb lc ld ke le lf lg ki lh li lj kl lk ll lm ko ln lo lp kr lq dt translated">附录</h1><h2 id="d5e1" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated">Osquery搜索</h2><pre class="jr js jt ju fq lr ls lt lu aw lv dt"><span id="3155" class="jy jz hu ls b fv lw lx l ly lz"><em class="ma">select path, size from file where path like 'C:\Users\%%' and mtime &gt; (select local_time from time) - 100 and filename != '.';</em><br/><br/><em class="ma">select source, name, path from startup_items;</em><br/><br/><em class="ma">select path, name, type, data from registry where path like 'HKEY_USERS\%\%%' and mtime &gt; (select local_time from time) - 100;</em><br/><br/><em class="ma">select path, name, type, data from registry where key like 'HKEY_USERS\%\Shrug';</em><br/><br/><em class="ma">select name, action, path, enabled, next_run_time from scheduled_tasks;</em><br/><br/><em class="ma">select name, display_name, start_type, path, user_account from services;</em></span></pre><h2 id="c092" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated">IOC示例</h2><div class="mb mc fm fo md me"><a href="https://otx.alienvault.com/pulse/5b899bd8694f420825bbdfdd" rel="noopener  ugc nofollow" target="_blank"><div class="mf ab ej"><div class="mg ab mh cl cj mi"><h2 class="bd hv fv z el mj eo ep mk er et ht dt translated">耸肩勒索软件- AlienVault -开放威胁交换</h2><div class="ml l"><h3 class="bd b fv z el mj eo ep mk er et ek translated">耸肩. NET写的勒索软件。</h3></div><div class="mm l"><p class="bd b gc z el mj eo ep mk er et ek translated">otx.alienvault.com</p></div></div></div></a></div><h2 id="e1aa" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated">连接</h2><p id="cb70" class="pw-post-body-paragraph ir is hu it b iu kt iw ix iy ku ja jb jc kv je jf jg kw ji jj jk kx jm jn jo hn dt translated"><a class="ae jp" href="http://tempacc11vl.000webhostapp[.]com/marthas_stuff/uploadhash.php" rel="noopener ugc nofollow" target="_blank"><em class="ma">http://tempacc 11 VL . 000 webhostapp[。]com/marthas _ stuff/upload hash . PHP</em></a></p><p id="47c1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="ma">145.14.145.119</em></p><h2 id="5e33" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated"><strong class="ak">文件</strong></h2><p id="ed71" class="pw-post-body-paragraph ir is hu it b iu kt iw ix iy ku ja jb jc kv je jf jg kw ji jj jk kx jm jn jo hn dt translated"><em class="ma">ShrugInstaller.exe</em></p><p id="6f55" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="ma">a 554 b 92036 FB BC 1c 5 D1 a 7 D8 a 4049 b 01 C5 b 6 b 7 b 30 f 06843 fcdccf 1 f 2420 DFD 707</em></p><h2 id="2c95" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated"><strong class="ak">已删除可执行文件</strong></h2><p id="3074" class="pw-post-body-paragraph ir is hu it b iu kt iw ix iy ku ja jb jc kv je jf jg kw ji jj jk kx jm jn jo hn dt translated"><em class="ma">C:\ Users \ admin \ AppData \ Local \ Temp \耸肩. exe </em></p><p id="e4d1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="ma">b 14 a 57 ad 391d 9 ba 5b 2714 dad 4773118 f 118 ed 8d 64 b 523466 bb 60 F3 b 18336 EFC 1</em></p><h2 id="efc2" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated"><strong class="ak">亚拉</strong></h2><pre class="jr js jt ju fq lr ls lt lu aw lv dt"><span id="1ef4" class="jy jz hu ls b fv lw lx l ly lz"><em class="ma">import "dotnet"</em><br/><br/><br/><em class="ma">rule ShrugRansomware {</em><br/><br/><em class="ma">            meta:</em><br/><br/><em class="ma">                        author = "AlienVault Labs"</em><br/><br/><em class="ma">            strings:</em><br/><br/><em class="ma">                        $bitcoin_address = "1Hr1grgH9ViEgUx73iRRJLVKH3PFjUteNx"</em><br/><br/><em class="ma">                        $s1 = "upoldhash.php"</em><br/><br/><em class="ma">                        $s2 = "HarmedFiles"</em><br/><br/><em class="ma">                        $s3 = "ShrugDecryptor"</em><br/><br/><em class="ma">                        $s4 = "SHRUG2"</em><br/><br/><em class="ma">                        $pdb1 = "\\Debug\\ShrugTwo.pdb"</em><br/><br/><em class="ma">                        $pdb2 = "\\Debug\\Shrug.pdb"</em><br/><br/><br/><em class="ma">            condition:</em><br/><br/><em class="ma">                        uint16(0) == 0x5A4D and dotnet.number_of_guids &gt; 0 and </em><br/><br/><em class="ma">                        ((dotnet.typelib == "a6ab6b1f-b144-4920-be42-bb90ec6fc22e") </em><br/><br/><em class="ma">                        or ($bitcoin_address) </em><br/><br/><em class="ma">                        or (2 of ($s*)) </em><br/><br/><em class="ma">                        or (any of ($pdb*)))<br/>}</em></span></pre><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="mn mo l"/></div></figure></div></div>    
</body>
</html>