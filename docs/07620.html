<html>
<head>
<title>Deploying the Winds API to AWS ECS with Docker Compose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Docker Compose将Winds API部署到AWS ECS</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/deploying-the-winds-api-to-aws-ecs-with-docker-compose-4daf8d130d3b?source=collection_archive---------27-----------------------#2018-09-06">https://medium.com/hackernoon/deploying-the-winds-api-to-aws-ecs-with-docker-compose-4daf8d130d3b?source=collection_archive---------27-----------------------#2018-09-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/b87c46843bf9b455f22453df21f965ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xxQ922zfMM9DWAH4_iRLFg.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">https://getstream.io/winds</figcaption></figure><div class=""/><p id="4fa2" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><a class="ae ke" href="https://getstream.io/winds" rel="noopener ugc nofollow" target="_blank"> Winds </a>是由<a class="ae ke" href="https://getstream.io/try-the-api" rel="noopener ugc nofollow" target="_blank"> Stream </a>提供的一个流行的RSS和播客应用程序——一个允许你在几个小时而不是几个月内建立新闻和活动提要的服务。Winds是100%开源的，后端很容易安装在本地环境或云中——这是我们将在本教程中讨论的任务。为了确保您顺利完成教程，<em class="kf">请</em>确保完成所有的先决条件。</p><h1 id="9cf1" class="kg kh ij bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">先决条件📚</h1><p id="38c0" class="pw-post-body-paragraph jg jh ij ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">与任何教程一样，它也有一些要求。对于这篇文章，您需要确保您已经启动并运行了以下内容，并在继续之前做好了准备。如果你决定跳过这些需求，你很可能会在某个地方停滞不前——我们不希望这种情况发生。</p><ol class=""><li id="0599" class="lj lk ij ji b jj jk jn jo jr ll jv lm jz ln kd lo lp lq lr dt translated">对<a class="ae ke" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank"> ECS </a>和<a class="ae ke" href="https://aws.amazon.com/elasticache/" rel="noopener ugc nofollow" target="_blank">elastic cache</a>拥有完全访问权限的亚马逊网络服务(AWS)账户</li><li id="345f" class="lj lk ij ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">来自https://github.com/GetStream/Winds<a class="ae ke" href="https://github.com/GetStream/Winds" rel="noopener ugc nofollow" target="_blank">的风的新克隆</a></li><li id="3c50" class="lj lk ij ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">拥有<a class="ae ke" href="https://cloud.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> MongoDB Atlas </a>或其他MongoDB提供商的账户(我们推荐MongoDB Atlas)</li><li id="0f11" class="lj lk ij ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">一个有<a class="ae ke" href="https://getstream.io/try-the-api" rel="noopener ugc nofollow" target="_blank">流</a>的自由账户</li><li id="87a5" class="lj lk ij ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">AWS ElastiCache设置和运行Redis的实例(<em class="kf">复制URI，因为您很快就会需要它</em></li><li id="b873" class="lj lk ij ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">来自Mercury的免费API密钥(它处理RSS文章解析，因此非常重要)</li><li id="ab6e" class="lj lk ij ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">来自<a class="ae ke" href="https://algolia.com/" rel="noopener ugc nofollow" target="_blank"> Algolia </a>的一套免费凭证</li><li id="7bae" class="lj lk ij ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">安装在您机器上的AWS CLI </li><li id="c1b5" class="lj lk ij ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">除AWS CLI外，还安装了ECS CLI</li><li id="dc47" class="lj lk ij ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">Docker Hub 上的一个账户(如果你愿意，你可以使用另一个提供商；然而，我强烈建议坚持使用Docker Hub)</li></ol><p id="9162" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我想提到的另一件事是，您应该在您的AWS帐户上拥有以下权限(或类似权限):</p><ul class=""><li id="a021" class="lj lk ij ji b jj jk jn jo jr ll jv lm jz ln kd lx lp lq lr dt translated">amazone C2 containerregistryfull access</li></ul><figure class="lz ma mb mc fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ly"><img src="../Images/2f3dfd4cf8a7007576c6739322e857c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lUn5dPOf1g5b4TXG"/></div></div></figure><p id="8c01" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">就是这样！💥</p><h1 id="b64b" class="kg kh ij bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">设置相关性🛠</h1><p id="765f" class="pw-post-body-paragraph jg jh ij ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">由于我们在上面提供了详尽的列表，希望您已经有机会完成各个步骤，并复制您的第三方URIs和凭据以继续下一步。下一步需要我们修改位于Winds的<strong class="ji ik"> /api </strong>目录中的<strong class="ji ik"> docker-compose-aws </strong>文件。</p><p id="928d" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">当我们开始时，该文件将如下所示:</p><p id="630a" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">按照<strong class="ji ik"> docker-compose-aws.yml </strong>文件中的指示填写凭证。不要忘记一个<a class="ae ke" href="https://randomkeygen.com/" rel="noopener ugc nofollow" target="_blank">随机值</a>给你的JWT。</p><p id="0e8e" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">您最终应该得到一个类似如下的文件:</p><blockquote class="md me mf"><p id="52a6" class="jg jh kf ji b jj jk jl jm jn jo jp jq mg js jt ju mh jw jx jy mi ka kb kc kd hn dt translated"><em class="ij">注意:我们在docker-compose.yml文件上使用了</em><strong class="ji ik"><em class="ij">docker-compose-AWS . yml</em></strong><em class="ij">文件，因为我们在同一个目录中有两个docker-compose文件。通过将“-aws”附加到文件中，我们可以很容易地指定在构建环境时要访问什么文件。</em></p></blockquote><h1 id="f7d3" class="kg kh ij bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">使用ECS CLI启动和运行🤔</h1><p id="63cc" class="pw-post-body-paragraph jg jh ij ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">Amazon Web Services (AWS CLI)的弹性容器服务命令行接口提供了高级命令，以简化从本地开发环境创建、更新和监控集群和任务。</p><p id="f79e" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这里重要的是，ECS CLI支持Docker Compose文件，这是我们用来定义我们的应用程序如何以及应该如何在云中运行的文件。虽然它是针对多容器应用程序的(我们在<strong class="ji ik"> docker-compose-aws.yml </strong>中也有一个文件)，但出于本教程的目的，我们将使用单个容器应用程序。</p><p id="f3be" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">让我们继续配置AWS ECS CLI，这样我们就可以开始运行了。首先，我们将使用以下命令创建一个“概要文件”:</p><p id="3459" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">接下来，我们将使用以下命令完成配置:</p><blockquote class="md me mf"><p id="3606" class="jg jh kf ji b jj jk jl jm jn jo jp jq mg js jt ju mh jw jx jy mi ka kb kc kd hn dt translated"><em class="ij">注意:将launch type替换为您希望默认使用的launch type(EC2 ),将region_name替换为您希望的AWS区域，将cluster_name (WINDS)替换为要使用的现有Amazon ECS集群或新集群的名称，将configuration_name (WINDS)替换为您希望为此配置指定的名称。</em></p></blockquote><h1 id="768e" class="kg kh ij bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">使用EC2任务✍创建群</h1><p id="fb87" class="pw-post-body-paragraph jg jh ij ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">AWS ECS需要权限，以便您的EC2任务可以在CloudWatch中存储日志。该权限由任务执行IAM角色负责。为此，我们需要使用AWS CLI创建一个任务执行IAM角色。</p><p id="9369" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">1.创建名为<strong class="ji ik">task-execution-assume-role . JSON</strong>的文件，内容如下:</p><p id="8572" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">2.创建任务执行角色(与<strong class="ji ik">task-execution-assume-role . JSON</strong>在同一目录下):</p><p id="2bd8" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">3.附加任务执行角色策略:</p><h1 id="a316" class="kg kh ij bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">创建群集和安全组🔑</h1><p id="1aa8" class="pw-post-body-paragraph jg jh ij ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">接下来，我们将创建一个带有安全组的Amazon ECS集群。</p><p id="cb70" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">1.我们已经在集群配置中将EC2指定为默认启动类型，因此以下命令创建一个空集群和一个配置了两个公共子网的VPC:</p><blockquote class="md me mf"><p id="2776" class="jg jh kf ji b jj jk jl jm jn jo jp jq mg js jt ju mh jw jx jy mi ka kb kc kd hn dt translated"><em class="ij">注意:创建资源时，此命令可能需要几分钟才能完成。您还需要记下创建的VPC和子网id，我们很快就会用到它们。</em></p></blockquote><p id="5449" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">2.使用AWS CLI，使用上一个命令输出中的VPC值创建一个安全组:</p><p id="79be" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">3.使用AWS CLI，我们将添加一个安全组规则，以允许端口80上的入站访问:</p><h1 id="5a45" class="kg kh ij bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">指定AWS ECS 🖥的参数</h1><p id="2599" class="pw-post-body-paragraph jg jh ij ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">除了我们已经为您创建的<strong class="ji ik"> docker-compose-aws.yml </strong>文件之外，您还需要创建一个包含以下内容的<strong class="ji ik"> ecs-params.yml </strong>文件:</p><blockquote class="md me mf"><p id="05bb" class="jg jh kf ji b jj jk jl jm jn jo jp jq mg js jt ju mh jw jx jy mi ka kb kc kd hn dt translated"><em class="ij">注意:这个params文件特定于AWS ECS，如果您想在AWS上运行Winds API，它是必需的。您需要指定的值可以在前面的请求中找到。</em></p></blockquote><h1 id="8ad6" class="kg kh ij bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">将映像部署到Docker Hub🚴</h1><p id="7e3a" class="pw-post-body-paragraph jg jh ij ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">在本节中，我们将概述如何构建、标记和上传Winds API到Docker和AWS。</p><h1 id="2b9f" class="kg kh ij bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">创建和上传</h1><p id="14ff" class="pw-post-body-paragraph jg jh ij ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">对于这一步，您需要使用以下命令登录Docker:</p><p id="398f" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然后，运行以下命令来构建Docker映像(您必须在<strong class="ji ik"> /api </strong>目录中):</p><h1 id="5bdd" class="kg kh ij bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">标记和推送</h1><p id="bb27" class="pw-post-body-paragraph jg jh ij ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">首先，您需要获得docker图像ID，您可以运行<strong class="ji ik"> docker图像列表</strong>，它将输出您所有的Docker图像。从标记为“winds”的文件中获取ID，并将其放入下面的命令中。</p><p id="956f" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">正确标记图像所需的命令是:</p><p id="a5bc" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">现在，是时候将标记的图像推送到AWS了。您可以通过以下方式实现这一点:</p><p id="2006" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">大约需要30秒，但完成后。</p><h1 id="a661" class="kg kh ij bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">部署到集群📤</h1><p id="a12a" class="pw-post-body-paragraph jg jh ij ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">现在我们已经配置好了文件和基础设施，我们可以使用以下命令将Docker compose文件部署到ECS:</p><blockquote class="md me mf"><p id="ff45" class="jg jh kf ji b jj jk jl jm jn jo jp jq mg js jt ju mh jw jx jy mi ka kb kc kd hn dt translated"><em class="ij">注意:默认情况下，该命令在当前目录中查找名为docker-compose.yml的文件；因为我们有两个文件，所以我们需要用–file选项(或简称为-f)指定一个不同的docker合成文件。</em></p></blockquote><p id="b6a6" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如果一切顺利，您应该会在ECS控制台中看到以下内容！如果您单击该任务，您会注意到有一个公共IP地址，允许您查看API(它应该以“pong”响应)。</p><figure class="lz ma mb mc fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ly"><img src="../Images/5ad52a991062e3944c79c8863524769f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cH4rNM7h70qKHI9W"/></div></div></figure><h1 id="9ec6" class="kg kh ij bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">搞定了。👏</h1><p id="b192" class="pw-post-body-paragraph jg jh ij ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">我希望你喜欢这篇关于如何使用Docker将Winds部署到AWS的教程。在以后的文章中，我将概述如何在Google和Digital Ocean上进行同样的部署。</p><p id="6b58" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如果你对部署前端感兴趣，看看这篇文章，这篇文章概述了如何使用AWS S3和CloudFront来部署前端。</p><p id="cde7" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">编码快乐！🎉</p><p id="21b6" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">标签:<a class="ae ke" href="https://getstream.io/blog/tag/aws-ecs/" rel="noopener ugc nofollow" target="_blank"> AWS ECS </a>，<a class="ae ke" href="https://getstream.io/blog/tag/containers/" rel="noopener ugc nofollow" target="_blank">集装箱</a>，<a class="ae ke" href="https://getstream.io/blog/tag/deployment/" rel="noopener ugc nofollow" target="_blank">调配</a>，<a class="ae ke" href="https://getstream.io/blog/tag/docker/" rel="noopener ugc nofollow" target="_blank">码头</a>，<a class="ae ke" href="https://getstream.io/blog/tag/winds/" rel="noopener ugc nofollow" target="_blank">大风</a></p></div><div class="ab cl mj mk hc ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="hn ho hp hq hr"><p id="44e0" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><em class="kf">最初发布于2018年9月6日</em><a class="ae ke" href="https://getstream.io/blog/deploying-the-winds-api-to-aws-ecs-with-docker-compose/" rel="noopener ugc nofollow" target="_blank"><em class="kf">getstream . io</em></a><em class="kf">。</em></p></div></div>    
</body>
</html>