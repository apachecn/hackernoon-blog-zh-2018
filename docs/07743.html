<html>
<head>
<title>Migrating from dep to Go 1.11 modules</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从dep迁移到Go 1.11模块</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/migrating-from-dep-to-go-1-11-modules-bba03c513799?source=collection_archive---------29-----------------------#2018-09-11">https://medium.com/hackernoon/migrating-from-dep-to-go-1-11-modules-bba03c513799?source=collection_archive---------29-----------------------#2018-09-11</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/f02864bde507936f7633b33f51653291.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7_wI3ZZt3qnOIPg4h8YOiQ.png"/></div></div></figure><div class=""/><h1 id="e8f8" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">TL；速度三角形定位法(dead reckoning)</h1><ul class=""><li id="f3b3" class="ka kb if kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated">将您的代码移到<code class="eh ks kt ku kv b">GOPATH</code>之外</li><li id="cfe2" class="ka kb if kc b kd kw kf kx kh ky kj kz kl la kn ko kp kq kr dt translated"><code class="eh ks kt ku kv b">go mod init [module path]</code>:这将从<code class="eh ks kt ku kv b">Gopkg.lock</code>导入依赖关系。</li><li id="3a54" class="ka kb if kc b kd kw kf kx kh ky kj kz kl la kn ko kp kq kr dt translated"><code class="eh ks kt ku kv b">go mod tidy</code>:这将删除不必要的导入，并添加间接导入。</li><li id="e356" class="ka kb if kc b kd kw kf kx kh ky kj kz kl la kn ko kp kq kr dt translated"><code class="eh ks kt ku kv b">rm -fr vendor/</code></li><li id="a688" class="ka kb if kc b kd kw kf kx kh ky kj kz kl la kn ko kp kq kr dt translated">一切都好吗？</li><li id="de48" class="ka kb if kc b kd kw kf kx kh ky kj kz kl la kn ko kp kq kr dt translated"><code class="eh ks kt ku kv b">rm -f Gopkg.lock Gopkg.toml</code></li><li id="9e57" class="ka kb if kc b kd kw kf kx kh ky kj kz kl la kn ko kp kq kr dt translated"><code class="eh ks kt ku kv b">git commit -m 'chore(dep): migrated from dep to Go 1.11 modules'</code></li></ul><h1 id="f8c4" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">介绍</h1><p id="3a47" class="pw-post-body-paragraph lb lc if kc b kd ke ld le kf kg lf lg kh lh li lj kj lk ll lm kl ln lo lp kn hn dt translated">在Go 1.11之前，依赖<a class="ae lq" href="https://hackernoon.com/tagged/management" rel="noopener ugc nofollow" target="_blank">管理</a>被留给了<a class="ae lq" href="https://hackernoon.com/tagged/community" rel="noopener ugc nofollow" target="_blank">社区</a>。有很多解决方案，但我最喜欢的是<a class="ae lq" href="https://golang.github.io/dep/" rel="noopener ugc nofollow" target="_blank"><strong class="kc ig"/></a>。</p><p id="3c34" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">像其他语言的许多依赖项管理工具一样，<strong class="kc ig"> dep </strong>有一个用于依赖项请求的文件(<code class="eh ks kt ku kv b">Gopkg.toml</code>)、一个锁定所使用的确切版本的文件(<code class="eh ks kt ku kv b">Gopkg.lock</code>)和一个保存依赖项文件的目录<code class="eh ks kt ku kv b">vendor</code>。一个简单的命令<code class="eh ks kt ku kv b"><a class="ae lq" href="https://golang.github.io/dep/docs/daily-dep.html" rel="noopener ugc nofollow" target="_blank">dep ensure</a></code>就可以完成所有的工作。</p><p id="0a0c" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">此外，在Go 1.11之前，您的项目源代码需要在您的<code class="eh ks kt ku kv b">GOPATH</code>中，并且您必须遵守<a class="ae lq" href="https://golang.org/doc/code.html" rel="noopener ugc nofollow" target="_blank">工作空间布局</a>。</p><p id="9f32" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">幸运的是，有了Go 1.11，你的代码可以存在于你磁盘上的任何地方！另外，依赖关系管理由<code class="eh ks kt ku kv b">go</code>命令处理，引入了<a class="ae lq" href="https://github.com/golang/go/wiki/Modules" rel="noopener ugc nofollow" target="_blank">模块</a>。</p><h1 id="958e" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">移民</h1><p id="7d91" class="pw-post-body-paragraph lb lc if kc b kd ke ld le kf kg lf lg kh lh li lj kj lk ll lm kl ln lo lp kn hn dt translated">安装Go 1.11后，从将代码移出<code class="eh ks kt ku kv b">GOPATH</code>开始:</p><p id="0fac" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">(我的<code class="eh ks kt ku kv b">GOPATH</code>是<code class="eh ks kt ku kv b">~/code/go/</code>)</p><pre class="lw lx ly lz fq ma kv mb mc aw md dt"><span id="8849" class="me jd if kv b fv mf mg l mh mi">~/code $ mv go/src/gitlab.callr.tech/platform/asterisk-pbx-agi .</span></pre><p id="23a1" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">现在，我的项目在<code class="eh ks kt ku kv b">~/code/asterisk-pbx-agi</code>。</p><p id="bb55" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">让我们试试<code class="eh ks kt ku kv b">go mod init</code>:</p><pre class="lw lx ly lz fq ma kv mb mc aw md dt"><span id="15a9" class="me jd if kv b fv mf mg l mh mi">~/code/asterisk-pbx-agi $ go mod init <br/>go: cannot determine module path for source directory ~/code/asterisk-pbx-agi (outside GOPATH, no import comments)</span></pre><p id="b33f" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">啊。所以因为代码在<code class="eh ks kt ku kv b">GOPATH</code>之外，go不能再确定“模块路径”了。有道理。</p><p id="8c04" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">让我们用模块路径再试一次:</p><pre class="lw lx ly lz fq ma kv mb mc aw md dt"><span id="771b" class="me jd if kv b fv mf mg l mh mi">~/code/asterisk-pbx-agi $ go mod init gitlab.callr.tech/platform/asterisk-pbx-agi<br/>go: creating new go.mod: module gitlab.callr.tech/platform/asterisk-pbx-agi<br/>go: copying requirements from Gopkg.lock</span></pre><p id="fb51" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">Go通过读取<code class="eh ks kt ku kv b">Gopkg.lock</code>文件从<strong class="kc ig"> dep </strong>导入了我的依赖项。干净利落。它还创建了一个<code class="eh ks kt ku kv b">go.mod</code>文件:</p><pre class="lw lx ly lz fq ma kv mb mc aw md dt"><span id="4345" class="me jd if kv b fv mf mg l mh mi">module gitlab.callr.tech/platform/asterisk-pbx-agi<br/><br/>require (<br/>    github.com/zaf/agi v0.0.0-20160319110841-15f1ed9d87e3<br/>    go.uber.org/atomic v1.3.2<br/>    go.uber.org/multierr v1.1.0<br/>    go.uber.org/zap v1.8.0<br/>    gopkg.in/yaml.v2 v2.2.1<br/>)</span></pre><p id="d49d" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">此时，<code class="eh ks kt ku kv b">go build</code>应该起作用了。</p><p id="063d" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">不过还是先试一个<code class="eh ks kt ku kv b">go mod tidy</code>吧。下面是运行后的<code class="eh ks kt ku kv b">go.mod</code>:</p><pre class="lw lx ly lz fq ma kv mb mc aw md dt"><span id="83ca" class="me jd if kv b fv mf mg l mh mi">module gitlab.callr.tech/platform/asterisk-pbx-agi<br/><br/>require (<br/>    github.com/davecgh/go-spew v1.1.1 // indirect<br/>    github.com/pkg/errors v0.8.0 // indirect<br/>    github.com/pmezard/go-difflib v1.0.0 // indirect<br/>    github.com/stretchr/testify v1.2.2 // indirect<br/>    github.com/zaf/agi v0.0.0-20160319110841-15f1ed9d87e3<br/>    go.uber.org/atomic v1.3.2 // indirect<br/>    go.uber.org/multierr v1.1.0 // indirect<br/>    go.uber.org/zap v1.8.0<br/>    gopkg.in/yaml.v2 v2.2.1<br/>)</span></pre><p id="2051" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">有意思。<code class="eh ks kt ku kv b">go mod tidy</code>检测到某些依赖关系是“间接的”,并将其标记为间接的。它还增加了一些其他的，需要用于<code class="eh ks kt ku kv b">go test</code>。</p><p id="2208" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">当<code class="eh ks kt ku kv b">go build</code>和<code class="eh ks kt ku kv b">go test</code>都工作时，您可以安全地删除旧文件:</p><pre class="lw lx ly lz fq ma kv mb mc aw md dt"><span id="1aec" class="me jd if kv b fv mf mg l mh mi">~/code/asterisk-pbx-agi $ rm -fr Gopkg.* vendor/</span></pre><p id="a8fb" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">你就完了。</p><h1 id="6453" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">更新您的配置项</h1><p id="e4a7" class="pw-post-body-paragraph lb lc if kc b kd ke ld le kf kg lf lg kh lh li lj kj lk ll lm kl ln lo lp kn hn dt translated">使用Gitlab，下面是我们过去如何使用Go 1.10和dep进行构建:</p><pre class="lw lx ly lz fq ma kv mb mc aw md dt"><span id="758a" class="me jd if kv b fv mf mg l mh mi">Build Go:<br/>  image: golang:1.10<br/>  stage: build<br/>  script:<br/>    - curl -fsSL -o /usr/local/bin/dep https://github.com/golang/dep/releases/download/v0.4.1/dep-linux-amd64 &amp;&amp; chmod +x /usr/local/bin/dep<br/>    - ln -s `pwd` /go/src/asterisk-pbx-agi<br/>    - cd /go/src/asterisk-pbx-agi<br/>    - dep ensure -vendor-only<br/>    - GOOS=linux GOARCH=amd64 go build -ldflags "-linkmode external -extldflags -static" -a -o callr.agi<br/>  artifacts:<br/>    paths:<br/>      - callr.agi<br/>    expire_in: 1 week</span></pre><p id="3e8c" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">由于<code class="eh ks kt ku kv b">GOPATH</code>的混乱，我们不得不创建一个到<code class="eh ks kt ku kv b">/go/src</code>内部代码的链接，并在其中运行<code class="eh ks kt ku kv b">dep</code>和<code class="eh ks kt ku kv b">go build</code>。</p><h1 id="8645" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">在...之后</h1><p id="eb4c" class="pw-post-body-paragraph lb lc if kc b kd ke ld le kf kg lf lg kh lh li lj kj lk ll lm kl ln lo lp kn hn dt translated">以下是Go 1.11的相同任务:</p><pre class="lw lx ly lz fq ma kv mb mc aw md dt"><span id="7c8e" class="me jd if kv b fv mf mg l mh mi">Build Go:<br/>  image: golang:1.11<br/>  stage: build<br/>  script:<br/>    - GOOS=linux GOARCH=amd64 go build -ldflags "-linkmode external -extldflags -static" -a -o callr.agi<br/>  artifacts:<br/>    paths:<br/>      - callr.agi<br/>    expire_in: 1 week</span></pre><p id="a162" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated">简单多了。<code class="eh ks kt ku kv b">go build</code>将自动处理依赖关系。</p><h1 id="799f" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">证明文件</h1><ul class=""><li id="60a8" class="ka kb if kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated"><a class="ae lq" href="https://github.com/golang/go/wiki/Modules" rel="noopener ugc nofollow" target="_blank"> Go wiki模块</a></li><li id="c319" class="ka kb if kc b kd kw kf kx kh ky kj kz kl la kn ko kp kq kr dt translated"><a class="ae lq" href="https://golang.org/cmd/go/" rel="noopener ugc nofollow" target="_blank"> Go命令文件</a></li></ul></div><div class="ab cl mj mk hc ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="hn ho hp hq hr"><p id="8703" class="pw-post-body-paragraph lb lc if kc b kd lr ld le kf ls lf lg kh lt li lj kj lu ll lm kl lv lo lp kn hn dt translated"><em class="mq">原载于2018年9月11日</em><a class="ae lq" href="https://blog.callr.tech/migrating-from-dep-to-go-1.11-modules/" rel="noopener ugc nofollow" target="_blank"><em class="mq">blog . callr . tech</em></a><em class="mq">。</em></p><figure class="lw lx ly lz fq hw"><div class="bz el l di"><div class="mr ms l"/></div></figure></div></div>    
</body>
</html>