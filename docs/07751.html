<html>
<head>
<title>The definitive guide to Express, the Node.js Web Application Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Express的权威指南，Node.js Web应用程序框架</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/the-definitive-guide-to-express-the-node-js-web-application-framework-649352e2ae87?source=collection_archive---------1-----------------------#2018-09-12">https://medium.com/hackernoon/the-definitive-guide-to-express-the-node-js-web-application-framework-649352e2ae87?source=collection_archive---------1-----------------------#2018-09-12</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/2c72e3c3a9f94c8429997b223d0ce157.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*huCrw2ybIkyg6NzbhvrAeA.jpeg"/></div></div></figure><p id="ff1f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你可以获得这个页面的<a class="ae ka" href="https://flaviocopes.com/page/express-handbook" rel="noopener ugc nofollow" target="_blank"> PDF、ePub和Mobi </a>版本，以便于参考，或者在你的Kindle或平板电脑上阅读。</p><h2 id="2e0c" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">目录</h2><ul class=""><li id="59c8" class="kw kx hu je b jf ky jj kz jn la jr lb jv lc jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#cf65">安装</a></li><li id="0616" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#3c1b">你好世界</a></li><li id="048b" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#e2ea">通过理解Hello World代码</a>学习Express的基础知识</li><li id="cf48" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#12e8">请求参数</a></li><li id="ea3b" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#abc5">如何检索得到查询字符串参数</a></li><li id="8d2c" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#901a">如何检索帖子查询字符串参数</a></li><li id="a49e" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#3f9c">发送响应</a></li><li id="8e63" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#cb86">如何服务JSON数据</a></li><li id="1036" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#74db">管理cookie</a></li><li id="e235" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#6ba1">使用HTTP头</a></li><li id="919c" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#5fc3">重定向</a></li><li id="7350" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#32e3">路由</a></li><li id="e640" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#243c"> CORS </a></li><li id="32be" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#a525">模板</a></li><li id="dcca" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#98bb">帕格简介</a></li><li id="b5d3" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#af6b">中间件</a></li><li id="29f5" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#3603">服务静态文件</a></li><li id="9d5f" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#9942">发送文件</a></li><li id="662c" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#e5a4">会话</a></li><li id="03c0" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#2c7d">验证输入</a></li><li id="29c4" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#f1c1">消毒输入</a></li><li id="5f41" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#7fa4">处理表单</a></li><li id="2092" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#fb32">以表格形式上传文件</a></li><li id="c9d0" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#f32a">如何为Node.js创建自签名HTTPS证书以在本地测试应用</a></li><li id="b2f1" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><a class="ae ka" rel="noopener" href="/p/649352e2ae87#c2d0">设置让我们为Express加密</a></li></ul><p id="1bc9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Node.js是一个构建网络服务和应用程序的神奇工具。</p><p id="5e31" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Express在其功能的基础上构建，提供易于使用的功能，满足Web服务器用例的需求。</p><p id="cbe8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它是开源的，免费的，易于扩展，性能非常好，并且有很多很多预构建的包，你可以直接放入并使用，来执行各种事情。</p><h2 id="cf65" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">装置</h2><p id="2be0" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">你可以用npm 将Express安装到任何项目中:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="9632" class="kb kc hu lu b fv ly lz l ma mb">npm install express --save</span></pre><p id="5fbd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">或<a class="ae ka" href="https://flaviocopes.com/yarn/" rel="noopener ugc nofollow" target="_blank">纱</a>:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="ddb4" class="kb kc hu lu b fv ly lz l ma mb">yarn add express</span></pre><p id="d418" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这两个命令也可以在一个空目录下工作，从头开始你的项目，尽管<code class="eh mc md me lu b">npm</code>根本不创建一个<code class="eh mc md me lu b">package.json</code>文件，Yarn创建一个基本文件。</p><p id="45df" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你要从头开始一个新项目，只需运行<code class="eh mc md me lu b">npm init</code>或<code class="eh mc md me lu b">yarn init</code>即可。</p><h2 id="3c1b" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">你好世界</h2><p id="5939" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">我们准备创建我们的第一个Express Web服务器。</p><p id="3d1c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">下面是一些代码:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="5feb" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()</span><span id="4709" class="kb kc hu lu b fv mf lz l ma mb">app.get('/', (req, res) =&gt; res.send('Hello World!'))<br/>app.listen(3000, () =&gt; console.log('Server ready'))</span></pre><p id="9382" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">将它保存到项目根文件夹中的一个<code class="eh mc md me lu b">index.js</code>文件中，并使用</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="2890" class="kb kc hu lu b fv ly lz l ma mb">node index.js</span></pre><p id="18f6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以在本地主机上打开到端口3000的浏览器，您应该会看到<code class="eh mc md me lu b">Hello World!</code>消息。</p><h2 id="e2ea" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">通过理解Hello World代码学习Express的基础知识</h2><p id="f4df" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">这4行代码在幕后做了很多工作。</p><p id="0555" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先，我们将<code class="eh mc md me lu b">express</code>包导入到<code class="eh mc md me lu b">express</code>值中。</p><p id="a89f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们通过调用应用程序的<code class="eh mc md me lu b">app()</code>方法来实例化它。</p><p id="1951" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦我们有了应用程序对象，我们告诉它使用<code class="eh mc md me lu b">get()</code>方法监听<code class="eh mc md me lu b">/</code>路径上的GET请求。</p><p id="0bad" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">每个HTTP <strong class="je hv">动词</strong>都有一个方法:<code class="eh mc md me lu b">get()</code>、<code class="eh mc md me lu b">post()</code>、<code class="eh mc md me lu b">put()</code>、<code class="eh mc md me lu b">delete()</code>、<code class="eh mc md me lu b">patch()</code>:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="bc33" class="kb kc hu lu b fv ly lz l ma mb">app.get('/', (req, res) =&gt; { /* */ })<br/>app.post('/', (req, res) =&gt; { /* */ })<br/>app.put('/', (req, res) =&gt; { /* */ })<br/>app.delete('/', (req, res) =&gt; { /* */ })<br/>app.patch('/', (req, res) =&gt; { /* */ })</span></pre><p id="b48a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">那些方法接受一个回调函数，当一个请求开始时调用这个函数，我们需要处理它。</p><p id="ae88" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们传入一个箭头函数:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="52d2" class="kb kc hu lu b fv ly lz l ma mb">(req, res) =&gt; res.send('Hello World!')</span></pre><p id="1f45" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这个回调中，Express向我们发送了两个对象，我们称之为<code class="eh mc md me lu b">req</code>和<code class="eh mc md me lu b">res</code>，它们分别代表请求和响应对象。</p><p id="7c50" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请求是HTTP请求。它可以给我们关于它的所有信息，包括请求参数、请求头、请求体等等。</p><p id="2631" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Response是我们将发送给客户端的HTTP响应对象。</p><p id="d6da" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们在回调中做的是发送“Hello World！”字符串发送到客户端，使用<code class="eh mc md me lu b">Response.send()</code>方法。</p><p id="3ac8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该方法将该字符串设置为主体，并关闭连接。</p><p id="17bb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">示例的最后一行实际上启动了服务器，并告诉它监听端口<code class="eh mc md me lu b">3000</code>。我们传递一个回调函数，当服务器准备好接受新的请求时调用这个函数。</p><h1 id="12e8" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">请求参数</h1><p id="c3eb" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">我提到了请求对象如何保存所有HTTP请求信息。</p><p id="8f97" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这些是您可能会用到的主要属性:</p><ul class=""><li id="55a9" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated"><strong class="je hv">。app </strong>保存了对Express app对象的引用</li><li id="25f4" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><strong class="je hv">。baseUrl </strong>应用程序响应的基本路径</li><li id="b380" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><strong class="je hv">。主体</strong>包含请求主体中提交的数据(在您可以访问它之前，必须手动解析和填充)</li><li id="076a" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><strong class="je hv">。cookie</strong>包含请求发送的cookie(需要<code class="eh mc md me lu b">cookie-parser</code>中间件)</li><li id="9199" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><strong class="je hv">。主机名</strong>服务器主机名</li><li id="b212" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><strong class="je hv">。ip </strong>服务器ip</li><li id="4417" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><strong class="je hv">。方法</strong>使用的HTTP方法</li><li id="e534" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><strong class="je hv">。params </strong>路线命名参数</li><li id="c844" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><strong class="je hv">。路径</strong>URL路径</li><li id="0da3" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><strong class="je hv">。协议</strong>请求协议</li><li id="a489" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><strong class="je hv">。query </strong>包含请求中使用的所有查询字符串的对象</li><li id="3aae" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><strong class="je hv">。安全</strong>如果请求是安全的，则为真(使用HTTPS)</li><li id="485f" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><strong class="je hv">。signedCookies </strong>包含请求发送的签名cookies(需要<code class="eh mc md me lu b">cookie-parser</code>中间件)</li><li id="8366" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><strong class="je hv">。如果请求是一个<a class="ae ka" href="https://flaviocopes.com/xhr/" rel="noopener ugc nofollow" target="_blank"> XMLHttpRequest </a>则为真</strong></li></ul><h2 id="abc5" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">如何检索GET查询字符串参数</h2><p id="c1b9" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">查询字符串是URL路径后面的部分，以感叹号<code class="eh mc md me lu b">?</code>开头。</p><p id="49f3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">示例:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="bcb9" class="kb kc hu lu b fv ly lz l ma mb">?name=flavio</span></pre><p id="7529" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用<code class="eh mc md me lu b">&amp;</code>可以添加多个查询参数:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="4b75" class="kb kc hu lu b fv ly lz l ma mb">?name=flavio&amp;age=35</span></pre><p id="115a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如何在Express中获得这些查询字符串值？</p><p id="0d93" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Express为我们填充了<code class="eh mc md me lu b">Request.query</code>对象，这让事情变得非常简单:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="660b" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()</span><span id="ada0" class="kb kc hu lu b fv mf lz l ma mb">app.get('/', (req, res) =&gt; {<br/>  console.log(req.query)<br/>})</span><span id="e6b7" class="kb kc hu lu b fv mf lz l ma mb">app.listen(8080)</span></pre><p id="d328" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该对象为每个查询参数填充了一个属性。</p><p id="b8fd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果没有查询参数，它就是一个空对象。</p><p id="d7e8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这使得使用for…in循环对其进行迭代变得很容易:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="b58a" class="kb kc hu lu b fv ly lz l ma mb">for (const key in req.query) {<br/>  console.log(key, req.query[key])<br/>}</span></pre><p id="16b7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这将打印查询属性键和值。</p><p id="7543" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您也可以访问单个属性:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="457b" class="kb kc hu lu b fv ly lz l ma mb">req.query.name //flavio<br/>req.query.age //35</span></pre><h2 id="901a" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">如何检索后查询字符串参数</h2><p id="f96c" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">POST查询参数由HTTP客户端发送，例如通过表单发送，或者在执行POST请求发送数据时发送。</p><p id="b34d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你如何访问这些数据？</p><p id="911a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果使用<code class="eh mc md me lu b">Content-Type: application/json</code>将数据作为JSON发送，您将使用<code class="eh mc md me lu b">express.json()</code>中间件:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="2f31" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()</span><span id="64e7" class="kb kc hu lu b fv mf lz l ma mb">app.use(express.json())</span></pre><p id="f969" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果使用<code class="eh mc md me lu b">Content-Type: application/x-www-form-urlencoded</code>将数据作为JSON发送，您将使用<code class="eh mc md me lu b">express.urlencoded()</code>中间件:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="6c6b" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()</span><span id="6b89" class="kb kc hu lu b fv mf lz l ma mb">app.use(express.urlencoded())</span></pre><p id="548a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这两种情况下，您都可以通过从<code class="eh mc md me lu b">Request.body</code>引用来访问数据:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="c5a5" class="kb kc hu lu b fv ly lz l ma mb">app.post('/form', (req, res) =&gt; {<br/>  const name = req.body.name<br/>})</span></pre><blockquote class="na nb nc"><p id="a8c6" class="jc jd nd je b jf jg jh ji jj jk jl jm ne jo jp jq nf js jt ju ng jw jx jy jz hn dt translated"><em class="hu">注意:旧的Express版本需要使用</em> <code class="eh mc md me lu b"><em class="hu">body-parser</em></code> <em class="hu">模块来处理POST数据。从Express 4.16(2017年9月发布)及以后的版本开始就不再是这样了。</em></p></blockquote><h1 id="3f9c" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">发送响应</h1><p id="5557" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">在Hello World示例中，我们使用了<code class="eh mc md me lu b">Response.send()</code>方法发送一个简单的字符串作为响应，并关闭连接:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="7856" class="kb kc hu lu b fv ly lz l ma mb">(req, res) =&gt; res.send('Hello World!')</span></pre><p id="19e2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你传入一个字符串，它将把<code class="eh mc md me lu b">Content-Type</code>头设置为<code class="eh mc md me lu b">text/html</code>。</p><p id="3d03" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果传入一个对象或数组，它会设置<code class="eh mc md me lu b">application/json</code> <code class="eh mc md me lu b">Content-Type</code>头，并将该参数解析为JSON。</p><p id="af97" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">send()</code>自动设置<code class="eh mc md me lu b">Content-Length</code> HTTP响应头。</p><p id="ca56" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">send()</code>也会自动关闭连接。</p><h2 id="64a8" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">使用end()发送空响应</h2><p id="c4f2" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">发送响应的另一种方法是使用<code class="eh mc md me lu b">Response.end()</code>方法，没有任何正文:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="cf0e" class="kb kc hu lu b fv ly lz l ma mb">res.end()</span></pre><h2 id="2636" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">设置HTTP响应状态</h2><p id="1438" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">使用<code class="eh mc md me lu b">Response.status()</code>:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="bd62" class="kb kc hu lu b fv ly lz l ma mb">res.status(404).end()</span></pre><p id="1831" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">或者</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="9912" class="kb kc hu lu b fv ly lz l ma mb">res.status(404).send('File not found')</span></pre><p id="685a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">sendStatus()</code>是快捷方式:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="09cd" class="kb kc hu lu b fv ly lz l ma mb">res.sendStatus(200)<br/>// === res.status(200).send('OK')</span><span id="6212" class="kb kc hu lu b fv mf lz l ma mb">res.sendStatus(403)<br/>// === res.status(403).send('Forbidden')</span><span id="aa5a" class="kb kc hu lu b fv mf lz l ma mb">res.sendStatus(404)<br/>// === res.status(404).send('Not Found')</span><span id="6a40" class="kb kc hu lu b fv mf lz l ma mb">res.sendStatus(500)<br/>// === res.status(500).send('Internal Server Error')</span></pre><h1 id="cb86" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">如何服务JSON数据</h1><p id="b0a5" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">当您在Express中监听某个路由上的连接时，回调函数将在每个<a class="ae ka" href="https://hackernoon.com/tagged/network" rel="noopener ugc nofollow" target="_blank">网络</a>调用中使用请求对象实例和响应对象实例来调用。</p><p id="aa96" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">示例:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="01cd" class="kb kc hu lu b fv ly lz l ma mb">app.get('/', (req, res) =&gt; res.send('Hello World!'))</span></pre><p id="3cc3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这里我们使用了<code class="eh mc md me lu b">Response.send()</code>方法，它接受任何字符串。</p><p id="b03c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以通过使用<code class="eh mc md me lu b">Response.json()</code>将JSON发送到客户端，这是一个有用的方法。</p><p id="253f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它接受一个对象或数组，并在发送之前将其转换为JSON:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="fa03" class="kb kc hu lu b fv ly lz l ma mb">res.json({ username: 'Flavio' })</span></pre><h1 id="74db" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">管理cookies</h1><h2 id="a1d2" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">如何使用“Response.cookie()”方法来操作您的cookie</h2><p id="f0af" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">使用<code class="eh mc md me lu b">Response.cookie()</code>方法来操作您的cookies。</p><p id="6fa3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">示例:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="988c" class="kb kc hu lu b fv ly lz l ma mb">res.cookie('username', 'Flavio')</span></pre><p id="8547" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该方法接受包含各种选项的第三个参数:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="99fc" class="kb kc hu lu b fv ly lz l ma mb">res.cookie('username', 'Flavio', { domain: '.flaviocopes.com', path: '/administrator', secure: true })</span><span id="2a0f" class="kb kc hu lu b fv mf lz l ma mb">res.cookie('username', 'Flavio', { expires: new Date(Date.now() + 900000), httpOnly: true })</span></pre><p id="0d67" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以设置的最有用的参数是:</p><p id="6553" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">domain</code><a class="ae ka" href="http://localhost:1313/cookies/#set-a-cookie-domain" rel="noopener ugc nofollow" target="_blank">cookie域名</a></p><p id="c7f2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">expires</code>设置<a class="ae ka" href="http://localhost:1313/cookies/#set-a-cookie-expiration-date" rel="noopener ugc nofollow" target="_blank"> cookie有效期</a>。如果缺少或为0，则cookie是会话cookie</p><p id="af65" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">httpOnly</code>将cookie设置为只能由web服务器访问。参见<a class="ae ka" href="https://flaviocopes.com/cookies/#httponly" rel="noopener ugc nofollow" target="_blank"> HttpOnly </a></p><p id="f1bd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">maxAge</code>设置相对于当前时间的到期时间，单位为毫秒</p><p id="f035" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">path</code><a class="ae ka" href="https://flaviocopes.com/cookies/#set-a-cookie-path" rel="noopener ugc nofollow" target="_blank">cookie路径</a>。默认为/</p><p id="26a9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">secure</code>只标志着<a class="ae ka" href="https://flaviocopes.com/cookies/#secure" rel="noopener ugc nofollow" target="_blank">曲奇HTTPS</a></p><p id="1333" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">signed</code>设置要签名的cookie</p><p id="810e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b"><a class="ae ka" href="https://flaviocopes.com/cookies/#samesite" rel="noopener ugc nofollow" target="_blank">SameSite</a></code>的<code class="eh mc md me lu b">sameSite</code>值</p><p id="13d8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">cookie可以通过以下方式清除</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="3406" class="kb kc hu lu b fv ly lz l ma mb">res.clearCookie('username')</span></pre><h1 id="6ba1" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">使用HTTP头</h1><h2 id="2d38" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">从请求中访问HTTP头值</h2><p id="fdec" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">您可以使用<code class="eh mc md me lu b">Request.headers</code>属性访问所有HTTP头:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="0457" class="kb kc hu lu b fv ly lz l ma mb">app.get('/', (req, res) =&gt; {<br/>  console.log(req.headers)<br/>})</span></pre><p id="8df6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用<code class="eh mc md me lu b">Request.header()</code>方法访问一个单独的请求头值:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="e671" class="kb kc hu lu b fv ly lz l ma mb">app.get('/', (req, res) =&gt; {<br/>  req.header('User-Agent')<br/>})</span></pre><h2 id="d9d1" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">更改响应的任何HTTP头值</h2><p id="a107" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">您可以使用<code class="eh mc md me lu b">Response.set()</code>更改任何HTTP头值:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="023b" class="kb kc hu lu b fv ly lz l ma mb">res.set('Content-Type', 'text/html')</span></pre><p id="4bfb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是，内容类型标题有一个快捷方式:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="111f" class="kb kc hu lu b fv ly lz l ma mb">res.type('.html')<br/>// =&gt; 'text/html'</span><span id="76b2" class="kb kc hu lu b fv mf lz l ma mb">res.type('html')<br/>// =&gt; 'text/html'</span><span id="c973" class="kb kc hu lu b fv mf lz l ma mb">res.type('json')<br/>// =&gt; 'application/json'</span><span id="de58" class="kb kc hu lu b fv mf lz l ma mb">res.type('application/json')<br/>// =&gt; 'application/json'</span><span id="f327" class="kb kc hu lu b fv mf lz l ma mb">res.type('png')<br/>// =&gt; image/png:</span></pre><h1 id="5fc3" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">重新寄送</h1><p id="f4ce" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">重定向在Web开发中很常见。您可以使用<code class="eh mc md me lu b">Response.redirect()</code>方法创建一个重定向:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="0f29" class="kb kc hu lu b fv ly lz l ma mb">res.redirect('/go-there')</span></pre><p id="f430" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这创建了一个302重定向。</p><p id="0c95" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">301重定向以这种方式进行:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="c702" class="kb kc hu lu b fv ly lz l ma mb">res.redirect(301, '/go-there')</span></pre><p id="061f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以指定绝对路径(<code class="eh mc md me lu b">/go-there</code>)、绝对url ( <code class="eh mc md me lu b">https://anothersite.com</code>)、相对路径(<code class="eh mc md me lu b">go-there</code>)或使用<code class="eh mc md me lu b">..</code>返回上一级:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="57a6" class="kb kc hu lu b fv ly lz l ma mb">res.redirect('../go-there')<br/>res.redirect('..')</span></pre><p id="0322" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您还可以使用以下方法重定向回Referer HTTP头值(如果未设置，默认为<code class="eh mc md me lu b">/</code>)</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="6491" class="kb kc hu lu b fv ly lz l ma mb">res.redirect('back')</span></pre><h1 id="32e3" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">按指定路线发送</h1><p id="a871" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">路由是确定调用URL时应该发生什么，或者应用程序的哪些部分应该处理特定的传入请求的过程。</p><p id="0d18" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在Hello World示例中，我们使用了以下代码</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="536e" class="kb kc hu lu b fv ly lz l ma mb">app.get('/', (req, res) =&gt; { /* */ })</span></pre><p id="e88e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这创建了一个路由，它将使用HTTP GET方法访问根域URL <code class="eh mc md me lu b">/</code>映射到我们想要提供的响应。</p><h2 id="5ff7" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">命名参数</h2><p id="4b45" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">如果我们想监听自定义请求，也许我们想创建一个接受字符串并返回大写的服务，我们不希望参数作为查询字符串发送，而是作为URL的一部分。我们使用命名参数:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="6321" class="kb kc hu lu b fv ly lz l ma mb">app.get('/uppercase/:theValue', (req, res) =&gt; res.send(req.params.theValue.toUpperCase()))</span></pre><p id="74fd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果我们向<code class="eh mc md me lu b">/uppercase/test</code>发送一个请求，我们将在响应体中得到<code class="eh mc md me lu b">TEST</code>。</p><p id="78c7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以在同一个URL中使用多个命名参数，它们都将存储在<code class="eh mc md me lu b">req.params</code>中。</p><h2 id="1555" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">使用正则表达式匹配路径</h2><p id="32a4" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">您可以使用<a class="ae ka" href="https://flaviocopes.com/javascript-regular-expressions/" rel="noopener ugc nofollow" target="_blank">正则表达式</a>用一条语句匹配多个路径:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="36d0" class="kb kc hu lu b fv ly lz l ma mb">app.get(/post/, (req, res) =&gt; { /* */ })</span></pre><p id="50a4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">会匹配<code class="eh mc md me lu b">/post</code>、<code class="eh mc md me lu b">/post/first</code>、<code class="eh mc md me lu b">/thepost</code>、<code class="eh mc md me lu b">/posting/something</code>，以此类推。</p><h1 id="243c" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">克-奥二氏分级量表</h1><p id="96a6" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">在浏览器中运行的JavaScript应用程序通常只能访问为其服务的同一个域(源)上的HTTP资源。</p><p id="6522" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">加载图像或脚本/样式总是有效的，但是对另一个服务器的XHR和获取调用将会失败，除非那个服务器实现了允许该连接的方法。</p><p id="ed9f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这种方式叫做CORS，<strong class="je hv">跨产地资源共享</strong>。</p><p id="2880" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">此外，使用<code class="eh mc md me lu b">@font-face</code>加载Web字体默认具有同源策略，以及其他不太流行的东西(如WebGL纹理和画布API中加载的<code class="eh mc md me lu b">drawImage</code>资源)。</p><p id="7668" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">需要CORS的一个非常重要的东西是最近在现代浏览器中引入的ES模块。</p><p id="1542" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您没有在服务器上设置允许服务第三方来源的CORS策略<strong class="je hv">，请求将会失败。</strong></p><p id="a04c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">获取示例:</p><figure class="lp lq lr ls fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nh"><img src="../Images/ce47d7b0b8cac6dc91f9855e6d675b4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7dadBaGuH3B_PU8z29enIw.png"/></div></div></figure><p id="c5a9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">XHR的例子:</p><figure class="lp lq lr ls fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ni"><img src="../Images/c29762fe936803280cc6c5796f8035b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*REjz-bvrKhnj8kfCBBY8UA.png"/></div></div></figure><p id="d1d3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在以下情况下，跨来源资源会失败:</p><ul class=""><li id="cbff" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated">到不同的<strong class="je hv">域</strong></li><li id="0520" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">到不同的<strong class="je hv">子域</strong></li><li id="3380" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">去不同的<strong class="je hv">港口</strong></li><li id="a48c" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">到不同的<strong class="je hv">协议</strong></li></ul><p id="dc87" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它是为了您的安全，防止恶意用户利用网络平台。</p><p id="1fd1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是，如果您同时控制服务器和客户机，您就有充分的理由允许它们相互通信。</p><p id="53b8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">怎么会？</p><p id="0a00" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这取决于您的服务器端堆栈。</p><h1 id="fa19" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">浏览器支持</h1><p id="3996" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">相当不错(基本上都是除了IE &lt;10):</p><figure class="lp lq lr ls fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nj"><img src="../Images/3794092729b0443d5f03a28e8e27daf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iky9_Ne6chRFDJR7jinrSw.png"/></div></div></figure><h2 id="2273" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">Example with Express</h2><p id="4d8c" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">If you are using Node.js and Express as a framework, use the <a class="ae ka" href="https://github.com/expressjs/cors" rel="noopener ugc nofollow" target="_blank"> CORS中间件包</a>)。</p><p id="3d64" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">下面是Express Node.js服务器的一个简单实现:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="aa05" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()</span><span id="0333" class="kb kc hu lu b fv mf lz l ma mb">app.get('/without-cors', (req, res, next) =&gt; {<br/>  res.json({ msg: '😞 no CORS, no party!' })<br/>})</span><span id="503f" class="kb kc hu lu b fv mf lz l ma mb">const server = app.listen(3000, () =&gt; {<br/>  console.log('Listening on port %s', server.address().port)<br/>})</span></pre><p id="93a2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您点击<code class="eh mc md me lu b">/without-cors</code>从不同的来源获取请求，这将引发CORS问题。</p><p id="0c3c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你需要做的就是要求上面链接的<code class="eh mc md me lu b">cors</code>包，并把它作为中间件函数传递给端点请求处理器:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="3fa0" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const cors = require('cors')<br/>const app = express()</span><span id="61d6" class="kb kc hu lu b fv mf lz l ma mb">app.get('/with-cors', cors(), (req, res, next) =&gt; {<br/>  res.json({ msg: 'WHOAH with CORS it works! 🔝 🎉' })<br/>})</span><span id="961e" class="kb kc hu lu b fv mf lz l ma mb">/* the rest of the app */</span></pre><p id="9b28" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我举了一个简单的故障例子。这里是客户端正在工作，这里是它的代码:<a class="ae ka" href="https://glitch.com/edit/#!/flavio-cors-client" rel="noopener ugc nofollow" target="_blank">https://glitch.com/edit/#!/flavio-cors-client</a>。</p><p id="2113" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是Node.js快递服务器:<a class="ae ka" href="https://glitch.com/edit/#!/flaviocopes-cors-example-express" rel="noopener ugc nofollow" target="_blank">https://glitch.com/edit/#!/flaviocopes-cors-example-express</a></p><p id="b7a4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请注意由于未正确处理CORS标题而失败的请求是如何被接收的，正如您在<a class="ae ka" href="https://hackernoon.com/tagged/network" rel="noopener ugc nofollow" target="_blank">网络</a>面板中看到的，在这里您可以找到服务器发送的消息:</p><figure class="lp lq lr ls fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nk"><img src="../Images/114a8f13f854bf2cd7a4a5b4933dd14f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V_k9xuUdF53zDHmNhkwCSg.png"/></div></div></figure><h2 id="ff7d" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">仅允许特定的来源</h2><p id="ddef" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">然而，这个例子有一个问题:任何请求都会被服务器接受为跨来源的。</p><p id="aaa2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">正如您在网络面板中看到的，通过的请求有一个响应头<code class="eh mc md me lu b">access-control-allow-origin: *</code>:</p><figure class="lp lq lr ls fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nl"><img src="../Images/20e010903a485c8f5d09f95d806175f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eYshr5kURTCXK_J8b3047Q.png"/></div></div></figure><p id="5ccc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您需要将服务器配置为只允许一个源提供服务，并阻止所有其他源。</p><p id="e81c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用同一个<code class="eh mc md me lu b">cors</code>节点库，您可以这样做:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="2605" class="kb kc hu lu b fv ly lz l ma mb">const cors = require('cors')</span><span id="57fe" class="kb kc hu lu b fv mf lz l ma mb">const corsOptions = {<br/>  origin: 'https://yourdomain.com'<br/>}</span><span id="8d21" class="kb kc hu lu b fv mf lz l ma mb">app.get('/products/:id', cors(corsOptions), (req, res, next) =&gt; {<br/>  //...<br/>})</span></pre><p id="ed54" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你还可以提供更多服务:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="29bf" class="kb kc hu lu b fv ly lz l ma mb">const whitelist = ['http://example1.com', 'http://example2.com']<br/>const corsOptions = {<br/>  origin: function(origin, callback) {<br/>    if (whitelist.indexOf(origin) !== -1) {<br/>      callback(null, true)<br/>    } else {<br/>      callback(new Error('Not allowed by CORS'))<br/>    }<br/>  }<br/>}</span></pre><h2 id="1631" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">起飞前的</h2><p id="0737" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">有些请求是以“简单”的方式处理的。所有的<code class="eh mc md me lu b">GET</code>请求都属于这个组。</p><p id="eca3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">同样<em class="nd">一些</em>T3和<code class="eh mc md me lu b">HEAD</code>请求也是如此。</p><p id="58e9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">POST</code>如果请求满足使用内容类型的要求，它们也属于该组</p><ul class=""><li id="8c7a" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated"><code class="eh mc md me lu b">application/x-www-form-urlencoded</code></li><li id="8b0e" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">multipart/form-data</code></li><li id="d85d" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">text/plain</code></li></ul><p id="e3cd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所有其他请求都必须经过一个称为预检的预先批准阶段。浏览器通过发出一个<code class="eh mc md me lu b">OPTIONS</code>请求来决定它是否有权限执行一个动作。</p><p id="ea24" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">预检请求包含几个标题，服务器将使用这些标题来检查权限(忽略不相关的字段):</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="5202" class="kb kc hu lu b fv ly lz l ma mb">OPTIONS /the/resource/you/request<br/>Access-Control-Request-Method: POST<br/>Access-Control-Request-Headers: origin, x-requested-with, accept<br/>Origin: <a class="ae ka" href="https://your-origin.com" rel="noopener ugc nofollow" target="_blank">https://your-origin.com</a></span></pre><p id="fea0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">服务器将像这样响应(不相关的字段省略):</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="7b28" class="kb kc hu lu b fv ly lz l ma mb">HTTP/1.1 200 OK<br/>Access-Control-Allow-Origin: https://your-origin.com<br/>Access-Control-Allow-Methods: POST, GET, OPTIONS, DELETE</span></pre><p id="f04e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们检查了POST，但是服务器告诉我们，我们还可以为该特定资源发出其他HTTP请求类型。</p><p id="7857" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">按照上面的Node.js Express示例，服务器还必须处理OPTIONS请求:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="d97e" class="kb kc hu lu b fv ly lz l ma mb">var express = require('express')<br/>var cors = require('cors')<br/>var app = express()</span><span id="e713" class="kb kc hu lu b fv mf lz l ma mb">//allow OPTIONS on just one resource<br/>app.options('/the/resource/you/request', cors())</span><span id="46a6" class="kb kc hu lu b fv mf lz l ma mb">//allow OPTIONS on all resources<br/>app.options('*', cors())</span></pre><h1 id="a525" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">模板</h1><p id="82a1" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">Express能够处理服务器端模板引擎。</p><p id="b94a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">模板引擎允许我们向视图添加数据，并动态生成HTML。</p><p id="1d80" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Express使用Jade作为默认值。Jade是老版本的Pug，具体是Pug 1.0。</p><blockquote class="na nb nc"><p id="42ee" class="jc jd nd je b jf jg jh ji jj jk jl jm ne jo jp jq nf js jt ju ng jw jx jy jz hn dt translated"><em class="hu">2016年该项目发布版本2时，由于商标问题，名称从Jade改为Pug。你仍然可以使用Jade，也就是Pug 1.0，但是将来，最好使用Pug 2.0 </em></p></blockquote><p id="9f48" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">虽然Jade的最后一个版本已经3年了(撰写本文时，2018年夏天)，但出于向后兼容的原因，它仍然是Express中的默认版本。</p><p id="b2af" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在任何新项目中，你应该使用Pug或者你选择的其他引擎。帕格的官方网站是<a class="ae ka" href="https://pugjs.org/" rel="noopener ugc nofollow" target="_blank">https://pugjs.org/</a>。</p><p id="a2fa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你可以使用许多不同的模板引擎，包括哈巴狗，车把，小胡子，EJS和更多。</p><h1 id="6c09" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">使用泥料</h1><p id="71b1" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">要使用Pug，我们必须首先安装它:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="bc34" class="kb kc hu lu b fv ly lz l ma mb">npm install pug</span></pre><p id="ef2f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">而在初始化Express app的时候，我们需要设置它:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="b337" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()<br/>app.set('view engine', 'pug')</span></pre><p id="1356" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们现在可以开始在<code class="eh mc md me lu b">.pug</code>文件中编写模板了。</p><p id="8aee" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">创建“关于”视图:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="eaab" class="kb kc hu lu b fv ly lz l ma mb">app.get('/about', (req, res) =&gt; {<br/>  res.render('about')<br/>})</span></pre><p id="8078" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">和<code class="eh mc md me lu b">views/about.pug</code>中的模板:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="062a" class="kb kc hu lu b fv ly lz l ma mb">p Hello from Flavio</span></pre><p id="5fa6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该模板将创建一个内容为<code class="eh mc md me lu b">Hello from Flavio</code>的<code class="eh mc md me lu b">p</code>标签。</p><p id="e3cc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以使用以下公式对变量进行插值</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="0f1d" class="kb kc hu lu b fv ly lz l ma mb">app.get('/about', (req, res) =&gt; {<br/>  res.render('about', { name: 'Flavio' })<br/>})</span><span id="38c0" class="kb kc hu lu b fv mf lz l ma mb">p Hello from #{name}</span></pre><p id="bb83" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是一个关于Pug的简短介绍，在Express中使用它。查看<a class="ae ka" href="https://flaviocopes.com/pug" rel="noopener ugc nofollow" target="_blank"> Pug指南</a>了解更多关于如何使用Pug的信息。</p><p id="f317" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您习惯于使用HTML和插值变量的模板引擎，比如把手(下面将描述)，您可能会遇到问题，尤其是当您需要将现有的HTML转换为Pug时。这个从HTML到Jade的在线转换器(非常相似，但和Pug有点不同)会有很大的帮助:<a class="ae ka" href="https://jsonformatter.org/html-to-jade" rel="noopener ugc nofollow" target="_blank">https://jsonformatter.org/html-to-jade</a></p><h2 id="d5f2" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">使用车把</h2><p id="a1c7" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">让我们试着用车把代替哈巴狗。</p><p id="3aaa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你可以用<code class="eh mc md me lu b">npm install hbs</code>安装它。</p><p id="d252" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在<code class="eh mc md me lu b">views/</code>文件夹中放一个<code class="eh mc md me lu b">about.hbs</code>模板文件:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="cc66" class="kb kc hu lu b fv ly lz l ma mb">Hello from {{name}}</span></pre><p id="d441" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后使用这个快速配置在<code class="eh mc md me lu b">/about</code>上提供服务:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="3fff" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()<br/>const hbs = require('hbs')</span><span id="b804" class="kb kc hu lu b fv mf lz l ma mb">app.set('view engine', 'hbs')<br/>app.set('views', path.join(__dirname, 'views'))</span><span id="c6a6" class="kb kc hu lu b fv mf lz l ma mb">app.get('/about', (req, res) =&gt; {<br/>  res.render('about', { name: 'Flavio' })<br/>})</span><span id="6c88" class="kb kc hu lu b fv mf lz l ma mb">app.listen(3000, () =&gt; console.log('Server ready'))</span></pre><p id="2eb9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您还可以使用<code class="eh mc md me lu b"><a class="ae ka" href="https://github.com/reactjs/express-react-views" rel="noopener ugc nofollow" target="_blank">express-react-views</a></code>包<strong class="je hv">呈现React应用服务器端</strong>。</p><p id="7bd1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">从<code class="eh mc md me lu b">npm install express-react-views react react-dom</code>开始。</p><p id="13ab" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，我们不需要<code class="eh mc md me lu b">hbs</code>，而是需要<code class="eh mc md me lu b">express-react-views</code>并将其用作引擎，使用<code class="eh mc md me lu b">jsx</code>文件:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="212c" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()</span><span id="b599" class="kb kc hu lu b fv mf lz l ma mb">app.set('view engine', 'jsx')<br/>app.engine('jsx', require('express-react-views').createEngine())</span><span id="4c82" class="kb kc hu lu b fv mf lz l ma mb">app.get('/about', (req, res) =&gt; {<br/>  res.render('about', { name: 'Flavio' })<br/>})</span><span id="e888" class="kb kc hu lu b fv mf lz l ma mb">app.listen(3000, () =&gt; console.log('Server ready'))</span></pre><p id="9be6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">只需将一个<code class="eh mc md me lu b">about.jsx</code>文件放入<code class="eh mc md me lu b">views/</code>中，调用<code class="eh mc md me lu b">/about</code>应该会显示一个“Hello from Flavio”字符串:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="7f38" class="kb kc hu lu b fv ly lz l ma mb">const React = require('react')</span><span id="4068" class="kb kc hu lu b fv mf lz l ma mb">class HelloMessage extends React.Component {<br/>  render() {<br/>    return &lt;div&gt;Hello from {this.props.name}&lt;/div&gt;<br/>  }<br/>}</span><span id="8116" class="kb kc hu lu b fv mf lz l ma mb">module.exports = HelloMessage</span></pre><h1 id="98bb" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">帕格简介</h1><p id="399c" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">帕格是什么？它是服务器端Node.js应用程序的模板引擎。</p><p id="54d8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Express能够处理服务器端模板引擎。模板引擎允许我们向视图添加数据，并动态生成HTML。</p><p id="c4fa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">帕格是旧事物的新名称。是<em class="nd">翡翠2.0 </em>。</p><p id="26c5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">由于2016年的商标问题，该项目发布了版本2，名称从Jade改为Pug。你仍然可以使用Jade，也就是Pug 1.0，但是将来，最好使用Pug 2.0</p><blockquote class="na nb nc"><p id="d7e3" class="jc jd nd je b jf jg jh ji jj jk jl jm ne jo jp jq nf js jt ju ng jw jx jy jz hn dt translated"><em class="hu">亦见</em> <a class="ae ka" href="https://pugjs.org/api/migration-v2.html" rel="noopener ugc nofollow" target="_blank"> <em class="hu">玉石与哈巴狗的区别</em> </a></p></blockquote><p id="0c35" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Express使用Jade作为默认值。Jade是老版本的Pug，具体是Pug 1.0。</p><p id="9751" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">虽然Jade的最后一个版本已经3年了(撰写本文时，2018年夏天)，但出于向后兼容的原因，它仍然是Express中的默认版本。</p><p id="b9dd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在任何新项目中，你应该使用Pug或者你选择的其他引擎。帕格的官方网站是<a class="ae ka" href="https://pugjs.org/" rel="noopener ugc nofollow" target="_blank">https://pugjs.org/</a>。</p><h2 id="157e" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">帕格看起来怎么样</h2><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="b3cd" class="kb kc hu lu b fv ly lz l ma mb">p Hello from Flavio</span></pre><p id="5524" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这个模板将创建一个内容为<code class="eh mc md me lu b">Hello from Flavio</code>的<code class="eh mc md me lu b">p</code>标签。</p><p id="3a57" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如你所见，帕格很特别。它将标记名作为一行中的第一件事，剩下的就是放入其中的内容。</p><p id="f472" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您习惯于使用HTML和插值变量的模板引擎，比如把手(下面将描述)，您可能会遇到问题，尤其是当您需要将现有的HTML转换为Pug时。这个从HTML到Jade的在线转换器(与Pug非常相似，但有一点不同)将会有很大的帮助:<a class="ae ka" href="https://jsonformatter.org/html-to-jade" rel="noopener ugc nofollow" target="_blank">https://jsonformatter.org/html-to-jade</a></p><h2 id="3e84" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">安装泥巴</h2><p id="9e07" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">安装Pug就像运行<code class="eh mc md me lu b">npm install</code>一样简单:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="6425" class="kb kc hu lu b fv ly lz l ma mb">npm install pug</span></pre><h2 id="7161" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">将Pug设置为Express中的模板引擎</h2><p id="7d7e" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">而在初始化Express app的时候，我们需要设置它:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="4cc5" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()<br/>app.set('view engine', 'pug')<br/>app.set('views', path.join(__dirname, 'views'))</span></pre><h2 id="0e4c" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">你的第一个Pug模板</h2><p id="101c" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">创建“关于”视图:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="4aec" class="kb kc hu lu b fv ly lz l ma mb">app.get('/about', (req, res) =&gt; {<br/>  res.render('about')<br/>})</span></pre><p id="b9c8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">而<code class="eh mc md me lu b">views/about.pug</code>中的模板:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="aa79" class="kb kc hu lu b fv ly lz l ma mb">p Hello from Flavio</span></pre><p id="a11d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这个模板将创建一个内容为<code class="eh mc md me lu b">Hello from Flavio</code>的<code class="eh mc md me lu b">p</code>标签。</p><h2 id="e050" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">Pug中的插值变量</h2><p id="41bb" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">您可以使用以下方法对变量进行插值</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="4872" class="kb kc hu lu b fv ly lz l ma mb">app.get('/about', (req, res) =&gt; {<br/>  res.render('about', { name: 'Flavio' })<br/>})</span><span id="8eda" class="kb kc hu lu b fv mf lz l ma mb">p Hello from #{name}</span></pre><h2 id="8281" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">插值函数返回值</h2><p id="0942" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">您可以使用以下方法对函数返回值进行插值</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="d28c" class="kb kc hu lu b fv ly lz l ma mb">app.get('/about', (req, res) =&gt; {<br/>  res.render('about', { getName: () =&gt; 'Flavio' })<br/>})</span><span id="1327" class="kb kc hu lu b fv mf lz l ma mb">p Hello from #{getName()}</span></pre><h2 id="2b1e" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">向元素添加id和类属性</h2><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="ee35" class="kb kc hu lu b fv ly lz l ma mb">p#title<br/>p.title</span></pre><h2 id="d820" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">设置文档类型</h2><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="6ef4" class="kb kc hu lu b fv ly lz l ma mb">doctype html</span></pre><h2 id="0e70" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">元标签</h2><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="7a83" class="kb kc hu lu b fv ly lz l ma mb">html<br/>  head<br/>    meta(charset='utf-8')<br/>    meta(http-equiv='X-UA-Compatible', content='IE=edge')<br/>    meta(name='description', content='Some description')<br/>    meta(name='viewport', content='width=device-width, initial-scale=1')</span></pre><h2 id="416b" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">添加脚本和样式</h2><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="9f34" class="kb kc hu lu b fv ly lz l ma mb">html<br/>  head<br/>    script(src="script.js")<br/>    script(src='//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js')</span><span id="6b80" class="kb kc hu lu b fv mf lz l ma mb">    link(rel='stylesheet', href='css/main.css')</span></pre><h2 id="f9ae" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">内嵌脚本</h2><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="436f" class="kb kc hu lu b fv ly lz l ma mb">script alert('test')</span><span id="a6a6" class="kb kc hu lu b fv mf lz l ma mb">script<br/>  (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=<br/>  function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;<br/>  e=o.createElement(i);r=o.getElementsByTagName(i)[0];<br/>  e.src='//www.google-analytics.com/analytics.js';<br/>  r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));<br/>  ga('create','UA-XXXXX-X');ga('send','pageview');</span></pre><h2 id="9506" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">环</h2><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="84cd" class="kb kc hu lu b fv ly lz l ma mb">ul<br/>  each color in ['Red', 'Yellow', 'Blue']<br/>    li= color</span><span id="604c" class="kb kc hu lu b fv mf lz l ma mb">ul<br/>  each color, index in ['Red', 'Yellow', 'Blue']<br/>    li= 'Color number ' + index + ': ' + color</span></pre><h2 id="8964" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">条件式</h2><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="d51a" class="kb kc hu lu b fv ly lz l ma mb">if name<br/>  h2 Hello from #{name}<br/>else<br/>  h2 Hello</span></pre><p id="3509" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">else-if也适用:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="ce17" class="kb kc hu lu b fv ly lz l ma mb">if name<br/>  h2 Hello from #{name}<br/>else if anotherName<br/>  h2 Hello from #{anotherName}<br/>else<br/>  h2 Hello</span></pre><h2 id="a7f2" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">设置变量</h2><p id="9c1a" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">您可以在Pug模板中设置变量:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="a496" class="kb kc hu lu b fv ly lz l ma mb">- var name = 'Flavio'<br/>- var age = 35<br/>- var roger = { name: 'Roger' }<br/>- var dogs = ['Roger', 'Syd']</span></pre><h2 id="84b0" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">递增变量</h2><p id="e5a0" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">您可以使用<code class="eh mc md me lu b">++</code>增加数值变量:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="626c" class="kb kc hu lu b fv ly lz l ma mb">age++</span></pre><h2 id="18cc" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">将变量分配给元素值</h2><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="5cd0" class="kb kc hu lu b fv ly lz l ma mb">p= name</span><span id="2a89" class="kb kc hu lu b fv mf lz l ma mb">span.age= age</span></pre><h2 id="d120" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">迭代变量</h2><p id="b5bb" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">可以用<code class="eh mc md me lu b">for</code>或者<code class="eh mc md me lu b">each</code>。没有区别。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="4451" class="kb kc hu lu b fv ly lz l ma mb">for dog in dogs<br/>    li= dog</span><span id="7901" class="kb kc hu lu b fv mf lz l ma mb">ul<br/>  each dog in dogs<br/>    li= dog</span></pre><p id="d520" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以使用<code class="eh mc md me lu b">.length</code>来获得物品的数量:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="4802" class="kb kc hu lu b fv ly lz l ma mb">p There are #{values.length}</span></pre><p id="2612" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">while</code>是另一种循环:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="7e86" class="kb kc hu lu b fv ly lz l ma mb">- var n = 0;</span><span id="53f4" class="kb kc hu lu b fv mf lz l ma mb">ul<br/>  while n &lt;= 5<br/>    li= n++</span></pre><h2 id="2409" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">包括其他Pug文件</h2><p id="b0ef" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">在Pug文件中，您可以包含其他Pug文件:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="9bd1" class="kb kc hu lu b fv ly lz l ma mb">include otherfile.pug</span></pre><h2 id="019d" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">定义块</h2><p id="e8b1" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">一个组织良好的模板系统将定义一个基础模板，然后所有其他模板从它扩展。</p><p id="09d3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">模板的一部分可以通过使用块来扩展:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="aade" class="kb kc hu lu b fv ly lz l ma mb">html<br/>  head<br/>    script(src="script.js")<br/>    script(src='//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js')</span><span id="dc9f" class="kb kc hu lu b fv mf lz l ma mb">    link(rel='stylesheet', href='css/main.css')<br/>    block head<br/>  body<br/>    block body<br/>      h1 Home page<br/>      p welcome</span></pre><p id="17e2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这种情况下，一个块<code class="eh mc md me lu b">body</code>具有一些内容，而<code class="eh mc md me lu b">head</code>没有。<code class="eh mc md me lu b">head</code>是用来给标题添加额外的内容，而<code class="eh mc md me lu b">body</code>的内容会被其他页面覆盖。</p><h2 id="5259" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">扩展基本模板</h2><p id="4c58" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">一个模板可以通过使用<code class="eh mc md me lu b">extends</code>关键字来扩展一个基础模板:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="9704" class="kb kc hu lu b fv ly lz l ma mb">extends home.pug</span></pre><p id="e8c7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">完成后，您需要重新定义块。模板的所有内容必须放入块中，否则引擎不知道将它们放在哪里。</p><p id="9fc1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">示例:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="3978" class="kb kc hu lu b fv ly lz l ma mb">extends home.pug</span><span id="250b" class="kb kc hu lu b fv mf lz l ma mb">block body<br/>  h1 Another page<br/>  p Hey!<br/>  ul<br/>    li Something<br/>    li Something else</span></pre><p id="cac0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以重新定义一个或多个块。未重新定义的模板将保留原始模板内容。</p><h2 id="e31b" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">评论</h2><p id="717e" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">Pug中的注释有两种类型:在结果HTML中可见或不可见。</p><h2 id="ff54" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">看得见的</h2><p id="b683" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">内嵌:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="f446" class="kb kc hu lu b fv ly lz l ma mb">// some comment</span></pre><p id="a90d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">阻止:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="9273" class="kb kc hu lu b fv ly lz l ma mb">//<br/>  some<br/>  comment</span></pre><h2 id="1ec0" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">看不见的</h2><p id="6a78" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">内嵌:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="d43c" class="kb kc hu lu b fv ly lz l ma mb">//- some comment</span></pre><p id="738b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">阻止:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="bf0a" class="kb kc hu lu b fv ly lz l ma mb">//-<br/>  some<br/>  comment</span></pre><h1 id="af6b" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">中间件</h1><p id="a0b9" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">中间件是一种与路由过程挂钩的功能，根据它想要做的事情，在某个时候执行一些操作。</p><p id="b86a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它通常用于编辑请求或响应对象，或者在请求到达路由处理程序代码之前终止请求。</p><p id="3868" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它被添加到执行堆栈，如下所示:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="a0c1" class="kb kc hu lu b fv ly lz l ma mb">app.use((req, res, next) =&gt; { /* */ })</span></pre><p id="a457" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这类似于定义一个路由，但是除了请求和响应对象实例之外，我们还有一个对下一个中间件函数<em class="nd">的引用，我们将它赋给了变量<code class="eh mc md me lu b">next</code>。</em></p><p id="fb63" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们总是在中间件函数的末尾调用<code class="eh mc md me lu b">next()</code>,将执行传递给下一个处理程序，除非我们想提前结束响应，并将其发送回客户端。</p><p id="a6b6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你通常使用预制的中间件，以<code class="eh mc md me lu b">npm</code>包的形式。这里的列出了一个很大的可用列表。</p><p id="16fb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一个例子是<code class="eh mc md me lu b">cookie-parser</code>，它用于将cookies解析成<code class="eh mc md me lu b">req.cookies</code>对象。您使用<code class="eh mc md me lu b">npm install cookie-parser</code>安装它，您可以像这样使用它:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="a3d9" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()<br/>const cookieParser = require('cookie-parser')</span><span id="0562" class="kb kc hu lu b fv mf lz l ma mb">app.get('/', (req, res) =&gt; res.send('Hello World!'))</span><span id="47c2" class="kb kc hu lu b fv mf lz l ma mb">app.use(cookieParser())<br/>app.listen(3000, () =&gt; console.log('Server ready'))</span></pre><p id="5a62" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您还可以将中间件功能设置为仅针对特定路由运行，而不是针对所有路由，方法是将其用作路由定义的第二个参数:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="60c6" class="kb kc hu lu b fv ly lz l ma mb">const myMiddleware = (req, res, next) =&gt; {<br/>  /* ... */<br/>  next()<br/>}</span><span id="12d6" class="kb kc hu lu b fv mf lz l ma mb">app.get('/', myMiddleware, (req, res) =&gt; res.send('Hello World!'))</span></pre><p id="beda" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您需要存储中间件中生成的数据，以便将其传递给后续的中间件功能，或者传递给请求处理器，您可以使用<code class="eh mc md me lu b">Request.locals</code>对象。它会将该数据附加到当前请求:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="ca31" class="kb kc hu lu b fv ly lz l ma mb">req.locals.name = 'Flavio'</span></pre><h1 id="3603" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">提供静态文件</h1><p id="c365" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">在<code class="eh mc md me lu b">public</code>子文件夹中存放图像、CSS等内容并将其暴露在根级别是很常见的:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="9a2d" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()</span><span id="d530" class="kb kc hu lu b fv mf lz l ma mb">app.use(express.static('public'))</span><span id="0efb" class="kb kc hu lu b fv mf lz l ma mb">/* ... */</span><span id="f565" class="kb kc hu lu b fv mf lz l ma mb">app.listen(3000, () =&gt; console.log('Server ready'))</span></pre><p id="27ef" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您在<code class="eh mc md me lu b">public/</code>中有一个<code class="eh mc md me lu b">index.html</code>文件，那么如果您现在点击根域URL ( <code class="eh mc md me lu b">http://localhost:3000</code>)，它就会被提供</p><h1 id="9942" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">发送文件</h1><p id="4edc" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">Express提供了一种将文件作为附件传输的简便方法:<code class="eh mc md me lu b">Response.download()</code>。</p><p id="f270" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦用户点击使用这种方法发送文件的路径，浏览器将提示用户下载。</p><p id="9509" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">Response.download()</code>方法允许你发送一个附加在请求上的文件，浏览器不会把它显示在页面上，而是把它保存到磁盘上。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="b04f" class="kb kc hu lu b fv ly lz l ma mb">app.get('/', (req, res) =&gt; res.download('./file.pdf'))</span></pre><p id="8505" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在应用程序的上下文中:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="4db0" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()</span><span id="ae77" class="kb kc hu lu b fv mf lz l ma mb">app.get('/', (req, res) =&gt; res.download('./file.pdf'))<br/>app.listen(3000, () =&gt; console.log('Server ready'))</span></pre><p id="f901" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以用自定义文件名设置要发送的文件:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="374d" class="kb kc hu lu b fv ly lz l ma mb">res.download('./file.pdf', 'user-facing-filename.pdf')</span></pre><p id="f770" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">此方法提供了一个回调函数，一旦文件被发送，您可以使用该函数来执行代码:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="7c39" class="kb kc hu lu b fv ly lz l ma mb">res.download('./file.pdf', 'user-facing-filename.pdf', (err) =&gt; {<br/>  if (err) {<br/>    //handle error<br/>    return<br/>  } else {<br/>    //do something<br/>  }<br/>})</span></pre><h1 id="e5a4" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">会议</h1><p id="633f" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">默认情况下，快速请求是连续的，没有请求可以相互链接。没有办法知道这个请求是否来自以前已经执行过请求的客户端。</p><p id="ad1f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">除非使用某种机制，否则无法识别用户。</p><p id="41e6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这就是会话。</p><p id="1dd2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当实现时，你的API或网站的每个用户将被分配一个唯一的会话，这允许你存储用户状态。</p><p id="39da" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们将使用由Express团队维护的<code class="eh mc md me lu b">express-session</code>模块。</p><p id="8248" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以使用安装它</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="2f3f" class="kb kc hu lu b fv ly lz l ma mb">npm install express-session</span></pre><p id="07f6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">完成后，您可以在您的应用程序中用</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="fdda" class="kb kc hu lu b fv ly lz l ma mb">const session = require('express-session')</span></pre><p id="67d6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是一个中间件，所以你<em class="nd">在快速使用中安装</em>它</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="4d78" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const session = require('express-session')</span><span id="b1bb" class="kb kc hu lu b fv mf lz l ma mb">const app = express()<br/>app.use(session(<br/>  'secret': '343ji43j4n3jn4jk3n'<br/>))</span></pre><p id="1b26" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">完成后，所有对应用程序路由的请求现在都使用会话。</p><p id="31a6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">secret</code>是唯一必需的参数，但是您可以使用更多的参数。对于您的应用程序，它应该是一个随机唯一的字符串。</p><p id="f507" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">会话被附加到请求上，所以您可以在这里使用<code class="eh mc md me lu b">req.session</code>来访问它:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="88ed" class="kb kc hu lu b fv ly lz l ma mb">app.get('/', (req, res, next) =&gt; {<br/>  // req.session<br/>}</span></pre><p id="768e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该对象可用于从会话中获取数据，也可用于设置数据:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="4e2d" class="kb kc hu lu b fv ly lz l ma mb">req.session.name = 'Flavio'<br/>console.log(req.session.name) // 'Flavio'</span></pre><p id="84b1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这些数据在存储时被序列化为JSON，所以使用嵌套对象是安全的。</p><p id="8db5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以使用会话将数据传递给稍后执行的中间件，或者在以后的请求中检索数据。</p><p id="136f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">会话数据存储在哪里？这取决于你如何设置<code class="eh mc md me lu b">express-session</code>模块。</p><p id="971c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它可以将会话数据存储在</p><ul class=""><li id="7928" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated"><strong class="je hv">内存</strong>，不用于生产</li><li id="69b8" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">像MySQL或Mongo这样的数据库</li><li id="5171" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">像Redis或Memcached这样的内存缓存</li></ul><blockquote class="na nb nc"><p id="38b4" class="jc jd nd je b jf jg jh ji jj jk jl jm ne jo jp jq nf js jt ju ng jw jx jy jz hn dt translated"><em class="hu">在</em><a class="ae ka" href="https://github.com/expressjs/session" rel="noopener ugc nofollow" target="_blank"><em class="hu">https://github.com/expressjs/session</em></a>中有一个很大的第三个包列表，它们实现了各种不同的兼容缓存存储</p></blockquote><p id="586e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所有解决方案都将会话id存储在cookie中，并将数据保存在服务器端。客户机将在一个cookie中接收会话id，并将它与每个HTTP请求一起发送。</p><p id="420a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们将引用服务器端来将会话id与本地存储的数据关联起来。</p><p id="f86c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">内存是默认的，它不需要你进行特殊的设置，这是最简单的事情，但是它仅仅是为了开发的目的。</p><p id="f8c3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最好的选择是像Redis这样的内存缓存，为此您需要建立自己的基础设施。</p><p id="bd8a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">另一个在Express中管理会话的流行包是<code class="eh mc md me lu b">cookie-session</code>，它有一个很大的不同:它在cookie中存储客户端数据。我不建议这样做，因为将数据存储在cookies中意味着它存储在客户端，并在用户发出的每个请求中来回发送。它的大小也有限，因为它只能存储4千字节的数据。Cookies也需要被保护，但是默认情况下它们是不安全的，因为安全的Cookies在HTTPS站点上是可能的，如果你有代理，你需要配置它们。</p><h1 id="2c7d" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">验证输入</h1><p id="186f" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">假设您有一个接受姓名、电子邮件和年龄参数的POST端点:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="35ad" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()</span><span id="6a52" class="kb kc hu lu b fv mf lz l ma mb">app.use(express.json())</span><span id="3a22" class="kb kc hu lu b fv mf lz l ma mb">app.post('/form', (req, res) =&gt; {<br/>  const name  = req.body.name<br/>  const email = req.body.email<br/>  const age   = req.body.age<br/>})</span></pre><p id="a26c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您如何在服务器端验证这些结果以确保</p><ul class=""><li id="e29f" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated">名称是至少3个字符的字符串。</li><li id="9c12" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">邮件是真邮件？</li><li id="77f0" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">年龄是一个数字，在0到110之间？</li></ul><p id="17df" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在Express中处理来自外部的任何类型的输入的最好方法是使用<code class="eh mc md me lu b"><a class="ae ka" href="https://express-validator.github.io/" rel="noopener ugc nofollow" target="_blank">express-validator</a></code> <a class="ae ka" href="https://express-validator.github.io/" rel="noopener ugc nofollow" target="_blank">包</a>:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="948d" class="kb kc hu lu b fv ly lz l ma mb">npm install express-validator</span></pre><p id="47fa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您需要包中的<code class="eh mc md me lu b">check</code>对象:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="a8a8" class="kb kc hu lu b fv ly lz l ma mb">const { check } = require('express-validator/check')</span></pre><p id="2e1b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们传递一组<code class="eh mc md me lu b">check()</code>调用作为<code class="eh mc md me lu b">post()</code>调用的第二个参数。每个<code class="eh mc md me lu b">check()</code>调用都接受参数名作为自变量:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="1a11" class="kb kc hu lu b fv ly lz l ma mb">app.post('/form', [<br/>  check('name').isLength({ min: 3 }),<br/>  check('email').isEmail(),<br/>  check('age').isNumeric()<br/>], (req, res) =&gt; {<br/>  const name  = req.body.name<br/>  const email = req.body.email<br/>  const age   = req.body.age<br/>})</span></pre><p id="1c5a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注意我用了</p><ul class=""><li id="6f73" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated"><code class="eh mc md me lu b">isLength()</code></li><li id="2f89" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isEmail()</code></li><li id="6449" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isNumeric()</code></li></ul><p id="9899" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这些方法还有很多，都来自<a class="ae ka" href="https://github.com/chriso/validator.js#validators" rel="noopener ugc nofollow" target="_blank"> validator.js </a>，包括:</p><ul class=""><li id="9765" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated"><code class="eh mc md me lu b">contains()</code>，检查数值是否包含规定值</li><li id="55a6" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">equals()</code>，检查值是否等于规定值</li><li id="eef5" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isAlpha()</code></li><li id="31c3" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isAlphanumeric()</code></li><li id="2cb0" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isAscii()</code></li><li id="a221" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isBase64()</code></li><li id="dd05" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isBoolean()</code></li><li id="d802" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isCurrency()</code></li><li id="c6b8" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isDecimal()</code></li><li id="f1d3" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isEmpty()</code></li><li id="745f" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isFQDN()</code>，是全限定域名吗？</li><li id="fc95" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isFloat()</code></li><li id="1adc" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isHash()</code></li><li id="1dc5" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isHexColor()</code></li><li id="632f" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isIP()</code></li><li id="d085" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isIn()</code>，检查该值是否在允许值的数组中</li><li id="da12" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isInt()</code></li><li id="55e8" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isJSON()</code></li><li id="8589" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isLatLong()</code></li><li id="81e5" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isLength()</code></li><li id="3205" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isLowercase()</code></li><li id="acfb" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isMobilePhone()</code></li><li id="bcb6" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isNumeric()</code></li><li id="cecc" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isPostalCode()</code></li><li id="5035" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isURL()</code></li><li id="2cd3" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isUppercase()</code></li><li id="ef7a" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isWhitelisted()</code>，根据允许字符的白名单检查输入</li></ul><p id="6de8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以使用<code class="eh mc md me lu b">matches()</code>根据正则表达式验证输入。</p><p id="eba4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">可以使用以下工具检查日期</p><ul class=""><li id="db1d" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated"><code class="eh mc md me lu b">isAfter()</code>，检查输入的日期是否在您传递的日期之后</li><li id="db26" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isBefore()</code>，检查输入的日期是否在您传递的日期之前</li><li id="0070" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isISO8601()</code></li><li id="a621" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">isRFC3339()</code></li></ul><p id="d552" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">关于如何使用这些验证器的确切细节，请参考<a class="ae ka" href="https://github.com/chriso/validator.js#validators" rel="noopener ugc nofollow" target="_blank">https://github.com/chriso/validator.js#validators</a>。</p><p id="4363" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所有这些检查都可以通过管道进行组合:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="ac8f" class="kb kc hu lu b fv ly lz l ma mb">check('name')<br/>  .isAlpha()<br/>  .isLength({ min: 10 })</span></pre><p id="439e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果有任何错误，服务器会自动发送响应来传达错误。例如，如果电子邮件无效，将返回以下内容:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="832e" class="kb kc hu lu b fv ly lz l ma mb">{<br/>  "errors": [{<br/>    "location": "body",<br/>    "msg": "Invalid value",<br/>    "param": "email"<br/>  }]<br/>}</span></pre><p id="2846" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">可以使用<code class="eh mc md me lu b">withMessage()</code>为您执行的每个检查覆盖该默认错误:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="bdfc" class="kb kc hu lu b fv ly lz l ma mb">check('name')<br/>  .isAlpha()<br/>  .withMessage('Must be only alphabetical chars')<br/>  .isLength({ min: 10 })<br/>  .withMessage('Must be at least 10 chars long')</span></pre><p id="70e4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你想写你自己的特殊的，定制的验证器呢？您可以使用<code class="eh mc md me lu b">custom</code>验证器。</p><p id="0a07" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在回调函数中，您可以通过抛出异常或返回拒绝的承诺来拒绝验证:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="13ba" class="kb kc hu lu b fv ly lz l ma mb">app.post('/form', [<br/>  check('name').isLength({ min: 3 }),<br/>  check('email').custom(email =&gt; {<br/>    if (alreadyHaveEmail(email)) {<br/>      throw new Error('Email already registered')<br/>    }<br/>  }),<br/>  check('age').isNumeric()<br/>], (req, res) =&gt; {<br/>  const name  = req.body.name<br/>  const email = req.body.email<br/>  const age   = req.body.age<br/>})</span></pre><p id="fea3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">自定义验证程序:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="6d1e" class="kb kc hu lu b fv ly lz l ma mb">check('email').custom(email =&gt; {<br/>  if (alreadyHaveEmail(email)) {<br/>    throw new Error('Email already registered')<br/>  }<br/>})</span></pre><p id="7eb8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">可以改写为</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="cccc" class="kb kc hu lu b fv ly lz l ma mb">check('email').custom(email =&gt; {<br/>  if (alreadyHaveEmail(email)) {<br/>    return Promise.reject('Email already registered')<br/>  }<br/>})</span></pre><h1 id="f1c1" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">净化输入</h1><p id="3dad" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">您已经看到了如何验证来自外部世界的输入到您的Express应用程序。</p><p id="3a58" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当你运行一个面向公众的服务器时，你很快就会明白一件事:永远不要相信输入。</p><p id="674d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">即使您清理并确保人们不能使用客户端代码输入奇怪的东西，您仍然会受到人们使用工具(甚至只是浏览器开发工具)直接向您的端点发布的影响。</p><p id="b0c6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">或者机器人尝试人类已知的各种可能的利用方式。</p><p id="3b2d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你需要做的是净化你的输入。</p><p id="5527" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您已经用来验证输入的<code class="eh mc md me lu b"><a class="ae ka" href="https://express-validator.github.io/" rel="noopener ugc nofollow" target="_blank">express-validator</a></code> <a class="ae ka" href="https://express-validator.github.io/" rel="noopener ugc nofollow" target="_blank">包</a>也可以方便地用来执行清理。</p><p id="a693" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">假设您有一个接受姓名、电子邮件和年龄参数的POST端点:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="e220" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()</span><span id="1d43" class="kb kc hu lu b fv mf lz l ma mb">app.use(express.json())</span><span id="819e" class="kb kc hu lu b fv mf lz l ma mb">app.post('/form', (req, res) =&gt; {<br/>  const name  = req.body.name<br/>  const email = req.body.email<br/>  const age   = req.body.age<br/>})</span></pre><p id="d0b5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以使用以下方法验证它:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="e48b" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()</span><span id="83b4" class="kb kc hu lu b fv mf lz l ma mb">app.use(express.json())</span><span id="f988" class="kb kc hu lu b fv mf lz l ma mb">app.post('/form', [<br/>  check('name').isLength({ min: 3 }),<br/>  check('email').isEmail(),<br/>  check('age').isNumeric()<br/>], (req, res) =&gt; {<br/>  const name  = req.body.name<br/>  const email = req.body.email<br/>  const age   = req.body.age<br/>})</span></pre><p id="6d79" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以通过在验证方法之后管道化清理方法来添加清理:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="b413" class="kb kc hu lu b fv ly lz l ma mb">app.post('/form', [<br/>  check('name').isLength({ min: 3 }).trim().escape(),<br/>  check('email').isEmail().normalizeEmail(),<br/>  check('age').isNumeric().trim().escape()<br/>], (req, res) =&gt; {<br/>  //...<br/>})</span></pre><p id="e267" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这里我使用的方法是:</p><ul class=""><li id="5eac" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated"><code class="eh mc md me lu b">trim()</code>修剪字符串开头和结尾的字符(默认为空白)</li><li id="1317" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">escape()</code>用对应的HTML实体替换<code class="eh mc md me lu b">&lt;</code>、<code class="eh mc md me lu b">&gt;</code>、<code class="eh mc md me lu b">&amp;</code>、<code class="eh mc md me lu b">'</code>、<code class="eh mc md me lu b">"</code>和<code class="eh mc md me lu b">/</code></li><li id="cb71" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">normalizeEmail()</code>规范电子邮件地址。接受多个小写电子邮件地址或子地址选项(如<code class="eh mc md me lu b">flavio+newsletters@gmail.com</code>)</li></ul><p id="13f5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">其他消毒方法:</p><ul class=""><li id="f13b" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated"><code class="eh mc md me lu b">blacklist()</code>删除出现在黑名单中的角色</li><li id="59ad" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">whitelist()</code>删除未出现在白名单中的字符</li><li id="ead4" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">unescape()</code>用<code class="eh mc md me lu b">&lt;</code>、<code class="eh mc md me lu b">&gt;</code>、<code class="eh mc md me lu b">&amp;</code>、<code class="eh mc md me lu b">'</code>、<code class="eh mc md me lu b">"</code>和<code class="eh mc md me lu b">/</code>替换HTML编码的实体</li><li id="4d08" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">ltrim()</code>类似trim()，但只修剪字符串开头的字符</li><li id="50d0" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">rtrim()</code>类似trim()，但只修剪字符串末尾的字符</li><li id="80ab" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">stripLow()</code>删除通常不可见的ASCII控制字符</li></ul><p id="7f40" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">强制转换为一种格式:</p><ul class=""><li id="d039" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated"><code class="eh mc md me lu b">toBoolean()</code>将输入字符串转换成布尔值。除“0”、“false”和“”之外的所有内容都返回true。在严格模式下，只有' 1 '和' true '返回true</li><li id="8554" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">toDate()</code>将输入字符串转换为日期，如果输入不是日期，则为null</li><li id="8219" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">toFloat()</code>将输入字符串转换为浮点数，如果输入不是浮点数，则转换为NaN</li><li id="9271" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">toInt()</code>将输入字符串转换为整数，如果输入不是整数，则转换为NaN</li></ul><p id="2858" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">与自定义验证器一样，您可以创建一个自定义杀毒器。</p><p id="d4e5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在回调函数中，您只需返回净化后的值:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="86c2" class="kb kc hu lu b fv ly lz l ma mb">const sanitizeValue = value =&gt; {<br/>  //sanitize...<br/>}</span><span id="fca5" class="kb kc hu lu b fv mf lz l ma mb">app.post('/form', [<br/>  check('value').customSanitizer(value =&gt; {<br/>    return sanitizeValue(value)<br/>  }),<br/>], (req, res) =&gt; {<br/>  const value  = req.body.value<br/>})</span></pre><h1 id="7fa4" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">处理表单</h1><p id="7770" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">这是一个HTML表单的示例:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="73a8" class="kb kc hu lu b fv ly lz l ma mb">&lt;form method="POST" action="/submit-form"&gt;<br/>  &lt;input type="text" name="username" /&gt;<br/>  &lt;input type="submit" /&gt;<br/>&lt;/form&gt;</span></pre><p id="43e8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当用户按下提交按钮时，浏览器会自动向页面同一原点的<code class="eh mc md me lu b">/submit-form</code> URL发出一个<code class="eh mc md me lu b">POST</code>请求，发送包含的数据，编码为<code class="eh mc md me lu b">application/x-www-form-urlencoded</code>。在这种情况下，表单数据包含<code class="eh mc md me lu b">username</code>输入字段值。</p><p id="ddeb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">表单也可以使用<code class="eh mc md me lu b">GET</code>方法发送数据，但是您将构建的绝大多数表单都将使用<code class="eh mc md me lu b">POST</code>。</p><p id="4de9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">表单数据将在POST请求正文中发送。</p><p id="9f3b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要提取它，您将使用Express提供的<code class="eh mc md me lu b">express.urlencoded()</code>中间件:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="b23e" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()</span><span id="1407" class="kb kc hu lu b fv mf lz l ma mb">app.use(express.urlencoded())</span></pre><p id="04dc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在您需要在<code class="eh mc md me lu b">/submit-form</code>路线上创建一个<code class="eh mc md me lu b">POST</code>端点，任何数据都可以在<code class="eh mc md me lu b">Request.body</code>上获得:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="9629" class="kb kc hu lu b fv ly lz l ma mb">app.post('/submit-form', (req, res) =&gt; {<br/>  const username = req.body.username<br/>  //...<br/>  res.end()<br/>})</span></pre><p id="cacb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">不要忘记在使用数据之前使用<code class="eh mc md me lu b">express-validator</code>对其进行验证。</p><h1 id="fb32" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">表单中的文件上传</h1><p id="9b23" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">这是一个允许用户上传文件的HTML表单示例:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="ebad" class="kb kc hu lu b fv ly lz l ma mb">&lt;form method="POST" action="/submit-form"&gt;<br/>  &lt;input type="file" name="document" /&gt;<br/>  &lt;input type="submit" /&gt;<br/>&lt;/form&gt;</span></pre><p id="a364" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当用户按下提交按钮时，浏览器会自动向页面同一原点的<code class="eh mc md me lu b">/submit-form</code> URL发出<code class="eh mc md me lu b">POST</code>请求，发送其中包含的数据，不是像普通形式那样编码为<code class="eh mc md me lu b">application/x-www-form-urlencoded</code>，而是编码为<code class="eh mc md me lu b">multipart/form-data</code>。</p><p id="efee" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在服务器端，处理多部分数据可能很棘手并且容易出错，所以我们将使用一个名为<strong class="je hv">强大的</strong>的实用程序库。这里是GitHub repo ，它有超过4000颗星星，维护得很好。</p><p id="ce70" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以使用以下方式安装它:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="2587" class="kb kc hu lu b fv ly lz l ma mb">npm install formidable</span></pre><p id="3504" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后在Node.js文件中包含它:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="5b10" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()<br/>const formidable = require('formidable')</span></pre><p id="52d6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，在<code class="eh mc md me lu b">/submit-form</code>路线的<code class="eh mc md me lu b">POST</code>端点，我们使用<code class="eh mc md me lu b">formidable.IncomingFrom()</code>实例化一个新的强大表单:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="cb0b" class="kb kc hu lu b fv ly lz l ma mb">app.post('/submit-form', (req, res) =&gt; {<br/>  new formidable.IncomingFrom()<br/>})</span></pre><p id="4c2a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这样做之后，我们需要解析表单。我们可以通过提供一个回调来同步完成，这意味着所有的文件都被处理，一旦完成，它就使它们可用:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="83e7" class="kb kc hu lu b fv ly lz l ma mb">app.post('/submit-form', (req, res) =&gt; {<br/>  new formidable.IncomingFrom().parse(req, (err, fields, files) =&gt; {<br/>    if (err) {<br/>      console.error('Error', err)<br/>      throw err<br/>    }<br/>    console.log('Fields', fields)<br/>    console.log('Files', files)<br/>    files.map(file =&gt; {<br/>      console.log(file)<br/>    })<br/>  })<br/>})</span></pre><p id="d88a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">或者您可以使用事件而不是回调，在解析每个文件时得到通知，以及其他事件，如结束处理、接收非文件字段或发生错误:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="5bc5" class="kb kc hu lu b fv ly lz l ma mb">app.post('/submit-form', (req, res) =&gt; {<br/>  new formidable.IncomingFrom().parse(req)<br/>    .on('field', (name, field) =&gt; {<br/>      console.log('Field', name, field)<br/>    })<br/>    .on('file', (name, file) =&gt; {<br/>      console.log('Uploaded file', name, file)<br/>    })<br/>    .on('aborted', () =&gt; {<br/>      console.error('Request aborted by the user')<br/>    })<br/>    .on('error', (err) =&gt; {<br/>      console.error('Error', err)<br/>      throw err<br/>    })<br/>    .on('end', () =&gt; {<br/>      res.end()<br/>    })<br/>})</span></pre><p id="42aa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">无论你选择哪种方式，你都会得到一个或多个令人生畏的东西。文件对象，它为您提供关于上传文件的信息。以下是您可以调用的一些方法:</p><ul class=""><li id="946e" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated"><code class="eh mc md me lu b">file.size</code>，文件大小以字节为单位</li><li id="26a0" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">file.path</code>，该文件写入的路径</li><li id="da7a" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">file.name</code>，文件的名称</li><li id="e0a0" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">file.type</code>，文件的MIME类型</li></ul><p id="0bde" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该路径默认为临时文件夹，如果您收听<code class="eh mc md me lu b">fileBegin</code>事件，可以修改该路径:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="791a" class="kb kc hu lu b fv ly lz l ma mb">app.post('/submit-form', (req, res) =&gt; {<br/>  new formidable.IncomingFrom().parse(req)<br/>    .on('fileBegin', (name, file) =&gt; {<br/>      form.on('fileBegin', (name, file) =&gt; {<br/>        file.path = __dirname + '/uploads/' + file.name<br/>      })<br/>    })<br/>    .on('file', (name, file) =&gt; {<br/>      console.log('Uploaded file', name, file)<br/>    })<br/>    //...<br/>})</span></pre><h1 id="f32a" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">如何为Node.js创建自签名HTTPS证书以在本地测试应用程序</h1><p id="e081" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">为了能够从本地主机为HTTPS上的站点提供服务，您需要创建一个自签名证书。</p><p id="bc98" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">自签名证书足以建立安全的HTTPS连接，尽管浏览器会抱怨该证书是自签名的，因此不可信。这对于开发来说非常好。</p><p id="2bb5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要创建证书，您的系统上必须安装有<strong class="je hv"> OpenSSL </strong>。</p><p id="34b0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可能已经安装了它，只需在您的终端中键入<code class="eh mc md me lu b">openssl</code>进行测试。</p><p id="4f63" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果没有，在Mac上你可以使用<code class="eh mc md me lu b">brew install openssl</code>安装它，如果你使用<a class="ae ka" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank">自制软件</a>。否则在Google上搜索“如何在上安装openssl”。</p><p id="28be" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦安装了OpenSSL，运行以下命令:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="15e9" class="kb kc hu lu b fv ly lz l ma mb">openssl req -nodes -new -x509 -keyout server.key -out server.cert</span></pre><p id="bcd1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它会问你几个问题。首先是国名:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="c54a" class="kb kc hu lu b fv ly lz l ma mb">Generating a 1024 bit RSA private key<br/>...........++++++<br/>.........++++++<br/>writing new private key to 'server.key'<br/>-----<br/>You are about to be asked to enter information that will be incorporated into your certificate request.<br/>What you are about to enter is what is called a Distinguished Name or a DN.<br/>There are quite a few fields but you can leave some blank<br/>For some fields there will be a default value,<br/>If you enter '.', the field will be left blank.<br/>-----<br/>Country Name (2 letter code) [AU]:</span></pre><p id="9af3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后是您所在的州或省:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="4f7e" class="kb kc hu lu b fv ly lz l ma mb">State or Province Name (full name) [Some-State]:</span></pre><p id="579d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您的城市:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="fead" class="kb kc hu lu b fv ly lz l ma mb">Locality Name (eg, city) []:</span></pre><p id="3daf" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您的组织名称:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="d824" class="kb kc hu lu b fv ly lz l ma mb">Organization Name (eg, company) [Internet Widgits Pty Ltd]:<br/>Organizational Unit Name (eg, section) []:</span></pre><p id="58be" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你可以把这些都留空。</p><p id="8fe0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请记住将此设置为<code class="eh mc md me lu b">localhost</code>:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="9479" class="kb kc hu lu b fv ly lz l ma mb">Common Name (e.g. server FQDN or YOUR name) []: localhost</span></pre><p id="a4b1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要添加您的电子邮件地址:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="3fb5" class="kb kc hu lu b fv ly lz l ma mb">Email Address []:</span></pre><p id="0dbd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">就是这样！现在，在运行该命令的文件夹中有两个文件:</p><ul class=""><li id="341f" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated"><code class="eh mc md me lu b">server.cert</code>是自签名证书文件</li><li id="433c" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated"><code class="eh mc md me lu b">server.key</code>是证书的私钥</li></ul><p id="06a3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">建立HTTPS连接需要这两个文件，根据您设置服务器的方式，使用它们的过程会有所不同。</p><p id="0f9f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这些文件需要放在应用程序可以到达的地方，然后您需要配置服务器来使用它们。</p><p id="32db" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是一个使用<code class="eh mc md me lu b">https</code>核心模块和Express的示例:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="7a46" class="kb kc hu lu b fv ly lz l ma mb">const https = require('https')<br/>const app = express()</span><span id="c113" class="kb kc hu lu b fv mf lz l ma mb">app.get('/', (req, res) =&gt; {<br/>  res.send('Hello HTTPS!')<br/>})</span><span id="c9c5" class="kb kc hu lu b fv mf lz l ma mb">https.createServer({}, app).listen(3000, () =&gt; {<br/>  console.log('Listening...')<br/>})</span></pre><p id="77bb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在不添加证书的情况下，如果我连接到<code class="eh mc md me lu b">https://localhost:3000</code>，浏览器将显示以下内容:</p><figure class="lp lq lr ls fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nm"><img src="../Images/b1c0ce5aa6dd8d2a27cc9f331d700efc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VFrGRrmDGH2m9R4456UCDg.png"/></div></div></figure><p id="decb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">证书准备就绪后:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="8d48" class="kb kc hu lu b fv ly lz l ma mb">const fs = require('fs')</span><span id="b444" class="kb kc hu lu b fv mf lz l ma mb">//...</span><span id="c1c0" class="kb kc hu lu b fv mf lz l ma mb">https.createServer({<br/>  key: fs.readFileSync('server.key'),<br/>  cert: fs.readFileSync('server.cert')<br/>}, app).listen(3000, () =&gt; {<br/>  console.log('Listening...')<br/>})</span></pre><p id="9702" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Chrome会告诉我们证书无效，因为它是自签名的，并会要求我们确认继续，但HTTPS连接将工作:</p><figure class="lp lq lr ls fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nn"><img src="../Images/629dad7187aa1a32c7f609c3d5830c11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wBZ5jTfVTX-OqeQ4dlP7yg.png"/></div></div></figure><h1 id="c2d0" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">设置让我们为Express加密</h1><p id="bbbc" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">如果您在自己的VPS上运行Node.js应用程序，您需要设法获得SSL证书。</p><p id="a54e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">今天，这样做的标准是使用<a class="ae ka" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> Let's Encrypt </a>和<a class="ae ka" href="https://certbot.eff.org/" rel="noopener ugc nofollow" target="_blank"> Certbot </a>，这是一个来自<a class="ae ka" href="https://www.eff.org/" rel="noopener ugc nofollow" target="_blank"> EFF </a>的工具，又名电子前沿基金会，这是一个领先的非营利组织，专注于数字世界中的隐私、言论自由和一般公民自由。</p><p id="55df" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们将遵循以下步骤:</p><ul class=""><li id="39ea" class="kw kx hu je b jf jg jj jk jn mx jr my jv mz jz ld le lf lg dt translated">安装证书机器人</li><li id="3861" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">使用Certbot生成SSL证书</li><li id="1fad" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">允许Express提供静态文件</li><li id="7915" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">确认域</li><li id="86ab" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">获得证书</li><li id="7791" class="kw kx hu je b jf lh jj li jn lj jr lk jv ll jz ld le lf lg dt translated">设置续订</li></ul><h2 id="8760" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">安装证书机器人</h2><p id="1bb2" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">这些说明假设您使用的是Ubuntu、Debian或任何其他使用<code class="eh mc md me lu b">apt-get</code>的Linux发行版:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="d8cc" class="kb kc hu lu b fv ly lz l ma mb">sudo add-apt repository ppa:certbot/certbot<br/>sudo apt-get update<br/>sudo apt-get install certbot</span></pre><p id="b86e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您也可以在Mac上安装Certbot来测试:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="7f11" class="kb kc hu lu b fv ly lz l ma mb">brew install certbot</span></pre><p id="44d7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是你需要把它链接到一个真实的域名上，这样它才会有用。</p><h2 id="db9e" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">使用Certbot生成SSL证书</h2><p id="9e78" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">现在Certbot已经安装好了，您可以调用它来生成证书。您必须以root用户身份运行:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="320a" class="kb kc hu lu b fv ly lz l ma mb">certbot certonly --manual</span></pre><p id="1a85" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">或者打电话给须藤</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="4957" class="kb kc hu lu b fv ly lz l ma mb">sudo certbot certonly --manual</span></pre><p id="1ba7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">安装程序会询问您网站的域名。</p><p id="406e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是详细的过程。</p><p id="4217" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它要求电子邮件</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="8ad7" class="kb kc hu lu b fv ly lz l ma mb">➜ sudo certbot certonly --manual<br/>Password: XXXXXXXXXXXXXXXXXX<br/>Saving debug log to /var/log/letsencrypt/letsencrypt.log<br/>Plugins selected: Authenticator manual, Installer None<br/>Enter email address (used for urgent renewal and security notices) (Enter 'c' to<br/>cancel): flavio@flaviocopes.com</span></pre><p id="efa0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它要求接受ToS:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="f05c" class="kb kc hu lu b fv ly lz l ma mb">Please read the Terms of Service at<br/>https://letsencrypt.org/documents/LE-SA-v1.2-November-15-2017.pdf. You must<br/>agree in order to register with the ACME server at<br/>https://acme-v02.api.letsencrypt.org/directory</span><span id="0a56" class="kb kc hu lu b fv mf lz l ma mb">(A)gree/(C)ancel: A</span></pre><p id="bdc2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它要求共享电子邮件地址</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="5165" class="kb kc hu lu b fv ly lz l ma mb">Would you be willing to share your email address with the Electronic Frontier<br/>Foundation, a founding partner of the Let's Encrypt project and the non-profit<br/>organization that develops Certbot? We'd like to send you email about our work<br/>encrypting the web, EFF news, campaigns, and ways to support digital freedom.<br/>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<br/>(Y)es/(N)o: Y</span></pre><p id="dd90" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最后，我们可以输入希望使用SSL证书的域:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="bc0d" class="kb kc hu lu b fv ly lz l ma mb">Please enter in your domain name(s) (comma and/or space separated)  (Enter 'c'<br/>to cancel): copesflavio.com</span></pre><p id="41e8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它会询问您是否可以登录您的IP:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="d875" class="kb kc hu lu b fv ly lz l ma mb">Obtaining a new certificate<br/>Performing the following challenges:<br/>http-01 challenge for copesflavio.com</span><span id="4125" class="kb kc hu lu b fv mf lz l ma mb">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<br/>NOTE: The IP of this machine will be publicly logged as having requested this<br/>certificate. If you're running certbot in manual mode on a machine that is not<br/>your server, please ensure you're okay with that.</span><span id="8446" class="kb kc hu lu b fv mf lz l ma mb">Are you OK with your IP being logged?<br/>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<br/>(Y)es/(N)o: y</span></pre><p id="ac85" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最后，我们进入验证阶段！</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="869d" class="kb kc hu lu b fv ly lz l ma mb">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<br/>Create a file containing just this data:</span><span id="5484" class="kb kc hu lu b fv mf lz l ma mb">TS_oZ2-ji23jrio3j2irj3iroj_U51u1o0x7rrDY2E.1DzOo_voCOsrpddP_2kpoek2opeko2pke-UAPb21sW1c</span><span id="b1d3" class="kb kc hu lu b fv mf lz l ma mb">And make it available on your web server at this URL:</span><span id="23a3" class="kb kc hu lu b fv mf lz l ma mb">http://copesflavio.com/.well-known/acme-challenge/TS_oZ2-ji23jrio3j2irj3iroj_U51u1o0x7rrDY2E</span></pre><p id="e92e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在让我们离开Certbot几分钟。</p><p id="1032" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们需要通过在<code class="eh mc md me lu b">.well-known/acme-challenge/</code>文件夹中创建一个名为<code class="eh mc md me lu b">TS_oZ2-ji23jrio3j2irj3iroj_U51u1o0x7rrDY2E</code>的文件来验证我们拥有这个域名。注意了！我刚刚粘贴的奇怪字符串每次都会改变。</p><p id="7453" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您需要创建文件夹和文件，因为默认情况下它们不存在。</p><p id="d440" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这个文件中，您需要放置Certbot打印的内容:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="2d8f" class="kb kc hu lu b fv ly lz l ma mb">TS_oZ2-ji23jrio3j2irj3iroj_U51u1o0x7rrDY2E.1DzOo_voCOsrpddP_2kpoek2opeko2pke-UAPb21sW1c</span></pre><p id="cf84" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">至于文件名，这个字符串在每次运行Certbot时都是唯一的。</p><h2 id="c0c3" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">允许Express提供静态文件</h2><p id="a153" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">为了从Express提供该文件，您需要启用静态文件服务。您可以创建一个<code class="eh mc md me lu b">static</code>文件夹，并在其中添加<code class="eh mc md me lu b">.well-known</code>子文件夹，然后像这样配置Express:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="92e8" class="kb kc hu lu b fv ly lz l ma mb">const express = require('express')<br/>const app = express()</span><span id="97fa" class="kb kc hu lu b fv mf lz l ma mb">//...</span><span id="adac" class="kb kc hu lu b fv mf lz l ma mb">app.use(express.static(__dirname + '/static', { dotfiles: 'allow' } ))</span><span id="080f" class="kb kc hu lu b fv mf lz l ma mb">//...</span></pre><p id="04c0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">dotfiles</code>选项是强制的，否则<code class="eh mc md me lu b">.well-known</code>是一个点文件，因为它以一个点开始，不会被显示。这是一种安全措施，因为点文件可能包含敏感信息，默认情况下最好保留这些信息。</p><h2 id="1531" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">确认域</h2><p id="d64c" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">现在运行应用程序，确保可以从公共互联网访问该文件，并返回到Certbot(它仍在运行),按ENTER键继续运行脚本。</p><h2 id="ec56" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">获得证书</h2><p id="f630" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">就是这样！如果一切顺利，Certbot创建了证书和私钥，并将其放在您计算机上的一个文件夹中(当然，它会告诉您是哪个文件夹)。</p><p id="d246" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在将路径复制/粘贴到您的应用程序中，开始使用它们来满足您的请求:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="50c5" class="kb kc hu lu b fv ly lz l ma mb">const fs = require('fs')<br/>const https = require('https')<br/>const app = express()</span><span id="757e" class="kb kc hu lu b fv mf lz l ma mb">app.get('/', (req, res) =&gt; {<br/>  res.send('Hello HTTPS!')<br/>})</span><span id="078a" class="kb kc hu lu b fv mf lz l ma mb">https.createServer({<br/>  key: fs.readFileSync('/etc/letsencrypt/path/to/key.pem'),<br/>  cert: fs.readFileSync('/etc/letsencrypt/path/to/cert.pem'),<br/>  ca: fs.readFileSync('/etc/letsencrypt/path/to/chain.pem')<br/>}, app).listen(443, () =&gt; {<br/>  console.log('Listening...')<br/>})</span></pre><p id="4530" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注意，我让这个服务器监听端口443，所以您需要用root权限运行它。</p><p id="6823" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">此外，服务器只在HTTPS运行，因为我使用了<code class="eh mc md me lu b">https.createServer()</code>。您还可以通过运行以下命令来运行HTTP服务器:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="5f01" class="kb kc hu lu b fv ly lz l ma mb">http.createServer(app).listen(80, () =&gt; {<br/>  console.log('Listening...')<br/>})</span><span id="e509" class="kb kc hu lu b fv mf lz l ma mb">https.createServer({<br/>  key: fs.readFileSync('/etc/letsencrypt/path/to/key.pem'),<br/>  cert: fs.readFileSync('/etc/letsencrypt/path/to/cert.pem'),<br/>  ca: fs.readFileSync('/etc/letsencrypt/path/to/chain.pem')<br/>}, app).listen(443, () =&gt; {<br/>  console.log('Listening...')<br/>})</span></pre><h2 id="50d4" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">设置续订</h2><p id="4f5f" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">SSL证书不会在90天内有效。你需要建立一个自动续费系统。</p><p id="fa72" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">怎么会？使用cron作业。</p><p id="206a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">cron作业是每隔一段时间运行任务的一种方式。它可以是每周、每分钟、每月。</p><p id="da97" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我们的例子中，我们将按照Certbot文档中的建议，每天运行两次更新脚本。</p><p id="5b9d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先找出<code class="eh mc md me lu b">certbot</code>在你的系统上的绝对路径。我在macOS上使用<code class="eh mc md me lu b">type certbot</code>来获得它，在我的情况下是<code class="eh mc md me lu b">/usr/local/bin/certbot</code>。</p><p id="8dd1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">下面是我们需要运行的脚本:</p><p id="073e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh mc md me lu b">certbot renew</code></p><p id="8ca2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是cron作业条目:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="82b9" class="kb kc hu lu b fv ly lz l ma mb">0 */12 * * * root /usr/local/bin/certbot renew &gt;/dev/null 2&gt;&amp;1</span></pre><p id="0c59" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这意味着每天每12小时运行一次:00:00和12:00。</p><blockquote class="na nb nc"><p id="6dc5" class="jc jd nd je b jf jg jh ji jj jk jl jm ne jo jp jq nf js jt ju ng jw jx jy jz hn dt translated"><em class="hu">提示:我使用</em><a class="ae ka" href="https://crontab-generator.org/" rel="noopener ugc nofollow" target="_blank"><em class="hu">https://crontab-generator.org/</em></a>生成了这一行</p></blockquote><p id="ac06" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用以下命令将该脚本添加到crontab中:</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="0d5b" class="kb kc hu lu b fv ly lz l ma mb">env EDITOR=pico crontab -e</span></pre><p id="8061" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这将打开<code class="eh mc md me lu b">pico</code>编辑器(您可以选择您喜欢的编辑器)。输入该行，保存，cron作业就安装好了。</p><p id="481c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">完成后，您可以使用以下命令查看活动的cron作业列表</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="368f" class="kb kc hu lu b fv ly lz l ma mb">crontab -l</span></pre><h1 id="57d6" class="mg kc hu bd kd mh mi mj kh mk ml mm kl mn mo mp ko mq mr ms kr mt mu mv ku mw dt translated">包扎</h1><p id="6b4c" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hn dt translated">如果你能走到这一步，那太棒了！我希望本文对Express的介绍能够让您快速了解这个非常棒的Node.js库。请记住，你可以获得该页面的<a class="ae ka" href="https://flaviocopes.com/page/express-handbook" rel="noopener ugc nofollow" target="_blank"> PDF、ePub和Mobi </a>版本，以便于参考，或者在Kindle或平板电脑上阅读。</p><figure class="lp lq lr ls fq iv"><div class="bz el l di"><div class="no np l"/></div></figure></div></div>    
</body>
</html>