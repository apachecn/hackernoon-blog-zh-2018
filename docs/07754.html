<html>
<head>
<title>BigQuery: level up your queries with these advanced tricks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery:用这些高级技巧提升你的查询水平</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/bigquery-level-up-your-queries-with-these-advanced-tricks-c87de1fde235?source=collection_archive---------4-----------------------#2018-09-12">https://medium.com/hackernoon/bigquery-level-up-your-queries-with-these-advanced-tricks-c87de1fde235?source=collection_archive---------4-----------------------#2018-09-12</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="e7f7" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated"><strong class="ak">以大都会艺术博物馆和云视觉API为特色</strong></h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/dd1e3ad6ff43c070140e803f0edee540.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3jgwjZR289bED2lB"/></div></div></figure><p id="bcec" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><a class="ae kr" href="https://hackernoon.com/tagged/bigquery" rel="noopener ugc nofollow" target="_blank"> BigQuery </a>是Google Cloud提供的数据仓库解决方案。组织使用数据仓库将多个数据源收集到一个实体中，并使用面向业务的模式将它们重新整合到SQL数据库中。</p><blockquote class="ks"><p id="6e8f" class="kt ku hu bd kv kw kx ky kz la lb kq ek translated">这使得组织的合作者可以通过一个独特的服务，只需几个SQL查询就可以访问多个分析就绪数据源。</p></blockquote><p id="e728" class="pw-post-body-paragraph jv jw hu jx b jy lc iv ka kb ld iy kd ke le kg kh ki lf kk kl km lg ko kp kq hn dt translated">因此，跨源数据分析很容易实现。</p><p id="2395" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这种类型的服务对于任何数据驱动的公司功能都非常有用，特别是<a class="ae kr" href="https://hackernoon.com/tagged/business" rel="noopener ugc nofollow" target="_blank">业务</a>情报分析师或数据科学家。</p><p id="d0be" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">BigQuery还带有公共数据集(<em class="lh">如</em> <code class="eh li lj lk ll b">hackernews</code>、<code class="eh li lj lk ll b">stackoverflow</code>或<code class="eh li lj lk ll b">github_repos</code>)。最好的是，该列表定期更新。</p><p id="e6ab" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果你是BigQuery的新手，想要探索这些开放数据，你可以在这里找到有价值的信息:<a class="ae kr" href="https://cloud.google.com/bigquery/" rel="noopener ugc nofollow" target="_blank">免费试用big query</a>。</p><p id="fbfa" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">此外，Felipe Hoffa还提供了一些关于BigQuery公共数据集的有趣分析:</p><ul class=""><li id="08fb" class="lm ln hu jx b jy jz kb kc ke lo ki lp km lq kq lr ls lt lu dt translated"><a class="ae kr" rel="noopener" href="/google-cloud/github-on-bigquery-analyze-all-the-code-b3576fd2b150"><em class="lh">Github中的所有开源现在在BigQuery内共享:分析所有代码！</em> </a></li><li id="9f8a" class="lm ln hu jx b jy lv kb lw ke lx ki ly km lz kq lr ls lt lu dt translated"><a class="ae kr" href="https://towardsdatascience.com/these-are-the-real-stack-overflow-trends-use-the-pageviews-c439903cd1a" rel="noopener" target="_blank"> <em class="lh">这些是真实的栈溢出趋势:使用浏览量</em> </a></li><li id="bf6f" class="lm ln hu jx b jy lv kb lw ke lx ki ly km lz kq lr ls lt lu dt translated"><a class="ae kr" href="https://medium.freecodecamp.org/the-top-contributors-to-github-2017-be98ab854e87" rel="noopener ugc nofollow" target="_blank"><em class="lh">2017年谁对开源贡献最大？我们来分析一下Github的数据，一探究竟。</em> </a></li></ul><p id="9d76" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">作为我工作的一部分，我个人已经使用BigQuery将近一年了，这里是我在这个过程中获得的一些经验，可能对你有用。为了支持我的陈述，我将使用公共数据集<code class="eh li lj lk ll b">bigquery-public-data.the_met</code>。</p><h1 id="25fd" class="ma mb hu bd mc md me mf mg mh mi mj mk ja ml jb mm jd mn je mo jg mp jh mq mr dt translated">数据集</h1><p id="d715" class="pw-post-body-paragraph jv jw hu jx b jy ms iv ka kb mt iy kd ke mu kg kh ki mv kk kl km mw ko kp kq hn dt translated"><code class="eh li lj lk ll b">the_met</code>数据集从纽约大都会艺术博物馆的20万件艺术品中收集数据。数据包括对象元数据和图片表示。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mx"><img src="../Images/b6b5d36df3b11f2fbdc0a37fa650ae0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*feRCJDMr-3f6sWYp"/></div></div></figure><p id="762e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">最重要的是，由于有了<a class="ae kr" href="https://cloud.google.com/vision/" rel="noopener ugc nofollow" target="_blank">云视觉API </a>，所有的图像都得到了注释:这个API具有几个预先训练好的计算机视觉模型，提供了丰富的视觉信息(其中包括图像分类、人脸检测和定位、光学字符识别)。</p><p id="9a56" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这些注释在数据集中可用，并包含许多嵌套字段，这使得它成为与数据争论的一个很好的场所。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff my"><img src="../Images/4e1738bd7f26a456b69646ec2602e081.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C1NE5kNOr64VCMEyvAfoJg.png"/></div></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">Logo Detection request to Cloud Vision with <strong class="bd nd">The Death of Socrates</strong>, David (1787)</figcaption></figure><p id="3fbd" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">数据集由3个表组成:</p><ul class=""><li id="d65c" class="lm ln hu jx b jy jz kb kc ke lo ki lp km lq kq lr ls lt lu dt translated"><code class="eh li lj lk ll b">the_met.images</code>为图片网址</li><li id="eb15" class="lm ln hu jx b jy lv kb lw ke lx ki ly km lz kq lr ls lt lu dt translated"><code class="eh li lj lk ll b">the_met.objects</code>对于对象元数据</li><li id="b918" class="lm ln hu jx b jy lv kb lw ke lx ki ly km lz kq lr ls lt lu dt translated"><code class="eh li lj lk ll b">the_met.vision_api_data</code>对于vision api生成的注释</li></ul><p id="d26e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">常用键是<code class="eh li lj lk ll b">object_id</code>。</p><p id="5866" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">更多关于<code class="eh li lj lk ll b">the_met</code>的信息可以从萨拉·罗宾逊的<a class="ae kr" href="https://cloud.google.com/blog/products/gcp/when-art-meets-big-data-analyzing-200000-items-from-the-met-collection-in-bigquery" rel="noopener ugc nofollow" target="_blank">这篇文章</a>中获得。</p><h1 id="53ee" class="ma mb hu bd mc md me mf mg mh mi mj mk ja ml jb mm jd mn je mo jg mp jh mq mr dt translated">招数怎么样？</h1><p id="7e6f" class="pw-post-body-paragraph jv jw hu jx b jy ms iv ka kb mt iy kd ke mu kg kh ki mv kk kl km mw ko kp kq hn dt translated">这里描述的技巧不一定能解决复杂的情况。它们更倾向于帮助您编写更短、更高效的查询，通常会忽略一些命令。</p><p id="e9ff" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我们将讨论的主题如下:</p><ol class=""><li id="8073" class="lm ln hu jx b jy jz kb kc ke lo ki lp km lq kq ne ls lt lu dt translated"><strong class="jx hv">等幂随机拆分表格行</strong></li><li id="937b" class="lm ln hu jx b jy lv kb lw ke lx ki ly km lz kq ne ls lt lu dt translated"><strong class="jx hv">使用</strong>和<code class="eh li lj lk ll b"><strong class="jx hv">EXCEPT</strong></code>缩短您的查询</li><li id="fcbc" class="lm ln hu jx b jy lv kb lw ke lx ki ly km lz kq ne ls lt lu dt translated"><strong class="jx hv">用</strong>修改数组内联<code class="eh li lj lk ll b"><strong class="jx hv">ARRAY</strong></code></li><li id="1f33" class="lm ln hu jx b jy lv kb lw ke lx ki ly km lz kq ne ls lt lu dt translated"><strong class="jx hv">当SQL无法处理它时，就JS它</strong></li><li id="e226" class="lm ln hu jx b jy lv kb lw ke lx ki ly km lz kq ne ls lt lu dt translated"><strong class="jx hv">big query ML上的附加部分</strong></li></ol><blockquote class="nf ng nh"><p id="3a9d" class="jv jw lh jx b jy jz iv ka kb kc iy kd ni kf kg kh nj kj kk kl nk kn ko kp kq hn dt translated"><strong class="jx hv">免责声明</strong>:下面的例子将使用标准SQL，一般来说，它比BigQuery遗留SQL 提供了更多的特性<a class="ae kr" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/migrating-from-legacy-sql" rel="noopener ugc nofollow" target="_blank">。它们假设您已经熟悉BigQuery、行聚合、记录、重复字段和子查询。</a></p></blockquote><h1 id="6a30" class="ma mb hu bd mc md me mf mg mh mi mj mk ja ml jb mm jd mn je mo jg mp jh mq mr dt translated">1.幂等随机拆分表格行</h1><p id="a408" class="pw-post-body-paragraph jv jw hu jx b jy ms iv ka kb mt iy kd ke mu kg kh ki mv kk kl km mw ko kp kq hn dt translated">当试验机器学习和BigQuery数据时，能够以给定的分数随机拆分表听起来可能很有用。</p><p id="e002" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果查询是幂等的，那就更好了:无论运行多少次，结果都是一样的。</p><p id="2342" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">用例出现在将数据集划分为训练集和开发集时。</p><p id="a137" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">例如，让我们对<code class="eh li lj lk ll b">the_met.objects</code>进行80–20分割。这个想法在于散列一个存在于所有行中并且对于每一行都是唯一的列字段，<em class="lh">例如</em>和<code class="eh li lj lk ll b"><a class="ae kr" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#farm_fingerprint" rel="noopener ugc nofollow" target="_blank">FARM_FINGERPRINT</a></code>。</p><p id="c07f" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然后可以利用整数散列的算术属性来幂等地区分行。</p><p id="0298" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">对于20%的分割，可以使用模5值。在这里，这个字段可以是<code class="eh li lj lk ll b">object_number</code>。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nl nm l"/></div></figure><p id="c50d" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">上面的查询返回了401596行中的80221行。 19.97%)。耶！</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff nn"><img src="../Images/9daff63bc0c2e9364781442902c53f0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2qqGVHlLtoeOUHl_W8E9mg.png"/></div></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">Samples of objects with their number, FARM_FINGERPRINT hash, corresponding group and title</figcaption></figure><h1 id="260c" class="ma mb hu bd mc md me mf mg mh mi mj mk ja ml jb mm jd mn je mo jg mp jh mq mr dt translated">2.使用<code class="eh li lj lk ll b">EXCEPT</code>缩短您的查询</h1><p id="e103" class="pw-post-body-paragraph jv jw hu jx b jy ms iv ka kb mt iy kd ke mu kg kh ki mv kk kl km mw ko kp kq hn dt translated">一个经常被忽视的关键词是<code class="eh li lj lk ll b">EXCEPT</code>。这允许您查询除了它们的子集之外的所有列。</p><p id="a223" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">事实证明，当表模式非常完备时，如在<code class="eh li lj lk ll b">the_met.objects</code>中，这是非常有用的。</p><p id="1521" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">例如:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nl nm l"/></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">With `EXCEPT`, 4 lines</figcaption></figure><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nl nm l"/></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">Without `EXCEPT`, 43 lines</figcaption></figure><p id="ce65" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><code class="eh li lj lk ll b">the_met.vision_api_data</code>中提供的另一个图像注释示例。在可用的注释中，有<code class="eh li lj lk ll b">faceAnnotations</code>:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff no"><img src="../Images/4e53369ec3a5bbee40a2a247a7a93e57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T30KXhvd1D_dCDLIou7sqw.png"/></div></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">Schema for `face_annotations` in `the_met.vision_api_data`</figcaption></figure><p id="85f8" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果我们对除了<code class="eh li lj lk ll b">faceAnnotations.surpriseLikelihood</code>和<code class="eh li lj lk ll b">faceAnnotations.sorrowLikelihood</code>之外的所有列都感兴趣，这个查询会起作用吗？</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nl nm l"/></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">This query references nested queries and is invalid.</figcaption></figure><p id="6fc1" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">实际上，这个查询是不允许的，因为它引用了<code class="eh li lj lk ll b">EXCEPT</code>中的一个嵌套字段。<code class="eh li lj lk ll b">faceAnnotations</code>需要<code class="eh li lj lk ll b">UNNEST</code> <em class="lh"> ed </em>才能引用。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nl nm l"/></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">This query is valid but the `faceAnnotations` are now unnested.</figcaption></figure><p id="7981" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">上面的查询有效，但是<code class="eh li lj lk ll b">faceAnnotations</code>现在没有嵌套。</p><p id="130d" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">下一节将展示如何在保留嵌套结构的同时执行任务，这要归功于关键字<code class="eh li lj lk ll b">ARRAY</code>。一般来说，与完全扁平化的表相比，维护嵌套结构在存储和处理能力方面更具成本效益。</p><h1 id="eef6" class="ma mb hu bd mc md me mf mg mh mi mj mk ja ml jb mm jd mn je mo jg mp jh mq mr dt translated">3.用<code class="eh li lj lk ll b">ARRAY</code>修改数组</h1><p id="b781" class="pw-post-body-paragraph jv jw hu jx b jy ms iv ka kb mt iy kd ke mu kg kh ki mv kk kl km mw ko kp kq hn dt translated">在BigQuery中，<code class="eh li lj lk ll b">ARRAY</code>字段(又名。<code class="eh li lj lk ll b">REPEATED</code>字段)指一行可以有多个对应值的列。例如在<code class="eh li lj lk ll b">vision_api_data</code>中，一个对象可以对应多个<code class="eh li lj lk ll b">faceAnnotations</code>:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff np"><img src="../Images/a13d71b3482155c9ae13b512b8e4b620.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uhG7sPyVjAUY3oyXX5Uymw.png"/></div></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">To one line (=one `object_id`) can correspond several `faceAnnotations`</figcaption></figure><p id="d6f5" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">你可能知道<code class="eh li lj lk ll b">ARRAY_AGG</code>或<code class="eh li lj lk ll b">ARRAY_LENGTH</code>，但你听说过经常被忽视的<code class="eh li lj lk ll b">ARRAY</code>吗？</p><p id="d9bc" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">根据<a class="ae kr" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/array_functions" rel="noopener ugc nofollow" target="_blank">文档</a> , <code class="eh li lj lk ll b">ARRAY(subquery)</code>返回一个<code class="eh li lj lk ll b">ARRAY</code>，子查询中的每一行都有一个元素。让我们看几个用例。</p><h2 id="9551" class="nq mb hu bd mc nr ns nt mg nu nv nw mk ke nx ny mm ki nz oa mo km ob oc mq od dt translated">3.1过滤掉嵌套字段，同时保留嵌套结构</h2><p id="58c5" class="pw-post-body-paragraph jv jw hu jx b jy ms iv ka kb mt iy kd ke mu kg kh ki mv kk kl km mw ko kp kq hn dt translated">让我们再次处理前面的例子，但是这次用一个更优雅的方法。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nl nm l"/></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">And I never unnested any column</figcaption></figure><p id="efe2" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">注意，当在一个<code class="eh li lj lk ll b">ARRAY</code>子句中查询多个列时，<code class="eh li lj lk ll b">SELECT AS STRUCT</code>是必需的。</p><h2 id="8436" class="nq mb hu bd mc nr ns nt mg nu nv nw mk ke nx ny mm ki nz oa mo km ob oc mq od dt translated">3.2筛选数组字段中的行</h2><p id="2a79" class="pw-post-body-paragraph jv jw hu jx b jy ms iv ka kb mt iy kd ke mu kg kh ki mv kk kl km mw ko kp kq hn dt translated">这一次，我们将根据嵌套列上的条件，过滤掉<code class="eh li lj lk ll b">ARRAY</code>中的行，而不是过滤掉列。</p><p id="558e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">假设我们对很可能曝光不足的人脸不感兴趣。 <code class="eh li lj lk ll b">underExposedLikelihood='VERY_LIKELY'</code>)。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nl nm l"/></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">The query</figcaption></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff oe"><img src="../Images/4a44826c2f24b231ec80393e7aea08b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PZXLdS_KWIrXcwdDVS44QA.png"/></div></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">Above: `faceAnnotations` before `WHERE` filtering</figcaption></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff oe"><img src="../Images/7ef50063b6c4cbcc987930013741d792.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fv2o_i9C7ZQSHsVSFqo4qQ.png"/></div></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">Above: `faceAnnotations` after `WHERE` filtering</figcaption></figure><h2 id="5e9d" class="nq mb hu bd mc nr ns nt mg nu nv nw mk ke nx ny mm ki nz oa mo km ob oc mq od dt translated">3.3用嵌套字段上的连接来丰富数组</h2><p id="2661" class="pw-post-body-paragraph jv jw hu jx b jy ms iv ka kb mt iy kd ke mu kg kh ki mv kk kl km mw ko kp kq hn dt translated">在面部注释的顶部，云视觉API提供了网络检测功能，类似于谷歌图像反向搜索。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff of"><img src="../Images/81c1dbd638df7f57676a9a5991a61b0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wd1_pQBXoPh1Gu-FYGu84g.png"/></div></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">`webDetection` schema</figcaption></figure><p id="de84" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">让我们用来自<code class="eh li lj lk ll b">the_met.images</code>的匹配<code class="eh li lj lk ll b">object_id</code>(博物馆物品的图片URL)来丰富这个模式。这是目标模式:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff og"><img src="../Images/b9acf1f2c6c05e4232fe5e50bb5fb863.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JWHeabGNXEEDgI1nNkms7g.png"/></div></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">Target enriched `webDetection` schema</figcaption></figure><p id="2e28" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">相应的查询</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nl nm l"/></div></figure><p id="997c" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">结果呢</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff oh"><img src="../Images/d7eb0d64edc461dd3e4a0971fc30826e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uP6N1Nn5F61HGFwZrn6C-A.png"/></div></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">Samples of the `webDetection` schema enrichment. The output schema has been simplified for readability.</figcaption></figure><p id="fc0d" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">例如，从那里你可以评估谷歌反向图像搜索的图像检索性能。</p><h1 id="13ac" class="ma mb hu bd mc md me mf mg mh mi mj mk ja ml jb mm jd mn je mo jg mp jh mq mr dt translated">4.当SQL不能处理它时，就用JS</h1><p id="f048" class="pw-post-body-paragraph jv jw hu jx b jy ms iv ka kb mt iy kd ke mu kg kh ki mv kk kl km mw ko kp kq hn dt translated">BigQuery允许您用JavaScript编写自己的<a class="ae kr" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/user-defined-functions" rel="noopener ugc nofollow" target="_blank">用户定义函数</a>(UDF)，这在StandardSQL不支持您想要实现的功能时会很有用。</p><p id="7c44" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">例如，我们可能对从<code class="eh li lj lk ll b">vision_api_data</code>中为每个<code class="eh li lj lk ll b">object_id</code>提取具有第二高<code class="eh li lj lk ll b">score</code>的<code class="eh li lj lk ll b">labelAnnotation</code>感兴趣。在StandardSQL中，可以选择第一行，但不能选择第二行(至少不能在单个查询中)。</p><blockquote class="nf ng nh"><p id="9a6c" class="jv jw lh jx b jy jz iv ka kb kc iy kd ni kf kg kh nj kj kk kl nk kn ko kp kq hn dt translated"><strong class="jx hv">编辑:</strong>后一项任务实际上很容易实现。请参考评论部分，看看如何做到这一点。</p></blockquote><p id="0fdc" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这可以通过以下方式实现</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nl nm l"/></div></figure><p id="c09b" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">结果呢</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff oi"><img src="../Images/79e9b44ad8f45d9423bc876e5bc6b740.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NTZ59XkQkT8M602JpuI-Ag.png"/></div></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">We prepended the table schema with the argument of the UDF for convenience.</figcaption></figure><p id="9ea3" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">请注意，在撰写本文时，BigQuery视图不支持UDF。</p><h1 id="9a88" class="ma mb hu bd mc md me mf mg mh mi mj mk ja ml jb mm jd mn je mo jg mp jh mq mr dt translated">5.BigQuery ML的附加部分</h1><p id="4469" class="pw-post-body-paragraph jv jw hu jx b jy ms iv ka kb mt iy kd ke mu kg kh ki mv kk kl km mw ko kp kq hn dt translated">BigQuery ML是BigQuery的最新特性之一。它允许您只使用几个SQL命令来构建、训练和部署机器学习模型。这可以节省你建立数据管道的时间，或许还可以加速其他服务，比如Google AppEngine。</p><p id="5d7f" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为了这个例子，让我们看看一个对象的一些元数据是否可以很好地预测一张脸是否出现在它上面。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff oj"><img src="../Images/d354f335867af347c8d96eea6a7054c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9cicZuVB7raskYOWN-8Frw.png"/></div></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">Logistic Regression task: predict whether or not an art piece has a face representation</figcaption></figure><p id="e518" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我们将依靠云视觉API对人脸的存在进行地面实况标记:</p><pre class="jk jl jm jn fq ok ll ol om aw on dt"><span id="a66f" class="nq mb hu ll b fv oo op l oq or">IF(<br/>  ARRAY_LENGTH(faceAnnotations)=0 OR faceAnnotations IS NULL<br/>  , 0<br/>  , 1<br/>) AS label</span></pre><p id="5436" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为此，我们将使用线性<a class="ae kr" href="https://en.wikipedia.org/wiki/Logistic_regression" rel="noopener ugc nofollow" target="_blank">逻辑回归</a>。</p><p id="a4c4" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在BigQuery上创建模型就像用几个命令预先挂起训练集查询一样简单。</p><p id="d3cd" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">假设您已经创建了一个名为<code class="eh li lj lk ll b">bqml</code>的数据集(如果没有，则创建它)，语法如下所示:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nl nm l"/></div></figure><p id="b37e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">注意输入特性中的混合类型:<code class="eh li lj lk ll b">STRING</code>、<code class="eh li lj lk ll b">BOOLEAN</code>、<code class="eh li lj lk ll b">INTEGER</code>。</p><p id="89ca" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">默认情况下，BigQuery通过对非数字特征进行一次性编码来处理这种多样性。还要注意，我们使用了上述幂等分裂技巧来训练80%数据的模型。</p><p id="a5a3" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">培训结束后，让我们用以下方法在开发集(其他20%的数据)上评估模型:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nl nm l"/></div></figure><p id="03ae" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">评估查询返回</p><pre class="jk jl jm jn fq ok ll ol om aw on dt"><span id="3f13" class="nq mb hu ll b fv oo op l oq or">[<br/>   {<br/>      "precision": "0.6363636363636364",<br/>      "recall": "4.160228218233686E-4",<br/>      "accuracy": "0.8950143845832215",<br/>      "f1_score": "8.315020490586209E-4",<br/>      "log_loss": "0.3046493172393632",<br/>      "roc_auc": "0.857339"<br/>   }<br/>]</span></pre><p id="3937" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">顺便提一下，先验分布如下:</p><pre class="jk jl jm jn fq ok ll ol om aw on dt"><span id="90e4" class="nq mb hu ll b fv oo op l oq or">[<br/>   { <br/>      "pc_with_faces": "0.1050043372170668", <br/>      "pc_no_faces": "0.8949956627829332" <br/>   } <br/>]</span></pre><p id="0c15" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">给定非常低的召回分数和几乎不超过先验分布的准确度分数，我们不能说模型已经从输入特征中学习了😊。</p><p id="e71b" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然而，这个例子可以作为BigQuery ML的介绍。</p><p id="2b91" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为了提高模型的性能，我们可以对像<code class="eh li lj lk ll b">culture</code>和<code class="eh li lj lk ll b">classification</code>这样的字段进行字符串预处理和分解。可以利用其他非结构化的描述文本字段，但是这超出了BigQuery ML的当前范围。</p><p id="f8e6" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果您热衷于在云中提供机器学习，但发现BigQuery ML有局限性，您可能会发现我的<a class="ae kr" href="https://towardsdatascience.com/https-towardsdatascience-com-deploying-machine-learning-has-never-been-so-easy-bbdb500a39a" rel="noopener" target="_blank">上一篇文章</a>很有用。</p><p id="c80f" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><em class="lh">在写这篇文章的时候，BigQuery ML是一个测试版。</em></p></div><div class="ab cl os ot hc ou" role="separator"><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox"/></div><div class="hn ho hp hq hr"><blockquote class="nf ng nh"><p id="5401" class="jv jw lh jx b jy jz iv ka kb kc iy kd ni kf kg kh nj kj kk kl nk kn ko kp kq hn dt translated"><strong class="jx hv">就这样结束了！谢谢你读到这里。我真的很喜欢分享这些知识，所以我希望它们对一些人有用。</strong></p></blockquote></div><div class="ab cl os ot hc ou" role="separator"><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox"/></div><div class="hn ho hp hq hr"><p id="0763" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在Sephora South-East Asia(Sephora SEA ),我们利用BigQuery实现更简单的数据支持决策，并更好地了解我们的客户。</p><p id="86eb" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><em class="lh">Sephora SEA的数据团队尽可能地关注数据的内部民主化，部分是通过关于BigQuery的SQL培训。</em></p><p id="c4c6" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><em class="lh">本文献给他们，也献给我们所有的实习生和往届毕业生。</em></p><p id="adbd" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><em class="lh">正如我的同事</em><a class="ae kr" rel="noopener" href="/@auvalade_52739"><em class="lh">aurélien</em></a><em class="lh">会自豪地说:</em></p><pre class="jk jl jm jn fq ok ll ol om aw on dt"><span id="b043" class="nq mb hu ll b fv oo op l oq or">SELECT thanks FROM you</span></pre><p id="6440" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><em class="lh">照片致谢:</em> <a class="ae kr" href="https://unsplash.com/@kxvn_lx?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> <em class="lh">凯文·拉明托</em> </a> <em class="lh">上</em><a class="ae kr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"><em class="lh">Unsplash</em></a></p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="oz nm l"/></div></figure></div></div>    
</body>
</html>