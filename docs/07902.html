<html>
<head>
<title>How to solve missing push notifications in Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何解决Android中错过推送通知的问题</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/notifications-in-android-are-horribly-broken-b8dbec63f48a?source=collection_archive---------4-----------------------#2018-09-18">https://medium.com/hackernoon/notifications-in-android-are-horribly-broken-b8dbec63f48a?source=collection_archive---------4-----------------------#2018-09-18</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="f8e6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Android是目前最受欢迎的移动操作系统，拥有超过76%的市场份额。这在某种程度上是可能的，因为它的开放性和多家厂商在其设备上安装Android。但它在碎片化方面也存在巨大的问题。例如，Android奥利奥于2017年8月发布，iOS 11于2017年9月发布，奥利奥的市场占有率为14.2%，iOS 11的市场占有率为85%，尽管奥利奥已经领先一步。为了达到85%的采用率，你需要瞄准2013年10月发布的<a class="ae jp" href="https://hackernoon.com/tagged/android" rel="noopener ugc nofollow" target="_blank"> Android </a> Kitkat。虽然这只是冰山一角。</p><p id="7a1e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">失踪通知</strong></p><p id="00e7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我是Flock Android的负责人，这是一款团队通讯应用，与Slack等公司竞争。我们开始从用户那里收到一些奇怪的抱怨，关于丢失通知。既然它是一款商务消息应用，通知就变得至关重要。我们尝试了各种方法来重现这个问题，包括使用测试脚本用通知轰炸设备，尝试不同的网络，但我们就是无法重现这个问题的可靠性。更糟糕的是，我们团队的设备出了几起事故，但日志显示什么也没有。谷歌GCM表示，通知已经发出，但在应用程序的日志中没有通知的痕迹，就好像操作系统正在吞噬通知。不知何故，像whatsapp、facebook这样的流行应用对这些问题免疫。棺材上的最后一颗钉子是首席执行官自己有时会错过通知。谷歌像往常一样对他们不存在的开发客户支持毫无帮助。我们能够在互联网上找到一堆支持文章，在这些文章中，其他应用程序基本上都列出了关闭电池优化的步骤，这似乎很有效(有趣的是，whatsapp和facebook通常会默认添加到这些列表中)。但是没有办法自动做到这一点，虽然我们也可以在响应支持票时这样做，但这对用户来说是痛苦的。</p><p id="1d55" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">几天后，我们能够在oneplus设备上遇到一些错过的通知，我们将该设备连接到一台记录系统日志的机器上。瞧，我们得到了一些正在发生的事情。</p><p id="3292" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">01–12 09:05:23.649 2719 2839 I activity manager:[BgDetect]chkExcessCpu level:0 do kills:true auto _ mode:false uptime:183054<br/>01–12 09:05:23.661 2719 2839 I activity manager:[BgDetect]检测进程上的过多CPU to . talk(PID:13406)level 0 usage 29<br/>01–12</p><p id="c7a1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">显然，一些名为BgDetect的进程发现我们的应用程序占用了太多的CPU，并决定杀死它。Android是开源的，我们认为我们应该能够获得bgdetect的源代码。但我们不仅在Android源中找不到BgDetect，它在oneplus源中也不存在。然后，我们与我们的营销团队取得了联系，并联系了oneplus的一些联系人，他们将我们引向了他们的开发团队。他们要了我们的apk，瞧，一周之后，我们就和Whatsapp和脸书之类的公司一起上了白名单。</p><p id="586c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但这个问题在小米、Oppo和一批中国制造商身上持续存在，对于这些制造商，我们仍然不得不采取措施，在电池优化方面加入白名单。显然，这些设备在标准的android上内置了自动启动的概念。</p><p id="54a6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">自动启动</strong></p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/fb4ea4337344df378750cfc515ead217.png" data-original-src="https://miro.medium.com/v2/resize:fit:360/format:webp/1*vG0sWmEHwOVB6_ilQ_RFBw.jpeg"/></div></figure><p id="12e7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在Android中，推送通知唤醒应用/服务，该应用/服务又显示推送通知。在应用被强制终止的情况下，系统将不会唤醒该应用。我们发现，在小米等一些设备上，我们的应用程序根本不会被唤醒，默认情况下会被强制杀死。避免这种情况的唯一方法是成为“自动启动”列表的一部分，这意味着应用程序在关闭后可以唤醒(“自动启动”)。</p><p id="a97e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">尽管为了方便起见，制造商选择默认自动添加脸书、Whatsapp等热门应用。由于我们是一家即将成立的初创公司，我们不可能在默认情况下成功。由于我们的大部分用户来自印度，随着用户越来越多，人们开始发布负面评论，投诉变得越来越频繁。我们必须找到解决办法。我们也意识到这很常见，有很多网站都有FAQ页面，专门让通知在Android上工作。例如<a class="ae jp" href="https://support.hike.in/hc/en-us/articles/230604667-Optimizing-message-receive-experience" rel="noopener ugc nofollow" target="_blank">徒步</a>、<a class="ae jp" href="https://www.forbes.com/sites/bensin/2017/07/28/how-to-fix-push-notifications-on-oppo-phones/#547d9b231735" rel="noopener ugc nofollow" target="_blank">福布斯</a>、<a class="ae jp" href="https://www.androidcentral.com/how-fix-push-notifications-miui-8" rel="noopener ugc nofollow" target="_blank">安卓中央</a>等。</p><p id="f612" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">使用双确认检测错过的推送</strong></p><p id="0558" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了解决这个问题，我们首先必须找出哪些用户错过了通知。虽然标准的HTTP GCM Push API不提供送达回执，但是XMPP API提供了。GCM交付收据实际上告诉你设备是否收到了推送通知。我们将此与应用程序内部的重复通知交付收据结合起来。因此，我们从GCM而不是从设备获得ack的任何设备都可能会错过推送。一旦设备被识别出来，我们就开始向它们发送bot消息，告诉它们如何将flock添加到设备的自动启动列表中。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="fe ff jy"><img src="../Images/6656d16618c36dece635c5f384ea9c08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bUj_k9YTPfX39c4OYwkgbA.png"/></div></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">Architecture to determine missed pushes</figcaption></figure><p id="0bc9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">结论</strong></p><p id="8e01" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Android是一个令人难以置信的碎片化生态系统，而且看起来只会越来越碎片化。虽然<a class="ae jp" href="https://hackernoon.com/tagged/google" rel="noopener ugc nofollow" target="_blank">谷歌</a>正在通过Project Treble和其他倡议做出一些坚定的努力来解决这个问题，但它无法阻止制造商添加像autostart这样的附加功能。Autostart通过在内存中保存更少的应用程序来帮助速度较慢的设备感觉更快，低端设备制造商将继续使用它。Android似乎在追随桌面Linux的脚步，每个制造商本质上都在创建自己的定制发行版。Android的未来似乎只会更加支离破碎。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="kh ki l"/></div></figure></div></div>    
</body>
</html>