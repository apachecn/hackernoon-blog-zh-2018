<html>
<head>
<title>Secrets Management within AWS ECS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS ECS中的机密管理</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/secrets-management-within-aws-ecs-1b6975819ccd?source=collection_archive---------3-----------------------#2018-09-20">https://medium.com/hackernoon/secrets-management-within-aws-ecs-1b6975819ccd?source=collection_archive---------3-----------------------#2018-09-20</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/69753d9c8649d14ef17fc84e1a1032a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-IcC1z1uqjpiYoeY"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">by <a class="ae jg" href="https://unsplash.com/@guibolduc?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Guillaume Bolduc</a> on <a class="ae jg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="693c" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><em class="kf">更新:ECS中的Secrets最近有了一些变化，关于最新的方法，请点击下面这篇文章的第二部分。为了弄清楚我们是如何到达那里的，请继续阅读。</em></p><div class="kg kh fm fo ki kj"><a rel="noopener follow" target="_blank" href="/@cbeardsmore/ecs-secrets-done-right-9e094cfa6200"><div class="kk ab ej"><div class="kl ab km cl cj kn"><h2 class="bd hv fv z el ko eo ep kp er et ht dt translated">ECS的秘密做对了</h2><div class="kq l"><h3 class="bd b fv z el ko eo ep kp er et ek translated">去年，我写了一篇关于ECS中秘密管理的痛苦的文章，但是现在世界变得更加光明，因为…</h3></div><div class="kr l"><p class="bd b gc z el ko eo ep kp er et ek translated">medium.com</p></div></div><div class="ks l"><div class="kt l ku kv kw ks kx ja kj"/></div></div></a></div><p id="e01d" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">ECS上的容器很棒…但是当涉及到秘密和配置管理时，ECS仍然很粗糙。应用程序需要秘密，关键问题是我们如何以一种既安全又兼容ECS的方式将秘密放入Docker容器。</p><p id="afa0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">对于本地开发，我们可以运行Docker图像，并简单地传入一个<a class="ae jg" href="https://docs.docker.com/compose/env-file/" rel="noopener ugc nofollow" target="_blank"> <em class="kf"> env-file </em> </a> <em class="kf"> </em>，其中包含我们希望我们的容器化应用程序使用的变量。这使得改变我们的秘密和配置更加灵活。您只需更改文件中的值并重启容器。无需重新构建！但是，当我们开始进入试运行或生产环境时，就变得有点困难了。我们需要管理秘密和凭证，出于显而易见的原因，我们希望<em class="kf">只有我们的应用程序</em>能够访问它们。让我们来讨论一些既方便又安全地将这些值放入ECS的选项。</p><figure class="kz la lb lc fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ky"><img src="../Images/24356317cd6d6941d4d8bcf993773f8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SBRWy7ST9_olS_butbNp6A.png"/></div></div></figure><h2 id="0b5d" class="ld le hu bd lf lg lh li lj lk ll lm ln js lo lp lq jw lr ls lt ka lu lv lw lx dt translated">烘焙成Docker</h2><p id="622a" class="pw-post-body-paragraph jh ji hu jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">我们可以在构建时将配置和秘密保存到Docker映像中。优点是您可以启动容器，而根本不用担心配置问题，但这是有代价的。现在，如果不重建您的映像，就不可能更改配置。管理开发、试运行和生产环境之间的配置变得非常困难。由于需要重建，您现在在试运行中测试的映像将与您部署到生产环境中的映像不同。老实说，对于大多数用例来说，这并不是一个可行的选择。</p><h2 id="ccbb" class="ld le hu bd lf lg lh li lj lk ll lm ln js lo lp lq jw lr ls lt ka lu lv lw lx dt translated">ECS环境变量</h2><p id="b0ba" class="pw-post-body-paragraph jh ji hu jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">这种方法有点类似于我们在当地的工作方式。我们在运行容器中设置环境变量时传递我们的配置。与本地开发不同，ECS不支持env文件。ECS允许的是，当您在任务定义中指定容器时，或者当您实际运行任务定义的实例时，定义环境变量。</p><p id="063b" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">关键的缺点是AWS不支持这些变量中的任何类型的安全参数。如果您以这种方式传递机密，那么任何有访问权限的人都可以通过AWS控制台读取它们。我们的应用凭证现在可供任何具有控制台访问权限的人查看和使用。我们的安全系统完蛋了。</p><figure class="kz la lb lc fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff md"><img src="../Images/daed49f857c8876087b844b210baa1de.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*ovVflac0F5uf-NR93EJuLA.png"/></div></div></figure><h2 id="9359" class="ld le hu bd lf lg lh li lj lk ll lm ln js lo lp lq jw lr ls lt ka lu lv lw lx dt translated">Docker从SSM参数存储中获取</h2><p id="8deb" class="pw-post-body-paragraph jh ji hu jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">这是AWS似乎正在推广的技术，也是迄今为止最干净、最安全的选项(鉴于缺乏其他可行的选项)。<a class="ae jg" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-paramstore.html" rel="noopener ugc nofollow" target="_blank"> SSM参数存储</a>允许安全存储配置数据和机密。由于它的层次结构，我们还可以设置粒度规则，规定哪些应用程序可以访问哪些机密。假设我们按照上面的示例，用以下名称创建了两个参数:</p><p id="f175" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><code class="eh me mf mg mh b">/application/secrets/DB_USERNAME/<br/>/application/secrets/DB_PASSWORD/</code></p><p id="9123" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">通过给我们的容器一个具有SSM权限的<a class="ae jg" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-iam-roles.html" rel="noopener ugc nofollow" target="_blank">任务角色</a>，它们可以在启动时使用CLI调用SSM来获取它们所需的配置。如果我们在Roles资源中指定一个特定的路径，比如<code class="eh me mf mg mh b">/application/secret/</code>，那么容器只能访问该路径中的参数。</p><p id="f598" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">要在Docker映像中实现这一点，首先需要安装awscli(通过python)和<a class="ae jg" href="https://stedolan.github.io/jq/" rel="noopener ugc nofollow" target="_blank"> JQ </a>。然后，修改容器入口点，首先调用一个脚本，该脚本将在运行其主要任务之前获取其配置。下面的脚本就是一个例子，它用一个特定的路径调用<code class="eh me mf mg mh b">get-parameters-by-path</code>，然后将容器中检索到的参数设置为环境变量。</p><figure class="kz la lb lc fq iv"><div class="bz el l di"><div class="mi mj l"/></div></figure><p id="b630" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">由于SSM通过其SecureString参数类型和细粒度权限提供了安全性，因此这种方法非常有效。这是我们目前最好的方法，但我不能说我对此感到满意。首先，我们用我们的应用程序并不真正需要的依赖项来膨胀我们纤细干净的Docker映像。从某种意义上说，我们正在破坏docker的纯粹性，因为我们必须在启动时从外部获取资源，而不是像容器那样只运行一个任务。这是一个痛苦的妥协，直到AWS在这一领域为我们提供更多支持。</p><h2 id="72fa" class="ld le hu bd lf lg lh li lj lk ll lm ln js lo lp lq jw lr ls lt ka lu lv lw lx dt translated">未来:</h2><p id="a3fe" class="pw-post-body-paragraph jh ji hu jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">随着越来越多的人转向AWS上的容器化应用程序，希望围绕秘密管理会出现更多的灵活性。有一些特性要求在任务定义中给SSM参数存储提供一级支持，以防止Docker在启动时调用。其他人使用S3来存储本质上是env文件的加密版本，尽管这仍然需要调用KMS来解密。目前，安全性胜过易用性，但没有理由ECS不能在未来继续改进，以允许开发人员两者兼顾。</p><h2 id="d2f5" class="ld le hu bd lf lg lh li lj lk ll lm ln js lo lp lq jw lr ls lt ka lu lv lw lx dt translated"><strong class="ak">更新:</strong></h2><p id="0fca" class="pw-post-body-paragraph jh ji hu jj b jk ly jm jn jo lz jq jr js ma ju jv jw mb jy jz ka mc kc kd ke hn dt translated">截至2018年11月，亚马逊现已<a class="ae jg" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data.html" rel="noopener ugc nofollow" target="_blank">正式发布对通过SSM在ECS容器中注入敏感数据的支持</a>！根据链接中显示的用户对特性请求的反馈，这是非常棒的第一步。目前还不支持Fargate启动类型，也不支持在给定一条路径的情况下获取多个参数，但希望我们能在未来几个月内看到这些进步。</p><h2 id="f442" class="ld le hu bd lf lg lh li lj lk ll lm ln js lo lp lq jw lr ls lt ka lu lv lw lx dt translated">链接:</h2><div class="kg kh fm fo ki kj"><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data.html" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab ej"><div class="kl ab km cl cj kn"><h2 class="bd hv fv z el ko eo ep kp er et ht dt translated">指定敏感数据——亚马逊弹性容器服务</h2><div class="kq l"><h3 class="bd b fv z el ko eo ep kp er et ek translated">Amazon ECS通过将敏感数据存储在AWS系统中，使您能够将敏感数据注入到容器中…</h3></div><div class="kr l"><p class="bd b gc z el ko eo ep kp er et ek translated">docs.aws.amazon.com</p></div></div><div class="ks l"><div class="mk l ku kv kw ks kx ja kj"/></div></div></a></div><div class="kg kh fm fo ki kj"><a href="https://aws.amazon.com/blogs/compute/managing-secrets-for-amazon-ecs-applications-using-parameter-store-and-iam-roles-for-tasks/" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab ej"><div class="kl ab km cl cj kn"><h2 class="bd hv fv z el ko eo ep kp er et ht dt translated">使用任务的参数存储和IAM角色管理Amazon ECS应用程序的机密| Amazon…</h2><div class="kq l"><h3 class="bd b fv z el ko eo ep kp er et ek translated">感谢我的同事Stas Vonholsky关于使用Amazon ECS应用程序管理秘密的精彩博客。-作为…</h3></div><div class="kr l"><p class="bd b gc z el ko eo ep kp er et ek translated">aws.amazon.com</p></div></div><div class="ks l"><div class="ml l ku kv kw ks kx ja kj"/></div></div></a></div><div class="kg kh fm fo ki kj"><a href="https://github.com/aws/amazon-ecs-agent/issues/1209" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab ej"><div class="kl ab km cl cj kn"><h2 class="bd hv fv z el ko eo ep kp er et ht dt translated">功能请求:一流的支持SSM参数存储作为一个秘密存储问题#1209 …</h2><div class="kq l"><h3 class="bd b fv z el ko eo ep kp er et ek translated">摘要使用SSM参数存储作为一个类似于Kubernetes秘密风格的秘密存储。描述SSM参数…</h3></div><div class="kr l"><p class="bd b gc z el ko eo ep kp er et ek translated">github.com</p></div></div><div class="ks l"><div class="mm l ku kv kw ks kx ja kj"/></div></div></a></div></div></div>    
</body>
</html>