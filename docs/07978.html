<html>
<head>
<title>Userspace traffic generation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用户空间流量生成</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/userspace-traffic-generation-fe32e2bd97da?source=collection_archive---------14-----------------------#2018-09-20">https://medium.com/hackernoon/userspace-traffic-generation-fe32e2bd97da?source=collection_archive---------14-----------------------#2018-09-20</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/09f094f9a8afaa0db964e3c9a9349ca2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O0lTO1sYTrUMAo-r2kmsaA.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">An artist’s concept showing MoonGen + DPDK + Lua traffic generation stack</figcaption></figure><p id="9d6b" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在野外缓解DDoS攻击需要测试和学习各种技术。硬件和软件网络解决方案需要在接近真实生活的人工环境中进行测试，有大量的流量模拟攻击。没有这样的经验，人们永远不会认识到每个复杂工具所具有的特定能力和局限性。</p><p id="3267" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在这篇文章中，我们将公开Qrator实验室中使用的某些流量生成方法。</p><p id="95e7" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">免责声明</strong></p><p id="adb1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">众所周知，我们建议所有读者不要尝试使用我们在这项研究中提到的工具。组织DoS攻击会受到法律迫害，并可能导致长期监禁。Qrator Labs负责任地在隔离的实验室环境中进行所有测试。</p><h1 id="bd30" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">最先进的，或者我们为什么要这样做</h1><p id="e470" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">我们领域的挑战性问题是使10G以太网接口充满小数据包，即处理14.88 Mpps(每秒数百万个数据包)。这里和下面只考虑最小的以太网分组，即64字节大小，因为我们对最大分组速率感兴趣。简单的计算表明，我们只有大约67纳秒来处理一个数据包。为了便于比较，这个值接近于在现代CPU上缓存未命中的情况下，从主内存中获取一段数据所需的时间。如果我们必须处理40G或100G以太网接口，试图使它们饱和，事情会变得复杂得多。</p><p id="56cf" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">由于典型的数据平面从用户空间应用通过内核传递到网卡，因此提高网络性能的第一个直接的想法是直接在内核中实现数据包生成。这种解决方案的一个例子是<a class="ae lh" href="https://github.com/danieltt/pktgen" rel="noopener ugc nofollow" target="_blank"> pktgen </a> [ <a class="ae lh" href="http://netoptimizer.blogspot.com/2014/10/unlocked-10gbps-tx-wirespeed-smallest.html" rel="noopener ugc nofollow" target="_blank"> 2 </a> ]内核模块。这种方式确实有助于提高性能，但不够灵活，而且内核源代码的任何更改都需要较长的实现-加载-测试循环，从而导致较低的生产率(即程序员花费的时间和精力)。</p><p id="bcaf" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">另一种方法是提供从用户空间到映射到NIC的缓冲区的直接访问。这种方式更复杂，但值得尝试实现更高的性能。缺点是较高的复杂性和较低的灵活性。例子有<a class="ae lh" href="http://info.iet.unipi.it/~luigi/netmap/" rel="noopener ugc nofollow" target="_blank">网络地图</a>、<a class="ae lh" href="https://www.ntop.org/products/packet-capture/pf_ring/" rel="noopener ugc nofollow" target="_blank"> PF_RING </a>、<a class="ae lh" href="https://www.dpdk.org/" rel="noopener ugc nofollow" target="_blank"> DPDK </a> [ <a class="ae lh" href="https://www.dpdk.org/" rel="noopener ugc nofollow" target="_blank"> 4 </a>。</p><p id="da19" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">另一种实现高性能的合理但昂贵的方法是专用硬件，例如<a class="ae lh" href="https://www.ixiacom.com/" rel="noopener ugc nofollow" target="_blank"> Ixia </a>。</p><p id="4924" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">也有基于DPDK和使用脚本的解决方案，因此在控制生成器的参数和改变运行时发出的包方面提供了一些灵活性。下面我们还将描述我们使用MoonGen工具的经验。</p><h1 id="6c6f" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">月神建筑</h1><figure class="lj lk ll lm fq iv fe ff paragraph-image"><div class="fe ff li"><img src="../Images/c319ca6b4e60c4eaa5cb1244623968d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*lTW-ksAdSBgNPWpt1f1Gvw.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">MoonGen architecture. A figure from the article [<a class="ae lh" href="https://www.net.in.tum.de/fileadmin/bibtex/publications/papers/MoonGen_IMC2015.pdf" rel="noopener ugc nofollow" target="_blank">1</a>].</figcaption></figure><p id="c315" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">MoonGen的主要特点是:</p><p id="f429" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">1.DPDK用户空间数据流处理，所有高性能都源于此；</p><p id="b719" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">2.Lua [ <a class="ae lh" href="https://www.lua.org/" rel="noopener ugc nofollow" target="_blank"> 5 </a> ]栈，其顶部是用户友好的脚本，后端绑定到基于C的DPDK</p><p id="31ee" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">3.幸亏用Lua编写的JIT脚本运行得相当快，与人们通常对脚本语言的期望相反；</p><p id="acf3" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">MoonGen可以被视为DPDK库周围的Lua包装器。至少以下DPDK操作被暴露给用户Lua接口:</p><ul class=""><li id="e3a3" class="ln lo hu ji b jj jk jn jo jr lp jv lq jz lr kd ls lt lu lv dt translated">网卡配置；</li><li id="7b96" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd ls lt lu lv dt translated">内存池和缓冲区的分配和访问，内存池和缓冲区应连续分配并对齐，以最大限度地提高性能；</li><li id="f6b6" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd ls lt lu lv dt translated">直接访问网卡RSS队列；</li><li id="cc8d" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd ls lt lu lv dt translated">具有NUMA [ <a class="ae lh" href="https://en.wikipedia.org/wiki/Non-uniform_memory_access" rel="noopener ugc nofollow" target="_blank"> 12 </a> ]感知和CPU关联的线程控制API。</li></ul><h2 id="78ff" class="mb kf hu bd kg mc md me kk mf mg mh ko jr mi mj ks jv mk ml kw jz mm mn la mo dt translated">月神</h2><p id="7afb" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">MoonGen是一个基于DPDK的可脚本化的高速数据包生成器。Lua脚本控制整个负载生成器:用户提供的脚本处理所有进一步发送的数据包。得益于令人难以置信的快速LuaJIT VM和数据包处理库DPDK，它可以用64字节的数据包饱和10 Gbps以太网链路，同时只使用一个CPU内核。即使Lua脚本修改了每个包，MoonGen也能达到这个速率。它不依赖于重放相同缓冲区的技巧。</p><p id="3763" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">MoonGen还可以接收分组，例如，检查被测系统丢弃了哪些分组。由于接收也完全在用户的Lua脚本的控制之下，它可以用来实现高级测试脚本。例如，可以使用彼此建立连接的两个月原实例。这种设置可以用来对防火墙等中间设备进行基准测试。</p><p id="1d9e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">MoonGen专注于四个要点:</p><ul class=""><li id="0765" class="ln lo hu ji b jj jk jn jo jr lp jv lq jz lr kd ls lt lu lv dt translated">高性能和多核扩展:每个CPU内核每秒超过2000万个数据包</li><li id="20fe" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd ls lt lu lv dt translated">灵活性:每个包都是由用户提供的Lua脚本实时制作的</li><li id="ce46" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd ls lt lu lv dt translated">精确和准确的时间戳:在商用硬件上进行亚微秒精度的时间戳标记</li><li id="a41a" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd ls lt lu lv dt translated">精确的速率控制:在商用硬件上可靠地生成任意流量模式</li></ul><h2 id="e4cf" class="mb kf hu bd kg mc md me kk mf mg mh ko jr mi mj ks jv mk ml kw jz mm mn la mo dt translated"><strong class="ak"> DPDK </strong></h2><p id="575a" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">DPDK是一个数据平面开发套件，由多个库组成，用于加速在各种CPU架构上运行的数据包处理工作负载。</p><p id="59db" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在网络日益成为人们通信方式的基础的今天，性能、吞吐量和延迟对于无线核心和接入、有线基础设施、路由器、负载平衡器、防火墙、视频流、VoIP等应用越来越重要。</p><p id="5436" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">DPDK是一种轻量级的、无处不在的构建测试和脚本的方式。用户空间数据流不是我们经常看到的，因为通常情况下，应用程序通过OS和内核堆栈与网络硬件通信，这与DPDK的操作方式相反。</p><h2 id="d25d" class="mb kf hu bd kg mc md me kk mf mg mh ko jr mi mj ks jv mk ml kw jz mm mn la mo dt translated"><strong class="ak">卢阿</strong></h2><p id="19b6" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">一般来说，Lua努力提供简单、灵活的元特性，可以根据需要进行扩展，而不是提供一个特定于一种编程范式的特性集。因此，基础语言是轻量级的——完整的参考解释器只有大约<a class="ae lh" href="https://www.lua.org/about.html#why" rel="noopener ugc nofollow" target="_blank"> 180 kB编译的</a>——并且容易适应广泛的应用。</p><p id="450c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">Lua是一种动态类型语言，旨在用作扩展或脚本语言，并且足够紧凑，适合各种主机平台。它只支持少量的原子数据结构，比如布尔值、数字(默认为双精度浮点)和字符串。数组、集合、列表和记录等典型的数据结构可以使用Lua的单一本地数据结构表来表示，这是一种异构的关联数组。</p><p id="76c2" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">Lua使用JIT (just in time)编译，因此，作为一种脚本语言，它仍然具有与C[<a class="ae lh" href="https://nullprogram.com/blog/2018/05/27/" rel="noopener ugc nofollow" target="_blank">10</a>等编译语言相当的性能。</p><h1 id="0c22" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">为什么是月神</h1><p id="312e" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">作为一家反DDoS公司，Qrator Labs需要开发、更新和验证其防护解决方案。为了测试这些，需要一些模拟真实攻击的流量生成器。然而，在OSI的L2、L3层模仿危险但简单的洪水攻击并不容易，因为在流量生成方面实现高性能可能很棘手。</p><p id="ff94" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">换句话说，DDoS缓解公司在隔离的实验室环境中模拟各种DoS攻击来了解不同硬件设置的真实行为是很自然的。</p><p id="88dc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">MoonGen是一种用最少的CPU内核生成网卡线速流量的方法。与生成大量流量的许多其他方式相比，用户空间数据流极大地提高了这种(MoonGen + DPDK)栈的性能。使用纯DPDK需要更多的努力，所以人们不应该对我们的工作流优化工作感到惊讶。为了扩展它的功能和实现一些特定的测试，我们还维护了一个原始MoonGen库的克隆。</p><p id="22b6" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">为了实现最大的灵活性，包生成逻辑由用户定义的Lua脚本描述，这是MoonGen的主要特性之一。在相对简单的数据包处理的情况下，这种解决方案看起来工作得足够快，足以让单个CPU内核的10G接口饱和。一种典型的处理输入包和制作新包的方法是处理相同类型的包，并改变它们的一些字段。</p><p id="5e13" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">考虑l3-tcp-syn-ack-flood示例，如下所述。注意，在它的所有活动中，任何操纵分组的操作都可以在相同的缓冲器中执行，在该缓冲器中存在传入的或先前生成的分组。实际上，这种操作非常快，因为它们不需要像系统调用、访问潜在的未缓存内存等昂贵的操作。</p><h1 id="2ee2" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">Qrator实验室硬件测试</h1><h2 id="6616" class="mb kf hu bd kg mc md me kk mf mg mh ko jr mi mj ks jv mk ml kw jz mm mn la mo dt translated">硬件设置</h2><p id="dd03" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">Qrator Labs维护着一个配有各种硬件的实验室。这里有一些正在使用和测试的NIC示例:</p><ul class=""><li id="e896" class="ln lo hu ji b jj jk jn jo jr lp jv lq jz lr kd ls lt lu lv dt translated">英特尔82599ES 10G</li><li id="b73f" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd ls lt lu lv dt translated">mellan ox ConnectX-4 40克</li><li id="9883" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd ls lt lu lv dt translated">mellan ox ConnectX-5 100克</li></ul><p id="d55c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">注意，当我们处理10G以上的网络接口控制器时，性能问题变得更加紧迫。如今，让一个CPU内核饱和40G接口似乎是不可能的，尽管几个内核就足以做到这一点。</p><p id="a583" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">对于Mellanox网卡，用户可以使用制造商的调整指南[ <a class="ae lh" href="http://www.mellanox.com/related-docs/prod_software/Performance_Tuning_Guide_for_Mellanox_Network_Adapters.pdf" rel="noopener ugc nofollow" target="_blank"> 3 </a> ]来调整设备的某些设置，以实现更高的性能，或者在某些情况下根据需要改变网卡的行为。其他网卡制造商为高性能设备提供了类似的文档，即使您找不到，也可以直接联系该公司。在我们的案例中，Mellanox回答得很快，帮助我们在需要的任务中实现了100%的带宽利用率。</p><h2 id="331b" class="mb kf hu bd kg mc md me kk mf mg mh ko jr mi mj ks jv mk ml kw jz mm mn la mo dt translated">TCP SYN泛洪测试</h2><p id="a20b" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">l3-tcp-syn-ack-flood示例旨在模拟SYN flood攻击[ <a class="ae lh" href="https://en.wikipedia.org/wiki/SYN_flood" rel="noopener ugc nofollow" target="_blank"> 6 </a> ]。它是来自MoonGen central repository的l3-tcp-syn-flood的扩展版本，由Qrator Labs在克隆存储库中开发[7]。我们的测试可以执行三种活动:</p><ol class=""><li id="dfcb" class="ln lo hu ji b jj jk jn jo jr lp jv lq jz lr kd mp lt lu lv dt translated">从头开始生成TCP SYN数据包流，改变一些字段，例如，源IP地址、源端口号等。；</li><li id="929b" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd mp lt lu lv dt translated">根据TCP协议为每个接收到的SYN数据包创建一个有效的ACK回复；</li><li id="0d7e" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd mp lt lu lv dt translated">根据TCP协议为每个收到的ACK数据包创建一个有效的SYN-ACK回复。</li></ol><p id="d46b" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">例如，制作ACK回复的内循环样板代码如下所示:</p><figure class="lj lk ll lm fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mq"><img src="../Images/dc16459f93b2a568434d662f2eacdc27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MlDOVgMCE-0pqg4BcUo6bg.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae lh" href="https://github.com/QratorLabs/MoonGen/blob/master/examples/l3-tcp-syn-ack-flood.lua#L99" rel="noopener ugc nofollow" target="_blank">https://github.com/QratorLabs/MoonGen/blob/master/examples/l3-tcp-syn-ack-flood.lua#L99</a></figcaption></figure><p id="2513" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">一般来说，写回信的想法如下。首先，从RX队列中提取一个包，然后检查收到的包是否是预期的类型。如果是，通过修改原始数据包的某些字段来准备答案。最后，重用同一个缓冲区，将伪造的数据包放入TX队列。为了提高性能，我们从RX队列中抓取所有可用的数据包，制作相应的答案并将其放入TX队列，而不是一个接一个地处理数据包。尽管单个包的操作数量相对较高，但性能仍然足够，因为Lua JIT将所有这些操作编译成几条CPU指令。许多其他测试，不仅仅是TCP SYN/ACK，都是以同样的方式实现的。</p><p id="d83f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">下表显示了在Mellanox ConnectX-4上运行的SYN泛洪测试(仅生成SYN而不回复)的结果。该网卡有两个40G端口，其理论峰值性能为单端口59.52 Mpps，两个端口2 * 50 Mpps。与PCIe的特定NIC连接导致后一种带宽限制(只有2 * 50，而不是预期的2 * 59.52)。</p><figure class="lj lk ll lm fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mr"><img src="../Images/05ce455c8a2da2c3c2064a5e7f80789a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BhCOBTr0PHDpzyLVnwaXBA.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><strong class="bd ms">SYN flood</strong> test; NIC: Mellanox Technologies MT27700 Family (<strong class="bd ms">ConnectX-4</strong>), dual 40G port; CPU: Intel(R) Xeon(R) Silver 4114 CPU @ 2.20GHz</figcaption></figure><p id="8de6" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">下表显示了在只有一个100G端口的Mellanox ConnectX-5上进行的相同SYN flood测试的结果。</p><figure class="lj lk ll lm fq iv fe ff paragraph-image"><div class="fe ff mt"><img src="../Images/88998d9708e17d295ead3aeab8137ead.png" data-original-src="https://miro.medium.com/v2/resize:fit:852/format:webp/1*sUSF_2nsvkW_kwBEagTKbw.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><strong class="bd ms">SYN flood</strong> test; NIC: Mellanox Technologies MT27800 Family (<strong class="bd ms">ConnectX-5</strong>), single 100G port; CPU: Intel(R) Xeon(R) Silver 4114 CPU @ 2.20GHz</figcaption></figure><p id="225e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">请注意，在所有这些情况下，96%以上的理论峰值性能都是通过几个CPU内核实现的。</p><h2 id="220d" class="mb kf hu bd kg mc md me kk mf mg mh ko jr mi mj ks jv mk ml kw jz mm mn la mo dt translated">在PCAP文件中捕获传入流量</h2><p id="29ca" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">另一个例子是rx-to-pcap，它试图将所有传入的流量保存到多个pcap文件[ <a class="ae lh" href="https://en.wikipedia.org/wiki/Pcap" rel="noopener ugc nofollow" target="_blank"> 8 </a> ]中。虽然这个测试不是关于包的生成，但是它可以证明这样一个事实，即这种数据流中最薄弱的环节是文件系统:即使是虚拟的tmpfs文件系统也会降低数据流的速度。在这种情况下，需要8个CPU内核来利用14.88 Mpps，而单个内核就足以接收(并丢弃或重定向)相同数量的流量。</p><p id="7d98" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">下表显示了PCAP文件中接收和保存的流量(Mpps ),这些文件驻留在固态硬盘上的ext2文件系统(第二列)或tmpfs文件系统(第三列)中。</p><figure class="lj lk ll lm fq iv fe ff paragraph-image"><div class="fe ff mu"><img src="../Images/e81aa14cf9e4a26a3f5244d19c1ee622.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*QD-LVIQNsRRUdIPID1y4CQ.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><strong class="bd ms">Rx-to-pcap capture</strong> test; NIC: <strong class="bd ms">Intel 82599ES 10-Gigabit</strong>; CPU: Intel(R) Xeon(R) CPU E5–2683 v4 @ 2.10GHz</figcaption></figure><h1 id="0d36" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">月神强化:任务管理器</h1><p id="fe74" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">我们还引入了MoonGen的扩展，代表了启动一组任务的另一种方式。其思想是将一般配置和特定于任务的选项分开，以同时运行任意数量的各种任务(即Lua脚本)。该实现在Qrator的存储库克隆中公开，并在那里进行了描述[ <a class="ae lh" href="https://github.com/QratorLabs/MoonGen#using-tman-task-manager" rel="noopener ugc nofollow" target="_blank"> 9 </a> ]，让我们重述一下。</p><p id="ec5f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">较新的CLI界面允许同时启动许多不同的任务。这是概要:</p><figure class="lj lk ll lm fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mv"><img src="../Images/7665f6f8a46e4eff210c46798fcef1b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q8qywqUzWl0uMa4dNyy48A.png"/></div></div></figure><p id="65b4" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">还有。/build/tman -h提供了更多增强的帮助。</p><p id="bc2e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然而，普通的任务Lua文件与<em class="mw"> tman </em>接口不兼容。用于<em class="mw"> tman </em>的任务文件必须确定以下对象:</p><ul class=""><li id="3e8d" class="ln lo hu ji b jj jk jn jo jr lp jv lq jz lr kd ls lt lu lv dt translated">描述任务选项的函数配置(解析器)。</li><li id="af02" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd ls lt lu lv dt translated">描述正在运行的功能任务(taskNum，txInfo，rxInfo，args)。这里txInfo和rxInfo分别是RX和TX队列的数组，args保存任务管理器和任务本身的参数。</li></ul><p id="01a7" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">参见examples/tman/中的示例。</p><p id="86e1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">使用任务管理器可以更灵活地运行异构任务。</p><h1 id="b2a2" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">结论</h1><p id="ca01" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">MoonGen方法似乎很符合我们的目标，因为它提供了高性能，同时还保持了用脚本语言编写的测试的简单性。性能的提高主要归功于两个特性:直接NIC缓冲区访问和Lua中的JIT技术。</p><p id="7ec3" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">通常有可能达到网卡的理论峰值性能。单个内核可能足以使10G端口饱和，而几个内核可能足以使100G端口饱和。</p><p id="0c48" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们感谢Mellanox团队的合作和MoonGen团队在修复错误方面的反应。</p><h1 id="8808" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">参考</h1><ol class=""><li id="a6cf" class="ln lo hu ji b jj lc jn ld jr mx jv my jz mz kd mp lt lu lv dt translated">MoonGen:一个可脚本化的高速包生成器—保罗·埃梅里希等，互联网测量大会2015 (IMC'15)，2015<br/><a class="ae lh" href="https://www.net.in.tum.de/fileadmin/bibtex/publications/papers/MoonGen_IMC2015.pdf" rel="noopener ugc nofollow" target="_blank">https://www . net . in . tum . de/file admin/bibtex/publications/papers/MoonGen _ IMC 2015 . pdf</a></li><li id="4412" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd mp lt lu lv dt translated">pktgen<a class="ae lh" href="http://netoptimizer.blogspot.com/2014/10/unlocked-10gbps-tx-wirespeed-smallest.html" rel="noopener ugc nofollow" target="_blank">http://net optimizer . blogspot . com/2014/10/unlocked-10g bps-tx-wirespeed-small . html</a></li><li id="ad82" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd mp lt lu lv dt translated">Mellanox调优指南:<a class="ae lh" href="http://www.mellanox.com/related-docs/prod_software/Performance_Tuning_Guide_for_Mellanox_Network_Adapters.pdf" rel="noopener ugc nofollow" target="_blank">http://www . mellan ox . com/related-docs/prod _ software/Performance _ Tuning _ Guide _ for _ mellan ox _ Network _ adapters . pdf</a></li><li id="20de" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd mp lt lu lv dt translated">数据平面开发套件:【https://www.dpdk.org/】T4，</li><li id="4ea9" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd mp lt lu lv dt translated">卢亚:<a class="ae lh" href="https://www.lua.org/" rel="noopener ugc nofollow" target="_blank">https://www.lua.org/</a></li><li id="53fb" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd mp lt lu lv dt translated">合成洪水:<a class="ae lh" href="https://en.wikipedia.org/wiki/SYN_flood" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/SYN_flood</a></li><li id="1e0c" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd mp lt lu lv dt translated">Qrator实验室的月神库克隆:<a class="ae lh" href="https://github.com/QratorLabs/MoonGen" rel="noopener ugc nofollow" target="_blank">https://github.com/QratorLabs/MoonGen</a></li><li id="ac9c" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd mp lt lu lv dt translated">https://en.wikipedia.org/wiki/Pcap PCAP文件格式:<a class="ae lh" href="https://en.wikipedia.org/wiki/Pcap" rel="noopener ugc nofollow" target="_blank"/></li><li id="2829" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd mp lt lu lv dt translated">任务管理器:<a class="ae lh" href="https://github.com/QratorLabs/MoonGen#using-tman-task-manager" rel="noopener ugc nofollow" target="_blank">https://github . com/QratorLabs/MoonGen # using-tman-task-manager</a></li><li id="03e8" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd mp lt lu lv dt translated">卢阿表演:<a class="ae lh" href="https://nullprogram.com/blog/2018/05/27/" rel="noopener ugc nofollow" target="_blank">https://nullprogram.com/blog/2018/05/27/</a></li><li id="2496" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd mp lt lu lv dt translated">网络功能虚拟化白皮书:<a class="ae lh" href="https://portal.etsi.org/NFV/NFV_White_Paper.pdf" rel="noopener ugc nofollow" target="_blank">https://portal.etsi.org/NFV/NFV_White_Paper.pdf</a></li><li id="ef5c" class="ln lo hu ji b jj lw jn lx jr ly jv lz jz ma kd mp lt lu lv dt translated">非均匀内存访问:<a class="ae lh" href="https://en.wikipedia.org/wiki/Non-uniform_memory_access" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Non-uniform_memory_access</a></li></ol></div></div>    
</body>
</html>