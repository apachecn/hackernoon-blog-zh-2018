<html>
<head>
<title>Today I Learned: Dealing with JSON DateTime when Unmarshal in Golang.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">今天我学习了:在Golang中解组时处理JSON DateTime。</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/today-i-learned-dealing-with-json-datetime-when-unmarshal-in-golang-4b281444fb67?source=collection_archive---------3-----------------------#2018-09-23">https://medium.com/hackernoon/today-i-learned-dealing-with-json-datetime-when-unmarshal-in-golang-4b281444fb67?source=collection_archive---------3-----------------------#2018-09-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="fbd1" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">当心日期时间标准！！</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff jj"><img src="../Images/7cbc5d4bc330802e440741e6a9a84d82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*A4u_3vaAg2DzF_R9-5ksXg.jpeg"/></div><figcaption class="jr js fg fe ff jt ju bd b be z ek">Golang taken from google image search</figcaption></figure><p id="dc9d" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">所以今天的故事是关于在Golang中从JSON解组DateTime时的奇怪行为。我不是说这是一个错误，但这只是我的故事，因为我缺乏处理Golang中日期和时区的经验</p><p id="39c1" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">当我想用Golang做一个CRUD API系统的时候就发生了。所以，我有一个端点，比方说:<code class="eh kr ks kt ku b">/event</code>，它将从JSON接收一个事件对象。</p><pre class="jk jl jm jn fq kv ku kw kx aw ky dt"><span id="eece" class="kz la hu ku b fv lb lc l ld le">{<br/>  "title": "title here in string",<br/>  "place": "place name here in string",<br/>  "start_time": "date time here in string"<br/>}</span></pre><p id="346d" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我使用<a class="ae lf" href="http://github.com/labstack/echo" rel="noopener ugc nofollow" target="_blank"> labstack/echo </a>作为我的路由库，以方便我处理我的请求。使用echo，要接收响应体并将其解组到我的结构，我可以用如下简单代码来完成:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lg lh l"/></div></figure><p id="33de" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">因此，当我想测试它时，我制作了如下的请求体，我只是从我们的API文档示例中复制粘贴它。因为一开始，我甚至不认为这有什么关系。</p><pre class="jk jl jm jn fq kv ku kw kx aw ky dt"><span id="e7f9" class="kz la hu ku b fv lb lc l ld le">{<br/>  "title": "Core i13 Anniversarry",<br/>  "place": "Ancol Beach",<br/>  "start_time": "<strong class="ku hv">2018-09-22T12:42:31Z</strong>"<br/>}</span></pre><p id="09f3" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">API已经部署到了临时服务器上，所以我直接从Postman到临时服务器上测试它。但是在获取所有存储的事件项之后，<code class="eh kr ks kt ku b">start_time</code>与我在请求体中发布的不同。下面就变成这样了。</p><pre class="jk jl jm jn fq kv ku kw kx aw ky dt"><span id="b08a" class="kz la hu ku b fv lb lc l ld le">{<br/>  "id": "1", // <em class="li">auto increment from database</em><br/>  "title": "Core i13 Anniversarry",<br/>  "place": "Ancol Beach",<br/>  "start_time": "<strong class="ku hv">2018-09-22T19:42:31+07:00</strong>",<br/>  "created_at": "2018-09-22T16:35:08+07:00",<br/>  "updated_at": "2018-09-22T16:35:08+07:00"<br/>}</span></pre><p id="c1f5" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在数据库中，它是这样存储的:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff lj"><img src="../Images/1eb7626160f1ca35958fd251fe24a0a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1356/format:webp/1*zq3bzfDUHZE7yCfAr0-O7Q.png"/></div><figcaption class="jr js fg fe ff jt ju bd b be z ek">row in MySQL</figcaption></figure><p id="c72f" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">看这个<code class="eh kr ks kt ku b">start_time</code>领域。和我贴的不一样。我想要的是，存储的数据与我从邮递员那里发布的数据相同。</p><p id="9f1a" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我发现这个问题的发生显然是因为时区。所以我只需要注意时区。这是我的第一个想法。我想我的系统在这方面有问题。</p><h1 id="0115" class="lk la hu bd ll lm ln lo lp lq lr ls lt ja lu jb lv jd lw je lx jg ly jh lz ma dt translated">解决问题</h1><p id="9a0f" class="pw-post-body-paragraph jv jw hu jx b jy mb iv ka kb mc iy kd ke md kg kh ki me kk kl km mf ko kp kq hn dt translated">为了解决这个问题，我做了下面的所有操作。</p><h2 id="2ef9" class="kz la hu bd ll mg mh mi lp mj mk ml lt ke mm mn lv ki mo mp lx km mq mr lz ms dt translated">在连接驱动程序中查找连接字符串</h2><p id="5819" class="pw-post-body-paragraph jv jw hu jx b jy mb iv ka kb mc iy kd ke md kg kh ki me kk kl km mf ko kp kq hn dt translated">因为我使用MySQL作为我的数据库存储，所以我需要一个驱动程序来连接我的应用程序和MySQL。我正在使用github.com/go-sql-driver/mysql作为我的连接驱动程序。所以在查找文档并检查我的连接字符串后，没有任何错误发生。我做对了。</p><pre class="jk jl jm jn fq kv ku kw kx aw ky dt"><span id="63b1" class="kz la hu ku b fv lb lc l ld le">dsn := root:root@tcp(127.0.0.1:3306)/event?parseTime=true&amp;loc=Asia%2FJakarta&amp;charset=utf8mb4&amp;collation=utf8mb4_unicode_ci</span></pre><h2 id="80b9" class="kz la hu bd ll mg mh mi lp mj mk ml lt ke mm mn lv ki mo mp lx km mq mr lz ms dt translated">手动重建日期时间</h2><p id="a20c" class="pw-post-body-paragraph jv jw hu jx b jy mb iv ka kb mc iy kd ke md kg kh ki me kk kl km mf ko kp kq hn dt translated">还是很好奇，为什么会这样。然后我试图在StackOverflow甚至GitHub中找到任何关于这个问题的问答或问题。</p><p id="66cd" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">老实说，我花了2个小时来解决这个问题🤦‍ <br/>直到那时，我才感到沮丧。所以我有两个选择来解决这个问题。</p><ol class=""><li id="3dd3" class="mt mu hu jx b jy jz kb kc ke mv ki mw km mx kq my mz na nb dt translated">我将在存储到数据库之前重建<code class="eh kr ks kt ku b">start_time</code>。</li><li id="3fe8" class="mt mu hu jx b jy nc kb nd ke ne ki nf km ng kq my mz na nb dt translated">问我的队友(*不管怎样，问这个问题会觉得很傻🤦‍)</li></ol><p id="38a3" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">但是，只想付出更多的努力😶，我通过重建日期时间进行了修复。</p><pre class="jk jl jm jn fq kv ku kw kx aw ky dt"><span id="4778" class="kz la hu ku b fv lb lc l ld le">startTime := e.StartTime</span><span id="2002" class="kz la hu ku b fv nh lc l ld le">loc, _ := time.LoadLocation("Asia/Jakarta")</span><span id="6df9" class="kz la hu ku b fv nh lc l ld le">localStartTime := time.Date(startTime.Year(), startTime.Month(), startTime.Day(), startTime.Hour(), startTime.Minute(), startTime.Second(), startTime.Nanosecond(), loc)</span></pre><p id="33a7" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然后，出于好奇，我向我的团队询问了这个问题。然后他们看我如何复制它，和我一样，他们也很好奇为什么会发生这种情况。直到几分钟后，我的一个团队找到了发生这种情况的原因。</p><p id="fb73" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">发生这种情况是因为我在请求体中设置了错误的时区偏移量。</p><pre class="jk jl jm jn fq kv ku kw kx aw ky dt"><span id="db5c" class="kz la hu ku b fv lb lc l ld le">{<br/>  "title": "Core i13 Anniversarry",<br/>  "place": "Ancol Beach",<br/>  "start_time": "<strong class="ku hv">2018-09-22T12:42:31Z</strong>" // <em class="li">look for the `</em><strong class="ku hv"><em class="li">Z</em></strong><em class="li">` indicator</em><br/>}</span></pre><p id="a150" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">因为我在<code class="eh kr ks kt ku b">+7.00 timezone (Asia/Jakarta)</code>生活过，所以应该收录在我的JSON里。</p><p id="750d" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">所以，当我把<code class="eh kr ks kt ku b">start_time</code>从:</p><pre class="jk jl jm jn fq kv ku kw kx aw ky dt"><span id="1c1a" class="kz la hu ku b fv lb lc l ld le">2018-09-22T12:42:31<strong class="ku hv">Z</strong></span></pre><p id="96bb" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">到…里面</p><pre class="jk jl jm jn fq kv ku kw kx aw ky dt"><span id="45dd" class="kz la hu ku b fv lb lc l ld le">2018-09-22T12:42:31<strong class="ku hv">+07:00</strong></span></pre><p id="d261" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">它解决了我的问题。我的系统没有任何问题。一切都很完美。</p><p id="8a01" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">当我意识到这一点时，我觉得自己很笨🤦‍.我白白浪费了我生命中的两个小时🤦‍.</p><h2 id="5be7" class="kz la hu bd ll mg mh mi lp mj mk ml lt ke mm mn lv ki mo mp lx km mq mr lz ms dt translated">要吸取的教训</h2><ul class=""><li id="06b7" class="mt mu hu jx b jy mb kb mc ke ni ki nj km nk kq nl mz na nb dt translated">总是先问你的队友(如果他们有空的话)</li><li id="ec08" class="mt mu hu jx b jy nc kb nd ke ne ki nf km ng kq nl mz na nb dt translated"><code class="eh kr ks kt ku b">2018–09–22T12:42:31+07:00</code>是RFC 3339 的<a class="ae lf" href="https://www.ietf.org/rfc/rfc3339.txt" rel="noopener ugc nofollow" target="_blank">格式，每一个字符都很重要。</a></li></ul></div><div class="ab cl nm nn hc no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="hn ho hp hq hr"><p id="2fd9" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><em class="li">如果你觉得这篇文章值得一读，就给点掌声或者分享到你的网络圈，这样大家也能读到这个。关注更多类似的故事！</em></p></div></div>    
</body>
</html>