<html>
<head>
<title>Redirecting all variants of your domain to https Version</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将域的所有变体重定向到https版本</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/redirecting-all-variants-of-your-domain-to-https-version-1db5f8b37418?source=collection_archive---------9-----------------------#2018-09-27">https://medium.com/hackernoon/redirecting-all-variants-of-your-domain-to-https-version-1db5f8b37418?source=collection_archive---------9-----------------------#2018-09-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/a60c1d697f3f467f2679f4eb0bc13cdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I57yzYWhtbu9-zLq0Z6lgA.jpeg"/></div></div></figure><p id="147a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当你终于要对你的网站上的某些东西做出改变并且你不能再推迟它的时候，你怎么做？当谷歌开始处罚。</p><p id="5358" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我一直在推迟为我的网站<a class="ae ka" href="https://www.bitfolio.org/" rel="noopener ugc nofollow" target="_blank">https://www.bitfolio.org/</a>设置https，但是自从谷歌开始处罚没有https的网站<a class="ae ka" href="https://ahrefs.com/blog/http-vs-https-for-seo/" rel="noopener ugc nofollow" target="_blank">和谷歌chrome开始显示所有https网站的不安全图标，我想终于为我的网站设置了SSL证书。</a></p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div class="fe ff kb"><img src="../Images/26fb1c7031b97994de3180f25d1afc7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:454/format:webp/1*ZHCEoW0UgkaWEB82H0DVHw.png"/></div><figcaption class="kg kh fg fe ff ki kj bd b be z ek">Chrome says Not Secure</figcaption></figure><p id="9adc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ka" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> Lets Encrypt </a>在成本和安装简易性方面都是救星。唯一的缺点是每三个月需要更新一次。一旦完成设置，您可以检查<a class="ae ka" href="https://www.ssllabs.com/ssltest/analyze.html?d=bitfolio.org&amp;latest" rel="noopener ugc nofollow" target="_blank">https://www.ssllabs.com/ssltest/analyze.html?d=bitfolio.org&amp;最新</a>以确保其正确实施。</p><p id="24d9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦这样做了，我想这应该是一件容易的事。但是令我惊讶的是，即使在Drupal中工作了几年之后，我仍然不完全了解完整的设置。我总是把这个部分交给我的系统管理员。我花了一些时间才弄明白，我发现的博客并没有真正的帮助。所以我想到这里把它组合起来。</p></div><div class="ab cl kk kl hc km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hn ho hp hq hr"><p id="3dcb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">假设我有一个域example.com，我想重定向这个域的所有变化到https版本。</p><p id="35fd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">可以有六种变奏<br/><code class="eh kr ks kt ku b">example.com</code><code class="eh kr ks kt ku b"><a class="ae ka" href="http://www.example.com`" rel="noopener ugc nofollow" target="_blank">www.example.com</a></code><code class="eh kr ks kt ku b"><a class="ae ka" href="http://example.com`" rel="noopener ugc nofollow" target="_blank">http://example.com</a></code><code class="eh kr ks kt ku b"><a class="ae ka" href="http://www.example.com`" rel="noopener ugc nofollow" target="_blank">http://www.example.com</a></code><code class="eh kr ks kt ku b"><a class="ae ka" href="https://example.com`" rel="noopener ugc nofollow" target="_blank">https://example.com</a></code><code class="eh kr ks kt ku b"><a class="ae ka" href="https://www.example.com`" rel="noopener ugc nofollow" target="_blank">https://www.example.com</a></code>。</p><p id="1efa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我想确保所有这些变化都重定向到<code class="eh kr ks kt ku b"><a class="ae ka" href="https://www.example.com`" rel="noopener ugc nofollow" target="_blank">https://www.example.com</a></code>。</p><p id="26ec" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh kr ks kt ku b">example.com</code>是你的域名<code class="eh kr ks kt ku b"><a class="ae ka" href="http://www.example.com`" rel="noopener ugc nofollow" target="_blank">www.example.com</a></code>的裸版。转到您的域提供商并添加一个指向您的服务器IP的名称。</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kv"><img src="../Images/d739471c1f5c64648fe5748b3d20bc61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XL7vZ_pX9dz_A7YIqJnt7w.png"/></div></div><figcaption class="kg kh fg fe ff ki kj bd b be z ek">Add A name</figcaption></figure><p id="79a5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">添加一个C名称，将www版本也指向同一个IP。</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kw"><img src="../Images/8965e88a51874241824d7b1796083efb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*surmBbZwxWg6_iNBbfPLTQ.png"/></div></div><figcaption class="kg kh fg fe ff ki kj bd b be z ek">Add a C Name</figcaption></figure><p id="5fff" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">假设您正在运行Apache(所有服务器都有类似的设置),请转到您的虚拟主机，并确保添加Servername和ServerAlias</p><pre class="kc kd ke kf fq kx ku ky kz aw la dt"><span id="f9e9" class="lb lc hu ku b fv ld le l lf lg">&lt;VirtualHost *:80&gt; <br/> ServerName example.com<br/> ServerAlias <a class="ae ka" href="http://www.example.com" rel="noopener ugc nofollow" target="_blank">www.example.com</a></span></pre><p id="6094" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这将确保您的服务器监听裸域和普通域，并将它们指向您的代码文件夹以供执行。</p><p id="bfb8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在转到你的<code class="eh kr ks kt ku b">.htaccess</code>文件</p><p id="d1dc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">确保您有以下代码。</p><pre class="kc kd ke kf fq kx ku ky kz aw la dt"><span id="235e" class="lb lc hu ku b fv ld le l lf lg">RewriteEngine on<br/> <br/> # Set “protossl” to “s” if we were accessed via <a class="ae ka" rel="noopener ugc nofollow" target="_blank" href="/">https://</a>. This is used later<br/> # if you enable “www.” stripping or enforcement, in order to ensure that<br/> # you don’t bounce between http and https.<br/> RewriteRule ^ — [E=protossl]<br/> RewriteCond %{HTTPS} on<br/> RewriteRule ^ — [E=protossl:s]</span></pre><p id="1d4f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您使用https访问过，这段代码将设置一个名为<code class="eh kr ks kt ku b">protossl</code>的标志。这将确保您不会进入评论中提到的http和https之间的无限重定向。</p><p id="33d3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注释掉所有其他与http和https重定向相关的设置。然后添加以下内容</p><pre class="kc kd ke kf fq kx ku ky kz aw la dt"><span id="0d58" class="lb lc hu ku b fv ld le l lf lg"> #<br/> # Rewrite http(s)://example.com to <a class="ae ka" href="https://www.example.com" rel="noopener ugc nofollow" target="_blank">https://www.example.com</a><br/> #<br/> RewriteCond “%{HTTP_HOST}” “!^www\.” [NC]<br/> RewriteCond “%{HTTP_HOST}” “!^$”<br/> RewriteRule ^ https://www.%{HTTP_HOST}%{REQUEST_URI} [L,R=301]<br/> <br/> #<br/> # Rewrite <a class="ae ka" href="http://www.example.com" rel="noopener ugc nofollow" target="_blank">http://www.example.com</a> to <a class="ae ka" href="https://www.example.com" rel="noopener ugc nofollow" target="_blank">https://www.example.com</a><br/> #<br/> RewriteCond %{HTTPS} off<br/> RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]</span></pre><p id="f30c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这段代码由<a class="ae ka" href="https://www.drupal.org/u/mdrescher" rel="noopener ugc nofollow" target="_blank">https://www.drupal.org/u/mdrescher</a>在<br/> <a class="ae ka" href="https://www.drupal.org/forum/support/post-installation/2018-04-15/forcing-to-https#comment-12723535" rel="noopener ugc nofollow" target="_blank">上提供https://www . Drupal . org/forum/support/post-installation/2018-04-15/forcing-to-https # comment-12723535</a>查看他关于为什么需要两种不同规则的评论。</p><p id="f10a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这些改变将确保所有六个变体<code class="eh kr ks kt ku b">example.com</code>、<code class="eh kr ks kt ku b"><a class="ae ka" href="http://www.example.com`" rel="noopener ugc nofollow" target="_blank">www.example.com</a></code>、<code class="eh kr ks kt ku b"><a class="ae ka" href="http://example.com`" rel="noopener ugc nofollow" target="_blank">http://example.com</a></code>、<code class="eh kr ks kt ku b"><a class="ae ka" href="http://www.example.com`" rel="noopener ugc nofollow" target="_blank">http://www.example.com</a></code>、<code class="eh kr ks kt ku b"><a class="ae ka" href="https://example.com`" rel="noopener ugc nofollow" target="_blank">https://example.com</a></code>、<code class="eh kr ks kt ku b"><a class="ae ka" href="https://www.example.com`" rel="noopener ugc nofollow" target="_blank">https://www.example.com</a></code>都被重定向到<code class="eh kr ks kt ku b"><a class="ae ka" href="https://www.example.com`" rel="noopener ugc nofollow" target="_blank">https://www.example.com</a></code></p><p id="aeea" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">希望它能为即将搬到<code class="eh kr ks kt ku b">https</code>的人节省时间。<code class="eh kr ks kt ku b">https</code>对整体互联网有好处。请在本周末抽出时间将您的网站迁移到<code class="eh kr ks kt ku b">https</code>。</p></div><div class="ab cl kk kl hc km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hn ho hp hq hr"><p id="d430" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这一节是根据伊利亚的评论增加的。</p><p id="6a56" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="lh li gr" href="https://medium.com/u/fe94790df425?source=post_page-----1db5f8b37418--------------------------------" rel="noopener" target="_blank">伊利亚·埃尔·马塔尼</a>提出了关于HSLD的建议，我花了一些时间对此进行了调查。302重定向手动将http请求重定向到https。但是它也为黑客提供了一个窃听的窗口。HSTS预加载确保浏览器知道网站通过发送给浏览器的报头使用https。</p><blockquote class="lj lk ll"><p id="4cc6" class="jc jd lm je b jf jg jh ji jj jk jl jm ln jo jp jq lo js jt ju lp jw jx jy jz hn dt translated">" T <!-- -->它设置严格传输安全策略字段参数。它通过HTTPS加密强制建立这些连接，忽略任何脚本通过HTTP加载该域中任何资源的调用。”</p></blockquote><p id="ef15" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以在<a class="ae ka" href="https://www.globalsign.com/en/blog/what-is-hsts-and-how-do-i-use-it/" rel="noopener ugc nofollow" target="_blank">https://www . globalsign . com/en/blog/what-is-hsts-and-how-do-I-use-it/</a>上了解更多信息</p><p id="df50" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要启用HSTS，运行<code class="eh kr ks kt ku b">apachectl -M</code>并确保割台模块已启用。如果没有，使用<code class="eh kr ks kt ku b">sudo a2enmod headers</code>启用标题。</p><p id="36ca" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">将以下内容添加到您的。htaccess文件。</p><pre class="kc kd ke kf fq kx ku ky kz aw la dt"><span id="3ad4" class="lb lc hu ku b fv ld le l lf lg">Header always set Strict-Transport-Security “max-age=63072000; includeSubDomains; preload”</span></pre><p id="d2c1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦你完成了修改，访问<a class="ae ka" href="https://hstspreload.org/?domain=bitfolio.org" rel="noopener ugc nofollow" target="_blank">https://hstspreload.org/?domain=bitfolio.org</a>来检查你的域名的状态。如果一切正常，那么您可以提交表单，将您的域名包含在预加载列表中。</p><p id="e577" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了使它与提供的建议兼容，我必须在htaccess代码中注释第一部分。</p><pre class="kc kd ke kf fq kx ku ky kz aw la dt"><span id="d163" class="lb lc hu ku b fv ld le l lf lg"> #<br/> # Rewrite http(s)://example.com to <a class="ae ka" href="https://www.example.com" rel="noopener ugc nofollow" target="_blank">https://www.example.com</a><br/> #<br/> #RewriteCond “%{HTTP_HOST}” “!^www\.” [NC]<br/> #RewriteCond “%{HTTP_HOST}” “!^$”<br/> #RewriteRule ^ https://www.%{HTTP_HOST}%{REQUEST_URI} [L,R=301]<br/> <br/> #<br/> # Rewrite <a class="ae ka" href="http://www.example.com" rel="noopener ugc nofollow" target="_blank">http://www.example.com</a> to <a class="ae ka" href="https://www.example.com" rel="noopener ugc nofollow" target="_blank">https://www.example.com</a><br/> #<br/> RewriteCond %{HTTPS} off<br/> RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]</span></pre><p id="ce58" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">虽然这可以确保您总是被重定向到https版本并且启用了HSTS，但是它认为www和裸版本是不同的。我仍在检查是否有办法解决这个问题。如果你已经明白了这一点，请评论。</p></div></div>    
</body>
</html>