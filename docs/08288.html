<html>
<head>
<title>You shouldn’t use Python 3.7 for data science right now</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你现在不应该将Python 3.7用于数据科学</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/you-shouldnt-use-python-3-7-for-data-science-right-now-18837c82f977?source=collection_archive---------13-----------------------#2018-10-02">https://medium.com/hackernoon/you-shouldnt-use-python-3-7-for-data-science-right-now-18837c82f977?source=collection_archive---------13-----------------------#2018-10-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/c48cd932db2e0fc991b8a7a0f66889d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SRix3UOy4ffCluic"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">“selective focus photography of girl crying” by <a class="ae jg" href="https://unsplash.com/@arwanod?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Arwan Sutanto</a> on <a class="ae jg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div><div class="ab cl jh ji hc jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hn ho hp hq hr"><p id="608d" class="pw-post-body-paragraph jo jp hu jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated"><strong class="jq hv">更新:Anaconda发布了一个补丁！如果您重新安装numpy 1.15.2(至少在linux上),您应该注意到您的内部版本号从1 . 15 . 2-py 37 h1 d 66 E8 a _ 0→1 . 15 . 2-py 37 h1 d 66 E8 a _ 1。这些构建在PyPi上不可用。Numpy 1.15.3也包含一个修复程序。我不建议用Python 3.7的旧版本NumPy】</strong></p><p id="0f37" class="pw-post-body-paragraph jo jp hu jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated"><strong class="jq hv">我们运营一个</strong> <a class="ae jg" href="https://www.saturncloud.io" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hv">云托管的Jupyter </strong> </a> <strong class="jq hv">笔记本服务。</strong> <a class="ae jg" href="https://www.saturncloud.io" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hv">今天就开始</strong> </a> <strong class="jq hv">！</strong></p></div><div class="ab cl jh ji hc jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hn ho hp hq hr"><p id="441b" class="pw-post-body-paragraph jo jp hu jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">我认为这是数据科学工作流和Python 3.7目前的一个严重缺陷。bug不在Python中，而是在NumPy中，在NumPy中有时会吞掉造型错误。这意味着您可以将字符串转换为复数，并且NumPy可能不会抛出异常。Pandas依靠NumPy的错误处理来确定您的数据帧是否全是数字。所以有时候，取数据帧的平均值可以得到复数形式的结果。在NumPy补丁发布之前，每个人都应该继续使用Python 3.6。相关github问题在NumPy <a class="ae jg" href="https://github.com/numpy/numpy/issues/11993" rel="noopener ugc nofollow" target="_blank"> #11993 </a>、<a class="ae jg" href="https://github.com/numpy/numpy/pull/12062" rel="noopener ugc nofollow" target="_blank"> #12062 </a>和熊猫<a class="ae jg" href="https://github.com/pandas-dev/pandas/issues/22506" rel="noopener ugc nofollow" target="_blank"> #22506 </a>、<a class="ae jg" href="https://github.com/pandas-dev/pandas/issues/22753" rel="noopener ugc nofollow" target="_blank"> #22753 </a>中。您可以通过将<code class="eh km kn ko kp b">numeric_only=True</code>传递到对<code class="eh km kn ko kp b">.mean</code>的调用中来规避这个问题，但是您不太可能已经这样做了。NumPy的修复已被合并。一旦发布，你应该升级。</p><h1 id="29d7" class="kq kr hu bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">数字臭虫</h1><p id="34d2" class="pw-post-body-paragraph jo jp hu jq b jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ls kj kk kl hn dt translated">如果我们看看NumPy 中用于将对象转换成其他类型的<a class="ae jg" href="https://github.com/numpy/numpy/blob/v1.15.2/numpy/core/src/multiarray/arraytypes.c.src#L1481" rel="noopener ugc nofollow" target="_blank">代码:</a></p><pre class="lt lu lv lw fq lx kp ly lz aw ma dt"><span id="6361" class="mb kr hu kp b fv mc md l me mf">static void<br/>OBJECT_to_@TOTYPE@(void *input, void *output, npy_intp n,<br/>        void *NPY_UNUSED(aip), void *aop)<br/>{<br/>    PyObject **ip = input;<br/>    @totype@ *op = output;<br/><br/>    npy_intp i;<br/>    int skip = @skip@;<br/><br/>    for (i = 0; i &lt; n; i++, ip++, op += skip) {<br/>        if (*ip == NULL) {<br/>            @TOTYPE@_setitem(Py_False, op, aop);<br/>        }<br/>        else {<br/>            @TOTYPE@_setitem(*ip, op, aop);<br/>        }<br/>    }<br/>}</span></pre><p id="f55a" class="pw-post-body-paragraph jo jp hu jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">当<code class="eh km kn ko kp b">@TOTYPE@_setitem</code>调用出现问题时，该代码不会退出。<a class="ae jg" href="https://github.com/ahaldane" rel="noopener ugc nofollow" target="_blank"> @ahaldane </a>发现并修复为</p><pre class="lt lu lv lw fq lx kp ly lz aw ma dt"><span id="6a5b" class="mb kr hu kp b fv mc md l me mf">static void<br/>OBJECT_to_@TOTYPE@(void *input, void *output, npy_intp n,<br/>        void *NPY_UNUSED(aip), void *aop)<br/>{<br/>    PyObject **ip = input;<br/>    @totype@ *op = output;<br/><br/>    npy_intp i;<br/>    int skip = @skip@;<br/><br/>    for (i = 0; i &lt; n; i++, ip++, op += skip) {<br/>        if (*ip == NULL) {<br/>            if (@TOTYPE@_setitem(Py_False, op, aop) &lt; 0) {<br/>                return;<br/>            }<br/>        }<br/>        else {<br/>            if (@TOTYPE@_setitem(*ip, op, aop) &lt; 0) {<br/>                return;<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="fdfe" class="pw-post-body-paragraph jo jp hu jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">在不退出循环的情况下，后续调用可能会调用一些CPython代码，这些代码在3.7中被更改为调用<code class="eh km kn ko kp b">PyErr_Clear</code>。顺便说一下，如果您觉得这段代码很奇怪，那是因为NumPy使用了自己的模板引擎。</p><h1 id="9fee" class="kq kr hu bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">熊猫冲击</h1><p id="b6ba" class="pw-post-body-paragraph jo jp hu jq b jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ls kj kk kl hn dt translated">这当然会比我在这里描述的影响更大，但是最直接的影响是，有时聚合混合类型的数据帧会导致复杂的结果。为了说明这个问题的不可预测性，请尝试以下示例:</p><pre class="lt lu lv lw fq lx kp ly lz aw ma dt"><span id="bccf" class="mb kr hu kp b fv mc md l me mf">df = pd.DataFrame({<br/>    "user":["A", "A", "A", "A", "A"],<br/>    "connections":[3.0, 4970.0, 4749.0, 4719.0, 4704.0],<br/>})<br/>df['connections2'] = df.connections.astype('int64')<br/>print()<br/>print('usually incorrect')<br/>print()<br/>print(df.mean())<br/>print()<br/>print(df.head())<br/>print()<br/>print('usually correct')<br/>print()<br/>print(df.mean())</span></pre><p id="409b" class="pw-post-body-paragraph jo jp hu jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">我总是得到类似这样的输出:</p><pre class="lt lu lv lw fq lx kp ly lz aw ma dt"><span id="5e30" class="mb kr hu kp b fv mc md l me mf">usually incorrect<br/><br/>user            (1.38443408503753e-310+1.38443408513886e-310j)<br/>connections       (1.3844303826283e-310+1.3844336097506e-310j)<br/>connections2                                         (3829+0j)<br/>dtype: complex128<br/><br/>  user  connections  connections2<br/>0    A          3.0             3<br/>1    A       4970.0          4970<br/>2    A       4749.0          4749<br/>3    A       4719.0          4719<br/>4    A       4704.0          4704<br/><br/>usually correct<br/><br/>connections     3829.0<br/>connections2    3829.0<br/>dtype: float64</span></pre><p id="5a63" class="pw-post-body-paragraph jo jp hu jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">为了说明不可预测性，如果我取出对<code class="eh km kn ko kp b">print(df.head())</code>的调用，那么我几乎每次都会得到复杂的结果。如果我将connections2的初始化放入dataframe构造函数，我几乎总是得到黑色的浮点结果，但是有时，我会错误地将“用户”的平均值设为0.0</p><p id="f28c" class="pw-post-body-paragraph jo jp hu jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">发生这种情况的原因是因为<code class="eh km kn ko kp b">_reduce</code>方法依赖于当归约函数应用于<code class="eh km kn ko kp b">.values</code>时发生的异常。如果失败，Pandas试图<a class="ae jg" href="https://github.com/pandas-dev/pandas/blob/v0.23.4/pandas/core/frame.py#L6901" rel="noopener ugc nofollow" target="_blank">只提取数字列</a>，然后再次应用该函数。在我们真正得到纯数字数据之前，有两次尝试调用函数<a class="ae jg" href="https://github.com/pandas-dev/pandas/blob/v0.23.4/pandas/core/frame.py#L6866" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae jg" href="https://github.com/pandas-dev/pandas/blob/v0.23.4/pandas/core/frame.py#L6893" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><h1 id="2241" class="kq kr hu bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">结论</h1><p id="1247" class="pw-post-body-paragraph jo jp hu jq b jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ls kj kk kl hn dt translated">现在继续使用Python 3.6。当NumPy发布修补程序时，请升级到该版本。</p></div><div class="ab cl jh ji hc jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hn ho hp hq hr"><h1 id="ff9a" class="kq kr hu bd ks kt mg kv kw kx mh kz la lb mi ld le lf mj lh li lj mk ll lm ln dt translated">感谢阅读！</h1><p id="57ed" class="pw-post-body-paragraph jo jp hu jq b jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ls kj kk kl hn dt translated">我们是云计算公司，我们提供云计算托管的笔记本电脑。如果您想让Jupyter为您的团队服务，或者参加课程，请联系我们！</p></div><div class="ab cl jh ji hc jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hn ho hp hq hr"><p id="0d03" class="pw-post-body-paragraph jo jp hu jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated"><em class="ml">原载于</em><a class="ae jg" href="https://www.opensourceanswers.com/blog/you-shouldnt-use-python-37-for-data-science-right-now.html" rel="noopener ugc nofollow" target="_blank"><em class="ml">www.opensourceanswers.com</em></a><em class="ml">。</em></p></div></div>    
</body>
</html>