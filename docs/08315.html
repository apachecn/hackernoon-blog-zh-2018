<html>
<head>
<title>You Are Logging All Wrong</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你记错了</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/you-are-logging-all-wrong-341d4246a6dd?source=collection_archive---------17-----------------------#2018-10-03">https://medium.com/hackernoon/you-are-logging-all-wrong-341d4246a6dd?source=collection_archive---------17-----------------------#2018-10-03</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/24cc676d223fb136e06616c2a7a54fd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tFiA2gs8W89XfFIC"/></div></div></figure><p id="1976" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这篇文章基于几个月前我公司的一位首席工程师发给R&amp;D邮件列表的一封电子邮件。</p><p id="455f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">他在电子邮件中描述的场景是如此明显，然而我可以诚实地说——当我回头看提交时，我发现我自己也时不时地这样做。我非常喜欢它，所以我分享了它。</p><h2 id="8446" class="ka kb hu bd kc kd ke kf kg kh ki kj kk jn kl km kn jr ko kp kq jv kr ks kt ku dt translated">需要注意两件事</h2><ol class=""><li id="2d6a" class="kv kw hu je b jf kx jj ky jn kz jr la jv lb jz lc ld le lf dt translated">它在<a class="ae lg" href="https://hackernoon.com/tagged/java" rel="noopener ugc nofollow" target="_blank"> Java </a>中谈到了<a class="ae lg" href="https://hackernoon.com/tagged/logging" rel="noopener ugc nofollow" target="_blank">日志</a>，但是你会看到这个概念很容易被移植到其他语言中。</li><li id="66f4" class="kv kw hu je b jf lh jj li jn lj jr lk jv ll jz lc ld le lf dt translated">我们用自己编写的LogWrapper对象包装了log4j，在继续记录收到的消息之前，它会检查系统中的当前日志级别。因此，当你看到<em class="lm"> logger.debug </em>时，它是LogWrapper类型，当你看到<em class="lm"> m_logger </em>时，它是包装的logger。</li></ol></div><div class="ab cl ln lo hc lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="hn ho hp hq hr"><p id="e1a8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是以错误的方式记录消息的代码示例:</p><pre class="lu lv lw lx fq ly lz ma mb aw mc dt"><span id="4a51" class="ka kb hu lz b fv md me l mf mg">List&lt;Stuff&gt; veryLongList = …</span><span id="fa67" class="ka kb hu lz b fv mh me l mf mg">…</span><span id="cd86" class="ka kb hu lz b fv mh me l mf mg">// explicit invoke object's toString()<br/>logger.debug(“my long list is “ + veryLongList.toString());</span><span id="68ce" class="ka kb hu lz b fv mh me l mf mg">logger.debug(“my extra long list is %s”, veryLongList.toString());</span><span id="0688" class="ka kb hu lz b fv mh me l mf mg">// implicit invoke object's toString()<br/>logger.debug(“my long list is “ + veryLongList);</span></pre><p id="e3ee" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所有这三个版本都是低效且容易出错的，应该避免。</p><p id="83ea" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">原因是对<em class="lm"> toString()的调用。</em>它强制创建一个可能很昂贵的String对象，然后传递给LogWrapper.debug()方法。</p><p id="0489" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要理解这个问题，请看一下<em class="lm">调试</em>方法是如何实现的:</p><pre class="lu lv lw lx fq ly lz ma mb aw mc dt"><span id="5dae" class="ka kb hu lz b fv md me l mf mg">public void debug(Object message) {<br/>   if (ThreadedLogLevelManager.<em class="lm">isDebugEnabled</em>(m_logger)) {<br/>      m_logger.log(<em class="lm">s_className</em>, Level.<em class="lm">DEBUG</em>, message, null);<br/>   }<br/>}</span><span id="d378" class="ka kb hu lz b fv mh me l mf mg">public void debug(Object message, Object arg) {<br/>   if (ThreadedLogLevelManager.<em class="lm">isDebugEnabled</em>(m_logger)) {<br/>      m_logger.log(<em class="lm">s_className</em>, Level.<em class="lm">DEBUG</em>, message, arg);<br/>   }<br/>}</span><span id="fc65" class="ka kb hu lz b fv mh me l mf mg">...</span><span id="68f5" class="ka kb hu lz b fv mh me l mf mg">public void debug(Object message, Object... args) {<br/>   if (ThreadedLogLevelManager.<em class="lm">isDebugEnabled</em>(m_logger)) {<br/>      m_logger.log(<em class="lm">s_className</em>, Level.<em class="lm">DEBUG</em>, message, args);<br/>   }<br/>}</span></pre><p id="b1eb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以看到，我们首先检查并看到这段代码启用了调试模式，然后才调用执行日志记录的m_logger。</p><blockquote class="mi mj mk"><p id="823b" class="jc jd lm je b jf jg jh ji jj jk jl jm ml jo jp jq mm js jt ju mn jw jx jy jz hn dt translated">通常甚至不会调用m_logger，因为调试日志记录在生产中通常是禁用的。</p></blockquote><p id="3ef9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后，m_logger本身将消息转换成一个字符串。<br/>你可以在下面看到，它转换成字符串的方式也是我们作为开发人员有时会忘记做的一项重要检查:</p><pre class="lu lv lw lx fq ly lz ma mb aw mc dt"><span id="f52c" class="ka kb hu lz b fv md me l mf mg">protected final String convertToString(Object message) {<br/>    return message == null ? (String)message : message.toString();<br/>}</span></pre><p id="d881" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这可以防止出现NullPointerException。</p></div><div class="ab cl ln lo hc lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="hn ho hp hq hr"><h2 id="19b6" class="ka kb hu bd kc kd ke kf kg kh ki kj kk jn kl km kn jr ko kp kq jv kr ks kt ku dt translated">正确的方式</h2><p id="77c2" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn mo jp jq jr mp jt ju jv mq jx jy jz hn dt translated">记录日志的方法很简单:</p><pre class="lu lv lw lx fq ly lz ma mb aw mc dt"><span id="4b9a" class="ka kb hu lz b fv md me l mf mg">logger.debug(“my long list is %s”, veryLongList);</span></pre><p id="2f57" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这有3个好处:</p><ol class=""><li id="5209" class="kv kw hu je b jf jg jj jk jn mr jr ms jv mt jz lc ld le lf dt translated">仅当启用日志记录时，LogWrapper才会调用toString()。</li><li id="8231" class="kv kw hu je b jf lh jj li jn lj jr lk jv ll jz lc ld le lf dt translated">如果有问题的对象为空，它将被记录为“空”字符串，而不是引发异常。</li><li id="3bfe" class="kv kw hu je b jf lh jj li jn lj jr lk jv ll jz lc ld le lf dt translated">代码更简洁。</li></ol><p id="77e9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这听起来很明显，但是在代码中有大约100个这样的例子。</p></div><div class="ab cl ln lo hc lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="hn ho hp hq hr"><p id="71f9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">就个人而言，要注意你记录的内容。不要为了记录而记录。</p><p id="d593" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">温斯顿·丘吉尔总结得最准确:</p><blockquote class="mu"><p id="c279" class="mv mw hu bd mx my mz na nb nc nd jz ek translated">"这份报告，就其篇幅而言，可以保护自己免受被人阅读的风险。"</p></blockquote></div><div class="ab cl ln lo hc lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="hn ho hp hq hr"><p id="98a3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">附注:我的好朋友elad shmidov在给我的帖子留言时提到:</p><blockquote class="mi mj mk"><p id="481c" class="jc jd lm je b jf jg jh ji jj jk jl jm ml jo jp jq mm js jt ju mn jw jx jy jz hn dt translated">Python在优化部分的日志<a class="ae lg" href="https://docs.python.org/2/howto/logging.html" rel="noopener ugc nofollow" target="_blank">最佳实践</a>中也有类似的内容</p></blockquote><figure class="lu lv lw lx fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ng"><img src="../Images/86fc4768dd620dfb8903d426a6ec2d64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JRTnL1a3oQfdas44DSZdXg.png"/></div></div></figure></div><div class="ab cl ln lo hc lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="hn ho hp hq hr"><p id="1720" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">另一个好朋友/编辑/评论家<a class="ne nf gr" href="https://medium.com/u/c8259072fdfa?source=post_page-----341d4246a6dd--------------------------------" rel="noopener" target="_blank"> Guy Cepelevich </a>分享了他们在Ruby中是如何做的:</p><pre class="lu lv lw lx fq ly lz ma mb aw mc dt"><span id="790a" class="ka kb hu lz b fv md me l mf mg">// define the log method<br/>def log<br/>    logger.debug yield if Environment.type == DEVELOPMENT<br/>end</span><span id="a56a" class="ka kb hu lz b fv mh me l mf mg">// use it<br/>log {"this is what i want to log: " + String(element_list)}</span></pre><p id="58f0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">只有当Environment.type == DEVELOPMENT时，才会计算花括号中的内容</p><figure class="lu lv lw lx fq iv"><div class="bz el l di"><div class="nh ni l"/></div></figure></div></div>    
</body>
</html>