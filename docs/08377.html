<html>
<head>
<title>Postcards from Lambda @ the Edge.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Lambda @ the Edge的明信片。</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/postcards-from-lambda-the-edge-11a43f215dc1?source=collection_archive---------5-----------------------#2018-10-07">https://medium.com/hackernoon/postcards-from-lambda-the-edge-11a43f215dc1?source=collection_archive---------5-----------------------#2018-10-07</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="067f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">亲爱的读者们，我终于到达了云锋的边缘，那里的空气就像文档中描述的那样稀薄。但是你可以在这里做一些令人惊奇的事情。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/76aae3b10c31b631b9d45dfb2afdeab4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Msp9be_SVLRClpO8oBQgg.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">At The Edge of CloudFront, a lone developer looks for the help file.</figcaption></figure><p id="5842" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">几年前，我第一次在re:Invent上看到Lambda@Edge，当时我不确定它是怎么回事。演示展示了如何在飞行中操纵http头，但观众在午餐后陷入了一场充满“那又怎样？”的甜蜜危机。这不是演示者的错——一些更高层次的概念没有得到大众的认可。我是说，谁需要干涉CDN，对吧？</p><p id="37e9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最近，我们启动了一个CloudFront-heavy项目，对网页进行各种优化。这时我想起了Lambda@Edge演示，一些灯泡开始闪烁。为了测试这一点，我们很快将一些代码移到边缘的函数中，并看到了一些<em class="jp">般的</em>性能提升。虽然我们写的代码没有什么特别令人惊奇的地方，但是让它工作起来却是一个前所未有的考验。让我们在拿到金牌之前先解决这些问题。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff kg"><img src="../Images/6813613ab45f39ee2a4dd2753b2fe9ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/format:webp/0*rOguNDgFtmxP02E-.jpg"/></div></figure><h1 id="9164" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">文献是一个罕见的发现。</h1><p id="218a" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">追踪一些AWS服务的例子就像是技术上的观鸟。尽管我很喜欢AWS，但我们都知道它们倾向于<em class="jp">咳咳</em>，稍微解释一下事情是如何运作的。L@E将这一点提升到了一个全新的水平，就像在云中找到复活节彩蛋一样。</p><p id="5889" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">说真的，我只在边上找到了十几个有用的网页，感谢那些人在我到达之前解决了混乱的局面。有必要的Slideshare封面<a class="ae lk" href="https://www.slideshare.net/AmazonWebServices/building-serverless-websites-with-lambdaedge-aws-online-tech-talks" rel="noopener ugc nofollow" target="_blank">用例</a>，一些<a class="ae lk" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-examples.html" rel="noopener ugc nofollow" target="_blank">非常基础的例子</a>，一个<a class="ae lk" href="https://github.com/aws-samples/aws-lambda-edge-workshops" rel="noopener ugc nofollow" target="_blank">神秘的工作室</a>，和一个<a class="ae lk" href="https://aws.amazon.com/blogs/networking-and-content-delivery/resizing-images-with-amazon-cloudfront-lambdaedge-aws-cdn-blog/" rel="noopener ugc nofollow" target="_blank">有前途的教程</a>，当它使用Sharp inside Docker而不是原生的ImageMagick(复杂性，人！).写得这么少真的很奇怪。</p><p id="ba0e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">也有一些旧的代码流传。快速PSA——在L@E处于技术预览版时有一些很好的例子，它们要么现在不工作，要么早期的发现者在前沿发现了一些错误，这些错误已经被修复。如果这些能更新就太好了，但是无论如何，我们在一些虚幻的问题上浪费了时间。</p><p id="4b53" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我发现重温一下CloudFront实际上如何与大量的官方文档一起工作是很有用的——白名单标题、它如何决定何时缓存什么，以及如果只是将它作为一个普通的CDN来处理，通常可以避免的所有细节。在深入了解Lambda是如何参与进来的之前，这是一个相当有启发性的好地方，并且至少在所有事情都令人着迷的时候给你一些线索。</p><h1 id="de20" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">生活在边缘。</h1><p id="01e2" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">本质上，您可以将您的功能附加到基本CloudFront生命周期中的四个事件上。CloudFront存在于查看者(用户)和源(包含内容的实际服务器)之间:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff ll"><img src="../Images/5c559daa0234691882724a2ba4b9be5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/0*_sRov-qJ7Vrbot-_.png"/></div></figure><ul class=""><li id="aa56" class="lm ln hu it b iu iv iy iz jc lo jg lp jk lq jo lr ls lt lu dt translated">查看器请求:当用户发出请求时，就会出现这种情况。CloudFront还没有检查内容是否被缓存，但是在这里您可以对传入的请求进行修改。</li><li id="a4b2" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo lr ls lt lu dt translated">Origin request:这个<em class="jp"> only </em>发生在缓存未命中时(即CloudFront没有内容)。它发生在提取之前，但如果存在缓存命中，则根本不会发生。</li><li id="d4cc" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo lr ls lt lu dt translated">Origin response:这是在Origin提供内容后触发的。</li><li id="2963" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo lr ls lt lu dt translated">查看者响应:最后，这发生在响应被转发之前。</li></ul><p id="0823" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在确定将代码挂接到哪些事件时，有一些微妙之处。眼尖的读者会立即发现您希望尽可能避免查看者请求事件，因为它每次都会运行，并且会增加延迟和每月账单的费用。</p><p id="5c8a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我对Lambda的通常做法是找到一个模拟事件和尽可能短的测试代码，看看什么有效。我想运行四个函数(每个CloudFront事件一个),将一些东西写到日志中，这样我就可以对它的成功运行感到兴奋。这花了一整天的时间。</p><p id="a5cb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，我找不到任何模拟事件。这实际上是一个问题，因为您的函数必须返回一个响应，而这个响应总是传入事件的修改形式。CloudFront会给你一个很长的JSON，你的代码在返回之前会对它进行调整。所以我想出了这个简单的主意:</p><pre class="jr js jt ju fq ma mb mc md aw me dt"><span id="a590" class="mf ki hu mb b fv mg mh l mi mj">'use strict';</span><span id="606f" class="mf ki hu mb b fv mk mh l mi mj">exports.handler = (event, context, callback) =&gt; {<br/>    console.log('Welcome from the Edge!');<br/>    const response = event.Records[0].cf.response;<br/>    console.log(JSON.stringify(response));<br/>    callback(null, response);<br/>};</span></pre><p id="55b9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们编写任何真正的代码之前，这是一种廉价而愉快的方式来记录那些到来的事件。几乎成功了。</p><h1 id="08f9" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">兰姆达斯的沉默。</h1><p id="9383" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">老练的云本地人熟悉管理区域的乐趣，但在Edge过程中有一个扭结，这让我困惑了几次。当您的代码在边缘运行时，日志记录发生在该边缘服务器的CloudWatch区域。日志可能不在您认为的位置。</p><p id="2e18" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一个典型的例子是——我住在新罕布什尔州(与技术人员交谈时也称为大波士顿地区)。我通常使用us-east-1，并总是假设它是离我最近的地区，所以在测试一些功能时，想象一下当CloudWatch日志在弗吉尼亚州为空时我有多惊讶。我调试了我的IAM权限，我的函数代码，用尽了我知道的大部分咒骂语，才意识到一些事情——我最近的地区是俄亥俄州。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff ml"><img src="../Images/54651b21b61b58ee93e7913a24277fb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gH7b7PHnCvFHhcYSonOyLw.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">Out in New Hampshire, we’re north of The Wall.</figcaption></figure><p id="7a60" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然，这要么是我低于标准的地理或CloudFront测量电缆距离，而不是实际距离。我花了几个小时进入了一个AWS区域，这个区域我从来没有在控制台上打开过。在一个没有服务运行的区域生成日志似乎有点奇怪，但现在我知道了。自然，没有任何迹象表明这正在发生。</p><p id="5603" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我后来测试了我手机上的一个网页，这个网页和我的笔记本电脑连接在同一个无线网络上。伐木又停止了。挖了一圈后，我的电话测试又回到了us-east-1，原因我完全不明白。然后，就在我习惯在俄亥俄州和弗吉尼亚州之间切换时，日志完全消失了。我的函数正在运行，只是没有记录日志，我正要重新考虑Azure时，我注意到了一些事情…</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mm"><img src="../Images/62358152be655d958ecb84b983d2e24a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-xL7c0RiLgWepILvl0i5jg.png"/></div></div></figure><p id="7f2d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">日志流名称的变化取决于该函数是在您的控制台中运行还是在CloudFront中运行，所以我搜索了错误的日志流名称。你知道你的日志流名称在Lambda中可以改变吗？由于您只能通过前缀而不是“contains”进行搜索，所以我花了很长时间来查找第二个日志组。</p><p id="a336" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好消息是，许多其他人完全被这个栈溢出弄糊涂了，不仅仅是我。一名开发人员报告说，尽管日志的分布仅限于美国/北美地区，但它却出现在世界各地。去想想。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff mn"><img src="../Images/13854694d16dada5572fdf4377012868.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/0*2tGks3skmHoj3324"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">Day 1 of writing functions for Lambda@Edge.</figcaption></figure><p id="c698" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">教训</strong>:如果你找不到你的日志，也没有502/503错误，那么Edge几乎肯定是在另一个区域登录。它肯定在某处记录。</p><h1 id="cd7e" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">工作流程很笨拙。</h1><p id="aeea" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">部署您的功能是一个容易出错、混乱的过程。如果你使用GUI，你必须记住函数版本是边缘的一等公民。我们遇到的许多错误都是由于在给定的发行版上运行了错误的版本，因为你不能将一个发行版链接到function的最新版本。</p><p id="e915" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当您有几个运行少量功能的CloudFront发行版时，这看起来并不太糟糕。当你试图将CloudFormation编写成脚本来完成所有这些工作，然后你想推出新版本的功能时，这就成了一项真正的任务。</p><p id="3309" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">再一次，我们在<a class="ae lk" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>的好朋友已经在我们之前解决了这个问题，并且用L@E插件平滑了一些粗糙的边缘。如果你是一个无服务器用户，这将使你的生活看起来更像一个开发人员，它有助于编排这个版本问题。只要确保你没有在YAML删除旧版本(是的，那很有趣)，不要期望它是完全完美的。</p><p id="8629" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一般来说，我们发现管理Edge代码有点困难，尤其是如果多个开发人员在同一个空间。当结合CloudFront的20分钟部署时间(是的，这也影响了您的Lambdas)时，不知道谁在做什么以及哪个代码在运行会有点奇怪。</p><p id="0d92" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们还发现，将Lambda更新部署到产品发行版是一件绝对可怕的二进制事情，成功率或失败率都是100%。向us-east-1推出您的新版本总是在全球范围内复制，回滚可能需要一段时间。如果您有客户在您的Edge代码上运行，那么部署更新的唯一明智的方法似乎是创建新的CloudFront发行版，并跨其迁移用户。如果客户的DNS指向你的CloudFront发行版，这就不那么容易了。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff mo"><img src="../Images/b4c45a963c3a53e26532bbfb3eff8890.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*Ti0ciH-YxNy9CXMO.jpg"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">It has a happy ending, don’t worry.</figcaption></figure><h1 id="41a8" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">但是等等…还有更多！</h1><p id="909a" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">在边缘不是规则的λ。首先，AWS的简介中充斥着许多限制。每个AWS帐户只能创建25个Lambda@Edge函数，每个发行版只能创建25个触发器，并且不能通过在其他帐户中将Lambdas与CloudFront关联来作弊。25个发行版的硬性限制是任何大规模SaaS式实现的最佳选择。</p><p id="73ba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您的所有功能必须驻留在us-east-1中，并且您的IAM权限必须具有正确的信任权限，以允许复制。你只有30秒的时间来完成任务(5分钟是给热爱土地的兰姆达斯的，而不是在边缘)，而且你不能使用VPCs。您的响应被限制在1 MB以内(这对任何梦想即时处理图像的人来说都是个坏消息),并且您的功能包不能超过1MB。唷，是这样吗？一点也不！</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff mp"><img src="../Images/bbb87b2baf442689bd87f83ceea37418.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/0*Mx2ihVHLrFrMt1P7.jpg"/></div></figure><h1 id="07f4" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">从边缘看到的景色令人惊叹。</h1><p id="03eb" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">我已经不是第一次经历AWS产品的怪癖和烦恼，并发现挑战已经有了回报。边缘是与常规Lambda不同的地方，也是与EC2完全不同的地方，与内部部署非常不同。基本上，我们在月球上。</p><p id="82df" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">CloudFront是一个非常巧妙的工程，你现在可以使用它了。面临的挑战是做得很少，速度极快，以避免增加延迟。当我们意识到延迟限制以及CloudFront在您的代码完成之前不会向用户返回任何内容的事实时，我们最初想在边缘将一切都塞进Lambda函数的梦想很快就破灭了。这种阻塞行为必须从一开始就影响你的设计。</p><p id="b102" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最初，我认为我可以检查DynamoDB，在S3保存一些文件，并在对CloudFront的一次调用中重新处理HTML。在实践中，我们发现了一种更好的方法——确定哪些事情可以异步完成，并让CloudFront向SQS发送消息以分离流程。这使我们能够对Edge功能进行最小的更改，保持较低的延迟，但以我们以前想象不到的各种创新和聪明的方式使用这个“钩子”。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff mo"><img src="../Images/7980f98a3881ba68843ee52086062f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*3nGA-k3EaPtIDJ7-.jpg"/></div></figure><p id="2d6f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你运行任何类型的静态站点——比如平面HTML或者SPAs，那么这个优势就是你的了。htaccess文件。在一个简单的Lambda函数中进行URL重写、重定向或自定义处理非常容易。它是高度可扩展的，无服务器的，便宜的——我提到过它的性能是<em class="jp">级的</em>吗？</p><p id="0353" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您想在静态站点中添加个性化，处理表单或用户帖子，或者在返回到应用程序之前预处理其他数据，那么Edge是理想之选。你也可以在这里用JWTs<a class="ae lk" href="https://aws.amazon.com/blogs/networking-and-content-delivery/authorizationedge-how-to-use-lambdaedge-and-json-web-tokens-to-enhance-web-application-security/" rel="noopener ugc nofollow" target="_blank">管理auth </a>，运行简单的<a class="ae lk" rel="noopener" href="/buildit/a-b-testing-on-aws-cloudfront-with-lambda-edge-a22dd82e9d12"> A/B测试</a>，并使用WAF<a class="ae lk" href="https://engineering.contaazul.com/instant-block-of-attacks-to-aws-websites-using-cloudfront-lambda-edge-dynamodb-waf-a94281cb5bde" rel="noopener ugc nofollow" target="_blank">即时阻挡攻击</a>。虽然我们还处于edge使用的早期，但看起来除了Edge功能向外扩展之外，没有任何重大的冷启动问题。</p><p id="b77d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">奇怪的是，总是与Lambda相提并论的一个陈词滥调的用例——即图像优化——看起来像一个反模式，可能不是一个好主意。从S3抓取图像并动态调整大小或优化可能会遇到前面提到的限制，并且通常会提供缓慢的用户体验。使用普通的Ol' Lambda也有更好的方法。</p><p id="a71b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我在Lambda@Edge上的冒险真的很有趣，尽管在最初的几天里有一些令人难以置信的恼人的时间。这是我的云工具箱中的一个有用的新工具，我不会在每个应用程序中使用它，但当它真正需要时，它没有替代物。正如Lambda改变了我看待拼凑解决方案的方式一样，我现在发现边缘正在悄悄进入我的设计，我很兴奋地发现接下来我可以用它做什么。</p></div></div>    
</body>
</html>