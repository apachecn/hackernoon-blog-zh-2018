<html>
<head>
<title>Lazy Image Optimiser Using AWS S3 and NodeJs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS S3和NodeJs的懒惰图像优化器</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/lazy-image-optimiser-using-aws-s3-and-nodejs-80fb38338987?source=collection_archive---------8-----------------------#2018-10-09">https://medium.com/hackernoon/lazy-image-optimiser-using-aws-s3-and-nodejs-80fb38338987?source=collection_archive---------8-----------------------#2018-10-09</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="48c8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面我将向你展示我们如何简单地优化和编辑我们的媒体库中的图像，从而大大减少我们网站加载所需的时间。我们的图像优化版本只会在用户第一次请求时创建。</p></div><div class="ab cl jp jq hc jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hn ho hp hq hr"><h1 id="ae2b" class="jw jx hu bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">情况</h1><p id="d761" class="pw-post-body-paragraph ir is hu it b iu ku iw ix iy kv ja jb jc kw je jf jg kx ji jj jk ky jm jn jo hn dt translated">想象一下，在我们的媒体库中有一张图片。</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="1b30" class="li jx hu le b fv lj lk l ll lm">name: grumpy_cat.jpg<br/>url: media.YOUR__WEBSITE.com/grumpy_cat.jpg<br/>width: 2500px<br/>size: 2mb</span></pre><p id="488f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们希望在以下地方使用我们的照片:</p><ul class=""><li id="9e88" class="ln lo hu it b iu iv iy iz jc lp jg lq jk lr jo ls lt lu lv dt translated"><em class="lw">作为博客列表项(推荐图片宽度150px) </em></li><li id="f88d" class="ln lo hu it b iu lx iy ly jc lz jg ma jk mb jo ls lt lu lv dt translated"><em class="lw">作为博文页面的特色图片(推荐图片宽度760px) </em></li><li id="0303" class="ln lo hu it b iu lx iy ly jc lz jg ma jk mb jo ls lt lu lv dt translated"><em class="lw">作为移动版博文页面的一部分(推荐图片宽度200px) </em></li></ul><p id="45af" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面我将描述处理这项任务的两种最常见的方法:</p><p id="baa2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">CSS方式</strong></p><ul class=""><li id="71be" class="ln lo hu it b iu iv iy iz jc lp jg lq jk lr jo ls lt lu lv dt translated">我们可以使用css很容易地实现图像修改，但它不能解决加载时间的问题，因为即使我们的图像显示很小，但文件仍然是相同的大小。</li></ul><p id="87c7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">硬编码方式</strong></p><ul class=""><li id="7696" class="ln lo hu it b iu iv iy iz jc lp jg lq jk lr jo ls lt lu lv dt translated">我们为什么不创建三个不同大小的图像并上传到媒体库？这个解决方案更好，但是想想当我们不是一个帖子而是几千个帖子的时候会发生什么？</li></ul><p id="5603" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">解决方案—让它更简单</strong></p><ul class=""><li id="8d08" class="ln lo hu it b iu iv iy iz jc lp jg lq jk lr jo ls lt lu lv dt translated">我们可以在图像修改过程中实现css功能(裁剪、覆盖等)。)，我们可以创建更小、更优化的图片，并以我们希望的实际宽度显示。(在我们的例子中，三个新图像:150像素、760像素、200像素)</li><li id="b463" class="ln lo hu it b iu lx iy ly jc lz jg ma jk mb jo ls lt lu lv dt translated">我们可以自动将图像上传到媒体库</li><li id="c970" class="ln lo hu it b iu lx iy ly jc lz jg ma jk mb jo ls lt lu lv dt translated">只有在用户第一次请求时，才会创建图像的优化版本</li></ul><p id="ae11" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">听起来不错吧？</p><h1 id="0cf2" class="jw jx hu bd jy jz mc kb kc kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt dt translated">定义</h1><p id="c79b" class="pw-post-body-paragraph ir is hu it b iu ku iw ix iy kv ja jb jc kw je jf jg kx ji jj jk ky jm jn jo hn dt translated"><strong class="it hv">存储服务器</strong></p><ul class=""><li id="42f0" class="ln lo hu it b iu iv iy iz jc lp jg lq jk lr jo ls lt lu lv dt translated">我们的媒体库，在这里我们可以处理我们的图像(在我们的例子中，它是一个<a class="ae mh" href="https://hackernoon.com/tagged/aws" rel="noopener ugc nofollow" target="_blank"> AWS </a> S3桶)</li><li id="237e" class="ln lo hu it b iu lx iy ly jc lz jg ma jk mb jo ls lt lu lv dt translated">在本教程中，我们使用以下url作为媒体库域:media。您的__WEBSITE.com</li></ul><p id="c0ea" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">图像处理器服务</strong></p><ul class=""><li id="39ae" class="ln lo hu it b iu iv iy iz jc lp jg lq jk lr jo ls lt lu lv dt translated">我们的API的端点，在我们的例子中，它执行所有的资源密集型文件操作</li><li id="aac5" class="ln lo hu it b iu lx iy ly jc lz jg ma jk mb jo ls lt lu lv dt translated">API url是API。您的__WEBSITE.com</li></ul><p id="edb7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">客户端</strong></p><ul class=""><li id="ecf0" class="ln lo hu it b iu iv iy iz jc lp jg lq jk lr jo ls lt lu lv dt translated">向我们的媒体库发送请求的用户</li></ul><p id="3410" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">任务</strong></p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="4a62" class="li jx hu le b fv lj lk l ll lm">--key-value</span></pre><p id="1350" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">原始图像路径和文件扩展名之间的键值模式</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="e3d3" class="li jx hu le b fv lj lk l ll lm">media.YOUR__WEBSITE.com/grumpy_cat--width-100.jpg</span></pre></div><div class="ab cl jp jq hc jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hn ho hp hq hr"><p id="6aac" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本教程中，我们使用AWS S3作为存储服务器，使用NodeJs express应用程序作为图像处理器服务。这些都可以根据你的个人喜好来替换。你可以使用你的本地文件服务器或者其他文件存储提供商(Azure，Google Cloud等。)而不是S3。您还可以用用不同编程语言编写的图像处理器替换NodeJs，或者您可以使用无服务器的函数提供者，例如AWS LAMBDA。</p><h1 id="25f2" class="jw jx hu bd jy jz mc kb kc kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt dt translated"><strong class="ak">流程</strong></h1><figure class="kz la lb lc fq mj fe ff paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="fe ff mi"><img src="../Images/4872b841ee6f57c935a0e0d87fa444c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DVpzIjFhMmUYq5tQlQMUvQ.jpeg"/></div></div></figure><h1 id="5d2f" class="jw jx hu bd jy jz mc kb kc kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt dt translated">第一部分—设置AWS S3存储桶</h1><p id="b494" class="pw-post-body-paragraph ir is hu it b iu ku iw ix iy kv ja jb jc kw je jf jg kx ji jj jk ky jm jn jo hn dt translated">我们要做的第一件事是设置并配置我们的存储桶。</p><ul class=""><li id="3fa4" class="ln lo hu it b iu iv iy iz jc lp jg lq jk lr jo ls lt lu lv dt translated">将所有404请求重定向到我们的图像处理器服务</li><li id="4f74" class="ln lo hu it b iu lx iy ly jc lz jg ma jk mb jo ls lt lu lv dt translated">使用AWS SDK添加上传和获取对象的权限</li></ul><p id="259b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="lw"> 1。在AWS上注册并创建一个新的bucket </em> </strong></p><p id="0708" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本教程中，我不会给你所有的细节，如果你需要更多的信息，我推荐以下文章</p><p id="3654" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae mh" href="https://docs.aws.amazon.com/quickstarts/latest/s3backup/step-1-create-bucket.html" rel="noopener ugc nofollow" target="_blank"><em class="lw">https://docs . AWS . Amazon . com/quick starts/latest/S3 backup/step-1-create-bucket . html</em></a></p><p id="c864" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="lw"> 2。选择您的存储桶</em> </strong></p><figure class="kz la lb lc fq mj fe ff paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="fe ff mq"><img src="../Images/a82aeb9a181024fbf79a434d36f2758c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pHKx-5o8CP90HhOg"/></div></div></figure><p id="d943" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="lw"> 3。配置桶权限和CORS参数</em>和</strong></p><figure class="kz la lb lc fq mj fe ff paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="fe ff mr"><img src="../Images/64bd751a780244df9bbb515efd0ca473.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*boGzg7uTNx7XTnNEY-gR_Q.png"/></div></div></figure><p id="9b9c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了能够使用AWS SDK从我们的图像处理器服务上传优化的图像，存储桶权限和CORS设置非常有用。</p><p id="76c6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">I .创建GetObject桶策略权限(公开s3桶)</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="6fd5" class="li jx hu le b fv lj lk l ll lm"><br/> “Version”: “2012–10–17”,<br/> “Statement”: [<br/>   {<br/>     “Effect”: “Allow”,<br/>     “Principal”: “*”,<br/>     “Action”: “s3:GetObject”,<br/>     “Resource”: “arn:aws:s3:::YOUR__BUCKET__NAME/*”<br/>   }<br/> ]<br/>}</span></pre><p id="4733" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您需要有关存储桶策略的更多信息:</p><p id="3d28" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae mh" href="https://aws.amazon.com/blogs/security/writing-iam-policies-how-to-grant-access-to-an-amazon-s3-bucket/" rel="noopener ugc nofollow" target="_blank"><em class="lw">https://AWS . Amazon . com/blogs/security/writing-iam-policies-how-to-grant-access-an-Amazon-S3-bucket/</em></a></p><p id="ff1c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">二。配置CORS</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="38cf" class="li jx hu le b fv lj lk l ll lm">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;CORSConfiguration &gt;<br/>&lt;CORSRule&gt;<br/>    &lt;AllowedOrigin&gt;*&lt;/AllowedOrigin&gt;<br/>    &lt;AllowedMethod&gt;GET&lt;/AllowedMethod&gt;<br/>    &lt;MaxAgeSeconds&gt;3000&lt;/MaxAgeSeconds&gt;<br/>    &lt;AllowedHeader&gt;Authorization&lt;/AllowedHeader&gt;<br/>&lt;/CORSRule&gt;<br/>&lt;CORSRule&gt;<br/>    &lt;AllowedOrigin&gt;https://api.YOUR__WEBSITE.com&lt;/AllowedOrigin&gt;<br/>    &lt;AllowedMethod&gt;PUT&lt;/AllowedMethod&gt;<br/>    &lt;MaxAgeSeconds&gt;3000&lt;/MaxAgeSeconds&gt;<br/>    &lt;AllowedHeader&gt;*&lt;/AllowedHeader&gt;<br/>&lt;/CORSRule&gt;<br/>&lt;/CORSConfiguration&gt;</span></pre><p id="359b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此设置使图像处理器服务能够使用AWS SDK在我们的存储服务器中进行修改，并将我们的媒体库设置为公共。</p><p id="3078" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="lw"> 4。启用并配置静态网站托管模式</em> </strong></p><p id="8396" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了处理对我们的图像处理器服务的404请求，必须将我们的桶设置为网站托管模式。</p><figure class="kz la lb lc fq mj fe ff paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="fe ff mq"><img src="../Images/2a870f616a8ea8a5041bc1b7cfa75fa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*un1oqrCNLXBC5IXa"/></div></div></figure><figure class="kz la lb lc fq mj fe ff paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="fe ff ms"><img src="../Images/ce52514fcaf729565e7c4ed0fc24651d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*99gMgRd2Zu-qOztlyEBtAQ.png"/></div></div></figure><p id="5a88" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="lw">重定向规则:</em></p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="6b6c" class="li jx hu le b fv lj lk l ll lm">&lt;RoutingRules&gt;<br/>  &lt;RoutingRule&gt;<br/>    &lt;Condition&gt;<br/>      &lt;HttpErrorCodeReturnedEquals&gt;<br/>        404<br/>      &lt;/HttpErrorCodeReturnedEquals&gt;<br/>    &lt;/Condition&gt;<br/>    &lt;Redirect&gt;<br/>      &lt;Protocol&gt;<br/>        https<br/>      &lt;/Protocol&gt;<br/>      &lt;HostName&gt;<br/>        api.YOUR__WEBSITE.com<br/>      &lt;/HostName&gt;<br/>      &lt;ReplaceKeyPrefixWith&gt;<br/>        media/optimiser?url=<br/>      &lt;/ReplaceKeyPrefixWith&gt;<br/>      &lt;HttpRedirectCode&gt;<br/>        302<br/>      &lt;/HttpRedirectCode&gt;<br/>    &lt;/Redirect&gt;<br/>  &lt;/RoutingRule&gt;<br/>&lt;/RoutingRules&gt;</span></pre><p id="0744" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="lw"> 5。如何在网站托管模式下使用您的S3</em></strong></p><p id="ce9c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当您的bucket在网站托管模式下运行时，您需要使用不同的端点url。</p><p id="c659" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">AWS S3有两种不同的用法:</p><ol class=""><li id="1f46" class="ln lo hu it b iu iv iy iz jc lp jg lq jk lr jo mt lt lu lv dt translated">将其作为API使用(https和. s3.) <br/> <em class="lw"> https://s3。REGION.amazonaws.com/YOUR_BUCET_NAME/grumpy_cat.jpg<br/>https://YOUR _ BUCET _ name . S3 . region . Amazon AWS . com/grumpy _ cat . jpg</em></li><li id="f64f" class="ln lo hu it b iu lx iy ly jc lz jg ma jk mb jo mt lt lu lv dt translated">用它做网站(http和. S3-网站。)<br/><em class="lw">http://YOUR _ BUCET _ name . S3-网址。REGION.amazonaws.com/grumpy_cat.jpg</em></li></ol><p id="de5d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本教程中，我们需要在网站模式下使用我们的Bucket，否则重定向将不起作用。</p><p id="0f57" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"><em class="lw">⑥。使用我们的桶在网站托管模式与https协议(可选)</em> </strong></p><p id="d2ff" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">遗憾的是，网站模式下的S3不支持HTTPS协议。如果您在您的网站中使用https协议，您需要使用代理服务器来访问您的bucket url。(AWS cloudfront、nginx、express-proxy等…)</p><p id="5f26" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Nginx示例:</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="3a41" class="li jx hu le b fv lj lk l ll lm">server_name www.media.YOUR__WEBSITE.com media.YOUR__WEBSITE.com;<br/>        return 301 https://$host$request_uri;<br/>}<br/><br/>server {<br/>        listen 443 ssl;<br/>        listen [::]:443 ssl;<br/><br/>        ssl_certificate CERTIFICATE__PATH;<br/>        ssl_certificate_key CERTIFICATE__PATH;<br/><br/>        server_name www.media.YOUR__WEBSITE.com media.YOUR__WEBSITE.com;<br/><br/>        location / {<br/>                proxy_pass <a class="ae mh" href="https://s3.eu-central-1.amazonaws.com/unleash-image-resizer-test/grumpy_cat.jpg" rel="noopener ugc nofollow" target="_blank">http://YOUR_BUCET_NAME.s3-website.REGIO.amazonaws.com<br/></a>        }<br/>}</span></pre><p id="d7b2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您现在可以将您的存储桶与您的<a class="ae mh" href="https://media.your__website.com" rel="noopener ugc nofollow" target="_blank"> https://media一起使用。您的__WEBSITE.com </a>地址</p><p id="5e83" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">7<em class="lw">。测试我们的s3设置<br/> </em> </strong>现在，当有人导航到我们的S3存储桶url并且媒体资产不存在时，我们的存储桶将自动导航到重定向url。(api。你的__WEBSITE.com/media/optimiser？url=)</p><p id="5a39" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请查看(上面的)过程，以了解它是如何工作的。</p><p id="7d91" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然，在这个阶段，您会收到一条错误消息，因为我们的图像处理器服务尚未完成。</p><p id="d541" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">示例:</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="e30d" class="li jx hu le b fv lj lk l ll lm">fetched image url:<br/>http://YOUR_BUCET_NAME.s3-website.REGIO.amazonaws.com/grumpy_cat--width-100.jpg</span><span id="c1a3" class="li jx hu le b fv mu lk l ll lm">or</span><span id="2456" class="li jx hu le b fv mu lk l ll lm">fetched image url with using https protocol and proxy server: https://media.YOUR__WEBSITE.com/grumpy_cat--width-100.jpg</span><span id="ffe8" class="li jx hu le b fv mu lk l ll lm">---------</span><span id="cec1" class="li jx hu le b fv mu lk l ll lm">redirect endpoint = https://api.YOUR__WEBSITE.com/media/optimiser?url=grumpy_cat--width-100.jpg</span></pre><p id="6739" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们可以开始编写我们的图像处理器服务了<br/>第一部分结束…</p><h1 id="1959" class="jw jx hu bd jy jz mc kb kc kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt dt translated">第二部分——用Express和Sharp在NodeJs中编写图像处理器服务</h1><p id="b8e5" class="pw-post-body-paragraph ir is hu it b iu ku iw ix iy kv ja jb jc kw je jf jg kx ji jj jk ky jm jn jo hn dt translated">定义:</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="2d41" class="li jx hu le b fv lj lk l ll lm">url:<br/>ORIGINAL_IMAGE--key-Value--key-value.FILE_EXTENSION</span><span id="cccd" class="li jx hu le b fv mu lk l ll lm">original url:<br/>ORIGINAL_IMAGE.FILE_EXTENSION</span><span id="f6bd" class="li jx hu le b fv mu lk l ll lm">bucketUrl:<br/>media.YOUR__WEBSITE.com or<br/>YOUR_BUCET_NAME.s3-website.REGION.amazonaws.com</span></pre><p id="1103" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="lw"> 1。安装并配置Express </em> </strong></p><p id="047f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本教程中，我们将使用带有ES6导入语法的<a class="ae mh" href="http://expressjs.com/en/starter/hello-world.html" rel="noopener ugc nofollow" target="_blank">http://expressjs.com/en/starter/hello-world.html</a>启动器示例</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="59aa" class="li jx hu le b fv lj lk l ll lm">import express from 'express'</span><span id="e5d3" class="li jx hu le b fv mu lk l ll lm">const app = express()<br/>const port = 3000</span><span id="1165" class="li jx hu le b fv mu lk l ll lm">app.get('/', (req, res) =&gt; res.send('Hello World!'))</span><span id="f23d" class="li jx hu le b fv mu lk l ll lm">app.listen(port, () =&gt; console.log(`Example app listening on port ${port}!`))</span></pre><p id="4064" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">②<em class="lw">。</em>创建功能(简体)</strong></p><p id="5ab6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">警告！这个代码片段不是一个生产就绪的脚本，如果你想使用它，你需要用验证器、错误处理程序、更多的任务等来扩展它…</p><p id="30c9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="lw"> index.js </em></p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="4569" class="li jx hu le b fv lj lk l ll lm">import Boom from 'boom' // Super useful error handler library<br/>import { putObject, getObject } from './aws.helper'<br/>import { sharpImageConverter } from './sharp.helper'</span><span id="d83d" class="li jx hu le b fv mu lk l ll lm">const bucketUrl = process.env.bucketUrl</span><span id="f98e" class="li jx hu le b fv mu lk l ll lm">app.get('/media/optimise', async (req, res) =&gt; {<br/>  try {<br/>    const { query } = req<br/>    const { url } = query<br/>    const acceptedFileExtensions = /\.(jpg|jpeg|png)$/i<br/>    const acceptedTasks = ['width']</span><span id="e003" class="li jx hu le b fv mu lk l ll lm">    // check the original request url<br/>    if (!url) throw Boom.notFound()</span><span id="de58" class="li jx hu le b fv mu lk l ll lm">    // check the file extension<br/>    if (!acceptedFileExtensions.test(url)) throw Boom.notFound()</span><span id="c275" class="li jx hu le b fv mu lk l ll lm">    // check the tasks<br/>    const [rawFilename, fileExtension] = url.split('.')<br/>    const splittedFilenameByTasks = rawFilename.split('--')</span><span id="ef1d" class="li jx hu le b fv mu lk l ll lm">    // if we don't have tasks<br/>    if (splittedFilenameByTasks.length === 1) throw Boom.notFound()</span><span id="18f1" class="li jx hu le b fv mu lk l ll lm">    // checking tasks<br/>    const tasks = {}<br/>    splittedFilenameByTasks.splice(1)<br/>      .forEach((task) =&gt; {<br/>        const [key, value] = task.split('-')</span><span id="9589" class="li jx hu le b fv mu lk l ll lm">        // if we have unknown tasks<br/>        if (!acceptedTasks.includes(key)) throw Boom.notFound();</span><span id="fdc8" class="li jx hu le b fv mu lk l ll lm">        tasks[key] = value<br/>        return<br/>      });</span><span id="fe25" class="li jx hu le b fv mu lk l ll lm">    // download the original image<br/>    const originalFilename = `${splittedFilenameByTasks[0]}.${fileExtension}`<br/>    const fetchedFileDataFromAWS = await getObject(originalFilename)</span><span id="cbaf" class="li jx hu le b fv mu lk l ll lm">    // create buffer<br/>    const { Body, ContentType } = fetchedFileDataFromAWS<br/>    const image = new Buffer.from(Body)</span><span id="5b87" class="li jx hu le b fv mu lk l ll lm">    // filesystem tasks<br/>    const convertedImageBuffer = await sharpImageConverter(image, tasks)</span><span id="adc2" class="li jx hu le b fv mu lk l ll lm">    // upload to the s3<br/>    await putObject(url, convertedImageBuffer, ContentType);</span><span id="4bc2" class="li jx hu le b fv mu lk l ll lm">    // redirect to the new image url<br/>    return res.redirect(`${bucketUrl}/${url}`);<br/>  } catch (_err) {<br/>    ...handle errors<br/>  }<br/>})</span></pre><p id="5076" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">AWS . helper . js<br/><a class="ae mh" href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html" rel="noopener ugc nofollow" target="_blank">T22】https://docs . AWS . Amazon . com/AWSJavaScriptSDK/latest/AWS/S3 . html</a></p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="1b23" class="li jx hu le b fv lj lk l ll lm">import AWS from 'aws-sdk'<br/>import Boom from 'boom'</span><span id="aaf1" class="li jx hu le b fv mu lk l ll lm">const s3Service = new AWS.S3({<br/>  accessKeyId: process.env.AWS_ACCESS_KEY_ID,<br/>  secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,<br/>  region: process.env.AWS_REGION,<br/>})</span><span id="bb8b" class="li jx hu le b fv mu lk l ll lm">export const getObject = key =&gt;<br/>  new Promise((resolve, reject) =&gt; {<br/>    const params = { Bucket: bucketName, Key: key }</span><span id="26fa" class="li jx hu le b fv mu lk l ll lm">    if (!key) reject(Boom.notFound())</span><span id="6879" class="li jx hu le b fv mu lk l ll lm">    s3Service.getObject(params, (err, data) =&gt; {<br/>      if (err) reject(err)<br/>      resolve(data)<br/>    })<br/>  })</span><span id="1d67" class="li jx hu le b fv mu lk l ll lm">export const putObject = (key, body, ContentType) =&gt;<br/>  new Promise((resolve, reject) =&gt; {<br/>    const params = {<br/>      Bucket: bucketName,<br/>      ContentType,<br/>      Key: key,<br/>      Body: body,<br/>    }</span><span id="7f26" class="li jx hu le b fv mu lk l ll lm">    if (!key) reject(Boom.notFound())</span><span id="1b0e" class="li jx hu le b fv mu lk l ll lm">    s3Service.putObject(params, (err, data) =&gt; {<br/>      if (err) reject(err)<br/>      resolve(data)<br/>    })<br/>  })</span></pre><p id="f578" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">sharp . helper . js<br/><a class="ae mh" href="https://github.com/lovell/sharp" rel="noopener ugc nofollow" target="_blank"><em class="lw">https://github.com/lovell/sharp</em></a></p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="eb72" class="li jx hu le b fv lj lk l ll lm">import sharp from 'sharp'</span><span id="f1a5" class="li jx hu le b fv mu lk l ll lm">export const sharpImageConverter = async (_image, params) =&gt; {<br/>  const { width } = params</span><span id="e49b" class="li jx hu le b fv mu lk l ll lm">  const modifiedImage = await sharp(_image)<br/>    .resize(width ? parseInt(width, 10) : undefined)<br/>    .crop()<br/>    .toBuffer()</span><span id="c8e0" class="li jx hu le b fv mu lk l ll lm">  return modifiedImage<br/>}</span></pre><p id="db88" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="lw"> 3。部署脚本</em> </strong></p><p id="feef" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们现在可以部署我们的系统，这将使我们能够加快我们的网站加载速度。我们可以保证你的搜索引擎优化结果将会改善。</p><p id="a77d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我希望这篇教程对你有用，如果你有任何问题，欢迎在下面评论。</p><figure class="kz la lb lc fq mj"><div class="bz el l di"><div class="mv mw l"/></div></figure></div></div>    
</body>
</html>