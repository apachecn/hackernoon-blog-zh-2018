<html>
<head>
<title>A Comprehensive Solution to Bugs in Fomo3D-like Games</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Fomo3D类游戏bug综合解决方案</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/a-comprehensive-solution-to-bugs-in-fomo3d-like-games-ab3b054f3cc5?source=collection_archive---------12-----------------------#2018-10-10">https://medium.com/hackernoon/a-comprehensive-solution-to-bugs-in-fomo3d-like-games-ab3b054f3cc5?source=collection_archive---------12-----------------------#2018-10-10</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/ad4010aa3825271af3ca0bf3ea488f30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6iecWd-ZUnruDUV_ILppTw.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Photo by <a class="ae jg" href="https://unsplash.com/photos/O6fs4ablxw8?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">gustavo centurion</a> on <a class="ae jg" href="https://unsplash.com/@guustimutant?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><blockquote class="jh ji jj"><p id="31fd" class="jk jl jm jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hn dt translated"><em class="hu">摘要:Fomo3D及其追随者的失败与其智能合约设计中的bug高度相关。这里我们从</em><a class="ae jg" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank"><em class="hu"/></a><em class="hu">的安全角度出发，对Fomo3D类游戏中的两个问题进行了详细的分析，并给出了几个实用的解决方案供大家参考。我们欢迎任何感兴趣的人加入我们的社区进行进一步的讨论。</em></p></blockquote><h1 id="f1bb" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">黑客攻击导致的Fomo3D类游戏的没落</h1><p id="6e2e" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">Fomo3D已经进入第三轮了。根据10月9日格林威治时间2:00的数据，这个池子只抽取了103.4482乙醚。总量不到800个乙醚加上上一轮的680个乙醚，与前几轮相比，这是一个巨大的衰退。</p><p id="c986" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">SECBIT Labs曾经发表过一篇文章，分析了Fomo3D类游戏的情况，供大家参考<a class="ae jg" href="#96ca" rel="noopener ugc nofollow">【1】</a>。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lp"><img src="../Images/93dfd1b155f342aa36082adcec2e40da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rrHWBiLUDKklEP2hDBqrdA.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><em class="lu">Pic 1: Fomo3D player participation and funds statistics</em></figcaption></figure><p id="5df4" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">上图是Fomo3D玩家参与比例和资金比例。红线代表参与人数，蓝线代表进入游戏合约的资金总和。高峰在左侧，准确的说是7月20日和21日。这段时间无数媒体报道了Fomo3D。许多人跟随其他人加入游戏，参与者人数和资金达到最高峰，超过18，000人和40，000人。在峰值之后，Fomo3D急剧渐变，于8月22日结束了第一轮，进入第二轮，而热度再也无法恢复。</p><p id="e3b1" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">然而，黑客们并没有就此罢休。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lv"><img src="../Images/09e83bc1a24c4b5da4b33dcfa2a10b9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y6mp20i93NbykHFArFox5w.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><em class="lu">Pic 2: Attacking statistics on Fomo3D</em></figcaption></figure><p id="688f" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">上图是对Fomo3D的攻击汇总。一些黑客利用<strong class="jn hv">空投bug </strong>攻击游戏，在第一轮巅峰和第二轮开始时收获颇丰<a class="ae jg" href="#53b6" rel="noopener ugc nofollow">【2】</a>。此外，在第一轮和第二轮即将结束时，黑客们正在利用交易<strong class="jn hv">阻止</strong>攻击，以获得赢得最终大奖的机会<a class="ae jg" href="#7cb6" rel="noopener ugc nofollow">【3】</a>。</p><p id="d522" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">Fomo3D并不孤单——其他模仿者也是黑客的目标。</p><figure class="lq lr ls lt fq iv"><div class="bz el l di"><div class="lw lx l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Fomo3D-like games</figcaption></figure><p id="17fa" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">Fomo3D的设计是通过用乙醚购买钥匙来参与，最后购买者赢得<strong class="jn hv">最终大奖</strong>，同时，参与者还有机会不时赢得<strong class="jn hv">空投奖励</strong>。这两种奖励是对参与者的激励，通过随机性和竞争性使游戏更有趣，吸引更多的参与者和以太来延长游戏长度。</p><p id="de2d" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">然而事情并没有像预期的那样发展。由于合同代码中的漏洞，黑客可以应用特殊技术不断获得高可能性的<strong class="jn hv">空投奖励</strong>，而<strong class="jn hv">最终奖励</strong>会被黑客窃取。普通参与者很难赢得奖品，并希望提前进入可以从追随者那里受益。然而,<strong class="jn hv">两个基本机制已经失效,</strong>游戏无法持续吸引更多资金。恶性循环开始存在。</p><p id="3097" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">那么黑客是如何利用这两个bug的呢？发展团队有出路吗？</p><h1 id="e4de" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">空投臭虫</h1><p id="de52" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">先看看空投奖励。</p><p id="2b31" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">进入游戏的所有醚的1%将被引导到次要池。赢得空投的可能性从0开始，每下一个价值不低于0.1以太的订单，增加0.1%。此外，空投数量与订单有关，例如，购买0.1–1乙醚可能会赢得25%的乙醚。付出越多，回报比例越大。游戏用户界面将显示当前获胜的可能性和未成年人池的数量。</p><p id="e31f" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">Fomo3D airdrop实现有两个bug:</p><ol class=""><li id="b5dc" class="ly lz hu jn b jo jp js jt lj ma ll mb ln mc ki md me mf mg dt translated">合同随机数是可预测的</li><li id="5401" class="ly lz hu jn b jo mh js mi lj mj ll mk ln ml ki md me mf mg dt translated">确定呼叫者是否是合同地址的方法不可靠</li></ol><p id="05f3" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">空投依赖于由合同代码中的<code class="eh mm mn mo mp b">airdrop()</code>控制的智能合同内部生成的随机数。</p><pre class="lq lr ls lt fq mq mp mr ms aw mt dt"><span id="878f" class="mu kk hu mp b fv mv mw l mx my">/**<br/>    * @dev generates a random number between 0-99 and checks to see if thats<br/>    * resulted in an airdrop win<br/>    * @return do we have a winner?<br/>    */<br/>function airdrop()<br/>    private <br/>    view <br/>    returns(bool)<br/>{<br/>    uint256 seed = uint256(keccak256(abi.encodePacked(<br/>        <br/>        (block.timestamp).add<br/>        (block.difficulty).add<br/>        ((uint256(keccak256(abi.encodePacked(block.coinbase)))) / (now)).add<br/>        (block.gaslimit).add<br/>        ((uint256(keccak256(abi.encodePacked(msg.sender)))) / (now)).add<br/>        (block.number)<br/>        <br/>    )));<br/>    if((seed - ((seed / 1000) * 1000)) &lt; airDropTracker_)<br/>        return(true);<br/>    else<br/>        return(false);<br/>}</span></pre><p id="18d7" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated"><code class="eh mm mn mo mp b">airdrop()</code>中的随机数<code class="eh mm mn mo mp b">seed</code>是由块信息和交易调用者地址计算出来的，很容易预测<a class="ae jg" href="#1ac4" rel="noopener ugc nofollow">【4】</a>。</p><p id="38c4" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">Fomo3D开发团队还应用<code class="eh mm mn mo mp b">isHuman()</code>阻止契约加入Fomo3D游戏自动攻击，并预测有契约的随机数。</p><pre class="lq lr ls lt fq mq mp mr ms aw mt dt"><span id="8d5c" class="mu kk hu mp b fv mv mw l mx my">/**<br/>    * @dev prevents contracts from interacting with fomo3d <br/>    */<br/>modifier isHuman() {<br/>    address _addr = msg.sender;<br/>    uint256 _codeLength;<br/>    <br/>    assembly {_codeLength := extcodesize(_addr)}<br/>    require(_codeLength == 0, "sorry humans only");<br/>    _;<br/>}</span></pre><p id="5934" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">这里我们可以看到另一个常见的错误。<code class="eh mm mn mo mp b">extcodesize</code>运算符用于获取目标地址的代码大小。已部署合同的地址与特定代码相关联，因此<code class="eh mm mn mo mp b">extcodesize</code>大于0。许多人使用这种方法来确定目标地址是否是契约，Fomo3D依靠它来防止契约调用某些函数，但这是一种不可靠的方法——在构造函数中调用函数可以绕过这种限制。构造合同时，地址不与任何代码关联，并且<code class="eh mm mn mo mp b">extcodesize</code>为0<a class="ae jg" href="#b9b7" rel="noopener ugc nofollow">【5】</a>。</p><p id="6813" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">通过结合这两个漏洞，黑客获得了建立攻击合同和预测随机数的权限，从而大大增加了他们获胜的机会。</p><h1 id="d4a5" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">如何修补空投Bug</h1><p id="6c35" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">那么应该怎么做才能解决Fomo3D空投bug呢？</p><p id="acb0" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">只有利用前面陈述的两个bug，黑客才能攻击成功。因此，我们只需要实现两个补丁中的一个:</p><ol class=""><li id="4699" class="ly lz hu jn b jo jp js jt lj ma ll mb ln mc ki md me mf mg dt translated">防止智能合约中的随机数预测</li><li id="0cda" class="ly lz hu jn b jo mh js mi lj mj ll mk ln ml ki md me mf mg dt translated">用更安全的方法确定调用方是否是一个协定</li></ol><h1 id="5806" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">补丁一:防止智能合约中的随机数预测</h1><p id="7abd" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">先从随机数预测开始。</p><p id="3c4e" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">智能合约中的随机数很容易预测，因为任何人都可以访问随机种子。<strong class="jn hv">攻击者可以构建一个恶意契约</strong>，在完全相同的环境中执行随机数生成公式，以获得随机数来进行下一步操作。</p><p id="548d" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">智能合约的几乎每个变量都是公开的，生成公式要求每个节点的结果之间保持一致。因此，很难找到一种简单的方法来生成不可预测的随机数。</p><p id="96b1" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">尽管如此，还有其他实用但复杂的解决方案。开发人员可以提交和揭示，或推迟几个块。此外，我们可以引入外部oracles，比如Oraclize和BTCRelay<a class="ae jg" href="#59dc" rel="noopener ugc nofollow">【6】</a>。</p><p id="70b4" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">结合Fomo3D机制，SECBIT Labs这里介绍一种利用当前/未来块<a class="ae jg" href="#c2e3" rel="noopener ugc nofollow">【7】</a>的<strong class="jn hv">哈希值的方法。</strong></p><p id="9b12" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">以太坊智能合约可以调用<code class="eh mm mn mo mp b">block.blockhash()</code>来获取特定块的哈希值。接受的参数是除当前块之外的最近256个块的块高度之一。如果传递其他值，则返回0。</p><p id="0e81" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">常见的不可靠随机数计算将读取先前块<code class="eh mm mn mo mp b">block.blockhash(block.number-1)</code>的散列作为随机种子。在约定内调用<code class="eh mm mn mo mp b">block.blockhash(block.number)</code>将返回0。我们无法在约定中获取当前块哈希，因为在矿工打包和执行事务之前，尚未计算该值。<strong class="jn hv">因此，可以有把握地说，当前块散列是未来的，不可预测的</strong>。</p><p id="6a20" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">当玩家第一次购买钥匙并获得唯一id时，我们可以将地址和<strong class="jn hv">当前块高N </strong>保存到一个数组中(如下面的<code class="eh mm mn mo mp b">_purchase()</code>所示)。</p><pre class="lq lr ls lt fq mq mp mr ms aw mt dt"><span id="6898" class="mu kk hu mp b fv mv mw l mx my">function _purchase(address user) internal {<br/>    Purchase memory p = Purchase({<br/>        user: user,<br/>        commit: uint64(block.number),<br/>        randomness: 0<br/>    });</span><span id="bf86" class="mu kk hu mp b fv mz mw l mx my">    uint id = purchases.push(p) - 1;</span><span id="91dc" class="mu kk hu mp b fv mz mw l mx my">    emit KeysPurchased(id, user, packCount);<br/>}</span></pre><p id="1f2a" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">玩家可以在接下来的255个区块中使用他们的id，并且高度为N的区块的哈希值可用于随机数生成，以确定是否有一个玩家赢得奖励(如下面的<code class="eh mm mn mo mp b">_airdrop()</code>所示)。</p><pre class="lq lr ls lt fq mq mp mr ms aw mt dt"><span id="57f3" class="mu kk hu mp b fv mv mw l mx my">function _airdrop(uint id) internal returns(bool) {<br/>    Purchase storage p = purchases[id];</span><span id="4db5" class="mu kk hu mp b fv mz mw l mx my">    require(p.randomness == 0);<br/>    require(block.number - 256 &lt; p.commit);<br/>    require(uint64(block.number) != p.commit);<br/>    require(p.user == msg.sender);</span><span id="832c" class="mu kk hu mp b fv mz mw l mx my">    bytes32 bhash = blockhash(p.commit);<br/>    uint seed = uint(keccak256(abi.encodePacked(bhash, p.user, id)));<br/>    p.randomness = seed;</span><span id="f3d7" class="mu kk hu mp b fv mz mw l mx my">    if((seed - ((seed / 1000) * 1000)) &lt; airDropTracker_)<br/>        return(true);<br/>    else<br/>        return(false);<br/>}</span></pre><p id="4338" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">玩家加入游戏时产生的区块散列在255个区块后不再可用。所以一定要通知玩家在一个时间范围内查奖，及时领奖。当然，如果球员错过了，我们可以再给一次机会。更多技术细节可在我们的技术社区获得。</p><p id="7a61" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">这种方法在著名的<a class="ae jg" href="https://hackernoon.com/tagged/blockchain" rel="noopener ugc nofollow" target="_blank">区块链</a>卡牌游戏《被解放的神》中也被应用，用来控制玩家购买的稀有卡牌。当然，根据相同的原理<a class="ae jg" href="#9402" rel="noopener ugc nofollow">【8】</a>，我们可以在当前高度之后使用给定数量的块哈希值(例如5)作为随机种子。</p><h1 id="3eef" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">补丁二:用更安全的方法确定调用者是否是契约</h1><p id="4eab" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">另一个问题是如何确定来电者是否为合同地址。</p><p id="ce64" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">我们可以用简单有效的方法解决这个问题。</p><pre class="lq lr ls lt fq mq mp mr ms aw mt dt"><span id="db99" class="mu kk hu mp b fv mv mw l mx my">modifier isHuman() {<br/>    require(tx.origin == msg.sender, "sorry humans only");<br/>    _;<br/>}</span></pre><p id="368b" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">以太坊开发最佳安全实践建议不要使用<code class="eh mm mn mo mp b">tx.origin</code>，因为许多开发人员不知道<code class="eh mm mn mo mp b">tx.orign</code>和<code class="eh mm mn mo mp b">msg.sender</code>之间的区别。<code class="eh mm mn mo mp b">tx.orign</code>代表一个事务的调用方，<code class="eh mm mn mo mp b">msg.sender</code>代表每个合同调用的调用方。</p><pre class="lq lr ls lt fq mq mp mr ms aw mt dt"><span id="764e" class="mu kk hu mp b fv mv mw l mx my">A -&gt; B -&gt; C</span></pre><p id="4308" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">例如，用户A调用合同B and B调用合同C。合同C中的<code class="eh mm mn mo mp b">msg.sender</code>是B，而<code class="eh mm mn mo mp b">tx.origin</code>是A。<code class="eh mm mn mo mp b">msg.sender</code>可能是合同，而<code class="eh mm mn mo mp b">tx.origin</code>永远不会是合同。因此，上述方法可以有效地限制合同调用合同。</p><h1 id="5d7c" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">事务阻塞错误</h1><p id="55eb" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">是时候检查最后的奖品了。</p><p id="e2ba" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">类似Fomo3D的游戏有倒计时——每轮结束前最后一个购买钥匙的人将赢得泳池中近一半的醚，因此许多玩家会在接近结束时购买钥匙，希望成为最后一秒被矿工打包的幸运儿。</p><p id="23ce" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">普通人在回合结束时采用类似的策略:检查倒计时，提高油价，买钥匙，闭上眼睛祈祷获胜；然而，这种策略不太可能给你带来回报。</p><p id="5b2e" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated"><strong class="jn hv">根据SECBIT Labs的分析，前两轮Fomo3D的获胜者采用了相同的攻击技术——在接近尾声时进行攻击交易。</strong></p><p id="3980" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">胜利者(黑客)调用部署的攻击契约中的<code class="eh mm mn mo mp b">getCurrentRoundInfo()</code>并检查<strong class="jn hv">回合结束</strong>和<strong class="jn hv">当前玩家的线索地址</strong>。当剩余时间达到一个阈值并且最后一个买家是黑客本身时，那么合同将调用<code class="eh mm mn mo mp b">assert()</code>以使交易失败并消耗所有气体；否则，它将什么也不做，消耗很少的气体。</p><p id="61ba" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">赢家(黑客)正是使用了这种方法，触发了大量易变的神秘交易:<strong class="jn hv">当黑客极有可能成为赢家</strong>时，抽取矿池，用高气价包装黑客的交易，并占领后续区块，导致其他购买钥匙的交易无法正常打包，<strong class="jn hv">加速游戏结束</strong>，提高获胜几率。</p><p id="e776" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">接近回合结束时，普通玩家可以手动或通过脚本购买高油价的钥匙。黑客方法比这些常规策略高明得多。</p><h1 id="7657" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">如何解决事务阻塞</h1><p id="fb62" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">实际上，这个问题不仅威胁着Fomo3D类游戏。所有要求玩家在一定时间范围内竞争的游戏也会受到威胁。在游戏中总会有黑客使用前面描述的方法，只要游戏奖金高并且<strong class="jn hv">奖励比成本</strong>多得多。</p><h1 id="bcc8" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">补丁一:提高攻击成本</h1><p id="d019" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">为了摆脱这个问题，SECBIT Labs建议游戏开发者不要把游戏获胜和倒计时联系起来，尽量减少<strong class="jn hv">通过攻击</strong>获得奖励的机会和<strong class="jn hv">攻击</strong>的欲望。</p><p id="4df9" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">例如，我们可以修改规则，因为最后一个买家赢得奖品的概率相对较低，比如5%。当时间结束时，由于概率原因，奖品没有显示，合同将增加倒计时时间。因此，黑客并不一定能通过拦截赢得奖金，而交易<strong class="jn hv">拦截攻击会耗费太多的汽油，使黑客无法继续攻击</strong>。</p><pre class="lq lr ls lt fq mq mp mr ms aw mt dt"><span id="983c" class="mu kk hu mp b fv mv mw l mx my">function buyCore(...)<br/>    private<br/>{<br/>    ...<br/>    // check to see if end round needs to be ran<br/>    if (_now &gt; round_[_rID].end &amp;&amp; round_[_rID].ended == false) <br/>    {<br/>        // check to see whether or not this round should end<br/>        if shouldRndEnd(lastCommitId) (<br/>            // end the round (distributes pot) &amp; start new round<br/>            round_[_rID].ended = true;<br/>            _eventData_ = endRound(_eventData_);<br/>            ...<br/>        ) else {<br/>            ...<br/>            updateTimer(_keys, _rID);<br/>            ...<br/>        }<br/>    }<br/>    ...<br/>}</span></pre><p id="0132" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">下面是一个代码示例。<code class="eh mm mn mo mp b">shouldRndEnd()</code>控制结束时的概率来决定游戏结束时间，这是依靠不可预测的随机数，参考<strong class="jn hv">控制空投的先验码</strong>。</p><h1 id="fe19" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">补丁二:禁止调用信息查询接口的合同</h1><p id="6d46" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">Fomo3D攻击的另一个原因是游戏契约的信息查询接口，它可以被任何地址调用。黑客们现在可以不断地查询游戏，并选择不同的策略以最小化成本和最大化获胜机会。</p><pre class="lq lr ls lt fq mq mp mr ms aw mt dt"><span id="be6d" class="mu kk hu mp b fv mv mw l mx my">modifier isHuman() {<br/>    require(tx.origin == msg.sender, "sorry humans only");<br/>    _;<br/>}</span><span id="5add" class="mu kk hu mp b fv mz mw l mx my">function getCurrentRoundInfo()<br/>    isHuman()<br/>    public<br/>    view<br/>    returns(...)<br/>{<br/>    ...<br/>}</span></pre><p id="2bfc" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">相应的，Fomo3D的另一个补丁就是把上面说的safe <code class="eh mm mn mo mp b">isHuman()</code>应用到<code class="eh mm mn mo mp b">getCurrentRoundInfo()</code>上，防止契约自动攻击。</p><h1 id="fd33" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">结论</h1><p id="1ebb" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">由于安全和公平方面的问题，Fomo3D及其模仿者更有可能成为黑客的金矿，而不是吸引更多的普通玩家。玩家的数量会一轮接一轮地减少，衰退还在继续。</p><p id="ed3c" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">SECBIT Labs建议后来者借鉴，避免抄袭代码，避免只靠PR吸引人。做一些改变，智能合同安全性将大幅上升，为未来的分散游戏开发。</p><h1 id="9aa0" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">参考</h1><ul class=""><li id="96ca" class="ly lz hu jn b jo lh js li lj na ll nb ln nc ki nd me mf mg dt translated">[1]黑客再次获得Fomo3D大奖——机制漏洞导致的降级(中文)，<a class="ae jg" href="https://zhuanlan.zhihu.com/p/45330743" rel="noopener ugc nofollow" target="_blank">https://zhuanlan.zhihu.com/p/45330743</a>，2018/09/25</li><li id="53b6" class="ly lz hu jn b jo mh js mi lj mj ll mk ln ml ki nd me mf mg dt translated">[2]区块链史上最大智能合约攻击曝光— Part 1，<a class="ae jg" rel="noopener" href="/@anchain.ai/largest-smart-contract-attacks-in-blockchain-history-exposed-part-1-93b975a374d0">https://medium . com/@ anchain . ai/Largest-Smart-Contract-Attacks-in-区块链-History-Exposed-Part-1-93b 975 a 374d 0</a>，2018/08/22</li><li id="7cb6" class="ly lz hu jn b jo mh js mi lj mj ll mk ln ml ki nd me mf mg dt translated">[3]中奖者如何获得Fomo3D大奖—详解，<a class="ae jg" rel="noopener" href="/coinmonks/how-the-winner-got-fomo3d-prize-a-detailed-explanation-b30a69b7813f">https://medium . com/coin monks/How-the-winner-get-fomo 3d-prize-A-Detailed-explain-b 30a 69 b 7813 f</a>，2018/08/23</li><li id="1ac4" class="ly lz hu jn b jo mh js mi lj mj ll mk ln ml ki nd me mf mg dt translated">[4]如何PWN FoMo3D，初学者指南，<a class="ae jg" href="https://www.reddit.com/r/ethereum/comments/916xni/how_to_pwn_fomo3d_a_beginners_guide" rel="noopener ugc nofollow" target="_blank">https://www . Reddit . com/r/ether eum/comments/916 xni/How _ to _ PWN _ fomo 3d _ a _初学者指南</a>，2018/07/23</li><li id="b9b7" class="ly lz hu jn b jo mh js mi lj mj ll mk ln ml ki nd me mf mg dt translated">[5]使用EVM汇编获取地址'码大小，<a class="ae jg" href="https://ethereum.stackexchange.com/questions/14015/using-evm-assembly-to-get-the-address-code-size" rel="noopener ugc nofollow" target="_blank">https://ether eum . stack exchange . com/questions/14015/Using-EVM-assembly-to-get-the-address-code-size</a>，2017/04/07</li><li id="59dc" class="ly lz hu jn b jo mh js mi lj mj ll mk ln ml ki nd me mf mg dt translated">[6]预测以太坊智能合约中的随机数，<a class="ae jg" href="https://blog.positive.com/predicting-random-numbers-in-ethereum-smart-contracts-e5358c6b8620" rel="noopener ugc nofollow" target="_blank">https://blog . positive . com/Predicting-Random-Numbers-in-ether eum-Smart-Contracts-e 5358 c6b 8620</a>，2018/02/01</li><li id="c2e3" class="ly lz hu jn b jo mh js mi lj mj ll mk ln ml ki nd me mf mg dt translated">[7]在winsome . io-Future block hashes上生成随机数，<a class="ae jg" href="https://blog.winsome.io/random-number-generation-on-winsome-io-future-blockhashes-fe44b1c61d35" rel="noopener ugc nofollow" target="_blank">https://blog . winsome . io/Random-Number-Generation-on-winsome-io-Future-block hashes-Fe 44 B1 c 61d 35</a>，2017/05/07</li><li id="9402" class="ly lz hu jn b jo mh js mi lj mj ll mk ln ml ki nd me mf mg dt translated">[8]诸神被解放，<a class="ae jg" href="https://etherscan.io/address/0x482cf6a9d6b23452c81d4d0f0f139c1414963f89#code" rel="noopener ugc nofollow" target="_blank">https://ethers can . io/address/0x 482 cf 6a 9 d6b 23452 c 81d 4d 0 f 0f 139 c 1414963 f 89 #代码</a>，2018/07/16</li></ul></div><div class="ab cl ne nf hc ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="hn ho hp hq hr"><p id="056d" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated"><a class="ae jg" href="https://secbit.io" rel="noopener ugc nofollow" target="_blank"><strong class="jn hv"><em class="jm">sec bit</em></strong></a><em class="jm">由一群加密货币爱好者创立。我们正在研究智能合同安全、智能合同形式验证、加密协议、编译、合同分析、博弈论和加密经济学。</em></p><figure class="lq lr ls lt fq iv"><div class="bz el l di"><div class="nl lx l"/></div></figure></div></div>    
</body>
</html>