<html>
<head>
<title>Meet MaaT: Alibaba’s DAG-based Distributed Task Scheduler</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">认识MaaT:阿里巴巴基于DAG的分布式任务调度器</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/meet-maat-alibabas-dag-based-distributed-task-scheduler-7c9cf0c83438?source=collection_archive---------8-----------------------#2018-10-12">https://medium.com/hackernoon/meet-maat-alibabas-dag-based-distributed-task-scheduler-7c9cf0c83438?source=collection_archive---------8-----------------------#2018-10-12</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="1ab6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">了解阿里巴巴如何通过一种新的支持平台确保跨平台效率</em></p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/a46b98adeb7bab3a6819464d4e3d3d6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jqoD46axDMKvLsCwryMdtw.jpeg"/></div></div></figure><p id="adc5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">本文是</em> <a class="ae kc" rel="noopener" href="/@alitech_2017/aiops-for-alibaba-search-operations-765854c60752"> <strong class="it hv"> <em class="jp">搜索AIOps </em> </strong> </a> <em class="jp">迷你系列的一部分。</em></p><p id="d833" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">作为一个服务和平台的复杂生态系统，阿里巴巴集团的网络架构提出了独特的运营挑战。在这样的环境中，异步地执行特定的功能并与指定的过程保持一致需要部署能够在非常深的网络结构中操作的多个协作子系统。例如，应用程序的上线过程需要连续调用配置同步模块、监视器模块、资源更新模块、smoke模块和引擎创建模块，这又需要在整个过程中进行分支判断、上下文转移和失败重试。</p><p id="41a6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了满足这些需求，阿里巴巴集团最近投资开发了使能平台，旨在支持单一系统无法满足需求的复杂服务。具体来说，阿里巴巴已经将自己的MaaT作为一种工具，用于集中管理大量面向过程的任务，同时在自己的容器中维护每个任务节点。这使得任务能够以分布式方式运行，确保过程以稳定的效率运行。</p><p id="381b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">今天，我们更仔细地观察MaaT的架构及其核心相关组件，以提供对其原理和机制的一般介绍。</p><h1 id="4647" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">什么是MaaT？</h1><p id="c0e0" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">MaaT是一个基于开源项目Airflow的流程调度系统，允许用户自定义流程节点。有了它，程序可以设置为在用户指定的时间启动(支持crontab格式)或由用户手动触发。</p><p id="6c7b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在MaaT中，所有节点以分布式方式在Hippo上运行，由Drogo调度。MaaT允许用户创建自己的调度节点和执行节点，以实现资源隔离，并配置操作环境或自己的执行节点的副本数量。</p><p id="42ab" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下图显示了单个任务的调度过程示例:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff lg"><img src="../Images/4300a7281580690b688714fa3b0e3e19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oO6uVvODTzag6EmbMn-1aA.png"/></div></div></figure><h1 id="8ead" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">为什么要部署MaaT？</h1><p id="380a" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">项目开发通常需要面向过程的定时派遣，例如上线过程或任务的定时分析。然而，试图开发一个程序调度系统和访问该集团的工作流程不可避免地提出了一些问题。</p><p id="f5c9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，服务代码和调度代码是高度耦合的。修改过程需要侵入代码层，其中服务代码的发布会影响调度。第二，如果没有统一的管理系统，很难管理和跟踪这些调度任务。最后，具有多个分支和上下文转移场景的复杂过程没有得到很好的支持，并且缺少可视UI使得它对用户不友好。</p><h1 id="8292" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">技术型号选择</h1><h2 id="3557" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">D2</h2><p id="4261" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">定时任务和流程任务的调度是D2和workflow等阿里集团内部产品以及Airflow和Quartz等开源产品的常见需求。</p><p id="65f2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">D2是一套基于ODPS的过程调度系统，承载集团基于ODPS数据输出产生的调度任务。允许用户自定义脚本、定时任务触发、手动触发(补充操作的方式)，适用于基于数据状态的任务过程调度(比如基于数据输出执行任务过程)。它由阿里巴巴的D2团队特别维护，拥有精心设计的用户界面。</p><p id="31d1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，D2有许多缺点。DAG(有向无环图)调度发生在大范围内，并且每天需要运行的每个节点和拓扑关系是基于前一天的全局拓扑关系来计算的。因此，理论上，新创建和修改的任务只能在第二天生效，并且需要以补偿操作的方式来完成，以便立即生效。服务中的任务(如任务配置或调度时间)经常会发生变化，或者涉及手动触发调度的场景(如随时可能发生的发布过程或完整备份过程)。使用D2使服务变得不灵活，并且在这种情况下超出了适用于D2的场景范围。此外，D2不支持过程上下文的转移，而上下文转移在相关服务中是相对健壮的。往往上一个节点输出某个值，下一个节点需要使用。</p><p id="086f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，D2缺乏对搜索生态系统的支持。搜索技术部的整个底层架构都有自己的一套生态系统，比如dispatch(由Hippo和Drago组成)和alarm(由Kmon组成)。使用D2，用户无法充分享受搜索技术生态系统的好处，同时也给后续的统一部署带来了问题。</p><h2 id="450f" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">工作流程</h2><p id="6ca2" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">组工作流是用于组审批过程的常规调度引擎。许多产品的审批过程都是基于组工作流的，它也可以用作简单的任务分派过程。在部署MaaT之前，阿里巴巴还使用小组工作流作为程序任务的调度引擎。它允许手动触发，支持以HSF模式调用外部系统，并支持上下文转移。但是，它涉及复杂的配置，并且对调用外部系统的支持有限。</p><h2 id="ca7b" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">石英</h2><p id="0fad" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">Quartz是一个基于Java的开源调度框架。它支持分布式调度、任务持久性和定时任务，但不支持过程调度。此外，任务配置需要耦合到调度系统中，而任务的热加载需要修改。</p><h2 id="4cff" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">气流</h2><p id="a29d" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">Airflow是一个开源项目，是一个分布式过程调度系统，具有许多优点。有了它，服务代码与调度系统解耦，每个服务的过程代码由单独的Python脚本描述，脚本定义了面向过程的节点来执行服务逻辑和支持任务的热加载。这样，crontab定时任务格式就完全受支持，可以用来指定任务完成的时间。它支持复杂的分支条件，并为每个节点设置一个触发时间，比如当父节点都成功时执行，或者当任何父节点成功时执行。它还提供了一个完整的UI，可以可视化所有任务的状态和历史，并且只依赖于DB和rabbitmq，外部依赖性更少，更容易构建。</p><p id="1f1f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有人对Luigi和Airflow的比较提出了一些问题。两者都基于功能相似的pipline任务调度系统。作为后来者，气流超越了早期的起步者和竞争者。</p><p id="1e66" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">以下是同类产品对比:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff lv"><img src="../Images/1d095b293b966a2f5b1f65c8adc415c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ylryYVDJIMBE-WW8tK3EEw.png"/></div></div><figcaption class="lw lx fg fe ff ly lz bd b be z ek"><em class="ma">Here Y represents support and N represents non-support</em></figcaption></figure><p id="1af5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">经过一段时间的研究，阿里巴巴选择了Airflow作为原型，从它开始开发分布式任务调度系统。功能全面，满足基本服务需求，可以比较轻松地扩展功能。气流较少依赖外部，更容易与搜索生态系统连接。</p><h2 id="ec0e" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">自然气流的问题</h2><p id="a8df" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">气流可以解决过程调度中存在的许多问题，但是直接实现用于生产的本地气流仍然存在许多问题。</p><p id="0694" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Native Airflow支持分布式调度，但由于依赖于本地状态，它不能直接部署在Drogo上。由于缺乏适当的监控手段，因此需要将其与Kmon相结合，以改善监控和警报设施，并且没有用户友好的编辑方法，因此用户需要了解更多有关气流的原理和细节，才能成功操作它。当大量任务正在运行时，调度的性能会急剧下降。最后，本地气流在分布式模式下存在一些缺陷。</p><h1 id="22ad" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">马特的建筑</h1><h2 id="1b81" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">概观</h2><p id="478d" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">下图提供了MaaT架构的高级视图:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mb"><img src="../Images/ba098b7f3ad82e78589ab3db90ac8592.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FqWslezSMO7H2yLIjZgjAg.png"/></div></div></figure><h2 id="5e10" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">服务层</h2><p id="e9e1" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">可以根据任何程序调度或定时触发要求，使用MaaT创建应用程序。MaaT提供可视化编辑页面和丰富的API。用户可以方便地创建编辑过程模板，设置复杂的分支逻辑，而MaaT会根据调度时运行时的状态来确定过程的流程路径。</p><p id="735c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">目前接入MaaT的应用场景有Tisplus、鹰眼、Kmon、产能平台、离线组件平台、Opensearch等。</p><h2 id="8757" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">管理层</h2><p id="bd26" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">native Airflow中的管理相对简单，因为它基于描述任务过程DAG的Python脚本调度。因此，用户需要学习气流原理来创建、更新和执行任务。只能基于档案进行维护，相当不方便。因此，MaaT在其外层(MaaT控制台)中加入了一个管理系统层，以降低运营、维护和用户学习的成本。</p><p id="723f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下图是玛特管理系统的操作界面流程图:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mc"><img src="../Images/326ff25d5322b8d5bab88cc399e7edf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sRQNSuMXt-FZQc9Pnm9jGA.png"/></div></div></figure><h2 id="896f" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">模板管理</h2><p id="2f86" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">在任务过程分派场景中，通常用于执行不同任务的过程或多或少是相同的，只有个别参数不同。因此，MaaT引入了基于模板管理的任务流程。用户在模板管理层为该过程定义一个运行模板，并使用变量来表示未确定的部分。当生成一个特定的任务时，它由特定的变量和模板来呈现。修改模板后，可以对依赖于它的所有任务进行验证。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff md"><img src="../Images/e4649d47f7044c6045c8b8bc6f0d923b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WIzqmBcY6HCmxsTpvU6jbw.png"/></div></div></figure><p id="729f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">模板管理预置了多个任务节点，用户可以自由选择不同的任务节点来组装模板流程。</p><h2 id="0f76" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">应用管理</h2><p id="4087" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">应用管理用于管理所有具体的过程调度任务，包括任务使用的模板、变量的值、告警信息以及任务触发的crontab。通过模板创建应用程序后，用户可以通过应用程序管理继续维护任务的运行。</p><h2 id="c138" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">队列管理</h2><p id="9081" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">在MaaT上运行的任务属于不同的应用程序，并且不同应用程序的操作环境差异很大。此外，不同的应用程序将理想地实现集群隔离。为此，MaaT提供了队列管理。结果，指定队列的任务节点被分派到相应队列的机器，这些机器将只运行指定队列的任务节点。</p><p id="db62" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，队列还可以指定并发性，指示当前队列上有多少任务同时运行，以确保在机器上同时运行的任务不会导致过度负载，并且超出并发性的任务将被挂起，直到资源被释放。</p><h2 id="dd57" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">核心模块</h2><p id="af3e" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">MaaT核心模块完成任务调度的整个过程。核心模块的各个节点在机器上独立运行，启动时互不依赖。数据状态通过DB保存，消息通过MQ或FaaS分发。</p><h2 id="f451" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">Web API服务</h2><p id="1156" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">Web API服务提供了丰富的与外部交互的API，包括任务添加、删除和修改、历史任务状态、任务状态修改、任务触发和任务重试。</p><p id="1246" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，它还完成了原生气流提供的网页显示功能。</p><h2 id="0719" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">调度程序</h2><p id="49af" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">调度器在MaaT中起着关键作用，它决定任务何时被调度运行，以及在运行任务时哪些节点可以被执行。调度程序通过MQ或FaaS将确定要执行的节点发送给工作节点。</p><p id="eff6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">随着任务数量的增加，单个调度程序的负载逐渐变得过高，导致调度周期延长。为了减轻调度器的压力，MaaT根据服务来划分调度器。不同服务的任务由一个独立的调度程序分派，并发送给指定的工作人员。</p><h2 id="2ed0" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">调度程序增强</h2><p id="09df" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">本机气流的调度逻辑吞吐量较低。当任务数增加时，调度周期会变得相当长，面临高任务数的调度器会延迟一分钟左右。参考最新实现，我们优化了原生调度逻辑，将之前阻塞的调度方法拆分成多个进程池，异步完成可执行任务的生产&gt;提交&gt;轮询操作。压力测试后，原来30至40秒的调度时间减少到大约5秒。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff me"><img src="../Images/cf1e4843dcc4337f23ecda903429d123.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PwwZugsz2PrIfylSal4aAw.png"/></div></div></figure><h2 id="a756" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">工人</h2><p id="114e" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">工作者是执行任务的角色。它接受调度程序发出的任务，并在worker上执行节点中描述的特定任务。worker通常部署有副本，任务在任何等价的worker机器上。当工人资源不足时，任务可以动态扩展。</p><p id="508e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不同的队列任务需要不同的基本环境，比如Python、Java、Hadoop和zk，并且不同队列中的worker角色的启动参数配置也有所不同。因此，当不同队列的工作人员启动时，他们将根据配置中描述的资源进行部署和安装。</p><p id="4470" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在worker上完成任务后，DB将被写回。调度程序将在检测到当前任务状态的变化后继续分派任务。</p><h2 id="97ff" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">分销商</h2><p id="0147" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">任务调度层将调度程序必须调度的任务发送给指定的工作人员。MaaT使用本地芹菜+Rabbitmq和基于搜索生态的FaaS来分派任务。</p><h2 id="ded5" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">芹菜+兔肉</h2><p id="5ba5" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">Native Airflow使用Celery + RabbitMQ将消息从调度程序发送到工作程序。</p><p id="3505" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Scheduler向MQ发送将要运行的任务，其中包括任务的相应队列信息。当worker从MQ获取信息时，只获取相应的队列任务，并拉至相应的worker执行。MQ是在MaaT中使用RabbitMQ实现的。与其他角色类似，MQ也是独立部署的。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff mf"><img src="../Images/232507de7211ee2beb7645c4fa7f1b17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*c6VYXw_4fjsZJhV6Wbvpyg.png"/></div></figure><p id="8a17" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Celery + Rabbitmq模型继续mq中的任务和任务状态。内存队列的性能可以满足大多数情况下的需求。但是，MaaT部署基于两层调度程序Drogo，并且要求所有部署节点都是无状态的。MQ不满足这一要求，因为它存储消息状态。这就是为什么我们选择了基于搜索生态的FaaS框架来代替芹菜+ RabbitMQ。</p><h2 id="0621" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">法斯</h2><p id="f280" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">FaaS (Function as a Service)是一个基于搜索生态实现的无服务器框架，其执行者是MaaT。</p><p id="d48e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所有的MaaT任务都被抽象成函数。当一个任务被执行时，MaaT调用相应的函数；任务完成后，MaaT返回到任务状态，此时MaaT和FaaS之间的初始链接完成。未来有望在FaaS的基础上进一步优化。例如，执行任务的多样化方式可以将轻量级任务转换为功能，将关键任务转换为服务；任务资源的动态调整甚至允许将资源分配给当前正在执行的任务，并在执行完成后立即释放这些资源。</p><p id="e448" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于MaaT，FaaS支持从生产者到消费者的任务分配，在MQ中构建消息，并提供任务状态接口。此外，FaaS本身确保消息不会丢失，并且能够根据用户负载自动扩展和收缩。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff mg"><img src="../Images/45a45a641ba17367e44e08a8dcb5d85e.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*j0o5hiWpNOYt7fKxAVyr0A.png"/></div></figure><h2 id="ba60" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">基本组件</h2><p id="ccdb" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">DB，使用group IDB，负责MaaT信息的长寿，包括任务信息、任务运行记录、任务运行状态、节点运行记录、节点运行状态等等。</p><p id="5d99" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">OSS是一个管理Drogo启动时机器迁移风险的组件，因为没有日志可以存储在本地。所有节点的运行日志都存储在OSS上，查看日志需要访问OSS。</p><p id="8d47" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Kmon负责监控集群的运行状态，并在任务失败时发出警报。</p><p id="e1f1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，Drogo完成所有MaaT节点的码头化部署。</p><h1 id="008c" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">MaaT平台的优势</h1><h2 id="798a" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">可视化编辑和通用节点类型</h2><p id="f40c" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">MaaT提供了一个管理平台Aflow，使用户能够方便地编辑流节点并管理所有模板和任务，如本文前面的管理层部分所述。</p><p id="5d1f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，MaaT还提供多样化类型的通用节点。Native Airflow支持各种可以执行不同类型任务的节点。在与用户的交互中，MaaT可以根据用户的习惯和需求来密封节点，也可以开发新的节点类型来满足大多数用户的需求，如下所示。</p><p id="ff8e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Bash节点是直接在workers上执行基本bash操作的节点。Bash节点通常依赖于其他资源，因此很少使用。</p><p id="4333" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Http节点支持http调用。在调度中，发送http请求来触发其他系统。这些节点还提供轮询http接口。当被触发时，它们轮询其他系统是否已经成功运行，只有当它们成功运行时才继续运行。</p><p id="a384" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">带资源的Bash节点，不同于普通的bash节点，自带一些资源(比如jar包、bash脚本、Python脚本)。运行这些节点首先在本地下载资源，然后执行bash脚本。</p><p id="fdf5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">分支节点根据之前的节点运行结果或最初传递的参数来决定分支的被分割节点经过哪些分支。</p><h2 id="0d87" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">基于Drogo的部署</h2><p id="49d3" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">MaaT服务提供多种角色，都要求不同的运行环境。维护这些环境可能成为操作人员的噩梦，在这种情况下，启动Hippo成为MaaT操作的最佳选择。作为一个基于两层调度服务的管理平台，Drogo使得所有MaaT节点部署到Hippo成为可能。</p><p id="5172" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">具体来说，基于Drogo的部署具有以下优势。</p><p id="6aa0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Drogo支持低成本添加新节点。在Drogo之前，每次需要新节点时，都需要为运行准备资源，还需要编写部署脚本。此外，操作团队本身必须维护每个节点的脚本。发射Drogo后，所有此类部署信息都可以存储在Drogo上。随着新节点的出现，从以前的部署中复制和调整类似的信息就足以完成工作。</p><p id="fc41" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Drogo易于扩展。在卓戈之前，高级任务的扩展需要准备机器、设置环境和调试运行参数，总共需要半天到一整天的时间。Drogo上线后，调整副本数量就足以自动扩展那些任务。</p><p id="e306" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Drogo还能有效防止机器迁移造成的服务干扰。在推出Drogo之前，一旦原始机器出现故障，就必须依赖另一台机器进行扩展。对于一些只运行一台机器的节点，操作员只能祈祷他们的机器能坚持下去。相比之下，Drogo会在机器迁移时自动指派一台新机器接管服务。对于可能被干扰的服务，即使在单节点部署场景中，也不必担心在机器出现故障后服务可能变得不可用。</p><p id="b4a8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下图显示了目前部署在Drogo上的MaaT角色:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mh"><img src="../Images/9145714e9ead94df50e00af7f03df87b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SZqWeVdlNkWUFhZKb9MbfQ.png"/></div></div></figure><p id="dc5e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由于native Airflow中的一些节点是有状态的，并且依赖于本地文件的一部分，所以机器迁移会使这些节点成为无状态的。因此，对MaaT进行了调整，以确保机器迁移不会导致如下结果。</p><p id="d48d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">以前的计划依赖于本地Python DAG文件，这些文件会因机器迁移而丢失，而现在的更改是将所有DAG文件与保存的计划信息一起存储在数据库中，以确保DAG信息在机器迁移后不会丢失。</p><p id="adf5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由于对本地文件的依赖，web服务和调度程序读取和写入相同的DAG文件。因此，native Airflow的角色调度程序和web服务必须绑定在一起才能运行。相反，使用DB信息进行调度允许分别部署web服务和调度程序。</p><p id="0767" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，由于原始日志文件存储在本地，机器迁移会导致它们丢失。重建后，日志文件存储在OSS的远端，每次都将在那里被读取。</p><h2 id="4b95" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">按集群管理</h2><p id="6e22" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">为了隔离不同的任务，MaaT扩展了针对各种任务的Airflow本地队列管理的集群管理功能。某些类型的任务可以创建自己的调度器和工作器，在创建应用程序时，可以使用指定的调度器来调度或运行指定的工作器。(如果没有指定，默认的调度程序和工作线程将负责调度。)</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff mi"><img src="../Images/62d4584414f7ab3d8ff3001368bc2f8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*rLsbf2CCs-bhO20iHUaQ3Q.png"/></div></figure><p id="947d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">集群配置参数包括工作人员部署配置、工作人员数量、集群并发性和调度程序。</p><p id="db9b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">工作者部署配置与该工作者所依赖的资源有关。当Drogo启动时，任务运行时所需的资源将被部署到工作机。当机器迁移时，此部署配置将用于重新分配资源。</p><p id="461e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">工作者数量参数简单地控制工作者角色的数量。</p><p id="06a2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">集群并发控制集群中运行的并发数量，以防止下游系统由于运行太多任务而负担过重。</p><p id="1531" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">目前，每个集群只有一个调度程序，尽管后续重建将支持多个调度程序节点。</p><h1 id="6585" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">监视器和警报</h1><h2 id="2714" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">平台监控和报警</h2><p id="6b10" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">为了收集平台如何运行的感觉，MaaT在每个节点的每个关键步骤向Kmon报告指标。开发人员会及时得到关于异常指标的警报。此类指标还可用于判断当前集群上的负载，并优化高负载的节点。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff mj"><img src="../Images/b74f087773f79cd49bf0d4a7f93c6765.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l4k6WVvxfvKAnCj5706Zjw.png"/></div></div></figure><h2 id="0f3e" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">任务警报</h2><p id="839d" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">对于特定的任务，MaaT支持对任务节点的任何异常运行进行报警，例如异常节点运行、未能按时运行任务、任务超时等。用户可以在管理平台上设置报警条件和报警接收人。</p><h1 id="0702" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">平台的当前状态</h1><p id="2874" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">MaaT是一个基于DAG的任务调度系统，服务于阿里巴巴集团内部服务，以及众多云应用场景。</p><p id="1419" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于支持搜索的平台Tisplus，它为Tisplus和其他需要定时触发的任务安排在线程序。</p><p id="01ce" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于Hawkeye来说，它是基于时间安排分析任务的。</p><p id="33ea" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于搜索监控平台Kmon，MaaT支持监控和托管服务以及警报处理程序。</p><p id="ae9c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Torch是一个搜索容量估计平台，它依靠MaaT来管理容量估计过程。</p><p id="fc5e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在离线搜索平台巴哈姆特，MaaT支持离线组件平台的发布程序和完整备份程序。</p><p id="2b6a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在Opensearch中，它支持许多算法场景的离线任务，在Tpp中，它为推荐的场景推荐过程调度任务。</p><h2 id="f754" class="lh ke hu bd kf li lj lk kj ll lm ln kn jc lo lp kr jg lq lr kv jk ls lt kz lu dt translated">MaaT在线集群任务执行</h2><p id="920a" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">截至2018年8月13日，MaaT平均每天调度超过3000个任务，平均每天运行超过24000个任务。</p><p id="c4ee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">随着更多的应用场景切换到MaaT，将在更严格的测试条件下进一步评估平台容量。</p><h1 id="93bb" class="kd ke hu bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">展望未来</h1><p id="6b38" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">随着更多业务和数据的出现，MaaT还需要进一步增强其用户体验和可靠性。这应包括进一步与Aflow结合，以便在管理平台上一站式创建、配置和部署集群。它还需要提供更多的报警选项，作为更强大的错误报告机制的一部分。此外，随着任务的增加，一些调度缺陷将会出现，需要进一步优化，以及与FaaS的深入合作，为各种任务创建单独的服务，并减少资源消耗。</p></div><div class="ab cl mk ml hc mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hn ho hp hq hr"><h1 id="a63c" class="kd ke hu bd kf kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la dt translated">阿里巴巴科技</h1><p id="01dc" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">关于阿里巴巴最新技术的第一手深度资料→脸书:<a class="ae kc" href="http://www.facebook.com/AlibabaTechnology" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">“阿里巴巴科技”</strong> </a>。推特:<a class="ae kc" href="https://twitter.com/AliTech2017" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">【阿里巴巴技术】</strong> </a>。</p></div></div>    
</body>
</html>