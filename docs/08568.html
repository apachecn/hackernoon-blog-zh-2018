<html>
<head>
<title>A Practical solution for CORS (Cross-Origin Resource Sharing) issues in IONIC 3 and Cordova</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">IONIC 3和Cordova中CORS(跨源资源共享)问题的实用解决方案</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/a-practical-solution-for-cors-cross-origin-resource-sharing-issues-in-ionic-3-and-cordova-2112fc282664?source=collection_archive---------4-----------------------#2018-10-15">https://medium.com/hackernoon/a-practical-solution-for-cors-cross-origin-resource-sharing-issues-in-ionic-3-and-cordova-2112fc282664?source=collection_archive---------4-----------------------#2018-10-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="96e2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">总结</strong>:我在爱奥尼亚和科尔多瓦的<a class="ae jp" href="https://developer.apple.com/documentation/webkit/wkwebview" rel="noopener ugc nofollow" target="_blank"> WKWebView </a>提供了一个解决CORS问题的实用方案。该解决方案适用于iOS和Android。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/87ebaad2f75248131e5d7fa8011624cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:790/format:webp/1*2y5alP2GIBfE_kafgmWiDA.png"/></div><figcaption class="jy jz fg fe ff ka kb bd b be z ek">Image credit: <a class="ae jp" href="http://enzolutions.com/articles/2014/05/31/what-is-cross-origin-resource-sharing-cors/" rel="noopener ugc nofollow" target="_blank">http://enzolutions.com</a></figcaption></figure><p id="f9c8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您用Ionic或Cordova编码，并使用REST API，您可能会看到这样的错误:</p><p id="c858" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kc"> XMLHttpRequest无法加载</em><a class="ae jp" href="http://api.ionic.com/endpoint." rel="noopener ugc nofollow" target="_blank"><em class="kc">http://api.ionic.com/endpoint.</em></a><em class="kc">请求的资源上不存在“Access-Control-Allow-Origin”标头。因此，不允许访问源“http://localhost:8100”。</em></p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="fe ff kd"><img src="../Images/242381a6ca0a06d539b542d76e2b5da5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L0loa528XpCDIkpZHnPs8g.png"/></div></div></figure><h1 id="1c20" class="ki kj hu bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf dt translated">什么是CORS？</h1><p id="566f" class="pw-post-body-paragraph ir is hu it b iu lg iw ix iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo hn dt translated">CORS主张跨产地资源共享。简而言之，CORS是一种防止客户端向主机请求显示当前未显示的服务的方法。这样做是出于安全原因。</p><h2 id="b44e" class="ll kj hu bd kk lm ln lo ko lp lq lr ks jc ls lt kw jg lu lv la jk lw lx le ly dt translated">问题是</h2><p id="ac1f" class="pw-post-body-paragraph ir is hu it b iu lg iw ix iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo hn dt translated">为了让外部API服务器在CORS存在的情况下工作，它应该在它的头中包含类似这样的内容:</p><blockquote class="lz ma mb"><p id="e624" class="ir is kc it b iu iv iw ix iy iz ja jb mc jd je jf md jh ji jj me jl jm jn jo hn dt translated">访问控制允许来源:*</p></blockquote><p id="92fb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，问题是一些API提供者不包括这一点，因为我们对服务器没有任何控制，所以我们不能将这一点添加到响应头中。</p><p id="6366" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是一个巨大的问题，特别是在iOS中，Ionic和Cordova运行在<a class="ae jp" href="https://developer.apple.com/documentation/webkit/wkwebview" rel="noopener ugc nofollow" target="_blank"> WKWebView </a>中，这执行CORS。</p><h1 id="37d7" class="ki kj hu bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf dt translated">解决方法</h1><p id="3514" class="pw-post-body-paragraph ir is hu it b iu lg iw ix iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo hn dt translated">爱奥尼亚的博客有一篇关于CORS问题的旧文章。不幸的是，他们提供的解决方案仅适用于使用<code class="eh mf mg mh mi b">ionic serve</code>或<code class="eh mf mg mh mi b">ionic run -l</code>运行应用程序的情况。该解决方案将无法在生产版本中使用！</p><p id="fc44" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好消息是，你仍然可以通过做一点点工作来解决问题。我列出了几个解决方案:</p><ol class=""><li id="27ef" class="mj mk hu it b iu iv iy iz jc ml jg mm jk mn jo mo mp mq mr dt translated"><strong class="it hv">使用代理(不是一个好的解决方案):</strong>想法很简单:在客户端和主API服务器中间创建自己的服务器。您的客户端请求发送到您自己的支持CORS的服务器。您的服务器将请求发送到API服务器，获取结果，然后将结果发送给您。</li></ol><p id="5608" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您的服务器可以非常简单，只需从Google Firebase等数据库服务器读取来自特定节点的请求(如<strong class="it hv">/请求</strong>)，然后将结果写入另一个名为<strong class="it hv">/回复</strong>的节点。</p><p id="5a19" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">虽然这是可行的，但我不喜欢这个解决方案，因为你需要创建一个新的服务器并维护它。</p><p id="2134" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> 2。使用原生HTTP(我的最爱)</strong>:幸运的是Cordova的<a class="ae jp" href="https://github.com/silkimen/cordova-plugin-advanced-http" rel="noopener ugc nofollow" target="_blank">原生HTTP插件</a>来拯救了。由于这个插件的HTTP请求不通过WKWebView，它没有CORS问题。这太棒了。</p><p id="0787" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以解决方案是通过本地HTTP插件而不是NodeJS的请求来发送给定API的HTTP请求。因此:</p><p id="8270" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">解决方案:</strong>不用npm的<code class="eh mf mg mh mi b">Request</code>或者<code class="eh mf mg mh mi b">Fetch</code>包，用Cordova的插件。</p><p id="e364" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是一个使用Cordova的本地HTTP的币安REST API的使用示例:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ms mt l"/></div></figure><h1 id="f050" class="ki kj hu bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf dt translated">如果我们对API使用npm包装器会怎么样？</h1><p id="6e4a" class="pw-post-body-paragraph ir is hu it b iu lg iw ix iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo hn dt translated">上面的解决方案有效，因为我们使用了一个简单的REST HTTP调用。然而，有时API调用更复杂。例如，您必须提供APIKey和Secret并签署请求。</p><p id="579e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于这种复杂的请求，有一些npm包装器来完成这项工作并处理更复杂的问题，只是这些包使用npm的<code class="eh mf mg mh mi b">Request</code>或<code class="eh mf mg mh mi b">Fetch</code>包。</p><p id="0af5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">根据您使用的npm包装，有两种可能的情况:</p><h2 id="ce06" class="ll kj hu bd kk lm ln lo ko lp lq lr ks jc ls lt kw jg lu lv la jk lw lx le ly dt translated">1.<code class="eh mf mg mh mi b">Request</code>或<code class="eh mf mg mh mi b">Fetch</code>函数在构造函数中公开</h2><p id="614b" class="pw-post-body-paragraph ir is hu it b iu lg iw ix iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo hn dt translated">如果你幸运的话，一些npm包比如<a class="ae jp" href="https://www.npmjs.com/package/ccxt" rel="noopener ugc nofollow" target="_blank"> CCXT </a>已经允许你重载它们的获取请求功能。在这种情况下，您只需要将自己的HTTP Fetch包装器传递给它的构造函数:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ms mt l"/></div></figure><h2 id="ef26" class="ll kj hu bd kk lm ln lo ko lp lq lr ks jc ls lt kw jg lu lv la jk lw lx le ly dt translated">2.<code class="eh mf mg mh mi b">Request</code>或<code class="eh mf mg mh mi b">Fetch</code>函数没有在构造函数中公开</h2><p id="348a" class="pw-post-body-paragraph ir is hu it b iu lg iw ix iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo hn dt translated">但是如果你运气不好，Fetch请求函数并没有在构造函数中公开。例如，这里有一个<a class="ae jp" href="https://www.npmjs.com/package/binance" rel="noopener ugc nofollow" target="_blank">很棒的币安API </a>的npm包装器。但是它使用了npm的<code class="eh mf mg mh mi b">Request</code>包，导致了CORS问题，唉…</p><p id="3904" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这种情况下，解决方案并不太难:您只需要修改那个包，并强制它使用Cordova的<code class="eh mf mg mh mi b">Request</code>而不是npm的。</p><p id="9868" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">例如，我<a class="ae jp" href="https://github.com/ourarash/binance" rel="noopener ugc nofollow" target="_blank">修改了币安的npm包装器</a>，这样，它就从构造函数中获取了<code class="eh mf mg mh mi b">Request</code>函数，我将其设置为<code class="eh mf mg mh mi b">cordova.plugin.http.get</code>:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ms mt l"/></div></figure><p id="cf78" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">简而言之，如果您正在为REST API使用一个npm包装器，而该包装器没有在其构造函数中公开其HTTP请求函数:</p><ul class=""><li id="99e9" class="mj mk hu it b iu iv iy iz jc ml jg mm jk mn jo mu mp mq mr dt translated">在您自己的Github中创建Github上的包装器的一个分支</li><li id="fb21" class="mj mk hu it b iu mv iy mw jc mx jg my jk mz jo mu mp mq mr dt translated">修改该包并强制它使用Cordova HTTP请求</li><li id="c9e2" class="mj mk hu it b iu mv iy mw jc mx jg my jk mz jo mu mp mq mr dt translated">在你的Ionic程序中使用修改后的包</li></ul><p id="35b0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">警告是，如果npm包装器被更新，您将需要在您的分支中集成更新。但是也许您可以创建一个pull请求，并鼓励包所有者使用您的更新，并在构造函数中公开请求函数。</p></div><div class="ab cl na nb hc nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="hn ho hp hq hr"><p id="df41" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你喜欢这篇文章，请给我反馈，如果这个解决方案解决了你的问题。</p><p id="ab42" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">还有，请试试我用Ionic写的app:<a class="ae jp" href="http://BitcoinCrazYness.com" rel="noopener ugc nofollow" target="_blank">比特币疯狂</a>。这是针对加密货币交易者的最全面的警报和投资组合管理应用程序之一。</p></div></div>    
</body>
</html>