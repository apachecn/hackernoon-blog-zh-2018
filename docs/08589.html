<html>
<head>
<title>How to run custom application on SONM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在SONM上运行自定义应用程序</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-run-custom-application-on-sonm-caa6b7879f3c?source=collection_archive---------25-----------------------#2018-10-15">https://medium.com/hackernoon/how-to-run-custom-application-on-sonm-caa6b7879f3c?source=collection_archive---------25-----------------------#2018-10-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/681030e9a4204452823466b614e0fdb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xm5_jLJTygOyDFHx2FvKJg.png"/></div></div></figure><p id="e387" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这个小指南将帮助有经验的SONM用户在SONM供应商上运行定制应用程序。如果你对SONM一无所知，最好从阅读文件开始。</p><p id="71fe" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="kb">你需要通过</em> <a class="ae ka" href="https://docs.sonm.com/how-to/how-to-pass-kyc-by-cryptonomica" rel="noopener ugc nofollow" target="_blank"> <em class="kb"> KYC3 </em> </a> <em class="kb">，没有它你只能运行</em> <a class="ae ka" href="https://github.com/sonm-io/allowed-list" rel="noopener ugc nofollow" target="_blank"> <em class="kb">允许列表</em> </a> <em class="kb">中的任务。</em></p><p id="9c9b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">作为本指南的一个例子，我将使用<a class="ae ka" href="https://github.com/taskula/sonm-community-telegram-bot" rel="noopener ugc nofollow" target="_blank"> SONM社区电报机器人</a>，最后你应该能够在SONM上构建并运行它。</p><h1 id="3690" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">建立形象</h1><p id="5a2f" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">Docker有很棒的文档，你可以阅读这本<a class="ae ka" href="https://docs.docker.com/get-started/part2/" rel="noopener ugc nofollow" target="_blank">手册</a>来基本了解映像构建过程和<a class="ae ka" href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/" rel="noopener ugc nofollow" target="_blank">编写docker文件的最佳实践</a>。</p><p id="b881" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">那么，如果Docker拥有所有文档，我们为什么还需要这个指南呢？</p><p id="1579" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">是的，你可以在SONM上运行任何docker映像，但是如果他们使用命令行参数来配置应用程序运行时或者将参数传递给容器内部的deamon，那么你就不能使用它。SONM任务不接受来自命令行的参数，将参数传递到容器的唯一方法是使用<a class="ae ka" href="https://docs.docker.com/engine/reference/run/#env-environment-variables" rel="noopener ugc nofollow" target="_blank">环境变量</a>。</p><h2 id="4ee0" class="lf kd hu bd ke lg lh li ki lj lk ll km jn lm ln kq jr lo lp ku jv lq lr ky ls dt translated">Dockerfile文件</h2><p id="3fd5" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">Dockerfile包含了为你的应用程序准备环境的命令列表，你可以在这里安装任何你想要/需要的东西。</p><p id="8f12" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们的bot是用python编写的，所以我们将使用Docker Hub和pip中的python基础映像来安装所需的python库。</p><p id="ce2d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">以下是来自bot repo的Dockerfile:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="6269" class="lf kd hu ly b fv mc md l me mf">FROM python:3-slim<br/>WORKDIR /usr/src/app<br/>COPY . .<br/>RUN pip install python-telegram-bot seaborn pandas numpy scipy<br/>RUN chmod +x init.sh<br/>ENTRYPOINT ["./init.sh"]</span></pre><p id="7b10" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">正如我提到的，我们只能通过环境变量将参数传递给容器内部的应用程序，所以我们需要一些包装器将它们转换成命令行参数。</p><p id="5f45" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是什么意思？通常，要运行docker映像，您需要从命令行为应用程序设置参数，如下所示:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="9531" class="lf kd hu ly b fv mc md l me mf">$ docker run &lt;someimage&gt; [ARGS]</span></pre><p id="be73" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了让SONM能够做到这一点，我们可以编写简单的bash脚本，从环境中获取参数并将其附加到应用程序中。</p><p id="b6f0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">入口点bash脚本可能如下所示:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="1204" class="lf kd hu ly b fv mc md l me mf">#!/usr/bin/env bash<br/>exec python ./start.py "$COMMANDVAR"</span></pre><p id="cae9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，您可以向环境变量$COMMANDVAR添加参数，它们将作为命令行参数添加到应用程序中。</p><p id="15e1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要使用docker环境变量，您可以使用如下命令:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="8f6f" class="lf kd hu ly b fv mc md l me mf">$ docker run -e "COMMANDVAR=--verbose" &lt;someimage&gt;</span></pre><p id="a0d4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了简化示例脚本，它们没有任何输入验证，所以按原样使用可能不安全。</p><p id="4539" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们的bot不使用任何命令行参数，但需要在配置文件中设置电报令牌。以下是bot repo中的init.sh，它使用了环境中的$TOKEN变量:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="8e51" class="lf kd hu ly b fv mc md l me mf">#!/usr/bin/env bash<br/>if [ ! -z "$TOKEN" ]; then<br/>  echo "[+] Using provided Telegram token."<br/>  cat config/telegram.json.template|sed "s/ADD_BOT_TOKEN_HERE/$TOKEN/g" &gt; config/telegram.json<br/>else<br/>  echo "[-] No Telegram token provided."<br/>  exit 1<br/>fi<br/>exec python ./start.py</span></pre><h2 id="a1c4" class="lf kd hu bd ke lg lh li ki lj lk ll km jn lm ln kq jr lo lp ku jv lq lr ky ls dt translated">应用</h2><p id="f819" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated"><a class="ae ka" href="https://github.com/taskula/sonm-community-telegram-bot" rel="noopener ugc nofollow" target="_blank"> SONM社区电报机器人</a>包含所有必要的代码，所以你可以克隆这个回购协议，并进一步进行。</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="13b3" class="lf kd hu ly b fv mc md l me mf">$ git clone <a class="ae ka" href="https://github.com/taskula/sonm-community-telegram-bot" rel="noopener ugc nofollow" target="_blank">https://github.com/taskula/sonm-community-telegram-bot</a></span></pre><h2 id="4fe1" class="lf kd hu bd ke lg lh li ki lj lk ll km jn lm ln kq jr lo lp ku jv lq lr ky ls dt translated">建设</h2><p id="343d" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">构建过程与通常的docker映像相同。</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="7cf1" class="lf kd hu ly b fv mc md l me mf">$ cd sonm-community-telegram-bot<br/>$ docker build -t sonm-community-telegram-bot .</span></pre><h2 id="fedc" class="lf kd hu bd ke lg lh li ki lj lk ll km jn lm ln kq jr lo lp ku jv lq lr ky ls dt translated">奔跑</h2><p id="c75e" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">如果你想测试环境变量，你可以用-e标志来设置它们。</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="9d2b" class="lf kd hu ly b fv mc md l me mf">$ docker run -e TOKEN=YOUR_TOKEN_HERE sonm-community-telegram-bot</span></pre><h1 id="e5bb" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">码头枢纽</h1><p id="d41b" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">好了，我们已经建立了我们的映像，并且能够运行它，现在我们需要使它可以从外部访问。你可以设置你自己的<a class="ae ka" href="https://docs.docker.com/registry/" rel="noopener ugc nofollow" target="_blank">注册表</a>、Docker Hub或任何其他可用的注册表。</p><p id="6c3b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们将坚持使用<a class="ae ka" href="https://hub.docker.com" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>，这是最简单的方法，你可以使用公共或私人回购，任务文件都支持。</p><h2 id="8515" class="lf kd hu bd ke lg lh li ki lj lk ll km jn lm ln kq jr lo lp ku jv lq lr ky ls dt translated">登录Docker Hub</h2><p id="ba7f" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">如果您在Docker Hub上没有帐户，现在是时候注册一个了。拥有帐户后，您需要从命令行登录，只需运行:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="4840" class="lf kd hu ly b fv mc md l me mf">$ docker login</span></pre><h2 id="75d2" class="lf kd hu bd ke lg lh li ki lj lk ll km jn lm ln kq jr lo lp ku jv lq lr ky ls dt translated">标签构建</h2><p id="c9bb" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">在上传图片到Hub之前，我们需要标记它，我不会详细介绍这个过程，你可以在<a class="ae ka" href="https://medium.freecodecamp.org/an-introduction-to-docker-tags-9b5395636c2a" rel="noopener ugc nofollow" target="_blank">这里</a>阅读，所以我们将使用最基本的变化:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="83ce" class="lf kd hu ly b fv mc md l me mf">$ docker tag sonm-community-telegram-bot &lt;DockerHubLogin&gt;/sonm-community-telegram-bot</span></pre><h2 id="b1ef" class="lf kd hu bd ke lg lh li ki lj lk ll km jn lm ln kq jr lo lp ku jv lq lr ky ls dt translated">推送图像</h2><p id="523f" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">设置标签后，我们可以上传我们的图像，并继续编写SONM任务文件。</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="eb74" class="lf kd hu ly b fv mc md l me mf">$ docker push &lt;DockerHubLogin&gt;/sonm-community-telegram-bot</span></pre><h2 id="b939" class="lf kd hu bd ke lg lh li ki lj lk ll km jn lm ln kq jr lo lp ku jv lq lr ky ls dt translated">自动化构建</h2><p id="dd1b" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">如果你的项目在GitHub上是开源的，我建议你阅读Docker Hub上的<a class="ae ka" href="https://docs.docker.com/docker-hub/builds/" rel="noopener ugc nofollow" target="_blank">自动构建</a>，这将使构建新版image的过程更加容易。</p><h1 id="ff1a" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">运行任务</h1><p id="0ece" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated"><em class="kb">您必须有一个活动的交易才能运行任务，如果您对SONM任务文件一无所知，</em> <a class="ae ka" href="https://docs.sonm.com/how-to/manage-tasks" rel="noopener ugc nofollow" target="_blank"> <em class="kb">阅读此</em> </a> <em class="kb">。如果你不知道如何得到一笔交易</em> <a class="ae ka" href="https://docs.sonm.com/getting-started/as-a-consumer" rel="noopener ugc nofollow" target="_blank"> <em class="kb">读读这个</em> </a> <em class="kb">。</em></p><p id="a38e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们的应用程序非常简单，task.yaml看起来像:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="d539" class="lf kd hu ly b fv mc md l me mf">container:<br/>  image: &lt;DockerHubLogin&gt;/sonm-community-telegram-bot<br/>  env:<br/>    TOKEN: add_your_telegram_token_here</span></pre><p id="19ce" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="kb">这个任务文件并没有涵盖你可以设置的所有选项，但是你可以在</em> <a class="ae ka" href="https://github.com/sonm-io/core/blob/master/task.yaml" rel="noopener ugc nofollow" target="_blank"> <em class="kb">这个例子</em> </a>中找到。</p><p id="87a7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要运行此任务，您只需键入:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="f88b" class="lf kd hu ly b fv mc md l me mf">$ sonmcli task start &lt;dealID&gt; task.yaml</span></pre><h1 id="f111" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">摘要</h1><p id="c5ee" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">恭喜你，现在你知道如何在SONM上运行任何自定义应用程序了！</p><p id="63b5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你有任何问题，给我写信。</p></div></div>    
</body>
</html>