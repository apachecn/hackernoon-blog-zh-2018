<html>
<head>
<title>Private Python Package Repository</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">私有Python包存储库</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/custom-python-pypi-repository-409f14975374?source=collection_archive---------1-----------------------#2018-10-20">https://medium.com/hackernoon/custom-python-pypi-repository-409f14975374?source=collection_archive---------1-----------------------#2018-10-20</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/24166cbed70057871cfd3b26b4621924.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pnol9fwV56DKR9jbFonL1g.jpeg"/></div></div></figure><p id="e5f8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">默认情况下，Python从PyPI存储库中下载它的依赖项。它包含最新版本(可以是稳定的或不稳定的)和各种数量的软件包。我们很好，对吗？那么，定制私有包存储库的需求是什么呢？</p></div><div class="ab cl ka kb hc kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hn ho hp hq hr"><h2 id="86bb" class="kh ki hu bd kj kk kl km kn ko kp kq kr jn ks kt ku jr kv kw kx jv ky kz la lb dt translated"><strong class="ak">依赖关系管理</strong></h2><p id="8e4e" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">您可以显式地控制包的依赖关系，而不管版本弃用或最新的向后不兼容版本。当然，这可以通过在<em class="lh"> requirements.txt、</em>中定义版本来实现，但是为了确保我们得到的每个包都是我们所期望的，最好使用定制库。</p><h2 id="455d" class="kh ki hu bd kj kk kl km kn ko kp kq kr jn ks kt ku jr kv kw kx jv ky kz la lb dt translated">PyPI服务器不支持TLS v1.1版和1.0版</h2><p id="de23" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">PyPI服务器已经停止支持TLS 1.0 / TLS 1.1版本设备下载包。</p><blockquote class="li lj lk"><p id="5ce9" class="jc jd lh je b jf jg jh ji jj jk jl jm ll jo jp jq lm js jt ju ln jw jx jy jz hn dt translated">“我将考虑在截止日期前组织一些预定的TLSv1.0和TLSv1.1断电’活动，尝试帮助人们找到需要更新的地方。任何计划中的限电将在发生之前发布到status.python.org。”</p></blockquote><p id="069a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">因此<a class="ae lo" href="https://pyfound.blogspot.com/2017/01/time-to-upgrade-your-python-tls-v12.html" rel="noopener ugc nofollow" target="_blank">升级你的Python: TLS v1.2将很快成为强制性的</a>，现在它已经成为强制性的了。安装了Ubuntu 12.04或更低版本的设备安装了TLS v1.1，这意味着这些设备无法从默认的python包管理服务器下载任何python包。通过在终端中运行以下命令来检查您的TLS版本。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="1fec" class="kh ki hu lu b fv ly lz l ma mb">python2 -c "import urllib2,json; print(json.loads(urllib2.urlopen('https://www.howsmyssl.com/a/check').read())['tls_version'])"</span></pre><p id="bbad" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">有一些变通办法，比如明确地说PIP从PyPI服务器下载。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="e089" class="kh ki hu lu b fv ly lz l ma mb">pip install --index-url=<a class="ae lo" href="https://pypi.python.org/simple/" rel="noopener ugc nofollow" target="_blank">https://pypi.python.org/simple/</a> scapy</span></pre><p id="2340" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这在一段时间内有效(在限电期间)，然后它也不会发生作用。</p><figure class="lp lq lr ls fq iv fe ff paragraph-image"><div class="fe ff mc"><img src="../Images/e8126dceb307b76145677079b1ce7a79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1118/format:webp/1*M1bhPyIGRaB6lxrZ6FWe7g.png"/></div><figcaption class="md me fg fe ff mf mg bd b be z ek"><a class="ae lo" href="https://stackoverflow.com/questions/49943662/cannot-install-any-python-2-packages-using-pip-in-ubuntu-12-04-lts-precise-pang" rel="noopener ugc nofollow" target="_blank">Too many stack overflow questions!</a></figcaption></figure><p id="e672" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这里我们只有两个选择，升级TLS版本或使用自定义存储库。过了一段时间，升级TLS也变得不可能，因为你需要升级openssl和<strong class="je hv"> python加密模块</strong>。升级python模块是不可能的，所以我们陷入了死锁😕。这就是自定义存储库的用武之地！😃</p></div><div class="ab cl ka kb hc kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hn ho hp hq hr"><h1 id="6ed5" class="mh ki hu bd kj mi mj mk kn ml mm mn kr mo mp mq ku mr ms mt kx mu mv mw la mx dt translated">构建自定义存储库</h1><p id="d094" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">您需要以下东西来创建您自己的定制python库。</p><ol class=""><li id="73f1" class="my mz hu je b jf jg jj jk jn na jr nb jv nc jz nd ne nf ng dt translated">托管Ubuntu服务器</li><li id="e4c5" class="my mz hu je b jf nh jj ni jn nj jr nk jv nl jz nd ne nf ng dt translated">使用TLS v1.2版的Python环境</li><li id="a5fd" class="my mz hu je b jf nh jj ni jn nj jr nk jv nl jz nd ne nf ng dt translated">公有土地</li></ol><p id="c53e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">好吧，让我们把手弄脏😉</p><p id="76b2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先登录你的Ubuntu服务器，在requirements.txt文件中列出你需要的所有依赖项，如下所示</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="7d58" class="kh ki hu lu b fv ly lz l ma mb">boto3==1.4.4<br/>botocore==1.5.90<br/>click==3.1<br/>coloredlogs==8.0<br/>configobj==5.0.6<br/>docutils==0.13.1<br/>futures==3.1.1<br/>jmespath==0.9.3<br/>pexpect==3.1<br/>pyOpenSSL==0.15.1<br/>pyasn1==0.4.2<br/>pycrypto==2.6.1<br/>python-dateutil==2.6.1<br/>requests==2.5.3<br/>s3transfer==0.1.10<br/>scapy==2.4.0<br/>six==1.5.2<br/>speedtest-cli==2.0.0<br/>urllib3==1.7.1<br/>virtualenv==15.2.0<br/>websocket-client==0.16.0<br/>wheel==0.24.0<br/>ndg-httpsclient<br/>distribute<br/>pip==1.5.4</span></pre><p id="05d4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后创建Python虚拟环境来安装这些依赖项。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="9241" class="kh ki hu lu b fv ly lz l ma mb">pip install virtualenv<br/>virtualenv repo<br/>source repo/bin/activate<br/>mkdir /home/batman/py-cache</span></pre><p id="8893" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">虚拟环境中现有的pip版本应为<strong class="je hv"> 1.5.4 </strong>。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="c90a" class="kh ki hu lu b fv ly lz l ma mb">pip install -r requirements.txt --no-use-wheel --download="/home/batman/py-cache"</span></pre><p id="8006" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在已经把所有的包下载到了你的Ubuntu服务器上，我们需要把所有的包组织到一个标准的目录结构中，这样PIP客户端就可以识别模块了。为此，我写了一个小脚本，在py-cache目录下运行它，它将为您完成这项工作😃</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="1196" class="kh ki hu lu b fv ly lz l ma mb">import os<br/> <br/>for filename in os.listdir('/home/batman/py-cache'):<br/>    try:<br/>        package_name = filename.split('.')[0].split('-')<br/>        del package_name[-1]<br/>        package_name = '-'.join(map(str, package_name))<br/>        print package_name<br/>        os.system('mkdir %s' % package_name)<br/>        os.system('mv %s %s/' % (filename, package_name))<br/>    except Exception as e:<br/>        print 'ERROR: '<br/>        print 'e'</span></pre><p id="7dd7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">确保所有的包裹都被搬走了。如果没有移动任何东西，手动创建一个目录，并将tar文件移动到里面。我们快到了！让我们托管存储库。</p><p id="5cd7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首次安装托管客户端</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="86ed" class="kh ki hu lu b fv ly lz l ma mb">pip install twisted</span></pre><p id="827f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">默认情况下，主机从端口8080启动，确保没有其他进程拥有它。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="c68c" class="kh ki hu lu b fv ly lz l ma mb">lsof -i:8080</span></pre><p id="737d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">将您的终端放入<strong class="je hv"> py-cache </strong>目录</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="3c31" class="kh ki hu lu b fv ly lz l ma mb">twistd -n web --path .</span></pre><p id="6050" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">就是这样！👏您已经构建了自己的定制库，现在它托管在您的Ubuntu服务器的端口8080中。</p></div><div class="ab cl ka kb hc kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hn ho hp hq hr"><h2 id="7c70" class="kh ki hu bd kj kk kl km kn ko kp kq kr jn ks kt ku jr kv kw kx jv ky kz la lb dt translated">向PIP客户告知我们的自定义存储库</h2><p id="a306" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">在你的客户身上，</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="9d8c" class="kh ki hu lu b fv ly lz l ma mb">vim /etc/pip.conf</span></pre><p id="abee" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">添加您的自定义存储库URL</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="c432" class="kh ki hu lu b fv ly lz l ma mb">[global]<br/>index-url = <a class="ae lo" href="http://10.1.10.69:8080" rel="noopener ugc nofollow" target="_blank">http://10.1.10.69:8080</a></span></pre><p id="db65" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后导出一个环境变量PIP_CONFIG_FILE。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="fd7b" class="kh ki hu lu b fv ly lz l ma mb">export PIP_CONFIG_FILE=/etc/pip.conf</span></pre><p id="40ef" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">就是这样。现在，通常的pip安装如下，将从您的自定义库安装python包。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="24b2" class="kh ki hu lu b fv ly lz l ma mb">pip install scappy</span></pre></div><div class="ab cl ka kb hc kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hn ho hp hq hr"><p id="ce83" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这里，您可以完全控制需要提供的依赖项，以及需要验证和禁止哪些客户端。我希望我已经和你们分享了有用的信息。</p><p id="e6fb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">干杯🍻</p><p id="c4be" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">编码快乐！</p></div></div>    
</body>
</html>