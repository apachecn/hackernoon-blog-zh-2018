<html>
<head>
<title>a few tips for storing secrets using aws parameter store</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用aws参数存储存储机密的一些技巧</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/a-few-tips-for-storing-secrets-using-aws-parameter-store-f03557c5cf1b?source=collection_archive---------2-----------------------#2018-10-20">https://medium.com/hackernoon/a-few-tips-for-storing-secrets-using-aws-parameter-store-f03557c5cf1b?source=collection_archive---------2-----------------------#2018-10-20</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/4bda77285ef3fc575d24a401ab38c0f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a9BorEgKumW-EYAiL79MyQ.jpeg"/></div></div></figure><div class=""/><p id="b20b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我目前的工作中，我们有50多种服务，大约6个以上的环境，以及服务和人类在我们的环境中使用的大约3.5k个参数。我们曾经使用Vault，但是在使用了一年之后，我们最终决定使用Parameter Store，因为我们是在AWS上托管的。参数存储对我们来说是一个明显的赢家，因为它通过利用IAM策略和KMS密钥为我们提供了我们想要的所有安全性。而且…我不需要自己跑跳马。</p><p id="cd18" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您正在考虑迁移东西，或者已经开始使用Param Store，这里有一些我使用Param Store管理秘密的经验。</p><h1 id="0285" class="ka kb if bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">使用CLI搜索参数</h1><p id="31ff" class="pw-post-body-paragraph jc jd if je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">一个非常恼人的问题是，我不能轻松地在整个参数库中搜索参数。如果你尝试过使用UI来做这件事，那么在使用正则表达式和/或路径进行搜索之间会有些痛苦。例如，我不能搜索所有以“db_”开头的参数，即<code class="eh ld le lf lg b">*db_*</code></p><p id="f97d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一个有用的解决方法—对参数存储进行快速搜索*。这需要获取所有的参数——但是允许您在可用的路径上应用普通的正则表达式，这在UI中是做不到的。*它有点慢，但可以让你快速预览你可用的秘密</p><pre class="lh li lj lk fq ll lg lm ln aw lo dt"><span id="7e8a" class="lp kb if lg b fv lq lr l ls lt">&gt; aws ssm describe-parameters \<br/> --output text \<br/> | egrep '^PARAMETERS' \ <br/> | awk '{print $5}' \<br/> | egrep $REGEX </span><span id="28a5" class="lp kb if lg b fv lu lr l ls lt">/dev/myApp/foo <br/>/dev/myApp/bar <br/>...</span></pre><p id="5822" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">可能有更好的方法。</p><h1 id="ea53" class="ka kb if bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">将您的数据库连接参数放在一起</h1><p id="8821" class="pw-post-body-paragraph jc jd if je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">尽量避免将数据库凭证分散在参数存储中的不同键中，并将它们放在一起。审计哪些用户/角色访问了凭证更容易，因为只有一个地方可以获取凭证。</p><pre class="lh li lj lk fq ll lg lm ln aw lo dt"><span id="a163" class="lp kb if lg b fv lq lr l ls lt">/$env/databases/$appDb/host      = mydb.somewhereinaws.com<br/>                      /user      = read-only<br/>                      /password  = 'a good password'<br/>                      /port      = 5432<br/>                      /dbname    = 'orders'<br/>                      /scheme    = 'postgres'</span><span id="e423" class="lp kb if lg b fv lu lr l ls lt">connection_string = $scheme://$user:$password@$host:$port/$dbname</span></pre><p id="fb22" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这将允许您通过IAM策略控制谁有权访问哪些数据库集。您还可以编写脚本，让它自动让您登录数据库，而无需查看密码。这里有一个在bash中如何实现的例子</p><pre class="lh li lj lk fq ll lg lm ln aw lo dt"><span id="d868" class="lp kb if lg b fv lq lr l ls lt">dbInfo=$(aws ssm get-parameters \<br/> --names "/dev/dbs/$dbName/database" \<br/> "/dev/dbs/$dbName/host" \<br/> "/dev/dbs/$dbName/password" \<br/> "/dev/dbs/$dbName/port" \<br/> "/dev/dbs/$dbName/user" \<br/> "/dev/dbs/$dbName/scheme" \<br/> --region $REGION \<br/> --with-decryption \ <br/> --query Parameters[*].Value \<br/> --output text | tr "\t" " ") </span><span id="37e7" class="lp kb if lg b fv lu lr l ls lt">database="${dbInfo[0]}"<br/>database_host="${dbInfo[1]}"<br/>database_pass="${dbInfo[2]}"<br/>database_port="${dbInfo[3]}"<br/>database_scheme="${dbInfo[4]}"<br/>database_user="${dbInfo[5]}"</span><span id="77e5" class="lp kb if lg b fv lu lr l ls lt">if [ "$database_scheme" = "mysql" ]; then <br/>  MYSQL_PWD=$database_pass mysql -h $database_host -P $listen_port -u $database_user $database_database <br/>else <br/>  PGPASSWORD=$database_pass psql -h $database_host -p $listen_port -U $database_user -d $database_database <br/>fi</span></pre><h1 id="234b" class="ka kb if bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">坚持命名惯例</h1><p id="599f" class="pw-post-body-paragraph jc jd if je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">这是我们用于我们的参数的约定，已经调整好了。</p><pre class="lh li lj lk fq ll lg lm ln aw lo dt"><span id="1e78" class="lp kb if lg b fv lq lr l ls lt">/$environment_name/databases/$database_name/{host,port,pass,user} <br/>                  /databags/$service_name/{all,my,server,creds}<br/>                  /other_sensitive_info/{foo,bar,baz}</span></pre><p id="0ac4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们用厨师烹饪书&amp;加密的数据标签从我们的日子里借来了<code class="eh ld le lf lg b">databags</code>。这基本上意味着在属于一个服务的键下有一堆参数。</p><p id="2444" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这让我们可以通过IAM策略在几个不同的维度上确定访问范围。我们可以说，在dev环境中，开发人员应该可以访问数据库机密，但在prod中只能访问服务机密。</p><pre class="lh li lj lk fq ll lg lm ln aw lo dt"><span id="f6b1" class="lp kb if lg b fv lq lr l ls lt">{ <br/>  "Effect": "Allow", <br/>  "Action": [ "ssm:GetParameters" ], <br/>  "Resource": [ <br/>    "arn:aws:ssm:us-east-2:xxxx:parameter/dev/databases/*",<br/>    "arn:aws:ssm:us-east-2:xxxx:parameter/prod/databags/myService/*"<br/>  ] <br/>}<!-- --> </span></pre><h1 id="2441" class="ka kb if bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">你不能把大项目塞进参数里</h1><p id="d70b" class="pw-post-body-paragraph jc jd if je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">我们曾经使用证书指南在我们的主机上安装证书，这要求我们以这种格式保存我们的证书</p><pre class="lh li lj lk fq ll lg lm ln aw lo dt"><span id="402b" class="lp kb if lg b fv lq lr l ls lt">{ <br/>  "id": "mail", <br/>  "cert": "-----BEGIN CERTIFICATE-----\nMail Certificate Here...", <br/>  "key": "-----BEGIN PRIVATE KEY\nMail Private Key Here...", <br/>  "chain": "-----BEGIN CERTIFICATE-----\nCA Root Chain Here..." <br/>}</span></pre><p id="d421" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是由于4096个字符的<a class="ae lv" href="https://docs.aws.amazon.com/systems-manager/latest/APIReference/API_Parameter.html" rel="noopener ugc nofollow" target="_blank">大小限制</a>，您不能将它作为json填充到参数中。当您迁移机密时，这更麻烦，但是很容易解决。不幸的是，它将要求你更新一些脚本，这些脚本需要以前的秘密格式。</p><h1 id="9db9" class="ka kb if bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">使用标签/指针帮助您轮换密码</h1><p id="4e40" class="pw-post-body-paragraph jc jd if je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">密码轮换是一个固有的难题，但是一个策略是使用指向秘密的指针(或者他们现在称之为标签)。例如，假设您想要轮换一个加密密钥，但是有多个服务依赖于它。</p><p id="2c5b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以这样定义您的结构:</p><pre class="lh li lj lk fq ll lg lm ln aw lo dt"><span id="8ebf" class="lp kb if lg b fv lq lr l ls lt">/dev/databags/my-key/current = 2 (index of actual secret) <br/>                    /1       = 'secret 2018' <br/>                    /2       = 'secret 2019'</span></pre><p id="9228" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您的应用程序需要知道如何跟随来自<code class="eh ld le lf lg b">current </code>的指针并读取想要的秘密。从那里，您必须重新生成一个配置文件并退回您的服务。</p><p id="4c6d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">幸运的是，<a class="ae lv" href="https://aws.amazon.com/blogs/mt/use-parameter-labels-for-easy-configuration-update-across-environments/" rel="noopener ugc nofollow" target="_blank">你现在可以在AWS </a>上通过参数标签来实现。<br/>使用Lambda和Secrets Manager也可以完成旋转密码<a class="ae lv" href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/rotating-secrets-lambda-function-overview.html" rel="noopener ugc nofollow" target="_blank">——点击这里查看这个演练</a></p><h1 id="9ad2" class="ka kb if bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">param store保留参数的版本，但如果您删除它们，则不会</h1><p id="795f" class="pw-post-body-paragraph jc jd if je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">文档表明参数是版本化的，并且当它们存在时它们是版本化的。但是如果你不小心删除了一个参数，历史记录也随之消失了。</p><p id="49f8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">共识似乎是你应该把你的参数存储数据库导出到S3或者Dynamodb，但是我还没有碰到过这个领域的工具。</p><h1 id="1d24" class="ka kb if bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">一些支持参数存储的相关工具</h1><p id="342f" class="pw-post-body-paragraph jc jd if je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">秘密地将秘密输出到你的环境中，用python写的—<a class="ae lv" href="https://github.com/energyhub/secretly" rel="noopener ugc nofollow" target="_blank">https://github.com/energyhub/secretly</a></p><p id="56b6" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">parameter-store-exec —类似secretly，用go写的。—<a class="ae lv" href="https://github.com/cultureamp/parameter-store-exec" rel="noopener ugc nofollow" target="_blank">https://github.com/cultureamp/parameter-store-exec</a></p><p id="667c" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">放入配置文件的confd—<a class="ae lv" href="https://github.com/kelseyhightower/confd" rel="noopener ugc nofollow" target="_blank">https://github.com/kelseyhightower/confd</a></p><p id="b4e4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">作为咨询模板的一部分—<a class="ae lv" href="https://github.com/hellofresh/consul-template-plugin-ssm" rel="noopener ugc nofollow" target="_blank">https://github.com/hellofresh/consul-template-plugin-ssm</a></p><p id="9048" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">包括参数库在内的密室管理—<a class="ae lv" href="https://github.com/segmentio/chamber" rel="noopener ugc nofollow" target="_blank">https://github.com/segmentio/chamber</a></p></div><div class="ab cl lw lx hc ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hn ho hp hq hr"><p id="748b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="md">原载于2018年10月20日</em><a class="ae lv" href="https://www.intricatecloud.io/2018/10/a-few-lessons-learned-using-aws-parameter-store/" rel="noopener ugc nofollow" target="_blank"><em class="md">www . intra cide cloud . io</em></a><em class="md">。</em></p></div></div>    
</body>
</html>