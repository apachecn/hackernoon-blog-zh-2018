<html>
<head>
<title>Reflecting on Building Real-time APIs at Facebook</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在脸书建立实时API的思考</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/reflecting-on-building-real-time-apis-at-facebook-6089f4b7de56?source=collection_archive---------10-----------------------#2018-10-29">https://medium.com/hackernoon/reflecting-on-building-real-time-apis-at-facebook-6089f4b7de56?source=collection_archive---------10-----------------------#2018-10-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/94b71f60eac6db8dbd71d9e42269ad43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aMcJFqbZBFTNDI83sBvLmw.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Real-time APIs stream data from the server to the client over a persistent connection</figcaption></figure><p id="882d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">免责声明:我已经不在脸书工作了。这些意见都是我一个人的。</p><p id="0fa4" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">上个月，我花了一些时间反思我在脸书构建实时API时所学到的东西。一个有用的技术脱颖而出:<em class="ke">首先构建空API</em>。</p><p id="8b4f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">考虑一个新HTTP API的空端点，它返回状态代码200和一个空主体。使用null 200 API，客户端可以:</p><ul class=""><li id="14c8" class="kf kg hu ji b jj jk jn jo jr kh jv ki jz kj kd kk kl km kn dt translated">检查网络连接</li><li id="2e14" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">测量延迟</li><li id="5178" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">验证访问令牌</li><li id="a78b" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">测试SSL证书</li><li id="34a3" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">测试中间缓存层</li></ul><p id="4a1c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">客户端还可以检测和处理各种故障情况:</p><ul class=""><li id="b0d9" class="kf kg hu ji b jj jk jn jo jr kh jv ki jz kj kd kk kl km kn dt translated">网络不可用(飞行模式)</li><li id="a928" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">DNS查找失败</li><li id="0615" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">请求超时(重试请求？)</li><li id="5e59" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">洪水响应(503)</li></ul><p id="ebaf" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">注意，我们没有提到<em class="ke">应用数据</em>。这才是重点。工程团队通常首先关注<em class="ke">功能需求</em>，其次关注<em class="ke">、</em>和<em class="ke">非功能需求</em>。通过省略<em class="ke">应用数据</em>，空API技术迫使我们向后工作，首先面对<em class="ke">非功能性</em>需求。</p><p id="02da" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">至于<em class="ke">流空API </em>，我们需要通过讨论流和请求/响应的区别来建立基础。在流式API中，客户端打开到服务器的<em class="ke">持久连接</em>，该持久连接可以是实际的持久连接(例如WebSocket)或模拟连接(例如HTTP长轮询)。在这个连接的生命周期中，服务器选择何时将数据推送到客户端。</p><p id="5284" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">虽然请求/响应API可以是有状态的或无状态的，但是流式API总是有状态的。例如，在聊天应用中，服务器需要存储至少三种状态:</p><ol class=""><li id="2b00" class="kf kg hu ji b jj jk jn jo jr kh jv ki jz kj kd kt kl km kn dt translated">用户加入了哪些聊天室？</li><li id="9061" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kt kl km kn dt translated">客户端收到的最后一条消息是什么？(如果我们想要连贯的对话)</li><li id="eec6" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kt kl km kn dt translated">哪个持久连接会将数据传送给正确的用户？</li></ol><p id="e68a" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">像HTTP这样的无状态应用层协议有极端的健忘症。他们只记得单个请求/响应的必要内容。相比之下，实时API在<a class="ae ku" href="https://en.wikipedia.org/wiki/OSI_model#Layer_7:_Application_Layer" rel="noopener ugc nofollow" target="_blank">应用协议层</a>也是有状态的。也就是说，他们必须记得过去发生的事情。例如，实时协议经常依赖于<a class="ae ku" href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern" rel="noopener ugc nofollow" target="_blank">发布者-订阅者模式</a>(例如<a class="ae ku" href="https://en.wikipedia.org/wiki/MQTT" rel="noopener ugc nofollow" target="_blank"> MQTT </a>和<a class="ae ku" href="https://redis.io/topics/protocol" rel="noopener ugc nofollow" target="_blank"> Redis </a>)，其中<em class="ke">取消订阅</em>请求可能仅在它跟随对同一频道名称的<em class="ke">订阅</em>请求时才有效。</p><p id="2c7c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">大规模处理这种状态极具挑战性。首先:服务器必须在一致性、可用性、分区容忍度(<a class="ae ku" href="https://en.wikipedia.org/wiki/CAP_theorem" rel="noopener ugc nofollow" target="_blank"> CAP定理</a>)、持久性和延迟之间做出权衡。第二:某些类型的状态，如聊天室成员，必须在网络上同步。如果客户端和服务器对当前用户的聊天室设置意见不一致，结果要么是用户体验不佳，要么是资源泄露。不幸的是，<a class="ae ku" href="https://en.wikipedia.org/wiki/Two_Generals%27_Problem" rel="noopener ugc nofollow" target="_blank">状态同步很难</a>。第三:客户端缓存通常不具备处理实时数据流的能力。</p><p id="0957" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">一个客户端需要多少个持久连接？“一”似乎是显而易见的答案。但是，如果这个单一的持久连接断开，共享该连接的所有数据流将同时断开。话又说回来，也许多重持续连接也不会好到哪里去，比如你的手机进入了一个盲区。关键是，实时API比请求/响应API复杂得多，部分原因是它们在应用协议层和传输层都是有状态的。</p><p id="0cb6" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">有了这些概念，我们就可以为空流API建模了:一个API，客户端打开一个到服务器的持久连接，但是服务器不推送应用数据。客户可以使用这样的API来预测各种各样的成功和失败案例:</p><p id="7b94" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">成功案例:</p><ul class=""><li id="0924" class="kf kg hu ji b jj jk jn jo jr kh jv ki jz kj kd kk kl km kn dt translated">到达服务器(网络可用，DNS解析，服务器证书合法)</li><li id="1cb9" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">创建持久连接</li><li id="bc85" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">通过持久连接发出请求</li><li id="e39a" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">检测服务器启动的流终止(流结束)</li><li id="7e51" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">关闭溪流</li><li id="1646" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">关闭持久连接</li><li id="7c6f" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">暂停流</li></ul><p id="2cac" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">失败案例:</p><ul class=""><li id="1c88" class="kf kg hu ji b jj jk jn jo jr kh jv ki jz kj kd kk kl km kn dt translated">无法创建永久连接(传输层):网络不可用、DNS查找失败、请求超时、证书错误、访问令牌错误</li><li id="6b9c" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">无法创建数据流(协议级别):未经验证、未经授权、无效请求、泛洪响应</li><li id="638d" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">连接中断:服务器减载、服务器网关节点故障</li><li id="c843" class="kf kg hu ji b jj ko jn kp jr kq jv kr jz ks kd kk kl km kn dt translated">流中断:连接中断(如上)</li></ul><p id="5524" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">流/连接中断的情况特别有趣。被中断的流不可能产生数据，但中断可能发生在传输层和协议层。如果该流向客户端提供重要数据(例如，多人游戏中的玩家健康)，让用户知道发生了什么是很重要的:“嘿，你落后了，坚持住！”。</p><p id="6ea7" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这个非功能性情况的列表显然不是详尽的，但是它已经显示了当处理边缘情况时，客户需要多聪明。通过首先构建这样的API，团队可以在构建运行于不可靠网络(如移动网络)上的应用程序时，发现并设计最佳的用户体验。</p><p id="d5e1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如果你已经成功地使用了一些null API技术的变体，或者你知道更好的方法，我很乐意在评论中听到你的意见！</p></div></div>    
</body>
</html>