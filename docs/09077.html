<html>
<head>
<title>Microservices monitoring with Envoy service mesh, Prometheus &amp; Grafana</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Prometheus &amp; Grafana使用Envoy service mesh进行微服务监控</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/microservices-monitoring-with-envoy-service-mesh-prometheus-grafana-a1c26a8595fc?source=collection_archive---------3-----------------------#2018-11-03">https://medium.com/hackernoon/microservices-monitoring-with-envoy-service-mesh-prometheus-grafana-a1c26a8595fc?source=collection_archive---------3-----------------------#2018-11-03</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="618f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你是“服务网格”和“特使”的新手，我有一篇文章解释这两者<a class="ae jp" rel="noopener" href="/@dnivra26/service-mesh-with-envoy-101-e6b2131ee30b">在这里</a>。</p><p id="a296" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是<strong class="it hv">观察特使服务网格</strong>系列的第二篇文章，你可以在这里阅读关于分布式追踪<a class="ae jp" rel="noopener" href="/@dnivra26/distributed-tracing-with-envoy-service-mesh-jaeger-c365b6191592">的第一篇文章。</a></p><p id="d1d1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于微服务，在监控方面你不可能一无所知，你至少需要知道有什么地方出错了。</p><p id="77f3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们看看Envoy如何帮助我们获得一些关于我们的服务的信息。对于服务网格，所有流量都通过网格，这意味着没有服务直接与其他服务对话，服务调用特使，特使将调用路由到目标服务，因此特使将有关于传入和传出流量的上下文。特使通常提供关于<a class="ae jp" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http_conn_man/stats" rel="noopener ugc nofollow" target="_blank">传入</a>请求、<a class="ae jp" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/cluster_manager/cluster_stats" rel="noopener ugc nofollow" target="_blank">传出</a>请求和特使实例的<a class="ae jp" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/statistics" rel="noopener ugc nofollow" target="_blank">状态的度量。</a></p><h2 id="8623" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">设置</h2><p id="4b7d" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">这是我们试图构建的内容的概述</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff kq"><img src="../Images/0f904830d2328030168ce911e57b54b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LNwynEwlXIOOo2tUZWxJWA.png"/></div></div><figcaption class="lc ld fg fe ff le lf bd b be z ek">overall setup</figcaption></figure><h2 id="9596" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">Statsd</h2><p id="f92a" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">Envoy支持以2或3种格式发布指标，但是对于这篇文章，我们将使用<a class="ae jp" href="https://github.com/b/statsd_spec" rel="noopener ugc nofollow" target="_blank"> statsd </a>格式。</p><p id="5a7b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">也就是说，流程将是，Envoy将指标推送到statsd，我们将使用<a class="ae jp" href="https://github.com/prometheus" rel="noopener ugc nofollow" target="_blank"> prometheus </a>(一个时间序列数据库)从statsd提取指标，然后我们将使用<a class="ae jp" href="https://github.com/grafana/grafana" rel="noopener ugc nofollow" target="_blank"> grafana </a>可视化指标。</p><p id="2e50" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们的设置图中，我提到了statsd exporter而不是statsd，这是有原因的，我们不会有这样的statsd，我们将有一个转换器(服务),它将接受statsd格式的数据并以prometheus格式公开它。帮我们完成任务。</p><p id="7567" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">特使的衡量标准主要可以分为两类</p><ol class=""><li id="1d3e" class="lg lh hu it b iu iv iy iz jc li jg lj jk lk jo ll lm ln lo dt translated">计数器:一个不断增长的度量。例如:请求总数</li><li id="04a6" class="lg lh hu it b iu lp iy lq jc lr jg ls jk lt jo ll lm ln lo dt translated">度量:可以上升或下降的度量，就像即时值一样。例如:当前CPU利用率</li></ol><p id="48ad" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们来看一个带有stats sink的特使配置</p><figure class="kr ks kt ku fq kv"><div class="bz el l di"><div class="lu lv l"/></div><figcaption class="lc ld fg fe ff le lf bd b be z ek">Envoy configuration with stats sink</figcaption></figure><p id="1938" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">第8–13行告诉Envoy我们需要statsd格式的指标，我们的stats的前缀是什么(通常是您的服务名)以及我们的statsd接收器所在的位置</p><p id="57c2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">第55–63行在我们的环境中配置statsd接收器</p><p id="8593" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就是从Envoy获取统计数据所需的全部配置。现在，如果您查看第2–7行，有两件事情正在发生</p><ol class=""><li id="4e3d" class="lg lh hu it b iu iv iy iz jc li jg lj jk lk jo ll lm ln lo dt translated">Envoy在端口9901上公开了一个管理端点，您可以使用它来动态更改日志级别、查看当前配置、统计信息等..</li><li id="04ca" class="lg lh hu it b iu lp iy lq jc lr jg ls jk lt jo ll lm ln lo dt translated">Envoy还可以生成类似nginx的访问日志，你可以用它来了解你的流量。访问日志的格式也是可配置的，第29–33行就是这样做的</li></ol><p id="c120" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您需要将相同的stats配置添加到我们系统中服务的另一个侧车特使(是的，每个服务都有自己的特使侧车)。</p><p id="edc2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">服务本身是用go编写的，除了通过Envoy调用其他服务之外，它们不做太多事情。你可以在这里查看服务和特使配置。</p><p id="bff8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，现在我们只有statsd exporter，这样，如果我们运行docker容器(docker-compose build &amp; docker-compose up)并向前端Envoy(localhost:8080)发送一些流量，Envoy将开始向我们的statsd exporter发送有关流量的指标，后者会将指标转换为prometheus格式并在端口9102中公开。</p><p id="1bc5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是statsd exporter中的统计信息</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff lw"><img src="../Images/372f03f06d9da66052d2d5740af4e772.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0b9lt28ByD3-bt52Wy7XiQ.png"/></div></div><figcaption class="lc ld fg fe ff le lf bd b be z ek">metrics from statsd exporter in prometheus format</figcaption></figure><p id="4915" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将有数百个统计数据，在上面的屏幕截图中，我们看到了服务A和服务b之间通信的延迟指标。上图中的指标采用了普罗米修斯格式</p><pre class="kr ks kt ku fq lx ly lz ma aw mb dt"><span id="b0a0" class="jq jr hu ly b fv mc md l me mf">metric_name ["{" label_name "=" `"` label_value `"` { "," label_name "=" `"` label_value `"` } [ "," ] "}"] value [ timestamp ]</span></pre><p id="e6d0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以在这里了解更多关于<a class="ae jp" href="https://github.com/prometheus/docs/blob/master/content/docs/instrumenting/exposition_formats.md" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><h2 id="6398" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">普罗米修斯</h2><p id="09a6" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">我们将使用<a class="ae jp" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a>作为我们的时间序列数据库来存储我们的指标。Prometheus不仅仅是一个时间序列数据库，它本身也是一个监控系统，但是在我们的设置中，我们将使用它作为度量的数据存储。需要注意的一件重要事情是，prometheus是一个基于拉动的系统，这意味着您必须告诉prometheus从哪里获取指标，在我们的情况下，它将是我们的statsd导出器。</p><p id="c16a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将prometheus添加到等式中非常简单，我们只需要将scrape目标(statsd exporter)作为配置文件传递给prometheus。这是配置的样子</p><figure class="kr ks kt ku fq kv"><div class="bz el l di"><div class="lu lv l"/></div><figcaption class="lc ld fg fe ff le lf bd b be z ek">prometheus configuration to scrape from statsd exporter</figcaption></figure><p id="04ee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">scrape_interval是prometheus从目标获取配置的频率。</p><p id="b9cb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以现在我们应该有普罗米修斯了，也有一些数据在普罗米修斯里。让我们启动locahost:9090，看看它有什么</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff mg"><img src="../Images/6dd53563104a70c256e35fa03690b0f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6yNrX39YPEc9VYNzt7wviw.png"/></div></div><figcaption class="lc ld fg fe ff le lf bd b be z ek">prometheus query page</figcaption></figure><p id="9a68" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如我们所见，我们的指标是可用的。你可以做的不仅仅是选择现有的指标，你可以在这里阅读普罗米修斯查询语言<a class="ae jp" href="https://prometheus.io/docs/prometheus/latest/querying/basics/" rel="noopener ugc nofollow" target="_blank"/>。它还可以根据我们的查询绘制图表。还有一个警报系统。</p><p id="f59f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果我们在prometheus中加载目标页面，我们会看到所有的刮擦目标以及这些目标的健康状况</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff mh"><img src="../Images/1773298c415caacf4ea32a410548b267.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QeLWV5kTludeMncBjxelZw.png"/></div></div><figcaption class="lc ld fg fe ff le lf bd b be z ek">prometheus targets</figcaption></figure><h2 id="3310" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">格拉夫纳</h2><p id="6318" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">Grafana是一个很棒的可视化和监控解决方案，支持很多后端，如Prometheus，Graphite，InfluxDB，ElasticSearch等...</p><p id="0084" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Grafana有两个我们需要配置的主要组件</p><ol class=""><li id="9ee5" class="lg lh hu it b iu iv iy iz jc li jg lj jk lk jo ll lm ln lo dt translated">data source:grafana将从中获取指标的后端。您可以使用如下所示的配置文件来配置数据源</li></ol><figure class="kr ks kt ku fq kv"><div class="bz el l di"><div class="lu lv l"/></div><figcaption class="lc ld fg fe ff le lf bd b be z ek">configuring prometheus as a datasource in grafana</figcaption></figure><p id="7ae3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">2.仪表板:这是您可视化来自数据源的指标的地方。Grafana支持各种各样的可视化元素，如图表、单个统计数据、热图等……你可以扩展它，并使用插件构建自己的元素。</p><p id="2be6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我对Grafana的唯一问题是，没有将这些仪表板开发成代码的标准方法。有一些第三方库支持这个，我们将使用来自weaveworks的一个名为<a class="ae jp" href="https://github.com/weaveworks/grafanalib" rel="noopener ugc nofollow" target="_blank">的grafanalib </a>。</p><p id="b885" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是我们试图构建的用python代码表示的仪表板</p><figure class="kr ks kt ku fq kv"><div class="bz el l di"><div class="lu lv l"/></div><figcaption class="lc ld fg fe ff le lf bd b be z ek">Grafana dashboard as code using grafanalib</figcaption></figure><p id="bcc3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们正在构建2xx、5xx和延迟的图表。第5–22行很重要，它提取我们的设置中可用的服务名作为grafana变量，它使我们的仪表板动态化，这意味着我们将能够选择我们想要查看这些统计数据的源和目标服务。更多关于变量<a class="ae jp" href="http://docs.grafana.org/reference/templating/" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="cfea" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您必须使用grafanalib命令从上面的python文件生成仪表盘</p><pre class="kr ks kt ku fq lx ly lz ma aw mb dt"><span id="c89a" class="jq jr hu ly b fv mc md l me mf">     generate-dashboard -o dashboard.json service-dashboard.py</span></pre><p id="9aa7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当心生成的dashboard.json不容易阅读。</p><p id="f698" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以我们只需要在启动Grafana时传递仪表板和数据源。当你访问http:localhost:3000时，你会看到:</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff mi"><img src="../Images/251c74963480575014c4039a787e6756.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sc3BzzP2BxrukficRUTaMg.png"/></div></div><figcaption class="lc ld fg fe ff le lf bd b be z ek">grafana dashboard</figcaption></figure><p id="3f9c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就是您的2xx、5xx和延迟图表，您还可以看到下拉菜单，从中可以选择源和目标服务。grafana有比我们讨论的更多的功能，它有一个强大的查询编辑器，一个警报系统。更重要的是，使用插件和应用程序，一切都是可扩展的，在这里查看一个例子<a class="ae jp" href="https://github.com/grafana/kubernetes-app" rel="noopener ugc nofollow" target="_blank"/>。如果您正在可视化redis、rabbitmq等常见服务的指标..Grafana有一个<a class="ae jp" href="https://grafana.com/dashboards" rel="noopener ugc nofollow" target="_blank">公共仪表盘</a>库，你可以从那里导入并使用它们。Grafana的另一个好处是，您可以用配置文件和代码创建和管理一切，而无需过多地使用UI。</p><p id="be4a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我强烈建议你和普罗米修斯和格拉夫纳一起玩，找出更多的答案。谢谢你的时间。请留下您的反馈意见。</p><p id="b05c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以在这里找到所有的代码、配置文件<a class="ae jp" href="https://github.com/dnivra26/envoy_monitoring/" rel="noopener ugc nofollow" target="_blank"/>。</p><div class="mj mk fm fo ml mm"><a href="https://github.com/dnivra26/envoy_monitoring/" rel="noopener  ugc nofollow" target="_blank"><div class="mn ab ej"><div class="mo ab mp cl cj mq"><h2 class="bd hv fv z el mr eo ep ms er et ht dt translated">dnivra26/envoy_monitoring</h2><div class="mt l"><h3 class="bd b fv z el mr eo ep ms er et ek translated">使用envoy服务网格监控微服务的演示，Prometheus &amp; grafana-dni vra 26/envoy _ monitoring</h3></div><div class="mu l"><p class="bd b gc z el mr eo ep ms er et ek translated">github.com</p></div></div><div class="mv l"><div class="mw l mx my mz mv na la mm"/></div></div></a></div></div></div>    
</body>
</html>