<html>
<head>
<title>Sneak Peak into Apache Zookeeper</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">潜入阿帕奇动物园管理员</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/sneak-peak-into-apache-zookeeper-10417393765?source=collection_archive---------5-----------------------#2018-11-11">https://medium.com/hackernoon/sneak-peak-into-apache-zookeeper-10417393765?source=collection_archive---------5-----------------------#2018-11-11</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/a596b4d972012994d8aa30e9622e0fbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*jUJ0oB_1ArNMYsmRFH4WbA.png"/></div></div></figure><div class=""/><p id="060e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Apache Zookeeper是Apache基金会的开源工具。最初由雅虎开发。感谢雅虎的动物园管理员。</p><p id="a803" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Zookeeper是用Java编写的，它是独立于平台的。</p><p id="3051" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">什么是分布式系统？</p><p id="427f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">多台独立的计算机连接在一起，对用户来说就像一台计算机。分布式系统通过网络传递消息进行通信。分布式系统中的所有组件相互交互以执行任务子集来实现共同的目标</p><p id="dffe" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">为什么要使用分布式系统？</strong></p><ul class=""><li id="6759" class="ka kb if je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated">可靠性:即使分布式系统中的一台或多台服务器出现故障，系统仍将继续运行。</li><li id="cb26" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">可伸缩性:系统可以根据工作负载的要求横向扩展和缩减。</li></ul><p id="0ece" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">分布式系统的挑战？</strong></p><ul class=""><li id="7376" class="ka kb if je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated">竞争条件:当两个或多个线程访问共享数据，并且它们试图同时改变它时，就会发生竞争条件。</li><li id="fc2c" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">死锁:当集群中的每个节点都在等待集群中的其他成员释放锁时，就会发生死锁。</li></ul><h1 id="6f0f" class="ko kp if bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">因为协调分布式系统是一个动物园</h1><p id="71b8" class="pw-post-body-paragraph jc jd if je b jf lm jh ji jj ln jl jm jn lo jp jq jr lp jt ju jv lq jx jy jz hn dt translated">Zookeeper是分布式系统使用的高性能协调服务。Zookeeper允许分布式系统通过数据注册器的分级名称空间来相互协调。</p><h1 id="7fd3" class="ko kp if bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">为什么我们需要像动物园管理员这样的服务？</h1><p id="6d4b" class="pw-post-body-paragraph jc jd if je b jf lm jh ji jj ln jl jm jn lo jp jq jr lp jt ju jv lq jx jy jz hn dt translated">1.结构管理</p><p id="ea25" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">2.同步</p><p id="eb3f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">3.领导人选举</p><p id="2f7c" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">4.命名服务</p><p id="6bca" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">5.通知系统</p><p id="8805" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Zookeeper提供了实现上述所有任务的API。</p><p id="bdb7" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt lr translated"><span class="l ls lt lu bm lv lw lx ly lz di">Z</span>T8】ookeeper架构</p><figure class="mb mc md me fq hw fe ff paragraph-image"><div class="fe ff ma"><img src="../Images/86373c901257f801442917eacb4d0528.png" data-original-src="https://miro.medium.com/v2/resize:fit:698/format:webp/1*cT6s1MUCxAbVdOpD_Bb2mA.jpeg"/></div></figure><p id="4f04" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Zookeeper服务以2模式运行</p><ul class=""><li id="0c71" class="ka kb if je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated">单独的</li><li id="70ef" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">法定人数</li></ul><p id="98a9" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在独立模式下，Zookeeper服务在单个服务器上运行，没有状态被复制。</p><p id="5f5e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在quorum模式下，一组Zookeeper服务器(我们称之为Zookeeper ensemble)复制状态，它们一起服务于客户端请求。</p><ol class=""><li id="1884" class="ka kb if je b jf jg jj jk jn kc jr kd jv ke jz mf kg kh ki dt translated">Zookeeper服务器的集合被称为<strong class="je ig">集合</strong>。</li><li id="bfa5" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz mf kg kh ki dt translated">在任何时候，动物园管理员都有一个领队和其余的随从。最好至少有3台Zookeeper服务器来运行生产环境。</li><li id="7949" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz mf kg kh ki dt translated">客户端将始终在任何时间点连接到任何一个Zookeeper服务器。</li><li id="5256" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz mf kg kh ki dt translated">ensemble中的任何Zookeeper服务器都可以为读取客户端请求提供服务。</li><li id="e1fb" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz mf kg kh ki dt translated">所有的写请求都将发送给动物园管理员。Zookeeper使用ZAB (Zookeeper原子广播)协议，该协议确保将所有写入的变化从领导者传播到追随者。</li><li id="6675" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz mf kg kh ki dt translated">Zookeeper由分层名称空间组成。</li><li id="4189" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz mf kg kh ki dt translated">名称空间中的每个节点被称为<strong class="je ig"> Znode </strong>。</li></ol><p id="89ce" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig"> Znode </strong>:</p><p id="9ea4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Zookeeper树中的每个节点都是Znode。动物园管理员中的节点维护stat结构。</p><p id="1256" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一个节点可以是持久的，也可以是短暂的。顾名思义，持久的Znode将保留在Zookeeper中，直到或者除非没有进行删除调用，并且当Zookeeper客户端断开连接时，短暂的Znode将被删除。还有一个连续的Znode，它在Znode后面附加一个唯一的数字。所以基本上有4种类型的Znode持久的，短暂的，持久连续的，短暂连续的。</p><p id="4829" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">ZAB :</p><p id="2ae3" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">客户给关注者的所有写请求都会被转发给领导者。领导者执行请求，并以事务的形式将执行结果作为状态更新进行广播。事务由提交事务时服务器必须应用于数据树的一组确切的变化组成。</p><p id="a759" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">如何安装独立的Zookeeper并运行？</strong></p><p id="0a71" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">从<a class="ae mg" href="http://mirrors.estointernet.in/apache/zookeeper/zookeeper-3.4.13/zookeeper-3.4.13.tar.gz" rel="noopener ugc nofollow" target="_blank">这里</a>下载Zookeeper最新稳定版。注意此链接可能因镜像而异。</p><p id="ff4f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我通常把我的安装放在<code class="eh mh mi mj mk b">/opt</code>里，但是你们可以在你选择的服务器/机器上下载。</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="9c4b" class="mp kp if mk b fv mq mr l ms mt">* wget <a class="ae mg" href="https://archive.apache.org/dist/zookeeper/zookeeper-3.4.13/zookeeper-3.4.13.tar.gz" rel="noopener ugc nofollow" target="_blank">https://archive.apache.org/dist/zookeeper/zookeeper-3.4.13/zookeeper-3.4.13.tar.gz</a></span><span id="1b1e" class="mp kp if mk b fv mu mr l ms mt">* tar xzf <a class="ae mg" href="https://archive.apache.org/dist/zookeeper/zookeeper-3.4.13/zookeeper-3.4.13.tar.gz" rel="noopener ugc nofollow" target="_blank">zookeeper-3.4.13.tar.gz</a></span><span id="1125" class="mp kp if mk b fv mu mr l ms mt">* cd zookeeper-3.4.13</span><span id="ed0c" class="mp kp if mk b fv mu mr l ms mt">* cp conf/zoo_sample.cfg conf/zoo.cfg</span></pre><p id="f929" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">启动Zookeeper服务器</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="86bb" class="mp kp if mk b fv mq mr l ms mt"><strong class="mk ig">* sudo bin/zkServer.sh start</strong></span><span id="8fe8" class="mp kp if mk b fv mu mr l ms mt">You sgould see output like below id Zookeeper start successfully</span><span id="a9bf" class="mp kp if mk b fv mu mr l ms mt"><strong class="mk ig">ZooKeeper JMX enabled by default<br/>Using config: /opt/zookeeper-3.4.13/bin/../conf/zoo.cfg<br/>Starting zookeeper … STARTED</strong></span></pre><p id="89d0" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">动物园管理员CLI </p><ol class=""><li id="aa10" class="ka kb if je b jf jg jj jk jn kc jr kd jv ke jz mf kg kh ki dt translated">创建一个持久的节点</li></ol><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="84c6" class="mp kp if mk b fv mq mr l ms mt">create /abhishek "anay"</span></pre><p id="dd94" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">输出应该如下所示</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="725b" class="mp kp if mk b fv mq mr l ms mt">Created /abhishek</span></pre><p id="c74d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用<code class="eh mh mi mj mk b">-s</code>标志创建顺序Znode，使用上述命令的<code class="eh mh mi mj mk b">-e</code>标志创建临时Znode。</p><p id="0b3b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">2.<strong class="je ig">从动物园管理员处获取</strong>数据</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="092e" class="mp kp if mk b fv mq mr l ms mt">get /abhishek</span></pre><p id="87e2" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您应该会看到如下输出</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="b718" class="mp kp if mk b fv mq mr l ms mt">anay<br/>cZxid = 0x9<br/>ctime = Sun Nov 11 20:55:34 IST 2018<br/>mZxid = 0x9<br/>mtime = Sun Nov 11 20:55:34 IST 2018<br/>pZxid = 0x9<br/>cversion = 0<br/>dataVersion = 0<br/>aclVersion = 0<br/>ephemeralOwner = 0x0<br/>dataLength = 4<br/>numChildren = 0</span></pre><p id="c771" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们理解上面的输出，它也是一个Znode元数据</p><ul class=""><li id="6f04" class="ka kb if je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated">anay:Znode保存的数据。</li><li id="832e" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">cZxid: 0x9是Zookeeper事务id。</li><li id="3379" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">ctime: Znode创建时间。</li><li id="831b" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">mZxid:上次修改时更改的Zxid。</li><li id="8f68" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">mtime:Znode的上次修改时间。</li><li id="c566" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">pZxid:上次修改此znode子节点的更改的Zxid。</li><li id="012e" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">c version:Znode子节点的更改次数。</li><li id="d805" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">data version:Znode的更改次数。</li><li id="7ab5" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">acl version:Znode的ACL的更改次数。</li><li id="912d" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">ephemerlOwner:如果Znode是临时节点，则为该Znode所有者的会话id。如果它不是一个短暂的节点，它将为零。</li><li id="5577" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">dataLength:Znode中数据的长度。</li><li id="7681" class="ka kb if je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">numChildren:此节点的子节点数。</li></ul><p id="2456" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">创建子节点</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="aaeb" class="mp kp if mk b fv mq mr l ms mt">create /abhishek/anayamralkar loveyouson</span></pre><p id="30b7" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">3.<strong class="je ig">观看</strong>命令</p><p id="0c9d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当Znode中的数据改变时，它会显示通知。我们可以使用<code class="eh mh mi mj mk b">watch </code>命令和<code class="eh mh mi mj mk b">get</code>命令。</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="06f8" class="mp kp if mk b fv mq mr l ms mt">get /abhishek [watch] 1</span></pre><p id="e6d0" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">输出类似于<code class="eh mh mi mj mk b">get</code>命令，但当Znode中的数据发生变化时会显示通知。</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="a5ba" class="mp kp if mk b fv mq mr l ms mt">get /abhishek [watch] 1<br/>anay<br/>cZxid = 0x9<br/>ctime = Sun Nov 11 20:55:34 IST 2018<br/>mZxid = 0x9<br/>mtime = Sun Nov 11 20:55:34 IST 2018<br/>pZxid = 0x9<br/>cversion = 0<br/>dataVersion = 0<br/>aclVersion = 0<br/>ephemeralOwner = 0x0<br/>dataLength = 4<br/>numChildren = 0</span></pre><p id="2e9e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">4.<strong class="je ig">设置</strong>命令用来改变与Znode相关的数据</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="dc6b" class="mp kp if mk b fv mq mr l ms mt">set /abhishek anayamralkar</span></pre><p id="c173" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">5.<strong class="je ig">删除</strong>命令删除znode</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="d42f" class="mp kp if mk b fv mq mr l ms mt">delete /abhishek</span></pre><p id="421b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">6.列出节点和子节点的命令</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="1e9e" class="mp kp if mk b fv mq mr l ms mt">[zk: localhost:2181(CONNECTED) 31] ls /<br/>[zookeeper, abhishek]<br/>[zk: localhost:2181(CONNECTED) 32] ls /abhishek<br/>[anayamralkar]</span></pre><p id="b84a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">7.<strong class="je ig"> stat </strong>命令检查Znode和children的状态</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="f9af" class="mp kp if mk b fv mq mr l ms mt">stat /</span><span id="87b8" class="mp kp if mk b fv mu mr l ms mt">stat /abhishek</span></pre><p id="5a6f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">8.<strong class="je ig">帮助</strong>命令查看所有可用命令</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="66a3" class="mp kp if mk b fv mq mr l ms mt">ZooKeeper -server host:port cmd args<br/> stat path [watch]<br/> set path data [version]<br/> ls path [watch]<br/> delquota [-n|-b] path<br/> ls2 path [watch]<br/> setAcl path acl<br/> setquota -n|-b val path<br/> history <br/> redo cmdno<br/> printwatches on|off<br/> delete path [version]<br/> sync path<br/> listquota path<br/> rmr path<br/> get path [watch]<br/> create [-s] [-e] path data acl<br/> addauth scheme auth<br/> quit <br/> getAcl path<br/> close <br/> connect host:port</span></pre><p id="3ae8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">9.<strong class="je ig">退出</strong>命令，退出Zookeeper外壳</p><pre class="mb mc md me fq ml mk mm mn aw mo dt"><span id="dba0" class="mp kp if mk b fv mq mr l ms mt">quit</span></pre></div></div>    
</body>
</html>