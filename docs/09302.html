<html>
<head>
<title>RAID: Life, Death and Resurrection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">突袭:生命、死亡和复活</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/raid-life-death-and-resurrection-bd55dfdcd321?source=collection_archive---------10-----------------------#2018-11-12">https://medium.com/hackernoon/raid-life-death-and-resurrection-bd55dfdcd321?source=collection_archive---------10-----------------------#2018-11-12</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/8f33acc04b573d13234a93941f42d7f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fIZKA5uYCW0NtQdb1cAcXQ.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">RAID4 array as seen by the author</figcaption></figure><p id="bc25" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这是2010/2011年左右发生在我身上的真实故事。</p><p id="1993" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我与<a class="ae ke" href="https://hackernoon.com/tagged/network" rel="noopener ugc nofollow" target="_blank">网络</a>连接存储(NAS)的问题很早就开始了。我认为这个艰难的童年与其说是由硬件的脆弱造成的，不如说是由我的虐待狂倾向造成的。我承认，我有点乖张，绝对是个黑客。这意味着我倾向于以生产商无法预测的方式使用每一件落入我手中的设备。</p><p id="77d1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">开始的时候，在尝试像我一样的麻烦制造者创造的各种添加时，我射掉了我的脚。或者说是我的脸。当我卸载system-suuplied BitTorrent客户端时，Web界面拒绝工作(顺便说一下，这相当卑鄙)。这实际上是制片人的错。制作人没有想到用户可能不一定需要他们无限的善良，可能会试图以自己的方式满足自己(如传输BitTorrent客户端)。因为我以前没有激活SSH访问(寓意:为了你自己好，在购买NAS后立即激活SSH！)，从那时起，我与<a class="ae ke" href="https://hackernoon.com/tagged/nas" rel="noopener ugc nofollow" target="_blank"> NAS </a>的唯一联系是通过NFS和使用传输(它不与网络接口集成，在不同的端口上工作)。</p><p id="99c4" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">因为它对于听音乐来说已经足够了(UPnP服务器工作得很好，没有大惊小怪)，所以我没有费心去修复它。“会有时间的”，我想。</p><h1 id="955f" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">保护好你自己，我的孩子</h1><p id="1c2b" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">值得一提的是，我拥有的NAS在备份解决方案方面非常丰富。从最简单的(当你按下“备份”按钮时，复制到任何连接到插座的USB设备)到更邪恶的(由<code class="eh li lj lk ll b">cron</code>控制的<code class="eh li lj lk ll b">rsync</code>)。</p><p id="0b8c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">令我苦恼的是，时间的缺乏(这将在本笔记中再次提到)是我在破坏网络界面之前没有设法激活这些解决方案的原因。</p><p id="cd7a" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">真正的问题</strong>开始的比较晚，和停电有关。我的阵列中有4x500GB的驱动器，生产商称之为X-RAID，它或多或少相当于<a class="ae ke" href="https://en.wikipedia.org/wiki/Standard_RAID_levels#RAID_4" rel="noopener ugc nofollow" target="_blank"> RAID 4 </a>。前提是一个驱动器的故障不会导致数据丢失，也不会干扰系统的工作。因此，根据<a class="ae ke" href="https://en.wikipedia.org/wiki/Murphy%27s_law" rel="noopener ugc nofollow" target="_blank">墨菲定律</a>，其中两个驱动器出现故障。经历了这样的打击后，NAS无法回心转意。我试图启动它，结果是“引导”信息在苍白的显示屏上永远持续着。坦率地说，展示是绿色的，但绿色无法展现出场景的全部悲怆。</p><h1 id="bb35" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">报数</h1><p id="7ade" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">我没有想太多(有时我觉得自己根本没想太多)，就决定检查驱动器。第一个观察结果:</p><ul class=""><li id="81de" class="lm ln hu ji b jj jk jn jo jr lo jv lp jz lq kd lr ls lt lu dt translated">HD1: <code class="eh li lj lk ll b">fdisk</code>显示分区表，ext2分区正在安装</li><li id="84cf" class="lm ln hu ji b jj lv jn lw jr lx jv ly jz lz kd lr ls lt lu dt translated">HD2: <code class="eh li lj lk ll b">fdisk</code>保持沉默</li><li id="b6d7" class="lm ln hu ji b jj lv jn lw jr lx jv ly jz lz kd lr ls lt lu dt translated">HD3:与HD1相同</li><li id="562d" class="lm ln hu ji b jj lv jn lw jr lx jv ly jz lz kd lr ls lt lu dt translated">HD4:燃烧的地狱</li></ul><p id="572e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">当我把HD4连接到我的电脑上进行检查时，BIOS开始对我大喊大叫。<a class="ae ke" href="https://en.wikipedia.org/wiki/S.M.A.R.T." rel="noopener ugc nofollow" target="_blank"> S.M.A.R.T </a>有些类似。HD4真的很生气。最终，我诊断为电子故障，并将其放在旁边标有“以后/可能”标签的盒子里。</p><p id="379d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在任何恢复数据的尝试中，拥有两个正常工作和两个故障驱动器都不是一个好的起点。</p><p id="09ac" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我挠了挠头。我还记得，当时我连续几个月挠头。最后，我得出结论，也许HD2并不像看上去那么糟糕。也许这只是模拟疾病来逃避工作？</p><figure class="mb mc md me fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ma"><img src="../Images/3e8358c8b16124664ba2e92e76f510f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*okFvAn8Fc6S03sWC"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">“bunch of fruits in buckets on black wheelbarrow” by <a class="ae ke" href="https://unsplash.com/@baconandbaileys?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Kelly Neil</a> on <a class="ae ke" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="482a" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">用独轮车移动钻头</h1><p id="f727" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">为了避免事情变得更加复杂，我决定购买一个额外的驱动器，并对图像进行所有操作。对于我的数据来说，硬盘上的任何错误都将是永久的死亡。我买了2TB的硬盘，把我最喜欢的工具之一拿在手里(<code class="eh li lj lk ll b">dd</code>)，然后开始铲土。我的工作假设是HD2的分区表被破坏了。</p><p id="2b71" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">因为出现故障的NAS以相同的方式格式化了每个驱动器(系统分区、交换分区，然后是<a class="ae ke" href="https://en.wikipedia.org/wiki/Logical_Volume_Manager_(Linux)" rel="noopener ugc nofollow" target="_blank"> LVM </a>)，所以我比较了HD1和HD3的分区表，然后将其中一个复制到了HD2。使用<code class="eh li lj lk ll b">losetup</code>，我用HD2安装了系统分区——一切看起来都绝对一流。我的心里充满了喜悦！我不耐烦地等待着能够激活LVM音量并重新获得数据。</p><h1 id="5f7a" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">(非)预期的图扭曲</h1><p id="3f88" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">然而，命运可能是邪恶的，结果发现其中一卷物理卷找不到了。我注意到了它的UUID，沮丧地思考着下一步该怎么办。由于缺乏更好的想法，我开始看我认为是一个单独的PV。</p><p id="3afa" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在HD1上，一切看起来像一个经典的LVM磨合，同样在HD3上。但是HD2呈现了预期数据和一些随机混乱的怪异混搭(乍一看)。UUID的领域特别奇怪。这是否意味着不仅仅是分区表受到了影响？</p><p id="f788" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">尽管遇到了挫折，我还是继续深入调查。为什么有些数据是正确的，而有些看起来是伪造的？启蒙运动来得很突然，我现在记不起是什么导致了它。当我回头看的时候，我发现我是多么的愚蠢。那时我认为我是地球上最聪明的人！</p><h1 id="8dff" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">来吧，我的孩子，我来教你！</h1><p id="082f" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">我检查了整个情况。我在思想上回到了从一开始就是我行为的催化剂这一点:RAID 4通过记录<a class="ae ke" href="https://en.wikipedia.org/wiki/Exclusive_or" rel="noopener ugc nofollow" target="_blank">异或</a>运算的数据来保护其中一个驱动器免于故障，从而允许重建原始数据。这不是很明显吗？</p><p id="44f7" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">没有太多思考(你打赌！)我用c写了一个概念验证，它所做的只是从三个映像中的每一个读取前4kB，并在屏幕上显示异或数据。这样我找到了失踪的UUID。还有，安心！现在，所有需要做的就是使程序更加通用。这样我就可以把结果写到第四张图片上，然后继续处理<code class="eh li lj lk ll b">losetup</code>、<code class="eh li lj lk ll b">vgchange -ay</code>，我们又可以回家了！</p><h1 id="6884" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">没那么快！</h1><p id="4d52" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">因为我的数学一直很差，所以我没想到把4张500GB的图片放在一张总容量为2TB的格式化光盘上会有问题。尤其是已经有一些其他数据的情况下。我最初的热情下降了，我开始考虑就地解决方案(与此同时，驱动器价格飙升，因此购买另一个是不可能的)。</p><p id="ab3f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">第一个绝妙的想法是编写一个内核驱动程序，它将呈现一个块设备，返回XOR格式提供的文件。我甚至开始阅读<a class="ae ke" href="https://www.linuxjournal.com/article/4786" rel="noopener ugc nofollow" target="_blank"> Linux驱动程序HOWTO </a>，尽管这看起来像是用大炮打一只苍蝇。最终，使用<a class="ae ke" href="https://en.wikipedia.org/wiki/Filesystem_in_Userspace" rel="noopener ugc nofollow" target="_blank"> FUSE </a>用Python编写文件系统的想法获得了胜利。这相对容易，几分钟后我就检查了它是如何工作的。当<code class="eh li lj lk ll b">losetup</code>哭诉它没有权限把我的假文件呈现为屏蔽设备时，我的心又沉了下去。</p><p id="1704" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在这种情况下，我倾向于向朋友寻求建议。幸运的是，其中一个名为<a class="ae ke" href="https://en.wikipedia.org/wiki/Strace" rel="noopener ugc nofollow" target="_blank"> strace </a>的人给我指出了问题所在。FUSE不允许一个用户访问另一个用户挂载的文件系统。因为<code class="eh li lj lk ll b">losetup</code>需要超级用户权限，而我是以普通用户的身份挂载我的文件系统，这变成了一个障碍。</p><h1 id="e6c1" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">哦，快乐的一天！卡洛奥。Callay！</h1><p id="ca9f" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated"><code class="eh li lj lk ll b">losetup</code>、<code class="eh li lj lk ll b">vgchange</code>、<code class="eh li lj lk ll b">fuseext2</code>还有……我的全部音乐收藏(几个月的翻录CD)安然无恙，欢快地向我招手。有很多欢乐！</p><h1 id="3bfe" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">验尸</h1><p id="8702" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">我相信你可能不会发现自己处于和我相似的位置。这是一个特别糟糕的巧合，电源故障、硬盘损坏和高昂的替换价格。但是，从这次经历中可以吸取一些教训。</p><p id="627c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">即使您在相对较高的级别上操作(如文件系统和FUSE ),了解抽象级别之外的情况也是很好的。对我来说，是<code class="eh li lj lk ll b">hexdump</code>和<code class="eh li lj lk ll b">strace</code>帮助我在形势严峻时重获宪法。</p><p id="8a8d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">无论你做什么，类似的问题都可能出现，大约在我为我的NAS苦苦挣扎的同时，Twitter也面临着与扩展相关的问题。尽管他们的软件是用Ruby编写的，他们还是求助于使用DTrace 的<a class="ae ke" href="http://dtrace.org/resources/ahl/dtrace_ruby_oscon_2007.pdf" rel="noopener ugc nofollow" target="_blank">来超越表象。所有这些花哨的框架确实节省了开发时间，但是当事情变得糟糕时，你可能会弄脏自己。</a></p><figure class="mb mc md me fq iv"><div class="bz el l di"><div class="mf mg l"/></div></figure></div></div>    
</body>
</html>