<html>
<head>
<title>Redirects, and their Effect on Performance or How a (Seemingly Minor) Third Party Change Affected the Website Performance of a Popular JavaScript Bundler</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">重定向，以及它们对性能的影响，或者一个(看似微小的)第三方变化如何影响一个流行的JavaScript Bundler的网站性能</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/redirects-and-their-effect-on-performance-or-how-a-seemingly-minor-third-party-change-affected-1ce78dfc24a1?source=collection_archive---------20-----------------------#2018-11-14">https://medium.com/hackernoon/redirects-and-their-effect-on-performance-or-how-a-seemingly-minor-third-party-change-affected-1ce78dfc24a1?source=collection_archive---------20-----------------------#2018-11-14</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="ba12" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当服务器重定向请求时，浏览器必须对文件进行第二次请求，增加(至少)一次额外的往返行程，并延迟向最终用户交付内容。</p><p id="6f0f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有一天，当我闲坐着的时候，我想知道“一个页面上重定向的最大数量是多少？”HTTP存档来拯救。在summary_pages表中，有一个numRedirects字段。在BigQuery中快速搜索，我发现了一个包含超过1100个重定向的页面:</p><blockquote class="jp jq jr"><p id="6fa5" class="ir is js it b iu iv iw ix iy iz ja jb jt jd je jf ju jh ji jj jv jl jm jn jo hn dt translated">在WebPageTest中，黄线表示请求了重定向。我数(好的..对“302”进行关键字搜索，找到了1，187个重定向。在一页上…都指向Gravatar的空白头像。<a class="ae jw" href="https://twitter.com/hashtag/perfmatters?src=hash&amp;ref_src=twsrc%5Etfw" rel="noopener ugc nofollow" target="_blank"><em class="hu">#性能</em></a><em class="hu"/><a class="ae jw" href="https://t.co/SCqzG6rQEG" rel="noopener ugc nofollow" target="_blank"><em class="hu">pic.twitter.com/SCqzG6rQEG</em></a></p><p id="583b" class="ir is js it b iu iv iw ix iy iz ja jb jt jd je jf ju jh ji jj jv jl jm jn jo hn dt translated"><em class="hu"> —道格·西拉斯🇧🇪(@ dougsillars)</em><a class="ae jw" href="https://twitter.com/dougsillars/status/1054761605257486336?ref_src=twsrc%5Etfw" rel="noopener ugc nofollow" target="_blank"><em class="hu">2018年10月23日</em> </a></p></blockquote><p id="382c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然，它正在对Gravatar的默认图像进行一些奇怪的拒绝服务攻击——所有1100个重定向(好吧，我看过的所有重定向——我很快就厌倦了)都指向Gravatar骨架图像，这有点奇怪。</p><h1 id="84c7" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">意想不到的网站</h1><p id="8262" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">当我继续搜索有大量重定向的网站列表时，我在前10名中看到了一个熟悉的名字。我发现web pack(<a class="ae jw" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank">https://webpack.js.org</a>)的主页上有超过600个重定向。</p><p id="7443" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Webpack是JavaScript的捆绑工具，有很多方法可以帮助优化内容的交付(参见<a class="ae jw" href="https://developers.google.com/web/fundamentals/performance/webpack/" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">用webpack进行Web性能优化</strong> </a>)。由于这个原因，我很惊讶在这个页面上看到这么多重定向！不幸的是，用WebPageTest进行的快速测试证实了这一点，并且还显示302重定向没有被缓存，回访也遭受了同样的600+ 302重定向惩罚。</p><figure class="lb lc ld le fq lf fe ff paragraph-image"><div class="fe ff la"><img src="../Images/afd4efeb8f60a2ba4d92a5e80849d123.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/0*tMud9VjIIxBWTSME"/></div></figure><p id="8650" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我会把完整的瀑布粘贴到这个帖子里，但是你会一直滚动，过一会儿就放弃我要说的话。如果你很好奇，可以在这里看到测试结果:<a class="ae jw" href="https://www.webpagetest.org/result/181023_JP_b9476f132f954277f10ab45938be4702/" rel="noopener ugc nofollow" target="_blank">https://www . web page test . org/result/181023 _ JP _ b 9476 f 132 f 954277 f 10 ab 45938 be 4702/</a></p><h1 id="2c48" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">诊断</h1><p id="f794" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">这是怎么回事？Webpack很幸运有很多赞助商，他们在自己的网页上列出了很多赞助商。每张图片都会导致一个重定向:</p><p id="a1cd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每个请求:</p><p id="875e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jw" href="https://opencollective.com/proxy/images/" rel="noopener ugc nofollow" target="_blank">https://opencollective.com/proxy/images/</a>？&lt; id &gt;</p><p id="5f3a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">已重定向至:</p><p id="a397" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">https://images.opencollective.com/proxy/images/<a class="ae jw" href="https://images.opencollective.com/proxy/images/" rel="noopener ugc nofollow" target="_blank">？&lt; id &gt;</a></p><blockquote class="jp jq jr"><p id="5e53" class="ir is js it b iu iv iw ix iy iz ja jb jt jd je jf ju jh ji jj jv jl jm jn jo hn dt translated"><em class="hu">并且重定向没有被缓存:</em></p><p id="a44f" class="ir is js it b iu iv iw ix iy iz ja jb jt jd je jf ju jh ji jj jv jl jm jn jo hn dt translated"><em class="hu">缓存控制:私有，最大年龄=0，无存储，无缓存，必须重新验证，后检查=0，预检查=0 </em></p></blockquote><p id="e0ab" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这意味着相同的重定向发生在随后的访问中。webpack页面是开源的，我四处挖掘，发现了一个对https://opencollective.com/api/groups/webpack/backers的API调用</p><p id="4591" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将返回一个包含所有支持者的(非常大的)JSON文件，包括他们图像的URL。这就是重定向的来源。</p><p id="971b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，我们发现了一个顶级工具的网站，其第三方API添加了数百个额外的请求来加载网页。</p><h1 id="fdbb" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">进一步挖掘</h1><p id="f5eb" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">我们可以解决这个问题！在Opencollective Github repo中，我发现在Opencollective上的9/17 commit中对图像子域进行了更改。这里没有邪恶，只是一个简单的迁移。这可能是罪魁祸首吗？幸运的是，有了HTTP存档，我们就有了历史数据！</p><figure class="lb lc ld le fq lf fe ff paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="fe ff li"><img src="../Images/bafdb6e77553b6f93956129b980c48f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BuiX5qWQv6KF5Kg-"/></div></div></figure><p id="cb35" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">查看2018年9月1日的HTTPArchive，webpack.js.org有0个重定向，但在2018年9月15日的HTTP存档爬网上有649个重定向。</p><p id="d28f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我的直觉是9/17提交导致了这个问题，所以这让我担心我的猜测是不正确的。在每次HTTP归档运行中测试了超过120万个网页，它们不可能在一天内全部运行。对webpack.js.org的测试在UNIX时间1537493496运行，即2018年9月21日，即推送后4天。好吧，我就这么定了。</p><h1 id="4ea9" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">提交缺陷和解决方案</h1><p id="f1f3" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">我在opencollective GitHub repo上提出了一个问题:</p><p id="6430" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jw" href="https://github.com/opencollective/opencollective-images/issues/10" rel="noopener ugc nofollow" target="_blank">https://github . com/open collective/open collective-images/issues/10</a></p><p id="25e2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上周已经解决了。现在webpack.js.org主页又有了0个重定向，允许所有这些图片在一个请求中加载！</p><p id="0c42" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jw" href="https://www.webpagetest.org/result/181108_98_7f290d38486ac8ce6505ad553c4abea9/" rel="noopener ugc nofollow" target="_blank">https://www . web page test . org/result/181108 _ 98 _ 7f 290d 38486 AC 8 ce 6505 ad 553 C4 ab e9/</a></p><figure class="lb lc ld le fq lf fe ff paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="fe ff ln"><img src="../Images/03679eda4aaa5549e6ab8786b7a77bbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:684/0*PXKXS4tK72NF5THB"/></div></div></figure><h1 id="c01a" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">结论:</h1><p id="bb0d" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">重定向增加了传递内容的额外往返行程，从而延迟了页面加载并降低了性能。有时，您的网站所依赖的第三方的变化会导致您的网站性能发生灾难性的变化，因此定期测试对于快速发现这些问题至关重要。</p><p id="c707" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">像HTTP Archive和WebPageTest这样的工具对于帮助查明问题是必不可少的，应该成为您的工具集的一部分来识别问题。</p></div><div class="ab cl lo lp hc lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="hn ho hp hq hr"><p id="a57e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="js">原载于2018年11月14日</em><a class="ae jw" href="https://dougsillars.com/2018/11/14/redirects-and-their-effect-on-performance-or-how-a-seemingly-minor-third-party-change-affected-the-website-performance-of-a-popular-javascript-bundler/" rel="noopener ugc nofollow" target="_blank"><em class="js">【dougsillars.com】</em></a><em class="js">。</em></p></div></div>    
</body>
</html>