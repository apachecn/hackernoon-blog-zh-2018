<html>
<head>
<title>Deploy, Operate, and Monitor IoTeX Cluster with Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kubernetes部署、操作和监控IoTeX集群</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/deploy-operate-and-monitor-iotex-cluster-with-kubernetes-76a2cc547459?source=collection_archive---------16-----------------------#2018-11-19">https://medium.com/hackernoon/deploy-operate-and-monitor-iotex-cluster-with-kubernetes-76a2cc547459?source=collection_archive---------16-----------------------#2018-11-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/6b8d6efa74db8271b7ed9841a704ccbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SyeYUzq8rwV97OzZgshPKA.png"/></div></div></figure><div class=""/><p id="a16a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Kubernetes  是一个开源系统，用于自动部署、扩展和管理容器化的应用程序。容器化是全机虚拟化的一种轻量级替代方案，它将应用程序封装在一个具有自己的操作环境的容器中。集装箱化在过去几年中已经成熟，并导致整个技术行业更多地采用Kubernetes。</p><p id="a81a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Kubernetes极大地提高了用户运行测试和模拟的能力。在高层次上，它允许用户扩展他们传统限制之外的技术资源；例如，用户可以模拟一个101节点的区块链集群，而无需拥有101台物理机。这对于快速建立区块链集群的临时环境非常理想。它对于模拟具有利益证明(PoS)或委托利益证明(DPoS)一致机制的区块链网络也是特别有用的，这涉及有限数量(例如，101个)地理上分布的块产生/验证节点。</p><p id="57e7" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">从我们的<a class="ae ka" rel="noopener" href="/iotex/iotex-testnet-beta-epik-release-4d972efd9638">Testnet Beta“Epik”发布</a>开始，IoTeX已经使用Kubernetes来部署和优化我们的Testnet基础设施。总的来说，Kubernetes极大地改善了我们的运营——在这篇博客中，我们分享了在Kubernetes上运行您自己的容器化应用程序和环境的经验和一些技巧。</p><h1 id="5cd3" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated"><strong class="ak">在Kubernetes上设置IoTeX集群</strong></h1><p id="579a" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">我们首先定义两种类型的Kubernetes <a class="ae ka" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">服务</a>:</p><ul class=""><li id="c560" class="le lf if je b jf jg jj jk jn lg jr lh jv li jz lj lk ll lm dt translated"><strong class="je ig"> bootnode服务:</strong>用于启动整个IoTeX集群。它是任何新iotex节点的入口点，并帮助新节点加入P2P网络。所有节点通过其内部Pod的IP地址相互识别。</li><li id="be86" class="le lf if je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm dt translated"><strong class="je ig"> iotex服务:</strong>从所有iotex节点公开JSON-RPC API。JSON-RPC接口由我们的<a class="ae ka" rel="noopener" href="/@iotex/iotex-network-explorer-has-been-open-sourced-27479bd13101">开源</a> <a class="ae ka" href="https://www.iotexscan.io/" rel="noopener ugc nofollow" target="_blank"> IoTeX Explorer </a>和我们的动作注入工具使用。</li></ul><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ls"><img src="../Images/bef5986a1a722bb95994f82dda034b8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JSPIbDjYn8c2nB56Z5I0Cg.png"/></div></div></figure><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lx"><img src="../Images/eabb4cdcd48c61d013beec5fa8d47fcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gIdh41aH6PeF6Xm6JqK8ow.png"/></div></div></figure><p id="c755" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所有节点配置都通过Kubernetes <a class="ae ka" href="https://cloud.google.com/kubernetes-engine/docs/concepts/configmap" rel="noopener ugc nofollow" target="_blank"> ConfigMap </a>部署，包括genesis块。这允许我们重新部署新的集群，而无需等待构建新的docker映像。</p><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div class="fe ff ly"><img src="../Images/50748f2b187a3d3832173edff2ac75fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*XeAOPp8Ynmm2ByykvfIq3A.png"/></div></figure><p id="0eba" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">默认情况下，Kubernetes Pods中运行的应用程序是无状态的，这意味着在重新部署后，任何应用程序中保存的数据都将不可用。为了解决这个问题，我们使用以下设置过程。在我们的场景中，每个IoTeX节点将利用相同的数据副本(即分布式分类帐)，因此没有必要持久存储每个节点的数据。因此，我们只将Kubernetes <a class="ae ka" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/" rel="noopener ugc nofollow" target="_blank">持久卷</a>挂载到一个iotex节点——在我们的例子中，我们将它挂载到我们的引导节点。我们还将持久化数据备份到对象存储空间，如S3和数字海洋。由于除启动节点之外的所有节点在重新部署后都不会保存数据，因此它们需要在启动前首先下载备份。我们使用init容器来实现这一点。这个过程使我们的集群能够从崩溃故障中重新启动，而不用担心丢失以前的数据。</p><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lz"><img src="../Images/058e6973b5123c5ad7a3ac9019c69417.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CJV3lzsI9J4GLSyGPZVQHA.png"/></div></div></figure><h1 id="bb96" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated"><strong class="ak">集群监控</strong></h1><p id="4649" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">跟踪21个节点(更不用说101个节点)的状态并不简单，而且随着节点数量的增加，跟踪变得更加复杂。为了在我们的IoTeX集群中获得更好的可观察性，我们在Kubernetes中设置了监控功能，它由日志堆栈、指标堆栈和警报管理器组成。</p><p id="3144" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对于测井叠加，我们使用<a class="ae ka" href="https://www.fluentd.org/" rel="noopener ugc nofollow" target="_blank"> Fluentd </a> + <a class="ae ka" href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank">弹性搜索</a> + <a class="ae ka" href="https://www.elastic.co/products/kibana" rel="noopener ugc nofollow" target="_blank"> Kibana </a> + <a class="ae ka" href="https://www.elastic.co/guide/en/elasticsearch/client/curator/5.5/index.html" rel="noopener ugc nofollow" target="_blank">弹性搜索管理器</a>。Fluentd将日志从每个节点发送到弹性搜索客户端，弹性搜索主服务器对日志进行索引，这些日志可以通过Kibana进行查询。最后，我们使用弹性搜索管理器来清理过时的日志。</p><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div class="ab fr cl ma"><img src="../Images/7635313d5c53a709e9afb78ea5885038.png" data-original-src="https://miro.medium.com/v2/format:webp/1*eNDJDq_eWIef-XfK4llMRg.png"/></div><figcaption class="mb mc fg fe ff md me bd b be z ek">Refer from <a class="ae ka" rel="noopener" href="/@carlosedp/log-aggregation-with-elasticsearch-fluentd-and-kibana-stack-on-arm64-kubernetes-cluster-516fb64025f9">Log aggregation with ElasticSearch, Fluentd and Kibana stack on ARM64 Kubernetes cluster</a></figcaption></figure><p id="a331" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对于度量堆栈，我们使用<a class="ae ka" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a> + <a class="ae ka" href="https://github.com/coreos/prometheus-operator" rel="noopener ugc nofollow" target="_blank">普罗米修斯操作符</a> + <a class="ae ka" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>。<a class="ae ka" href="https://coreos.com/operators/prometheus/docs/latest/user-guides/getting-started.html" rel="noopener ugc nofollow" target="_blank">CoreOS Prometheus Operator</a>提供了一种简单的方法来配置在Kubernetes集群中运行的Prometheus。我们可以通过简单地公开一个度量服务，将IoTeX节点的Prometheus客户机与Prometheus服务器连接起来。</p><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mf"><img src="../Images/bc512e6f8d09ceee08b89749345c31fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wYZjVKVU4NWXSH4A.png"/></div></div><figcaption class="mb mc fg fe ff md me bd b be z ek">Refer from <a class="ae ka" href="https://coreos.com/operators/prometheus/docs/latest/user-guides/getting-started.html" rel="noopener ugc nofollow" target="_blank">CoreOS: Prometheus Operator</a></figcaption></figure><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mg"><img src="../Images/d4e80eeb26b8fb6b8008121b4faf345a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n97erIaW5H2BpKlqWSOdDA.png"/></div></div></figure><p id="2f16" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们还在努力使用Prometheus Alert Manager设置警报，以便在我们发现异常指标时向我们的待命工程师发送警报。</p><h1 id="46b6" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated"><strong class="ak">使用Helm管理多个配置</strong></h1><p id="aec9" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">对于单一环境，使用yaml配置在Kubernetes上部署不同类型的应用程序相当简单。但是，当您有多个环境(例如，测试、试运行、生产)和不同的节点扭曲/配置(例如，21个代表对101个代表)时，用户在管理同一应用程序的各种Kubernetes yaml配置时会遇到更高的开销和冗余。为了解决这个问题，我们使用了Helm。</p><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mh"><img src="../Images/973ecda64acbbf36c2b6d79889c2da71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vzshXza0nuqO3AXWccCMAw.png"/></div></div></figure><p id="11d4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ka" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>是Kubernetes应用程序的包管理器。它允许我们将IoTeX集群创建为包含版本和默认值的图表包。有了Helm，我们不需要管理重复的Kubernetes yaml文件；相反，我们只需要为不同的环境和扭曲管理一个较小的配置子集，这将覆盖默认值。它还将启动新的IoTeX集群所需运行的命令简化为一条命令:</p><p id="b746" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Helm还允许我们轻松发布图表。未来，我们将向社区发布我们的IoTeX掌舵图，这样您可以在几分钟内设置一个IoTeX集群。</p><h1 id="c464" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated"><strong class="ak">更多精彩来了！</strong></h1><p id="9e35" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">借助Kubernetes和其他操作工具的力量，IoTeX的开发团队不仅节省了集群操作的时间，而且消化问题的速度和迭代速度都比以前更快。我们期待在未来分享更多技术观点——如有任何问题，请随时联系我们以支持@iotex.io。</p><h1 id="be92" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">关于IoTeX</h1><p id="3c19" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">IoTeX是世界上第一个以隐私为中心的区块链平台，快速、灵活、物联网(IoT)友好。IoTeX的全球团队由密码学、分布式系统和机器学习领域的博士、顶级工程师和经验丰富的生态系统构建者组成。IoTeX专为物联网而设计和优化，使用最先进的隐私、共识和子链创新来捕捉物联网的全部潜力。通过实现可信数据、互操作性和M2M自动化，IoTeX连接了物理和数字世界，并为大众带来了可信的机器经济。</p><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mi"><img src="../Images/8e5cb53bbe1264f1ac274ce722ea2168.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2jlKqWNYU8cI_gxzlgWGAQ.png"/></div></div></figure><p id="b39d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">与我们保持联系！</p><blockquote class="mj mk ml"><p id="518a" class="jc jd mm je b jf jg jh ji jj jk jl jm mn jo jp jq mo js jt ju mp jw jx jy jz hn dt translated">网址:<a class="ae ka" href="https://iotex.io/" rel="noopener ugc nofollow" target="_blank">https://iotex.io/</a><br/>推特:<a class="ae ka" href="https://twitter.com/iotex_io" rel="noopener ugc nofollow" target="_blank">https://twitter.com/iotex_io</a><br/>电报公告频道:<a class="ae ka" href="https://t.me/iotexchannel" rel="noopener ugc nofollow" target="_blank">https://t.me/iotexchannel</a><br/>电报组:<a class="ae ka" href="https://t.me/IoTeXGroup" rel="noopener ugc nofollow" target="_blank">https://t.me/IoTeXGroup</a><br/>中:<a class="ae ka" rel="noopener" href="/@iotex">https://medium.com/@iotex</a><br/>Reddit:<a class="ae ka" href="https://www.reddit.com/r/IoTeX/" rel="noopener ugc nofollow" target="_blank">https://www.reddit.com/r/IoTeX/</a><br/>加入我们:<a class="ae ka" href="https://iotex.io/careers" rel="noopener ugc nofollow" target="_blank">https://iotex.io/careers</a></p></blockquote></div></div>    
</body>
</html>