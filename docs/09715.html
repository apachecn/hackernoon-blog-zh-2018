<html>
<head>
<title>AWS: Some Tips for Avoiding Those “Holy Bill” Moments</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS:一些避免“神圣法案”时刻的建议</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/aws-some-tips-for-avoiding-those-holy-bill-moments-9e48e0cb1a83?source=collection_archive---------16-----------------------#2018-11-30">https://medium.com/hackernoon/aws-some-tips-for-avoiding-those-holy-bill-moments-9e48e0cb1a83?source=collection_archive---------16-----------------------#2018-11-30</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="9866" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">云是令人敬畏的，但是当它咬回你的钱包时，它会非常疼。</h2></div><p id="62b4" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">云是令人敬畏的:几乎100%的可用性，几乎零维护，按需购买，最重要的是，无限扩展。</p><p id="343f" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">但是最后两个很容易反咬你一口，把这种牛逼变成一场收费噩梦。</p><p id="e514" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">偶尔你会看到这样的故事:</p><div class="kf kg fm fo kh ki"><a rel="noopener follow" target="_blank" href="/@asankha/lambda-programming-errors-that-could-cost-you-thousands-of-dollars-a-day-265dfac354f"><div class="kj ab ej"><div class="kk ab kl cl cj km"><h2 class="bd hv fv z el kn eo ep ko er et ht dt translated">Lambda编程错误可能会让你每天损失数千美元！</h2><div class="kp l"><h3 class="bd b fv z el kn eo ep ko er et ek translated">这是一个真实的故事。一个仍在发展的过程..一周之内，由于一个…</h3></div><div class="kq l"><p class="bd b gc z el kn eo ep ko er et ek translated">medium.com</p></div></div><div class="kr l"><div class="ks l kt ku kv kr kw kx ki"/></div></div></a></div><figure class="kz la lb lc fq ld fe ff paragraph-image"><div class="fe ff ky"><img src="../Images/48d775ce29a075aa43c741f9c8658f34.png" data-original-src="https://miro.medium.com/v2/resize:fit:286/0*f-IYiXflx9aZp0Dk"/></div><figcaption class="lf lg fg fe ff lh li bd b be z ek">Holy Bill!</figcaption></figure><p id="0a11" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在这里，我公布一些我们从构建世界上第一个无服务器IDE 的不太顺利的旅程中学到的技巧，可以帮助其他人避免一些“有趣的”陷阱。</p><h1 id="1b5f" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">小心那个配置！</h1><p id="3a53" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">我们学到的一件事是永远不要低估配置的力量。</p><p id="e897" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果你读了上面的链接文章，你会注意到这是一个简单的错误配置:一个<a class="ae lj" href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/enable-cloudtrail-events.html" rel="noopener ugc nofollow" target="_blank"> CloudTrail日志配置</a>将日志写到它已经监控的一个桶中。</p><p id="a236" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">你当然可以想出更复杂、更有创意的例子来创造“服务循环”,产生计费黑洞，但想法很简单:AWS的智能取决于配置它的人。</p><figure class="kz la lb lc fq ld fe ff paragraph-image"><div class="fe ff mh"><img src="../Images/e43a2994d40e53efbfc8cc855fa65e79.png" data-original-src="https://miro.medium.com/v2/resize:fit:300/0*RZx_O88UuHXEeqnW"/></div><figcaption class="lf lg fg fe ff lh li bd b be z ek">Welcome to Infinite Loop</figcaption></figure><p id="2bd7" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">(嗯，上面的案例是我的一个同事配置的，<em class="mi">我是</em>验证的人；所以你可以停在这里，如果你喜欢它；) )</p><p id="2971" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">所以，当你准备提交一个新的配置更新时，试着重新考虑一下后果。你不会后悔的。</p><h1 id="277b" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">这是S3，不是你的阁楼。</h1><p id="a63a" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated"><a class="ae lj" href="https://docs.aws.amazon.com/aws-technical-content/latest/cost-optimization-storage-optimization/introduction.html" rel="noopener ugc nofollow" target="_blank"> AWS估计</a>7%的云计费浪费在“未使用”的存储上——被没有实际用途的内容占用的空间:过时的捆绑包、临时上传、旧主机等等。</p><h2 id="08c3" class="mj ll hu bd lm mk ml mm lq mn mo mp lu js mq mr lw jw ms mt ly ka mu mv ma mw dt translated">水桶里的生活</h2><p id="cafc" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">然而，清理东西确实说起来容易做起来难。忘记一个废弃的文件比跟踪它并在适当的时候删除它要容易得多。</p><p id="a6d5" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">可能出于同样的原因，S3提供了<a class="ae lj" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/intro-lifecycle-rules.html" rel="noopener ugc nofollow" target="_blank">生命周期配置</a>——基于时间的自动清理计划。你可以简单的说“超过7天就删了这个”，7天就没了。</p><p id="0fc5" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这是保存临时存储(构建工件、一次性共享等)的理想方式。)在检查中，免提。</p><figure class="kz la lb lc fq ld fe ff paragraph-image"><div class="fe ff mx"><img src="../Images/af83b1f384e667d781d521f67c1fe0df.png" data-original-src="https://miro.medium.com/v2/resize:fit:296/0*PZ51VdnDBT0BhlwX"/></div><figcaption class="lf lg fg fe ff lh li bd b be z ek">Like that daily garbage truck.</figcaption></figure><p id="157c" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">当您想从存储桶中删除大量文件时，生命周期配置也很方便；而不是删除单个文件(这本身会导致API开销——虽然删除是免费的，但列表不是！，你可以简单地<a class="ae lj" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/lifecycle-expire-general-considerations.html" rel="noopener ugc nofollow" target="_blank">设置一个生命周期配置规则</a>，让所有东西在1天内过期。坐下来放松一下，S3会替你做这件事的！</p><pre class="kz la lb lc fq my mz na nb aw nc dt"><span id="c82f" class="mj ll hu mz b fv nd ne l nf ng">{<br/>    "Rules": [<br/>        {<br/>            "Status": "Enabled",<br/>            "Prefix": "",<br/>            "Expiration": {<br/>                "Days": 1<br/>            }<br/>        }<br/>    ]<br/>}</span></pre><p id="6063" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">或者，你可以把不再需要但还没准备好的东西搬进<a class="ae lj" href="https://aws.amazon.com/glacier/pricing/" rel="noopener ugc nofollow" target="_blank">冰川，只需存储成本的一小部分</a>；比方说，对于子路径<code class="eh nh ni nj mz b">archived</code>下的内容:</p><pre class="kz la lb lc fq my mz na nb aw nc dt"><span id="6048" class="mj ll hu mz b fv nd ne l nf ng">{<br/>    "Rules": [<br/>        {<br/>            "Filter": {<br/>                "Prefix": "archived"<br/>            },<br/>            "Status": "Enabled",<br/>            "Transitions": [<br/>                {<br/>                    "Days": 1,<br/>                    "StorageClass": "GLACIER"<br/>                }<br/>            ]<br/>        }<br/>    ]<br/>}</span></pre><p id="b327" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">但在此之前…</p><h2 id="46c2" class="mj ll hu bd lm mk ml mm lq mn mo mp lu js mq mr lw jw ms mt ly ka mu mv ma mw dt translated">哎哟，有版本了！</h2><p id="0e32" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated"><em class="mi">(灵感来源于真实事件。)</em></p><p id="c46d" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我设置了一个生命周期配置来删除大约3GB的桶访问日志(显然是数百万个文件)，并认为一切都很好——直到一个月后，我收到了与上个月相同的S3账单:(</p><p id="9ab8" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">结果是bucket已经启用了版本控制，所以<a class="ae lj" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/DeletingObjectVersions.html" rel="noopener ugc nofollow" target="_blank">删除并没有真正删除对象</a>。</p><p id="6d80" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">因此，启用版本控制后，您需要明确地告诉S3生命周期逻辑:</p><ul class=""><li id="45ea" class="nk nl hu jl b jm jn jp jq js nm jw nn ka no ke np nq nr ns dt translated"><a class="ae lj" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/lifecycle-configuration-examples.html#lifecycle-config-conceptual-ex6" rel="noopener ugc nofollow" target="_blank">丢弃非当前(已删除)对象版本</a>，以及</li><li id="0991" class="nk nl hu jl b jm nt jp nu js nv jw nw ka nx ke np nq nr ns dt translated"><a class="ae lj" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/lifecycle-configuration-examples.html#lifecycle-config-conceptual-ex7" rel="noopener ugc nofollow" target="_blank">过期旧删除标记</a></li></ul><p id="4096" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">为了完全去掉"已删除"的内容和关联的<a class="ae lj" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/DeleteMarker.html" rel="noopener ugc nofollow" target="_blank"> <em class="mi">删除标记</em> </a>。</p><p id="1ae5" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">“简单”的存储服务到此为止；)</p><h2 id="7875" class="mj ll hu bd lm mk ml mm lq mn mo mp lu js mq mr lw jw ms mt ly ka mu mv ma mw dt translated">CloudWatch是你的伙伴</h2><p id="8723" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">每当您想要<a class="ae lj" href="https://serverfault.com/questions/84815/how-can-i-get-the-size-of-an-amazon-s3-bucket#710080" rel="noopener ugc nofollow" target="_blank">找出您的存储桶所占用的总大小</a>，只需遍历您的<code class="eh nh ni nj mz b"><a class="ae lj" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/cloudwatch-monitoring.html" rel="noopener ugc nofollow" target="_blank">AWS/S3</a></code> <a class="ae lj" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/cloudwatch-monitoring.html" rel="noopener ugc nofollow" target="_blank"> CloudWatch度量名称空间</a>。惊讶吧，惊讶吧，没有办法从S3本地检查桶的大小；就连S3的仪表盘都依赖于CloudWatch，你为什么不呢？</p><p id="5a75" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">查看所有内容的快速片段？(使用<code class="eh nh ni nj mz b">bash</code>上的<code class="eh nh ni nj mz b"><a class="ae lj" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html" rel="noopener ugc nofollow" target="_blank">aws-cli</a></code>和<code class="eh nh ni nj mz b">bc</code>)</p><pre class="kz la lb lc fq my mz na nb aw nc dt"><span id="6a1d" class="mj ll hu mz b fv nd ne l nf ng">yesterday=$(date -d @$((($(date +%s)-86400))) +%F)<br/>for bucket in `aws s3api list-buckets --query 'Buckets[*].Name' --output text`; do<br/>        size=$(aws cloudwatch get-metric-statistics --namespace AWS/S3 --start-time ${yesterday}T00:00:00 --end-time $(date +%F)T00:00:00 --period 86400 --metric-name BucketSizeBytes --dimensions Name=StorageType,Value=StandardStorage Name=BucketName,Value=$bucket --statistics Average --output text --query 'Datapoints[0].Average')<br/>        if [ $size = "None" ]; then size=0; fi<br/>        printf "%8.3f  %s\n" $(echo $size/1048576 | bc -l) $bucket<br/>done</span></pre><h1 id="58fd" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">EC2:清扫垃圾，堵塞漏洞</h1><p id="0ba1" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">EC2使管理虚拟机(计算、存储和网络)变得轻而易举。然而，它的简单性也意味着它可能会留下一些不为人知的垃圾和账单漏洞。</p><figure class="kz la lb lc fq ld fe ff paragraph-image"><div class="fe ff ny"><img src="../Images/056af9d925b7d9d547f5e23f54a4a8d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:298/0*IOVSUVbHRWydeZ_r"/></div><figcaption class="lf lg fg fe ff lh li bd b be z ek">EC2: Elastic Compute Cloud</figcaption></figure><h2 id="1984" class="mj ll hu bd lm mk ml mm lq mn mo mp lu js mq mr lw jw ms mt ly ka mu mv ma mw dt translated">选择您的实例类型</h2><p id="a550" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">当创建一个新的实例时，有太多的设置。除非有特定的性能需求，否则选择一个具有<a class="ae lj" href="https://aws.amazon.com/ebs/" rel="noopener ugc nofollow" target="_blank">弹性块存储(EBS)支持的存储</a>和2–4gb RAM的<a class="ae lj" href="https://aws.amazon.com/ec2/instance-types/t2/" rel="noopener ugc nofollow" target="_blank"> T2级实例类型</a>将足以满足大多数需求。</p><p id="b993" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">尽管符合免费等级标准，但是如果您的服务器在某个时候能够接收计算或内存密集型负载，<code class="eh nh ni nj mz b">t2.micro</code>可能是一个PITA在这些情况下<code class="eh nh ni nj mz b">t2.micro</code>倾向于简单地冻结(可能与<a class="ae lj" href="https://forums.aws.amazon.com/thread.jspa?messageID=789458#jive-message-holder" rel="noopener ugc nofollow" target="_blank">耗尽CPU信用</a>有关)？)，造成得不偿失的麻烦。</p><h2 id="122c" class="mj ll hu bd lm mk ml mm lq mn mo mp lu js mq mr lw jw ms mt ly ka mu mv ma mw dt translated">清理ami和快照</h2><p id="244e" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">我们习惯于定期拍摄EC2实例的快照作为备份。其中一些被制作成<a class="ae lj" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html" rel="noopener ugc nofollow" target="_blank">机器映像(AMIs) </a>供重用或<a class="ae lj" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/sharingamis-explicit.html" rel="noopener ugc nofollow" target="_blank">与其他AWS用户共享</a>。</p><p id="04f2" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们很容易忘记其他的快照。</p><p id="0012" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">虽然快照<a class="ae lj" href="https://aws.amazon.com/ebs/pricing/#Amazon_EBS_Snapshots_to_Amazon_S3" rel="noopener ugc nofollow" target="_blank">不会因其完整卷大小</a>而被计费，但随着时间的推移，它们会累积成大量垃圾。因此，定期访问并清理您的<a class="ae lj" href="https://console.aws.amazon.com/ec2/v2/home#Snapshots" rel="noopener ugc nofollow" target="_blank"> EC2快照选项卡</a>非常重要。</p><p id="46a3" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">此外，创建新的非盟特派团通常意味着旧的非盟特派团将被淘汰；他们也可以从<a class="ae lj" href="https://console.aws.amazon.com/ec2/v2/home#Images" rel="noopener ugc nofollow" target="_blank"> AMIs标签</a>中“注销”。</p><p id="08b8" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">但是…</p><h2 id="adf6" class="mj ll hu bd lm mk ml mm lq mn mo mp lu js mq mr lw jw ms mt ly ka mu mv ma mw dt translated">谁是罪魁祸首——AMI还是snapshot？</h2><p id="e604" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">实际费用在<em class="mi">快照</em>上，而不是在AMIs本身上。</p><p id="cf4b" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这变得很棘手，因为<a class="ae lj" href="https://serverfault.com/questions/892384/why-aws-snapshot-is-not-removed-after-de-registering-aws-ami" rel="noopener ugc nofollow" target="_blank">取消注册AMI不会自动删除相应的快照</a>。</p><p id="8fce" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您通常需要复制AMI ID，转到快照，在描述字段中查找ID，然后销毁匹配的快照。或者，如果你很勇敢(也很懒)，选择并删除<em class="mi">所有</em>快照；AWS将阻止您删除AMI正在使用的文件。</p><h2 id="dcb6" class="mj ll hu bd lm mk ml mm lq mn mo mp lu js mq mr lw jw ms mt ly ka mu mv ma mw dt translated">同样，对于实例和卷</h2><p id="9387" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">当EC2实例运行时，对计算计费；但是它的<a class="ae lj" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSVolumes.html" rel="noopener ugc nofollow" target="_blank">存储卷</a>一直在计费——直到被删除。</p><p id="0ba8" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">当您终止一个实例时，卷通常会被销毁；但是，如果您尝试过卷附件设置，分离的卷可能会留在您的帐户中。虽然没有附加到实例，但它们仍然占用空间；所以AWS对它们收费。</p><p id="6117" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">同样，只需转到<a class="ae lj" href="https://console.aws.amazon.com/ec2/v2/home#Volumes" rel="noopener ugc nofollow" target="_blank">卷选项卡</a>，选择处于“可用”状态的卷，并点击delete以永久删除它们。</p><h2 id="8594" class="mj ll hu bd lm mk ml mm lq mn mo mp lu js mq mr lw jw ms mt ly ka mu mv ma mw dt translated">标记EC2的东西:实例、卷、快照、ami等等</h2><figure class="kz la lb lc fq ld fe ff paragraph-image"><div class="fe ff mh"><img src="../Images/a683f03c8ff3010d7a57b4a5f8e21613.png" data-original-src="https://miro.medium.com/v2/resize:fit:300/0*Das3GLpOt6LefhLn"/></div><figcaption class="lf lg fg fe ff lh li bd b be z ek">Tag ‘em.</figcaption></figure><p id="9da7" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">创建快照时，很容易忘记实例中的状态。或者运行/停止的实例的目的，似乎没有人对此负责。</p><p id="b75e" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">命名和标记有助于避免令人不快的意外(“你到底为什么删除上个月的生产快照？!");并且还能帮助你快速决定扔掉什么(“我们已经有了一个11-05的主快照，所以只需删除比它更早的)。</p><h2 id="3f3c" class="mj ll hu bd lm mk ml mm lq mn mo mp lu js mq mr lw jw ms mt ly ka mu mv ma mw dt translated">你停止使用，我们开始计费！</h2><p id="bd49" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">有时，AWS领主以神秘的方式工作。</p><p id="2abc" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">例如，<a class="ae lj" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html" rel="noopener ugc nofollow" target="_blank">弹性IP地址(EIP)</a>只要附加到正在运行的实例，就是免费的。但是实例一停止，他们就开始按小时收费；或者它们是否以某种方式进入了“分离”状态(没有连接到正在运行的实例)。</p><p id="9533" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">对你将要注册的服务有一些预先的了解，可以防止这种时尚的一些令人讨厌的惊喜。快速的价格页面查询或谷歌可能是一个交易破坏者。</p><h1 id="e4b8" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">按使用付费与按分配付费</h1><p id="1824" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">许多AWS服务遵循上述一种或两种模式。前者微不足道(你只需为你实际使用的时间/资源付费，其余时间享受零账单)，难以错过；但后者可能有点模糊，很容易被忽视。</p><p id="7665" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">考虑EC2:您主要为<a class="ae lj" href="https://aws.amazon.com/ec2/pricing/on-demand/" rel="noopener ugc nofollow" target="_blank">实例运行时</a>付费，但是您也为存储(卷、快照、ami)和<a class="ae lj" href="https://hackernoon.com/tagged/network" rel="noopener ugc nofollow" target="_blank">网络</a>分配(比如<strong class="jl hv">非活动</strong>弹性IP)付费，即使您的实例已经停止了几个月。</p><p id="b072" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">还有很多例子，特别是在<a class="ae lj" href="https://hackernoon.com/why-serverless-why-now-f09ce43c4767" rel="noopener ugc nofollow" target="_blank">无服务器领域</a>(我们自己也非常熟悉):</p><ul class=""><li id="d16c" class="nk nl hu jl b jm jn jp jq js nm jw nn ka no ke np nq nr ns dt translated"><strong class="jl hv"> Kinesis </strong>按碎片时间对<a class="ae lj" href="https://aws.amazon.com/kinesis/data-streams/pricing/" rel="noopener ugc nofollow" target="_blank">收费——即使你所有的碎片都是空闲的</a></li><li id="6793" class="nk nl hu jl b jm nt jp nu js nv jw nw ka nx ke np nq nr ns dt translated"><strong class="jl hv"> DynamoBB </strong>根据“容量单位”对<a class="ae lj" href="https://aws.amazon.com/dynamodb/pricing/" rel="noopener ugc nofollow" target="_blank">存储和读/写进行收费</a> —幸好有一个不会过期的自由层！</li><li id="d8f5" class="nk nl hu jl b jm nt jp nu js nv jw nw ka nx ke np nq nr ns dt translated"><strong class="jl hv"> RDS </strong>(非常类似于EC2)对实例运行时收费，不管是忙还是闲(<a class="ae lj" href="https://aws.amazon.com/rds/aurora/pricing/" rel="noopener ugc nofollow" target="_blank">极光无服务器</a>似乎试图在某种程度上改变这一点)</li><li id="1d57" class="nk nl hu jl b jm nt jp nu js nv jw nw ka nx ke np nq nr ns dt translated"><strong class="jl hv"> KMS </strong>对每个客户管理密钥<a class="ae lj" href="https://aws.amazon.com/kms/pricing/" rel="noopener ugc nofollow" target="_blank">收取固定费用(CMK) </a>不管你是否使用它</li></ul><figure class="kz la lb lc fq ld fe ff paragraph-image"><div class="fe ff mh"><img src="../Images/228b78b4eb6d6b2e853d7a22975db438.png" data-original-src="https://miro.medium.com/v2/resize:fit:300/0*7VbkcarBjciRLYop"/></div><figcaption class="lf lg fg fe ff lh li bd b be z ek">Each block adds a bit more to your cost.</figcaption></figure><p id="eec4" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">与此同时，一些服务秘密建立自己的监控、备份和其他“实用”实体。这些，虽然(大概！)本意是做好事，可偷偷渗入你的账单:</p><ul class=""><li id="7789" class="nk nl hu jl b jm jn jp jq js nm jw nn ka no ke np nq nr ns dt translated">DynamoDB设置<a class="ae lj" href="https://github.com/awslabs/serverless-application-model/issues/507" rel="noopener ugc nofollow" target="_blank"> CloudWatch告警</a>；即使在相应的表被删除后，这些表仍会保留下来(至少在通过CloudFormation管理时)。</li><li id="664b" class="nk nl hu jl b jm nt jp nu js nv jw nw ka nx ke np nq nr ns dt translated">RDS在终止时以及日常维护(esp)期间自动创建<a class="ae lj" href="https://aws.amazon.com/rds/details/backup/" rel="noopener ugc nofollow" target="_blank">实例卷快照</a>。当通过<a class="ae lj" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html" rel="noopener ugc nofollow" target="_blank">“默认”云编队配置</a>部署时；这些很容易超过您的存储配额</li></ul><p id="3675" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这些都是我们<a class="ae lj" href="https://hackernoon.com/tagged/aws" rel="noopener ugc nofollow" target="_blank"> AWS </a>账单中经常出现的罪魁祸首；当然还有更好的例子，但是你明白了。</p><h1 id="0be9" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">CloudWatch(是啊，又来了)</h1><p id="23a3" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">许多服务已经——或者可以配置为——向CloudWatch报告<a class="ae lj" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/aws-services-cloudwatch-metrics.html" rel="noopener ugc nofollow" target="_blank">使用指标</a>。因此，了解了哪些指标映射到哪些计费组件后(例如，S3存储成本由跨越<code class="eh nh ni nj mz b">AWS/S3</code>名称空间所有条目的<code class="eh nh ni nj mz b">BucketSizeBytes</code>指标的总和表示)，您可以围绕<a class="ae lj" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/working_with_metrics.html" rel="noopener ugc nofollow" target="_blank"> CloudWatch指标</a>构建一个完整的计费和监控解决方案(或者将工作委托给第三方服务，如<a class="ae lj" href="https://www.datadoghq.com/" rel="noopener ugc nofollow" target="_blank"> DataDog </a>)。</p><figure class="kz la lb lc fq ld fe ff paragraph-image"><div class="fe ff mh"><img src="../Images/88c73ea0f65761082c96dfc0c8188a3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:300/0*H-xEWWgpyd_RY1J8"/></div><figcaption class="lf lg fg fe ff lh li bd b be z ek">CloudWatch</figcaption></figure><p id="d5f2" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">CloudWatch本身基本上是免费的，它的指标有自动的总结机制，所以你不必担心它会被陈旧的垃圾淹没，或者被超出限制的容量账单淹没。</p><h1 id="e785" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">计费API</h1><p id="8b49" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">虽然AWS确实有一个专用的<a class="ae lj" href="https://console.aws.amazon.com/billing/home" rel="noopener ugc nofollow" target="_blank">计费仪表板</a>，但每天登录并查看它并不是你会添加到你的日程中的事情(至少对你我这样的API/CLI头脑来说不是)。</p><p id="dcb9" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">幸运的是，AWS提供了一个<a class="ae lj" href="https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/ce-api.html" rel="noopener ugc nofollow" target="_blank">计费API </a>,通过它，您可以在任何首选时间段内获得当前未结账单的详细视图——按服务或实际API操作细分。</p><p id="4ca8" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">问题是，这个API不是免费的:每次调用要花费你0.01美元。当然，这是可以忽略不计的——考虑到不得不支付几十笔费用的风险——甚至在某些情况下支付数百或数千美元——有一个每月0.30美元的账单监视器来跟踪任何异常情况是值得的，以免为时过晚。</p><p id="e97b" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">思考:随着对谷歌云功能的<a class="ae lj" href="https://cloud.google.com/blog/products/gcp/introducing-headless-chrome-support-in-cloud-functions-and-app-engine" rel="noopener ugc nofollow" target="_blank">提供的</a><a class="ae lj" href="https://developers.google.com/web/updates/2017/04/headless-chrome" rel="noopener ugc nofollow" target="_blank">无头浏览器</a>的支持，人们可能能够建立一个无服务器的工作流程，登录AWS仪表板并为你检查账单。一些可以在空闲时间尝试的东西(如果一些有独创性的人还没有一起破解的话)。</p><h1 id="e81c" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">计费提醒</h1><p id="4f39" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">奇怪的是(或许不是；))AWS没有提供一种为计费设置硬性限制的方法；尽管<a class="ae lj" href="https://news.ycombinator.com/item?id=13072296" rel="noopener ugc nofollow" target="_blank">大量的用户请求</a>和令人不安的事件报道遍布网络。相反，他们为各种计费“级别”提供<a class="ae lj" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/monitor_estimated_charges_with_cloudwatch.html" rel="noopener ugc nofollow" target="_blank">警报</a>；您可以通过电子邮件或社交网络订阅通知，如“账单金额为限额的x%”和“超出限额”(方便通过Lambda 实现<a class="ae lj" href="https://slappforge.com/docs/sigma/components/aws/sns.html#sns-as-a-trigger" rel="noopener ugc nofollow" target="_blank">自动化！).</a></p><p id="a402" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jl hv">我的建议:</strong>这是每个AWS账户必备的<strong class="jl hv"/>。如果我们有一个，到目前为止，我们已经节省了数千美元。</p><figure class="kz la lb lc fq ld fe ff paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="fe ff nz"><img src="../Images/a6bcbab663e6ccec0ca7648d7277c754.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mhNikTFnXgbrYI_8.jpg"/></div></div><figcaption class="lf lg fg fe ff lh li bd b be z ek">Don’t wait till they become worthless pieces of plastic.</figcaption></figure><h1 id="ae8d" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">组织帐户</h1><p id="a0f6" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">如果您想将AWS访问授权给第三方(测试团队、基于合同的开发人员、演示用户等)。)，通过将您的root帐户转换为启用了合并计费的<a class="ae lj" href="https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/consolidated-billing.html" rel="noopener ugc nofollow" target="_blank"> AWS组织来创建子帐户可能是个好主意。</a></p><p id="603b" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">(虽然使用一个<a class="ae lj" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html" rel="noopener ugc nofollow" target="_blank"> IAM用户</a>可以做几乎相同的事情，但是它不提供资源隔离；所有的东西都将被塞进同一个账户，而且可能需要煞费苦心的复杂IAM策略来隔离用户之间的实体。)</p><p id="18fc" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们的<a class="ae lj" href="https://lk.linkedin.com/in/asankha" rel="noopener ugc nofollow" target="_blank">首席执行官兼同事Asankha </a>已经<a class="ae lj" rel="noopener" href="/@asankha/creating-isolated-aws-accounts-for-testing-and-experimentation-9795a8d2e2de">就此写了相当全面的文章</a>，所以我就讲到这里。</p><h1 id="0cd5" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">最后:显示器。监视器。监视器。</h1><p id="7c90" class="pw-post-body-paragraph jj jk hu jl b jm mc iv jo jp md iy jr js me ju jv jw mf jy jz ka mg kc kd ke hn dt translated">没有必要强调这一点——我没完没了的漫谈已经传达了它的重要性。</p><p id="d698" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">所以，祝你好运！</p></div><div class="ab cl oe of hc og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="hn ho hp hq hr"><p id="2151" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><em class="mi">原载于2018年11月30日</em><a class="ae lj" href="http://randomizd.blogspot.com/2018/11/aws-some-tips-for-avoiding-those-holy.html?m=1" rel="noopener ugc nofollow" target="_blank"><em class="mi">randomizd.blogspot.com</em></a><em class="mi">。</em></p><figure class="kz la lb lc fq ld"><div class="bz el l di"><div class="ol om l"/></div></figure></div></div>    
</body>
</html>