<html>
<head>
<title>How to make SnapChat Lenses using Computer Vision?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用计算机视觉制作SnapChat镜头？</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-make-snapchat-lenses-f9eae861b5db?source=collection_archive---------8-----------------------#2018-12-10">https://medium.com/hackernoon/how-to-make-snapchat-lenses-f9eae861b5db?source=collection_archive---------8-----------------------#2018-12-10</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="9e81" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们都喜欢SnapChat镜头/滤镜，但有没有想过如何自己制作？本文解释了如何使用python和计算机视觉库(如opencv和dlib)来创建自己的“眼镜和小胡子透镜”，代码只有80行。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff jp"><img src="../Images/8b174dffa7fc691f36a7c9174ce8aa36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*yCyEOoUBa-oYYT9xyr1mKA.gif"/></div></figure><h1 id="e038" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">什么是dlib？</h1><p id="6960" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">Dlib是一个现代C++工具包，包含机器学习算法和工具，用于用C++创建复杂的软件来解决现实世界的问题。它广泛应用于工业和学术界，包括机器人、嵌入式设备、移动电话和大型高性能计算环境。Dlib的开源许可允许您在任何应用程序中免费使用它。[ <a class="ae la" href="http://dlib.net/" rel="noopener ugc nofollow" target="_blank">来源</a></p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lb lc l"/></div></figure><h1 id="5450" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">OpenCV是什么？</h1><p id="09ec" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">OpenCV(开源计算机视觉)是一个主要针对实时计算机视觉的编程函数库。该库是跨平台的，在开源BSD许可下可以免费使用。OpenCV支持深度学习框架TensorFlow、Torch/PyTorch和Caffe。[ <a class="ae la" href="https://en.wikipedia.org/wiki/OpenCV" rel="noopener ugc nofollow" target="_blank">来源</a></p></div><div class="ab cl ld le hc lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hn ho hp hq hr"><p id="18fa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们试着在下图的道恩·强森上实现一个SnapChat过滤器。出于本教程的目的，我们将添加一副眼镜和一个小胡子。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff lk"><img src="../Images/a96eac53a9a68163babb42e429ddc329.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9kLoQU6mIBKoorH1EQXdEg.jpeg"/></div></div></figure><p id="6147" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，导入所有需要的库:</p><pre class="jq jr js jt fq lp lq lr ls aw lt dt"><span id="ffbf" class="lu jy hu lq b fv lv lw l lx ly">import cv2<br/>import numpy as np<br/>import glob<br/>import os<br/>import dlib</span></pre><p id="61f5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">阅读所有的图像文件，我们想覆盖在道恩·强森的脸。我们将使用如下所示的眼镜和胡子。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff lz"><img src="../Images/450c3a7cdef9822d3320049f610bc90d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*ETBZMTHMEmk9n-fPdQO2vA.png"/></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">glasses</figcaption></figure><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff lz"><img src="../Images/9551e61999dc5d0607b8f561b5525f91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*R-utGCtvBqGXnwq361JJAA.png"/></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">mustache</figcaption></figure><p id="cc41" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在下面的代码片段中，我们加载小胡子和眼镜图像，并创建我们的图像遮罩。图像遮罩用于从图像中选择我们想要显示的部分。当我们将小胡子图像覆盖在背景图像上时，我们需要确定应该显示小胡子图像中的哪些像素，以及应该显示背景图像中的哪些图像。蒙版用于标识在应用于图像时应该使用哪些像素。</p><p id="1590" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们用-1(负一)作为第二个参数来加载小胡子/眼镜，以加载图像中的所有层。图像由4层(或通道)组成:蓝色，绿色，红色和一个阿尔法透明层(称为BGR-A)。alpha通道告诉我们图像中的哪些像素应该是透明的，哪些应该是不透明的(由其他3层组合而成)。然后，我们只需阿尔法层，并创建一个新的单层图像，我们将用于遮罩。我们把面具反过来。初始遮罩将定义小胡子/眼镜的区域，而反向遮罩将用于小胡子/眼镜周围的区域。然后，我们将小胡子/眼镜图像转换为3通道BGR图像。保存原来的小胡子/眼镜图像尺寸，我们将在以后调整小胡子/眼镜图像大小时使用。</p><pre class="jq jr js jt fq lp lq lr ls aw lt dt"><span id="3e95" class="lu jy hu lq b fv lv lw l lx ly">imgMustache = cv2.imread("mustache.png", -1)<br/>orig_mask = imgMustache[:,:,3]<br/>orig_mask_inv = cv2.bitwise_not(orig_mask)<br/>imgMustache = imgMustache[:,:,0:3]<br/>origMustacheHeight, origMustacheWidth = imgMustache.shape[:2]</span><span id="7c40" class="lu jy hu lq b fv me lw l lx ly">imgGlass = cv2.imread("glasses.png", -1)<br/>orig_mask_g = imgGlass[:,:,3]<br/>orig_mask_inv_g = cv2.bitwise_not(orig_mask_g)<br/>imgGlass = imgGlass[:,:,0:3]<br/>origGlassHeight, origGlassWidth = imgGlass.shape[:2]</span></pre><p id="544b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦阅读完成。先说人脸检测。有几种方法可以做到这一点。</p><ol class=""><li id="fa55" class="mf mg hu it b iu iv iy iz jc mh jg mi jk mj jo mk ml mm mn dt translated">dlib人脸检测</li><li id="c152" class="mf mg hu it b iu mo iy mp jc mq jg mr jk ms jo mk ml mm mn dt translated">OpenCV人脸检测</li><li id="84f6" class="mf mg hu it b iu mo iy mp jc mq jg mr jk ms jo mk ml mm mn dt translated">TenesorflowSSD人脸检测</li></ol><p id="5232" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将使用dlib人脸检测超过其他两个原因。</p><ol class=""><li id="c653" class="mf mg hu it b iu iv iy iz jc mh jg mi jk mj jo mk ml mm mn dt translated">要使用Tensorflow，我们需要训练自己的人脸检测模型，因为没有预先训练的模型可用。</li><li id="6bbf" class="mf mg hu it b iu mo iy mp jc mq jg mr jk ms jo mk ml mm mn dt translated">与OpenCV相比，dlib似乎提供了更好的准确性。</li></ol><pre class="jq jr js jt fq lp lq lr ls aw lt dt"><span id="ccf8" class="lu jy hu lq b fv lv lw l lx ly"># 68 point detector on face<br/>predictor_path = "shape_predictor_68_face_landmarks.dat"<br/># face detection modal<br/>face_rec_model_path = "dlib_face_recognition_resnet_model_v1.dat"</span><span id="0ed2" class="lu jy hu lq b fv me lw l lx ly">cnn_face_detector=dlib.cnn_face_detection_model_v1("mmod_human_face_detector.dat")</span><span id="a76a" class="lu jy hu lq b fv me lw l lx ly">detector=dlib.get_frontal_face_detector()<br/>predictor = dlib.shape_predictor(predictor_path)</span></pre><p id="4235" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">dlib 68点检测器将检测以下面部点</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff mt"><img src="../Images/fe3f8b440fe4c10fa548234e9cc6f698.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*aYZ66mrQy1PzkwP_zIYMKA.png"/></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">dlib face points map</figcaption></figure><p id="541d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我们将开始从网络摄像头或视频文件中捕捉帧，然后我们将检测这些帧中的人脸，还将检测人脸上的68个点以应用过滤器。</p><pre class="jq jr js jt fq lp lq lr ls aw lt dt"><span id="fe7b" class="lu jy hu lq b fv lv lw l lx ly">ret, frame = video_capture.read()  <br/>dets = cnn_face_detector(frame, 1) <br/>for k, d in enumerate(dets):  <br/>    shape = predictor(frame, d.rect)</span></pre><p id="5505" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在点31和35是鼻子的长度，所以我们将认为小胡子是鼻子长度的3倍，并且高度与原始图片相关。将numpy数组应用于原始帧。</p><pre class="jq jr js jt fq lp lq lr ls aw lt dt"><span id="d8df" class="lu jy hu lq b fv lv lw l lx ly">mustacheWidth = abs(3 * (shape.part(31).x - shape.part(35).x))<br/>mustacheHeight = int(mustacheWidth * origMustacheHeight / origMustacheWidth) - 10<br/>mustache = cv2.resize(imgMustache, (mustacheWidth,mustacheHeight), interpolation = cv2.INTER_AREA)<br/>mask = cv2.resize(orig_mask, (mustacheWidth,mustacheHeight), interpolation = cv2.INTER_AREA)<br/>mask_inv = cv2.resize(orig_mask_inv, (mustacheWidth,mustacheHeight), interpolation = cv2.INTER_AREA)<br/>y1 = int(shape.part(33).y - (mustacheHeight/2)) + 10<br/>y2 = int(y1 + mustacheHeight)<br/>x1 = int(shape.part(51).x - (mustacheWidth/2))<br/>x2 = int(x1 + mustacheWidth)<br/>roi = frame[y1:y2, x1:x2]<br/>roi_bg = cv2.bitwise_and(roi,roi,mask = mask_inv)<br/>roi_fg = cv2.bitwise_and(mustache,mustache,mask = mask)<br/>frame[y1:y2, x1:x2] = cv2.add(roi_bg, roi_fg)</span></pre><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff lk"><img src="../Images/27d986241bfc363012783c95c2e75514.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JIeEEzcqxV-Seqv_Wi3FZg.jpeg"/></div></div></figure><p id="e2cd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，让我们戴上眼镜。点1和16将是玻璃宽度，高度是相对的。</p><pre class="jq jr js jt fq lp lq lr ls aw lt dt"><span id="32fa" class="lu jy hu lq b fv lv lw l lx ly">glassWidth = abs(shape.part(16).x - shape.part(1).x)<br/>glassHeight = int(glassWidth * origGlassHeight / origGlassWidth)<br/>glass = cv2.resize(imgGlass, (glassWidth,glassHeight), interpolation = cv2.INTER_AREA)<br/>mask = cv2.resize(orig_mask_g, (glassWidth,glassHeight), interpolation = cv2.INTER_AREA)<br/>mask_inv = cv2.resize(orig_mask_inv_g, (glassWidth,glassHeight), interpolation = cv2.INTER_AREA)<br/>y1 = int(shape.part(24).y)<br/>y2 = int(y1 + glassHeight)<br/>x1 = int(shape.part(27).x - (glassWidth/2))<br/>x2 = int(x1 + glassWidth)<br/>roi1 = frame[y1:y2, x1:x2]<br/>roi_bg = cv2.bitwise_and(roi1,roi1,mask = mask_inv)<br/>roi_fg = cv2.bitwise_and(glass,glass,mask = mask)<br/>frame[y1:y2, x1:x2] = cv2.add(roi_bg, roi_fg)</span></pre><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff lk"><img src="../Images/3b7581c0b6301df705864647d5b9f433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ZCJEKZsi_KWIgj247TqoA.jpeg"/></div></div></figure></div><div class="ab cl ld le hc lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hn ho hp hq hr"><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mu lc l"/></div></figure><h1 id="422a" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">结论</h1><p id="42f5" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">这将不会像SnapChat镜头那样好，但它是创建一个像SnapChat一样的强大基础。此外，创建自己的定制镜头比使用SnapChat提供的镜头有趣得多。你可以在下面归档全部代码。</p><div class="mv mw fm fo mx my"><a href="https://github.com/smitshilu/SnapChatFilterExample" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab ej"><div class="na ab nb cl cj nc"><h2 class="bd hv fv z el nd eo ep ne er et ht dt translated">smit Shilu/SnapChatFilterExample</h2><div class="nf l"><h3 class="bd b fv z el nd eo ep ne er et ek translated">SnapChat过滤器的小例子。通过在…上创建帐户，为smit Shilu/SnapChatFilterExample开发做出贡献</h3></div><div class="ng l"><p class="bd b gc z el nd eo ep ne er et ek translated">github.com</p></div></div><div class="nh l"><div class="ni l nj nk nl nh nm jv my"/></div></div></a></div></div><div class="ab cl ld le hc lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hn ho hp hq hr"><p id="5bde" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你喜欢这篇文章请别忘了关注我关于<a class="ae la" rel="noopener" href="/@smitshilu"> <strong class="it hv"> <em class="nn">中</em> </strong> </a> <strong class="it hv"> <em class="nn"> </em> </strong>或者<strong class="it hv"><em class="nn"/></strong><a class="ae la" href="https://github.com/smitshilu" rel="noopener ugc nofollow" target="_blank"><strong class="it hv"><em class="nn">Github</em></strong></a><strong class="it hv"><em class="nn">。</em> </strong>或者订阅我的<a class="ae la" href="http://www.youtube.com/c/SmitShilu" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv"> <em class="nn"> YouTube频道</em> </strong> </a>。</p></div></div>    
</body>
</html>