<html>
<head>
<title>DevOps101 — First Steps on Terraform: Terraform + OpenStack + Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">devo PS 101—terra form的第一步:Terraform + OpenStack + Ansible</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/terraform-openstack-ansible-d680ea466e22?source=collection_archive---------2-----------------------#2018-12-14">https://medium.com/hackernoon/terraform-openstack-ansible-d680ea466e22?source=collection_archive---------2-----------------------#2018-12-14</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="9b6f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我目前是一名教师助理👨‍💻<em class="jp"> @ </em> <a class="ae jq" href="https://tecnico.ulisboa.pt/en/" rel="noopener ugc nofollow" target="_blank"> <em class="jp"> Técnico葡京</em> </a> <em class="jp">，我正与</em><a class="ae jq" href="https://fenix.tecnico.ulisboa.pt/homepage/ist40132" rel="noopener ugc nofollow" target="_blank"><em class="jp">Rui Cruz</em></a>博士教授密切合作👨‍🏫<em class="jp">at</em><a class="ae jq" href="https://fenix.tecnico.ulisboa.pt/disciplinas/AGISIT/2018-2019/1-semestre" rel="noopener ugc nofollow" target="_blank"><em class="jp">it基础设施管理与行政</em> </a> <em class="jp"> </em> 🖥 <em class="jp">、a </em>大师级课程<em class="jp"> @ </em> <a class="ae jq" href="https://tecnico.ulisboa.pt/en/" rel="noopener ugc nofollow" target="_blank"> <em class="jp"> Técnico葡京</em> </a>。</p><p id="3cb6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本教程旨在向您介绍Terraform。Terraform将利用OpenStack上的基础设施部署。Ansible将提供已部署的机器。我们将使用vagger来管理安装了Terraform和Ansible的机器。</p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><p id="ff56" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在<a class="ae jq" href="https://hackernoon.com/devops101-itinfrastructure-54337d6a148b" rel="noopener ugc nofollow" target="_blank">DevOps 101——基础设施作为带有流浪者(灯栈)的代码</a>中，我介绍了敏捷devo PS运动。它的目的是自动化工作，让你更快地启动。</p><p id="9dab" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你打算开始一项业务或副业，你必须考虑的是DevOps。你为什么要在乎？随着业务需求的增长，您会有不同的基础架构需求。因此，如果您从一开始就以正确的方式构建一切，那么更改和升级的成本将会更低。时间不多了，我们来介绍一下:</p><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div class="fe ff jy"><img src="../Images/0d4a2d44c30e95188c20c3751f57770c.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/format:webp/1*jrHI1MCKYpM2lNQEsNFq4Q.png"/></div></figure><p id="93f3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Terraform旨在提供一个工作流程来管理基础设施。它允许您定义基础设施，以最小的成本进行更改和部署更改。</p><p id="23de" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该方案综合了Terraform的工作原理:</p><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff kg"><img src="../Images/24b03b1ecde402ce4d42933bd49e2ae2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lYFNHNM03biX_95IQMayUw.png"/></div></div></figure><p id="5554" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Terraform依赖于。定义基础设施(地形实例)的tf文件。Terraform通过状态文件知道部署了什么。默认情况下，此状态存储在名为“terraform.tfstate”的本地文件中。它也可以远程存储，这在团队环境中效果更好。Terraform允许几个提供者，通常在一个名为terraform-provider.tf的文件中初始化。如果您想更详细地了解它是如何工作的，<a class="ae jq" href="https://www.youtube.com/watch?v=h970ZBgKINg" rel="noopener ugc nofollow" target="_blank">查看terraform的这个介绍视频，</a>。</p><h1 id="22c5" class="kl km hu bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li dt translated">要求</h1><p id="a5a7" class="pw-post-body-paragraph ir is hu it b iu lj iw ix iy lk ja jb jc ll je jf jg lm ji jj jk ln jm jn jo hn dt translated"><a class="ae jq" href="https://github.com/RafaelAPB/devops101-terraform-ansible-openstack" rel="noopener ugc nofollow" target="_blank">这个实验的代码在Github </a>上。<a class="ae jq" href="https://help.github.com/articles/fork-a-repo/" rel="noopener ugc nofollow" target="_blank">分叉仓库</a>然后<a class="ae jq" href="https://help.github.com/articles/cloning-a-repository/" rel="noopener ugc nofollow" target="_blank">克隆它。</a></p><p id="9e68" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">强烈推荐你用流浪。如果你不知道什么是流浪者或者它是如何工作的，<a class="ae jq" href="https://hackernoon.com/devops101-vagrant-6737c8c29904" rel="noopener ugc nofollow" target="_blank">这篇文章很适合你(它甚至一步一步地解释了如何配置这个工具和它们的依赖关系)</a>。</p><h1 id="dcfa" class="kl km hu bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li dt translated">在我们开始之前…</h1><p id="84c3" class="pw-post-body-paragraph ir is hu it b iu lj iw ix iy lk ja jb jc ll je jf jg lm ji jj jk ln jm jn jo hn dt translated">第一步:了解你的资源。</p><p id="aa84" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您打开支持文件，您将看到几个文件类型:。tf，。yml，。cfg，。嘘和一个流浪的档案。</p><p id="34b3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们可以看到3个逻辑组:与流浪者、Ansible和Terraform相关的文件。流浪者为您提供一个虚拟机，其中包含运行Terraform所需的软件。或者，如果不想使用虚拟机，可以在主机上安装Terraform。</p><p id="4260" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Ansible是一个开源工具，旨在简化供应。Ansible将通过Terraform连接到已部署的实例。之后，它会安装所需的软件。</p><p id="aece" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，Terraform将负责部署基础设施。</p><p id="08b3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">第二步:初始化虚拟机。</strong></p><p id="a3b7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在保存支持文件的同一个目录下，运行<em class="jp">运行</em>并等待机器启动。注意，流浪者将当前文件夹与<em class="jp"> terraform-experiment同步。</em></p><p id="d166" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们为下一步做好了准备。</p><p id="791a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">第三步:了解Terraform支持文件。</strong></p><p id="e8ec" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">研究terraform-provider.tf:</p><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff lo"><img src="../Images/4a8fc3a04ef04e3b06f8adb1065caedc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UWBPPOWEj53V5hdgGic0WA.png"/></div></div><figcaption class="lp lq fg fe ff lr ls bd b be z ek">Created with carbon.sh (check it out)</figcaption></figure><p id="ea80" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如您所见，这个文件中有几个变量声明。一些将要传递给我们的提供者的变量。</p><p id="95f0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Terraform的提供者以不同的方式初始化，因为它们有不同的API。换句话说，您需要为正在使用的每个提供程序设置不同的变量。<a class="ae jq" href="https://www.terraform.io/docs/providers/openstack/" rel="noopener ugc nofollow" target="_blank">这里列出了OpenStack需要的变量</a>。对于这个实验，我将使用我大学的私有云，基于OpenStack。例如，您可以使用<a class="ae jq" href="https://www.suse.com/pt-br/products/suse-openstack-cloud/" rel="noopener ugc nofollow" target="_blank"> SUSE OpenStack Cloud </a>、<a class="ae jq" href="https://www.terraform.io/docs/providers/opentelekomcloud/index.html" rel="noopener ugc nofollow" target="_blank"> OpenTelekomCloud </a>或任何基于OpenStack的私有云。Y <a class="ae jq" href="https://www.mirantis.com/blog/how-to-install-openstack-on-your-local-machine-using-devstack/" rel="noopener ugc nofollow" target="_blank">您可以在本地安装OpenStack】，并从那里运行(最便宜的解决方案)。</a></p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><p id="61f0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来的<strong class="it hv"> DevOps101 </strong> ☄️，关于如何使用Terraform在谷歌云引擎上部署基础设施的教程，敬请关注！<a class="ae jq" href="https://emojipedia.org/unicorn-face/" rel="noopener ugc nofollow" target="_blank">🦄</a></p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><p id="9cc6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要访问您的提供商，您需要填写必需的变量:</p><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff lt"><img src="../Images/7a4f5aac5a90a279d1f92d0105527335.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ggGKTXiA0VaEJZvb-P1xfw.png"/></div></div></figure><p id="33a0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">第4步:了解您想要部署的基础设施</strong></p><p id="4a28" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，研究一下<em class="jp"> terraform-instances.tf </em>和<em class="jp"> terraform-networks.tf </em>文件。他们在定义什么？他们是如何做到的？</p><p id="09f8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在<em class="jp"> terraform-networks.tf </em>上，我们正在创建一个前端网络、一个子网并定义一个安全组。安全组允许从<a class="ae jq" href="https://www.grc.com/port_443.htm" rel="noopener ugc nofollow" target="_blank">端口443 </a>接收连接。文件<em class="jp"> terraform-instances.tf定义了</em>两个web服务器和一个负载均衡器。然后，它将它们分配给一个网络、一个安全组和一个子网。</p><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff lu"><img src="../Images/fb69331f549e796cf25624bac34d2029.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-6S4libH8j5BIzmiPTl0gA.png"/></div></div></figure><h1 id="b671" class="kl km hu bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li dt translated">让我们开始行动吧！</h1><p id="1cac" class="pw-post-body-paragraph ir is hu it b iu lj iw ix iy lk ja jb jc ll je jf jg lm ji jj jk ln jm jn jo hn dt translated">生成公私密钥对。此密钥对将存储在/home/中。ssh/。您可以通过以下方式生成密钥(通过按ENTER键跳过所有提示):</p><pre class="jz ka kb kc fq lv lw lx ly aw lz dt"><span id="0093" class="ma km hu lw b fv mb mc l md me">$ ssh-keygen -t rsa -b 2048</span></pre><p id="8ad2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您的密钥对将由Terraform (terraform.tfvars)导入。</p><p id="d8e2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，我们想把我们的计划应用到现实世界中。请注意，Terraform有五个基本命令，允许我们处理端到端的工作流:</p><ul class=""><li id="9d04" class="mf mg hu it b iu iv iy iz jc mh jg mi jk mj jo mk ml mm mn dt translated"><strong class="it hv"> terraform init: </strong>该<strong class="it hv"> </strong>命令用于初始化包含terraform配置文件的工作目录。</li><li id="1e01" class="mf mg hu it b iu mo iy mp jc mq jg mr jk ms jo mk ml mm mn dt translated"><strong class="it hv"> terraform刷新:</strong>该命令用于协调terraform了解的状态(通过其状态文件)与现实基础设施。</li><li id="09e4" class="mf mg hu it b iu mo iy mp jc mq jg mr jk ms jo mk ml mm mn dt translated"><strong class="it hv">地形计划:</strong>创建执行计划。Terraform执行刷新，然后确定需要采取哪些操作来实现配置文件中指定的所需状态。</li><li id="ceb4" class="mf mg hu it b iu mo iy mp jc mq jg mr jk ms jo mk ml mm mn dt translated"><strong class="it hv"> terraform apply: A </strong>应用所需的更改，以达到所需的配置状态。</li><li id="7faa" class="mf mg hu it b iu mo iy mp jc mq jg mr jk ms jo mk ml mm mn dt translated"><strong class="it hv">地形摧毁:</strong>摧毁<strong class="it hv"> </strong>由地形管理的基础设施。</li></ul><p id="fddb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，我们需要初始化工作目录。这是在编写新的Terraform配置后应该运行的第一个命令。运行:</p><pre class="jz ka kb kc fq lv lw lx ly aw lz dt"><span id="9beb" class="ma km hu lw b fv mb mc l md me">$ terraform init</span></pre><p id="c504" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它应该输出类似如下的内容:</p><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff mt"><img src="../Images/9abf19fc84e936e67ac09fd90079cd63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zJIIFnSqdN0J4HMjMR9GEQ.png"/></div></div></figure><p id="ab56" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了了解Terraform必须对提供者进行哪些更改，请运行:</p><pre class="jz ka kb kc fq lv lw lx ly aw lz dt"><span id="7c5a" class="ma km hu lw b fv mb mc l md me">$ terraform plan</span></pre><p id="2b3f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">输出指定了计划:</p><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff mu"><img src="../Images/36ee3c8f4d456cdf9dc3bd77dd1b21f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xyOMjoW_qpwk6Zruqlz78g.png"/></div></div></figure><p id="989a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在是部署基础设施的时候了。运行:</p><pre class="jz ka kb kc fq lv lw lx ly aw lz dt"><span id="9ed6" class="ma km hu lw b fv mb mc l md me">$ terraform apply</span></pre><p id="344f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">到目前为止，您的基础设施已经部署完毕。</p><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff lu"><img src="../Images/e5a05aab3d1a81b8c9773486437523b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MOVM4gksvc_SmbWSp0rZ9g.png"/></div></div></figure><p id="5e52" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了供应机器，我们将使用Ansible。我用了Oliver Louvignes的这个角色集合。要告诉Ansible将哪些机器作为目标，请替换file <em class="jp">主机上机器的IP。</em>如果找不到，运行<em class="jp">地形输出。</em>现在，运行安装节点的行动手册:</p><pre class="jz ka kb kc fq lv lw lx ly aw lz dt"><span id="d546" class="ma km hu lw b fv mb mc l md me">$ ansible-playbook site-servers-setup-all.yml</span></pre><p id="4e23" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就是这样。您有一个由两个web服务器组成的系统(没有任何负载平衡),在OpenStack提供者上运行Node。接下来，在<em class="jp">"</em><strong class="it hv">devo PS 101</strong>☄️<em class="jp">"，</em>我们将部署一个由两个web服务器和一个负载均衡器组成的系统。</p><h1 id="c72a" class="kl km hu bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li dt translated">结束实验</h1><p id="5868" class="pw-post-body-paragraph ir is hu it b iu lj iw ix iy lk ja jb jc ll je jf jg lm ji jj jk ln jm jn jo hn dt translated">使用两个命令，您将结束实验并关闭虚拟机。这些是:</p><pre class="jz ka kb kc fq lv lw lx ly aw lz dt"><span id="e150" class="ma km hu lw b fv mb mc l md me">$ terraform destroy -auto-approve<br/>$ exit<br/>$ vagrant halt<br/></span></pre><p id="b514" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果要销毁您创建的虚拟机，请运行:</p><pre class="jz ka kb kc fq lv lw lx ly aw lz dt"><span id="4e62" class="ma km hu lw b fv mb mc l md me">$ vagrant destroy</span></pre><p id="9a7f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">恭喜你！💯你到达终点了！T24】🦄</p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><h1 id="179e" class="kl km hu bd kn ko mv kq kr ks mw ku kv kw mx ky kz la my lc ld le mz lg lh li dt translated">后续步骤:</h1><h2 id="6c26" class="ma km hu bd kn na nb nc kr nd ne nf kv jc ng nh kz jg ni nj ld jk nk nl lh nm dt translated">如果你喜欢这篇文章，请订阅我的邮件列表。这里是👇。这对我意义重大。</h2><figure class="jz ka kb kc fq kd fe ff paragraph-image"><a href="http://eepurl.com/go_uUD"><div class="fe ff nn"><img src="../Images/b802eda461e56087a1ffff179f0e2459.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/1*MAwoJUN3vK5V6BTJdIKOBA.png"/></div></a></figure></div></div>    
</body>
</html>