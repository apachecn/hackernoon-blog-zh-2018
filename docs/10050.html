<html>
<head>
<title>Build your own CI/CD pipeline with Drone</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用无人机构建您自己的CI/CD管道</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/build-your-own-ci-cd-pipeline-with-drone-e43d7190989b?source=collection_archive---------3-----------------------#2018-12-14">https://medium.com/hackernoon/build-your-own-ci-cd-pipeline-with-drone-e43d7190989b?source=collection_archive---------3-----------------------#2018-12-14</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/11b95a6802d59117a92ab29a8264dda2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*utMM3g0RjLCMFDGN"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Photo credit unsplash.com</figcaption></figure><blockquote class="jg jh ji"><p id="11d5" class="jj jk jl jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated"><strong class="jm hv">TL；博士</strong></p><p id="134c" class="jj jk jl jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated">这主要是一篇烹饪书风格的文章。如果你期望更多的理论指导，我建议你看看<a class="ae ki" href="https://docs.drone.io" rel="noopener ugc nofollow" target="_blank">官方无人机文档</a>和<a class="ae ki" href="https://www.amazon.com/Continuous-Integration-Improving-Software-Reducing/dp/0321336380" rel="noopener ugc nofollow" target="_blank">持续集成</a>和<a class="ae ki" href="https://www.amazon.com/Continuous-Delivery-Deployment-Automation-Addison-Wesley/dp/0321601912" rel="noopener ugc nofollow" target="_blank">持续交付</a>的书</p></blockquote><h1 id="eb3d" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">背景故事</h1><p id="b6d5" class="pw-post-body-paragraph jj jk hu jm b jn lh jp jq jr li jt ju lj lk jx jy ll lm kb kc ln lo kf kg kh hn dt translated">在我目前的公司，我负责后端工程以及DevOps方面。您可能知道，建立自动化CI/CD管道是DevOps工程师的主要职责。我没什么不同。</p><p id="f0d9" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">从历史上看，我们主要是一家Jenkins CI驱动的公司，就像大多数其他创业公司一样。但是，我们是高度的云爱好者和考虑到可扩展性的分布式开发公司。你知道，使用jenkins的分布式CI/CD管道不是不可能的，但是当你达到某个级别时就很难了，因为Jenkins几乎是一个古老的(和先驱的)CI/CD工具。遗憾的是，我们已经提前达到了这个水平。所以我们决定尝试其他方法。符合我们的范式并坚持我们的工程哲学的东西。</p><p id="0937" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">在开发方面，我们主要是一家基于Golang的公司，这证明了我们非常热爱Go。我们尽可能多地使用基于Go的开源工具来满足我们的大部分开发需求(它们工作得很好)。所以我们尝试了几个用Go构建的CI/CD工具。我们尝试了<a class="ae ki" href="https://concourse-ci.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="jm hv">汇合</strong> </a>，但似乎太陡了，无法乘坐。经过一番含糊不清的混乱之后，我们终于找到了用Go编写的开源CI/CD工具Drone's footprint。在撰写本文时，无人机相当流行。</p><h1 id="663a" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">为什么是无人机？</h1><p id="caf4" class="pw-post-body-paragraph jj jk hu jm b jn lh jp jq jr li jt ju lj lk jx jy ll lm kb kc ln lo kf kg kh hn dt translated">或者我可以问，为什么不是无人机？这是一款纯分布式、云原生、DevOps友好、面向团队且高度可扩展的开源CI/CD工具。Phewww，满嘴描述吧？如果你想了解更多关于无人机的知识，不要害羞，直接去<a class="ae ki" href="https://drone.io" rel="noopener ugc nofollow" target="_blank">官方网站</a>吧。</p><p id="284c" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">我相当兴奋，所以让我们深入兔子洞。</p><h1 id="20b9" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">设置无人机服务器</h1><p id="aa94" class="pw-post-body-paragraph jj jk hu jm b jn lh jp jq jr li jt ju lj lk jx jy ll lm kb kc ln lo kf kg kh hn dt translated">无人机多为量产级CI/CD服务器。不像Jenkins，如果你没有一个公共的IP，它不会在你的本地机器上工作。无人机在云虚拟机中工作得最好，如AWS、DigitalOcean、GCP等提供商的虚拟机实例。</p><p id="f061" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">另一个选择是使用Drone的免费云SaaS，这是一个非常棒的免费工具(我们将在本文中使用)。这样，当您急于测试服务器时，就不必浪费时间来设置它。一切都在那里等着你。</p><p id="93b6" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">在我未来的文章中，我将向您展示如何在您自己的私有(但面向公众)云机器中为您的项目设置无人机服务器，而不是依赖无人机云。</p><p id="9c7e" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">印象深刻？说够了。</p><p id="0523" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">现在进入<a class="ae ki" href="https://cloud.drone.io" rel="noopener ugc nofollow" target="_blank"> https://cloud.drone.io </a>，用你的github账号登录。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lp"><img src="../Images/5087ce000c0865f5f348b8a7e42ced7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dk2osqaoS55DdQXgX9AJ8Q.png"/></div></div></figure><p id="f4fc" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">它将要求Github访问，因为Drone使用Github的webhook功能。登录后，它将同步您的存储库。</p><p id="c860" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">现在是开发设置的时候了。对于这个项目，我准备了一个例子<a class="ae ki" href="https://github.com/cyantarek/drone-go-git-test" rel="noopener ugc nofollow" target="_blank"> <strong class="jm hv"> git回购</strong> </a>。将其分支并克隆到您的本地机器中。应该没问题。这是一个基于Go的项目，但是你不需要安装Go，因为我们不会在我们的机器上运行这个项目。</p><p id="0e5f" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">在我们完成开发之后，是时候将无人机集成到我们的开发工作流程中了。</p><h1 id="2225" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">无人机集成</h1><p id="e3f9" class="pw-post-body-paragraph jj jk hu jm b jn lh jp jq jr li jt ju lj lk jx jy ll lm kb kc ln lo kf kg kh hn dt translated">Drone使用YML描述文件来定义它的整个管道。基本上，您编写要在您的管道中执行的步骤(比如从git获取、构建、测试、部署、运行等)。Drone会读取这个文件，了解你希望它执行什么。</p><p id="ea58" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">这是我们的<strong class="jm hv"> .drone.yml </strong>文件</p><pre class="lq lr ls lt fq lu lv lw lx aw ly dt"><span id="2c3c" class="lz kk hu lv b fv ma mb l mc md"><strong class="lv hv">kind</strong>: pipeline<br/><strong class="lv hv">name</strong>: default</span><span id="dd52" class="lz kk hu lv b fv me mb l mc md"><strong class="lv hv">workspace</strong>:<br/>  <strong class="lv hv">base</strong>: /go<br/>  <strong class="lv hv">path</strong>: src/github.com/yourname/go-drone-hello-world</span><span id="7b24" class="lz kk hu lv b fv me mb l mc md"><strong class="lv hv">steps</strong>:<br/>  - <strong class="lv hv">name</strong>: test<br/>    <strong class="lv hv">image</strong>: golang<br/>    <strong class="lv hv">commands</strong>:<br/>      - go get<br/>      - go test</span><span id="d2fe" class="lz kk hu lv b fv me mb l mc md">  - <strong class="lv hv">name</strong>: build<br/>    <strong class="lv hv">image</strong>: golang<br/>    <strong class="lv hv">commands</strong>:<br/>      - go get<br/>      - go build -o output<br/>      - chmod +x output</span><span id="7757" class="lz kk hu lv b fv me mb l mc md">  - <strong class="lv hv">name</strong>: run<br/>    <strong class="lv hv">image</strong>: golang<br/>    <strong class="lv hv">commands</strong>:<br/>      - go get<br/>      - go build -o output<br/>      - chmod +x output<br/>      - ./output</span></pre><p id="f142" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">很简单，对吧？让我描述一下其中的一些片段</p><p id="6926" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">我们用几个步骤定义了一个管道。为了本教程，我将测试、构建、运行分成了不同的步骤。如果你读了YML文件，你可以很容易地理解它所说的。它将在Docker容器中获取、构建和测试我们的Github repo(无人机完全基于容器，这太棒了)。在这种情况下，我们使用“golang”官方docker图像来建造集装箱。您可能会猜测，您可以为不同的语言项目使用您想要的语言运行时映像。</p><p id="4684" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">这是整合部分。因为我们将Guithub与Drone一起使用，所以在您提交对源代码(当然在git repo中)的任何更改并将其推送到远程后，它将自动开始执行它的工作(如YML文件中所述)。Github将发射webhook信号，然后无人机将捕捉它并完成它的工作。</p><p id="009f" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">说够了，让我们试试。哦，顺便说一下，你应该在无人机云UI中为你想要的git repo点击“激活”按钮。这将激活无人机的回购工作。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mf"><img src="../Images/efc7b8f826037b98451ed8badb65b862.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VBtS_6Zz0YslNHPLZ6iwBw.png"/></div></div></figure><p id="14da" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">选择“激活”后，它会给你一大堆定制选项，如YML文件名，公共/私人项目，crone作业，CI/CD构建标记README.md文件等。酷！</p><p id="f082" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">激活repo后，提交代码并将其推送到远程源。留意<a class="ae ki" href="https://cloud.drone.io" rel="noopener ugc nofollow" target="_blank"> https://cloud.drone.io </a>主界面/仪表盘。你会看到无人机在你按下后的几分之一秒内捡起你的回购，然后它开始工作。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mg"><img src="../Images/f398ea06933ec70b4f58f16fe9a81a0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zOJQOWgdUYiD97ksrNt0XQ.png"/></div></div></figure><p id="071a" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">你会看到一个黄色时钟动画徽章，显示无人机正在做它的工作。点击回购看看里面发生了什么。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mg"><img src="../Images/737c06caf5e5ccb2ed39d3d10cd94329.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xzUluoVfxrxineGnrUsgmA.png"/></div></div></figure><p id="23fc" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">正如你所看到的，这里列出了一堆我之前试验过的版本。您将看到您的提交消息作为每个构建阶段的标题，所以明智地选择您的提交消息。</p><p id="d2d7" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">单击最新版本。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mg"><img src="../Images/0936fa8df4f90ca6c22b1a06c512abba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kHJtNrmJs-ELi1SmIRKcmA.png"/></div></div></figure><p id="9f53" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">它显示了您在YAML文件中定义的所有步骤。它还会显示成功或失败步骤的彩色徽章。我们所有的步骤都已经通过了。厉害！</p><p id="c7ba" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">如果你点击每个任务，你会看到无人机当时做了什么。很酷的UI，不是吗？</p><p id="e76b" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">本文到此为止。你刚刚触及了无人机和整个CI/CD概念的表面。从这里可以学到很多东西。请随意探索Drone的文档、CI/CD书籍，并设置您自己的复杂项目管道，并感到高兴。</p><p id="8ca0" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju lj jw jx jy ll ka kb kc ln ke kf kg kh hn dt translated">谢了。</p></div></div>    
</body>
</html>