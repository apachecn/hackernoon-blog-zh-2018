<html>
<head>
<title>Selenium and Headless Chrome on AWS Lambda Layers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Lambda层上的硒和无头铬</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/running-selenium-and-headless-chrome-on-aws-lambda-layers-python-3-6-bd810503c6c3?source=collection_archive---------0-----------------------#2018-12-15">https://medium.com/hackernoon/running-selenium-and-headless-chrome-on-aws-lambda-layers-python-3-6-bd810503c6c3?source=collection_archive---------0-----------------------#2018-12-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/f3d08675a15740c616ae3dbd3c9285fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l0FnCCMp2w-RmMeJUzL2cA.png"/></div></div></figure><p id="3f5d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">AWS已经将Lambda函数的超时限制从5分钟延长到15分钟，并且AWS在re:Invent 2018上发布了新的Lambda layers功能，有了这些新功能，我们现在可以将Selenium测试迁移到无服务器框架，而不会出现任何性能问题！</p><p id="64bc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在多次尝试使用不同版本的chrome驱动程序和二进制文件后——我最终找到了让它工作的方法——Chrome driver能够在Lambda层内运行无头Chrome并与之交互。</p><p id="c1c4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我创建了<a class="ae ka" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv">无服务器框架</strong> </a> (≥1.34.0)项目来发布和使用带有Selenium和Headless Chrome的Lambda层，因此团队能够使用Python进行UI测试，而无需在服务器或本地机器上运行Selenium。</p><h2 id="dcf7" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">硒和无头铬</h2><p id="1daf" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">不兼容版本的无服务器chrome、chromedriver和Selenium会导致<strong class="je hv"> Chrome不可达</strong>错误。通过我的测试，这些版本最终可以很好地配合使用:</p><ul class=""><li id="85fb" class="lb lc hu je b jf jg jj jk jn ld jr le jv lf jz lg lh li lj dt translated">Python3.6</li><li id="e1e7" class="lb lc hu je b jf lk jj ll jn lm jr ln jv lo jz lg lh li lj dt translated">硒2.37</li><li id="ab9b" class="lb lc hu je b jf lk jj ll jn lm jr ln jv lo jz lg lh li lj dt translated"><a class="ae ka" href="https://sites.google.com/a/chromium.org/chromedriver/downloads" rel="noopener ugc nofollow" target="_blank"> ChromeDriver2.37 </a></li><li id="ea3b" class="lb lc hu je b jf lk jj ll jn lm jr ln jv lo jz lg lh li lj dt translated"><a class="ae ka" href="https://github.com/adieuadieu/serverless-chrome/releases?after=v1.0.0-46" rel="noopener ugc nofollow" target="_blank">无服务器Chrome v1.0.0.41 </a></li></ul><h2 id="a0e1" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">文件结构</h2><p id="c2b4" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">根目录下有2个子sls项目，<strong class="je hv"> seleniumLayer </strong>是Selenium Lambda层，存储Selenium库、无头Chromium驱动和二进制。<strong class="je hv"> lambda </strong>是正常的lambda函数，用于进行UI测试</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="4c92" class="kb kc hu lu b fv ly lz l ma mb">root<br/>── /<strong class="lu hv">seleniumLayer</strong>/  # lambda layers<br/>  ├── /<strong class="lu hv">selenium  </strong>lambda layer of selenium lib<br/>  │  └──/python/      # python libs<br/>  │   └── /lib/    <br/>  │     └── /python3.6/*    <br/>  ├── /<strong class="lu hv">chromedriver</strong>/    # lambda layer of headless Chrome <br/>  │ ├── /chromedriver   # chrome driver<br/>  │ └── /headless-chromium # headless chrome binary<br/>  └── /serverless.yaml     <br/>── /<strong class="lu hv">lambda</strong>/            # lambda function<br/>  ├── /handler.py      # source code of lambda function <br/>  └── /serverless.yaml # serverless config</span></pre><h2 id="ea34" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">安装Selenium库</h2><p id="0cf2" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">Lambda运行时在<code class="eh mc md me lu b">/opt</code>目录中包含路径，以确保您的函数代码可以访问包含在层中的库。</p><p id="d7ce" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要在层中包含库，请将它们放在python/lib/python 3.6/site-packages/中</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="6e81" class="kb kc hu lu b fv ly lz l ma mb"># download Selenium 2.37 to layer directory<br/>$ pip3.6 install -t seleniumLayer/<em class="mf">selenium/</em>python/lib/python3.6/site-packages selenium==2.37</span></pre><h2 id="82ad" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">安装无头Chrome驱动和二进制</h2><p id="084f" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">转到<strong class="je hv">根目录</strong>下，安装chrome二进制文件和驱动程序</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="06d6" class="kb kc hu lu b fv ly lz l ma mb"># download chrome driver<br/>$ <!-- -->mkdir -p seleniumLayer/chromedriver<br/>$ cd seleniumLayer/<!-- -->chromedriver<br/>$ curl -SL https://chromedriver.storage.googleapis.com/2.37/chromedriver_linux64.zip &gt; chromedriver.zip<br/>$ unzip chromedriver.zip<br/>$ rm chromedriver.zip</span><span id="7c51" class="kb kc hu lu b fv mg lz l ma mb"># download chrome binary<br/>$ curl -SL https://github.com/adieuadieu/serverless-chrome/releases/download/v1.0.0-41/stable-headless-chromium-amazonlinux-2017-03.zip &gt; headless-chromium.zip<br/>$ unzip headless-chromium.zip<br/>$ rm headless-chromium.zip</span></pre><p id="98ce" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">将以下代码复制到<strong class="je hv">/selenium layer/server less . YAML</strong></p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="c4d1" class="kb kc hu lu b fv ly lz l ma mb"><strong class="lu hv">service</strong>: selenium-layer<br/><br/><strong class="lu hv">provider</strong>:<br/>  <strong class="lu hv">name</strong>: aws<br/>  <strong class="lu hv">runtime</strong>: python3.6<br/>  <strong class="lu hv">region</strong>: ap-southeast-2<br/>  <strong class="lu hv">timeout</strong>: 900<br/><br/><strong class="lu hv">layers</strong>:<br/>  <strong class="lu hv">selenium</strong>:<br/>    <strong class="lu hv">path</strong>: selenium<br/>    <strong class="lu hv">CompatibleRuntimes</strong>: [<br/>      <strong class="lu hv">"python3.6"<br/>    </strong>]<br/>  <strong class="lu hv">chromedriver</strong>:<br/>    <strong class="lu hv">path</strong>: chromedriver<br/>    <strong class="lu hv">description</strong>: chrome driver layer<br/>    <strong class="lu hv">CompatibleRuntimes</strong>: [<br/>      <strong class="lu hv">"python3.6"<br/>    </strong>]<br/><strong class="lu hv">resources</strong>:<br/>  <strong class="lu hv">Outputs</strong>:<br/>    <strong class="lu hv">SeleniumLayerExport</strong>:<br/>        <strong class="lu hv">Value</strong>:<br/>          <strong class="lu hv">Ref</strong>: SeleniumLambdaLayer<br/>        <strong class="lu hv">Export</strong>:<br/>          <strong class="lu hv">Name</strong>: SeleniumLambdaLayer<br/>    <strong class="lu hv">ChromedriverLayerExport</strong>:<br/>       <strong class="lu hv">Value</strong>:<br/>         <strong class="lu hv">Ref</strong>: ChromedriverLambdaLayer<br/>       <strong class="lu hv">Export</strong>:<br/>         <strong class="lu hv">Name</strong>: ChromedriverLambdaLayer</span></pre><h2 id="62a3" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">λ函数</h2><p id="f1ff" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">并将下面的代码复制到<strong class="je hv"> /lambda/handler.py </strong></p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="c292" class="kb kc hu lu b fv ly lz l ma mb"><strong class="lu hv">from </strong>selenium <strong class="lu hv">import </strong>webdriver<br/><strong class="lu hv">from </strong>selenium.webdriver.chrome.options <strong class="lu hv">import </strong>Options<br/><br/><strong class="lu hv">def </strong>hello(event, context):<br/>    options = Options()<br/>    options.binary_location = <strong class="lu hv">'/opt/headless-chromium'<br/>    </strong>options.add_argument(<strong class="lu hv">'--headless'</strong>)<br/>    options.add_argument(<strong class="lu hv">'--no-sandbox'</strong>)<br/>    options.add_argument(<strong class="lu hv">'--single-process'</strong>)<br/>    options.add_argument(<strong class="lu hv">'--disable-dev-shm-usage'</strong>)<br/><br/>    driver = webdriver.Chrome(<strong class="lu hv">'/opt/chromedriver'</strong>,chrome_options=options)<br/><br/>    driver.get(<strong class="lu hv">'https://www.neaminational.org.au/'</strong>)<br/>    body = <strong class="lu hv">f"Headless Chrome Initialized, Page title: {driver.title}"<br/><br/>    </strong>driver.close();<br/>    driver.quit();<br/><br/>    response = {<br/>        <strong class="lu hv">"statusCode"</strong>: 200,<br/>        <strong class="lu hv">"body"</strong>: body<br/>    }<br/><br/>    <strong class="lu hv">return </strong>response</span></pre><p id="89fc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">将以下代码复制到<strong class="je hv">/lambda/server less . YAML</strong></p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="28c5" class="kb kc hu lu b fv ly lz l ma mb"><strong class="lu hv">service</strong>: selenium-lambda<br/><br/><strong class="lu hv">provider</strong>:<br/>  <strong class="lu hv">name</strong>: aws<br/>  <strong class="lu hv">runtime</strong>: python3.6<br/>  <strong class="lu hv">region</strong>: ap-southeast-2<br/>  <strong class="lu hv">timeout</strong>: 900<br/><br/><br/><strong class="lu hv">functions</strong>:<br/>  <strong class="lu hv">hello</strong>:<br/>    <strong class="lu hv">handler</strong>: handler.hello<br/>    <strong class="lu hv">layers</strong>:<br/>      - ${cf:selenium-layer-dev.SeleniumLayerExport}<br/>      - ${cf:selenium-layer-dev.ChromedriverLayerExport}</span></pre><h2 id="901b" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">部署Lambda层</h2><p id="6f79" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">转到/ <strong class="je hv">硒化层</strong>目录</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="8653" class="kb kc hu lu b fv ly lz l ma mb"> $ sls deploy</span></pre><h2 id="d675" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">部署λ函数</h2><p id="a943" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">转到/ <strong class="je hv"> lambda </strong>目录</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="3f94" class="kb kc hu lu b fv ly lz l ma mb">$ sls deploy</span></pre><h2 id="fad1" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">开始测试</h2><p id="c5f3" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">转到/ <strong class="je hv"> lambda </strong>目录</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="75a0" class="kb kc hu lu b fv ly lz l ma mb"><br/>$ sls invoke --function hello</span></pre><p id="e1c0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您应该会得到如下响应</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="ed6e" class="kb kc hu lu b fv ly lz l ma mb">{<br/>"statusCode": 200,<br/>"body": "Headless Chrome Initialized, Page title Home | Neami    National"<br/>}</span></pre><p id="c183" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我希望这篇文章对你有用，你可以在我的<strong class="je hv"> GitHub repo </strong>中找到完整的项目:</p><div class="mh mi fm fo mj mk"><a href="https://github.com/yai333/Selenium-UI-testing-with-AWS-Lambda-Layers" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab ej"><div class="mm ab mn cl cj mo"><h2 class="bd hv fv z el mp eo ep mq er et ht dt translated">yai 333/Selenium-UI-使用AWS-Lambda-Layers进行测试</h2><div class="mr l"><h3 class="bd b fv z el mp eo ep mq er et ek translated">用AWS Lambda层进行Selenium UI测试。为yai 333/Selenium-UI-testing-with-AWS-Lambda-Layers开发做出贡献…</h3></div><div class="ms l"><p class="bd b gc z el mp eo ep mq er et ek translated">github.com</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my ja mk"/></div></div></a></div></div><div class="ab cl mz na hc nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="hn ho hp hq hr"><h2 id="2106" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">了解更多信息</h2><div class="mh mi fm fo mj mk"><a rel="noopener follow" target="_blank" href="/neami-apps/how-to-add-nodejs-library-dependencies-in-a-aws-lambda-layer-with-serverless-framework-d774cb867197"><div class="ml ab ej"><div class="mm ab mn cl cj mo"><h2 class="bd hv fv z el mp eo ep mq er et ht dt translated">如何使用无服务器框架在AWS Lambda层中添加NodeJs库依赖项</h2><div class="mr l"><h3 class="bd b fv z el mp eo ep mq er et ek translated">无服务器计算在re:Invent 2018上得到推动。AWS宣布了简洁的Lambda层，它给了开发者多达五个…</h3></div><div class="ms l"><p class="bd b gc z el mp eo ep mq er et ek translated">medium.com</p></div></div><div class="mt l"><div class="ng l mv mw mx mt my ja mk"/></div></div></a></div><figure class="lp lq lr ls fq iv"><div class="bz el l di"><div class="nh ni l"/></div></figure></div></div>    
</body>
</html>