<html>
<head>
<title>Malware Analysis using Osquery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Osquery的恶意软件分析</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/malware-analysis-using-osquery-part-3-9dc805b67d16?source=collection_archive---------25-----------------------#2018-12-17">https://medium.com/hackernoon/malware-analysis-using-osquery-part-3-9dc805b67d16?source=collection_archive---------25-----------------------#2018-12-17</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="8b8a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是第三部分。在这个博客系列的第1部分中，我们分析了恶意软件的行为，在第2部分的<a class="ae jp" href="https://www.alienvault.com/blogs/labs-research/malware-analysis-using-osquery-part-2" rel="noopener ugc nofollow" target="_blank">中，我们学习了如何检测恶意软件攻击中使用的持久性技巧。尽管如此，当恶意活动发生时，我们可以通过Osquery观察到更多类型的事件。因此，在本系列的最后一篇博客文章中，我们将讨论如何检测恶意软件攻击中使用的另一种技术示例，这种技术涉及在系统中安装根证书，该证书可用于拦截通过安全TLS/SSL通信传输的信息(中间人)。我们还将了解如何使用Alienvault代理和Alienvault USM Anywhere来创建自定义规则并检测您环境中的恶意活动。</a></p><h1 id="f738" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">检测新安装的根证书</h1><p id="b82b" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">根证书通常由制造商或软件供应链预先安装在系统中。它们在公钥加密中用于标识证书颁发机构，通常用于在web浏览器中建立TLS和SSL连接。安装在根目录中的系统和应用程序信任证书。</p><p id="2d9b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">攻击者可以利用这种信任，在系统中安装根证书来拦截通信或代码签名等。在本例中，我们将安装自己的证书，该证书可用于拦截与银行平台的连接，从而窃取用户的个人信息。安装后，我们可以使用MMC控制台查看系统受信任的根证书颁发机构，看看我们的证书是如何放置的。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff kt"><img src="../Images/7e75dcecc0747fcd96860ff55655cf9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dapD51r0lnRKDdvw"/></div></div></figure><p id="ada5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如我们之前讨论的，Osquery可以通过查询certificates表来检测这种活动。如果我们执行一个查询来检索安装在受信任的根证书颁发机构中的所有证书，我们将像以前一样发现我们的证书。</p><p id="5540" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此查询可用于列出系统中的新证书:</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff lf"><img src="../Images/7e524d68816d5fa87c5f64488568a6f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ubMNWY2HMLF5FKQr"/></div></div></figure><h1 id="a559" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">如何通过Alienvault代理和Alienvault USM Anywhere使用Osquery的强大功能</h1><p id="ff91" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">到目前为止，我们已经观察了Osquery如何帮助实现端点检测和响应(EDR)功能。现在我们来看看如何通过Alienvault USM Anywhere中的AlienVault代理使用Osquery。</p><p id="4f4d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">AlienVault代理是一个基于Osquery的轻量级端点代理，它被配置为按时间间隔调度查询，从而实现连续的端点检测。您可以在AlienVault USM的<strong class="it hv">数据源&gt;代理&gt;配置文件</strong>中看到查询集合。这些查询由Alienvault实验室团队维护和更新，该团队研究新的威胁和恶意活动，并基于该研究构建和更新查询。</p><p id="4681" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果我们选择Windows完整配置文件，我们可以看到代理在端点中执行了多少查询。在所有这些查询中，我们发现一些旨在寻找持久性技术、DLL注入、后门、密码挖掘器甚至系统错误配置的查询。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff lg"><img src="../Images/22299267f025c581b68db959cd8fe3c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sWcMZG59PgxWpE81"/></div></div></figure><p id="68f4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">用例1:检测系统后门持久性</strong></p><p id="9fef" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我们将了解如何创建一个自定义编排规则，以使用Alienvault代理生成的事件来检测恶意活动。我们要做的第一件事是搜索来自AlienVault代理数据源的有趣事件。在这种情况下，我将为“检测到通用Windows平台应用程序持久性”查询创建一个警报规则。创建这个查询是为了检测一个<a class="ae jp" href="https://oddvar.moe/2018/09/06/persistence-using-universal-windows-platform-apps-appx/" rel="noopener ugc nofollow" target="_blank">已知的持久性机制</a>，该机制用于隐藏一个<a class="ae jp" href="https://hackernoon.com/tagged/program" rel="noopener ugc nofollow" target="_blank">程序</a>，该程序将在自动运行工具启动时运行。</p><p id="392b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦我们有了想要的事件，就有必要对感兴趣的领域做笔记。有些可用于规则中的条件，有些可用作突出显示字段。例如，在下面的事件中，有一些有趣的字段，如:</p><ul class=""><li id="5ee9" class="lh li hu it b iu iv iy iz jc lj jg lk jk ll jo lm ln lo lp dt translated">数据来源:Alienvault代理</li><li id="b131" class="lh li hu it b iu lq iy lr jc ls jg lt jk lu jo lm ln lo lp dt translated">事件类型:检测_应用程序_持久性</li><li id="4671" class="lh li hu it b iu lq iy lr jc ls jg lt jk lu jo lm ln lo lp dt translated">注册表值:C:\Windows\system32\cmd.exe</li></ul><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff ca"><img src="../Images/a8d3ea1873958dc0ae06c9e5d8b96e0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xSMYVP26vhXU5-KI"/></div></div></figure><p id="a641" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在USM Anywhere的<strong class="it hv">设置&gt;规则</strong>部分，我们可以为警报类型创建一个编排规则。因为我们想要一个警报来触发“通用Windows平台应用程序持久性”事件，所以我们可以先开始添加琐碎的条件，比如<strong class="it hv">数据源== AlienVault代理</strong>和<strong class="it hv">事件类型= = detection _ appx _ persistence</strong>。然后，假设我们只想在注册表值中放置的进程是cmd.exe或powershell.exe时触发警报，这是后门系统通常使用的。我们可以添加一个带有OR运算符的组条件来匹配这种情况。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff lv"><img src="../Images/11e4fd58175f1e435c54b57a7c30ced5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jkC9nC61YjBA6aBo"/></div></div></figure><p id="1949" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦创建了编排规则，我们就可以通过运行恶意命令来测试它，使用我们试图检测的技术向系统添加后门。之后，如果我们查看警报部分，我们可以看到该活动是如何触发我们的新警报规则的。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff lw"><img src="../Images/cf3d6aa4c63196b2d529d08be1338ea9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rzmHhbptEIBa8Oa1"/></div></div></figure><p id="87dc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">用例2:检测监听连接的进程</strong></p><p id="7d35" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">假设您的公司正成为某个最新威胁的目标，您希望检测恶意软件正在执行的活动。在阅读了一篇关于这项研究的博客文章后，您发现一个恶意软件正在使用netcat的修改版本，以便在受感染的机器上获得远程外壳。</p><p id="5200" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果我们看一下代理提供的不同事件，我们可以看到当进程正在侦听传入连接时，侦听端口事件会进行报告。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff lg"><img src="../Images/7ca0804c0dd5baff855ffa8dc3d975cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Qa1O8nt0rMwXcIxt"/></div></div></figure><p id="df96" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，我们可以创建一个新的规则，以匹配位于/ <em class="lx"> tmp </em>(临时目录)文件夹(通常不需要管理权限来写文件)中的进程开始监听特定端口上的连接并一直等待与攻击者建立通信。此外，我们可以添加参数<em class="lx"> — allowfile /tmp/，</em>，这是我们从研究博客中了解到的一个常见的IOC发现。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff ly"><img src="../Images/90a30bf98b4b588d25ca43fca8f170aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OCvl0QajO4ZOSEre"/></div></div></figure><p id="04bb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如我们所看到的，已经触发了一个警报，表明我们的一个主机感染了我们想要检测的恶意软件。我们可以在突出显示的字段中查找该活动最重要的特征。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff lz"><img src="../Images/b37360b61d2c92ac94327aac70d48f0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QqbKmotVdlVfM9Yq"/></div></div></figure><p id="f893" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">结论</strong></p><p id="0eec" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这个博客系列中，我们讨论了如何使用Osquery来帮助您检测终端上的恶意软件和其他恶意活动。通过AlienVault代理(USM Anywhere的一部分)实现Osquery，您可以将恶意软件检测和分析提升到一个新的水平。USM Anywhere支持强大的端点检测和响应功能(EDR ),可持续自动监控您的端点是否存在威胁，将该数据与网络<a class="ae jp" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank">安全</a>数据相关联，并为您提供一个集中的控制台来查看所有安全警报，查询您的系统以获取取证信息，并创建定制的编排规则来自动执行这些查询和其他事件响应操作。</p><p id="a738" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">还有更多的东西有待发现。通过我们的在线互动演示或<a class="ae jp" href="https://www.alienvault.com/products/usm-anywhere/free-trial" rel="noopener ugc nofollow" target="_blank">开始为期14天的免费试用</a>，在任何地方参观USM。</p><figure class="ku kv kw kx fq ky"><div class="bz el l di"><div class="ma mb l"/></div></figure></div></div>    
</body>
</html>