<html>
<head>
<title>CI/CD with Angular 6 &amp; Firebase &amp; GitLab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带Angular 6和Firebase和GitLab的CI/CD</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/ci-cd-with-angular-6-firebase-gitlab-5118ad469e4d?source=collection_archive---------0-----------------------#2018-12-23">https://medium.com/hackernoon/ci-cd-with-angular-6-firebase-gitlab-5118ad469e4d?source=collection_archive---------0-----------------------#2018-12-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="6b44" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">使用GitLab CI/CD自动构建、测试和部署</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/f1f7aa6d44cd864599d9621361a5cff1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HdUuR2RzeqTy9MYMv6mBwQ.png"/></div></div></figure><p id="8636" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我最近写了一篇关于如何用Angular 6、Firebase和Bitbucket管道进行CI/CD的文章。我收到的反馈也是试用<a class="ae kr" href="https://gitlab.com/" rel="noopener ugc nofollow" target="_blank"> GitLab </a>。开始了。</p><h1 id="378a" class="ks kt hu bd ku kv kw kx ky kz la lb lc ja ld jb le jd lf je lg jg lh jh li lj dt translated">概述</h1><ol class=""><li id="9cb8" class="lk ll hu jx b jy lm kb ln ke lo ki lp km lq kq lr ls lt lu dt translated">创建GitLab存储库</li><li id="4530" class="lk ll hu jx b jy lv kb lw ke lx ki ly km lz kq lr ls lt lu dt translated">创建Angular 6演示应用程序</li><li id="8750" class="lk ll hu jx b jy lv kb lw ke lx ki ly km lz kq lr ls lt lu dt translated">CI/CD配置角度6(构建、测试、部署)</li><li id="1de6" class="lk ll hu jx b jy lv kb lw ke lx ki ly km lz kq lr ls lt lu dt translated">创建Firebase项目</li><li id="2c14" class="lk ll hu jx b jy lv kb lw ke lx ki ly km lz kq lr ls lt lu dt translated">在GitLab中配置CI/CD</li></ol><h1 id="ef17" class="ks kt hu bd ku kv kw kx ky kz la lb lc ja ld jb le jd lf je lg jg lh jh li lj dt translated">先决条件</h1><ul class=""><li id="a2db" class="lk ll hu jx b jy lm kb ln ke lo ki lp km lq kq ma ls lt lu dt translated"><a class="ae kr" href="https://gitlab.com" rel="noopener ugc nofollow" target="_blank"> GitLab </a>和<a class="ae kr" href="https://firebase.google.com/" rel="noopener ugc nofollow" target="_blank"> Firebase </a>账号</li><li id="64b3" class="lk ll hu jx b jy lv kb lw ke lx ki ly km lz kq ma ls lt lu dt translated">安装在本地开发机器上的<a class="ae kr" href="https://git-scm.com/" rel="noopener ugc nofollow" target="_blank"> Git </a>和<a class="ae kr" href="https://nodejs.org" rel="noopener ugc nofollow" target="_blank"> Node.js </a> 10.x</li></ul><h1 id="881f" class="ks kt hu bd ku kv kw kx ky kz la lb lc ja ld jb le jd lf je lg jg lh jh li lj dt translated">(1)创建GitLab资源库</h1><p id="3687" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">首先，我们创建一个新的GitLab存储库。你可以在这里找到我的演示库:<a class="ae kr" href="https://gitlab.com/kniklas/angular-firebase-ci-demo" rel="noopener ugc nofollow" target="_blank">https://gitlab.com/kniklas/angular-firebase-ci-demo</a></p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff me"><img src="../Images/f511dff2b33b293772385c5fb571aaf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y01dp-NmB7cKauTpdIutnw.png"/></div></div></figure><h1 id="678b" class="ks kt hu bd ku kv kw kx ky kz la lb lc ja ld jb le jd lf je lg jg lh jh li lj dt translated">(2)创建Angular 6演示应用程序</h1><p id="c9a6" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">在这个演示中，我们用<a class="ae kr" href="https://angular.io/guide/quickstart" rel="noopener ugc nofollow" target="_blank"> Angular CLI </a>创建我们的Angular应用程序。如果您尚未安装CLI，请使用以下命令进行安装:</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="ee94" class="mk kt hu mg b fv ml mm l mn mo">npm install -g @angular/cli</span></pre><p id="f844" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果您已经安装了旧版本的angular CLI，请使用以下命令升级到最新版本，如这里的<a class="ae kr" href="https://www.npmjs.com/package/@angular/cli" rel="noopener ugc nofollow" target="_blank">所述</a>:</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="12a6" class="mk kt hu mg b fv ml mm l mn mo">npm uninstall -g @angular/cli<br/>npm cache verify<em class="mp"><br/></em>npm install -g @angular/cli@latest</span></pre><p id="e7f0" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然后，我们可以创建我们的角骨架应用程序:</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="6f21" class="mk kt hu mg b fv ml mm l mn mo">ng new angular-firebase-ci-demo</span></pre><p id="efa9" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果您对刚刚创建的内容感兴趣，请从内置服务器开始:</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="252b" class="mk kt hu mg b fv ml mm l mn mo">cd angular-firebase-ci-demo <br/>ng serve -o</span></pre><p id="60c7" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">该命令应该会自动启动您的浏览器并导航到<a class="ae kr" href="http://localhost:4200/" rel="noopener ugc nofollow" target="_blank"> http://localhost:4200/ </a>。</p><h1 id="40b0" class="ks kt hu bd ku kv kw kx ky kz la lb lc ja ld jb le jd lf je lg jg lh jh li lj dt translated">(3)用于构建、测试和部署的配置角度6</h1><p id="6f90" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">Angular 6附带2个测试工具:<a class="ae kr" href="https://karma-runner.github.io/" rel="noopener ugc nofollow" target="_blank"> Karma </a>用于单元测试，<a class="ae kr" href="https://www.protractortest.org/" rel="noopener ugc nofollow" target="_blank">量角器</a>用于end-2-end或集成测试。你可以在这里找到更多关于差异<a class="ae kr" href="https://www.protractortest.org/#/faq" rel="noopener ugc nofollow" target="_blank">的信息。这两种方法的共同点是，它们打开浏览器来执行测试(这听起来很合理，因为我们正在构建一个前端)。在开发过程中，我们可以使用命令<code class="eh mq mr ms mg b">ng test</code>运行基于Karma的测试，该命令打开浏览器(Chrome ),执行测试并在代码发生变化时重新运行所有测试。为了执行基于量角器的测试，我们使用命令<code class="eh mq mr ms mg b">ng e2e</code>，它也打开一个浏览器并运行测试。</a></p><p id="a03d" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在我们的CI环境中，我们只需要执行我们的测试用例，而不需要浏览器的GUI和内存开销。有了chrome 的<a class="ae kr" href="https://developers.google.com/web/updates/2017/04/headless-chrome" rel="noopener ugc nofollow" target="_blank">无头模式，这才有可能。</a></p><h2 id="5c6b" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">操纵木偶的人</h2><p id="f2d0" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">首先，我们需要在CI环境中包含一个浏览器。我们将使用捆绑了chrome的节点库<a class="ae kr" href="https://github.com/GoogleChrome/puppeteer" rel="noopener ugc nofollow" target="_blank">木偶师</a>。有了它，我们可以确保无论是在我们的开发环境中还是在我们的CI环境中，我们都有合适的浏览器。</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="9a4f" class="mk kt hu mg b fv ml mm l mn mo">npm install --save-dev puppeteer</span></pre><h2 id="f657" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">Karma构型</h2><p id="5150" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">我们在<code class="eh mq mr ms mg b">karma.conf.js</code>中添加了一个定制的启动器，在CI环境中以无头模式启动Chrome。此外，我们需要使用选项<code class="eh mq mr ms mg b">--no-sandbox</code>，使其工作，因为我们没有在docker映像上进行额外的用户配置。</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="46ba" class="mk kt hu mg b fv ml mm l mn mo"># ./angular-firebase-ci-demo/<strong class="mg hv">src/karma.conf.js</strong></span><span id="441a" class="mk kt hu mg b fv ng mm l mn mo"><strong class="mg hv">const puppeteer = require('puppeteer');<br/>process.env.CHROME_BIN = puppeteer.executablePath();</strong></span><span id="5985" class="mk kt hu mg b fv ng mm l mn mo">module.exports = function (config) {<br/>  config.set({<br/>    (...)<strong class="mg hv"><br/>    customLaunchers: {<br/>      ChromeHeadlessNoSandbox: {<br/>        base: 'ChromeHeadless',<br/>        flags: ['--no-sandbox']<br/>      }<br/>    },<br/>    </strong>(...)<strong class="mg hv"><br/>  </strong>});<br/>};</span></pre><h2 id="f2c1" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">量角器配置</h2><p id="94b1" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">对于e2e测试，我们添加了以下配置文件，以便能够在无头模式下使用选项<code class="eh mq mr ms mg b">--no-sandbox</code>调用chrome。</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="1d77" class="mk kt hu mg b fv ml mm l mn mo"># ./angular-firebase-ci-demo/<strong class="mg hv">e2e/protractor-ci.conf.js</strong></span><span id="ac73" class="mk kt hu mg b fv ng mm l mn mo">const config = require('./protractor.conf').config;<br/>const puppeteer = require('puppeteer');</span><span id="6338" class="mk kt hu mg b fv ng mm l mn mo">config.capabilities = {<br/>  browserName: 'chrome',<br/>  chromeOptions: {<br/>    args: ['--headless', '--no-sandbox'],<br/>    binary: puppeteer.executablePath()<br/>  }<br/>};</span><span id="367e" class="mk kt hu mg b fv ng mm l mn mo">exports.config = config;</span></pre><h2 id="d468" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">为CI/CD添加节点脚本</h2><p id="432f" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">为了在CI上正确地构建、测试和部署，我们将以下脚本添加到我们的<code class="eh mq mr ms mg b">package.json</code>配置文件中。</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="267b" class="mk kt hu mg b fv ml mm l mn mo">"scripts": {<br/>  "<strong class="mg hv">build-prod</strong>": "ng build --prod",<br/>  "<strong class="mg hv">test-ci</strong>": "ng test --no-watch --no-progress --browsers=ChromeHeadlessNoSandbox",<br/>  "<strong class="mg hv">e2e-ci</strong>": "ng e2e --protractor-config=e2e/protractor-ci.conf.js",<br/>  "<strong class="mg hv">deploy</strong>": "firebase deploy --token $FIREBASE_TOKEN --non-interactive"<br/>}</span></pre><h2 id="458d" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">提交到GitLab</h2><p id="acd7" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">现在我们可以与GitLab中的远程存储库共享我们的本地代码。您可以在GitLab资源库概述中找到git URL。对我来说，这些命令看起来像这样:</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="5558" class="mk kt hu mg b fv ml mm l mn mo"># switch to project folder in ./angular-firebase-ci-demo</span><span id="20a4" class="mk kt hu mg b fv ng mm l mn mo">git remote add origin <a class="ae kr" href="https://gitlab.com/kniklas/angular-firebase-ci-demo.git" rel="noopener ugc nofollow" target="_blank">https://gitlab.com/kniklas/angular-firebase-ci-demo.git</a> </span><span id="f7bb" class="mk kt hu mg b fv ng mm l mn mo">git push origin master</span></pre><p id="233f" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">代码现在应该在我们的GitLab库中可见。</p><h1 id="6a79" class="ks kt hu bd ku kv kw kx ky kz la lb lc ja ld jb le jd lf je lg jg lh jh li lj dt translated">(4)创建Firebase应用程序</h1><p id="f3a3" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">在<a class="ae kr" href="https://console.firebase.google.com/" rel="noopener ugc nofollow" target="_blank">https://console.firebase.google.com/</a>上创建新项目。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff nh"><img src="../Images/b9b55322bf150c870e570f2ebc2f3cee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*eXp6uegaaXkKZfDe9lM1hw.png"/></div><figcaption class="ni nj fg fe ff nk nl bd b be z ek">New Firebase Project</figcaption></figure><h2 id="f69f" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">安装Firebase工具</h2><p id="ee12" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">因为我们想要部署到firebase，所以我们需要<a class="ae kr" href="https://www.npmjs.com/package/firebase-tools" rel="noopener ugc nofollow" target="_blank"> firebase工具</a>。让我们将它们添加到我们的开发依赖项中，并在我们的机器上全局安装它们:</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="bd72" class="mk kt hu mg b fv ml mm l mn mo">npm install --save-dev firebase-tools<br/>npm install -g firebase-tools</span></pre><h2 id="c457" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">添加Firebase的配置</h2><p id="a7d8" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">常规Firebase项目配置。您需要使用项目id <strong class="jx hv">而不是</strong>项目名称:</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="c37e" class="mk kt hu mg b fv ml mm l mn mo"># ./angular-firebase-ci-demo/<strong class="mg hv">.firebaserc</strong></span><span id="720f" class="mk kt hu mg b fv ng mm l mn mo">{<br/>  "projects": {<br/>    "default": "angular-firebase-ci-demo"<br/>  }<br/>}</span></pre><p id="0b09" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">Firebase托管配置:让我们只部署dist文件夹中的内容，它是在产品构建期间创建的。</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="da1b" class="mk kt hu mg b fv ml mm l mn mo"># ./angular-firebase-ci-demo/<strong class="mg hv">firebase.json</strong></span><span id="faa1" class="mk kt hu mg b fv ng mm l mn mo">{<br/>  "hosting": {<br/>    "public": "dist/angular-firebase-ci-demo",<br/>    "rewrites": [<br/>      {<br/>        "source": "**",<br/>        "destination": "/index.html"<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><h2 id="08f2" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">提交Firebase配置</h2><p id="ce07" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">我们现在将所有更改推送到我们的主分支。</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="6ef5" class="mk kt hu mg b fv ml mm l mn mo">git add -A<br/>git commit -m "firebase config"<br/>git commit git push origin master</span></pre><h1 id="82aa" class="ks kt hu bd ku kv kw kx ky kz la lb lc ja ld jb le jd lf je lg jg lh jh li lj dt translated">(5)在GitLab中设置和配置CI/CD</h1><h2 id="e1d8" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">配置配置项/光盘</h2><p id="d5b7" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">GitLab CI/CD配置了一个名为<code class="eh mq mr ms mg b">.gitlab-ci.yml</code>的特殊文件，需要放在项目的根文件夹中。GitLab自动检测文件，并根据配置运行管道。让我们添加以下文件，从一个简单的3步管道开始，它包括构建、测试和部署到生产环境，并缓存和存储构建工件。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nm nn l"/></div></figure><h2 id="71c3" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">已配置管道的说明</h2><p id="5060" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">通过<code class="eh mq mr ms mg b">image: node:10</code>,我们告诉管道哪个docker容器应该用于构建。对于角度6，我们需要节点10.x。</p><p id="57a0" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我们把流水线分成三个工作:<code class="eh mq mr ms mg b">build</code>、<code class="eh mq mr ms mg b">test</code>和<code class="eh mq mr ms mg b">deploy_prod</code>。每一步都在我们定义的图像上一个接一个地独立执行。每当出现错误时，管道就会停止。<em class="mp">例</em>:如果<code class="eh mq mr ms mg b">build</code>失败，则<code class="eh mq mr ms mg b">test</code>和<code class="eh mq mr ms mg b">deploy_prod</code>不会被执行。</p><p id="a2d5" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">使用<code class="eh mq mr ms mg b">caches: path: node_modules/</code>,我们缓存在依赖项安装期间下载的所有node_modules。这将加速管道的后续作业，因为它们都是在空白映像上执行的。默认的缓存策略是<code class="eh mq mr ms mg b">pull-push</code>。这意味着，在作业中运行任何脚本之前，将从缓存存储库中提取定义为缓存的文件。所有脚本运行后，文件被推回到缓存存储库。</p><p id="756e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">对于<code class="eh mq mr ms mg b">test</code>和<code class="eh mq mr ms mg b">deploy_prod</code>作业，我们使用缓存策略<code class="eh mq mr ms mg b">pull</code>定义了要缓存的相同文件夹，因为我们不需要写回缓存。这加快了进程。</p><p id="5f1d" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">使用命令<code class="eh mq mr ms mg b">only: master</code>,我们告诉<code class="eh mq mr ms mg b">deploy_prod</code>作业只在主分支发生变化时运行。有了它，我们就可以确保，不是特性或其他分支上的每一个变化都会被部署到生产中。</p><p id="37c3" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">通过命令<code class="eh mq mr ms mg b">dependencies: build</code>我们告诉<code class="eh mq mr ms mg b">deploy_prod</code>作业获取我们在构建作业中定义的工件。这样，我们就不需要再次构建它，并确保不部署其他东西。</p><p id="d8d2" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为了跟踪生产环境的部署，我们使用命令<code class="eh mq mr ms mg b">environment</code>告诉GitLab将该作业视为生产部署。在这里找到更多关于<a class="ae kr" href="https://docs.gitlab.com/ee/ci/environments.html" rel="noopener ugc nofollow" target="_blank"> GitLab环境</a>的信息。</p><p id="fb1d" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">每项工作的主要部分是<code class="eh mq mr ms mg b">script:</code>部分，其任务如下:</p><ol class=""><li id="d153" class="lk ll hu jx b jy jz kb kc ke no ki np km nq kq lr ls lt lu dt translated"><strong class="jx hv">构建</strong>:安装所有在<code class="eh mq mr ms mg b">package.json</code>中描述的所需模块，并构建我们想要部署的工件。</li><li id="8283" class="lk ll hu jx b jy lv kb lw ke lx ki ly km lz kq lr ls lt lu dt translated"><strong class="jx hv">测试</strong>:按照<a class="ae kr" href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/troubleshooting.md" rel="noopener ugc nofollow" target="_blank">木偶师故障诊断文档</a>中的讨论，安装所需的库来运行docker映像上的chrome。然后执行因果报应和量角器测试。</li><li id="ba29" class="lk ll hu jx b jy lv kb lw ke lx ki ly km lz kq lr ls lt lu dt translated"><strong class="jx hv">部署</strong>:将工件部署到火焰基地。</li></ol><p id="07da" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果任何命令失败，整个管道都会失败。这意味着，失败的测试将阻止部署到服务器上(这很好，因为我们不想破坏生产)。</p><h2 id="75bf" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">在GitLab中设置环境变量</h2><p id="0453" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">在我们的管道脚本中，我们定义了两个环境变量。</p><ol class=""><li id="b501" class="lk ll hu jx b jy jz kb kc ke no ki np km nq kq lr ls lt lu dt translated"><code class="eh mq mr ms mg b">FIREBASE_TOKEN</code>，用于验证GitLab对Firebase和</li><li id="d5e8" class="lk ll hu jx b jy lv kb lw ke lx ki ly km lz kq lr ls lt lu dt translated"><code class="eh mq mr ms mg b">FIREBASE_URL</code>，这是我们项目的URL，仅用作我们在GitLab中的环境配置的元信息。</li></ol><p id="d54b" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我们通过在命令行上键入以下内容来获得令牌:</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="3225" class="mk kt hu mg b fv ml mm l mn mo">firebase login:ci</span></pre><p id="4f6a" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我们在<strong class="jx hv">设置&gt; CI/CD &gt;变量</strong>中配置的令牌。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff nr"><img src="../Images/15b0060f5abe63dfda704e831bf8cd46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P1lV5zL0lOJiSG1DdUg6rg.png"/></div></div><figcaption class="ni nj fg fe ff nk nl bd b be z ek">CI/CD variables in GitLab</figcaption></figure><p id="4ec0" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><strong class="jx hv">重要提示:</strong>请勿将密码或其他机密信息存储在git中。而是利用环境变量。</p><h2 id="65a2" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">测试管道</h2><p id="b511" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">现在提交任何对master的更改或合并到master，您将看到Firebase的部署。如果您提交到任何其他分支，将只运行构建和测试作业。</p><h2 id="05c9" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">替代码头工人图像</h2><p id="a86b" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">管道目前“中毒”了，声明安装chrome所需的库。如果没有这些库，chrome就不能工作，并且会出错。一种更干净的方法是使用包含这些库的自定义docker容器。这对于维护和加速管道来说更为友好。<a class="ae kr" href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/troubleshooting.md" rel="noopener ugc nofollow" target="_blank">木偶师的故障诊断文档</a>中描述了这种情况。</p></div><div class="ab cl ns nt hc nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="hn ho hp hq hr"><h1 id="bb99" class="ks kt hu bd ku kv nz kx ky kz oa lb lc ja ob jb le jd oc je lg jg od jh li lj dt translated">想多读点吗？</h1><p id="a798" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">订阅我的<a class="ae kr" href="https://mailchi.mp/7f46c21dfc63/better-software-architect" rel="noopener ugc nofollow" target="_blank"> <strong class="jx hv">关于现代软件架构的时事通讯</strong> </a>。增长您的技能，成为更好的软件架构师。</p><p id="dbfa" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">支持我的工作，并查看我的书“<a class="ae kr" href="http://bettersoftwarearchitect.com" rel="noopener ugc nofollow" target="_blank">成为一名更好的软件架构师——来自实践经验的行动和见解</a>”。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff oe"><img src="../Images/7e76c94cfed58c19d8ba1ac7cf2ced66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A5DjoyQ07_MNk6W1FUrZNw.png"/></div></div><figcaption class="ni nj fg fe ff nk nl bd b be z ek"><a class="ae kr" href="http://bettersoftwarearchitect.com" rel="noopener ugc nofollow" target="_blank">Become a Better Software Architect — Actions and insights from practical experience</a></figcaption></figure></div><div class="ab cl ns nt hc nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="hn ho hp hq hr"><h1 id="f07e" class="ks kt hu bd ku kv nz kx ky kz oa lb lc ja ob jb le jd oc je lg jg od jh li lj dt translated">奖金</h1><h2 id="4b79" class="mk kt hu bd ku mt mu mv ky mw mx my lc ke mz na le ki nb nc lg km nd ne li nf dt translated">跳过管道中的作业</h2><p id="c2c3" class="pw-post-body-paragraph jv jw hu jx b jy lm iv ka kb ln iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">有时候，我们只是想更新一个不重要的文件，比如readme，而不想运行管道或者只是其中的一部分。这可以通过向作业添加例外来实现。在这个场景中，我向所有三个已定义的作业添加了以下配置:</p><pre class="jk jl jm jn fq mf mg mh mi aw mj dt"><span id="8410" class="mk kt hu mg b fv ml mm l mn mo">except:<br/>    variables:<br/>      - $CI_COMMIT_MESSAGE =~ /skip-ci/</span></pre><p id="e457" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果我们现在在提交消息中包含关键字<code class="eh mq mr ms mg b">skip-ci</code>，那么除了配置之外的作业将不会被执行。</p></div><div class="ab cl ns nt hc nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="hn ho hp hq hr"><p id="0167" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><em class="mp">原载于2018年12月23日</em><a class="ae kr" href="https://kai-niklas.de/163/ci-cd-with-angular-6-firebase-gitlab/" rel="noopener ugc nofollow" target="_blank"><em class="mp">kai-niklas . de</em></a><em class="mp">。</em></p></div></div>    
</body>
</html>