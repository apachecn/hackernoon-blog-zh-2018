<html>
<head>
<title>Traffic Mirroring with Istio Service Mesh</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio服务网格的流量镜像</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/traffic-mirroring-with-istio-service-mesh-8731655faf16?source=collection_archive---------11-----------------------#2018-12-24">https://medium.com/hackernoon/traffic-mirroring-with-istio-service-mesh-8731655faf16?source=collection_archive---------11-----------------------#2018-12-24</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/7fee0b33969d1ff61b4fb49490c061b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UzZHtw_FAbVM2Z8V"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Photo by <a class="ae jg" href="https://unsplash.com/@sararp?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Sara Riaño</a> on <a class="ae jg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><figure class="ji jj jk jl fq iv fe ff paragraph-image"><a href="https://gum.co/learnistio"><div class="fe ff jh"><img src="../Images/1b70d2208055f8627d86d6e96c0e5290.png" data-original-src="https://miro.medium.com/v2/resize:fit:560/format:webp/1*GK0PpxzY92AsCw9o2uW76A.png"/></div></a></figure><blockquote class="jm jn jo"><p id="6767" class="jp jq jr js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn hn dt translated"><em class="hu">这是节选自使用Istio </em>  <em class="hu">模块的</em> <strong class="js hv"> <em class="hu">交通管理—您可以通过注册下载</em> <strong class="js hv"> <em class="hu"> 20+页PDF </em> </strong> <em class="hu">和支持的YAML文件👉</em><a class="ae jg" href="http://www.LearnIstio.com" rel="noopener ugc nofollow" target="_blank"><em class="hu">www.LearnIstio.com</em></a><em class="hu">👈</em></strong></p></blockquote></div><div class="ab cl ko kp hc kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="hn ho hp hq hr"><p id="8e62" class="pw-post-body-paragraph jp jq hu js b jt ju jv jw jx jy jz ka kv kc kd ke kw kg kh ki kx kk kl km kn hn dt translated">除了不同服务版本之间更“传统”的流量路由之外，这可以基于各种传入请求属性，例如URL的部分、报头值、请求方法等。，Istio还支持<strong class="js hv">流量镜像</strong>。</p><p id="7ab6" class="pw-post-body-paragraph jp jq hu js b jt ju jv jw jx jy jz ka kv kc kd ke kw kg kh ki kx kk kl km kn hn dt translated">当您不想<strong class="js hv">发布</strong>新版本并向用户公开时，可以使用流量镜像，但您仍然希望<strong class="js hv">部署</strong>新版本并观察其工作原理，收集遥测数据，并将现有服务的性能和功能与新服务进行比较。</p><p id="8fe9" class="pw-post-body-paragraph jp jq hu js b jt ju jv jw jx jy jz ka kv kc kd ke kw kg kh ki kx kk kl km kn hn dt translated">你可能会问——部署和发布之间有什么区别？当我们谈论<strong class="js hv">将</strong>服务部署到生产环境中时，我们只是将可执行代码(二进制代码、容器、代码能够执行所需的任何形式)转移到生产环境中，但是<strong class="js hv">没有</strong>向它发送任何生产流量。服务是有的，但不是(希望如此！)影响任何在它旁边运行的现有服务。</p><p id="7fe9" class="pw-post-body-paragraph jp jq hu js b jt ju jv jw jx jy jz ka kv kc kd ke kw kg kh ki kx kk kl km kn hn dt translated"><strong class="js hv">发布</strong>一项服务包括获取该已部署的服务，并开始将生产流量路由到该服务。此时，我们转移到生产环境中的代码正在执行，它可能会影响其他服务和最终用户。</p><p id="ffe5" class="pw-post-body-paragraph jp jq hu js b jt ju jv jw jx jy jz ka kv kc kd ke kw kg kh ki kx kk kl km kn hn dt translated">在两个版本之间路由流量，进行蓝绿色发布是有帮助的，也是有用的，但是也有风险——如果服务中断或出现故障怎么办？即使服务只接收到1%的生产流量，它仍然会对大量用户产生负面影响。</p><p id="e16d" class="pw-post-body-paragraph jp jq hu js b jt ju jv jw jx jy jz ka kv kc kd ke kw kg kh ki kx kk kl km kn hn dt translated">流量镜像背后的想法是将用户暴露于潜在错误服务的风险降至最低。我们不是部署、释放流量并将其路由到新服务，而是部署新服务，然后<strong class="js hv">镜像</strong>发送到服务发布版本的生产流量。</p><p id="cb5a" class="pw-post-body-paragraph jp jq hu js b jt ju jv jw jx jy jz ka kv kc kd ke kw kg kh ki kx kk kl km kn hn dt translated">然后，可以<strong class="js hv">观察接收镜像流量的服务</strong>是否有错误，而不会影响任何生产流量。除了在服务的已部署版本上运行各种测试之外，您现在还可以使用实际的生产流量并增加测试覆盖率，这可以让您更有信心并最大限度地降低发布有问题的服务的风险。</p><p id="d295" class="pw-post-body-paragraph jp jq hu js b jt ju jv jw jx jy jz ka kv kc kd ke kw kg kh ki kx kk kl km kn hn dt translated">以下是如何使用Istio打开流量镜像的一个快速片段:</p><figure class="ji jj jk jl fq iv"><div class="bz el l di"><div class="ky kz l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Mirror traffic to the v1 subset of greeter-service to the v2 subset as well</figcaption></figure><p id="536b" class="pw-post-body-paragraph jp jq hu js b jt ju jv jw jx jy jz ka kv kc kd ke kw kg kh ki kx kk kl km kn hn dt translated">上面的虚拟服务将100%的流量路由到v1版本，同时也将相同的流量镜像到v2版本。要了解这一点，最快的方法是观察v2服务的日志，同时向v1版本的服务发送一些请求。</p><p id="d7f7" class="pw-post-body-paragraph jp jq hu js b jt ju jv jw jx jy jz ka kv kc kd ke kw kg kh ki kx kk kl km kn hn dt translated">您将在网页上看到的响应将来自服务的v1版本，但是，您也将看到请求被发送到v2版本:</p><pre class="ji jj jk jl fq la lb lc ld aw le dt"><span id="364d" class="lf lg hu lb b fv lh li l lj lk">$ kubectl logs greeter-service-v2–78fc64b995-krzf7 -c svc -f<br/>&gt; greeter-service@2.0.0 start /app<br/>&gt; node server.js</span><span id="a516" class="lf lg hu lb b fv ll li l lj lk">Listening on port 3000<br/>GET /hello 200 9.303 ms — 59<br/>GET /hello 200 0.811 ms — 59<br/>GET /hello 200 0.254 ms — 59<br/>GET /hello 200 3.563 ms — 59</span></pre></div><div class="ab cl ko kp hc kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="hn ho hp hq hr"><figure class="ji jj jk jl fq iv fe ff paragraph-image"><a href="https://gum.co/learnistio"><div class="fe ff jh"><img src="../Images/1b70d2208055f8627d86d6e96c0e5290.png" data-original-src="https://miro.medium.com/v2/resize:fit:560/format:webp/1*GK0PpxzY92AsCw9o2uW76A.png"/></div></a></figure><blockquote class="jm jn jo"><p id="e14e" class="jp jq jr js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn hn dt translated"><em class="hu">这是节选自</em> <a class="ae jg" href="https://learnistio.com" rel="noopener ugc nofollow" target="_blank"> <strong class="js hv"> <em class="hu">交通管理与Istio </em> </strong> </a> <em class="hu">模块—您可以在以下网站注册下载</em> <strong class="js hv"> <em class="hu"> 20+页PDF </em> </strong> <em class="hu">和支持的YAML文件👉</em><a class="ae jg" href="http://www.LearnIstio.com" rel="noopener ugc nofollow" target="_blank"><em class="hu">www.LearnIstio.com</em></a><em class="hu">👈</em></p></blockquote></div></div>    
</body>
</html>