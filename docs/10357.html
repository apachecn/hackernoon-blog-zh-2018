<html>
<head>
<title>How to add In-Skill Products to your Alexa Skill</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将技能产品添加到你的Alexa技能中</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-add-in-skill-products-to-your-alexa-skill-fa57adbcd55e?source=collection_archive---------13-----------------------#2018-12-26">https://medium.com/hackernoon/how-to-add-in-skill-products-to-your-alexa-skill-fa57adbcd55e?source=collection_archive---------13-----------------------#2018-12-26</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/7ab1b33cde471628857f151c52323946.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*w3NFfNnDNubd5Y1-"/></div></div></figure><p id="bd2e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">自从亚马逊宣布能够为开发Alexa技能的开发者提供技能内购买，我已经为两种不同的技能添加了四项优质内容。我最近发表了一篇关于<a class="ae ka" rel="noopener" href="/@garrettvargas/why-you-should-add-premium-content-to-your-alexa-skill-spoiler-its-not-for-the-money-17118879096f">为什么您应该考虑添加优质内容</a>的文章，在这篇文章中，我将通过一步一步的代码示例向您展示如何通过ASK SDK实现这一点。</p><h2 id="53a3" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">技能产品的类型</h2><p id="c72b" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">在进入代码之前，我想回顾一下亚马逊为Alexa提供的技能产品(或ISP)的类型，你可以使用它们的不同方式，以及关于你何时以及多久提醒你的客户关于你的内容的一些注意事项。</p><p id="75a8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您的技能可以提供三种类型的ISP:</p><ul class=""><li id="cbaf" class="lb lc hu je b jf jg jj jk jn ld jr le jv lf jz lg lh li lj dt translated"><strong class="je hv">权利</strong>:这些产品基本上是一个开关。他们通常会在您的技能范围内选择一项功能，一旦客户购买了该产品，他们就可以持续使用该功能。这些都是典型的功能，如扩展包，额外的水平，或高级音效。</li><li id="54ab" class="lb lc hu je b jf lk jj ll jn lm jr ln jv lo jz lg lh li lj dt translated"><strong class="je hv">订阅</strong>:订阅提供对某个功能或内容的访问，但与授权不同，客户按月或按年为该功能付费。一旦取消，用户将无法访问高级功能。您通常会为具有持续发展内容的功能提供订阅，例如访问歌曲或视频库。您也可以通过订阅提供免费试用期。</li><li id="04d8" class="lb lc hu je b jf lk jj ll jn lm jr ln jv lo jz lg lh li lj dt translated"><strong class="je hv">易耗品</strong>:易耗品是可以购买、使用、再购买的产品。例子包括游戏中的额外生命或设定数量的提示。</li></ul><p id="1772" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦你决定了你想提供哪种类型的产品，你就应该考虑如何向你的顾客传达这种产品的信息。你可以在主页上描述你的技能，但由于许多客户没有仔细阅读内容，你需要通过你的语音内容让他们了解你提供的产品。让用户意识到这些内容并提高你的转化率的最好方法是在谈话的自然部分进行，这时优质内容可能会有用:</p><ul class=""><li id="2c2a" class="lb lc hu je b jf jg jj jk jn ld jr le jv lf jz lg lh li lj dt translated">如果你为一个游戏提供一个有额外关卡的扩展包，你可能想在一个已经完成所有内置关卡的返回用户启动你的技能时提供它。</li><li id="d836" class="lb lc hu je b jf lk jj ll jn lm jr ln jv lo jz lg lh li lj dt translated">如果你提供一个不同的游戏作为多游戏技能的一部分，你可能想在用户试图从一个游戏切换到另一个游戏时提供它。</li><li id="29cb" class="lb lc hu je b jf lk jj ll jn lm jr ln jv lo jz lg lh li lj dt translated">如果你提供额外的生命或提示，你可能想在玩家用完他们当前所有的生命或提示时提供，作为继续游戏的一种方式。</li><li id="fe8a" class="lb lc hu je b jf lk jj ll jn lm jr ln jv lo jz lg lh li lj dt translated">这也是一个最佳实践，让客户探索你能提供什么——回应诸如“你有什么可买的？”</li><li id="3d82" class="lb lc hu je b jf lk jj ll jn lm jr ln jv lo jz lg lh li lj dt translated">如果客户拒绝了购买优质内容的提议，你应该进入指数补偿模式——在随后的技能使用中越来越少地提供内容。我建议你不要完全停止提供你的优质内容。我见过拒绝追加销售的客户最终接受了报价。</li></ul><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lp"><img src="../Images/43228f94da33cbe151c6aba38a62f612.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jfkJrwRhLgWjJkPitZWP6g.png"/></div></div><figcaption class="lu lv fg fe ff lw lx bd b be z ek">Selecting a new machine in Slot Machine</figcaption></figure><p id="e8ba" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对于代码示例，我将引用我在吃角子老虎机技能中提供购买的一个高级游戏。老虎机允许客户玩多台机器，他们可以说“选择不同的游戏”，从一台机器切换到另一台机器。我的优质内容可以在三个地方之一呈现给用户——当他们第一次启动技能时，当他们切换到不同的机器时，以及在连续玩同一台机器给定时间后。</p><h2 id="a407" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">使用CLI添加您的产品</h2><p id="1815" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">为了给你的Alexa技能添加一个技能内产品，你必须使用ASK CLI。如果您还没有使用CLI，<a class="ae ka" href="https://developer.amazon.com/docs/smapi/quick-start-alexa-skills-kit-command-line-interface.html" rel="noopener ugc nofollow" target="_blank">请按照这些说明中的步骤1–3</a>进行设置。一旦你设置好了，你会想要克隆你想要添加一个高级产品的技能。使用克隆命令完成此操作</p><pre class="lq lr ls lt fq ly lz ma mb aw mc dt"><span id="dec2" class="kb kc hu lz b fv md me l mf mg">ask clone</span></pre><p id="0e0c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这将为您提供一个您的Alexa技能列表。使用箭头键选择您想要克隆的技能，然后按enter键。如果您在机器上使用Lambda函数，克隆将复制技能清单、元数据和代码。有了这个本地副本之后，转到新克隆的技能的根目录，并使用这个命令来设置您的内置技能产品。</p><pre class="lq lr ls lt fq ly lz ma mb aw mc dt"><span id="af1b" class="kb kc hu lz b fv md me l mf mg">ask add isp</span></pre><p id="72c7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这将为您提供一个可以添加的产品类型列表</p><pre class="lq lr ls lt fq ly lz ma mb aw mc dt"><span id="bd51" class="kb kc hu lz b fv md me l mf mg">List of in-skill product types you can choose (Use arrow keys)<br/>&gt; Consumable<br/>  Entitlement<br/>  Subscription</span></pre><p id="b35d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">选择您想要使用的模板，并接受您看到的默认模板。完成后，系统会提示您输入新技能产品的名称。假设你叫它<code class="eh mh mi mj lz b">extragame</code>。这将在您的技能的isp文件夹中创建一个名为<code class="eh mh mi mj lz b">extragame.json</code>的新文件。</p><p id="6703" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">打开这个文件，你会看到一些需要填写的细节来描述你的技能。具体来说，您需要提供名称、描述、图标(108x108和512x512格式)以及一些描述产品定价和发布日期的发布细节。同样值得注意的是，你需要提供一个隐私政策的链接。不要担心，你可以通过在线搜索“Alexa技能隐私政策”找到几个可以利用的政策示例</p><p id="28dd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦您填写了这些信息，您就可以使用<code class="eh mh mi mj lz b">ask deploy</code>来部署您的技能，它将为您的技能上传新产品设置。</p><h2 id="0d0e" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">检查产品可用性</h2><p id="24aa" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">现在您已经上传了产品设置，您需要在代码中添加支持。你应该做的第一件事是使用<code class="eh mh mi mj lz b">MonetizationServiceClient</code>来检查当用户启动你的技能时哪些产品是可用的。以下代码显示了如何做到这一点，并在会话属性中保存每个产品的可用性:</p><pre class="lq lr ls lt fq ly lz ma mb aw mc dt"><span id="da18" class="kb kc hu lz b fv md me l mf mg">const ms = handlerInput.serviceClientFactory.getMonetizationServiceClient();</span><span id="f3eb" class="kb kc hu lz b fv mk me l mf mg">return ms.getInSkillProducts(event.request.locale)<br/>.then((inSkillProductInfo) =&gt; {<br/>  let state;<br/>  attributes.paid = {};</span><span id="7e75" class="kb kc hu lz b fv mk me l mf mg">  if (inSkillProductInfo) {                  <br/>    inSkillProductInfo.inSkillProducts.forEach((product) =&gt; {<br/>      if (product.entitled === 'ENTITLED') {<br/>        state = 'PURCHASED';<br/>      } else if (product.purchasable == 'PURCHASABLE') {<br/>        state = 'AVAILABLE';<br/>      }<br/><br/>      if (state) {<br/>        attributes.paid[product.referenceName] = {<br/>          productId: product.productId,<br/>          state: state,<br/>        };<br/>      }<br/>    }<br/>  });<br/>})<br/>.catch((error) =&gt; {<br/>  // Ignore errors<br/>});</span></pre><p id="f85f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，在您的<code class="eh mh mi mj lz b">attributes.paid</code>对象中，您有一个所有产品的列表，状态设置为<code class="eh mh mi mj lz b">PURCHASED</code>或<code class="eh mh mi mj lz b">AVAILABLE</code>。当您尝试销售产品时，您可以对照该对象来查看他们是否已经购买了该产品，或者该产品是否可供他们购买。</p><h2 id="58ca" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">设置追加销售响应</h2><p id="7704" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">提供购买产品的代码可能有点复杂。基本上，你要把购买请求交给Alexa，在这个过程中退出你的用户会话。Alexa将处理与客户的互动和支付流程，包括提供亚马逊当时可能正在运行的任何折扣。然后，您的代码将通过一个新的会话和客户是否购买您的产品的结果被回调。</p><p id="6092" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对Alexa的<code class="eh mh mi mj lz b">Connections.SendRequest</code>响应开启了这个过程。幸运的是，您可以传递一个令牌作为这个响应的一部分，这个响应将作为新会话请求的一部分返回给您。我发现这很方便，并使用它来让我知道我提供的是哪种产品(记住，我支持多种产品)，以及哪个处理程序向我发送了请求(因为我可以在多个位置进行追加销售)。这允许我无缝地将用户放回到交互流中。如果他们拒绝了购买回复，我知道在我用报价打断他们之前他们想做什么，所以我可以把他们放回原处。如果他们接受了购买，我也有上下文，所以可以在代码的适当部分删除他们。例如，如果用户在选择新游戏的过程中被出售一个假日主题的老虎机，我会使用一个名为<code class="eh mh mi mj lz b">holiday.select</code>的令牌</p><p id="8d1e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">下面是这段代码的样子:</p><pre class="lq lr ls lt fq ly lz ma mb aw mc dt"><span id="12ec" class="kb kc hu lz b fv md me l mf mg">// Create an upsell directive<br/>const directive = {<br/>  'type': ' Connections.SendRequest’,<br/>  ‘name’: ‘Upsell’,<br/>  ‘payload’: {<br/>  ‘InSkillProduct’: {<br/>    productId: attributes.paid[upsellProduct].productId,<br/>   },<br/>  ‘upsellMessage’: 'We have a holiday themed game available for purchase, want to hear more?',<br/> },<br/>  ‘token’: 'holiday.select',<br/>};</span><span id="2384" class="kb kc hu lz b fv mk me l mf mg">return handlerInput.responseBuilder<br/>  .addDirective(directive)<br/>  .withShouldEndSession(true)<br/>  .getResponse();</span></pre><p id="4cd2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注意<code class="eh mh mi mj lz b">upsellMessage</code>字段需要是明文。Alexa读取时，您为不同声音或语音变化设置的任何SSML标签都将被忽略。从客户交互的角度来看，他们会听到这样的话——注意，在用户对你的代码设置的upsellMessage说“是”之后，交互直接由Alexa处理:</p><blockquote class="ml mm mn"><p id="97d6" class="jc jd mo je b jf jg jh ji jj jk jl jm mp jo jp jq mq js jt ju mr jw jx jy jz hn dt translated">Alexa，选择一台新机<br/>我们有一款假日主题游戏可供购买，想听更多吗？<br/>是<br/>这会将假日游戏添加到您可以玩的老虎机列表中。Prime会员节省0.19美元。如果没有Prime，您的价格是0.99美元加税。你想要购买它吗？<br/>是<br/>请说出您的4位数代码以确认购买。</p></blockquote><p id="b7f6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你处理的是明确的购买而不是追加销售(例如，响应“Alexa，购买假日游戏”这样的请求)，那么你在指令中设置<code class="eh mh mi mj lz b">name</code>为“购买”并删除<code class="eh mh mi mj lz b">upsellMessage</code>字段。您仍然需要设置令牌，以便当它们返回到您的技能时，您可以处理响应。</p><p id="4ae9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">不要忘记取消消息！同样，像购买案例一样，您需要支持一种允许客户退款的话语(“Alexa，退款给假日游戏”)。对于这个消息，您将指令中的<code class="eh mh mi mj lz b">name</code>设置为‘取消’,并再次删除<code class="eh mh mi mj lz b">upsellMessage</code>字段。</p><h2 id="b944" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">处理用户响应</h2><p id="9f3c" class="pw-post-body-paragraph jc jd hu je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">无论用户对您的追加销售请求是同意还是反对，或者如果在购买流程中出现其他错误，您的技能都将通过一个请求类型为<code class="eh mh mi mj lz b">Connections.Response</code>的新会话来调用，然后您可以将用户带到他们的自然继续点。如果他们在选择新机器并购买时听到这条消息，我会将他们放入所选的机器并准备好进行游戏。如果他们拒绝购买，我会告诉他们我们还有哪些机器，这样他们就可以继续选择新机器。如果在购买过程中出现某种错误，我会让他们进入相同的流程，就好像他们拒绝购买一样。Alexa会处理告诉他们有一个错误，所以我们的代码没有必要重复。响应的处理程序如下所示:</p><pre class="lq lr ls lt fq ly lz ma mb aw mc dt"><span id="6e1e" class="kb kc hu lz b fv md me l mf mg">canHandle: function(handlerInput) {<br/>  const request = handlerInput.requestEnvelope.request;<br/>  return (request.type === 'Connections.Response');<br/>},<br/>handle: function(handlerInput) {<br/>  const event = handlerInput.requestEnvelope;<br/>  const attributes = handlerInput.attributesManager.getSessionAttributes();</span><span id="7b6b" class="kb kc hu lz b fv mk me l mf mg">  // options[0] will be the name of the game we were selling<br/>  // options[1] will be the intent they were sold in<br/>  const options = event.request.token.split('.');<br/>  const accepted = (event.request.payload &amp;&amp;<br/>    ((event.request.payload.purchaseResult == 'ACCEPTED') ||<br/>    (event.request.payload.purchaseResult == 'ALREADY_PURCHASED')));<br/>  let nextAction = options[1];</span><span id="3617" class="kb kc hu lz b fv mk me l mf mg">  if ((event.request.name === 'Upsell') &amp;&amp; !accepted) {<br/>    // Don't upsell them again on the next round<br/>    attributes.noUpsell = true;<br/>  }</span><span id="a06a" class="kb kc hu lz b fv mk me l mf mg">  // Did they accept?<br/>  if (accepted) {<br/>    // If this is was a cancellation remove it<br/>    if (event.request.name === 'Cancel') {<br/>      attributes[options[0]] = undefined;<br/>      if (attributes.paid &amp;&amp; attributes.paid[options[0]]) {<br/>        attributes.paid[options[0]].state = 'AVAILABLE';<br/>      }<br/>    } else {<br/>      // We'll auto-select<br/>      // Make sure we put it into the list of paid products as purchased<br/>      if (attributes.paid &amp;&amp; attributes.paid[options[0]]) {<br/>        attributes.paid[options[0]].state = 'PURCHASED';<br/>      }<br/>      nextAction = 'autoselect';<br/>    }<br/>  }</span><span id="2faa" class="kb kc hu lz b fv mk me l mf mg">  // And go to the appropriate next step<br/>  // Select, SelectYes, Spin, and Launch are intent handlers<br/>  if (nextAction === 'select') {<br/>    return Select.handle(handlerInput);<br/>  } else if (nextAction === 'autoselect') {<br/>    attributes.gameToSelect = options[0];<br/>    return SelectYes.handle(handlerInput);<br/>  } else if (nextAction === 'spin') {<br/>    return Spin.handle(handlerInput);<br/>  } else {<br/>    // Just drop them directly into a game<br/>    return Launch.handle(handlerInput);<br/>  }</span></pre><p id="8501" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您会注意到，除了设置新机器(如果选中)并移交给适当的下一个意向进行处理之外，如果用户收到追加销售消息并拒绝了它，还有代码设置一个<code class="eh mh mi mj lz b">noUpsell</code>标志。这是为了避免无限循环，因为我将用户放回到他们之前所在的路径。在显示追加销售消息之前，我的代码检查是否设置了该标志以避免无限循环。这也有助于确保客户在会话期间只听到一次追加销售信息，从而获得更好的客户体验。</p><p id="5681" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我希望你觉得这个指南有用，并祝你好运添加优质内容到你自己的Alexa技能！</p></div></div>    
</body>
</html>