<html>
<head>
<title>Simplifying Jenkinsfiles</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">简化Jenkinsfiles文件</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/simplifying-jenkinsfiles-c97cfee13f83?source=collection_archive---------0-----------------------#2018-12-27">https://medium.com/hackernoon/simplifying-jenkinsfiles-c97cfee13f83?source=collection_archive---------0-----------------------#2018-12-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><blockquote class="ir is it"><p id="7f3a" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">利用詹金斯来解开詹金斯。</p></blockquote><figure class="jt ju jv jw fq jx fe ff paragraph-image"><div class="ab fr cl jy"><img src="../Images/3f50c0b66eef9b8f2cc87fd01ba07748.png" data-original-src="https://miro.medium.com/v2/0*5wF1cCMs3cPKju4P."/></div></figure><p id="d0c1" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kb jh ji jj kc jl jm jn kd jp jq jr js hn dt translated">在过去的几周里，我对詹金斯的内部运作进行了彻底的<strong class="ix hv">疯狂的调查。我们一直在寻找一种好的、方便的方法来简化我们的应用程序库的根处的<code class="eh ke kf kg kh b">Jenkinsfile</code>。我们喜欢詹金斯，经过谷歌搜索和一些实验，我们发现了一些很酷的东西。但是首先，问题。</strong></p><p id="3010" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kb jh ji jj kc jl jm jn kd jp jq jr js hn dt translated">我试图雄辩地描述我们的一些詹金斯档案有多糟糕，但是我的一个同事抢先了一步:</p><blockquote class="ki"><p id="7a98" class="kj kk hu bd kl km kn ko kp kq kr js ek translated">这个Jenkinsfile看起来像是Groovy开发人员用cat命令创建的。</p></blockquote><p id="2474" class="pw-post-body-paragraph iu iv hu ix b iy ks ja jb jc kt je jf kb ku ji jj kc kv jm jn kd kw jq jr js hn dt translated">他没有错。天哪，我们的档案里有一些疯狂的东西。所有这些<em class="iw">都需要</em>，但没有一件是漂亮的。看看这个坏男孩:</p><pre class="jt ju jv jw fq kx kh ky kz aw la dt"><span id="b5c7" class="lb lc hu kh b fv ld le l lf lg">pipeline {<br/>    agent any</span><span id="8ce5" class="lb lc hu kh b fv lh le l lf lg">    parameters {<br/>        string (defaultValue: '', description: '<strong class="kh hv">Imagine like 10 parameters here</strong>', name: 'buildNumber')</span><span id="fea4" class="lb lc hu kh b fv lh le l lf lg">    tools {<br/>        // Yep, everyone was using the same maven and JDK version.</span><span id="ef1b" class="lb lc hu kh b fv lh le l lf lg">maven 'Maven 3.5.0'<br/>        jdk 'jdk8'<br/>    }<br/>    environment {<br/>        BUCKET='my-app-bucket'</span><span id="7551" class="lb lc hu kh b fv lh le l lf lg"><strong class="kh hv">        // ABOUT 15 IDENTICAL ENVIRONMENT VARIABLES</strong><br/>    }<br/>    stages {<br/>        stage("Initialise"){</span><span id="de28" class="lb lc hu kh b fv lh le l lf lg">            steps{<br/>                echo "Config Aws - <strong class="kh hv">Yep, everyone does this too</strong>"<br/>                sh"""<br/>                    <strong class="kh hv">aws do-some-repetitive-shit</strong><br/>                """<br/>                <br/>            }<br/>        }<br/>        stage("Test"){<br/>            when {<br/>                expression {<br/>                    params.buildNumber == ''<br/>                }<br/>            }<br/>            steps{<br/>                echo 'Running Tests'<br/>                sh "<strong class="kh hv">Run the same maven command as every build</strong>"<br/>                }<br/>            }<br/>            post {<br/>                always {<br/>                    junit 'target/surefire-reports/**/*.xml'<br/>                }<br/>                success {<br/>                    <strong class="kh hv">sh "Tell Slack the build went okay"</strong><br/>                }<br/>                failure {<br/>                    <strong class="kh hv">sh "Tell Slack the build is knackered"</strong><br/>                }<br/>            }<br/>        }<br/>        stage('Cleanup') {<br/>            when {<br/>                <strong class="kh hv">// Do the same conditional logic in every file.</strong><br/>            }<br/>            steps {<br/>                <strong class="kh hv">sh "Do the same clean up for every app"</strong><br/>            }<br/>        }</span><span id="540b" class="lb lc hu kh b fv lh le l lf lg">        stage('Packaging') {<br/>            when {<br/>                <strong class="kh hv">// Some more conditional logic? Fuck it, why not.</strong><br/>            }<br/>            steps {<br/>                // <strong class="kh hv">You guessed it you animals, more of the same.<br/>                sh "Literally run mvn package"</strong></span><span id="bef6" class="lb lc hu kh b fv lh le l lf lg">            }<br/>            post {<br/>                failure {<br/>                    <strong class="kh hv">sh "A failure condition that has never fired"</strong><br/>                }<br/>            }<br/>        }</span><span id="455b" class="lb lc hu kh b fv lh le l lf lg">        stage(’Push App Version’) {<br/>            when {<br/>                <strong class="kh hv">// It’s not complicated enough. MORE CONDITIONALS.</strong><br/>            }<br/>            steps {<br/>                <strong class="kh hv">// You bet this is copied and pasted. </strong><br/>            }    <br/>        }</span><span id="6192" class="lb lc hu kh b fv lh le l lf lg">        stage(’Deploy’) {<br/>            when {<br/>                <strong class="kh hv">// Ayyy. It’s not a party without conditional logic.</strong><br/>            }<br/>            steps{<br/>                echo "Deploying cos to dev"<br/>                <strong class="kh hv">sh "THE SAME COMMAND EVERY TIME SERIOUSLY OMG"</strong><br/>            }<br/>        }<br/>    }<br/>}</span></pre><h1 id="add2" class="li lc hu bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me dt translated">该死的克里斯</h1><p id="7d0f" class="pw-post-body-paragraph iu iv hu ix b iy mf ja jb jc mg je jf kb mh ji jj kc mi jm jn kd mj jq jr js hn dt translated">我知道。我们运行着令人毛骨悚然的微服务，这种疯狂充斥着整个节目。几十个这样的文件(除去脏话)，这完全是我的错。我记得一开始设计这个该死的文件。我记得懒洋洋地复制和粘贴。我知道这将咬我的屁股，像一个S&amp;M爱好者，我不在乎。变坏的感觉真好。</p><p id="f102" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kb jh ji jj kc jl jm jn kd jp jq jr js hn dt translated">当我们不得不对CI/CD渠道进行更改时，这种感觉就不再好了。我摘下我的瘸子面具，做了一些谷歌搜索。然后我挖到了金子。</p><h2 id="5273" class="lb lc hu bd lj mk ml mm ln mn mo mp lr kb mq mr lv kc ms mt lz kd mu mv md mw dt translated">全球共享库</h2><p id="8858" class="pw-post-body-paragraph iu iv hu ix b iy mf ja jb jc mg je jf kb mh ji jj kc mi jm jn kd mj jq jr js hn dt translated">对，所以首先要认识到的是，你的管道只是一组groovy脚本。如果是声明式的或脚本式的，它只是运行一堆groovy命令。Groovy和Java一样，支持文件顶部的<code class="eh ke kf kg kh b">import</code>语句。一旦这一点变得显而易见，我们就会想到一些事情:</p><ul class=""><li id="32eb" class="mx my hu ix b iy iz jc jd kb mz kc na kd nb js nc nd ne nf dt translated">所有的构建都以同样的方式做着同样的事情</li><li id="bb15" class="mx my hu ix b iy ng jc nh kb ni kc nj kd nk js nc nd ne nf dt translated">由于复制和粘贴，一些构建使用了maven的旧版本或者运行不同风格的命令。</li><li id="d404" class="mx my hu ix b iy ng jc nh kb ni kc nj kd nk js nc nd ne nf dt translated">所有应用程序都部署到同一个基础架构中。</li></ul><p id="51cf" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kb jh ji jj kc jl jm jn kd jp jq jr js hn dt translated">所以我转向我的同事，告诉那个漂亮的混蛋我有个主意。他没理我，因为我一天要说100遍，但这次我说到点子上了。</p><p id="4cc1" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kb jh ji jj kc jl jm jn kd jp jq jr js hn dt translated">我在这个过程中学到了一些东西，所以我把一个<a class="ae nl" href="https://github.com/ChrisCooney/jenkins-global-library-simple" rel="noopener ugc nofollow" target="_blank">简单的示例库和一些注意事项</a>放在了一起。好吧，盛大的揭幕仪式，我们的詹金斯档案现在看起来怎么样了？</p><pre class="jt ju jv jw fq kx kh ky kz aw la dt"><span id="0ca0" class="lb lc hu kh b fv ld le l lf lg">import com.central.ci.*</span><span id="adc4" class="lb lc hu kh b fv lh le l lf lg">APP_NAME = "my-app"</span><span id="19b2" class="lb lc hu kh b fv lh le l lf lg">Pipelines pipelines = new Pipelines()</span><span id="b938" class="lb lc hu kh b fv lh le l lf lg">pipelines.javaPipeline(APP_NAME)</span><span id="1b4b" class="lb lc hu kh b fv lh le l lf lg">// They could also invoke pipelines.emptyJavaPipeline() and define their own, but without the need to set everything up.</span></pre><h2 id="ad8b" class="lb lc hu bd lj mk ml mm ln mn mo mp lr kb mq mr lv kc ms mt lz kd mu mv md mw dt translated">而且做起来非常简单！</h2><p id="031f" class="pw-post-body-paragraph iu iv hu ix b iy mf ja jb jc mg je jf kb mh ji jj kc mi jm jn kd mj jq jr js hn dt translated">首先，创建一个git存储库。詹金斯支持其他一些人，但现在已经不是2006年了。请记住，Jenkins需要适当的凭证才能访问您的私有存储库。</p><p id="055f" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kb jh ji jj kc jl jm jn kd jp jq jr js hn dt translated">其次，告诉Jenkins这个存储库是存在的。点击“管理Jenkins”并向下滚动，直到您看到以下内容:</p><figure class="jt ju jv jw fq jx fe ff paragraph-image"><div role="button" tabindex="0" class="nn no di np bf nq"><div class="fe ff nm"><img src="../Images/c106c81bfdb610ff44482d3dcfc29b32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ibeuRqDWkFP3qRJckZRHgA.png"/></div></div><figcaption class="nr ns fg fe ff nt nu bd b be z ek">You’ve struck oil you lucky bastard.</figcaption></figure><p id="405c" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kb jh ji jj kc jl jm jn kd jp jq jr js hn dt translated">您需要指定存储库的位置，包括您需要的任何凭证。从那里，像对待任何其他Groovy脚本一样对待您的<code class="eh ke kf kg kh b">Jenkinsfile</code>,并导入您的库。如果你想确保所有的构建默认都有这个，我建议勾选“隐式加载”框。</p><h2 id="7059" class="lb lc hu bd lj mk ml mm ln mn mo mp lr kb mq mr lv kc ms mt lz kd mu mv md mw dt translated">所以是的</h2><p id="98b9" class="pw-post-body-paragraph iu iv hu ix b iy mf ja jb jc mg je jf kb mh ji jj kc mi jm jn kd mj jq jr js hn dt translated">不敢相信实话实说会有这么好的效果。我们还没有给它一个详尽的运行，但到目前为止，它已经受到好评，我们正在推出它到我们现有的应用程序的过程中。</p></div><div class="ab cl nv nw hc nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="hn ho hp hq hr"><p id="30b1" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kb jh ji jj kc jl jm jn kd jp jq jr js hn dt translated">更多CI/CD漫谈，<a class="ae nl" href="https://twitter.com/chris_cooney" rel="noopener ugc nofollow" target="_blank">在twitter上关注我！</a></p></div></div>    
</body>
</html>