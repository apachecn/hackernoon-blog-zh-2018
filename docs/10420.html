<html>
<head>
<title>DIY Redux with RxJS =&gt; RxDx</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带RxJS的DIY Redux with RxJS</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/diy-redux-with-rxjs-rxdx-23163a87ade1?source=collection_archive---------7-----------------------#2018-12-29">https://medium.com/hackernoon/diy-redux-with-rxjs-rxdx-23163a87ade1?source=collection_archive---------7-----------------------#2018-12-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/e2035650f8cb1e060e2f23b3e69ba90e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dvz733Mj3DVx2ytegmBW-g.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Photo by <a class="ae jg" href="https://unsplash.com/photos/iVGevPcaJzk?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Steve Halama</a> on <a class="ae jg" href="https://unsplash.com/search/photos/code?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="dae1" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果你正在开发一个巨大的应用程序，状态管理是必须的，使用适当的状态管理可以是一个真正的救命稻草。在React上，Redux是我们的救生员，在Angular上，我们有NgRx来担当这个角色。</p><p id="9699" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我认为，在架构层面上，两者都有相似的样板，如果你已经掌握了其中一个，那么你对另一个的学习曲线将会更加平滑。我在NgRx上真正喜欢的不是库本身，而是RxJS，它确实是处理流事件的最令人惊叹的库。</p><p id="dc62" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">当我在研究Redux和NgRx时，我意识到几乎没有人在没有大量助手库的情况下单独使用Redux，但另一方面，NgRx的情况并不相似，因为它在大多数情况下提供了一个完整的解决方案。所以我决定做一个实验，将RxJS和所有Redux helper库结合起来，创建一个超级duper状态管理库，用于像Redux这样具有相似指纹的React。</p><p id="b152" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在这一点上，诀窍是显而易见的:首先，我用RxJS重新实现了Redux，并在其上添加了一些中间件salt，它已经准备好了！所以在这篇文章中，我将试着解释我是如何做到的。</p><p id="c0a3" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv">提示:我已经发布了最终库的alpha版本，你可以在这里查看</strong><a class="ae jg" href="https://github.com/onerzafer/rxdx" rel="noopener ugc nofollow" target="_blank"><strong class="jj hv"/></a><strong class="jj hv">。</strong></p><h1 id="c9a5" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">步骤0:解构Redux和相关库</h1><p id="8d77" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">Redux主要提供了一个<strong class="jj hv"> createStore </strong>函数，它显然创建了一个商店。这个createStore带有一个<strong class="jj hv">缩减器、</strong> <strong class="jj hv">初始状态、</strong>和一个<strong class="jj hv">增强器</strong>。</p><p id="630a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv"> Reducer </strong>是取一个状态返回一个状态的函数。很简单，对吧？但是等一下，我将需要不止一个减压器，这意味着我将需要一个助手函数来将所有减压器组合成一个大减肥器。</p><p id="3aab" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">出于类似的目的，Redux有<strong class="jj hv">组合减少器</strong>功能，非常方便。<strong class="jj hv">初始状态</strong>是一个对象，它可能是一个空的或未定义的状态。甚至更简单！<strong class="jj hv">增强器</strong>有点奇怪，有以下特征:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="6b47" class="lr kg hu ln b fv ls lt l lu lv">(createStore) =&gt; (reducer, initialState) =&gt; store</span></pre><p id="1174" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我将再次需要不止一个增强器，我将再次需要一个助手函数来将所有增强器组合成一个名为<strong class="jj hv"> applyMiddleware的增强器。</strong></p><p id="5d96" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">当我们运行createStore函数时，它返回一个类似于下面简化对象的对象:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="8692" class="lr kg hu ln b fv ls lt l lu lv">{<br/>   getState: () =&gt; state,<br/>   subscribe: () =&gt; unsubscribe,<br/>   dispatch: (action) =&gt; void<br/>}</span></pre><p id="f40b" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv"> getState </strong>返回当前状态。<strong class="jj hv">订阅</strong>返回一个<strong class="jj hv">取消订阅</strong>对象，但是如果我打算使用RxJS，我可以使用它自己的订阅和取消订阅。因此，我将有一个更简单的实现。<strong class="jj hv">分派</strong>功能实际上将动作传递给减速器。RxJS在这里也很方便，它有自己的调度机制。</p><p id="ab64" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">因此，我创建了一个待办事项列表来实现我的目标:</p><ul class=""><li id="8941" class="lw lx hu jj b jk jl jo jp js ly jw lz ka ma ke mb mc md me dt translated">实现` createStore(reducer，initialState，enhancer) =&gt; store `功能</li><li id="14e3" class="lw lx hu jj b jk mf jo mg js mh jw mi ka mj ke mb mc md me dt translated">实现“combine reducer(structuredReducersObject)= &gt; reducer”</li><li id="72af" class="lw lx hu jj b jk mf jo mg js mh jw mi ka mj ke mb mc md me dt translated">实现` applymiddleware(createStore)= &gt;(reducer，initialState) =&gt; store `功能</li></ul><p id="2e9f" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">开始吧！</p><h1 id="04ee" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">第一步:在RxJS行为主体和操作者的帮助下创建Store</h1><p id="da27" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">任何时候<strong class="jj hv">商店</strong>的消费者调用<strong class="jj hv"> getState，</strong>商店都应该返回当前状态。如果我使用<strong class="jj hv">behavior subject</strong>作为状态源，内部存储状态的实现将更容易，因为通过调用<strong class="jj hv">behavior subject . value</strong>来自RxJS observables的类似行为属于<strong class="jj hv">behavior subject</strong>。</p><p id="0ee5" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">事情是这样的:</p><figure class="li lj lk ll fq iv"><div class="bz el l di"><div class="mk ml l"/></div></figure><p id="7aa6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我将用人类的语言重新表述我在这里所做的事情。在<strong class="jj hv"> createStore </strong>函数中，我用给定的<strong class="jj hv">减速器</strong>和<strong class="jj hv">初始状态</strong>创建了一个<strong class="jj hv">商店</strong>。如果有一个<strong class="jj hv">增强器</strong>我传递一个假的<strong class="jj hv"> createStore </strong>函数，它将返回已经创建的<strong class="jj hv">存储</strong>，结果它将返回增强的<strong class="jj hv">存储</strong>。然后我分派第一个动作并返回创建的或增强的存储。所以当调用<strong class="jj hv"> createStore </strong>函数时，我们可以在我们的app中使用<strong class="jj hv"> store引用</strong>。也许这个引用可以传递给某个react上下文提供者。</p><p id="7861" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如你所见，最复杂的部分是<strong class="jj hv">选择</strong>功能，它根本不是一个必须具备的功能。我添加这个部分是为了有一个接口，比如<strong class="jj hv">重选</strong>。据我目前所知，Redux的<strong class="jj hv"> subscribe </strong>功能并不是一个广泛使用的特性，但是react-redux库使用它来获得更新和重新呈现组件(如果有人直接使用它，请在下面评论它，因为在我的实验中我找不到任何subscribe功能的用例)。</p><p id="057f" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv">因此，createStore函数到目前为止应该能够为一个reducer和一个enhancer工作，这意味着我的基于RxJS的Redux库的主干已经准备好被命名:从现在开始我将称它为RxJs + Redux = RxDx。</strong></p><h1 id="6cbf" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">第二步:如何创建一个combineReducers函数？</h1><p id="2623" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">当我检查Redux的<strong class="jj hv"> combineReducers </strong>源代码时，我意识到它接受一个对象(可以嵌套),该对象的键有一个reducer，结果返回一个更大的reducer。</p><p id="c1ea" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">让我们从下面的初始代码开始:</p><figure class="li lj lk ll fq iv"><div class="bz el l di"><div class="mk ml l"/></div></figure><p id="ab68" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在，我将避免错误预防和错误处理(我将信任使用该函数的任何人)。这里的想法是循环reducers对象的键，并调用带有相关状态部分和动作的附加reducer。</p><p id="1d5e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">因此，所有的reducers将只更新状态的相关部分，我将在相同的结构中组合结果并返回它们。当我试图编写这个函数时，我注意到这个函数的名字本身就有解:<strong class="jj hv"> Array.reduce. </strong></p><figure class="li lj lk ll fq iv"><div class="bz el l di"><div class="mk ml l"/></div></figure><h1 id="029e" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">步骤3:神奇的applyMiddleware函数</h1><p id="d9ec" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">如果你仔细观察Redux的实现，最神奇的事情发生在一个名为<strong class="jj hv"> compose </strong>的函数上。撰写功能是做什么的？实际上，它非常简单，因为它接受一个函数列表，通过将第二个包装的函数传递给第一个函数，将第三个传递给第二个函数，以此类推，来包装每个函数，最后返回这个奇怪的嵌套函数:</p><figure class="li lj lk ll fq iv"><div class="bz el l di"><div class="mk ml l"/></div></figure><p id="711c" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">从上面可以看到，函数A，B，C，D，E变成了A(B(C(D(E(…args))))。这个行为是至关重要的，因为所有的增强器都应该能够在每个动作上被调用，并且所有的增强器都应该能够改变动作或者调度新的动作，甚至延迟原来的动作。对增强器还有一个限制，因为它们应该遵循下面的签名:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="fbe1" class="lr kg hu ln b fv ls lt l lu lv">// sample enhancer signature<br/>const enhancer =&gt; (createStore) =&gt; (next) =&gt; (action) =&gt; state</span></pre><p id="fef3" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最后，通过省略错误处理和错误预防部分，我得到了下面的函数:</p><figure class="li lj lk ll fq iv"><div class="bz el l di"><div class="mk ml l"/></div></figure><h1 id="1e15" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">最后的话</h1><p id="68ac" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">事实上，RxDx目前包括其他功能的损失，如果你愿意检查它们和所有的示例用法，你可以检查<a class="ae jg" href="https://github.com/onerzafer/rxdx" rel="noopener ugc nofollow" target="_blank"> repo </a>和<a class="ae jg" href="https://github.com/onerzafer/rxdx-sample-app" rel="noopener ugc nofollow" target="_blank"> sample todo app repo </a>。</p><p id="120d" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这是RxDx的核心部分，我计划在这篇文章的后续文章中进一步解释如何将RxDx连接到React组件。</p><p id="20af" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在接下来的文章中，我希望能阐明react-redux的内部结构，然后我将继续讨论react-observable，然后重新选择库。</p><p id="7cb9" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果你对RxDx感兴趣，并且喜欢到目前为止的文章，请不要忘记点击拍手(你最多可以拍手50次)。如果你在下面分享你的想法和反馈，我会很高兴的！感谢阅读。</p></div><div class="ab cl mm mn hc mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="hn ho hp hq hr"><p id="72c0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv">对于第2部分，请点击链接:</strong></p><div class="mt mu fm fo mv mw"><a href="https://hackernoon.com/diy-redux-with-rxjs-part-2-f9d4c53fa230" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab ej"><div class="my ab mz cl cj na"><h2 class="bd hv fv z el nb eo ep nc er et ht dt translated">使用RxJS的DIY Redux:第2部分</h2><div class="nd l"><h3 class="bd b fv z el nb eo ep nc er et ek translated">将RxJS和所有广泛使用的Redux中间件合并为一个库的尝试</h3></div><div class="ne l"><p class="bd b gc z el nb eo ep nc er et ek translated">hackernoon.com</p></div></div><div class="nf l"><div class="ng l nh ni nj nf nk ja mw"/></div></div></a></div></div></div>    
</body>
</html>