<html>
<head>
<title>GraphQL Subscriptions Using Apollo 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Apollo 2的GraphQL订阅</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/graphql-subscriptions-using-apollo-2-3eb3184768c4?source=collection_archive---------6-----------------------#2018-12-30">https://medium.com/hackernoon/graphql-subscriptions-using-apollo-2-3eb3184768c4?source=collection_archive---------6-----------------------#2018-12-30</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/8031296f381f8645d2b57fa3137dde50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f4f6LIAv3mJ0umAM94mS6w.jpeg"/></div></div></figure><p id="93e9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我的一个兼职项目涉及围绕通用象棋接口(<a class="ae ka" href="http://wbec-ridderkerk.nl/html/UCIProtocol.html" rel="noopener ugc nofollow" target="_blank"/>)编写一个<a class="ae ka" href="https://wehavefaces.net/graphql-shorthand-notation-cheatsheet-17cd715861b6" rel="noopener ugc nofollow" target="_blank"> GraphQL API </a>。我最初开发了一个模拟实现，不久前<a class="ae ka" href="https://medium.freecodecamp.org/wrapping-an-streaming-i-o-interface-in-graphql-931650dafd3b" rel="noopener ugc nofollow" target="_blank">写了一篇文章</a>。它使用的是Apollo第一版的客户端/服务器堆栈，在第二版中<a class="ae ka" href="https://www.apollographql.com/docs/apollo-server/migration-two-dot.html" rel="noopener ugc nofollow" target="_blank">做了很大的改变。最大的变化之一是订阅接口和实现，我花了很多时间才让它工作起来。部分问题是文档不是很完整，而是很分散。这篇文章将涵盖订阅服务的最基本的实现和使用它的客户端代码。</a></p><h1 id="4401" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">入门指南</h1><p id="a330" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">GraphQL服务器将基于<a class="ae ka" href="https://www.apollographql.com/docs/apollo-server/" rel="noopener ugc nofollow" target="_blank"> ApolloServer </a>，在这种情况下，它将使用Express服务器作为中间件。订阅将使用一个<a class="ae ka" href="https://en.wikipedia.org/wiki/WebSocket" rel="noopener ugc nofollow" target="_blank"> WebSocket </a>，它连接到一个普通的HTTP服务器(正如我们将看到的，也是由ApolloServer管理的)。</p><p id="710e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">有两个客户端:GraphQL Playground和一个供Mocha在GUI之外测试API的客户端。为了简单起见，我将把Mocha客户机代码保存在与服务器代码相同的文件夹中。我也用巴别塔，这样我就不用考虑迈克尔·杰克逊的剧本等等。</p><p id="06ba" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">记住这一点，下面是要安装的软件包:</p><ul class=""><li id="6cbe" class="le lf hu je b jf jg jj jk jn lg jr lh jv li jz lj lk ll lm dt translated">阿波罗链接，阿波罗链接http，阿波罗链接ws，阿波罗服务器快递</li><li id="6fa3" class="le lf hu je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm dt translated">巴别cli，巴别核心，巴别预设环境</li><li id="6b6c" class="le lf hu je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm dt translated">graphql，graph QL-工具</li><li id="8a4d" class="le lf hu je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm dt translated">订阅-传输-ws</li><li id="7a3b" class="le lf hu je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm dt translated">茶，摩卡</li></ul><p id="f585" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我将在本文末尾提供一个工作代码库的链接。</p><h1 id="1cfa" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">服务器</h1><p id="41bc" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">这个服务器是我能做的最简单的:</p><figure class="ls lt lu lv fq iv"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="968c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在第12 行<strong class="je hv">创建了一个ApolloServer，并传入了一个模式和解析器。第17 </strong>行<strong class="je hv">上的<a class="ae ka" href="https://www.apollographql.com/docs/apollo-server/essentials/server.html#middleware" rel="noopener ugc nofollow" target="_blank"> applyMiddleware </a>调用在第9 </strong>行<strong class="je hv">上创建的express应用中通过。最后，创建一个http服务器来处理订阅服务的web socket接口，这是在<strong class="je hv">第22行</strong>上创建的。</strong></p><h2 id="da2c" class="ly kc hu bd kd lz ma mb kh mc md me kl jn mf mg kp jr mh mi kt jv mj mk kx ml dt translated">该模式</h2><figure class="ls lt lu lv fq iv"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="0e4a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该模式非常基本:<strong class="je hv"> go </strong>将返回一个字符串确认，但是在后台它将触发一个方法，向订阅者发送发布通知。订户通过<strong class="je hv">信息</strong>订阅API进行订阅。</p><p id="5583" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们可以在resolvers.js中看到这是如何工作的:</p><figure class="ls lt lu lv fq iv"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="c05c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我特意简化了解析器。例如，来自PubSub的asyncIterator方法相当复杂(例如，它支持过滤器和认证)。既然已经<a class="ae ka" href="https://www.apollographql.com/docs/apollo-server/features/subscriptions.html" rel="noopener ugc nofollow" target="_blank">有据可查</a>，这里就不深究各种选项了。上面的解析器所做的只是向所有订阅者发布一个<strong class="je hv">信息主题</strong>，将<strong class="je hv">信息</strong>对象作为订阅的主体进行传递(<strong class="je hv">行10 </strong>)。</p><h1 id="f23a" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">客户</h1><p id="8944" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">正如我提到的，我将使用两个客户端进行测试。一个是内置的Prisma Playground，这是一个由ApolloServer自动提供的服务(仅供参考:<a class="ae ka" href="https://www.apollographql.com/docs/apollo-server/features/graphql-playground.html#Configuring-Playground" rel="noopener ugc nofollow" target="_blank">你可以在生产中关闭这个功能</a>)。</p><h2 id="750a" class="ly kc hu bd kd lz ma mb kh mc md me kl jn mf mg kp jr mh mi kt jv mj mk kx ml dt translated">操场测试</h2><p id="710a" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">为了测试，我将在Chrome中打开Playground，位于<a class="ae ka" href="http://localhost:3031/graphql." rel="noopener ugc nofollow" target="_blank">http://localhost:3031/graph QL。</a>在Playground中，你可以打开多个标签。首先，我将订阅<strong class="je hv">信息专题</strong>:</p><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mm"><img src="../Images/752b6eeb33bff005275cbf866b9b230e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kOWRMlUhvC3UQI-IVMo2YQ.png"/></div></div></figure><p id="a2ee" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">播放此命令时，您将在右窗格中看到“Listening …”响应，如上所示。现在您已经订阅了。</p><p id="a852" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在操场中打开另一个标签，查询<strong class="je hv"> go: </strong></p><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mn"><img src="../Images/d92a264907c36d259b9cf31eec3bbb72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8nSzQgpD63UMJMMPAT2E8A.png"/></div></div></figure><p id="cc93" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这发回了一个“正在进行”的响应，所以一切正常。现在，返回到subscription选项卡，您将看到发布的输出:</p><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mo"><img src="../Images/3cbc7178c8bdb947f48acde6f5e5fe37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IbFu1tqOmn31Ms9JwlVIjQ.png"/></div></div></figure><h1 id="b127" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">使用摩卡/茶进行测试</h1><p id="0bcf" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">在设置客户机时有很多样板文件，所以我创建了一个实用程序文件来处理查询和订阅操作。它叫做fetch.js:</p><figure class="ls lt lu lv fq iv"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="f60f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">fetch.js代码引入了许多相互依赖的模块。对于测试操作，我使用<a class="ae ka" href="https://www.npmjs.com/package/apollo-link" rel="noopener ugc nofollow" target="_blank"> apollo-link </a> ( <strong class="je hv">第6行)</strong>来处理服务器之间的接口(顺便说一下，它必须正在运行😉)和测试的GraphQL操作。这里实际上有两个接口:一个通过HTTP处理查询和变异请求(第21–27行)，另一个通过web套接字订阅主题(第29–37行)。</p><p id="d48d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">大部分来自于<a class="ae ka" href="https://www.apollographql.com/docs/link/index.html#standalone" rel="noopener ugc nofollow" target="_blank">文档</a>，但是你必须安装一些额外的模块，我之前没有提到:</p><ul class=""><li id="8ad0" class="le lf hu je b jf jg jj jk jn lg jr lh jv li jz lj lk ll lm dt translated">节点获取(通过<strong class="je hv"> npm -g </strong>全局安装)</li><li id="4964" class="le lf hu je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm dt translated">《华盛顿明星报》</li><li id="732c" class="le lf hu je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm dt translated">gql</li></ul><p id="4298" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">节点获取</strong>模块实现了正在成为标准的HTTP <a class="ae ka" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API" rel="noopener ugc nofollow" target="_blank">获取API </a>。<strong class="je hv"> ws </strong>模块是Node的WebSocket实现(还有其他的)，而<strong class="je hv"> gql </strong>是一个模板文字标签，你可以在这里阅读更多关于<a class="ae ka" href="https://github.com/apollographql/graphql-tag" rel="noopener ugc nofollow" target="_blank">的内容。</a></p><p id="8335" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">测试本身非常简单:我们首先<strong class="je hv">订阅</strong>，然后<strong class="je hv">开始</strong>:</p><figure class="ls lt lu lv fq iv"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="a8a8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv"> hander </strong>对象(传递给第26 行的<strong class="je hv"> subscribe </strong>方法)接收发布通知。当接收到最后发布的消息时，测试过程终止(<strong class="je hv">第15行)</strong>。</p><h1 id="8017" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">结论</h1><p id="9c89" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">您应该浏览提供的链接，因为还有很多关于GraphQL订阅的内容我无法在本文中介绍。我还包括了一些相关的链接，如下。包含以上代码的完整github库可以在<a class="ae ka" href="https://github.com/JeffML/Apollo2Sub" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv">这里</strong> </a>找到。尽情享受吧！</p></div><div class="ab cl mp mq hc mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="hn ho hp hq hr"><ul class=""><li id="ad6d" class="le lf hu je b jf jg jj jk jn lg jr lh jv li jz lj lk ll lm dt translated"><a class="ae ka" href="https://dev-blog.apollodata.com/tutorial-graphql-subscriptions-server-side-e51c32dc2951" rel="noopener ugc nofollow" target="_blank">教程:GraphQL订阅(服务器端)— Apollo </a></li><li id="823a" class="le lf hu je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm dt translated"><a class="ae ka" href="https://dev-blog.apollodata.com/tutorial-graphql-subscriptions-server-side-e51c32dc2951" rel="noopener ugc nofollow" target="_blank">GraphQL</a><a class="ae ka" href="https://github.com/apollographql/graphql-subscriptions" rel="noopener ugc nofollow" target="_blank">apollographql/graph QL-subscriptions:实现Node.js的graph QL订阅的小模块</a></li><li id="9a8c" class="le lf hu je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm dt translated"><a class="ae ka" href="https://github.com/apollographql/apollo-server/issues/1338" rel="noopener ugc nofollow" target="_blank">Apollo Server 2.0上的SSL订阅问题#1338 </a></li><li id="b646" class="le lf hu je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm dt translated"><a class="ae ka" href="https://github.com/apollographql/apollo-server/issues/1338" rel="noopener ugc nofollow" target="_blank">apollographql/阿波罗-服务器</a> <a class="ae ka" href="https://www.apollographql.com/docs/link/links/ws.html" rel="noopener ugc nofollow" target="_blank">阿波罗-链接-ws |阿波罗链接</a></li><li id="10df" class="le lf hu je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm dt translated"><a class="ae ka" href="https://www.apollographql.com/docs/link/index.html" rel="noopener ugc nofollow" target="_blank">graph QL | Apollo Link的可组合网络</a></li><li id="023d" class="le lf hu je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm dt translated"><a class="ae ka" href="https://www.apollographql.com/docs/react/api/apollo-client.html#ApolloClient.subscribe" rel="noopener ugc nofollow" target="_blank">阿波罗客户端|阿波罗客户端</a></li></ul></div></div>    
</body>
</html>