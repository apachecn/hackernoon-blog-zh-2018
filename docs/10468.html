<html>
<head>
<title>Minimal Solidity Contract Testing with Ganache and Jest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于Ganache和Jest的最小可靠性契约测试</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/minimal-solidity-contract-testing-with-ganache-and-jest-f735547d9643?source=collection_archive---------9-----------------------#2018-12-31">https://medium.com/hackernoon/minimal-solidity-contract-testing-with-ganache-and-jest-f735547d9643?source=collection_archive---------9-----------------------#2018-12-31</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="e3f6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最近，在为dapps编写一些前端工具时，我遇到了快速测试我的库是否能与真正的Solidity契约一起工作的需求。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/b24c5db198f3f035d3ad475f43f3180b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SLAxiKVogFIzakqLqkM4Bw.jpeg"/></div></div></figure><p id="4f24" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">虽然我总是建议dapp制造商从块菌项目开始，但有时你需要更轻量级的东西。例如，与其必须运行迁移，<strong class="it hv">也许您只想编译一个智能契约并立即进行测试。</strong></p><p id="94ce" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不用担心，松露工具套件已经覆盖了你！</p><p id="5132" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本教程中，我将向您展示如何用Ganache和Jest设置最小智能契约测试。</p><p id="34bd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="kb">如果不需要循序渐进的解释，回购的例子就在这里:</em> </strong></p><div class="kc kd fm fo ke kf"><a href="https://github.com/adrianmcli/ganache-jest-example" rel="noopener  ugc nofollow" target="_blank"><div class="kg ab ej"><div class="kh ab ki cl cj kj"><h2 class="bd hv fv z el kk eo ep kl er et ht dt translated">adrianm CLI/gan ache-jest-example</h2><div class="km l"><h3 class="bd b fv z el kk eo ep kl er et ek translated">🚀使用Ganache和Jest进行最小可靠性契约测试-adrianm CLI/gan ache-Jest-example</h3></div><div class="kn l"><p class="bd b gc z el kk eo ep kl er et ek translated">github.com</p></div></div><div class="ko l"><div class="kp l kq kr ks ko kt jz kf"/></div></div></a></div><h1 id="1bd4" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">仅仅三步</h1><p id="cc88" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">本质上，你只需要做三件事:</p><ol class=""><li id="9441" class="lx ly hu it b iu iv iy iz jc lz jg ma jk mb jo mc md me mf dt translated">编写可靠性合同</li><li id="1735" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">催生一个测试“区块链”</li><li id="492a" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">部署合同。</li></ol><p id="d5ea" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">听起来很吓人，对吧？但是感谢松露和整个社区，这实际上比你想象的要简单得多。</p><h1 id="2681" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">我们的合同</h1><p id="5eef" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">在我们开始之前，让我们创建我们的合同，<code class="eh ml mm mn mo b">SimpleStorage.sol</code>:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mp mq l"/></div></figure><p id="7847" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个契约很简单，它允许你获取并设置一个整数，就是这样。</p><h1 id="5738" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">编制合同</h1><p id="bc8a" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">我们将使用<a class="ae mr" href="https://github.com/ethereum/solc-js" rel="noopener ugc nofollow" target="_blank"> solc-js </a>来编译我们的可靠性合同。这意味着我们将不得不遵循他们的做事方式，这可能会有点奇怪，所以让我们为此创建一个新文件。</p><p id="9edc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">启动一个名为<code class="eh ml mm mn mo b">compile.js</code>的新文件，并粘贴以下内容:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mp mq l"/></div></figure><p id="b9bb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们正在导出一个函数<code class="eh ml mm mn mo b">compile</code>，它将接受一个文件名，并在同一个文件夹中查找它。我们以它想要的方式传递<code class="eh ml mm mn mo b">solc</code>options对象(即<code class="eh ml mm mn mo b">input</code>)，它抛出一个JSON，我们可以从中提取工件。</p><p id="72c4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，我也有一个版本的回购使用<code class="eh ml mm mn mo b">truffle-compile</code>而不是<code class="eh ml mm mn mo b">solc</code>。这两种方式都有利弊，你可以随意做出自己的判断。</p><h1 id="4058" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">用加纳切繁殖一只试验区块链</h1><p id="41bc" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">对于这一部分和下一部分，我将首先解释这些概念，然后我将向您展示整个文件，所有这些都在这里。所以请注意，我保证会有回报的！</p><p id="2ae0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">繁殖区块链测试比我想象的要简单得多。实际上你唯一需要做的就是:</p><pre class="jq jr js jt fq ms mo mt mu aw mv dt"><span id="f54a" class="mw kv hu mo b fv mx my l mz na">// import Ganache<br/>const Ganache = require("ganache-core");</span><span id="35d0" class="mw kv hu mo b fv nb my l mz na">// spawn the test "blockchain" provider<br/>const provider = Ganache.provider();</span><span id="493f" class="mw kv hu mo b fv nb my l mz na">// use it like how you would normally use a provider<br/>const web3 = new Web3(provider);<br/>const accounts = await web3.eth.getAccounts();</span></pre><p id="d8cf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个一行程序本质上为你做了所有繁重的工作。它基本上会在内存中生成一个区块链，并给你一个<code class="eh ml mm mn mo b">provider</code>对象来与之交互。</p><p id="7743" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">从提供者那里，我们可以很容易地获得<code class="eh ml mm mn mo b">web3</code>实例，以及下一步需要的<code class="eh ml mm mn mo b">accounts</code>数组。</p><h1 id="d0a5" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">部署您的合同</h1><p id="f4fd" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">现在我们有了web3和契约工件，我们可以将它部署到我们的测试区块链上。</p><pre class="jq jr js jt fq ms mo mt mu aw mv dt"><span id="84b8" class="mw kv hu mo b fv mx my l mz na">const instance = new web3.eth.Contract(SimpleStorage.abi);</span><span id="c755" class="mw kv hu mo b fv nb my l mz na">const deployedInstance = await instance.deploy({<br/>  data: SimpleStorage.evm.bytecode.object<br/>}).send({<br/>  from: accounts[0],<br/>  gas: 150000<br/>});</span></pre><p id="e01f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是web 3 . js API(1.0版)的标准用法。我们首先通过从工件<code class="eh ml mm mn mo b">SimpleStorage.abi</code>传入ABI来创建我们的契约实例。然后，我们通过调用合同工件中的字节码<code class="eh ml mm mn mo b">.deploy()</code>来部署它，最后从我们的帐户中调用指定gas量的<code class="eh ml mm mn mo b">send()</code>来确保它通过。</p><h1 id="3b5b" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">把所有的放在一起</h1><p id="7fab" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">既然我们知道了我们需要做什么，我们可以创建一个名为<code class="eh ml mm mn mo b">test.js</code>的新文件，并开始编写我们的测试。我们谈论的大部分是为我们的测试设置环境，所以它将从Jest的<code class="eh ml mm mn mo b">beforeAll()</code>钩子下。</p><p id="5038" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我将向您展示整个文件:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mp mq l"/></div></figure><p id="05d8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，<code class="eh ml mm mn mo b">provider</code>、<code class="eh ml mm mn mo b">web3</code>、<code class="eh ml mm mn mo b">accounts</code>和<code class="eh ml mm mn mo b">contractInstance</code>变量是在<code class="eh ml mm mn mo b">beforeAll()</code>钩子之外声明的，因此我们可以在测试中使用它们。</p><p id="1d21" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们还有一个<code class="eh ml mm mn mo b">afterAll()</code>钩子，在这里我们调用提供者上的<code class="eh ml mm mn mo b">stop()</code>来防止内存泄漏。</p><p id="c427" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，实际的示例测试演示了如何设置和获取值。</p><h1 id="d649" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">一些想法</h1><p id="89a9" class="pw-post-body-paragraph ir is hu it b iu ls iw ix iy lt ja jb jc lu je jf jg lv ji jj jk lw jm jn jo hn dt translated">当然，如果你有许多不同的契约，并且它们是相互继承的，这可能会有点难以操作。对于那些用例，我会强烈推荐一个传统的块菌项目。</p><p id="8ece" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，如果您有一些简单的东西要测试，或者如果您想从您的Truffle项目中单独测试您的前端，这是一个允许您这样做的很好的选择。</p><p id="77e9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请记住，生成一个Ganache提供者需要几秒钟的时间，所以不要到处都这样做。如果你开始不得不这样做，这可能是另一个迹象，表明你应该考虑将你的项目转换为全面的松露项目。</p><p id="8b96" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这种格式可能不适合所有人，所以请务必查看您可以自己克隆和运行的示例回购！</p><div class="kc kd fm fo ke kf"><a href="https://github.com/adrianmcli/ganache-jest-example" rel="noopener  ugc nofollow" target="_blank"><div class="kg ab ej"><div class="kh ab ki cl cj kj"><h2 class="bd hv fv z el kk eo ep kl er et ht dt translated">adrianm CLI/gan ache-jest-example</h2><div class="km l"><h3 class="bd b fv z el kk eo ep kl er et ek translated">🚀使用Ganache和Jest进行最小可靠性契约测试-adrianm CLI/gan ache-Jest-example</h3></div><div class="kn l"><p class="bd b gc z el kk eo ep kl er et ek translated">github.com</p></div></div><div class="ko l"><div class="kp l kq kr ks ko kt jz kf"/></div></div></a></div><p id="c221" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你喜欢这篇文章，请给我几个掌声！</p></div></div>    
</body>
</html>