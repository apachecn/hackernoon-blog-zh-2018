# “Meltdown”CPU 漏洞的简单解释

> 原文：<https://medium.com/hackernoon/a-simplified-explanation-of-the-meltdown-cpu-vulnerability-ad316cd0f0de>

![](img/6095ac47577bcc385e9cce82f624ca5f.png)

我刚刚读了关于“Meltdown”CPU 安全漏洞的白皮书，因为我很好奇这里到底发生了什么。白皮书详细解释了这一点，但它相当长，而且是学术性的，所以我认为一个简单的概述是合适的。

[Meltdown](https://hackernoon.com/tagged/meltdown) 攻击是一种绕过许多现代 CPU 安全检查的狡猾方式，允许从未打补丁的操作系统上的任何进程读取内核模式内存。

这篇文章是关于它实际上是如何工作的——你可以在熔毁现场和其他地方阅读更多关于这些漏洞[的含义。](https://meltdownattack.com/)

首先，称这是一个“bug ”(很多人都这样认为)可能有点言过其实——CPU[的功能与广告宣传的一样。问题是有人发现了如何解读手术引起的副作用，而这些副作用本来是可以避免的。](https://hackernoon.com/tagged/cpu)

接下来的内容有点技术性，但我会尽可能简单地解释。当然，我已经掩饰了细节——这里的要点只是从概念上传达它是如何工作的。

在找到问题的真正原因之前，您需要了解几个先决条件。

## 先决条件#1 — CPU 内存缓存

CPU 缓存是 CPU 上的一块内存，用于存储最近访问的数据页面。因为这些页面被直接缓存在 CPU 上，所以对它们的访问比一直回到主内存要快。

当 CPU 从主内存中读取数据时，它会在 CPU 缓存中缓存该页面的副本。如果页面被缓存，下一次它需要从主存中读取时，它可以从更快的 CPU 上的缓存中加载值。

缓存中的每个页面有 4096 个字节，缓存足够大，可以存储许多这样的页面(取决于 CPU)

## 先决条件#2 —无序执行

每个 CPU 内核都有多个执行单元，每个执行单元都能够执行不同类型的操作。

例如:英特尔 i7 有 17 到 20 个执行单元——2 个整数运算单元、1 个除法单元、1 个加载内存单元、1 个存储内存单元等

为了让这些单元尽可能忙碌，CPU 会提前查看即将到来的指令，并开始在不同的执行单元上执行它们，同时等待当前指令完成。

*(这是一个过于简化的观点，但对于这个讨论来说已经足够了。实际上，指令被分解成微操作，这些微操作被分派给执行单元。*

## 先决条件#3 —特权模式

在任何时间点，CPU 都在特权模式或非特权模式下运行。

*   内核代码以特权模式运行，可以访问所有映射内存。
*   用户代码在非特权模式下运行，如果它试图读取或写入标记为特权的内存，将会失败并出现异常。

基本上，操作系统以特权模式运行，安装的程序以非特权模式运行。

## 问题是

如果你考虑一下上面的内容，你会发现用户态(非特权)代码不应该能够读取内核态内存，因为 CPU 会抛出一个异常。

问题在于:

1.  在指令完成之前，不会执行特权模式检查。(即:不在乱序执行期间)。
2.  即将到来的指令的无序执行会导致可以观察到的副作用。

## 它是这样工作的

首先，攻击者分配一个由 256 页内存组成的内存块(即:256 * 4096 字节)。这个内存块中的每个页面此时都不会被缓存，因为它从未被访问过。

接下来，执行类似下面的代码序列。这被称为“发送者”:

1.  执行一些会抛出异常的指令(不管是什么)
2.  从特权内存中读取一个字节。让我们称之为“秘密”
3.  将密码乘以 4096(缓存页面大小)
4.  使用相乘的值作为分配的内存块的索引，并读取一个字节(即:从第 N 页读取一个字节，其中 N 是秘密)

假设 CPU 在指令 1 完成之前开始无序执行指令 2–4，那么指令 4 将导致 CPU 上缓存一页分配的内存块。缓存的页面将与从内核模式内存中读取的字节直接相关。例如:如果秘密是 21，那么分配的内存块的第 21 页现在将被缓存在 CPU 上。

最后，“接收者”观察这种无序执行的副作用，以确定所读取的秘密字节。

1.  捕捉上面指令 1 抛出的异常。
2.  遍历分配的内存块中的每一页，然后…
3.  计时从每页读取一个字节所需的时间。
4.  如果这个字节加载得很快，那么这个页面一定已经被缓存了，并且泄露了秘密。

继续上面的例子，所分配的内存块的第 0 页到第 20 页读取起来会很慢，但是第 21 页会快得多，所以秘密值必须是 21。

现在，只要重复上面的一切，你想读取多少秘密字节。白皮书称，他们的读取速度高达 500 kb/秒。