# æˆ‘åœ¨ Android ä¸Šä½¿ç”¨ FFmpeg çš„ä½“éªŒ

> åŸæ–‡ï¼š<https://medium.com/hackernoon/android-ndk-my-experience-with-ffmpeg-93dd7e4b9269>

Android SDK ä¸ºå¼€å‘äººå‘˜æ¯å¤©ä½¿ç”¨çš„å¤§å¤šæ•°å¸¸è§å·¥ä½œæä¾›äº† APIï¼Œå¦‚`direct share`ã€`app linking`ã€`fingerprint authentication`ç­‰ç­‰ã€‚æœ‰æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å¤„ç†ä½çº§åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½å¤§å¤šä»¥ [C/C++åº“](https://ffmpeg.org/)çš„å½¢å¼æä¾›ã€‚æœ‰äº† [Android](https://hackernoon.com/tagged/android) NDKï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª C/C++åŒ…è£…å™¨æ¥ä½¿ç”¨è¿™äº›é¢„å»ºçš„åº“ï¼Œå¹¶ä½¿ç”¨ JNI ä» Kotlin/Java è°ƒç”¨æœ¬åœ°ä»£ç ã€‚

é€šè¿‡è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å°†è§£é‡Š

*   å¦‚ä½•å°†é¢„æ„å»ºçš„åº“ä¸ Android åº”ç”¨ç¨‹åº(å¦‚ FFmpeg)é›†æˆ
*   å›´ç»•é¢„æ„å»ºçš„åº“åˆ›å»ºä¸€ä¸ªåŒ…è£…å™¨ï¼Œç”¨äºæ‚¨çš„ android åº”ç”¨ç¨‹åºã€‚

å…³äº NDK åŸºç¡€çŸ¥è¯†å’Œæœ¬åœ°ä»£ç å›è°ƒçš„ä¿¡æ¯ï¼Œä½ å¯ä»¥çœ‹çœ‹æˆ‘ä»¥å‰çš„æ–‡ç« :

1.  [*å®‰å“ NDK:ä½¿ç”¨ç§‘ç‰¹æ—ç¬¬ 1 é›†â€”â€”æ¦‚å¿µ*](/fueled-android/using-android-ndk-with-kotlin-episode-1-the-concepts-bbffd69d2ea6)
2.  [*å®‰å“ NDK:ä½¿ç”¨ç§‘ç‰¹æ—ç¬¬äºŒé›†â€”â€”å›è°ƒ(ç§‘ç‰¹æ—åˆ° cpp)*](/fueled-engineering/understanding-android-ndk-with-kotlin-episode-2-callbacks-kotlin-to-cpp-e67a87d6d8c9)
3.  [*å®‰å“ NDK:ä½¿ç”¨ç§‘ç‰¹æ—ç¬¬ä¸‰é›†â€”â€”å›è°ƒç»§ç»­ã€‚*](/@iamnitishbhatt/understanding-android-ndk-with-kotlin-episode-3-callbacks-continued-bbeacf884848)

# å°† FFmpeg ä¸ Android åº”ç”¨é›†æˆ

å…¶ä¸­ä¸€ä¸ªé¡¹ç›®è¦æ±‚ä½¿ç”¨ FFmpeg è¿›è¡Œè§†é¢‘å¤„ç†ã€‚ä½œä¸ºä½¿ç”¨ FFmpeg çš„æ–°æ‰‹ï¼Œæˆ‘é‡åˆ°äº†å¤„ç†è§†é¢‘æ‰€éœ€çš„é‡æ–°å¤ç”¨ã€ä»£ç è½¬æ¢ã€é€Ÿç‡è½¬æ¢å’Œå¤§å°è½¬æ¢è¿‡ç¨‹ã€‚

# çƒ­æœ¨å…´

é‡æ–° muxing æ˜¯ä¸€ä¸ªæ— æŸè¿‡ç¨‹ï¼Œç”¨äºæ›´æ”¹ç»™å®šæ–‡ä»¶çš„å®¹å™¨æ ¼å¼(ä¾‹å¦‚ï¼Œä» mp4 åˆ° aviï¼Œåä¹‹äº¦ç„¶)ã€‚

![](img/05e6991ef9601c052117222814e730f7.png)

Remuxing

# è½¬ç 

[è½¬ç ](https://hackernoon.com/tagged/transcoding)æ˜¯å°†æ–‡ä»¶ä»ä¸€ç§ç¼–ç æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§ç¼–ç æ ¼å¼çš„è¿‡ç¨‹ï¼Œä»¥ä¾¿å¯ä»¥åœ¨ä¸åŒçš„æ’­æ”¾è®¾å¤‡ä¸Šè§‚çœ‹å†…å®¹ã€‚

![](img/27bbbe23a35fae4e0a372f15e1b3549e.png)

Transcoding

# **ç¿»è¯‘**

é€Ÿç‡è½¬æ¢æ˜¯å°†è§†é¢‘æ–‡ä»¶å’ŒéŸ³é¢‘æ–‡ä»¶è½¬æ¢ä¸ºé™ä½çš„æ¯”ç‰¹ç‡ï¼ŒåŒæ—¶ä»ä¿æŒåŸå§‹åª’ä½“æ ¼å¼çš„è¿‡ç¨‹ã€‚

# **è½¬è¿**

æ”¹å˜å¤§å°æŒ‡çš„æ˜¯æ”¹å˜è§†é¢‘çš„å›¾ç‰‡å¤§å°ï¼Œå¦‚æœè¾“å‡ºåˆ†è¾¨ç‡ä¸åŒäºåª’ä½“çš„åˆ†è¾¨ç‡ï¼Œè¿™æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚

> æ ¹æ®è¦æ±‚ï¼Œå¯ä»¥é€‰æ‹©é‡æ–°å¤ç”¨æˆ–ä»£ç è½¬æ¢ã€‚
> 
> ä¾‹å¦‚:
> 
> å°†ä¸€ç§æ ¼å¼è½¬æ¢æˆå¦ä¸€ç§æ ¼å¼â€” **é‡æ–°å¤ç”¨**
> 
> è¦è£å‰ªè§†é¢‘æˆ–æ’­æ”¾å®æ—¶æµâ€” **è½¬ç **
> 
> é™ä½æ¯”ç‰¹ç‡â€” **é€Ÿç‡è½¬æ¢**
> 
> è¦æ›´æ”¹åˆ†è¾¨ç‡â€” **æ”¹å˜å°ºå¯¸**
> 
> é€šå¸¸è¿™äº›æ–¹æ³•ç»“åˆä½¿ç”¨ä»¥è·å¾—æœŸæœ›çš„ç»“æœ

# ä¸º Android ç¼–è¯‘ FFmpeg

æ¥ä¸‹æ¥æ˜¯é‡è¦çš„éƒ¨åˆ†ï¼Œå³ç¼–è¯‘ FFmpeg æºä»£ç ï¼Œä¸º android ç”Ÿæˆåº“([äº¤å‰ç¼–è¯‘](https://en.wikipedia.org/wiki/Cross_compiler))ã€‚ä»äº‹è¿‡ä¸€äº›ç¡¬ä»¶ç›¸å…³çš„é¡¹ç›®å¯¹æˆ‘å¸®åŠ©å¾ˆå¤§ï¼Œå› ä¸ºè¿™äº›æœ¯è¯­å¯¹æˆ‘æ¥è¯´ä¸å†é™Œç”Ÿäº†ğŸ˜›ã€‚ä¸‹é¢æ˜¯æˆ‘ç”¨æ¥ç”Ÿæˆåº“çš„ä¸€äº›æ•™ç¨‹ã€‚

*   [ä¸º android ç¼–è¯‘ FFmpegã€‚](https://yesimroy.gitbooks.io/android-note/content/compile_ffmpeg_for_android.html)
*   [ä¸º android ç¼–è¯‘ X264ã€‚](https://yesimroy.gitbooks.io/android-note/content/compile_x264_for_android.html)

è¿™äº›æ•™ç¨‹å°†å¸®åŠ©ä½ è·¨è¶Šäº¤å‰ç¼–è¯‘çš„éšœç¢ã€‚

ç¼–è¯‘åï¼Œæ‚¨å°†æ‹¥æœ‰å¦‚ä¸‹æ‰€ç¤ºçš„ [ABIs](https://developer.android.com/ndk/guides/abis.html) :

![](img/e0bc6e4f9d606d9751e4a327d7811b59.png)

# FFmpeg åº“

C/C++ä¸­æœ‰ä¸¤ç§[åº“](https://stackoverflow.com/questions/2649334/difference-between-static-and-shared-libraries)

*   å…±äº«:å…±äº«åº“æ˜¯`.so`æ–‡ä»¶ã€‚ä¸è¯¥åº“ç›¸å…³çš„æ‰€æœ‰ä»£ç éƒ½åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”åœ¨è¿è¡Œæ—¶è¢«ä½¿ç”¨å®ƒçš„ç¨‹åºå¼•ç”¨ã€‚

> ä½¿ç”¨å…±äº«åº“çš„ç¨‹åºåªå¼•ç”¨å®ƒåœ¨å…±äº«åº“ä¸­ä½¿ç”¨çš„ä»£ç ã€‚

*   é™æ€:é™æ€åº“æ˜¯ã€‚a æ–‡ä»¶ã€‚æ‰€æœ‰ä¸åº“ç›¸å…³çš„ä»£ç éƒ½åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œå®ƒåœ¨ç¼–è¯‘æ—¶ç›´æ¥é“¾æ¥åˆ°ç¨‹åºä¸­ã€‚

> ä½¿ç”¨é™æ€åº“çš„ç¨‹åºä»é™æ€åº“ä¸­å¤åˆ¶å®ƒæ‰€ä½¿ç”¨çš„ä»£ç ï¼Œå¹¶ä½¿å…¶æˆä¸ºç¨‹åºçš„ä¸€éƒ¨åˆ†ã€‚

FFmpeg åŒ…å«ä¸€ç»„å¯ç”¨äºä¸åŒæ“ä½œçš„å…±äº«åº“:

*   `[libavcodec](https://www.ffmpeg.org/libavcodec.html)`:æä¾›é€šç”¨ç¼–ç /è§£ç æ¡†æ¶ï¼ŒåŒ…å«å¤šä¸ªç”¨äºéŸ³é¢‘ã€è§†é¢‘å’Œå­—å¹•æµçš„è§£ç å™¨å’Œç¼–ç å™¨ï¼Œä»¥åŠå‡ ä¸ªæ¯”ç‰¹æµè¿‡æ»¤å™¨ã€‚
*   `[libavutil](https://www.ffmpeg.org/libavutil.html)`:æ˜¯ä¸€ä¸ªå¸®åŠ©ä¾¿æºå¼å¤šåª’ä½“ç¼–ç¨‹çš„å®ç”¨ç¨‹åºåº“ã€‚
*   `[libavformat](https://www.ffmpeg.org/libavformat.html)`:ä¸ºéŸ³é¢‘ã€è§†é¢‘å’Œå­—å¹•æµçš„å¤ç”¨å’Œè§£å¤ç”¨(å¤ç”¨å’Œè§£å¤ç”¨)æä¾›é€šç”¨æ¡†æ¶ã€‚
*   `[libavdevice](https://www.ffmpeg.org/libavdevice.html)`:æä¾›ä¸€ä¸ªé€šç”¨æ¡†æ¶ï¼Œç”¨äºä»è®¸å¤šå¸¸è§çš„å¤šåª’ä½“è¾“å…¥/è¾“å‡ºè®¾å¤‡ä¸­æŠ“å–å’Œæ¸²æŸ“ï¼Œå¹¶æ”¯æŒå¤šç§è¾“å…¥å’Œè¾“å‡ºè®¾å¤‡ï¼ŒåŒ…æ‹¬ Video4Linux2ã€VfWã€DShow å’Œ ALSAã€‚
*   `[libavfilter](https://www.ffmpeg.org/libavfilter.html)`:æä¾›ä¸€ä¸ªé€šç”¨çš„éŸ³é¢‘/è§†é¢‘è¿‡æ»¤æ¡†æ¶ï¼ŒåŒ…å«å‡ ä¸ªè¿‡æ»¤å™¨ã€æºå’Œæ¥æ”¶å™¨ã€‚
*   `[libavresample](https://www.ffmpeg.org/doxygen/2.5/group__lavr.html)`:æ˜¯ä¸€ä¸ªå¤„ç†éŸ³é¢‘é‡é‡‡æ ·ã€æ ·æœ¬æ ¼å¼è½¬æ¢å’Œæ··éŸ³çš„åº“ã€‚
*   `[libswscale](https://www.ffmpeg.org/libswscale.html)`:è¯¥åº“æ‰§è¡Œé«˜åº¦ä¼˜åŒ–çš„å›¾åƒç¼©æ”¾ã€è‰²å½©ç©ºé—´å’Œåƒç´ æ ¼å¼è½¬æ¢æ“ä½œã€‚
*   `[libswresample](https://www.ffmpeg.org/libswresample.html)`:è¿™ä¸ªåº“æ‰§è¡Œé«˜åº¦ä¼˜åŒ–çš„éŸ³é¢‘é‡é‡‡æ ·ã€é‡æ··éŸ³å’Œæ ·æœ¬æ ¼å¼è½¬æ¢æ“ä½œã€‚
*   `libpostproc`:æ˜¯ç”¨äºè½¬ç çš„åå¤„ç†åº“ã€‚

> æ ¹æ®é¡¹ç›®éœ€æ±‚ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©éœ€è¦é›†æˆåˆ°é¡¹ç›®ä¸­çš„åº“ã€‚

# å°†ç¼–è¯‘åçš„åº“æ·»åŠ åˆ°é¡¹ç›®ä¸­

æ ¹æ®éœ€è¦ï¼Œæ‚¨å¯ä»¥å°†åº“åŒ…å«åœ¨ JNI æ–‡ä»¶å¤¹ä¸‹ï¼Œå¦‚ä¸‹æ‰€ç¤º:

![](img/a18d23aaf823f6d3d861fc45d27fdeef.png)

Adding Shared Libs and header files to project

Adding the path of shared libs and abifilters in the Gradle file

å°†æ­¤æ·»åŠ åˆ° CMakeLists.txt æ–‡ä»¶ä¸­

Importing required libraries

Linking pre-built libraries

# åˆ›å»ºä½¿ç”¨åº“çš„åŒ…è£…å™¨

ç”±äºæˆ‘ä»¬å·²ç»å°† FFmpeg åº“æ·»åŠ åˆ°é¡¹ç›®ä¸­ï¼Œå¹¶ä½¿ç”¨`target_link_libraries`å°†`JNIFunctions.cpp`é“¾æ¥åˆ° FFmpeg åº“ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥é€šè¿‡åœ¨* `.h`ä¸­åŒ…å«å¤´æ–‡ä»¶æ¥ä½¿ç”¨åº“ä¸­å¯ç”¨çš„å‡½æ•°ã€‚

Include the header files required in the project

ä»¥ä¸‹æ˜¯ä» RTSP é¦ˆé€ä¸­è·å– SPS(åºåˆ—å‚æ•°é›†)å¸§çš„å‡½æ•°ä¹‹ä¸€:

# ç»“è®º

FFmpeg æ˜¯ä¸€ä¸ªéå¸¸æ£’çš„ç”¨äº A/V å¤„ç†çš„åº“ã€‚æˆ‘ä»¬å¯ä»¥æ‰§è¡Œè§£å¤ç”¨ã€æ˜¾ç¤ºçŸ©é˜µæ—‹è½¬ã€è§†é¢‘è£å‰ªã€åˆå¹¶éŸ³é¢‘å’Œè§†é¢‘æµç­‰ã€‚æœ‰å¾ˆå¤š[å¼€æº](https://trac.ffmpeg.org/wiki/Projects)é¡¹ç›®ä½¿ç”¨ FFmpeg åº“ã€‚è¯·åŠ¡å¿…é˜…è¯»å®ƒä»¬ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚

# å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œç‚¹å‡»ğŸ‘ã€‚ç‰¹åˆ«æ„Ÿè°¢æˆ‘çš„æœ‹å‹å…¼åŒäº‹ [Arun Sasidharan](https://medium.com/u/40499e50fc3b?source=post_page-----93dd7e4b9269--------------------------------) å‚¬æˆ‘å†™è¿™ç¯‡æ–‡ç« ã€‚

æŠ“æˆ‘è¿™é‡Œ:
*æ¨ç‰¹:*[*@ iamnitishbhatt*](https://twitter.com/initishbhatt) *é¢†è‹±:*[*https://www.linkedin.com/in/iamnitishbhatt/*](https://www.linkedin.com/in/iamnitishbhatt/) **Github:*[https://github.com/initishbhatt](https://github.com/initishbhatt)*