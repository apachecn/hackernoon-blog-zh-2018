# é€šè¿‡æ„å»ºä¸€ä¸ªç±»ä¼¼ Redux çš„åº“æ¥ç†è§£ JavaScript ä¸­çš„çŠ¶æ€ç®¡ç†

> åŸæ–‡ï¼š<https://medium.com/hackernoon/building-a-redux-like-state-manager-for-react-cd75cc2853b3>

> å¯¹äºä»»ä½•æƒ³è·³è¿‡è¿™ç¯‡æ–‡ç« å¹¶çœ‹åˆ°æœ€ç»ˆç»“æœçš„äººæ¥è¯´ï¼Œæˆ‘å·²ç»æŠŠæˆ‘å†™åœ¨è¿™é‡Œçš„ä¸œè¥¿ç”¨é’©å­åšäº†ä¸€ä¸ªåº“: [use-simple-state](https://github.com/Jahans3/use-simple-state) ã€‚å®ƒæ²¡æœ‰ä¾èµ–æ€§(é™¤äº†ååº”ä¸ºå¯¹ç­‰ä¾èµ–æ€§ä¹‹å¤–),åªæœ‰ 3kbï¼Œéå¸¸è½»é‡çº§ã€‚

è¿‘å¹´æ¥ï¼Œweb åº”ç”¨ç¨‹åºçš„èŒƒå›´æ€¥å‰§æ‰©å¤§ï¼Œéšç€åº”ç”¨ç¨‹åºéœ€æ±‚çš„å¢é•¿ï¼Œå¤æ‚æ€§ä¹Ÿåœ¨å¢åŠ ã€‚ä¸ºäº†ä½¿è¿™ç§å¢åŠ çš„å¤æ‚æ€§æ›´å®¹æ˜“å¤„ç†ï¼ŒæŸäº›æŠ€æœ¯å’Œæ¨¡å¼è¶Šæ¥è¶Šå¤šåœ°è¢«ç”¨æ¥ä½¿å¼€å‘äººå‘˜çš„ç”Ÿæ´»æ›´å®¹æ˜“ï¼Œå¹¶å¸®åŠ©æˆ‘ä»¬æ„å»ºæ›´å¥å£®çš„åº”ç”¨ç¨‹åºã€‚

å¤æ‚æ€§å¢åŠ çš„ä¸€ä¸ªä¸»è¦é¢†åŸŸæ˜¯ç®¡ç†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œå› æ­¤ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼€å‘äººå‘˜æ­£åœ¨ä½¿ç”¨æä¾›æŠ½è±¡çš„åº“æ¥æ›´æ–°å’Œè®¿é—®ä»–ä»¬çš„åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€‚æœ€è‘—åçš„ä¾‹å­æ˜¯ [Redux](https://redux.js.org/introduction) ï¼Œå®ƒæ˜¯[é€šé‡æ¨¡å¼](https://facebook.github.io/flux/docs/in-depth-overview.html#content)çš„ä¸€ç§å®ç°ã€‚

ä¸€æ—¦å¼€å‘äººå‘˜å­¦ä¼šäº†å¦‚ä½•ä½¿ç”¨åƒ Redux è¿™æ ·çš„åº“ï¼Œä»–ä»¬å¯èƒ½ä»ç„¶æƒ³çŸ¥é“â€œå¼•æ“ç›–ä¸‹â€çš„ä¸€åˆ‡ç©¶ç«Ÿæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå› ä¸ºè¿™ä¸€å¼€å§‹å¹¶ä¸æ˜æ˜¾ï¼Œå³ä½¿æ›´æ–°å…¨å±€å¯ç”¨å¯¹è±¡çš„æ›´ä¸€èˆ¬çš„æ¦‚å¿µå¾ˆå®¹æ˜“ç†è§£ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å®Œå…¨ä»é›¶å¼€å§‹ä¸º React åº”ç”¨ç¨‹åºæ„å»ºè‡ªå·±çš„çŠ¶æ€ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚æˆ‘ä»¬å°†ä»ä¸€ä¸ªåªéœ€å‡ è¡Œä»£ç å°±èƒ½å®ç°çš„åŸºæœ¬è§£å†³æ–¹æ¡ˆå¼€å§‹ï¼Œç„¶åé€æ­¥å¼€å‘æ›´é«˜çº§çš„åŠŸèƒ½ï¼Œç›´åˆ°æˆ‘ä»¬æœ‰äº†ç±»ä¼¼ Redux çš„ä¸œè¥¿ã€‚

# åŸºæœ¬æ€æƒ³

ä»»ä½•çŠ¶æ€ç®¡ç†å·¥å…·åªéœ€è¦å‡ æ ·ä¸œè¥¿:å¯¹æ•´ä¸ªåº”ç”¨ç¨‹åºå¯ç”¨çš„å…¨å±€çŠ¶æ€å€¼ï¼Œä»¥åŠè¯»å–å’Œæ›´æ–°å®ƒçš„èƒ½åŠ›ã€‚å°±è¿™æ ·ï¼Œè¯´çœŸçš„ã€‚

ä¸ºäº†å‘æ‚¨å±•ç¤ºçŠ¶æ€ç®¡ç†å™¨æœ‰å¤šç®€å•ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªåŸºæœ¬çš„ JavaScript å®ç°:

Thatâ€™s it, seriously

ä¸Šé¢çš„ä¾‹å­æ˜¯æœ€åŸºæœ¬çš„ï¼Œä½†å®ƒä»ç„¶ç¬¦åˆæ‰€æœ‰çš„æƒ…å†µ:

*   ä»£è¡¨æˆ‘ä»¬åº”ç”¨ç¨‹åºçŠ¶æ€çš„å…¨å±€å¯ç”¨å€¼:`state`
*   è¯»å–æˆ‘ä»¬çŠ¶æ€çš„èƒ½åŠ›:`getState`
*   èƒ½å¤Ÿæ›´æ–°æˆ‘ä»¬çš„çŠ¶æ€:`setState`

å¯¹äºå¤§å¤šæ•°ç°å®ä¸–ç•Œçš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œä¸Šé¢çš„ä¾‹å­å¤ªç®€å•äº†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å°†å¼€å§‹å®ç°ä¸€ä¸ªåœ¨ React åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„å¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚æˆ‘ä»¬å°†ä»é‡æ„å‰é¢çš„ä¾‹å­å¼€å§‹ï¼Œè®©å®ƒåœ¨ React ä¸­å·¥ä½œï¼Œå¹¶ä»é‚£é‡Œå¼€å§‹æ„å»ºã€‚

# React ä¸­çš„çŠ¶æ€ç®¡ç†

ä¸ºäº†åˆ¶ä½œæˆ‘ä»¬ä¹‹å‰è§£å†³æ–¹æ¡ˆçš„åŸºäº React çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨ä¸¤ä¸ª React ç‰¹æ€§ã€‚ç¬¬ä¸€ä¸ªç‰¹å¾æ˜¯æ™®é€šçš„æ—§ç±»ç»„ä»¶ï¼Œä¹Ÿç§°ä¸º[æœ‰çŠ¶æ€ç»„ä»¶](https://reactjs.org/docs/state-and-lifecycle.html#adding-local-state-to-a-class)ã€‚

ç¬¬äºŒä¸ªç‰¹æ€§æ˜¯[ä¸Šä¸‹æ–‡ API](https://reactjs.org/docs/context.html) ï¼Œå®ƒç”¨äºä½¿æ•°æ®å¯¹æ•´ä¸ª React åº”ç”¨ç¨‹åºå¯ç”¨ã€‚ä¸€ä¸ªä¸Šä¸‹æ–‡æœ‰ä¸¤éƒ¨åˆ†:ä¸€ä¸ª*æä¾›è€…*å’Œä¸€ä¸ª*æ¶ˆè´¹è€…*ã€‚é¡¾åæ€ä¹‰ï¼Œæä¾›è€…å‘åº”ç”¨ç¨‹åºæä¾›*ä¸Šä¸‹æ–‡*(æ•°æ®)ã€‚è€Œå½“æˆ‘ä»¬æƒ³è¦è®¿é—®ä¸Šä¸‹æ–‡æ—¶ä½¿ç”¨æ¶ˆè´¹è€…ã€‚

ç†è§£ä¸Šä¸‹æ–‡çš„ä¸€ä¸ªå¥½æ–¹æ³•æ˜¯:å¦‚æœ*é“å…·*ç”¨äº**æ˜¾å¼åœ°**é€šè¿‡ä½ çš„ç»„ä»¶ä¼ é€’æ•°æ®ï¼Œé‚£ä¹ˆ*ä¸Šä¸‹æ–‡*ç”¨äº**éšå¼åœ°**ä¼ é€’æ•°æ®ã€‚

# æ„å»ºæˆ‘ä»¬çš„çŠ¶æ€ç®¡ç†å™¨

ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†æˆ‘ä»¬æƒ³è¦ä½¿ç”¨çš„å·¥å…·ï¼Œåªæ˜¯æŠŠå®ƒä»¬æ”¾åœ¨ä¸€èµ·çš„é—®é¢˜ã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡æ¥ä¿å­˜æˆ‘ä»¬çš„å…¨å±€çŠ¶æ€ï¼Œç„¶åå°†è¯¥ä¸Šä¸‹æ–‡çš„*æä¾›è€…*åŒ…è£…åœ¨ä¸€ä¸ª*æœ‰çŠ¶æ€ç»„ä»¶*ä¸­ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥ç®¡ç†çŠ¶æ€ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä½¿ç”¨`React.createContext`æ¥åˆ›å»ºæˆ‘ä»¬çš„ä¸Šä¸‹æ–‡ï¼Œè¿™ç»™äº†æˆ‘ä»¬`Provider`å’Œ`Consumer`:

Baby steps

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„`Provider`åŒ…è£…åœ¨ä¸€ä¸ª*æœ‰çŠ¶æ€ç»„ä»¶*ä¸­ï¼Œä»¥ä¾¿åˆ©ç”¨å®ƒæ¥ç®¡ç†æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€‚æˆ‘ä»¬è¿˜æƒ³å¯¼å‡ºå…·æœ‰æ›´å…·ä½“åç§°çš„*æ¶ˆè´¹è€…*:

So far so good

åœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„`StateProvider`åªæ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒæ¥å—ä¸€ä¸ª`state`é“å…·ä½œä¸ºåˆå§‹çŠ¶æ€ï¼Œå¹¶ä½¿è¯¥é“å…·ä¸­åŒ…å«çš„ä»»ä½•å†…å®¹å¯¹ç»„ä»¶æ ‘ä¸­å®ƒä¸‹é¢çš„ä»»ä½•ç»„ä»¶éƒ½å¯ç”¨ã€‚å¦‚æœæ²¡æœ‰æä¾›`state`ï¼Œåˆ™ä½¿ç”¨ç©ºå¯¹è±¡ã€‚

ä½¿ç”¨æˆ‘ä»¬çš„`StateProvider`å°±åƒå°†å®ƒåŒ…è£…åœ¨åº”ç”¨ç¨‹åºçš„æ ¹ç»„ä»¶ä¸Šä¸€æ ·ç®€å•:

Simples

ç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¶ˆè´¹è€…ä»`MyApp`å†…éƒ¨çš„ä»»ä½•åœ°æ–¹è®¿é—®æˆ‘ä»¬çš„çŠ¶æ€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿå·²ç»åˆå§‹åŒ–äº†æˆ‘ä»¬çš„çŠ¶æ€ï¼Œä½¿ä¹‹æˆä¸ºä¸€ä¸ªåªæœ‰ä¸€ä¸ªå±æ€§çš„å¯¹è±¡:`count`ï¼Œæ‰€ä»¥æ— è®ºä½•æ—¶æˆ‘ä»¬è®¿é—®æˆ‘ä»¬çš„çŠ¶æ€ï¼Œæˆ‘ä»¬éƒ½ä¼šå‘ç°ã€‚

æ¶ˆè´¹è€…ä½¿ç”¨[æ¸²æŸ“é“å…·](https://reactjs.org/docs/render-props.html)æ¥ä¼ é€’ä¸Šä¸‹æ–‡æ•°æ®ï¼Œè¿™å¯ä»¥åœ¨ä¸‹é¢çœ‹åˆ°ï¼Œå…¶ä¸­ä¸€ä¸ªå‡½æ•°æ˜¯`StateConsumer`çš„å­å‡½æ•°ã€‚ä¼ é€’ç»™è¯¥å‡½æ•°çš„`state`å‚æ•°è¡¨ç¤ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„å½“å‰çŠ¶æ€ï¼Œå› æ­¤æ ¹æ®æˆ‘ä»¬çš„`initialState` , `state.count`å°†ç­‰äº`0`ã€‚

Accessing our appâ€™s state

å…³äºæˆ‘ä»¬çš„`StateConsumer`éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå®ƒè‡ªåŠ¨è®¢é˜…ä¸Šä¸‹æ–‡ä¸­çš„å˜åŒ–ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬çš„çŠ¶æ€æ”¹å˜æ—¶ï¼Œç»„ä»¶å°†é‡æ–°å‘ˆç°ä»¥æ˜¾ç¤ºæ›´æ–°ã€‚è¿™åªæ˜¯æ¶ˆè´¹è€…çš„é»˜è®¤è¡Œä¸ºï¼Œæˆ‘ä»¬æ²¡æœ‰åšä»»ä½•äº‹æƒ…æ¥å¯ç”¨å®ƒã€‚

# æ›´æ–°çŠ¶æ€

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»æ„å»ºäº†ä¸€äº›ä¸œè¥¿ï¼Œå…è®¸æˆ‘ä»¬è¯»å–æˆ‘ä»¬çš„çŠ¶æ€ï¼Œå¹¶åœ¨å®ƒæ”¹å˜æ—¶è‡ªåŠ¨æ›´æ–°ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥æ›´æ–°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œä¸ºæ­¤æˆ‘ä»¬åªéœ€åœ¨æˆ‘ä»¬çš„`StateProvider`ä¸­æ›´æ–°çŠ¶æ€ã€‚

æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªåä¸º`state`çš„é“å…·ä¼ é€’ç»™äº†æˆ‘ä»¬çš„`StateProvider`ï¼Œç„¶åè¿™ä¸ªé“å…·åˆè¢«ä¼ é€’ç»™äº†*ç»„ä»¶çš„* `state`å±æ€§ã€‚è¿™æ˜¯æˆ‘ä»¬å°†ä½¿ç”¨ React å†…ç½®çš„`this.setState`æ–¹æ³•æ›´æ–°çš„å†…å®¹:

ç»§ç»­ä¿æŒç®€å•çš„ä¸»é¢˜ï¼Œæˆ‘ä»¬åˆšåˆšå°†`this.setState`ä¼ é€’åˆ°æˆ‘ä»¬çš„ä¸Šä¸‹æ–‡ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¿…é¡»ç¨å¾®æ”¹å˜ä¸Šä¸‹æ–‡çš„å€¼ï¼›æˆ‘ä»¬ç°åœ¨ä¸æ˜¯åªä¼ é€’`this.state`è€Œæ˜¯ä¼ é€’ä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªå±æ€§çš„å¯¹è±¡:`state`å’Œ`setState`ã€‚

æ¯å½“æˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬çš„`StateConsumer`æ—¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª[ææ„èµ‹å€¼](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment)æ¥è·å–`state`å’Œ`setState`ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬å¯ä»¥è¯»å–å’Œå†™å…¥æˆ‘ä»¬çš„çŠ¶æ€å¯¹è±¡:

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæˆ‘ä»¬åªæ˜¯ç®€å•åœ°å°† React çš„å†…ç½®`this.setState`æ–¹æ³•ä½œä¸ºæˆ‘ä»¬çš„`setState`å‡½æ•°ï¼Œé¢å¤–çš„å±æ€§å°†ä¸ç°æœ‰çŠ¶æ€åˆå¹¶ã€‚è¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬é™¤äº†`count`ä¹‹å¤–è¿˜æœ‰ç¬¬äºŒä¸ªå±æ€§ï¼Œé‚£ä¹ˆå®ƒå°†è¢«è‡ªåŠ¨ä¿ç•™ã€‚

ç°åœ¨æˆ‘ä»¬å·²ç»å»ºç«‹äº†ä¸€äº›*å¯ä»¥*åœ¨ç°å®ä¸–ç•Œä¸­å·¥ä½œçš„ä¸œè¥¿(å°½ç®¡ä¸æ˜¯å¾ˆæœ‰æ•ˆ)ã€‚å®ƒæœ‰ä¸€ä¸ªç®€å•çš„ APIï¼ŒReact å¼€å‘äººå‘˜åº”è¯¥å¾ˆç†Ÿæ‚‰ï¼Œå¦å¤–å®ƒåˆ©ç”¨äº†å†…ç½®å·¥å…·ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿæ²¡æœ‰æ·»åŠ ä»»ä½•æ–°çš„ä¾èµ–é¡¹ã€‚å¦‚æœçŠ¶æ€ç®¡ç†åº“ä»¥å‰æ„Ÿè§‰æœ‰ç‚¹â€œç¥å¥‡â€ï¼Œå¸Œæœ›æˆ‘ä»¬å·²ç»èƒ½å¤Ÿæ­ç¤ºä¸€ä¸ªåº“çš„å†…éƒ¨å¯èƒ½æ˜¯ä»€ä¹ˆæ ·å­ã€‚

# é™„åŠ ç‰©

é‚£äº›å·²ç»ç†Ÿæ‚‰ Redux çš„äººå¯èƒ½å·²ç»æ³¨æ„åˆ°æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆåœ¨å‡ ä¸ªæ–¹é¢æœ‰æ‰€æ¬ ç¼º:

*   å®ƒæ²¡æœ‰å¤„ç†å‰¯ä½œç”¨çš„å†…ç½®æ–¹å¼ï¼Œä½ å¯ä»¥é€šè¿‡ [Redux ä¸­é—´ä»¶](https://redux.js.org/advanced/middleware)è·å¾—åŠŸèƒ½ã€‚
*   å½“ä¸æˆ‘ä»¬çš„`setState`å‡½æ•°å†…è”ç¼–å†™æ—¶ï¼Œå¤æ‚çš„çŠ¶æ€æ›´æ–°ä¼šå¾ˆæ··ä¹±ï¼Œæˆ‘ä»¬ä¾èµ– React çš„é»˜è®¤`this.setState`è¡Œä¸ºæ¥å¤„ç†æˆ‘ä»¬çš„çŠ¶æ€æ›´æ–°é€»è¾‘ï¼Œä¹Ÿæ²¡æœ‰é‡ç”¨çŠ¶æ€æ›´æ–°çš„å†…ç½®æ–¹å¼ï¼Œè¿™æ˜¯ä»[Redux reducer](https://redux.js.org/basics/reducers)è·å¾—çš„ã€‚
*   æˆ‘ä»¬ä¹Ÿæ— æ³•å¤„ç†[å¼‚æ­¥åŠ¨ä½œ](https://redux.js.org/advanced/asyncactions)ï¼Œè¿™é€šå¸¸æ˜¯ç”±åƒ [Redux Thunk](https://github.com/reduxjs/redux-thunk) å’Œ [Redux Saga](https://github.com/redux-saga/redux-saga) è¿™æ ·çš„åº“æä¾›çš„ã€‚
*   é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•è®©æˆ‘ä»¬çš„æ¶ˆè´¹è€…è®¢é˜…çŠ¶æ€çš„*éƒ¨åˆ†*ï¼Œè¿™æ„å‘³ç€å½“æˆ‘ä»¬çŠ¶æ€çš„ä»»ä½•éƒ¨åˆ†æ›´æ–°æ—¶ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…éƒ½å°†é‡æ–°å‘ˆç°ã€‚

ä¸ºäº†å…‹æœè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†é€šè¿‡å®ç°æˆ‘ä»¬è‡ªå·±çš„åŠ¨ä½œã€reducers å’Œä¸­é—´ä»¶æ¥æ¨¡æ‹Ÿ Reduxã€‚æˆ‘ä»¬è¿˜å°†æ·»åŠ å¯¹å¼‚æ­¥æ“ä½œçš„å†…ç½®æ”¯æŒã€‚ä¹‹åï¼Œæˆ‘ä»¬å°†ä¸ºæˆ‘ä»¬çš„æ¶ˆè´¹è€…å®ç°ä¸€ç§æ–¹æ³•ï¼Œåªç›‘å¬æˆ‘ä»¬çŠ¶æ€å­é›†çš„å˜åŒ–ã€‚æœ€åï¼Œæˆ‘ä»¬è¿˜å°†çœ‹çœ‹å¦‚ä½•é‡æ„æˆ‘ä»¬çš„ä»£ç ï¼Œå› æ­¤æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨å…¨æ–°çš„ [Hooks API](https://reactjs.org/docs/hooks-intro.html) ã€‚

# Redux ç®€ä»‹

> å…è´£å£°æ˜:ä¸‹é¢çš„å†…å®¹åªæ˜¯ä¸ºäº†ç»™ä½ è¶³å¤Ÿçš„ç†è§£æ¥ç»§ç»­è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å¼ºçƒˆæ¨èé˜…è¯» Redux çš„å®˜æ–¹ä»‹ç»ä»¥è·å¾—æ›´å…¨é¢çš„è§£é‡Šã€‚
> 
> å¦‚æœæ‚¨å·²ç»å¯¹ Redux æœ‰äº†å¾ˆå¥½çš„äº†è§£ï¼Œå¯ä»¥è·³è¿‡è¿™ä¸€ç‚¹ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ª Redux åº”ç”¨ç¨‹åºä¸­æ•°æ®æµçš„ç®€åŒ–å›¾:

![](img/4a42c5209365f82d8f47ea400c8b9dc3.png)

Redux data flow

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œæœ‰ä¸€ä¸ª*å•å‘*æ•°æ®æµâ€”â€”æˆ‘ä»¬*åˆ†æ´¾*ä¸€ä¸ªåŠ¨ä½œï¼Œæˆ‘ä»¬çš„ reducers ä»è¿™ä¸ªåŠ¨ä½œä¸­è·å¾—ä¸€ä¸ªæ›´æ–°çš„çŠ¶æ€ï¼Œæ²¡æœ‰æ•°æ®åœ¨æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†ä¹‹é—´æ¥å›ä¼ è¾“ã€‚

æ›´è¯¦ç»†åœ°è¯´:

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ†æ´¾ä¸€ä¸ªåŠ¨ä½œï¼Œè¯¥åŠ¨ä½œæè¿°äº†å¯¹æˆ‘ä»¬çŠ¶æ€çš„ä¸€ä¸ªæ”¹å˜ï¼Œä¾‹å¦‚å°†ä¸€ä¸ªæ•°å­—åŠ  1ã€‚ä¸æˆ‘ä»¬ä¹‹å‰çš„æ–¹æ³•ç›¸æ¯”ï¼Œè¿™ç§æ–¹æ³•æ›´æœ‰å‘½ä»¤æ€§ï¼Œæˆ‘ä»¬æœ¬è´¨ä¸Šæ˜¯ç›´æ¥æ“çºµ`count`çŠ¶æ€:`setState({ count: count + 1 })`ã€‚

ç„¶ååŠ¨ä½œé€šè¿‡æˆ‘ä»¬çš„*ä¸­é—´ä»¶ã€‚* Redux ä¸­é—´ä»¶æ˜¯å¯é€‰åŠŸèƒ½ï¼Œå¯ä»¥æ‰§è¡ŒåŠ¨ä½œçš„å‰¯ä½œç”¨ï¼Œä¾‹å¦‚ï¼Œå¦‚æœè°ƒåº¦äº†ä¸€ä¸ª`SIGN_OUT`åŠ¨ä½œï¼Œæ‚¨å¯ä»¥åœ¨å°†åŠ¨ä½œä¼ é€’ç»™ reducer ä¹‹å‰ï¼Œä½¿ç”¨ä¸­é—´ä»¶åŠŸèƒ½ä»æœ¬åœ°å­˜å‚¨ä¸­åˆ é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®ã€‚å¦‚æœä½ ç†Ÿæ‚‰ [Express](https://expressjs.com/) ä¸­çš„ä¸­é—´ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ç›¸ä¼¼çš„æ¦‚å¿µã€‚

æœ€åï¼Œæˆ‘ä»¬çš„åŠ¨ä½œåˆ°è¾¾é‡‡å–åŠ¨ä½œçš„ reducersï¼Œä»¥åŠä»»ä½•é™„å¸¦çš„æ•°æ®ï¼Œå¹¶ä½¿ç”¨è¯¥æ•°æ®åŠ ä¸Šç°æœ‰çŠ¶æ€æ¥æ´¾ç”Ÿæ–°çš„çŠ¶æ€ã€‚å‡è®¾æˆ‘ä»¬*å‘é€*ä¸€ä¸ªåä¸º`ADD`çš„åŠ¨ä½œï¼Œå¹¶ä¸”æˆ‘ä»¬è¿˜å‘é€ä¸€ä¸ªä¼´éšå€¼(åä¸º*æœ‰æ•ˆè½½è·*)ï¼Œè¿™æ˜¯æˆ‘ä»¬å¸Œæœ›æ·»åŠ åˆ°çŠ¶æ€ä¸­çš„æ•°é‡ã€‚æˆ‘ä»¬çš„ reducer å°†æ£€æŸ¥ä¸€ä¸ª`ADD`åŠ¨ä½œï¼Œå½“å®ƒå‘ç°ä¸€ä¸ªåŠ¨ä½œæ—¶ï¼Œå®ƒå°†è·å–*æœ‰æ•ˆè´Ÿè½½*ä»¥åŠæˆ‘ä»¬çŠ¶æ€ä¸­çš„å½“å‰å€¼ï¼Œå¹¶å°†ä¸¤è€…ç›¸åŠ ä»¥äº§ç”Ÿæˆ‘ä»¬çš„æ›´æ–°çŠ¶æ€ã€‚

å‡é€Ÿå™¨çš„åŠŸèƒ½ç‰¹å¾å¦‚ä¸‹:

```
(state, action) => nextState
```

ä¸€ä¸ªç¼©å‡å™¨åº”è¯¥åªæ˜¯ä¸€ä¸ª`state`å’Œ`action.`çš„å‡½æ•°ã€‚API ç®€å•è€Œå¼ºå¤§ã€‚éœ€è¦æ³¨æ„çš„ä¸€ä¸ªå…³é”®ç‚¹æ˜¯ï¼Œå½’çº¦å™¨åº”è¯¥æ€»æ˜¯[çº¯å‡½æ•°](https://en.wikipedia.org/wiki/Pure_function)ï¼Œè¿™æ ·å®ƒä»¬å°±æ€»æ˜¯ç¡®å®šçš„ã€‚

# è¡ŒåŠ¨+æ´¾é£

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»ç®€è¦ä»‹ç»äº† Redux åº”ç”¨ç¨‹åºçš„ä¸€äº›å…³é”®éƒ¨åˆ†ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ¥æ¨¡æ‹Ÿç›¸åŒçš„è¡Œä¸ºã€‚é¦–å…ˆ:æˆ‘ä»¬éœ€è¦ä¸€äº›åŠ¨ä½œå’Œä¸€ç§è°ƒåº¦å®ƒä»¬çš„æ–¹æ³•ã€‚

å¯¹äºæˆ‘ä»¬çš„åŠ¨ä½œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åŠ¨ä½œåˆ›å»ºå™¨ï¼Œè¿™äº›åªæ˜¯åˆ›å»ºåŠ¨ä½œçš„å‡½æ•°ã€‚åŠ¨ä½œåˆ›å»ºè€…ä½¿å¾—æµ‹è¯•ã€é‡ç”¨å’Œä¼ é€’æœ‰æ•ˆè´Ÿè½½åˆ°æˆ‘ä»¬çš„åŠ¨ä½œå˜å¾—æ›´åŠ å®¹æ˜“ã€‚æˆ‘ä»¬è¿˜å°†åˆ›å»ºä¸€äº›åŠ¨ä½œç±»å‹ï¼Œè¿™äº›åªæ˜¯å­—ç¬¦ä¸²å¸¸é‡ï¼Œå› ä¸ºå®ƒä»¬å°†åœ¨æˆ‘ä»¬çš„ reducers ä¸­é‡ç”¨ï¼Œæˆ‘ä»¬å°†å®ƒä»¬å­˜å‚¨åœ¨å˜é‡ä¸­:

So far, so good

ç°åœ¨ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªå ä½ç¬¦`dispatch`å‡½æ•°ã€‚æˆ‘ä»¬çš„å ä½ç¬¦å°†åªæ˜¯ä¸€ä¸ªç©ºå‡½æ•°ï¼Œæˆ‘ä»¬å°†ç”¨å®ƒæ¥æ›¿æ¢æˆ‘ä»¬ä¸Šä¸‹æ–‡ä¸­çš„`setState`å‡½æ•°ã€‚æˆ‘ä»¬ä¸€ä¼šå„¿å°†å›åˆ°è¿™ä¸€ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ä»»ä½• reducers æ¥åˆ†æ´¾æˆ‘ä»¬çš„åŠ¨ä½œã€‚

# è¿˜åŸå‰‚

ç°åœ¨æˆ‘ä»¬æœ‰äº†åŠ¨ä½œï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€äº› reducers æ¥å‘é€å®ƒä»¬ã€‚å›æƒ³ä¸€ä¸‹ reducer å‡½æ•°ç­¾åï¼Œå®ƒåªæ˜¯ä¸€ä¸ªçº¯ç²¹çš„åŠ¨ä½œå’ŒçŠ¶æ€å‡½æ•°:

```
(state, action) => nextState
```

çŸ¥é“äº†è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯å°†ç»„ä»¶çš„çŠ¶æ€å’Œåˆ†æ´¾çš„åŠ¨ä½œä¼ é€’ç»™æˆ‘ä»¬çš„ reducersã€‚å¯¹äº reducersï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€ç»„ç¬¦åˆä¸Šè¿°ç‰¹å¾çš„å‡½æ•°ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ•°ç»„ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`Array.reduce`ç®€å•åœ°è¿­ä»£å®ƒï¼Œç›´åˆ°æˆ‘ä»¬åˆ°è¾¾æˆ‘ä»¬çš„æ–°çŠ¶æ€:

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬æ‰€åšçš„å°±æ˜¯ä½¿ç”¨æˆ‘ä»¬çš„ reducers æ¥è®¡ç®—æˆ‘ä»¬çš„æ–°çŠ¶æ€ï¼Œç„¶åå°±åƒä¹‹å‰ä¸€æ ·ï¼Œæˆ‘ä»¬ç®€å•åœ°è°ƒç”¨`this.setState`æ¥æ›´æ–°`StateProvider`çš„ç»„ä»¶çŠ¶æ€ã€‚

ç°åœ¨æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªçœŸæ­£çš„å‡é€Ÿå™¨:

æˆ‘ä»¬çš„ reducer åªæ˜¯æ£€æŸ¥ä¼ å…¥çš„`action.type`ï¼Œå¦‚æœå‘ç°åŒ¹é…ï¼Œå®ƒå°†ç›¸åº”åœ°æ›´æ–°çŠ¶æ€ï¼Œå¦åˆ™æˆ‘ä»¬åªæ˜¯éå†`switch`è¯­å¥ï¼Œé»˜è®¤æƒ…å†µä¸‹ä»æˆ‘ä»¬çš„å‡½æ•°è¿”å›ä¸€ä¸ª`undefined`å€¼ã€‚Redux çš„ reducers å’Œæˆ‘ä»¬è‡ªå·±çš„ redox ä¹‹é—´çš„ä¸€ä¸ªé‡è¦åŒºåˆ«æ˜¯ï¼Œå½“æˆ‘ä»¬ä¸æƒ³æ›´æ–°çŠ¶æ€æ—¶ï¼Œé€šå¸¸æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åŠ¨ä½œç±»å‹ï¼Œæˆ‘ä»¬è¿”å›ä¸€ä¸ª [falsy](https://developer.mozilla.org/en-US/docs/Glossary/Falsy) å€¼ï¼Œè€Œä½¿ç”¨ Reduxï¼Œæ‚¨å°†è¿”å›æœªæ›´æ”¹çš„çŠ¶æ€ã€‚

å¹¶æŠŠæˆ‘ä»¬çš„å‡é€Ÿå™¨é€’ç»™æˆ‘ä»¬çš„`StateProvider`:

Our reducers need to be passed in an array, even if thereâ€™s only a single reducer

ç°åœ¨æˆ‘ä»¬ç»ˆäºå¯ä»¥åˆ†æ´¾ä¸€äº›åŠ¨ä½œï¼Œå¹¶æ ¹æ®æˆ‘ä»¬å‘é€çš„åŠ¨ä½œæ¥è§‚å¯Ÿæˆ‘ä»¬çš„çŠ¶æ€æ›´æ–°:

Reducers done!

# ä¸­é—´ä»¶

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€äº›ç±»ä¼¼ Redux çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€ç§æ–¹æ³•æ¥å¤„ç†å‰¯ä½œç”¨ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†å…è®¸æˆ‘ä»¬çš„ç”¨æˆ·ä¼ é€’ä¸­é—´ä»¶å‡½æ•°ï¼Œæ¯å½“è°ƒåº¦ä¸€ä¸ªåŠ¨ä½œæ—¶éƒ½ä¼šè°ƒç”¨è¿™äº›å‡½æ•°ã€‚

æˆ‘ä»¬è¿˜å¸Œæœ›æˆ‘ä»¬çš„ä¸­é—´ä»¶å‡½æ•°èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ‘†è„±çŠ¶æ€æ›´æ–°ï¼Œæ‰€ä»¥å¦‚æœ`null`ä»ä¸€ä¸ªè¿”å›ï¼Œæˆ‘ä»¬ä¸ä¼šå°†åŠ¨ä½œä¼ é€’ç»™æˆ‘ä»¬çš„ reducerã€‚Redux å¯¹æ­¤çš„å¤„ç†ç•¥æœ‰ä¸åŒâ€”â€”åœ¨ Redux ä¸­é—´ä»¶ä¸­ï¼Œæ‚¨éœ€è¦æ‰‹åŠ¨å°†åŠ¨ä½œä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ Redux çš„`next`å‡½æ•°ä¼ é€’ï¼ŒåŠ¨ä½œå°†ä¸ä¼šåˆ°è¾¾ reducerï¼ŒçŠ¶æ€ä¹Ÿä¸ä¼šæ›´æ–°ã€‚

ç°åœ¨è®©æˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„ä¸­é—´ä»¶ã€‚æˆ‘ä»¬å¸Œæœ›å®ƒå¯»æ‰¾ä¸€ä¸ª`ADD_N`åŠ¨ä½œï¼Œå¦‚æœæ‰¾åˆ°ï¼Œå®ƒåº”è¯¥æ‰“å°å‡º`payload`å’Œç°æœ‰çš„`count`çŠ¶æ€çš„æ€»å’Œï¼Œä½†æ˜¯é˜»æ­¢å®é™…çš„çŠ¶æ€æ›´æ–°ã€‚

å°±åƒæˆ‘ä»¬çš„ reducers ä¸€æ ·ï¼Œæˆ‘ä»¬å°†æŠŠä»»ä½•ä¸­é—´ä»¶ä¼ é€’ç»™æ•°ç»„ä¸­çš„`StateProvider`:

æœ€åï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨æˆ‘ä»¬æ‰€æœ‰çš„ä¸­é—´ä»¶ï¼Œå¹¶ä½¿ç”¨ç»“æœæ¥ç¡®å®šæˆ‘ä»¬æ˜¯å¦æƒ³è¦ä¸­æ­¢æ›´æ–°ã€‚å› ä¸ºæˆ‘ä»¬åˆšåˆšä¼ é€’äº†ä¸€ä¸ªæ•°ç»„ï¼Œå¹¶ä¸”æˆ‘ä»¬æ­£åœ¨å¯»æ‰¾ä¸€ä¸ªå•ä¸€çš„å€¼ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`Array.reduce`æ¥è·å¾—æˆ‘ä»¬çš„ç»“æœã€‚å°±åƒæˆ‘ä»¬çš„ reducers ä¸€æ ·ï¼Œæˆ‘ä»¬å°†åœ¨è°ƒç”¨æ¯ä¸ªå‡½æ•°æ—¶éå†æ•°ç»„ï¼Œç„¶åå°†ç»“æœä¼ é€’ç»™ä¸€ä¸ªåä¸º`continueUpdate`çš„å˜é‡ã€‚

ç”±äºä¸­é—´ä»¶è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªé«˜çº§ç‰¹æ€§[æˆ‘ä»¬ä¸å¸Œæœ›å®ƒæ˜¯å¼ºåˆ¶æ€§çš„ï¼Œæ‰€ä»¥å¦‚æœåœ¨æˆ‘ä»¬çš„`StateProvider`ä¸­æ²¡æœ‰æ‰¾åˆ°`middleware`å±æ€§ï¼Œæˆ‘ä»¬å°†é»˜è®¤è®¾ç½®`continueUpdate`ç­‰äº`undefined`ã€‚æˆ‘ä»¬è¿˜å°†æ·»åŠ ä¸€ä¸ª`middleware`æ•°ç»„ä½œä¸ºé»˜è®¤é“å…·ï¼Œè¿™æ ·å¦‚æœæ²¡æœ‰ä¼ é€’ä»»ä½•ä¸œè¥¿`middleware.reduce`å°±ä¸ä¼šæŠ›å‡ºé”™è¯¯ã€‚](https://redux.js.org/advanced)

æ­£å¦‚æ‚¨åœ¨ç¬¬ 13 è¡Œçœ‹åˆ°çš„ï¼Œæˆ‘ä»¬æ£€æŸ¥ä¸­é—´ä»¶å‡½æ•°è¿”å›äº†ä»€ä¹ˆã€‚å¦‚æœé‡åˆ°`null`å€¼ï¼Œæˆ‘ä»¬å°†è·³è¿‡å…¶ä½™çš„ä¸­é—´ä»¶å‡½æ•°ï¼Œå¹¶ä¸”`continueUpdate`çš„å€¼å°†æ˜¯`null`ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å°†ä¸­æ­¢æ›´æ–°ã€‚

# å¼‚æ­¥æ“ä½œ

å› ä¸ºæˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„çŠ¶æ€ç®¡ç†å™¨åœ¨ç°å®ä¸–ç•Œä¸­æœ‰ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†æ·»åŠ å¯¹å¼‚æ­¥æ“ä½œçš„æ”¯æŒï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å¤„ç†åƒç½‘ç»œè¯·æ±‚è¿™æ ·çš„å¸¸è§ä»»åŠ¡ã€‚ç”±äº API ç®€å•ã€ç›´è§‚ä¸”åŠŸèƒ½å¼ºå¤§ï¼Œæˆ‘ä»¬å°†åœ¨è¿™é‡Œå€Ÿé‰´ä¸€ä¸‹ Redux Thunkã€‚

æˆ‘ä»¬è¦åšçš„å°±æ˜¯æ£€æŸ¥æ˜¯å¦æœ‰ä¸€ä¸ªæœªè°ƒç”¨çš„å‡½æ•°è¢«ä¼ é€’ç»™ dispatchï¼Œå¦‚æœæˆ‘ä»¬æ‰¾åˆ°ä¸€ä¸ªï¼Œæˆ‘ä»¬å°†åœ¨ä¼ é€’`dispatch`å’Œ`state`çš„åŒæ—¶è°ƒç”¨å®ƒï¼Œè¿™ç»™äº†ç”¨æˆ·ç¼–å†™å¼‚æ­¥æ“ä½œæ‰€éœ€çš„ä¸€åˆ‡ã€‚ä»¥æ­¤èº«ä»½éªŒè¯æ“ä½œä¸ºä¾‹:

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º`logIn`çš„åŠ¨ä½œåˆ›å»ºå™¨ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªæ¥å—`dispatch`çš„å‡½æ•°ã€‚è¿™å…è®¸ç”¨æˆ·åœ¨å¼‚æ­¥ API è°ƒç”¨ä¹‹å‰å’Œä¹‹åè°ƒåº¦åŒæ­¥æ“ä½œã€‚æ ¹æ® API è°ƒç”¨çš„ç»“æœï¼Œå°†ä¼šåˆ†æ´¾ä¸åŒçš„æ“ä½œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå‡ºç°é—®é¢˜ï¼Œæˆ‘ä»¬å°†å‘é€ä¸€ä¸ªé”™è¯¯æ“ä½œã€‚

å®ç°è¿™ä¸€ç‚¹å°±åƒåœ¨æˆ‘ä»¬çš„`StateProvider`ä¸­çš„`_dispatch`æ–¹æ³•ä¸­æ£€æŸ¥`function`ç±»å‹çš„`action`ä¸€æ ·ç®€å•:

è¿™é‡Œè¦æ³¨æ„ä¸¤ä»¶äº‹:å½“æˆ‘ä»¬è°ƒç”¨`action`ä½œä¸ºå‡½æ•°æ—¶ï¼Œæˆ‘ä»¬ä¼ é€’`this.state`ä»¥ä¾¿ç”¨æˆ·å¯ä»¥è®¿é—®å¼‚æ­¥åŠ¨ä½œä¸­çš„ç°æœ‰çŠ¶æ€ï¼Œæˆ‘ä»¬è¿˜è¿”å›å‡½æ•°è°ƒç”¨çš„ç»“æœï¼Œå…è®¸å¼€å‘äººå‘˜ä»ä»–ä»¬çš„å¼‚æ­¥åŠ¨ä½œä¸­è·å¾—è¿”å›å€¼ï¼Œè¿™æ‰“å¼€äº†æ›´å¤šçš„å¯èƒ½æ€§ï¼Œä¾‹å¦‚ä»`dispatch`é“¾æ¥æ‰¿è¯ºã€‚

# é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“

ç»å¸¸è¢«å¿½ç•¥çš„æ˜¯ Redux(æˆ–è€…æ›´å‡†ç¡®åœ°è¯´ï¼Œ[React-Redux](https://github.com/reduxjs/react-redux)â€”Redux çš„ React ç»‘å®š)çš„ä¸€ä¸ªåŸºæœ¬ç‰¹æ€§ï¼Œå³å®ƒèƒ½å¤Ÿåœ¨å¿…è¦æ—¶é‡æ–°å‘ˆç°ç»„ä»¶ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œå®ƒä½¿ç”¨äº†`connect` [é«˜é˜¶ç»„ä»¶](https://reactjs.org/docs/higher-order-components.html)ï¼Œè¯¥ç»„ä»¶é‡‡ç”¨äº†ä¸€ä¸ªæ˜ å°„å‡½æ•°â€”â€”`mapStateToProps`â€”â€”å¹¶ä¸”åªæœ‰å½“`mapStateToProps`(ä»ç°åœ¨å¼€å§‹ä»…ä»…æ˜¯`mapState`)çš„è¾“å‡ºæ”¹å˜æ—¶ï¼Œæ‰ä¼šè§¦å‘å®ƒæ‰€é™„åŠ çš„ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚å¦‚æœä¸æ˜¯è¿™ç§æƒ…å†µï¼Œé‚£ä¹ˆæ¯æ¬¡çŠ¶æ€æ›´æ–°æ—¶ï¼Œä½¿ç”¨`connect`è®¢é˜…å­˜å‚¨æ›´æ”¹çš„æ¯ä¸ªç»„ä»¶éƒ½å°†è¢«é‡æ–°å‘ˆç°*ã€‚*

æƒ³æƒ³æˆ‘ä»¬éœ€è¦åšä»€ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥å­˜å‚¨ä»¥å‰çš„`mapState`è¾“å‡ºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å°†å®ƒä¸ä»»ä½•æ–°çš„ç»“æœè¿›è¡Œæ¯”è¾ƒï¼Œä»¥å†³å®šæˆ‘ä»¬æ˜¯å¦è¦ç»§ç»­å¹¶é‡æ–°å‘ˆç°æˆ‘ä»¬çš„ç»„ä»¶ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªå«åš[è®°å¿†åŒ–](https://en.wikipedia.org/wiki/Memoization)çš„è¿‡ç¨‹ã€‚åƒæˆ‘ä»¬è¡Œä¸šä¸­çš„è®¸å¤šäº‹æƒ…ä¸€æ ·ï¼Œè¿™å¯¹äºä¸€ä¸ªç›¸å½“ç®€å•çš„è¿‡ç¨‹æ¥è¯´æ˜¯ä¸€ä¸ªå¤§è¯ï¼Œå°¤å…¶æ˜¯å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥åˆ©ç”¨`React.Component`å°†æˆ‘ä»¬çŠ¶æ€çš„å­é›†å­˜å‚¨åœ¨`this.state`ä¸­ï¼Œå¹¶ä¸”åªæœ‰å½“æˆ‘ä»¬æ£€æµ‹åˆ°`mapState`çš„è¾“å‡ºå‘ç”Ÿå˜åŒ–æ—¶æ‰æ›´æ–°å®ƒã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥è·³è¿‡ä¸å¿…è¦çš„ç»„ä»¶æ›´æ–°ã€‚React é€šè¿‡ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•`shouldComponentUpdate`ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç®€å•çš„æ–¹æ³•ã€‚å®ƒå°†ä»»ä½•ä¼ å…¥çš„å±æ€§å’ŒçŠ¶æ€ä½œä¸ºå‚æ•°ï¼Œè¿™å…è®¸æˆ‘ä»¬å°†å€¼ä¸ç°æœ‰çš„å±æ€§å’ŒçŠ¶æ€è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæˆ‘ä»¬è¿”å›`true`ï¼Œæ›´æ–°å°†ç»§ç»­ï¼Œä½†å¦‚æœæˆ‘ä»¬è¿”å›`false`ï¼ŒReact å°†è·³è¿‡æ¸²æŸ“ã€‚

ä»¥ä¸Šæ˜¯æˆ‘ä»¬ä¸‹ä¸€æ­¥è¦åšçš„æ¦‚è¿°ã€‚å®ƒæ‹¥æœ‰æ‰€æœ‰çš„ä¸»è¦éƒ¨åˆ†:å®ƒä»æˆ‘ä»¬çš„ä¸Šä¸‹æ–‡ä¸­æ¥æ”¶æ›´æ–°ï¼Œå®ƒå®ç°äº†`getDerivedStateFromProps`å’Œ`shouldComponentUpdate`ï¼Œå®ƒè¿˜å°†ä¸€ä¸ªæ¸²æŸ“é“å…·ä½œä¸ºå­å¯¹è±¡â€”â€”å°±åƒé»˜è®¤æ¶ˆè´¹è€…ä¸€æ ·ã€‚æˆ‘ä»¬è¿˜é€šè¿‡ä½¿ç”¨ä¼ é€’çš„`mapState`å‡½æ•°åˆå§‹åŒ–æ¶ˆè´¹è€…çš„åˆå§‹çŠ¶æ€ã€‚

å°±åƒç°åœ¨ä¸€æ ·ï¼Œ`shouldComponentUpdate`åªä¼šåœ¨æ”¶åˆ°ç¬¬ä¸€æ¬¡çŠ¶æ€æ›´æ–°æ—¶æ¸²æŸ“ä¸€æ¬¡ã€‚ä¹‹åï¼Œå®ƒå°†è®°å½•ä¼ å…¥å’Œç°æœ‰çŠ¶æ€ï¼Œå¹¶è¿”å›`false`ï¼Œé˜»æ­¢ä»»ä½•æ›´æ–°ã€‚

ä¸Šé¢çš„è§£å†³æ–¹æ¡ˆä¹Ÿè°ƒç”¨äº†`shouldComponentUpdate`ä¸­çš„`this.setState`ï¼Œæ­£å¦‚æˆ‘ä»¬æ‰€çŸ¥`this.setState`æ€»æ˜¯è§¦å‘é‡æ–°æ¸²æŸ“ã€‚å› ä¸ºæˆ‘ä»¬ä¹Ÿä»`shouldComponentUpdate`è¿”å›`true`ï¼Œè¿™å°†å¯¼è‡´é¢å¤–çš„é‡æ–°æ¸²æŸ“ï¼Œæ‰€ä»¥ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸ`getDerivedStateFromProps`æ¥å¯¼å‡ºæˆ‘ä»¬çš„çŠ¶æ€ï¼Œç„¶åæˆ‘ä»¬å°†ä½¿ç”¨`shouldComponentUpdate`æ¥ç¡®å®šæˆ‘ä»¬æ˜¯å¦æƒ³è¦åŸºäºæˆ‘ä»¬å¯¼å‡ºçš„çŠ¶æ€ç»§ç»­æ¸²æŸ“è¿‡ç¨‹ã€‚

å¦‚æœæˆ‘ä»¬æ£€æŸ¥æˆ‘ä»¬çš„æ§åˆ¶å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¨å±€çŠ¶æ€æ›´æ–°ï¼Œè€Œæˆ‘ä»¬çš„ç»„ä»¶é˜»æ­¢å¯¹å®ƒçš„`this.state`å¯¹è±¡çš„ä»»ä½•æ›´æ–°ï¼Œå› æ­¤è·³è¿‡æ¸²æŸ“:

![](img/625a7d9d263afc26551de097128684c6.png)

Three attempts to update state, but thisState only changes once

æ‰€ä»¥ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•é˜²æ­¢ä¸å¿…è¦çš„æ›´æ–°ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥æ™ºèƒ½åœ°ç¡®å®šæˆ‘ä»¬çš„æ¶ˆè´¹è€…ä½•æ—¶åº”è¯¥å‘ˆç°ã€‚å¦‚æœæˆ‘ä»¬æƒ³çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªä¼ å…¥çš„çŠ¶æ€å¯¹è±¡ä¸Š[é€’å½’](https://en.wikipedia.org/wiki/Recursion_(computer_science))å¹¶æ£€æŸ¥æ¯ä¸€ä¸ªå±æ€§ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦è¢«æ”¹å˜äº†ï¼Œä½†æ˜¯è™½ç„¶è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç»ƒä¹ æ¥æé«˜æˆ‘ä»¬çš„ç†è§£ï¼Œä½†å®ƒå¯èƒ½å¯¹æ€§èƒ½ä¸åˆ©ã€‚æˆ‘ä»¬æ— æ³•çŸ¥é“ä»»ä½•ä¼ å…¥çš„çŠ¶æ€å¯¹è±¡æœ‰å¤šæ·±æˆ–å¤šå¤æ‚ï¼Œå¦‚æœé€€å‡ºæ¡ä»¶æ°¸è¿œä¸æ»¡è¶³ï¼Œé€’å½’å‡½æ•°å°†æ„‰å¿«åœ°æ— é™æœŸè¿è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬å°†é™åˆ¶æ¯”è¾ƒçš„èŒƒå›´ã€‚

å°±åƒ Redux ä¸€æ ·ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ª*æµ…å±‚*æ¯”è¾ƒå‡½æ•°ã€‚è¿™é‡Œçš„â€œæµ…â€æŒ‡çš„æ˜¯å±æ€§çš„æ·±åº¦ï¼Œåœ¨è¿™ä¸ªæ·±åº¦æˆ‘ä»¬å°†æŸ¥çœ‹æˆ‘ä»¬çš„å¯¹è±¡æ˜¯å¦ç›¸ç­‰ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å°†åªæ£€æŸ¥ 1 çº§æ·±åº¦ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†æ£€æŸ¥æ–°çŠ¶æ€é¡¶å±‚çš„æ¯ä¸ªå±æ€§æ˜¯å¦ç­‰äºç°æœ‰çŠ¶æ€ä¸Šçš„åŒåå±æ€§ï¼Œå¦‚æœåŒåå±æ€§ä¸å­˜åœ¨æˆ–è€…å®ƒä»¬å…·æœ‰ä¸åŒçš„å€¼ï¼Œæˆ‘ä»¬å°†ç»§ç»­æ¸²æŸ“ï¼Œå¦åˆ™æˆ‘ä»¬å‡è®¾æˆ‘ä»¬çš„çŠ¶æ€ç›¸åŒï¼Œå¹¶ä¸­æ­¢æ¸²æŸ“ã€‚

Our shallow comparison function

é¦–å…ˆï¼Œæˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„æ£€æŸ¥å¼€å§‹ï¼Œæ£€æŸ¥ä¸¤ç§çŠ¶æ€æ˜¯å¦éƒ½æ˜¯å¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬è·³è¿‡æ¸²æŸ“ã€‚åœ¨è¿™ä¸ªåˆå§‹æ£€æŸ¥ä¹‹åï¼Œæˆ‘ä»¬å°†å½“å‰çŠ¶æ€è½¬æ¢ä¸ºä¸€ä¸ªé”®/å€¼å¯¹çš„æ•°ç»„ï¼Œå¹¶é€šè¿‡å°†æ•°ç»„ç®€åŒ–ä¸ºä¸€ä¸ªå¸ƒå°”å‹æ¥å¯¹ç…§ä¼ å…¥çš„çŠ¶æ€å¯¹è±¡æ£€æŸ¥æ¯ä¸ªå±æ€§çš„å€¼ã€‚

è¿™æ˜¯æœ€éš¾çš„éƒ¨åˆ†ã€‚ç°åœ¨æˆ‘ä»¬æƒ³ä½¿ç”¨æˆ‘ä»¬çš„`shallowCompare`å‡½æ•°ï¼Œæœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªè°ƒç”¨å®ƒå¹¶æ£€æŸ¥ç»“æœçš„ä¾‹å­ã€‚å¦‚æœå®ƒè¿”å›`true`ï¼Œæˆ‘ä»¬å°†è¿”å›`true`ä»¥å…è®¸é‡æ–°æ¸²æŸ“ï¼Œå¦åˆ™æˆ‘ä»¬ç®€å•åœ°è¿”å›`false`ä»¥è·³è¿‡æ›´æ–°(å¹¶ä¸”æˆ‘ä»¬çš„æ´¾ç”ŸçŠ¶æ€è¢«ä¸¢å¼ƒ)ã€‚æˆ‘ä»¬è¿˜æƒ³åº”ç”¨æˆ‘ä»¬çš„`mapDispatch`å‡½æ•°ï¼Œå¦‚æœå®ƒå­˜åœ¨çš„è¯ã€‚

Surprisingly simple

æœ€åï¼Œæˆ‘ä»¬éœ€è¦å‘æ¶ˆè´¹è€…ä¼ é€’ä¸€ä¸ª`mapState`å‡½æ•°ï¼Œè¯¥å‡½æ•°ä»…æ˜ å°„æˆ‘ä»¬çš„éƒ¨åˆ†çŠ¶æ€ï¼Œå› æ­¤æˆ‘ä»¬å°†æŠŠå®ƒä½œä¸ºé“å…·ä¼ é€’ç»™æ›´æ–°åçš„`StateConsumer`:

ç°åœ¨æˆ‘ä»¬åªè®¢é˜…äº†`greeting`ä¸­çš„å˜åŒ–ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æ›´æ–°`count`ï¼Œæˆ‘ä»¬çš„ç»„ä»¶å°†å¿½ç•¥å…¨å±€çŠ¶æ€ä¸­çš„å˜åŒ–ï¼Œå¹¶é¿å…é‡æ–°å‘ˆç°ã€‚

# å¿«é€Ÿå›é¡¾

å¦‚æœæ‚¨å·²ç»åšåˆ°äº†è¿™ä¸€æ­¥ï¼Œæ‚¨å°†ä¼šçœ‹åˆ°å¦‚ä½•å®ç°ä¸€ä¸ªç±»ä¼¼ Redux çš„çŠ¶æ€ç®¡ç†åº“ï¼ŒåŒ…æ‹¬ Redux å’Œ actionsã€‚æˆ‘ä»¬è¿˜è®¨è®ºäº†æ›´é«˜çº§çš„ä¸»é¢˜ï¼Œæ¯”å¦‚å¼‚æ­¥æ“ä½œã€ä¸­é—´ä»¶ï¼Œä»¥åŠå¦‚ä½•ä½¿å®ƒåªæ¥æ”¶æˆ‘ä»¬æƒ³è¦çš„çŠ¶æ€æ›´æ–°ï¼Œä»¥é¿å…æ¯æ¬¡å…¨å±€çŠ¶æ€æ›´æ–°æ—¶é‡æ–°å‘ˆç°æˆ‘ä»¬çš„æ¶ˆè´¹è€…ã€‚

è™½ç„¶ Redux æ¯”æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæœ‰æ›´å¤šçš„åŠŸèƒ½ï¼Œä½†å¸Œæœ›è¿™æœ‰åŠ©äºæ¾„æ¸…ä¸€äº›æ ¸å¿ƒæ¦‚å¿µï¼Œå¹¶è¡¨æ˜è™½ç„¶ Redux é€šå¸¸è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªæ›´é«˜çº§çš„ä¸»é¢˜ï¼Œä½†å®ƒçš„å®ç°ç›¸å¯¹ç®€å•ã€‚

ä¸ºäº†æ›´é€å½»åœ°ç†è§£ Redux çš„å†…éƒ¨ï¼Œæˆ‘å¼ºçƒˆæ¨èé˜…è¯» Github ä¸Šçš„[æºä»£ç ã€‚](https://github.com/reduxjs/redux/tree/master/src)

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆå·²ç»å…·å¤‡äº†åœ¨ç°å®é¡¹ç›®ä¸­ä½¿ç”¨çš„æ‰€æœ‰å¿…è¦å·¥å…·å’Œå±æ€§ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ React é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬ä¸éœ€è¦ Reduxï¼Œé™¤éæˆ‘ä»¬æƒ³è®¿é—®ä¸€äº›çœŸæ­£é«˜çº§çš„ç‰¹æ€§ã€‚

# é’©ä½

å¦‚æœä½ è¿˜æ²¡æœ‰å¬è¯´ï¼Œé’©å­å¾ˆå¿«æˆä¸º React ä¸­çš„ä¸‹ä¸€ä¸ªå¤§äº‹ä»¶ã€‚ä¸‹é¢æ˜¯æ¥è‡ªå®˜æ–¹ä»‹ç»çš„ç®€è¦è¯´æ˜:

> é’©å­æ˜¯ä¸€ä¸ªæ–°çš„ç‰¹æ€§æè®®ï¼Œå®ƒè®©ä½ ä¸ç”¨å†™ç±»å°±å¯ä»¥ä½¿ç”¨çŠ¶æ€å’Œå…¶ä»– React ç‰¹æ€§ã€‚

é’©å­ç»™äº†æˆ‘ä»¬æ‰€æœ‰é«˜é˜¶ç»„ä»¶çš„èƒ½åŠ›ï¼Œå¹¶ä¸”ç”¨ä¸€ä¸ªæ›´å¹²å‡€ã€æ›´ç›´è§‚çš„ API æ¥æ¸²æŸ“é“å…·ã€‚

è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè¿™ä¸ªä¾‹å­å±•ç¤ºäº†åŸºæœ¬çš„é’©å­`useState`:

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å°†`0`ä¼ é€’ç»™`useState`æ¥åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„çŠ¶æ€ï¼Œåè€…è¿”å›æˆ‘ä»¬çš„çŠ¶æ€:`count`ï¼Œä»¥åŠä¸€ä¸ªæ›´æ–°å‡½æ•°:`setCount`ã€‚å¦‚æœä½ ä»¥å‰æ²¡æœ‰è§è¿‡è¿™ä¸ªï¼Œä½ å¯èƒ½ä¼šæƒ³ä¸ºä»€ä¹ˆ`useState`ä¸ä¼šåœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½è¢«é‡æ–°åˆå§‹åŒ–ä¸º`0`â€”â€”è¿™æ˜¯å› ä¸º React åœ¨å†…éƒ¨å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦æ‹…å¿ƒè¿™ä¸ªé—®é¢˜ã€‚

å› æ­¤ï¼Œè®©æˆ‘ä»¬æš‚æ—¶å¿˜è®°ä¸­é—´ä»¶å’Œå¼‚æ­¥æ“ä½œï¼Œä½¿ç”¨`useReducer`é’©å­é‡æ–°å®ç°æˆ‘ä»¬çš„æä¾›è€…ï¼Œå®ƒçš„å·¥ä½œæ–¹å¼å’Œ`useState`ä¸€æ ·ï¼Œåªæ˜¯æ“ä½œè¢«åˆ†æ´¾åˆ°æ´¾ç”Ÿæ–°çŠ¶æ€çš„ reducerï¼Œå°±åƒæˆ‘ä»¬æ­£åœ¨æ„å»ºçš„ä¸€æ ·ã€‚

çŸ¥é“äº†è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ç®€å•åœ°å°†æˆ‘ä»¬çš„ reducer é€»è¾‘ä»æ—§çš„`StateProvider`å¤åˆ¶åˆ°æ–°çš„åŠŸèƒ½æ€§`StateProvider`:

è¿™å°±æ˜¯å®ƒå¯ä»¥æœ‰å¤šç®€å•ï¼Œä½†æ˜¯å°½ç®¡æˆ‘ä»¬æƒ³è®©äº‹æƒ…å˜å¾—ç®€å•ï¼Œæˆ‘ä»¬ä»ç„¶æ²¡æœ‰å®Œå…¨åˆ©ç”¨é’©å­çš„åŠ›é‡ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨é’©å­å°†æˆ‘ä»¬çš„`StateConsumer`æ¢æˆæˆ‘ä»¬è‡ªå·±çš„å®šåˆ¶é’©å­ï¼Œæˆ‘ä»¬å°†é€šè¿‡åŒ…è£…`useContext`é’©å­æ¥å®ç°:

Easy peasy

ç„¶è€Œï¼Œä¹‹å‰æˆ‘ä»¬åœ¨åˆ›å»ºä¸Šä¸‹æ–‡æ—¶ææ„äº†`Provider`å’Œ`Consumer`ï¼Œè¿™æ¬¡æˆ‘ä»¬å°†å®ƒå­˜å‚¨åœ¨ä¸€ä¸ªå˜é‡ä¸­ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™`useContext`ï¼Œä»¥ä¾¿æˆ‘ä»¬åœ¨æ²¡æœ‰`Consumer`çš„æƒ…å†µä¸‹è®¿é—®ä¸Šä¸‹æ–‡ã€‚æˆ‘ä»¬è¿˜å°†æˆ‘ä»¬çš„å®šåˆ¶é’©å­å‘½åä¸º`useStore`ï¼Œå› ä¸º`useState`æ˜¯ä¸€ä¸ªé»˜è®¤é’©å­ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç®€å•åœ°é‡æ„æˆ‘ä»¬æ¶ˆè´¹ä¸Šä¸‹æ–‡çš„æ–¹å¼:

å¸Œæœ›è¿™äº›ä¾‹å­åœ¨æŸç§ç¨‹åº¦ä¸Šå±•ç¤ºäº†é’©å­æ˜¯å¤šä¹ˆç›´è§‚ã€ç®€å•å’Œå¼ºå¤§ã€‚æˆ‘ä»¬å‡å°‘äº†æ‰€éœ€çš„ä»£ç é‡ï¼Œå¹¶ä¸ºè‡ªå·±æä¾›äº†ä¸€ä¸ªæ¼‚äº®ã€ç®€å•çš„ APIã€‚

æˆ‘ä»¬è¿˜æƒ³è®©æˆ‘ä»¬çš„ä¸­é—´ä»¶å’Œå†…ç½®çš„å¼‚æ­¥æ“ä½œæ”¯æŒå†æ¬¡å·¥ä½œã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†æŠŠæˆ‘ä»¬çš„`useReducer`åŒ…è£…åœ¨ä¸€ä¸ªå®šåˆ¶çš„é’©å­ä¸­ï¼Œä¸€ä¸ªä¸“é—¨åœ¨æˆ‘ä»¬çš„`StateProvider`ä¸­ä½¿ç”¨çš„é’©å­ï¼Œç„¶åç®€å•åœ°é‡ç”¨æˆ‘ä»¬æ—§çš„æœ‰çŠ¶æ€ç»„ä»¶çš„å…ˆå‰é€»è¾‘ã€‚

ä¸æˆ‘ä»¬çš„æ—§è§£å†³æ–¹æ¡ˆä¸€æ ·ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸­é—´ä»¶æ˜¯å¯é€‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å†æ¬¡æ·»åŠ ä¸€ä¸ªç©ºæ•°ç»„ä½œä¸ºç¼ºçœå€¼â€”â€”å°½ç®¡è¿™ä¸€æ¬¡æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç¼ºçœå‚æ•°è€Œä¸æ˜¯ç¼ºçœå±æ€§ã€‚ç±»ä¼¼äºæˆ‘ä»¬ä»¥å‰çš„è°ƒåº¦åŠŸèƒ½ï¼Œæˆ‘ä»¬è°ƒç”¨æˆ‘ä»¬çš„ä¸­é—´ä»¶ï¼Œå¦‚æœ`continueUpdate !== null`æˆ‘ä»¬ç»§ç»­çŠ¶æ€æ›´æ–°ã€‚æˆ‘ä»¬ä¹Ÿæ²¡æœ‰æ”¹å˜å¤„ç†å¼‚æ­¥åŠ¨ä½œçš„æ–¹å¼ã€‚

æœ€åï¼Œæˆ‘ä»¬å°†`useStateProvider`çš„ç»“æœåŠå…¶å‚æ•°ä¼ é€’ç»™æˆ‘ä»¬çš„æä¾›è€…ï¼Œè¿™ä¸ªæä¾›è€…å·²ç»å¤§å¤§ç¼©å°äº†:

å°±æ˜¯è¿™æ ·ï¼ğŸ‰

## ç„¶è€Œâ€¦

ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°çš„ä¸€ä»¶äº‹æ˜¯ï¼Œæˆ‘ä»¬çš„é’©å­å®ç°æ²¡æœ‰åŠæ³•è·³è¿‡ä¸å¿…è¦çš„æ›´æ–°ã€‚è¿™æ˜¯å› ä¸ºé’©å­æ˜¯å¦‚ä½•åœ¨å‡½æ•°ç»„ä»¶çš„ä¸»ä½“ä¸­è¢«è°ƒç”¨çš„â€”â€”åœ¨é‚£ä¸ªé˜¶æ®µï¼ŒReact æ²¡æœ‰åŠæ³•è„±ç¦»æ¸²æŸ“è¿‡ç¨‹(ä¸æ˜¯æ²¡æœ‰ä¸€äº›é»‘å®¢)ã€‚ä¸è¿‡æ²¡å¿…è¦æ‹…å¿ƒï¼Œ[React å›¢é˜Ÿå·²ç»æ„è¯†åˆ°äº†è¿™ä¸€ç‚¹](https://github.com/facebook/react/issues/14110)ï¼Œå¹¶è®¡åˆ’ä¸ºæˆ‘ä»¬æä¾›ä¸€ç§æ–¹æ³•æ¥ä¸­æ­¢æ¥è‡ªåŠŸèƒ½ç»„ä»¶çš„æ›´æ–°ã€‚

ä¸€æ—¦æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå®˜æ–¹çš„æ–¹æ³•æ¥æ‘†è„±å‡½æ•°ç»„ä»¶å†…éƒ¨çš„æ¸²æŸ“ï¼Œæˆ‘ä¼šå›åˆ°è¿™é‡Œæ¥æ›´æ–°è¿™ç¯‡åšæ–‡ã€‚åŒæ—¶ï¼Œæˆ‘åœ¨ hooks å®ç°ä¹‹å¤–ç¼–å†™çš„åº“é™„å¸¦äº†ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è®¿é—®è¿™ä¸ªåŠŸèƒ½ã€‚

# æ¦‚æ‹¬èµ·æ¥

æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬å·²ç»ç ”ç©¶äº†æœ€åŸºæœ¬çš„çŠ¶æ€ç®¡ç†å™¨ï¼Œå¹¶åœ¨å®ƒçš„åŸºç¡€ä¸Šé€æ­¥æ„å»ºï¼Œç›´åˆ°æˆ‘ä»¬æœ€ç»ˆå¾—åˆ°äº†ç±»ä¼¼ Redux çš„ä¸œè¥¿â€”â€”åŒ…æ‹¬åŠ¨ä½œã€reducersã€ä¸­é—´ä»¶å’Œä¸€ç§åŒºåˆ†çŠ¶æ€æ›´æ–°ä»¥æé«˜æ€§èƒ½çš„æ–¹æ³•ã€‚æˆ‘ä»¬è¿˜ç ”ç©¶äº†å¦‚ä½•ä½¿ç”¨å…¨æ–°çš„ hooks API ç®€åŒ–æˆ‘ä»¬çš„ä»£ç ã€‚

å¸Œæœ›æ‚¨åœ¨è¿™ç¯‡æ–‡ç« ä¸­æ‰¾åˆ°äº†ä¸€äº›æœ‰ç”¨çš„ä¸œè¥¿ï¼Œæˆ‘èƒ½å¤Ÿé˜æ˜ä¸€äº›æ›´é«˜çº§çš„æ¦‚å¿µï¼ŒåŒæ—¶è¡¨æ˜æˆ‘ä»¬ä½¿ç”¨çš„è®¸å¤šå·¥å…·å¯èƒ½æ¯”å®ƒä»¬ç¬¬ä¸€æ¬¡å‡ºç°æ—¶æ›´ç®€å•ã€‚

> æ­£å¦‚åœ¨å¼€å§‹æ—¶ç®€è¦æåˆ°çš„ï¼Œæˆ‘åœ¨æœ¬æ–‡åé¢å†™äº†ä¸€ä¸ªåº“ï¼Œ[ä½¿ç”¨ç®€å•çŠ¶æ€](https://github.com/Jahans3/use-simple-state)ã€‚ä½ å¯ä»¥åœ¨æˆ‘çš„ [Github é¡µé¢](https://github.com/Jahans3)ä¸Šçœ‹åˆ°å®ƒï¼Œåœ¨é‚£é‡Œæˆ‘ä¸º[çš„æœ€ç»ˆå®ç°](https://github.com/Jahans3/use-simple-state/tree/master/src)ä½¿ç”¨äº†é’©å­ï¼Œå®ƒåŒ…æ‹¬å‡ ä¸ªé¢å¤–çš„ç‰¹æ€§ã€‚

## æ¨ç‰¹: [@josh_jahans](https://twitter.com/josh_jahans)