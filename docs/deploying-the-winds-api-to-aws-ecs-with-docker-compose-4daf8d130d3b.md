# ä½¿ç”¨ Docker Compose å°† Winds API éƒ¨ç½²åˆ° AWS ECS

> åŸæ–‡ï¼š<https://medium.com/hackernoon/deploying-the-winds-api-to-aws-ecs-with-docker-compose-4daf8d130d3b>

![](img/b87c46843bf9b455f22453df21f965ff.png)

https://getstream.io/winds

[Winds](https://getstream.io/winds) æ˜¯ç”± [Stream](https://getstream.io/try-the-api) æä¾›çš„ä¸€ä¸ªæµè¡Œçš„ RSS å’Œæ’­å®¢åº”ç”¨ç¨‹åºâ€”â€”ä¸€ä¸ªå…è®¸ä½ åœ¨å‡ ä¸ªå°æ—¶è€Œä¸æ˜¯å‡ ä¸ªæœˆå†…å»ºç«‹æ–°é—»å’Œæ´»åŠ¨æè¦çš„æœåŠ¡ã€‚Winds æ˜¯ 100%å¼€æºçš„ï¼Œåç«¯å¾ˆå®¹æ˜“å®‰è£…åœ¨æœ¬åœ°ç¯å¢ƒæˆ–äº‘ä¸­â€”â€”è¿™æ˜¯æˆ‘ä»¬å°†åœ¨æœ¬æ•™ç¨‹ä¸­è®¨è®ºçš„ä»»åŠ¡ã€‚ä¸ºäº†ç¡®ä¿æ‚¨é¡ºåˆ©å®Œæˆæ•™ç¨‹ï¼Œ*è¯·*ç¡®ä¿å®Œæˆæ‰€æœ‰çš„å…ˆå†³æ¡ä»¶ã€‚

# å…ˆå†³æ¡ä»¶ğŸ“š

ä¸ä»»ä½•æ•™ç¨‹ä¸€æ ·ï¼Œå®ƒä¹Ÿæœ‰ä¸€äº›è¦æ±‚ã€‚å¯¹äºè¿™ç¯‡æ–‡ç« ï¼Œæ‚¨éœ€è¦ç¡®ä¿æ‚¨å·²ç»å¯åŠ¨å¹¶è¿è¡Œäº†ä»¥ä¸‹å†…å®¹ï¼Œå¹¶åœ¨ç»§ç»­ä¹‹å‰åšå¥½äº†å‡†å¤‡ã€‚å¦‚æœä½ å†³å®šè·³è¿‡è¿™äº›éœ€æ±‚ï¼Œä½ å¾ˆå¯èƒ½ä¼šåœ¨æŸä¸ªåœ°æ–¹åœæ»ä¸å‰â€”â€”æˆ‘ä»¬ä¸å¸Œæœ›è¿™ç§æƒ…å†µå‘ç”Ÿã€‚

1.  å¯¹ [ECS](https://aws.amazon.com/ecs/) å’Œ[elastic cache](https://aws.amazon.com/elasticache/)æ‹¥æœ‰å®Œå…¨è®¿é—®æƒé™çš„äºšé©¬é€Šç½‘ç»œæœåŠ¡(AWS)è´¦æˆ·
2.  æ¥è‡ª https://github.com/GetStream/Winds[çš„é£çš„æ–°å…‹éš†](https://github.com/GetStream/Winds)
3.  æ‹¥æœ‰ [MongoDB Atlas](https://cloud.mongodb.com/) æˆ–å…¶ä»– MongoDB æä¾›å•†çš„è´¦æˆ·(æˆ‘ä»¬æ¨è MongoDB Atlas)
4.  ä¸€ä¸ªæœ‰[æµ](https://getstream.io/try-the-api)çš„è‡ªç”±è´¦æˆ·
5.  AWS ElastiCache è®¾ç½®å’Œè¿è¡Œ Redis çš„å®ä¾‹(*å¤åˆ¶ URIï¼Œå› ä¸ºæ‚¨å¾ˆå¿«å°±ä¼šéœ€è¦å®ƒ*
6.  æ¥è‡ª Mercury çš„å…è´¹ API å¯†é’¥(å®ƒå¤„ç† RSS æ–‡ç« è§£æï¼Œå› æ­¤éå¸¸é‡è¦)
7.  æ¥è‡ª [Algolia](https://algolia.com/) çš„ä¸€å¥—å…è´¹å‡­è¯
8.  å®‰è£…åœ¨æ‚¨æœºå™¨ä¸Šçš„ AWS CLI
9.  é™¤ AWS CLI å¤–ï¼Œè¿˜å®‰è£…äº† ECS CLI
10.  Docker Hub ä¸Šçš„ä¸€ä¸ªè´¦æˆ·(å¦‚æœä½ æ„¿æ„ï¼Œä½ å¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªæä¾›å•†ï¼›ç„¶è€Œï¼Œæˆ‘å¼ºçƒˆå»ºè®®åšæŒä½¿ç”¨ Docker Hub)

æˆ‘æƒ³æåˆ°çš„å¦ä¸€ä»¶äº‹æ˜¯ï¼Œæ‚¨åº”è¯¥åœ¨æ‚¨çš„ AWS å¸æˆ·ä¸Šæ‹¥æœ‰ä»¥ä¸‹æƒé™(æˆ–ç±»ä¼¼æƒé™):

*   amazone C2 containerregistryfull access

![](img/2f3dfd4cf8a7007576c6739322e857c6.png)

å°±æ˜¯è¿™æ ·ï¼ğŸ’¥

# è®¾ç½®ç›¸å…³æ€§ğŸ› 

ç”±äºæˆ‘ä»¬åœ¨ä¸Šé¢æä¾›äº†è¯¦å°½çš„åˆ—è¡¨ï¼Œå¸Œæœ›æ‚¨å·²ç»æœ‰æœºä¼šå®Œæˆå„ä¸ªæ­¥éª¤ï¼Œå¹¶å¤åˆ¶æ‚¨çš„ç¬¬ä¸‰æ–¹ URIs å’Œå‡­æ®ä»¥ç»§ç»­ä¸‹ä¸€æ­¥ã€‚ä¸‹ä¸€æ­¥éœ€è¦æˆ‘ä»¬ä¿®æ”¹ä½äº Winds çš„ **/api** ç›®å½•ä¸­çš„ **docker-compose-aws** æ–‡ä»¶ã€‚

å½“æˆ‘ä»¬å¼€å§‹æ—¶ï¼Œè¯¥æ–‡ä»¶å°†å¦‚ä¸‹æ‰€ç¤º:

æŒ‰ç…§ **docker-compose-aws.yml** æ–‡ä»¶ä¸­çš„æŒ‡ç¤ºå¡«å†™å‡­è¯ã€‚ä¸è¦å¿˜è®°ä¸€ä¸ª[éšæœºå€¼](https://randomkeygen.com/)ç»™ä½ çš„ JWTã€‚

æ‚¨æœ€ç»ˆåº”è¯¥å¾—åˆ°ä¸€ä¸ªç±»ä¼¼å¦‚ä¸‹çš„æ–‡ä»¶:

> *æ³¨æ„:æˆ‘ä»¬åœ¨ docker-compose.yml æ–‡ä»¶ä¸Šä½¿ç”¨äº†****docker-compose-AWS . yml****æ–‡ä»¶ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨åŒä¸€ä¸ªç›®å½•ä¸­æœ‰ä¸¤ä¸ª docker-compose æ–‡ä»¶ã€‚é€šè¿‡å°†â€œ-awsâ€é™„åŠ åˆ°æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°æŒ‡å®šåœ¨æ„å»ºç¯å¢ƒæ—¶è¦è®¿é—®ä»€ä¹ˆæ–‡ä»¶ã€‚*

# ä½¿ç”¨ ECS CLI å¯åŠ¨å’Œè¿è¡ŒğŸ¤”

Amazon Web Services (AWS CLI)çš„å¼¹æ€§å®¹å™¨æœåŠ¡å‘½ä»¤è¡Œæ¥å£æä¾›äº†é«˜çº§å‘½ä»¤ï¼Œä»¥ç®€åŒ–ä»æœ¬åœ°å¼€å‘ç¯å¢ƒåˆ›å»ºã€æ›´æ–°å’Œç›‘æ§é›†ç¾¤å’Œä»»åŠ¡ã€‚

è¿™é‡Œé‡è¦çš„æ˜¯ï¼ŒECS CLI æ”¯æŒ Docker Compose æ–‡ä»¶ï¼Œè¿™æ˜¯æˆ‘ä»¬ç”¨æ¥å®šä¹‰æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¦‚ä½•ä»¥åŠåº”è¯¥å¦‚ä½•åœ¨äº‘ä¸­è¿è¡Œçš„æ–‡ä»¶ã€‚è™½ç„¶å®ƒæ˜¯é’ˆå¯¹å¤šå®¹å™¨åº”ç”¨ç¨‹åºçš„(æˆ‘ä»¬åœ¨ **docker-compose-aws.yml** ä¸­ä¹Ÿæœ‰ä¸€ä¸ªæ–‡ä»¶)ï¼Œä½†å‡ºäºæœ¬æ•™ç¨‹çš„ç›®çš„ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å•ä¸ªå®¹å™¨åº”ç”¨ç¨‹åºã€‚

è®©æˆ‘ä»¬ç»§ç»­é…ç½® AWS ECS CLIï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹è¿è¡Œäº†ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªâ€œæ¦‚è¦æ–‡ä»¶â€:

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®Œæˆé…ç½®:

> *æ³¨æ„:å°† launch type æ›¿æ¢ä¸ºæ‚¨å¸Œæœ›é»˜è®¤ä½¿ç”¨çš„ launch type(EC2 ),å°† region_name æ›¿æ¢ä¸ºæ‚¨å¸Œæœ›çš„ AWS åŒºåŸŸï¼Œå°† cluster_name (WINDS)æ›¿æ¢ä¸ºè¦ä½¿ç”¨çš„ç°æœ‰ Amazon ECS é›†ç¾¤æˆ–æ–°é›†ç¾¤çš„åç§°ï¼Œå°† configuration_name (WINDS)æ›¿æ¢ä¸ºæ‚¨å¸Œæœ›ä¸ºæ­¤é…ç½®æŒ‡å®šçš„åç§°ã€‚*

# ä½¿ç”¨ EC2 ä»»åŠ¡âœåˆ›å»ºç¾¤

AWS ECS éœ€è¦æƒé™ï¼Œä»¥ä¾¿æ‚¨çš„ EC2 ä»»åŠ¡å¯ä»¥åœ¨ CloudWatch ä¸­å­˜å‚¨æ—¥å¿—ã€‚è¯¥æƒé™ç”±ä»»åŠ¡æ‰§è¡Œ IAM è§’è‰²è´Ÿè´£ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ AWS CLI åˆ›å»ºä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ IAM è§’è‰²ã€‚

1.åˆ›å»ºåä¸º**task-execution-assume-role . JSON**çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

2.åˆ›å»ºä»»åŠ¡æ‰§è¡Œè§’è‰²(ä¸**task-execution-assume-role . JSON**åœ¨åŒä¸€ç›®å½•ä¸‹):

3.é™„åŠ ä»»åŠ¡æ‰§è¡Œè§’è‰²ç­–ç•¥:

# åˆ›å»ºç¾¤é›†å’Œå®‰å…¨ç»„ğŸ”‘

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå¸¦æœ‰å®‰å…¨ç»„çš„ Amazon ECS é›†ç¾¤ã€‚

1.æˆ‘ä»¬å·²ç»åœ¨é›†ç¾¤é…ç½®ä¸­å°† EC2 æŒ‡å®šä¸ºé»˜è®¤å¯åŠ¨ç±»å‹ï¼Œå› æ­¤ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªç©ºé›†ç¾¤å’Œä¸€ä¸ªé…ç½®äº†ä¸¤ä¸ªå…¬å…±å­ç½‘çš„ VPC:

> *æ³¨æ„:åˆ›å»ºèµ„æºæ—¶ï¼Œæ­¤å‘½ä»¤å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ‰èƒ½å®Œæˆã€‚æ‚¨è¿˜éœ€è¦è®°ä¸‹åˆ›å»ºçš„ VPC å’Œå­ç½‘ idï¼Œæˆ‘ä»¬å¾ˆå¿«å°±ä¼šç”¨åˆ°å®ƒä»¬ã€‚*

2.ä½¿ç”¨ AWS CLIï¼Œä½¿ç”¨ä¸Šä¸€ä¸ªå‘½ä»¤è¾“å‡ºä¸­çš„ VPC å€¼åˆ›å»ºä¸€ä¸ªå®‰å…¨ç»„:

3.ä½¿ç”¨ AWS CLIï¼Œæˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªå®‰å…¨ç»„è§„åˆ™ï¼Œä»¥å…è®¸ç«¯å£ 80 ä¸Šçš„å…¥ç«™è®¿é—®:

# æŒ‡å®š AWS ECS ğŸ–¥çš„å‚æ•°

é™¤äº†æˆ‘ä»¬å·²ç»ä¸ºæ‚¨åˆ›å»ºçš„ **docker-compose-aws.yml** æ–‡ä»¶ä¹‹å¤–ï¼Œæ‚¨è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ **ecs-params.yml** æ–‡ä»¶:

> *æ³¨æ„:è¿™ä¸ª params æ–‡ä»¶ç‰¹å®šäº AWS ECSï¼Œå¦‚æœæ‚¨æƒ³åœ¨ AWS ä¸Šè¿è¡Œ Winds APIï¼Œå®ƒæ˜¯å¿…éœ€çš„ã€‚æ‚¨éœ€è¦æŒ‡å®šçš„å€¼å¯ä»¥åœ¨å‰é¢çš„è¯·æ±‚ä¸­æ‰¾åˆ°ã€‚*

# å°†æ˜ åƒéƒ¨ç½²åˆ° Docker HubğŸš´

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¦‚è¿°å¦‚ä½•æ„å»ºã€æ ‡è®°å’Œä¸Šä¼  Winds API åˆ° Docker å’Œ AWSã€‚

# åˆ›å»ºå’Œä¸Šä¼ 

å¯¹äºè¿™ä¸€æ­¥ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç™»å½• Docker:

ç„¶åï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ„å»º Docker æ˜ åƒ(æ‚¨å¿…é¡»åœ¨ **/api** ç›®å½•ä¸­):

# æ ‡è®°å’Œæ¨é€

é¦–å…ˆï¼Œæ‚¨éœ€è¦è·å¾— docker å›¾åƒ IDï¼Œæ‚¨å¯ä»¥è¿è¡Œ **docker å›¾åƒåˆ—è¡¨**ï¼Œå®ƒå°†è¾“å‡ºæ‚¨æ‰€æœ‰çš„ Docker å›¾åƒã€‚ä»æ ‡è®°ä¸ºâ€œwindsâ€çš„æ–‡ä»¶ä¸­è·å– IDï¼Œå¹¶å°†å…¶æ”¾å…¥ä¸‹é¢çš„å‘½ä»¤ä¸­ã€‚

æ­£ç¡®æ ‡è®°å›¾åƒæ‰€éœ€çš„å‘½ä»¤æ˜¯:

ç°åœ¨ï¼Œæ˜¯æ—¶å€™å°†æ ‡è®°çš„å›¾åƒæ¨é€åˆ° AWS äº†ã€‚æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°è¿™ä¸€ç‚¹:

å¤§çº¦éœ€è¦ 30 ç§’ï¼Œä½†å®Œæˆåã€‚

# éƒ¨ç½²åˆ°é›†ç¾¤ğŸ“¤

ç°åœ¨æˆ‘ä»¬å·²ç»é…ç½®å¥½äº†æ–‡ä»¶å’ŒåŸºç¡€è®¾æ–½ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°† Docker compose æ–‡ä»¶éƒ¨ç½²åˆ° ECS:

> *æ³¨æ„:é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å‘½ä»¤åœ¨å½“å‰ç›®å½•ä¸­æŸ¥æ‰¾åä¸º docker-compose.yml çš„æ–‡ä»¶ï¼›å› ä¸ºæˆ‘ä»¬æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨â€“file é€‰é¡¹(æˆ–ç®€ç§°ä¸º-f)æŒ‡å®šä¸€ä¸ªä¸åŒçš„ docker åˆæˆæ–‡ä»¶ã€‚*

å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œæ‚¨åº”è¯¥ä¼šåœ¨ ECS æ§åˆ¶å°ä¸­çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼å¦‚æœæ‚¨å•å‡»è¯¥ä»»åŠ¡ï¼Œæ‚¨ä¼šæ³¨æ„åˆ°æœ‰ä¸€ä¸ªå…¬å…± IP åœ°å€ï¼Œå…è®¸æ‚¨æŸ¥çœ‹ API(å®ƒåº”è¯¥ä»¥â€œpongâ€å“åº”)ã€‚

![](img/5ad52a991062e3944c79c8863524769f.png)

# æå®šäº†ã€‚ğŸ‘

æˆ‘å¸Œæœ›ä½ å–œæ¬¢è¿™ç¯‡å…³äºå¦‚ä½•ä½¿ç”¨ Docker å°† Winds éƒ¨ç½²åˆ° AWS çš„æ•™ç¨‹ã€‚åœ¨ä»¥åçš„æ–‡ç« ä¸­ï¼Œæˆ‘å°†æ¦‚è¿°å¦‚ä½•åœ¨ Google å’Œ Digital Ocean ä¸Šè¿›è¡ŒåŒæ ·çš„éƒ¨ç½²ã€‚

å¦‚æœä½ å¯¹éƒ¨ç½²å‰ç«¯æ„Ÿå…´è¶£ï¼Œçœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼Œè¿™ç¯‡æ–‡ç« æ¦‚è¿°äº†å¦‚ä½•ä½¿ç”¨ AWS S3 å’Œ CloudFront æ¥éƒ¨ç½²å‰ç«¯ã€‚

ç¼–ç å¿«ä¹ï¼ğŸ‰

æ ‡ç­¾: [AWS ECS](https://getstream.io/blog/tag/aws-ecs/) ï¼Œ[é›†è£…ç®±](https://getstream.io/blog/tag/containers/)ï¼Œ[è°ƒé…](https://getstream.io/blog/tag/deployment/)ï¼Œ[ç å¤´](https://getstream.io/blog/tag/docker/)ï¼Œ[å¤§é£](https://getstream.io/blog/tag/winds/)

*æœ€åˆå‘å¸ƒäº 2018 å¹´ 9 æœˆ 6 æ—¥*[*getstream . io*](https://getstream.io/blog/deploying-the-winds-api-to-aws-ecs-with-docker-compose/)*ã€‚*