# 开发一个快速销售系统

> 原文：<https://medium.com/hackernoon/developing-a-flash-sale-system-7481f6ede0a3>

![](img/b2179dd9c8a3159df15ac7850b7db009.png)

[http://www.internationalnewsandviews.com/wp-content/uploads/2017/03/flash-sale-banner.png](http://www.internationalnewsandviews.com/wp-content/uploads/2017/03/flash-sale-banner.png)

在中国有一个几乎每个中国人都使用的著名网站，我们通常一年只使用一次——12306.com，火车票预订系统。

当网站开始销售农历新年的门票时，许多人都在电脑前等待，准备在销售开始的准确时间点击`reserve`按钮。

然后，网站崩溃，用户投诉。

(然后软件工程师反思如何修复)

# 什么是闪购系统

上面的例子是一个典型的闪购系统。它通常具有以下特征:

1.  大量用户同时进入系统，导致流量激增。(早上 6 点开始售票，6:30 结束)
2.  订购请求的数量远大于库存规模。(100 万用户争夺 1 万张门票)

# 挑战是什么

1.  读取时处理负载。用户将不断刷新页面以查看可用库存。也有可能所有用户会同时请求其他类似的资源，如帐户、商品描述等。
2.  提供高吞吐量。对于有限的库存记录，将会有许多并发的读取和写入，因此数据库锁可能会导致某些请求超时。
3.  避免库存超卖或低价出售。如何处理可用库存数？如果多个请求保留了相同的库存，则某个项目可能会超卖。如果库存处于暂挂状态，但流程失败且库存未释放，则产品可能会销售不足。这种情况发生在一些电子商务网站上，通常他们会打电话给客户退款。
4.  防止用脚本作弊。用户可以编写一个脚本来循环触发请求。所以这个用户可能会产生许多重复的请求

# 设计考虑

1.  来自上游的限制要求:我们库存有限，即使 100 万用户来，也只能服务其中的 1000 个。可以减少用户不必要的请求数量？
2.  分流流量:根本原因是我们要求用户同时来，造成秒杀。能不能把销售分成不同的时间段，邀请不同时间段的用户？
3.  异步处理:我们需要立即处理请求吗？或者我们可以接受请求，以我们的系统可以支持的速度处理它，并在可接受的时间内通知用户？
4.  缓存、缓存、缓存:对从不/很少更改的资源进行多次重复读取。我们能把它们保存在缓存中以减轻数据库的负荷吗？
5.  理解权衡并做出牺牲:我们真的需要显示实时库存吗？我们一年只有一次闪购，投入这么多资源有意义吗？
6.  数据库设计:同一问题的不同模式设计会有不同的权衡。
7.  可伸缩性:我们能够横向扩展以支持更多用户吗？

# 分层优化

## 客户

当用户提交请求后没有得到即时响应时，他们会一次又一次地点击按钮。但是，这些请求是重复的，会给系统带来不必要的负载。(想象一下，每个用户再提交 9 个请求，那么系统收到的 90%的请求都是多余的)

我们能做的是:

1.  提交后禁用提交按钮
2.  仅在最近 1 分钟内没有重复请求的情况下发送请求。

这将减少来自客户端的大部分不必要的请求，但是，它并不阻止用户编写脚本来绕过客户端的限制。因此，我们需要做更多的工作。

## 门

当一个请求到达网关时，我们跟踪同一个用户的请求号。简单有效的解决方案是在内存中为每个用户 ID 保留一个计数器。

如果该用户最近发出了相同的请求，我们可以放弃请求或返回相同的响应。

但是，如果这个用户创建了数千个用户帐户呢？我们将在服务层处理它。

## 服务

现在到达服务层的请求少了很多。我们开始处理吧。

1.  ***管理可用库存***

我们需要做的第一件事是检查可用库存。我们如何获得剩余的库存规模？

如果我们使用类似于`COUNT`的聚集来查询数据库，首先，我们可能需要为影响性能的事务设置一个`serialisable`隔离级别。如果我们不应用这种隔离级别，我们可能会以幻像读取结束，并认为我们仍然有足够的库存请求，然后我们销售超过我们所拥有的。

为了解决这个问题，我们可以使用一个具有原子性的计数器。当需要处理请求时，Redis 将是原子减量的一个好选择。

***2。带消息队列*的缓冲区**

处理交易可能会非常复杂和繁重。例如，根据用户的忠诚度积分自动应用促销。

因此，让我们使用消息队列来缓冲请求，并让服务以自己的速度处理它。

## 数据库ˌ资料库

现在，到达数据库的请求数量已经大大减少到可接受的数量。

我们可以专注于设计更好的模式，优化查询，也许还可以对表进行分片。

# 讨论

> 所以现在我可以直接把这个设计复制到我的项目里了？

不。首先，这取决于你的要求。其次，你可能不需要花费这么多的努力，可能有其他更好的方法。

# 结论

这篇文章是一个简短的 flash 销售系统设计的案例研究。它为正在解决类似问题的人们提供了一个通用的指南和可能的启发。