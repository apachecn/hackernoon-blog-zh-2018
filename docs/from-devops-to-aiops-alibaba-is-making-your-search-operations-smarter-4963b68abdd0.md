# 从 DevOps 到 ai ops——阿里巴巴让你的搜索操作更智能

> 原文：<https://medium.com/hackernoon/from-devops-to-aiops-alibaba-is-making-your-search-operations-smarter-4963b68abdd0>

*AIOps 是一个快速发展的领域，但是 AIOps 平台仍然面临着效率、可靠性和成本的挑战*

![](img/d357ccf94bc3e3ebadffa024f8a32430.png)

*本文是* [***搜索 AIOps***](/@alitech_2017/aiops-for-alibaba-search-operations-765854c60752) *迷你系列的一部分。*

# 背景

AIOps，一个曾经代表“算法 IT 操作”的术语，最近采用了一个更热门的名字:IT 操作的人工智能。但是顾名思义，AIOps 是基于人工智能技术和算法的 IT 操作。

搜索服务的快速发展已经将搜索系统转变为名副其实的平台。这一过程首先经历了从手动操作到自动化脚本操作，然后最终到开发运维的转变。然而，大数据和人工智能技术的快速进步使得常规运营和解决方案越来越难以满足需求。

为了以更低的成本提高平台的效率和可靠性，阿里巴巴推出了两款变革性工具——鹰眼和火炬。Hawkeye 是一个在线服务优化解决方案，Torch 是一个容量规划平台。

# 利用鹰眼实施 AIOps 智能诊断和优化

鹰眼主要通过智能诊断和优化来提高效率和可靠性。鹰眼架构在下图中有详细描述:

![](img/9717f53c0922f60fce8e405256d76487.png)

Hawkeye 有三个主要层:分析层、web 层和服务层。

**分析层**

该层本身分为两个部分:

鹰眼-眨眼

底层分析的工程部分，基于 Blink 处理数据，主要关注访问日志分析和完整数据分析。主要分析底层数据，该工程部分使用 Blink 强大的数据处理能力来分析搜索平台上所有 Ha3 应用程序的访问日志和完整数据。

鹰眼体验

一键诊断的工程部分。以 Hawkeye-blink 的分析结果为基础，Hawkeye-experience 进行更贴近用户的分析，如字段信息检测(包括字段类型合理性、字段值单调性)。kmon 失效警报、烟雾情况记录、引擎降级配置、内存相关配置、推荐的副本/分区号和切换时的最小服务副本，以及其他检测功能也在本节的服务范围内。

Hawkeye-experience 的工程目标是搜索引擎诊断规则的中间地带，将操作人员的宝贵经验整合到系统中。这样，每个新的应用程序都可以立即获得这些体验，而不是一路上遇到一大堆障碍。我们的目标是给每个用户一个角色(如智能诊断专家)来优化他们的引擎。描述鹰眼经验如何处理数据的流程图如下所示:

![](img/d88a1c5de99e8ed2989747ba31e2deb3.png)

**网页层**

该层在各种 API 和可视化监控表中输出鹰眼分析结果。

**服务层**

这一层为鹰眼分析和优化提供 API 输出。

阿里巴巴基于上述架构实现了以下诊断和优化功能:

资源优化:引擎锁内存优化(无效字段分析)、实时内存优化等等

性能优化:TopN 慢速查询优化，buildservice 资源配置优化

智能诊断:常规检查和智能问答等

下面几节详细介绍了每个优化的关键功能，即锁内存优化、慢速查询分析和智能问答。

## 锁定内存优化

对于 Ha3 引擎，引擎字段分为反向索引(索引)、正向索引(属性)和摘要索引(摘要)。引擎的锁定策略可以设置为通过这三个索引锁定内存或解锁内存。锁内存的优势是不言而喻的，即更快的访问和更低的 rt。但也很有可能在 100 个字段中，只有 50 个字段在几个月的时间内被访问，而其他字段在索引中的访问记录为零，这是对内存的巨大浪费。为了避免这种情况，Hawkeye 进行了分析和优化，缩减了标题应用程序的索引。下图显示了锁内存优化的过程——该过程总共节省了数百万元人民币。

![](img/51b7e9124cd887efa0f4da76f765ea64.png)

## 慢速查询分析

慢速查询数据来自应用程序的访问日志。查询次数与页面浏览量相关，页面浏览量通常为数千万或上亿。从海量日志中获取 TopN 慢速查询属于大数据分析的范畴。依托 Blink 的大数据分析能力，采用分而治之+ hash + min-heap 的方式获取 TopN 慢查询。这个过程首先解析查询格式并获取查询时间，然后获取解析后的 k-v 数据的 md5 值，并根据 md5 值进行分片。在每个分片操作中，计算 TopN 慢查询，得到所有 TopN 值的最终 TopN。根据分析的 TopN 慢速查询做出的个性化优化建议被推送给用户，以帮助他们提高引擎查询性能，这是增加引擎容量的间接方式。

## 一键诊断

健康得分是阿里巴巴衡量引擎健康状况的指标，告诉用户他们的服务有多健康。诊断报告指定了诊断时间，提供了不合适配置的描述和详细信息，并强调了优化的好处。下面显示的是诊断逻辑和一键诊断后的故障结果页面。由于篇幅限制，此处未显示诊断详细信息页面。

![](img/a74d35c8910129b695b44bc8b451619b.png)![](img/426c8ab090174ab753bb798f4a326a3d.png)

## 智能问答

越来越多的应用程序导致平台上出现越来越多的问题。在回答这些问题时，很明显有些问题被反复询问，比如那些关于停止增量和公共资源警报的问题。可以在既定程序中处理的问题可以用 chatOps 来构建，之后可以由一个回答机器人来处理。目前，Hawkeye 结合了 kmon 指标和可定制的警报消息模板，并通过向警报文本添加诊断来处理这些问题的智能问答。用户可以将报警信息粘贴到问答群和@机器人。然后他们会收到警报的原因。

# 使用 Torch 实施 AIOps 优化的容量管理

虽然 Hawkeye 提高了效率和可靠性，但 Torch 专注于通过容量管理降低成本。搜索平台应用的数量正在增长，并且必须适当地解决几个问题(如下所述)。否则，资源的使用效率低下，浪费严重。

1.商家随意申请容器资源，造成不可避免的浪费。需要向他们展示如何申请资源(包括 CPU、内存和磁盘)来帮助最小化容器成本。另一种选择是阻止用户管理他们的资源。

2.企业一直在扩张和收缩，没有人知道他们真正的在线能力。可以支持的 qps 限制是多少？当企业面临更高的流量时，是否需要扩展容量？如果确实需要，有哪些扩容方案？应该扩展副本还是增加单个容器的 CPU？当企业需要更多数据时，最好的行动计划是什么——拆分列或增加单个容器的内存？这些问题都需要回答。

让我们假设一个场景，其中当前使用的资源是 kmon 数据。在线系统的状态报告给 kmon。但是这里有一个想法:直接使用 kmon 数据进行容量估计怎么样？

实验发现这还不够。许多在线应用程序运行在较低的级别，因此在较高的级别安装容量是不现实的。这就是为什么需要进行压力测试来更好地了解性能。现在的问题是在哪里进行压力测试？在线压力测试有风险，预发布压力测试不能提供在线容量的真实情况，尤其是考虑到有限的预发布资源和糟糕的设备配置。这就是克隆模拟的用武之地。为压力测试克隆单个在线实例既准确又安全。因此，有了压力测试数据，下一个任务是通过算法分析找到最便宜的资源配置。然后，任务管理模块可以管理每个任务，并自动估计它们的容量。

这是建议的解决方案:

![](img/f0d924b96c02646ff8f9a0e39133577c.png)

以下部分详细介绍了该解决方案的系统架构、如何在该架构中实现克隆模拟，以及压力测试和算法服务。

## 系统结构

![](img/e63bd2dd2ef5ee78cc5161d8f05f7f73.png)

如果你看看图的底部，接入层似乎是跳出来的。要接入一个平台，只需提供平台上所有应用的应用信息和集群信息(目前只接入 TISPLUS 上的 Ha3 和 sp)。应用管理模块将整合应用信息。接下来，任务管理模块将把每个应用程序抽象成容量估计任务。

容量估计的过程如下。首先，克隆一个实例，然后对其进行自动压力测试，直到达到极限容量。然后，压力测试数据和日常数据在数据工厂中格式化，并提交给决策中心。决策中心使用压力测试数据和日常数据来估计算法服务的容量，并确定收益。如果收益可观，决策中心会考虑算法和容量优化建议，以执行克隆压力测试进行验证。如果验证结果为“通过”，则结果将被永久存储。如果结果是失败，将进行简单的容量估计(通过考虑压力测试中发现的性能限制来粗略估计容量)。一旦容量评估通过或失败，决策中心就会清除应用于克隆或压力测试的临时资源，从而有助于避免浪费。

图的顶部是应用层。考虑到 Torch 容量管理不仅仅针对 TISPLUS，应用层提供了容量指标、容量估计、容量报表和增益指标，用于以嵌入式方式切换到其他平台。还提供了容量 API 供其他系统调用。

容量估计还依赖于搜索许多其他系统，如 maat、kmon、Hawkeye、drogo 和 cost 系统，这些系统组合在一起形成一个闭环。

## 架构实施—克隆模拟

简单地说，克隆模拟是应用程序在克隆线上的单个实例。Ha3 应用程序是关于克隆整个副本和 sp 的独立服务。现在强大的搜索武器 hippo 已经出现，资源正以容器的形式被使用。像 suez ops 和 sophon 这样的 DevOps 平台的兴起也使得应用程序的快速克隆成为现实。以下是克隆管理模块的一些具体步骤:

![](img/1fdacfbfde0dd403cc6e8d7f405f4cf4.png)

克隆有两种类型:浅层克隆和深层克隆。浅层克隆主要适用于 Ha3 应用，利用影子表直接提取主应用的索引，省略了加速克隆的步骤。对于深度克隆，克隆的应用程序需要离线构建。

克隆的优势是不言而喻的:

服务隔离:真实的在线容量可以通过对克隆环境进行压力测试来估计。

可以通过压力测试在克隆环境中验证资源优化建议。

使用后，克隆的环境自动释放，不浪费在线资源。

## 压力测试服务

考虑到日常 kmon 数据大多缺乏高级指标，并且在没有实际压力测试的情况下无法确定真实的发动机容量，因此需要压力测试服务。对阿里巴巴的亚马逊压力测试平台和阿里妈妈压力测试平台的早期调查发现，这两个平台都无法满足自动压力测试的需求。因此，阿里巴巴开发了一种基于 hippo 的自适应分布式压力测试服务，增加了一个工人来施加压力。

![](img/5a949d06f87aa409a02219daeb464103.png)

## 算法服务

容量估计的目的是最小化资源成本，提高资源利用率。这有一个前提条件，即资源必须可以用成本来量化。成本是作为平台运行搜索和评估平台价值的一个重要维度。因此，阿里巴巴搜索团队与财务人员一起制定了一个满足这一前提条件的价格方程。算法团队进行的大量实验分析发现，这可以转化为带有约束的规划问题:

优化的目标函数是价格方程(包括内存、CPU 和磁盘等变量)。

约束是所提供的容器的规格和数量必须能够保证最小的 qps 内存和磁盘。

# AIOps 的未来是什么

在 TISPLUS 搜索平台上推出 Hawkeye 和 Torch 降低了成本，提高了效率和可靠性，并增强了阿里巴巴将 AIOps 应用于其他在线系统的能力。下一个目标是将 Hawkeye 和 Torch 整合到一个 AIOps 平台中，并让其他在线服务享受 AIOps 的好处。因此，开放性和可访问性成为该平台最重要的两个焦点。

为此，下一个主要步骤是构建以下四个操作库:

度量库

标准化和集成在线系统日志、监控指标、事件和应用程序上的信息，以确保轻松获取各种运营指标。

知识图书馆

基于专家系统积累的一组问题和日常问答会话的经验，提供搜索和计算功能，促进类似在线问题的自动诊断和自我修复。

组件库

模块化克隆模拟、压力测试和算法模型，允许用户灵活选择算法来实施策略，并使用克隆模拟和压力测试来验证有效性。

策略库

通过允许用户使用画布功能拖动和编写 UDP，使用户能够快速实现其系统的操作策略。度量库、知识库和组件库提供了多样化的数据和组件，便于实施操作策略。

如果建立了上述基础设施并与策略相结合，就可以产生来自各种操作场景的数据。这可以用于故障排除、智能问答、容量管理、性能优化以及不同场景中的其他应用。

![](img/d5de9261916fade50fac8e1ac709784b.png)

如果有一件事是肯定的，那就是要让世界摆脱糟糕的搜索引擎还有很长的路要走。从 SaaS 容量到将搜索算法视为产品，以及云上的 DevOps 和 AIOps，未来仍有许多挑战。

(Original article by Cai Yunlai 蔡云雷 & Li Xuefeng 李雪峰)

# 阿里巴巴科技

关于阿里巴巴最新技术的第一手深度资料→脸书: [**“阿里巴巴科技”**](http://www.facebook.com/AlibabaTechnology) 。推特: [**【阿里巴巴技术】**](https://twitter.com/AliTech2017) 。