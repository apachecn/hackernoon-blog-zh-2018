# 从创业到网络规模:对规模的温和介绍

> 原文：<https://medium.com/hackernoon/from-startup-to-web-scale-a-gentle-introduction-to-scaling-22612beedcdd>

![](img/bca1d4cfa863def960f416721916aabc.png)

这篇文章温和地介绍了扩展 web 服务的概念以及它所经历的不同阶段。后续的帖子将会有更多关于这里介绍的这些概念的细节。

# 开始

在一个晴朗的日子里，你想到了创建一个有助于在线销售产品的网站的想法。你知道一些你在学校学过的编程语言，你也有数据库的基础知识，你可以很快学会一些技巧来制作一个网页。你花了几个小时思考用例，设计数据库表，实现细节，创建一个与应用程序交互的前端用户界面，进行基本测试，并托管应用程序供公众使用。

你与你的朋友分享细节，他们中的许多人喜欢它并开始使用它。你开始看到涓涓的车流。

## 想知道它做得怎么样和分析的好奇心

你知道数据库的细节，所以你只需要做一些查询就可以知道有多少人使用过它，人们对什么样的东西感兴趣。但是，每次查询都很困难。所以你开始整理一个分析页面，在那里你可以很容易地得到这些细节。

## 用户群的增长和一次性错误

这款应用变得流行起来。更多的车辆进来了。你的许多朋友抱怨说他们很少随机看到错误。您意识到您没有添加太多日志记录，并且没有简单的方法来发现他们面临的问题。

**记录和调试**

您构建了一个基本的日志策略。您将大多数日志写入文件，在某些情况下写入数据库本身，以便以后收集信息。

**监控和报警**

您已经记录了足够的日志，正在等待下一组失败。这个错误几个小时后才显现出来。您继续定期查看日志，但它就是拒绝返回。因此，现在您编写另一个脚本，它将继续监视日志，并在出现任何问题时发送电子邮件。几个小时后，你会收到第一个警报。有足够的细节来解决这个棘手的问题，在接下来的几个小时里，所需的代码将会推出。你准备告诉你的朋友你已经解决了问题，但是你得到了一个惊喜。朋友本人在给你打电话。看来要么是他自己发现了，要么这就是所谓的心灵感应。你兴奋地接起电话，但似乎还有更多坏消息。这位朋友告诉你，以前只有很少的东西会随机失败，但是现在什么都不用了，而且服务器好像也坏了。

## **可用性问题和高可用性规划**

似乎当你试着推出代码的时候，服务器坏了。听起来很蠢，但你已经做到了。你想尽快摆脱这种混乱。您决定在添加任何新功能之前准备好基本冗余。

## 负载平衡和部署策略

你的策略很简单，你想在多个机器上托管服务器/应用程序。你听说过 nginx。您快速设置了一个 nginx 反向代理和代理后面的几个框。您还决定，下次升级代码时，您将通过删除一个盒子从流量中删除该盒子，然后升级该盒子并将其放回流量中，并对其他盒子重复相同的操作。

这解决了你当前的问题。但是你不想仅仅停留在当前的问题上，而是想弄清楚还有什么需要减少的。你不用想太多，你知道数据库是另一个主要的瓶颈。

## 数据库复制、定期备份和后备设置

因此，您决定定期备份数据库，并设置一个后备冗余数据库设置。

所有这些都需要几个简单的脚本，您只需将这些自动化脚本添加到相同的代码库中。

## 老化的代码库和重构的需求

随着所有这些代码被添加到同一个地方，代码开始增长。你在代码中有一些独立的东西:部署脚本，监控和警报脚本，分析查询，用户界面，管理功能和你的主要功能应用程序。代码库已经开始显示出它的年龄。

在为时已晚之前，您希望根据功能拆分代码库，然后开始将它们放在单独的文件夹中，并根据其所属的领域进行命名。

你的朋友很开心。大家都在竖起大拇指。

## 更多功能和进一步发展

你的应用继续获得越来越多的关注和高点击率。客户要求小而多的新功能。以客户为中心一直是你的优势。你要确保他们每个人都满意。你已经照顾到了他们所要求的所有大小功能。

缓慢但肯定的是，你的代码变得越来越混乱。

## 不完整的功能、测试策略和环境

随着几个特性的发布，考虑所有的用例变得很困难。愚蠢的错误开始频繁出现，破坏了主要功能。不满意顾客是你不喜欢的。是时候关注最佳工程实践了。虽然你已经做了单元测试和一些功能测试；缺少端到端测试。您决定编写多个覆盖整个用户体验的端到端测试。您意识到，这些测试需要数据库设置、服务器设置等等。现在是投资测试环境的时候了，在测试环境中，您可以复制整个生产设置并运行测试。良好的测试环境和可靠的测试策略正在显示结果。顾客又开心了。

满意的顾客意味着更多的机会和更多的要求。

## 进一步增长

越来越多的新功能被问到。有发送日终报告、月报、电子邮件、文本等的要求。很少的功能需要与支付处理器，会计和更多的集成。

## 域隔离

有了这么多不同的特性，维护代码库变得很困难。你雇了几个人来帮你。很多沟通障碍，人们互相踩着对方的脚。有不同的专业领域，如交易，用户界面，会计等。

你决定把这个应用分成多个小的应用。每一个都专注于一个领域。

这些应用程序将有单独的代码库，并由不同的开发人员/团队拥有。您决定所有这些应用程序都需要独立部署和运行。

## 服务和服务合同

对于多个应用程序，您希望确保端到端功能正常工作。所以你在这些服务之间签订了合同，所有这些服务都应该严格遵守合同。

## 异步任务、批处理和守护进程

也有离线报告和定期电子邮件的要求。您希望编写定期运行的批处理。每天运行一次的批次很少，频率更高的很少，频率更低的也很少。您还需要异步完成需要较长时间完成的任务。你不希望你的顾客盯着屏幕上的纺车。因此，您开始投资守护程序和消息队列。服务将进行基本的验证，确保请求能够得到满足，并执行一组基本的强制步骤，然后不是立即处理非必要的内容(如发送电子邮件、文本等)，而是以特定的格式序列化请求，并将它们添加到队列中，并以状态“成功”和“等待完成非必要的内容”进行响应。UI 将使用此响应向客户表明请求已成功处理，稍后将异步处理文本和电子邮件。守护进程将挑选它们，并在以后处理长时间运行的活动和不必要的东西。它还会将操作结果推送到电子邮件/移动文本，并在数据库中更新。UIs 将从数据库中选择最新的状态，因此客户不必等待结果

一旦所有这些基础架构变更都完成了，事情看起来就很好了。

很少有人抱怨反应慢，但总的来说事情看起来很稳定。

## 负载问题和数据库扩展

有了最初的一些抱怨，你就开始探索如何改进来消除这些抱怨。您从基本的查询优化开始，但是随着时间的推移，响应缓慢的问题开始越来越频繁地出现。

## 索引、分区和归档

仔细分析显示，一些错误的查询正在进行全表扫描，您很快就会发现正确的索引会有所帮助。渐渐地，很明显，使用的增长是巨大的，仅仅索引是没有用的。您意识到，自应用程序启动以来，您仍然将所有数据保存在同一个数据库中，并且清理可能是一个选项。因此，您决定对数据进行分区。有几个表是按月分区的，有几个是按日分区的。您还决定制定数据保留和归档政策。

实施过程中出现了一些小问题，但值得一试。

随着每个分区数据量的减少，查询变得更快，您再次拥有了满意的客户。这也意味着增长趋势还在继续。

## DB 分割

随着持续增长，数据量再次开始成为瓶颈。即使在查询调优、优化和硬件升级之后，也没有其他选择，只能拆分数据库。

虽然早期的数据库优化本质上是孤立的，不会影响代码的其他部分，但这次不一样了。

大多数代码都假设，所有的表都在同一个数据库中，所以你不必担心事务性，默认情况下数据库能够提供所有这些。随着多个数据库和图片模式，它不会是相同的。因此，您需要重新查看整个代码，以理解哪些表被一起访问、一起读或写，然后相应地分组。任何不符合新设计模式的地方，要么你不得不改变代码或设计，要么你不得不修改。这个练习比你想象的更痛苦。但这也验证了你的领域分离思想。虽然属于一个域的大部分数据都被正确地放置在相应的模式中，但是很少有模式/表可以跨域共享。

## 读/写服务和缓存

您认为多个位置的直接数据库访问导致了问题。少数关键数据库/模式总体上变得相当热，甚至在拆分后仍有大量负载。您已经开始研究是否可以将读取和写入分开，并从两个不同的实例提供服务。您还意识到这样做可能会导致复制延迟可能会给客户带来困惑/问题的情况。您瞄准了内存缓存解决方案。所有写入都将同时发生在数据库和缓存中。读取将首先通过缓存进行，对于部分用例，如果需要，还可以从只读数据库实例中读取。如果数据在高速缓存中不可用，那么只有它会转到只读数据库实例。这也意味着从不同的地方直接访问数据库不是一个好主意，所有的数据库读写都应该通过服务来进行，这些服务知道什么时候从缓存中查找，什么时候查找数据库。

有了这一改变，数据库的健康状况看起来不错。读取和写入是分开的，缓存在减少数据库读取查询命中方面帮助很大。

你的应用程序继续吸引更多的客户和指数流量。随着批处理和面向客户的 API 的引入，峰值负载是平均负载的几倍。

## 延迟写入、日志记录和最终一致性

在交通高峰期，这个数据库看起来很脆弱。如果你能以某种方式将高峰负荷分配到非高峰时间，你应该是不错的。您正在尝试找出如何在峰值负载的情况下延迟写入。您提出了一个非常简单的队列和守护进程解决方案。你总是写一个临时数据库，然后一个守护进程从这个临时数据库中获取数据并写入主数据库。在写入临时数据库之前，通过验证数据来确保数据是好的，基于数据的应用程序逻辑也会更新缓存，以防有人需要立即使用数据。您还知道，对于临时数据库表，日志记录将是一个好主意；以防需要任何回滚。因此，您还确保了临时数据库表是 insert，这与仅追加日志非常相似，在这种情况下，您从不更新行，并且总是为每个操作添加新记录。这种方式有助于您协调这些记录，还提供了一种方法，在回滚的情况下，通过执行语义上相反的操作来执行回滚。现在，您将拥有多个临时数据库表，而不是一个成为瓶颈的主数据库，因此消除了瓶颈。守护进程总是以定义的速度拾取，并以相同的速率写入主数据库。在出现峰值的情况下，所有负载仍然局限于临时数据库，主数据库写入仍然保持相同的速度。您知道在流量高峰期间，对主数据库的实际写入可能会延迟一点。为了同时处理读取，您已经写入了缓存。您的读取服务假设如果缓存中有数据，那么它将是最新的数据，所以从缓存中读取，否则从数据库中读取。

这解决了您的高峰交通问题。尽管你的代码需要更多的数据验证，但是这些验证中有许多是不明确的，你真的必须进行大量的中断和修复来使其工作。一旦完成，你就解脱了。现在，主数据库可以更定期地维护，而不用担心流量下降。

但故事并没有到此结束。

你的应用增长势不可挡！

它继续以惊人的速度增长，似乎每秒写入主表的键模式的数量远远超过了平均建议数量。写实例再次热运行，您需要做些什么。

## 数据库分片

每个数据库只能承受有限的负载，即使升级了硬件，您也看不出它能适应您需要的规模。您做了一些研究，发现唯一的解决方法是拥有多个数据库，每个数据库服务一小部分工作负载。你喜欢这个想法。您刚刚完成了分析，似乎发现您需要一个分片键来决定数据需要写入哪个目标数据库或从哪个目标数据库读取。你已经有了访问数据库的读写服务，所以对你来说会简单一点。您已经分析了所有的读写模式，并发现可以基于帐号共享数据库。您将确保所有读取查询都将帐号作为一个键。同样，每一笔交易都必须有一个账号。您还将在物理碎片和逻辑碎片之间进行分离，这样您可以从较少数量的物理数据库开始，但最终在需要时扩展到更多的数据库。

这样你就达到了你的应用程序可能拥有的最大规模的极限。

如果你需要更大的规模，也许下一个选择就是拆分你的公司！

**参考文献:**

[](https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-load-balancing) [## 如何设置 Nginx 负载平衡|数字海洋

### 负载平衡是一种有用的机制，可以在几个有能力的虚拟专用服务器之间分配传入流量。由…

www.digitalocean.com](https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-load-balancing) [](https://www.infoworld.com/article/3198149/application-development/microservices-need-to-honor-contracts.html) [## 微服务需要履行合同

### "狐狸知道许多事情，但是刺猬知道一件大事."阿奇洛库斯说在公元前 700 世纪后，Unix…

www.infoworld.com](https://www.infoworld.com/article/3198149/application-development/microservices-need-to-honor-contracts.html)  [## 强制 com-developer.force.com 中的异步处理

### 为了确保有足够的资源来处理突然增加，排队框架将监视系统…

developer.salesforce.com](https://developer.salesforce.com/page/Asynchronous_Processing_in_Force_com) [](https://softwareengineering.stackexchange.com/questions/354911/microservices-handling-eventual-consistency) [## 微服务:处理最终一致性

### 根据我对最终一致性的理解，所有这些服务(消费者)将在…

softwareengineering.stackexchange.com](https://softwareengineering.stackexchange.com/questions/354911/microservices-handling-eventual-consistency) [](https://en.wikipedia.org/wiki/Eventual_consistency) [## 最终一致性-维基百科

### 最终一致的服务通常被分类为提供基础(基本可用、软状态、最终…

en.wikipedia.org](https://en.wikipedia.org/wiki/Eventual_consistency) [](https://www.citusdata.com/blog/2018/01/10/sharding-in-plain-english/) [## 用简单的英语解释数据库分片

### 您的指南，以了解如何分片工作的关系数据库，以及如何可以用来转换一个…

www.citusdata.com](https://www.citusdata.com/blog/2018/01/10/sharding-in-plain-english/)