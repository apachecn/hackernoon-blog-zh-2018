# 从数字海洋，到 AWS，到 Heroku。

> 原文：<https://medium.com/hackernoon/hard-up-for-hosting-from-digitalocean-to-aws-to-heroku-db15a063fa94>

![](img/dd55d7b54a7db7da2d879e0706afc97b.png)

今年是 2016 年。我是一个业余爱好者，有很多想法。很自然，我需要一个便宜的主机提供商来运行我最新的网络应用。我该从哪里开始？谁会被证明是难以捉摸的“最性感的女主人？”

这是我在 DigitalOcean、AWS 和 Heroku 之间迁移的故事——试错、利弊和痛点。你已经看过典型的英雄故事。现在系紧你的腰带，给你的剑上油。准备亲身体验一个简单的乡村爱好者的史诗般的故事——以及他对合适主人的追求。

# 背景:想法和应用程序。

[我喜欢跑](https://tygertec.com/run-better-code/)。在准备下一场比赛时，我遵循了一个训练计划，但所有的训练计划都有一个共同点:它们为不同类型的跑步规定了不同的配速。例如，我被期望根据我是去“轻松”跑、“长距离”跑还是“长距离”跑来调整我的配速。但是什么是*是一次“轻松”的跑步？给我以分钟/英里为单位的数字——我怎么知道什么时候达到了目标？为了找到答案，我会根据一个跑步者最近的 5000 米比赛时间查阅配速表，并写下我为一次预定的跑步指定的配速。*

*手动在起搏图表中查找起搏既乏味又无聊。所以我写了一个 app 帮我做: [RunbyPace](https://www.runbypace.com/) 。无论我在哪里，我都可以查找给定跑步类型的规定配速，并立即开始跑步。*

*但是我应该在哪里托管我的应用程序呢？我不想花太多钱。我为它做了每月 5-10 美元的预算。我的搜索始于数字海洋。*

# *数字海洋托管:节省(和斗争)是真实的。*

*数字海洋是一个伟大的开始。他们的 droplets 预装了不同类型应用的必备工具。在我的例子中，我有一个 rails 应用程序，所以 Ruby、Postgres、Bundler、Unicorn 和 Nginx 都是预装的，可以在 Rails 上运行。我经历的最大的痛点围绕着更新——保持操作系统补丁，更新 Ruby 生态系统，以及推送应用程序本身的新版本。由于液滴的内存有限，这都是手工操作，非常困难。*

# *数字海洋专业版*

*   *不贵，每月 5 美元。*
*   *容易上手。*
*   *许多写得很好的指南。*

# *数字海洋公司*

*   *我不得不**自己管理一切**，包括 Nginx、SSL/TLS 证书，而不是开发新的应用功能。*
*   ***手动更新**。操作系统更新是一个手动过程。我配置了一个 Cron 作业来自动安装安全更新，这有点帮助，但仍然。*
*   *Ruby 生态系统的更新也是手动的。*
*   ***手动展开**。发布新版本的应用程序不是一键操作的事情。我不得不 ssh 到虚拟机，手动运行我的脚本。*
*   ***可用性。**只有*一个*小滴，所以可用性一般。更新和新的应用程序版本意味着应用程序暂时离线。*
*   ***缩放。**结垢的唯一可能性是垂直的，有更大的液滴。*
*   ***限位闸板**。基本的 droplet 只有 512MB 内存，只够基本操作使用。为了完成耙子任务，我必须杀死独角兽。*
*   ***生产和开发之间的环境差异**让我害怕对应用程序进行大的改动，因为我不确定它们是否能在生产中发挥作用。我经常推迟发布。*

*DigitalOcean 让我前进，但发布新功能的痛苦让我想要更自动化、更强大的东西。我对尝试 AWS 产生了兴趣。*

# *用 AWS 托管:没有人会访问你的站点，但是每个人都可以——如果他们想的话。*

*在我的数字海洋体验之后，我决定尝试一下 AWS。我注册并获得了 AWS 免费层的资格，这意味着我可以以有限的成本享受一点乐趣——但只有一年。*

# *AWS 的目标*

*由于对 DigitalOcean 记忆犹新，以下是我对 AWS 的目标:*

*   *开发和生产环境之间的平衡。*
*   *高可用性，即使在更新、发布和部署失败时也是如此。*

# *AWS 上的架构*

*我全力投入 AWS 生态系统。我把我的 runbypace.com 域名转移到了 AWS Route 53，并使用了他们的 DNS 基础设施。DNS 将访问者导向弹性负载平衡器(ELB)，然后将访问者导向 EC2 实例，这些实例在弹性容器服务(ECS)之上运行 Nginx 和 my Rails 应用程序的 dockerized 版本。在后端，我们在 AWS RDS 上运行 Postgres。AWS 还为我办理了 SSL 证书。*

```
*# AWS architecture diagram       Route 53 
         |
   Elastic Load Balancer
      |          | 
   ec2/ecs    ec2/ecs
   (nginx)    (nginx)
   (rails)    (rails)
        |      |
       PostgreSQL*
```

# *AWS 优点*

*   ***成本**。在免费层，整个强大的世界级架构每月仅花费我大约 11 美元。这主要是由于第二个 t2.micro 实例。*
*   ***轻松部署**。一旦基础设施就绪，我编写了部署脚本，我就可以用一个命令部署新版本的应用程序。*
*   ***通过容器进行开发/生产奇偶校验**。在我的 dev box 上，我只需要运行`docker compose up`并开始编写代码。因为应用程序是容器化的，所以我有信心，如果它能在我的机器上工作，它也能在云中工作。不过，正如你将在“缺点”一节中看到的那样，它并不是 100%无缝的。Dockerfiles 使得打包和部署我不想开源的资产和工件变得非常容易。*
*   ***供货情况**。我在 AWS 上运行网站的整个过程中，从未出现过一次宕机。当我推送一个新的应用程序版本时，ECS 会处理停止一个 web 任务，以便为新注册的任务腾出空间。一旦新任务通过健康检查，ECS 将停止其他 web 任务，并用新版本替换它们。整个过程天衣无缝。如果我做了一个愚蠢的举动，破坏了一些东西，新版本将无法通过健康检查，ECS 将继续运行旧版本的网站。*
*   ***更新管理少。如果你运行标准的 AMIs(亚马逊机器镜像),他们会为你处理安全更新。***

# *AWS 缺点*

*   ***成本，后自由层。**免费层到期后，我预计每月要为现有架构支付大约 50 到 65 美元。哎哟！对于一个只赚我 0 美元的业余爱好应用程序来说，这实在是太贵了。*
*   *AWS 文档有点漫不经心*
*   ***ECS 别扭**。当时，Kubernetes 还不在 AWS 上。ECS 是唯一的选择。等等，你的意思是我必须管理我的容器*和运行它们的虚拟机*？我只想把我的容器推到云端。没有简单的方法来自动伸缩 EC2 实例以响应来自 ECS 容器的压力？—我必须手动增加 EC2 实例的数量？呃。因此，如果我遇到大流量高峰，我最好能访问 AWS 控制台。*
*   ***仍然需要管理 EC2 实例。**同样，为什么我必须管理 EC2？为什么我在使用 AMIs 时必须手动更新 ECS 容器代理？*
*   ***开发/生产之间的应用配置差异。**对于本地开发，我将配置保存在`docker-compose`使用的`.env`文件中。对于生产，我将配置与 ECS 任务定义一起推送。当我添加或修改了一个`.env`配置，但忘记更新任务定义时，麻烦就来了。如果我多考虑一下，我想我可以自动完成这个。*

*AWS 非常强大，但也不是没有痛苦，痛苦机器即将达到每月 50 美元以上！我研究了 Elastic Beanstalk，它应该直接将代码部署到云中，而不需要管理 EC2，但是它也很贵！成本大概和我以前的 AWS 架构一样。因此，我们继续寻找合适的主机提供商——这次是 Heroku。*

# *Heroku 主持:到目前为止，一切顺利*

*我刚刚开始使用 Heroku，所以我仍然处于蜜月期，但目前为止事情看起来很好。价格符合我的需求，部署也不在话下。*

# *Heroku Pros*

*   ***价格。爱好 dyno 每月只需 7 美元。***
*   ***可扩展性**。显然，它既可以水平扩展(额外的 dynos)，也可以垂直扩展(更强大的 dynos)*
*   *摔死**简单自动展开**。现在我所要做的就是推送到主机，Heroku 就会自动部署到生产环境。*
*   *通过 **Heroku 构建包**构建配置。对于我的 AWS 设置，我使用 Dockerfiles 来调整我的构建设置。有了 Heroku，我可以很容易地创建自己的构建包。对于一些例子，见一个构建包，用于[将当前提交散列部署到任意路径](https://github.com/tygerbytes/heroku-buildpack-commithash)，另一个用于[将密钥库证明部署到任意目录](https://github.com/tygerbytes/heroku-buildpack-keybaseproof)。*
*   *免费 SSL 证书*

# *Heroku Cons*

*   *Google 域的裸域上的 **SSL 证书问题。离开 53 号公路后，我带 runbypace.com 回到谷歌域名。对于我的自定义域名`runbypace.com`，Heroku 要求我用指向`runbypace.herokudns.com`的`ANAME`记录来配置我的 DNS 提供商。*不幸的是* Google Domains 不支持`ANAME`记录……_ Google Domains 的解决方法是创建一个指向`www.runbypace.herokudns.com`的`CNAME`，然后创建一个合成记录将`@`重定向到`www`。*不幸的是*，这在 SSL 证书的某个地方发生了故障，导致`https://runbypace.com`拥有无效的证书，尽管`https://www.runbypace.com`工作正常。这是一个很大的遗憾，所以我现在改用 PointDNS，因为它支持`ANAME`记录。***

*随着我在 Heroku 获得更多的生活经验，我会报告新的发现。*

# *我的托管任务暂时告一段落*

*旅伴们，在寻找最佳主机提供商的过程中，我们又迎来了一个喘息的机会。我们见过 DigitalOcean，它不贵，但把安装和配置的负担留给了你。然后就是主持界的希尔顿，AWS。如果您需要巨大的可伸缩性和数十亿个 9 的可用性，它是您唯一的选择之一。如果你只是想做梦和部署代码，Heroku 似乎是最合适的，现在…一路平安，编码愉快！*

**原载于 2018 年 1 月 27 日*[*tygertec.com*](https://tygertec.com/hosting-digitalocean-aws-heroku/)*。**