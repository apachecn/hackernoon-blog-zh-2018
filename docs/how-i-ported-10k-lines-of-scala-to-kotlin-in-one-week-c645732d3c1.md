# æˆ‘å¦‚ä½•åœ¨ä¸€å‘¨å†…å°† Scala çš„ 10K ä»£ç ç§»æ¤åˆ° Kotlinï¼Ÿï¼

> åŽŸæ–‡ï¼š<https://medium.com/hackernoon/how-i-ported-10k-lines-of-scala-to-kotlin-in-one-week-c645732d3c1>

![](img/a78aff7b8108e2f06f4bf1d28e487ac9.png)

> ä¸Šå‘¨åœ¨ç§‘ç‰¹æž—ï¼Œæœ‰å‡ ä¸ªäº‹ä»¶â€”â€”å°†åœ¨ä¸‹é¢æè¿°â€”â€”å¼•å¯¼æˆ‘å°† Scala çš„ postgresql-async ç§»æ¤åˆ° [**jasync-sql**](https://github.com/jasync-sql/jasync-sql) ã€‚ä»ç„¶æœ‰è®¸å¤šç¼ºå¤±çš„éƒ¨åˆ†ï¼Œä½†æ˜¯ alpha ç‰ˆæœ¬æ˜¯å¯ç”¨çš„ï¼Œå·¥ä½œä»åœ¨è¿›è¡Œä¸­ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³åˆ†äº«æˆ‘æ˜¯å¦‚ä½•å°†ä»£ç ä»Ž Scala è½¬æ¢åˆ° Kotlin çš„ï¼Œä»¥åŠæˆ‘ä»Žä¸­å­¦åˆ°äº†ä»€ä¹ˆï¼Œè¿™æ ·å®ƒå¯ä»¥å¸®åŠ©å…¶ä»–å¼€å‘äººå‘˜å¤„ç†åŒæ ·çš„ä»»åŠ¡ã€‚

ä½†é¦–å…ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿ(è€Œä¹‹åŽï¼Œå¦‚ä½•ï¼Ÿ)

# ä¸ºä»€ä¹ˆï¼Ÿ

æˆ‘è½¬åˆ°äº† Outbrain çš„ä¸€ä¸ªæ–°å›¢é˜Ÿï¼Œæˆ‘çš„ä»»åŠ¡ä¹‹ä¸€æ˜¯åè°ƒæˆ‘ä»¬çš„æ¨¡å—ä»Ž Scala 2.10 å‡çº§åˆ° 2.11ã€‚äº‹å®žè¯æ˜Žè¿™æ˜¯å¯èƒ½çš„ï¼Œä½†æ˜¯è¿™æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼Œå› ä¸ºè¿™éœ€è¦æˆ‘ä»¬ä¸ºå¤šä¸ªå·¥ä»¶â€œä¿®è¡¥â€æˆ‘ä»¬æ‰€æœ‰çš„ JVM æ¨¡å—ï¼Œå¦‚è¿™é‡Œæ‰€æè¿°çš„ã€‚ç”šè‡³æˆ‘ä»¬çš„ Java æ¨¡å—ï¼å› ä¸ºå®ƒä»¬éƒ½ä¾èµ–äºŽ [ob1k-db](https://github.com/outbrain/ob1k/) ï¼Œè€Œ ob1k-db åˆä¾èµ–äºŽ pstgresql-asyncï¼Œè€Œ pstgresql-async åˆä¾èµ–äºŽå…·æœ‰ä¸åŒå·¥ä»¶çš„ Scala 2.10/2.11ã€‚

å› æ­¤ï¼ŒåŽ»é™¤æ‰€æœ‰å¤–éƒ¨æ¨¡å—ä¸­ Scala ä¾èµ–æ€§å¯èƒ½æ˜¯ä¸ªå¥½ä¸»æ„...ä½ çŸ¥é“æˆ‘æœ‰å¤šå–œæ¬¢ Scala å’Œ Kotlinï¼Œåœ¨æˆ‘ä¹‹å‰çš„æ–‡ç« ä¸­:

[](/@OhadShai/scala-pack-your-bags-kotlin-is-coming-5169f737cfe8) [## Scala -æ‰“åŒ…ä½ çš„è¡ŒæŽï¼›ç§‘ç‰¹æž—æ¥äº†ï¼

### TLï¼›DRâ€”â€”å¾ˆå¤šäººé—®æˆ‘ä¸ºä»€ä¹ˆæˆ‘è®¤ä¸º Kotlin æ¯” Scala æ›´å¥½ï¼Œæˆ–è€…ç›¸åï¼Œæ‰€ä»¥åœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘å°†â€¦

medium.com](/@OhadShai/scala-pack-your-bags-kotlin-is-coming-5169f737cfe8) 

æ­¤å¤–ï¼Œä¸Šå‘¨ï¼Œåœ¨ä¸€å¹´å¤šçš„ä¸æ´»åŠ¨ä¹‹åŽï¼Œç»ˆäºŽæœ‰ä¸€ä¸ª commit æ‰¹å‡†ä¸å†ç»´æŠ¤[postgres-SQL](https://github.com/mauricio/postgresql-async/commit/5716ac43818b6be0dc4fcc2b2655dde3411cdbe0)ã€‚è¿™æ˜¯æœ€åŽä¸€æ ¹ç¨»è‰ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ MySQL å¼‚æ­¥é£Žæ ¼çš„åº“ï¼Œå¹¶ä¸”æ²¡æœ‰æ‰¾åˆ°æ›¿ä»£å®ƒçš„æ’ä»¶ã€‚

ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜åŠ¿æ˜¯ Scala å’Œ Kotlin éžå¸¸ç›¸ä¼¼â€”â€”åœ¨ç‰¹æ€§å’Œè¯­æ³•æ–¹é¢â€”â€”æ‰€ä»¥å°è¯•ç§»æ¤[ä»£ç ](https://hackernoon.com/tagged/code)ç›¸å¯¹æ¥è¯´å¾ˆæœ‰è¯±æƒ‘åŠ›ã€‚

# æ€Žä¹ˆä¼šï¼Ÿ

åœ¨æˆ‘ä»¬æ·±å…¥æ‰€æœ‰é‚£äº›æ²¹è…»çš„è¯­æ³•ç»†èŠ‚ä¹‹å‰ï¼Œä¼‘æ¯ä¸€ä¸‹ï¼Œé€šè¿‡ä¸€æ¬¡è®¿é—®å’Œä¸€ä¸ªæ˜Žæ˜Ÿä¸ºæ–°çš„å¼€æºåº“åšè´¡çŒ®ðŸ˜‰ï¼š

[](https://github.com/jasync-sql/jasync-sql) [## jasync-sql/jasync-sql

### ç”¨äºŽ PostgreSQL å’Œ MySQL çš„å¼‚æ­¥ã€åŸºäºŽ Netty çš„ JVM æ•°æ®åº“é©±åŠ¨ç¨‹åºï¼Œç”¨ Kotlin - jasync-sql/jasync-sql ç¼–å†™

github.com](https://github.com/jasync-sql/jasync-sql) 

è½¬æ¢æœ¬èº«åˆ†ä¸ºä¸¤ä¸ªä¸»è¦æ­¥éª¤:

*   è‡ªåŠ¨é€è¡ŒæŸ¥æ‰¾å’Œæ›¿æ¢è„šæœ¬ï¼Œä»¥èŠ‚çœä¸€äº›è€—æ—¶çš„çŒ´å­æ‰“å­—ã€‚
*   æ‰‹åŠ¨æ£€æŸ¥æ–‡ä»¶å¹¶ä¿®å¤æ‰€æœ‰ç¼–è¯‘é”™è¯¯ï¼Œå†³å®šå¦‚ä½•è½¬æ¢å¹¶æ”¹è¿›è„šæœ¬ã€‚

## å‰§æœ¬

è¿™çœŸçš„æ˜¯ä¸€ä¸ªç®€å•è€Œæ„šè ¢çš„ [kscript](https://github.com/holgerbrandl/kscript) ï¼Œç”šè‡³å¯èƒ½æ˜¯ä»¤äººå°´å°¬çš„æ„šè ¢ã€‚æœ‰äº›è¡Œç”šè‡³æ²¡æœ‰è¢«æ›¿æ¢æˆæœ‰æ•ˆçš„å®Œæ•´è¯­å¥:ä¾‹å¦‚ï¼Œè¯·å‚è§æ¨¡å¼åŒ¹é…å’Œè½¬æ¢ã€‚

æˆ‘æ—¢æ²¡æœ‰æ—¶é—´ä¹Ÿæ²¡æœ‰ä¸“ä¸šçŸ¥è¯†æ¥ä½¿ç”¨åƒ [antlr](http://www.antlr.org/) è¿™æ ·çš„ä¸œè¥¿ï¼Œå¹¶ç¼–å†™ä¸€ä¸ªè§£æžå™¨æˆ–ä¸€ä¸ªæˆç†Ÿçš„è½¬æ¢å™¨ï¼Œæ­¤å¤–ï¼Œæˆ‘è¿˜æœ‰ä¸€äº›éžå¸¸å®šåˆ¶çš„å’Œç‰¹å®šçš„éœ€æ±‚ã€‚ä½†æ˜¯æˆ‘ä»¬éžå¸¸æ¬¢è¿Žä½ è¿™ä¹ˆåšã€‚

å› æ­¤ï¼Œäº‹ä¸å®œè¿Ÿï¼Œä¸‹é¢æ˜¯è¯¥è„šæœ¬çš„ç®€åŒ–/æ¸…ç†ç‰ˆæœ¬:

è¿™ä¸ªè„šæœ¬æ˜¯ä¸€ä¸ª [kscript](https://github.com/holgerbrandl/kscript) ï¼Œå®ƒæœ‰ä¸€ä¸ªå‚æ•°:æˆ–è€…æ˜¯ä¸€ä¸ªå·²ç»é‡å‘½åçš„ Scala æ–‡ä»¶`.kt`ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªé€’å½’è½¬æ¢æ–‡ä»¶çš„ç›®å½•ã€‚

è¯¥è„šæœ¬åšäº†ä¸€ä¸ªç®€å•çš„é€è¡ŒæŸ¥æ‰¾å’Œæ›¿æ¢:`def`åˆ°`fun`ï¼Œ`trait`åˆ°`interface`ç­‰ã€‚æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚ä½†æ˜¯æ­£å¦‚æˆ‘ä¹‹å‰æåˆ°çš„ï¼Œè¯­è¨€æœ‰ç›¸ä¼¼çš„è¯­æ³•æ˜¯æœ‰å¸®åŠ©çš„ã€‚ä¾‹å¦‚ï¼Œè½¬æ¢ä¸º Java å¯èƒ½æ›´å¤æ‚ã€‚

## å¸å–çš„æ•™è®­/æˆ‘åšå‡ºçš„å†³å®š

æˆ‘å†™è¿™ç¯‡åšå®¢çš„åŽŸå› æ˜¯æé†’æˆ‘è‡ªå·±æˆ‘åšäº†ä»€ä¹ˆã€‚ä¸€äº›æ–‡ä»¶ä»ç„¶éœ€è¦è½¬æ¢ï¼Œå…¶ä»–äººä¹Ÿæœ‰æ‰€è´¡çŒ®ï¼Œæ‰€ä»¥è¿™ä¹Ÿæœ‰æ‰€å¸®åŠ©ã€‚

å…¶ä½™çš„åªæ˜¯ä¸€ä¸ªæ²¡æœ‰ç‰¹å®šé¡ºåºçš„æ¡ç›®åˆ—è¡¨ï¼Œå°†æ¥ä¹Ÿå¯èƒ½ä¼šæ›´æ–°ã€‚

## æœªæ¥-> CompletableFuture

åŽŸå§‹ä»£ç å¹¿æ³›ä½¿ç”¨ Scala Futureï¼Œæˆ‘å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªæ›¿ä»£æ–¹æ¡ˆã€‚è€Œä¸”æœ‰å¾ˆå¤š:

*   Netty future â€”è¯­æ³•ä¼¼ä¹Žå†—é•¿è€Œè¿‡æ—¶ã€‚
*   JavaRX/Guava/ Other lib future â€”éœ€è¦å¦ä¸€ä¸ªå¤–éƒ¨ä¾èµ–é¡¹ã€‚
*   Java 8 å¯å®Œæˆçš„æœªæ¥â€”â€”è‡³å°‘å¿…é¡»ä¾èµ– Java 8ã€‚
*   kot Lin deferredâ€”â€”ä¸»è¦ç”¨äºŽ couroutinesï¼Œæ‰€ä»¥ä¸å¤ªä¸°å¯Œï¼Œä¸ç¡®å®š java ç”¨æˆ·æ˜¯å¦æ„Ÿåˆ°èˆ’é€‚ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œæ‰¾åˆ°å¦‚ä½•ä½œæ›²æœ‰ç‚¹å›°éš¾ã€‚

å†³å®šä½¿ç”¨ CompletableFutureï¼Œå› ä¸ºè¿™ä¸»è¦æ˜¯ä¸€ä¸ªåŽç«¯åº“ï¼Œè¿™æ„å‘³ç€æˆ‘çœ‹ä¸åˆ°åœ¨ Android ä¸­ä½¿ç”¨ååº”å¼å…³ç³»åž‹ sql åº“çš„ç†ç”±ï¼Œè€Œä¸” Java 8 åœ¨ Android ä¹‹å¤–è¢«å¹¿æ³›ä½¿ç”¨ã€‚

æ³¨æ„ CompletableFuture æ›¿æ¢ Scala Future å’Œ Promiseã€‚

## å±žå›½

ç”±äºŽè¿™æ˜¯ä¸€ç§é©±åŠ¨ç¨‹åºåº“ï¼Œæˆ‘è¯•å›¾æœ€å°åŒ–å¤–éƒ¨ä¾èµ–çš„æ•°é‡ï¼Œè¿™å½±å“äº†å…³äºŽä½¿ç”¨çš„å…¶ä»–å†³å®šã€‚

## å®Œæˆ

äº‹å®žè¯æ˜Žï¼Œåœ¨ Kotlin ä¸­ï¼Œæ‚¨ä¸å¿…é‡å†™ finalize æ–¹æ³•ã€‚

## æ•°æ®ç»“æž„

æˆ‘ä¸è®°å¾—æ‰€æœ‰ï¼Œä½†è¿™é‡Œæ˜¯æˆ‘åšçš„è½¬æ¢ï¼Œå¹¶è®°å¾—:

*   åºåˆ—->åˆ—è¡¨
*   IndexedSeq ->åˆ—è¡¨
*   ArrayBuffer ->å¯å˜åˆ—è¡¨

## æ¯”ç‰¹æ‹¨å¼„

Kotlin å¯¹`byte`æœ‰ç‚¹å¥‡æ€ªï¼Œå› ä¸ºå®ƒè¿˜æ²¡æœ‰åŒ…å«æ‰€æœ‰çš„æ“ä½œç¬¦ã€‚æˆ‘æŠŠä¸€äº›ç±»è½¬æ¢æˆäº† Javaï¼Œå…¶ä»–çš„æˆ‘ç•™åœ¨äº† Kotlin ä¸­ï¼Œå¸Œæœ›æˆ‘æ²¡å¼„é”™ï¼Œå› ä¸ºæˆ‘ä¸æ˜¯ 100%ç¡®å®š Scala æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚æ¬¢è¿Žå°±æ­¤å‘è¡¨æ„è§ã€‚

## æ‰©å±•æ–¹æ³•å’Œå±žæ€§

ä¸€å¼€å§‹æˆ‘å¹¶ä¸æ˜Žç™½ï¼Œä½†åœ¨æŸä¸ªæ—¶å€™æˆ‘æ„è¯†åˆ°æˆ‘å¯ä»¥é€šè¿‡æ‰©å±•è®© Kotlin å˜å¾—éžå¸¸ç±»ä¼¼äºŽ Scalaï¼Œè¿™éžå¸¸é…·ã€‚

ä¾‹å¦‚ï¼Œç§‘ç‰¹æž—åœ¨åˆ—è¡¨ä¸­æœ‰`size`ï¼Œè€Œåœ¨ Scala ä¸­æ˜¯`length`ã€‚

é—®é¢˜ï¼Ÿæ‰©å±•ã€‚

## å°è¯•

æˆ‘å†³å®šä»Ž Scala+Arrow ç§»æ¤/ä½¿ç”¨ä¸€ä¸ªç±»ä¼¼çš„ç±»ã€‚

## æ–¹æ³•å£°æ˜Žå’Œè°ƒç”¨ä¸­çš„å¤§æ‹¬å·

Scala å¹¶ä¸å¼ºåˆ¶æ‰§è¡Œï¼Œæœ‰æ—¶è½¬æ¢èµ·æ¥éžå¸¸æ··ä¹±å’Œç—›è‹¦ã€‚

## æœŸé™->æœŸé™

å†³å®šä½¿ç”¨ java.util.Duration

## æ‰§è¡Œä¸Šä¸‹æ–‡å’Œéšå¼å‚æ•°

æˆ‘å‘çŽ°è¿™ä¸ªç‰¹æ€§éžå¸¸ä»¤äººå›°æƒ‘ï¼Œæ‰€ä»¥æˆ‘å°†æ‰€æœ‰éšå¼å‚æ•°éƒ½æ”¹ä¸ºå¼ºåˆ¶å‚æ•°ã€‚å®ƒä½¿ä»£ç æ›´åŠ å†—é•¿ï¼Œä½†æ˜¯æ›´åŠ æ¸…æ™°ã€‚

æˆ‘ä½¿ç”¨å…¬å…±æ± ä½œä¸ºé»˜è®¤çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå°½ç®¡åœ¨ ob1k ä¸­æˆ‘ä»¬ä½¿ç”¨å¦ä¸€ä¸ªï¼Œæˆ‘ä»¬åªæ˜¯æ˜¾å¼åœ°ä¼ é€’å®ƒã€‚

## è¯•éªŒ

æœ€åˆçš„åº“ä½¿ç”¨ specs2ã€‚æœ€åˆæˆ‘æƒ³æŠŠå®ƒä»¬ç•™åœ¨ Scala ä¸­ä¸€æ®µæ—¶é—´ï¼Œä½†æ˜¯ç”±äºŽå¤§é‡çš„å†…éƒ¨ä»£ç è¢«ä¿®æ”¹ï¼Œè¿™çœ‹èµ·æ¥ä¼¼ä¹Žéœ€è¦åšå¾ˆå¤šå·¥ä½œã€‚å¤šäºäº†å…¶ä»–è´¡çŒ®è€…ï¼Œè½¬æ¢ä»ç„¶æ˜¯ WIPã€‚

## [è®¡]é€‰é¡¹

æˆ‘ä¸»è¦ç”¨å¯ç©ºç±»åž‹æ›¿æ¢äº†å®ƒï¼Œç”¨ä¸€äº›æ‰©å±•å¸®åŠ©å™¨:[https://github . com/ja sync-SQL/ja sync-SQL/blob/master/d b-async-common/src/main/Java/com/github/ja sync/SQL/db/util/nullable utils . kt](https://github.com/jasync-sql/jasync-sql/blob/master/db-async-common/src/main/java/com/github/jasync/sql/db/util/NullableUtils.kt)

åœ¨è¿™é‡Œï¼Œæˆ‘è®¤ä¸º Kotlin æ–¹å¼æ˜¯æ›´å¥½çš„æ–¹æ³•ï¼Œå› ä¸ºåœ¨ Scala ä¸­æœ‰æ—¶ä¼šä½¿ç”¨`Option`ï¼Œä½†æœ‰æ—¶ä¹Ÿä¼šç›´æŽ¥ä½¿ç”¨ nullã€‚

ä¹Ÿæœ‰å¯èƒ½ç”¨ java `Optional`ä»£æ›¿ã€‚

## ç‰ˆæœ¬-> kotlinsversion

å®ƒæœ‰ä¸€ä¸ªç‰¹å®šçš„é€»è¾‘ï¼Œä½†æ˜¯çœ‹èµ·æ¥å¾ˆæ ‡å‡†ï¼Œæ‰€ä»¥æˆ‘æ‰¾åˆ°äº†`KotlinVersion`ç±»æ¥åŒ¹é…å®ƒã€‚

## éšå¼è½¬æ¢

ä¸‡æ¶ä¹‹æº(åŠ ä¸Šè¿‡æ—©ä¼˜åŒ–)ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œç”¨æ‰©å±•æ–¹æ³•å’Œ Java é™æ€æ–¹æ³•æ›¿æ¢ç”¨æ³•éžå¸¸å®¹æ˜“ã€‚è¿™ä¸ªä¾‹å­å¯ä»¥åœ¨ç¬¬ 25 è¡Œä¸­çœ‹åˆ°[ï¼Œæˆ‘ä»¬é€šè¿‡ç¬¬ 25 è¡Œ](https://github.com/mauricio/postgresql-async/blob/master/mysql-async/src/main/scala/com/github/mauricio/async/db/mysql/binary/decoder/BigDecimalDecoder.scala)ä¸­å®šä¹‰çš„[æ–¹æ³•éšå¼åœ°å°† ByteBuf è½¬æ¢ä¸º ChannelWrapperã€‚åœ¨ Kotlin ä¸­ï¼Œæˆ‘åœ¨ ByteBuf ä¸Šä½¿ç”¨äº†æ‰©å±•æ–¹æ³•ï¼Œæ¯”å¦‚è¿™é‡Œçš„](https://github.com/mauricio/postgresql-async/blob/master/db-async-common/src/main/scala/com/github/mauricio/async/db/util/ChannelWrapper.scala)ï¼Œå¹¶ç”¨é™æ€æ–¹æ³•åˆ¶ä½œäº† ChannelWrapperã€‚

## ç‰¹å¾->æŽ¥å£+é€šè¿‡ç±»å§”æ‰˜

åŽŸæ¥ç‰¹å¾åªæ˜¯å¤šé‡é—ä¼ çš„æ›¿ä»£ç‰©ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥æœ‰çŠ¶æ€ã€‚æˆ‘è®¾æ³•ç”¨[ç±»å§”æ‰˜(ç¬¬ 55 è¡Œ)](https://github.com/jasync-sql/jasync-sql/blob/master/mysql-async/src/main/java/com/github/jasync/sql/db/mysql/MySQLConnection.kt)æ›¿æ¢äº†å®ƒã€‚ç¼ºç‚¹æ˜¯å®žçŽ°éœ€è¦æŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³•ï¼Œå¦‚æžœæ²¡æœ‰è¢«é‡å†™ï¼Œè¿™äº›æ–¹æ³•åœ¨è¿è¡Œæ—¶ä¼šå¤±è´¥ã€‚[è§æ­¤å¤„ç¬¬ 51 è¡Œ](https://github.com/jasync-sql/jasync-sql/blob/master/db-async-common/src/main/java/com/github/jasync/sql/db/pool/TimeoutScheduler.kt)ã€‚

## å°±æ˜¯è¿™æ ·ã€‚æ„Ÿè°¢é˜…è¯»ã€‚

ä¸€å¦‚æ—¢å¾€ï¼Œæ¬¢è¿Žè¯„è®ºï¼

> æ ‡é¢˜å›¾ç‰‡ç”±[å®‰æœµæ–¯ç“¦æ–¯](https://unsplash.com/photos/EeCfOPSeRik?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)ä»Ž [Unsplash](https://unsplash.com/search/photos/driver?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)