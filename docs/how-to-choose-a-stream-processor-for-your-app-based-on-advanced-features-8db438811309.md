# 选择流处理器:深度观察

> 原文：<https://medium.com/hackernoon/how-to-choose-a-stream-processor-for-your-app-based-on-advanced-features-8db438811309>

## 由 Miyuru Dayarathna 和 Srinath Perera

![](img/aeebcfd09cbcd07a67f008f1b387f4a1.png)

# 介绍

流处理使用户能够查询连续的数据流，并在从接收时间算起的短时间内快速检测状况。检测时间段可以从几毫秒到几分钟不等。例如，通过流处理，您可以通过查询来自温度传感器的数据流并检测温度何时达到冰点来接收警报。(如果你对这个话题不熟悉，请阅读[流处理的简明介绍](/stream-processing/what-is-stream-processing-1eadfca11b97)。)

如果你想建立一个处理流数据并做出实时决策的应用程序，你有两个选择:使用工具或自己构建。答案取决于您的用例的复杂性、可伸缩性需求以及可靠性和容错需求。

如果您想自己构建应用程序，首先将事件放在消息代理主题中(例如，ActiveMQ、RabbitMQ 或 Kafka)，然后编写代码从代理中的主题接收事件(它们成为您的流)，最后将结果发布回代理。完成以上三个步骤的代码在流处理世界中被称为 actor。

然而，与从头开始编写上述场景不同，您可以通过使用流处理框架来节省时间。事件流处理器允许您使用流 SQL 编写逻辑，并负责其余的工作。

您可以将事件直接发送给流处理器，也可以通过代理发送。事件流处理器将通过收集数据、将数据传递给每个参与者、确保它们以正确的顺序运行、收集结果、在负载较高时进行伸缩以及处理故障来完成繁重的工作。

下一个问题是，“您应该使用哪个流处理器？."我有好消息和坏消息。好消息是有这么多(见 Quora 问题:[)最好的流处理解决方案是什么？](https://www.quora.com/What-are-the-best-stream-processing-solutions-out-there))，所以你有很多选择。坏消息是有很多，你可能会面临选择的矛盾。

# 考虑太多

不同的流处理系统支持不同的功能。

1.  使用消息代理接收数据
2.  使用流式 SQL 编写查询
3.  流处理 API 和查询编写环境
4.  可靠性、高可用性(HA)和最低 HA
5.  通过拖放式图形用户界面(GUI)实现业务用户友好性
6.  流式机器学习
7.  消息处理保证
8.  无序事件
9.  大规模系统性能(可伸缩性，处理大窗口)

这是一个很大的特点。我们正努力在 19 个流处理器中考虑所有这些方面，以做出决定。

# 理念:“普通产品”

考虑了一段时间后，我们提出了两个想法。

首先是必须具备和可选的特性。必备功能是大多数用户最终会在流处理应用中使用的功能，因此是必需的。休息是可选的功能。

那么第二个想法就是*“平均产品”*。我们将平均产品定义为假设的产品，它只具有市场上超过 2/3 的流处理器支持的特性。

然后，您可以对照平均产品来评估每个产品。如果产品具有平均产品之外的特征，则是正面的，而如果产品缺少与平均产品相反的特征，则是负面的。

给出的平均产品是将每个产品与平均产品进行比较和对比的参考点。

# 必备功能

在调查了 19 个流处理器后，我们决定将以下四个作为必备特性。

1.  使用消息代理支持数据摄取
2.  流式 SQL
3.  流处理 API 和查询编写环境
4.  可靠性、高可用性(HA)和最低 HA

我们已经在 InfoQ 的文章[中详细讨论了上述四个必备特性，如何为你的应用选择流处理器](https://www.infoq.com/articles/how-to-choose-stream-processor)？

# 基于高级选择(可选功能)

本文讨论了可选特性，以及我们如何使用一般产品的概念来评估它们。

根据我们的定义，一般的流处理产品具有以下特征。或者换句话说，产品或更多产品的⅔具有以下特征。

*   该产品可以以分布式方式运行，并且是可扩展的
*   支持至少一次消息传递保证
*   为节点故障提供容错能力
*   支持定期检查点和恢复
*   支持背压
*   支持变换、聚合、关联、时间窗口运算符
*   支持调试
*   支持多个数据源和接收器
*   支持编写自定义运算符
*   支持运行系统的监控

您可以评估特定的流处理，首先选择与您的应用程序相关的可选功能，然后比较所选的流处理器在一般产品中的可选功能。

让我们讨论一下每个可选功能，以及不同的使用情形需要什么级别的支持。

# 可选功能

## **时间的概念**

流处理总是分布式应用。首先，从运行在一台或多台计算机上的传感器收集数据，然后将数据传送到流处理器，进行处理，并将结果传送到一台或多台其他计算机。

因此，在系统中的所有节点上没有单一的时间或时钟概念(这是分布式系统中众所周知的结果)。时间有多种概念，用户根据他们的应用来选择。

流处理器的时间概念有三种类型:事件时间、流时间和处理时间。

*   事件时间—事件实际生成的时间
*   流时间——流处理器将数据接收到平台的时间
*   处理时间-流处理器处理数据的时间

时间的概念对于处理时间顺序敏感操作的流应用变得非常重要。

不同的流处理器支持不同级别的时间。有些具有处理事件时间和处理时间的能力。有些只处理流时间。有些人三次都处理。例如，如果上述警报生成应用需要使用基于事件时间的时间窗口，并在特定时间范围(例如，下午 5 点到上午 8 点)内对特定字段进行比较，则仅使用流时间的流处理器不能用于此目的。这是因为如果在 windows 中使用流时间，它可能会抛出不正确的警报。因此，您应该根据应用程序所需的时间排序支持级别来选择流处理器。

区分事件时间和流时间的流处理器必须处理无序事件的正确性问题。这是因为当事件在传输到流处理器的接收器时，它们之间的顺序经常会发生混乱。流中的无序事件是由多种原因产生的，例如操作符并行化、网络延迟和异步流的合并。无序处理技术通常用于处理这种情况。无序处理的细节将在本文后面的小节中详细讨论。

## **业务用户友好度**

支持[业务用户](/@suhothayan/making-stream-processing-accessible-to-business-users-54c57e566063)构建流处理应用程序提高了流处理器的可用性。[业务用户](/@minudika001/business-rules-manager-for-wso2-stream-processor-a-brainstorm-56e4c281d927)是指需要将流分析用于业务用例，但不具备流处理解决方案底层技术方面的良好技术知识的人。业务用户友好性允许开发人员和业务用户设计、部署和定制他们的用例。

需要这种业务用户友好性的一个例子是分布在不同地理位置的业务。在这种用例中，每个地理位置的运营中心将执行具有不同变量的相同流程。在这样的场景中，以抽象的方式设计流程，并为每个地理位置定制流程，这极大地简化了用例。

有几个示例方法，其中流处理器实现了业务用户友好。一种方法是通过使用电子表格进行流处理。尽管业务用户(即领域专家)并不总是程序员，但他们通常熟悉电子表格处理器，因为据报道全球有超过 [5 亿人使用电子表格](https://www.microsoft.com/en-us/research/wp-content/uploads/2016/12/popl11-synthesis.pdf)。[电子表格](https://link.springer.com/chapter/10.1007%252F978-3-662-44202-9_15)已经被用于可视化实时流、计算新流的实时编程，以及导出要在服务器上运行的计算，以便计算可以与其他用户共享，并在电子表格的生命周期之外持续存在。Hirzel 的论文[“具有无界窗口和分区的流处理的电子表格”](http://hirzels.com/martin/papers/debs16-activesheets-talk.pdf)是 is 方法的一个例子，尽管就我们所知，还没有流处理器支持这种方法。

另一个例子是在 [WSO2 流处理器](https://wso2.com/analytics/) (WSO2 SP)中模板的使用。WSO2 SP 的[业务规则管理器](/@suhothayan/making-stream-processing-accessible-to-business-users-54c57e566063)允许将查询指定为模板(即骨架)。熟悉编写流处理查询的开发人员将决定哪些值应该作为变量保存。对如何编写流式查询了解有限或一无所知的业务用户可以使用框架来创建应用程序。例如，假设我们想要编写一个查询来检测车辆何时超过了速度限制。但是，业务用户可以根据查询部署的位置来决定速度限制。模板包括一个表单，业务用户可以填写该表单来更改查询行为。然而，在保留相同查询结构的同时，不同的参数可能会因组织和业务场景而异。业务规则管理器的使用允许使用查询模板快速生成正在运行的查询，并为参数赋值。

如前所述，拖放式图形用户界面(GUI)允许通过使用图标和属性窗口封装查询逻辑来实现应用程序。例如，一旦用户将流组件拖放到拖放 GUI 中，他就可以使用流组件的相关属性窗口来添加属性名称及其类型。

在我们调查的流处理器中，只有 32%为商业用户开发流处理应用程序提供了至少一些支持。提供预构建的业务应用程序和业务用户工具也有助于业务用户使用流处理器系统快速转变他们的业务流程。在接受调查的流处理器中，只有 3 个提供这种预构建的业务应用程序。

## **整合到机器学习中**

机器学习(ML)从数据中学习，通过编写算法来解决难以解决的问题。例如，机器学习模型可用于检测欺诈活动。可以将分类器与警报生成应用程序相结合，以更好的准确性生成警报，而不是使用简单的标准，例如大于比较。

大多数新的用例将以某种方式结合机器学习。因此，我们需要流处理器来支持机器学习模型。然而，将最大似然算法集成到流处理应用中并不是一项简单的任务。

传统的基于批处理的 ML 通常有两个阶段:模型训练和基于模型的预测。常见的方法是首先使用批处理算法训练模型，然后将预训练的 ML 模型导入到流处理应用中。只有少数流处理器具有内置的 ML 能力。为了将预训练的 ML 模型加载到流处理应用中，模型需要以众所周知的格式保存，例如 [PMML](https://en.wikipedia.org/wiki/Predictive_Model_Markup_Language) ，以便模型可以被加载而没有任何格式问题。

一些流处理器还支持流机器学习，这是一种可以在数据进入时建立和改进模型的技术。然而，流式机器学习的准确性低于用经典(基于批处理的)机器学习建立的模型。同时，经典模型并不会随着数据而改善。因此，模型需要不时更新。

这是一个权衡。如果您的流应用程序需要机器学习模型，您需要在批处理和流机器学习之间进行选择，考虑准确性与概念漂移(模型随着新数据漂移的速度)之间的权衡。

## **消息处理保证**

“你希望你的应用程序能达到什么样的准确度？”由流处理器提供的消息处理保证级别决定。消息处理保证(即语义)决定了流处理器的消息传递有多可靠。你想使用什么类型的语义作为框架取决于在你的用例中什么是有意义的。有三种主要的消息处理保证:最多调用一次、至少调用一次和恰好调用一次。

最弱的保障最多一次。最多一次其实并不能保证它会带来什么。例如，两个事件可能从传入流进入应用程序，而只有一个消息可能从应用程序传出。当最多实现一次时，发送方或接收方不需要状态，因为不涉及[确认协议](https://petabridge.com/blog/akkadotnet-at-least-once-message-delivery/)。至多一次不会引入额外的性能开销，这是三种消息处理保证中最容易实现的。

更强的保证是至少一次，其中消息可能至少被处理一次。这意味着邮件肯定会到达收件人，但也有可能重复。系统故障将导致相同的消息在输出流中重复多次。因此，下游应用程序需要小心处理这种重复的消息。如果数据是等幂的，那么至少使用一个消息处理保证对于您的用例就足够了。为了实现至少一次，发送者必须跟踪消息被发送给谁，哪些消息还没有被确认，以及何时消息必须被重新传递。至少一次消息保证对于许多用例来说已经足够好了。例如，对于一个警报生成应用程序，至少一次消息保证就足够了，因为它确保了警报通知被成功地传递给目标方。

第三种类型的消息处理保证是一次处理，这是大多数流处理团体所寻求的，尽管它可能有意义也可能没有意义。对于一些任务关键型应用程序，如采购订单、金融交易系统、航班预订、酒店预订等，需要一次保证。如果有两条消息进入应用程序，并且发生了一些系统崩溃，那么恰好一次可以保证每条消息恰好被处理一次。当实现一次消息保证时，我们需要保存发送方和接收方的状态。接收者还必须至少在一段时间内跟踪哪些消息之前已经被看到和处理过。因此，在三种消息处理保证中，这种方法的实现成本最高。

许多流处理用例只需要最多一次和至少一次保证。我们观察到 19 个流处理器中大约 47%支持至少一次语义，37%支持恰好一次语义，21%完全没有消息处理保证。

如果您的流应用程序需要更强的保证，您应该相应地选择流处理器。

## **无序处理和处理不确定性**

如果输入数据出现的时间顺序不同于在数据源生成的时间顺序，会发生什么情况？流中的无序事件(即，迟到事件)是由于多种原因而产生的，例如分布式传感器、操作者并行化、网络延迟和异步流的合并。无序事件处理可能会导致错误的结果。例如，为了确保事件模式匹配的正确操作，需要处理无序事件。如果事件 X 在事件 Y 之后到达，则可以配置生成警报。假设某个查询检测到的事件顺序为 Y 后接 X。如果由于顺序错误，该查询在 Y 之后接收到事件 X，则它不匹配。类似地，具有基于事件时间触发的时间窗口的应用程序也可能受到这种无序事件的影响。但是，某些应用程序(如事件过滤器)不受无序事件的影响。

无序事件处理是一个正在积极探索的话题。有几种高级方法。

首先是截取事件，然后在处理它们之前在缓冲区中对它们重新排序。这种方法增加的延迟与每个事件的延迟量成比例。当无序引起的延迟很小且有界时，这种方法是有效的。

第二种方法是构建能够处理无序事件并从中恢复的弹性操作符。然而，这使得操作符实现起来很复杂。标点符号的使用就是一个例子。基于标点的技术依赖于随数据流一起发送的特殊元组。标点符号明确地通知查询操作者何时返回窗口结果。因此，与上述基于缓冲区的技术不同，查询操作符可以直接使用无序输入。

第三种方法称为[推测](https://doc.rero.ch/record/18131/files/Brito_Andrey_-_Speculative_Out-Of-Order_Event_Processing_with_Software_20100429.pdf)，当观察到无序事件时，我们应用补偿技术来纠正先前发出的不准确的查询结果。这里，我们假设元组按顺序到达，并在窗口关闭时立即产生窗口的结果。当检测到迟到的 *e* 时，之前发出的受 *e* 影响的结果无效。通过考虑 *e* 产生这些结果的新修正。当晚到的人较少时，这种方法最有效。如果流连续接收无序事件，这可能会引入额外的纠正延迟。

尽管已经对处理无序的各种方法进行了大量的研究，但是大多数流处理器不执行无序事件处理。在接受调查的 19 个流处理器中，只有 47%关心无序事件。此外，47%的流处理器中只有少数真正进行了重新排序。其他人只是放弃了无序事件。

## **性能**

一个典型的具有事件持久性的流处理应用程序大约每秒运行 [50k 个事件。](https://docs.wso2.com/display/SP400/Performance+Analysis+Results)因此，大多数流处理场景都可以通过 2 节点 HA 设置来实现(例如，参见[您的流处理器是否过于庞大？](/p/d33936de00ff?source=user_profile---------2------------------))。但是，可能需要将系统扩展到 2 个节点以上。此外，具有大状态的窗口可能会消耗大量的系统内存。流处理器需要支持处理如此大的状态。

## **系统可扩展性**

如果你的应用程序必须处理越来越多的负载，会发生什么？系统可伸缩性和性能是衡量流处理器处理大型工作负载能力的重要指标。预期的性能水平取决于用例，一旦选择，切换到不同的流处理器是一个非常昂贵的操作。

例如，用例最初可能是对小事件的简单过滤操作(几个字段总计几百个字节)。但是随着时间的推移，随着添加具有大量数据(例如，几兆字节)的新字段，事件可能会变得更大。此外，随着时间的推移，业务不断增长，应用程序逻辑也可能通过复杂的连接、事件模式匹配、窗口处理等得到增强。随着这样的变化，用例可能需要比最初的系统所能提供的性能多几倍的性能。因此，如果用例需要大量的性能，您需要测试候选 sp 是否能够处理如此繁重的工作负载。

可扩展的流处理器可以通过添加更多资源来扩展其操作规模。如果流处理器被保证从一组固定的输入源(例如，用于车载网络的流处理器)接收仅固定速率的输入事件，则该流处理器不需要具有可伸缩性特征。然而，如果流处理器作为软件服务运行，需要[处理不断变化的工作负载](http://miyurud.github.io/papers/2017/ElasticCEP_ICPE2017-web.pdf)，那么通常需要扩展能力。大多数流处理器讨论了它们的水平扩展(添加新节点)能力，而没有太多关于垂直扩展(添加资源保持相同节点)的细节。考虑流处理器的垂直可伸缩性是一个非常重要的因素，尤其是在部署环境无法配备更多服务器的情况下。此外，水平扩展会引入额外的网络通信开销。这意味着在进行水平扩展之前，我们应该首先尝试尽可能地垂直扩展。

开源分布式流处理器已经公布了每秒百万事件范围内的吞吐量数字。大多数专有的流处理器没有公布吞吐量数字。给定固定稳定的输入数据流，流处理器的吞吐量受多种因素的影响，如队列大小、CPU 内核、内存和节点间带宽。因此，几乎不可能找到对所有产品进行的研究。在分布式流处理器上可以找到的性能数字中，发现的最大吞吐量是 1.1 亿个事件/秒，低延迟为 30 毫秒。发现单节点版本的最佳延迟为 0.003 毫秒

## **处理长聚集窗口**

如果 app 涉及到事件数百万的 windows 会怎么样？一般来说，流处理对数据流应用轻量级的一次性处理。流应用程序通常必须在 windows 上进行聚合。窗口的大小很重要，因为窗口必须保存在内存中。如果窗口可能包含数百万个事件，那么它必须保存在内存中，系统可能会过载，这对系统的稳定性是一个巨大的威胁。对于[示例](http://www-cs.stanford.edu/~datar/papers/sicomp_streams.pdf)，在电信系统中，可能存在每天为 1 亿客户处理由 3 亿条记录组成的长途电话记录的用例。另一个应用是网络流量工程，其中关于当前网络性能(例如，延迟和带宽)的信息被在线聚集，并用于动态地监控和调整网络性能。

可以从流处理器侧以及应用侧提供解决方案。为了处理大窗口，流处理器必须配备充足的内存。否则，流处理器必须具备通过压缩窗口或将部分窗口存储在辅助存储器中来减少存储器占用的能力。

从应用的角度来看，解决方案是使用较小的数量进行聚合，然后根据较小的数量计算较高级别的值(即[增量聚合](https://wso2.github.io/siddhi/documentation/siddhi-4.0/%23incremental-aggregation))。例如，如果维护 3 亿条记录的一天长度窗口的预期最终结果是计算电话呼叫的总持续时间，则可以通过按分钟累计呼叫记录，使用这些结果来计算每小时的总和，并最终使用这些每小时的值来计算全天的总持续时间来获得相同的结果。

# **结论**

不同的流处理器具有与不同用例相匹配的固有特性。在尝试选择最适合您的流处理器时，要考虑的特性数量很大，这使得做出正确的选择很困难。

本文介绍了一种选择流处理器的系统方法。

本文通过引入两个概念来做到这一点。

*   必须具备特性—这些特性是大多数流媒体应用程序在其生命周期中都需要的
*   常规产品—此概念性产品由⅔或更多流处理产品支持的功能组成。人们可以通过将两个流处理器与通用产品进行比较来决定对两个流处理器进行比较。

这种方法回答了两个主要问题。首先，流处理器在多大程度上支持核心流处理器架构特性？第二，应用程序的特殊需求是什么，候选流处理器在多大程度上满足了这些需求？

在回答第二个问题时，我们可以用“一般产品”的概念作为基线。您可以通过与平均产品进行比较来评估特定的流程处理。