# 如何在 React 组件中正确定义状态

> 原文：<https://medium.com/hackernoon/how-to-properly-define-state-in-react-components-b0f0ee83c982>

如果你一直在使用 [React](https://hackernoon.com/tagged/react) ，你有 100%的机会知道在组件的构造函数中初始化组件状态的模式。然而，这种模式一直存在几个问题，现在多亏了[明确键入——反应](https://www.npmjs.com/package/@types/react)，我们才‘被迫’解决这些问题。

![](img/f70743aca138c244fcac9867bf283b65.png)

在我们开始之前，我只想说我的例子将基于 [Typescript](https://www.typescriptlang.org/) ，然而，同样的想法/原则也适用于 [Javascript](https://hackernoon.com/tagged/javascript) 。

# 通用组件的状态问题

让我们先来看看这个简单的组件，它接收道具(一个超级英雄的名字)并有一个内部状态(超级英雄的生命值)。

直到最近，如果您运行这段代码，您不会得到任何编译时错误。然而，在运行时，您会得到一个关于访问 null 上的属性的错误，因为当我们试图访问`this.state.health`时，状态没有被定义。当您忘记在构造函数中初始化组件的状态时，可能会发生这种情况。谢天谢地，最新版本的绝对类型化@types/react，你现在会在编译时抛出一个错误。

好，让我们在构造函数中设置状态！

# 使用构造函数有什么问题？

这是和以前一样的组件，但是现在我们在构造函数中初始化状态。

此代码有两个问题:

1.  不必要的样板文件——我们正在调用构造函数，再次定义道具的类型并调用 super(props)。这一切只是因为我们想初始化状态…
2.  我们让状态对突变开放 React 的第一条规则是我们不谈论突变。React 的第二条规则是我们不谈论突变。好吧，我们确实在谈论它，但无论如何都要避免。在这种情况下，我可以执行以下操作而不会出现错误:`this.state.health = 90;`事实上，我的组件不会再次呈现，我仍然会看到健康值为 100，但是不会抛出错误，因为我们没有保护类的 state 属性。

事实上，从 [@types/react](http://twitter.com/types/react) 16.4.3 开始，这段代码将抛出以下错误:

> 无法赋值给“state ”,因为它是常数或只读属性

# 好吧，我服了，有什么办法？

幸运的是，在 Typescript 中，我们可以在类属性上使用`readonly`属性。这给了我们一个干净清晰的方法来保护状态对象免受突变(第 10 行):

# 我知道你在想什么

看完上面的例子，你脑子里闪过的第一个念头是:“好看！”。你脑中闪过的第二个想法是:“但是如果我需要用道具中的一些逻辑来初始化我的状态呢？!"。这个问题有一个很好的解决方案:

正如你在第 12 行看到的，我们用组件的道具调用了`getInitialHealth`(这是一个纯函数)，如果超级英雄的名字是蜘蛛侠，他的生命值是 0，如果是其他人，他的生命值将是 100。我真的很喜欢这种方法，因为你只是因为实际需要而引用属性，而不是因为构造函数需要它们。

# 我没时间做这个！尽快快速修复！

很有可能你现在有一堆失败的项目需要修复。如果你真的时间紧迫(即使这些修复真的很小，并且不需要花很多时间来改变)，有 2 件事你可以做。要么:

在引入这些新类型之前，将 package.json 中的@types/react 版本包固定到 16.4.2。

运筹学

在类中定义 state 属性，这样编译器“知道”它将在构造函数中设置(第 10 行):

# 包裹

在 Typescript React 组件中设置状态的“新”方法非常好，可以保护您的状态对象不发生变化。当然，这对专业开发人员来说可能不是“关键的”(我们都还是人，对吗？)，但对于新开发人员来说，这无疑有助于防止通常很难发现的常见错误。

过去一年我一直在使用 Typescript，每天我都觉得它比以往任何时候都更像是开发 Javascript 时的“必备工具”。

如果你喜欢这篇文章，请在 Medium 上跟随我，点击几次“拍手”图标来表达你的爱。你也可以在 [Twitter](https://twitter.com/EyalEizenberg) 和 [Github](https://github.com/eyaleizenberg/) 上关注我。