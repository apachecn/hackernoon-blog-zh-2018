# 初创公司的微服务:采访 SparkPost 的克里斯·麦克法登

> 原文：<https://medium.com/hackernoon/microservices-for-startups-an-interview-with-chris-mcfadden-of-sparkpost-7d5bc7d34ee2>

*这次采访是为我们的* [*创业微服务*](https://buttercms.com/books/microservices-for-startups/) *电子书做的。一定要去看看关于微服务的实用建议。感谢 Chris 的时间和投入！*

![](img/66a9ebc641ee043093575a6d054118b7.png)

[*克里斯麦克法登*](https://twitter.com/cristoirmac?lang=en) *是*[*SparkPost*](https://www.sparkpost.com/)*的工程副总裁。SparkPost 是一家领先的电子邮件基础设施提供商，也是目前性能最好的电子邮件递送服务提供商。*

对于上下文，您的工程团队有多大？您是否正在使用微服务，能否概述一下您是如何使用它们的？

我们的工程团队大约有 60 人。我们有几个不同的团队，包括一些开发团队和我们的 SRE 团队，他们负责我们的一些生产业务。我们的实际架构由一个核心 NTA 或电子邮件引擎组成，这也是我们的内部动量产品。然后我们有一些内置的 REST APIs，还有 SMTP。但是我们有十几个微服务，大部分是用 NodeJS 编写的。这些微服务可用于账户使用或管理、身份认证、报告分析以及其他类型的数据管理。

**你是从整体开始，后来采用微服务的吗？**

我们已经经营了 10 多年，实际上我们是从一家内部部署的企业软件公司起步的。我们已经在云端大约三年或更长时间了。但是 SparkPost，我们出售了动量，这是我们的 MTA 再次在前提。这是一个相当成熟的产品。它是用 C 和 Lua 编写的，但是它的性能非常高，非常灵活，非常模块化。但归根结底，它或多或少还是一块巨石。因此，当我们准备在云中发布时，我们确实以此作为我们的平台。我们确实在其中构建了一些 API，因为它有一个 HTTP 服务器。因此，核心电子邮件服务是这个庞然大物的一部分。但是，我们还有其他一些微服务共存。因此，除非它真的与电子邮件处理直接相关，否则它是独立于整体服务的，所以我们基本上有一种大型整体服务与微服务共存。

**采用微服务的动机是什么？你是如何评估权衡的？**

持续交付和持续部署对我们来说非常重要，这就是微服务对我们非常重要的原因。在处理微服务时，每个团队都可以更加独立地工作。当你处理更小的微服务时，复杂度肯定更低。更小的服务意味着更快的构建时间，更快的测试运行，更快的部署，然后每个部署的风险也更小，更容易回滚等等。现在，对于微服务来说，它们是按需部署的，因为每个单独的用户故事都独立于其他故事。在平台的 monolith 端，我们每周进行两次部署，时间更为固定。

我们基本上是一个 API 服务提供商。电子邮件 APIs 这是我们的业务，也是我们销售的产品。所以 API 优先的架构对我们来说非常重要。对我们来说，将 API 作为主要用户界面实际上非常有帮助，即使我们有一个客户端 JavaScript 应用程序，它对运行在相同 API 之上的一些东西进行一些报告。但是 API 优先的方法确实很有帮助；使用微服务真的很有帮助，因为你能够将事情从用户界面中分离出来，能够相当快速地做事情，并在事情准备好的时候发布。这对我们很有帮助，因为我们将部署与发布分离开来。对我们来说，部署是:一旦微服务中的变化或功能增强、错误修复完成，工程师就可以将它部署到生产环境中，这实际上是一个工程决策。我们当然可以在我们准备好的时候告诉我们的客户，所以我们通常会每周告诉客户，有一个更改日志，说这是新的。当你在做 API 微服务时，这很好，因为直到你告诉客户他们并不真正了解的东西，所以它真的很适合做事情的软发布。

作为一个团队/工程组织，你是如何处理微服务这个话题的？是否围绕微服务的定义进行了讨论？

这要追溯到 2013 年，当时我们决定采用微服务，这实际上是我们内部产品的一部分。那是我们推出云服务的一年前。在此之前，我们实际上没有对 NodeJS 做任何事情。老实说，我们更像是一家 PHP 商店，提供一些更面向应用的用户界面之类的东西。所以我们在想，我们真的不想用 PHP 来构建 API，有些人更懂 PHP，有些人更懂 Python。NodeJS 在那个时候真的变得越来越流行了。所以我们决定用 JavaScript APIs 和 JavaScript 前端全力以赴。在我们看来，使用 JavaScript 做任何事情都会变得更容易，既可以进行交叉培训，又可以让人们在团队之间来回移动。因此，我们在 NodeJS 上对这些微服务进行了标准化。我们使用 Express.js 作为某种基础。这真的很有帮助，因为我们能够轻松地构建新的 API。我们有一个锅炉板—锅炉板代码和部署计划，如果我们需要建立新的服务，我们可以使用它们。还是那句话，非常快。

早在 2013 年，微服务并不像现在这样流行。我们首先关注的是 API。我们想做的是快速构建 API，并让它们独立于用户界面。但是，当我们看到这一点时，一些读过微服务或认为微服务听起来很酷的团队成员。它似乎解决了我们的许多问题，使事情变得非常灵活，减少了我们的周期时间，降低了复杂性，使我们能够独立地构建和部署东西。因此，我们中的一些人对持续交付和持续部署有更多的了解。这似乎也能解决我们过去遇到的许多问题，在这些问题中，当您尝试频繁部署时，大型应用程序(如果您愿意，也可以称之为整体应用程序)可能会遇到一些挑战。

为了应对采用微服务，您是否改变了团队的组织或运营方式？

开发这些微服务的团队开始时是一个团队，现在分成了三个团队，但隶属于同一个更大的团队。每个团队都有某种级别的职责——这是一个相对较新的变化——围绕某些领域和某些专业知识。但是这些服务的所有权并不局限于这些团队中的任何一个。因此，这使得任何团队都可以致力于与这些服务相关的新功能、修复或生产问题。这使得他们在新产品开发方面更加灵活，因为你不会受到太多的限制，这是基于我们公司和工程团队的规模。我们确实需要保留一些灵活性。如果我们的规模大得多，那么让一个更大的团队拥有其中一个微服务会更有意义。在我们大约六个月前做出这些改变之前，我们有两个团队，就哪一个团队更负责每一项微服务而言，这非常清楚，但这带来了各种挑战，例如，我们正在进行呼叫轮换或其他类型的支持轮换，而有人没有使用过它或不是很了解它。所以这可能会造成一些问题。因此，我认为，对这些服务承担更广泛的责任更好，这给了你更多的灵活性。至少在这个时候，我们作为一个组织是这样的。

技术选择的自由度有多大？你们是否都同意坚持使用一个堆栈，或者是否有尝试新堆栈的灵活性？你是如何做出那个决定的？

在 Node.js 上实现标准化的决定对我们来说是一个很好的决定。如果 Node.js 没有继续发展，它可能会走上不同的道路，所以这是一个很好的决定，从那以后我们一直保持着这个决定。我们并没有真正想要改变 Node.js，我们已经用 Go 做了一些实验。我们完全有可能将 Go 作为一种替代语言。但是，我们在标准化方面更开放的地方实际上是在一些后端服务或数据库上。因此，我们使用了很多不同的数据库，并根据我们的需求频繁地更换它们。

**你有没有把一个单一的应用程序分解成更小的微服务？如果是的话，你能给我们介绍一下这个过程吗？你是如何完成这项任务的？有哪些不可预见的问题和经验教训？**

在过去的几年中，我们没有在这个整体中添加太多额外的服务或 API 端点，所以真正的任何新东西都是通过单独的微服务来完成的。持续交付和持续部署对我们来说非常重要。对我们来说，这就是为什么微服务对我们非常重要。在处理微服务时，每个团队都可以更加独立地工作。当你处理更小的微服务时，复杂度肯定更低。更小的服务意味着更快的构建时间、更快的测试运行、更快的部署，并且每个部署的风险也更小。更容易回滚之类的东西。所以我们现在能够按需部署微服务，因为每个用户的故事都是独立的。在平台的 monolith 端，我们每周进行两次部署，时间更为固定。

你如何确定服务边界？你的团队内部的讨论是怎样的？你能举些例子吗？

我们尝试沿着自然领域边界或甚至底层数据来确定这些微服务的范围。例如，我们有一个抑制微服务，它会跟踪数百万和数十亿个关于抑制的条目，但它都非常专注于抑制，所以实际上只有一两个表。其他服务也是一样。我们有自己的网络主机或 IP 池。实际上，在大多数情况下，您谈论的是服务正在管理的一个或两个表。

我想另一种思考方式是遵循高内聚和松耦合的规则。在大多数情况下，我们真的不想让一个服务调用另一个服务。这通常不是一个好主意。当然，在某些情况下这很好，但我们实际上发现了一种情况，这实际上是我们可能更复杂的用例。我们曾经有一个服务叫做用户应用编程接口。然后我们有了另一个叫做账户持有人的 API。所以用户有用户，API 密匙，认证。然后，我们有这个帐户的 API，其中有帐户的帐户，计费信息。但问题是他们之间实际上有几次通话。所以你可以在账户中做一些事情，也可以在用户中做一些事情，反之亦然。你会对用户做一些事情，并且必须在账户中查找信息。所以我们最终实际上只是把它们合并到我们所谓的原告 API 中。这是我们现在最大的服务。最初，我们只是折叠代码以进入同一个回购。我们开始做的是消除这些链接，它们之间的内部 API 调用。所以他们用的是同一个模型。现在我们正在经历一个过程，当我们从 Cassandra DynamoDB 转移东西时，我们也在重构。数据模型可以简单得多。因此，从几十个表到少数几个表，采用一种更基于记录的方法，而不是一种准关系方法。

因此，如果您考虑一个帐户，而不是拥有所有这些不同的表，并使用 Cassandra 作为一个准关系数据库，其中每个关系在 Cassandra 中都有一个表，您可以使用一种基于记录或基于文档的方法，在 DynamoDB 中有一个更嵌套的结构。这很有帮助。这有助于简化代码。我们正在对它进行重构，但它仍然是我们拥有的最大的服务，所以我们确实面临着构建和部署需要多长时间的挑战。实际构建和运行它的所有任务可能需要 30 分钟。为此，我们努力争取 10-15 分钟的时间。因为这是一个较大的服务，所以速度会慢一点，但是如果你最终试图将它分解成较小的服务，那么这两者之间会有太多的耦合，这会产生自己的问题。所以我认为我们现在最好把它们结合起来。但是，这里也有一些权衡。

**您从规模估算服务中学到了什么？**

90%的时间你都在谈论一两张桌子。然后你就有了这个异常值，这就是原告的 API。我觉得微服务就是服务。总的来说，服务的整个概念并不是一个新概念，无论是回到 CORBA 还是其他类似的东西。这是一个非常古老的概念。显然，实现有一点不同，但即使回到像面向对象的设计方法这样的东西，也是这种松散耦合、高内聚。你在过去所学到的关于开发服务和组件的所有东西对微服务来说都是正确的。

**微服务对你的开发过程有什么影响？您的运营和部署流程？出现了哪些挑战，你是如何解决的？你能举些例子吗？**

我认为我们做的事情可能与其他公司有所不同，至少是我谈过的一些公司。我们的开发团队实际上负责构建和管理微服务的部署管道。所以我们使用一个叫做 Bamboo 的工具来进行管道编排。那是亚特兰蒂斯的工具。然后，我们的开发人员与我们的站点可靠性团队在监控、可靠性和扩展等方面密切合作。然后两个队都有自己的待命时间表。

微服务的好处是不需要非常复杂的运营流程。老实说，它简化了事情。它们要小得多。管理许多小事情，然后管理一些非常大的事情要容易得多。例如，我们也没有专门的开发运营团队。对我们来说，开发运营不仅仅是我们做事的方式。没有人有开发运营工程师的头衔。我们在部署方面面临的早期挑战之一就是自动化，因此我们至少经历了不同的迭代。我们已经决定使用 Ansible，这对我们的用例来说非常好。它解决了我们持续部署的许多问题，还管理代码、数据库模式更改、迁移以及配置更改。我们必须能够以一种向前和向后兼容的方式做所有这些事情，这样您就不会有任何突破性的更改，也不会有任何停机时间。所以 Ansible 真的很有帮助。

在构建和部署他们自己的微服务方面，开发团队确实有很多责任，我认为这是最好的方式。有很多好的工具，比如 New Relic。所以我们的开发团队会用 New Relic。这正是我们的开发运营或 SRE 团队所关注的。绝对是个好工具。我认为，当你削减服务时，让开发团队更多地接触和负责生产是非常可行的，我认为你最终会有一个更好的结果。

**微服务对您的测试方式有何影响？在这方面有什么经验教训或建议？你能举些例子吗？**

围绕我们如何进行测试或 QA，它确实发生了很大的变化。历史上，我们有一个独立的 QA 团队。首先[我们的 QA 团队]在做手工测试，然后他们开始做他们自己的自动化功能测试。但当我们开始做微服务时，我们决定真正简化事情，所以没有单独的 QA 团队。实际的开发团队编写他们自己的所有功能性能测试。他们也有自己的自动化功能测试和自动化回滚。我从运营的角度讨论的大部分内容是让开发团队对微服务完全负责[意味着]没有独立功能组的外部依赖性。简单多了。我不认为在我们的特定情况下，拥有单独的 QA 会带来很多价值。在我们的平台团队中，我们有一个更大的整体，我们有单独的性能测试工程师，他们真正帮助该平台的基准测试，这有点复杂，所以一些以前的实践继续在那里发生。但是，在微服务方面，一切都要小得多。我认为，如果你来自一个更传统的环境，那里有这些更大的应用程序，更传统的开发过程，我认为把很多东西放在一边，真正考虑如何简化事情是非常重要的。

然后，我们要做的是，在任何人编写任何 API 更改或新 API 之前，他们将首先更新文档，审查该更改，以确保它符合我们所有文档记录的 API 约定和标准，并确保这里没有引入突破性的更改。我们将确保它符合我们的命名惯例等等。一旦审核完毕，我们还可以编写 API 变更，有时这些工作会同时进行，以便在实际 API 变更的同时完成文档。这真的帮了大忙。早期，我们对 API 治理过程非常严格。但是现在这已经在人们心中根深蒂固了，所有的惯例都很广为人知和理解。这就是我们遵循这些标准的方式，但我们过去也尝试过其他工具。我们开始使用 Apiary，这是一个很好的 API 文档工具。然后我们迁移到使用 API 蓝图规范。但是那时我们使用一个叫做 Jekyll 的工具来生成静态 HTML 文档，所以这就是我们现在所拥有的。它让我们对文档的外观和感觉有了更多的控制。但我们确实使用了一种叫做 Dredge 的东西，它基本上是获取整个规范，然后对 API 进行验证，但这真的很麻烦，而且似乎有很多奇怪的情况，我们最终没有使用它。我们还进行了大量的监控，因此，如果出现了非常严重的问题，无论是通过测试还是监控，我们都会及时发现。这并不是说没有一些奇怪的边缘案例，有人修复了 bug，然后以某种方式在 API 中引入了一些奇怪的突破性变化。但是这种情况非常非常罕见。

**微服务对安全性和控制数据访问有何影响？在这方面有什么经验教训或建议？你能举些例子吗？**

可能值得一提的是，我们使用 Nginx 作为所有 API 的代理，在 Nginx 中，您可以在 Nginx 中共享自定义 Lua。因此，我们将其集成到自定义身份验证 API 密钥身份验证授权机制中。这让我们能够集中所有的东西和所有的逻辑。所有的服务本身都不知道任何关于认证和授权的事情，所以从这个角度来看，为了让事情变得简单，我们可以把它们都放到 Nginx 中。还有其他工具可以做到这一点，任何类似 API 网关类型的产品。但这样做的好处是，你真的让服务本身非常简单，所有的访问控制都可以集中起来。从安全的角度来看，我们做了一些我认为 API 通常会阻止的事情。它们提供了比某些类型的应用程序更好的安全配置文件。但是我们确实利用了像 GitHub 的新依赖漏洞扫描这样的东西。因为我们在 GitHub 中拥有一切，这是他们做的一件很酷的新事情。我们也扫描代码。我们也有像 SQL 注入这样的安全编码实践。

**您是否遇到过在微服务架构中管理数据一致性的问题？如果是这样，请描述这些问题以及你是如何解决它们的。**

我认为，如果你来自这种单一的服务或系统，其中一个挑战是这些非常繁重的事务的想法。然后，当你使用微服务时，你需要接受的最重要的事情是，每个服务只对自己的事务负责。如果你要在一个更大的层次上进行某种交易，而这种交易将使用多个服务，你必须基本上假设一些服务可能工作，也可能不工作，或者会出现某种失败或错误，然后进行一些异步重试等等。例如，我们将使用队列中的数据，它将处理这些数据并尝试更新多个 API。如果其中一个失败了，我们会重试其他的，或者根据需要重试。你必须接受事情就是这样的。我前面提到过，如果一个服务试图同时更新多个数据表，有不同的方法来处理。但当然有些数据库会支持事务，但如果你像我们这样跨数据库，你会知道我们已经能够利用这种更异步的复制，只需使用 Lambda。所以我们只需更新 DynamoDB，然后有一个同步过程，将数据同步到其他数据源。我认为对我们来说，我们真的不需要数据更新和 100%一致。我认为，一旦你放弃了数据必须 100%一致的想法或需求，我认为你的生活会变得更好。我认为这可能对一些人来说很难接受，但我认为当你在一些数据库或微服务中处理云时，你必须将其融入到你的架构中。

*再次感谢 Chris 的时间和投入！这次采访是为我们的* [*创业微服务*](https://buttercms.com/books/microservices-for-startups/) *电子书做的。一定要去看看关于微服务的实用建议。*

*本文原载于*[*buttercms.com*](https://buttercms.com/blog/microservices-for-startups-an-interview-with-chris-mcfadden-of-sparkpost)*。这是《创业公司的微服务》一书* [*采访系列的一部分。新章节一发布，你就可以通过电子邮件收到。*](https://buttercms.com/books/microservices-for-startups/)

如果你喜欢这篇文章，请在下面鼓掌帮助它传播！更多类似内容，请关注我们的 [*推特*](https://twitter.com/ButterCMS) *和* [*订阅我们的博客*](https://buttercms.com/blog/) *。*

如果你想在你的网站上添加一个博客或者内容管理系统，而不是用 Wordpress， [*你应该试试黄油内容管理系统。*](https://buttercms.com/)