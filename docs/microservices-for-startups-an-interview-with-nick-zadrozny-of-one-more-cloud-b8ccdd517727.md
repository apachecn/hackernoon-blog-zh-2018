# 创业公司的微服务:采访《再一片云》的尼克·扎德罗兹尼

> 原文：<https://medium.com/hackernoon/microservices-for-startups-an-interview-with-nick-zadrozny-of-one-more-cloud-b8ccdd517727>

*这次采访是为我们的* [*创业微服务*](https://buttercms.com/books/microservices-for-startups/) *电子书做的。一定要去看看关于微服务的实用建议。感谢 Nick 的时间和投入！*

![](img/777115e9fcc0c38f34bd3162bdc12814.png)

[Nick Zadrozny](https://twitter.com/nz_?lang=en) 是一家提供专业托管云服务的公司 [One More Cloud](https://omc.io/) 的创始人兼首席执行官。尼克是 OMC 两个托管搜索即服务产品 Bonsai 和 Websolr 的创始人。

**就背景而言，您的工程团队有多大？**

我们是一个小团队。我们有八名全职员工，我不知道，根据项目的不同，在任何时候都有三到五名兼职承包商。

**您是否正在使用微服务，能否概述一下您是如何使用它们的？**

我想我会说我们一开始是一个整体，但这并不完全正确。我们从一开始就有微服务，这甚至可以追溯到 2009 年。

主应用程序主要是一个面向用户的仪表板。它是一个 API 端点，供 Heroku 提供资源和帐户，然后供用户单点登录到他们的仪表板。然后，如果你去 Bonsai.io 或 websolr.com，这是主要的主页和营销存在，创建你的帐户，登录和管理你的资源和所有类似的东西。所以只是通常的 SaaS 帐户和资源仪表板的东西。

Websolr 由 Apache Solr 作为服务管理，Bonsai 由 ElasticSearch 管理。我们算是第一个同时销售这两种产品的公司。事实上，当我们创建 Websolr 时，我们是受 Heroku 的人们的邀请，因为他们正在启动这个附加程序。他们的客户想要搜索引擎托管。这在当时并不存在，这很有趣。所以我最初的联合创始人和 Heroku 的人有些联系，也有一些搜索方面的背景。我也有网络开发、搜索和运营的背景。所以他们说服了我们:你们应该开始自己的搜索托管业务。会很有趣的。一件事接一件事，八年后我们在这里。我们只有一个 Rails 应用程序——这是我们的客户所使用的界面。这个应用程序本身是 Heroku 的 API，它与我们的应用程序进行对话，为客户调配资源，这是我们的中间点，我们将调用其他服务来调配后端服务器资源，并对中间路由层中间件服务等进行更新。这是我们建筑的超高水平的草图。

**你是从单体开始，后来采用微服务的吗？**

我想说，我们从第一天就开始使用微服务。我们一直有一些独立于我们的主应用程序的服务，可以作为亚马逊的服务器资源的协调者。在早期，这肯定是更多的整体性，我认为总的来说，作为一个小团队，整体性开发肯定有优势。

**如果是，采用微服务的动机是什么？你是如何评估权衡的？**

我们使用的微服务确实是出于强烈的技术需要。例如，我们不能在每一台 Solr 服务器上运行我们的 Rails 应用程序。这根本说不通。如果你说的是这个，那么你说的是所有与我们的应用程序使用的同一个中央数据库进行对话的人。因此，如果我们这样设计，这将是我们应用程序的一个严重的中心失败点，因为如果我们的主数据库宕机，那么我们所有的客户实例都会宕机。所以出于必要，我们必须强烈地去耦合。无论我们的主应用程序发生什么情况，我们的 Solr 和 ElasticSearch 集群都必须保持运行。因此，从第一天起，出于技术上的需要，这是最明显的分离。从那以后，我们的集中式应用程序仍然是一个庞然大物。我们逐渐将定义非常清晰的功能提取到服务中。

**作为一个团队/工程组织，你是如何处理微服务这个话题的？是否围绕微服务的定义进行了讨论？作为对采用微服务的回应，您是否改变了团队的组织或运营方式？**

我认为这对我们来说并不是什么大问题。我们是一个非常注重工程的团队。我们八个全职员工中有六个是工程师，是产品、平台和运营工程师，所以我认为我们都非常熟悉微服务的概念，当然我们足够小和敏捷，所以我们熟悉现代应用程序开发部署实践。我们是云部署的早期采用者，比如 Heroku 的平台模型和十二因素应用模型。外包给各种不同的 API，我们一直认为这是一种微服务方法。现在，无论是事务性电子邮件交付还是订阅和计费管理，我们都得到了很好的利用。我认为，对于我们来说，微服务或整体服务的问题最终取决于具体情况，就像我们在逐个功能的基础上进行评估一样。因此，当我们谈论开发一些新功能时，对我们来说，问题总是会出现:我们是将它内置到 Rails 应用程序中，还是提取某种微服务，然后让应用程序通过 API 进行通信？对我们来说，这很大程度上是一个重复的好处的问题。我们是要重复编写两次代码，本质上是将它直接构建到 Rails 应用程序中，还是要编写一次大部分代码，然后在每个应用程序中编写一个较小的集成层？因为对我们来说，每个行业都有自己的主要支柱。它们是带有独立数据库的独立应用程序。因此，这确实是我们在这一点上讨论的主要问题，从哲学上来说，这一特性或功能领域是否应该转移到微服务中。但我想说，至于什么是微服务，它在我们的架构中扮演什么角色，我认为对于我们这个主要由工程师组成的团队来说可能更清楚。我认为我们在使用微服务方面已经相当成熟。

你有没有把一个单一的应用程序分解成更小的微服务？如果是的话，你能给我们介绍一下这个过程吗？

我想说，我们从第一天就开始使用微服务。

**你如何确定服务边界？你的团队内部的讨论是怎样的？你能举些例子吗？**

所以我认为我们有一些独特的要求。我们是一家全年无休的公司。我们是一家运营提供商，正因为如此，我们的首要责任是为我们的客户管理良好的正常运行时间。我们的客户使用我们的服务，因为我们能够管理比他们更长的正常运行时间和更高的性能，当然这是以我们的服务为代价的。因此，我们绝对有一个强大的设计理念，隔离任何可能的组件，将在客户的流量到他们的搜索引擎的热路径。因此，这是分离边界的第一条规则，试图明确定义我们必须在后端与客户资源交互的时间和原因。大多数必须与客户资源直接或间接互动的事情，我们都希望从日常产品开发中分离出来。因此，这种隔离的好处是:后端微服务有自己的 API，因此我们可以将发布周期和发布管理与我们是否需要调整前端的 CSS 或调整营销文案或其他东西分离开来。所有这些都可以按照与我们所需的发货和更新不同的时间表进行部署，这将改变我们管理客户资源的方式。它将会更加小心地推出，并拥有自己的代码库，甚至可能有不同类型的代码审查政策之类的东西。我认为这可能是我们用来定义这些服务边界的第一个主要标准。

**您从规模估算服务中学到了什么？**

当我们考虑管理大量数据的微服务或内部服务时，我们会为所有客户流量存储非常详细的日志和分析。例如，我们有一个代理层来记录搜索请求的所有元数据。这是一个什么样的动作，花了多长时间完成？处理它的后端服务器是什么？诸如此类的事情，这样我们就可以看到运营指标的趋势。因此，这个特定的服务在某一点上负责收集所有的日志。所以在很早的时候，服务器上的日志变得非常庞大，或者不适合搜索。然后我们开始将所有这些日志导出到另一个 ElasticSearch 集群中，这样我们就可以在这些日志中进行搜索。过一段时间后，我们开始遇到一些确定的规模和扩展挑战，您可以暂时纵向扩展，为该服务添加更多容量。但随着时间的推移，我们发现再一次重建指标集合更加实际，然后这些天我们实际上做了很多预先计算和汇总，所以现在这项服务不仅仅是索引到弹性搜索的可搜索性。它还做了大量的汇总工作，我们将指标存储在 Cassandra 中。因此，可以灵活地重组事物持久化的方式。从磁盘上的日志文件到 Elk Stack，再到 Elk plus Cassandra，让一些元数据直接从服务器上传到我们后端的其他服务上是一个非常好的好处。我们能够做到所有这些——同样，这与客户热路径直接相关——我们能够以一种有效的方式管理发布，这使我们能够在不影响实际客户流量的情况下进行一些重大的功能和容量改进。

**微服务对你的开发过程有什么影响？您的运营和部署流程？出现了哪些挑战，你是如何解决的？你能举些例子吗？**

每当我们推出有效的微服务时，部署速度肯定会加快。我们总是看到性能的提高，因为当我们清楚地定义这些界限时，我们有了更多的信心，当您在某一方面进行更改时，当您审查代码和规划部署时，您会了解受影响的范围。因此，我们现在有一个部署流程，很多时候，如果我们要添加依赖微服务的新功能，我们可以先在后端部署该功能，然后让它正常工作。只有当它完成并且运行良好后，我们才可以在前端为它转换接口。因此，将这两者分离意味着你能够更频繁地做出更小的改变，这真的增加了我们对正在做出的改变的信心。它提高了我们概念化什么已经被改变的能力，并且不必担心代码都是纠缠在一起的，并且在你的软件耦合到它自己的地方产生一些不必要的和不清楚的点。这在运营中也非常有价值。如果您不能保持经常部署和部署非常小的更改并验证它们的能力，那么您就会陷入这种模式，一个季度发布一次，或者一年一次。这就像拔牙一样，获得所有的资源来实现它，然后当它真正完成时，现在你正在计划下一个。

**微服务是否影响了您的测试方式？在这方面有什么经验教训或建议？你能举些例子吗？**

是的，是的。实际上我们还在研究一些东西。我觉得这很有趣。我的意思是从测试的角度来看这很好。你可以有更多集中的单元测试，你有服务边界，对吗？服务边界的一边是微服务；在边界的另一边，是消费它的客户。所以你可以在编写测试时同时考虑这两个因素。测试微服务本身的单元测试——更多一点是实现细节。作为一个微服务的所有者，你有更多的自由和灵活性来改变你的实现，这伴随着改变你的测试。因此，通过清楚地定义边界，可能不需要改变 API 本身。我认为你只是提高了很多生产力。我认为测试更清晰，更有效率，更一次性。它是一种工具，在它需要存在的环境中，在一段时间内服务于一个目的。但从使用微服务的应用程序的角度来看，它真的不关心这些东西。我发现这对于测试来说是一个非常明显的好处。我们测试微服务行为的主要整体测试要少得多，因为我们能够在更高的层次上信任它正在服务于工作，它正在做它需要做的工作。这使得巨石柱更加集中。它防止耦合回微服务中可能的实现细节。然后，它允许微服务本身有更多的灵活性来适应变化。这更像是一种开发实践，而不是专门的测试。但是，是的，我认为这是我们得到的主要东西，只是灵活地使用正确的工具来完成工作，并专注于您直接工作的代码库，专注于它负责的内容。

因此，改变我们对待测试的方式，我们将——我认为在我们的微服务中，大多数都将客户端捆绑在项目中。我们可能在后端有一个 Java drop wizard 微服务，它会在 repo 中捆绑一个 Ruby gem 客户端，然后由 Rails 应用程序使用。因此，我们实际上会使用自己的客户端来驱动集成测试和微服务本身。这是这种测试的好处之一。我们仍然会有 Java 单元测试。但最终，Ruby 客户端是我们进行所有集成测试的地方，也是展示如何使用这个东西的地方。如果在 API 级别上违反了合同，那么我们可以创建一个回归测试。

**您是否遇到过在微服务架构中管理数据一致性的问题？如果是这样，请描述这些问题以及你是如何解决它们的。**

我们一直在帮助客户解决这个问题。我的意思是，对我们来说，数据一致性并不是太大的问题，因为我们已经有了这样一个整体，因为它与 PostgreSQL 对话，基本上 PostgreSQL 事务为我们提供了我们需要的所有一致性。在我们的 Rails 应用程序中，我们的模型主要被定义为基于事件的设计，这种方式为我们提供了解决任何潜在的数据竞争、并发或冲突情况所需的一切。因此，我们在这方面面临的挑战比我们的客户可能面临的挑战要少。我们的一项微服务内置了分布式数据存储。但幸运的是，这是一种最后的正确的设计。

对我来说有三层含义。我们的业务是分布式数据服务的管理，也就是说，ElasticSearch 是一个大公司，它从第一天起就被设计成分布式的。因此，这些年来，作为紧跟云架构的工程师，我们必须在分布式系统工程学科上保持真正的教育。因此，我们的主要客户群、帐户、群集管理和资源管理不一定是分布式问题，因为它通过一个中央数据库。但当涉及到协调我们的一些数据服务时，这可能会成为一个分布式数据问题，因此我们有时不得不依赖专门为该环境构建的数据库。所以我们确实使用了 Zookeeper，它是为分布式环境中的一致性而设计的。我们还有一种专为高可用性设计的不同数据服务，因此它可能不总是 100%一致，但它总是 100%可用。因此，当我们在后端设计微服务时，总会有一个问题，即什么是基本的支持数据存储，在数据一致性和可用性方面有哪些权衡，以及这将如何影响我们的决策？所以我们三个都有。我们有集中型，我们有分散型，但针对一致性进行了优化，我们有分散型，但针对可用性进行了优化。也就是说，当你看到我们的一个客户与像我们这样的搜索引擎服务集成时，管理一致性真的很有趣，因为现在他们必须在他们的主数据存储中进行更改，这些更改必须发布到他们的搜索引擎并可被搜索到。有时，他们需要对资源进行更新，并协调这些更新的一致性，特别是在对单个文档进行快速连续更新的情况下。因此，我们通过支持渠道对客户进行了大量的教育。在管理数据一致性方面，我们可以向人们推荐六种不同的最佳实践。

我认为，对于任何微服务领域的工程师来说，在分布式世界中，最好的事情是，如果没有必要，不要制造数据一致性问题。只需使用 PostgreSQL 或其他可靠的中央数据存储。这并不总是正确的答案，因为这会成为单点故障。我认为最重要的是，工程师们真的应该接受数据一致性、设计数据持久性、一致性和可用性的权衡以及纯粹的集中化方面的教育。

再次感谢 Nick 的时间和意见！这次采访是为我们的 [*创业微服务*](https://buttercms.com/books/microservices-for-startups/) *电子书做的。一定要去看看关于微服务的实用建议。*

*本文原载于*[*buttercms.com*](https://buttercms.com/blog/microservices-for-startups-an-interview-with-nick-zadrozny-of-one-more-cloud)*。这是《创业公司的微服务》一书* [*采访系列的一部分。新章节一发布，你就可以通过电子邮件收到。*](https://buttercms.com/books/microservices-for-startups/)

如果你喜欢这篇文章，请在下面鼓掌帮助它传播！更多类似内容，请关注我们的[*Twitter*](https://twitter.com/ButterCMS)*和* [*订阅我们的博客*](https://buttercms.com/blog/) *。*

如果你想在你的网站上添加一个博客或者内容管理系统，而不是用 Wordpress， [*你应该试试黄油内容管理系统*](https://buttercms.com/) *。*