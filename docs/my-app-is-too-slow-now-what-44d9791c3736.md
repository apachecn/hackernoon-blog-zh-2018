# 我的应用程序太慢了，现在怎么办？

> 原文：<https://medium.com/hackernoon/my-app-is-too-slow-now-what-44d9791c3736>

![](img/bc2e089e379c49bffdee0a867d3dc28f.png)

My App

在遇到性能问题之前，你不必做很长时间的软件工程师。数据库加载太慢。计算路线要花很长时间。远程呼叫挂起。怎么办？

SQL 查询优化？JS 包装？指数？算法优化？多线程？换成 C++？云？微服务？碎片？NoSQL？移除功能？增加硬件要求？内核优化？JIT 装载？负载均衡？移除变量？用 Protobuf？更好的压缩？换库？改变框架？GC 调优？

有很多方法可以加速代码，但并不是所有的方法都是有效的或者值得努力的。但是你的最佳选择是什么？这是一个巨大的专业领域，举例来说，上面列出的所有技术都有自己的专家，如果你碰巧需要的话。在你去租一个之前，让我们来看一些可能帮助你决定的步骤。

# 第一步:诊断

诊断问题显然是第一步。它可以像计时函数调用一样简单，但通常更好的方法是启动一个分析器，比如 Chrome Developer Tools Profiles 窗格或 Java Mission Control，无论您在什么平台上。有很多性能分析工具，所以去找一个适合你需求的吧。花点时间学习如何使用，他们通常会很快将你定位到最糟糕的罪犯。

这也是发现像内存泄漏这样的编程错误的好时机。不管怎样，这些问题都需要解决。寻找对象计数和分配的内存，看看这些数字是否有意义。

几乎可以肯定的是,[帕累托法则](https://en.wikipedia.org/wiki/Pareto_principle)将会成立——80%的缓慢是由 20%的代码造成的。事实上，它通常比这更极端——一个经常被点击的函数可能会成为整个 100k 行代码库的瓶颈，所以您应该首先解决这个问题。

通常问题和解决方法一样明显，所以抓住这些唾手可得的水果可以解决你大部分的苦恼。如果不清楚如何修复和修复什么，请继续阅读。

# 第二步:了解你的领域

![](img/fc25e11c1b6353eda0d983616d3ceebd.png)

Finnish conscripts testing the voting system in 2017.

即使有些事情可以做，也不意味着它应该做。在你决定做任何激烈的事情之前，了解你的领域、给定的硬件限制和预期的负载是至关重要的。我们是在讨论单人游戏吗？在你的树莓 Pi 上运行的硬件传感器读取应用程序？一个最多有 100 个用户的商业应用？一个拥有百万并发用户的 web app？从 Ruby 转换到 C 在 Pi 上可能有意义，但在 Rails 应用上可能没有意义。

让我们以芬兰议会及其投票系统问题为例:

> 芬兰议会在 21 世纪初升级了电子投票系统。在测试的最后阶段，他们发现当足够多的成员同时按下他们的投票按钮时，系统无法处理负载并崩溃。

在芬兰议会中，主席要求对某事进行投票，你可以让 200 名议员通过按下三个选项中的一个来投票，Jaa(是)，Ei(否)或 Tyhj(以上都不是)。他们通常有 10 秒左右的时间来做这件事。所以，如果你想一想，失败的场景是最常见的用例——大多数成员会在投票结束时立即按下按钮。

那么我们能从中学到什么，至少在性能方面？了解你的领域。如果问题出在电子设备上，即使后端有点慢，换成无服务器的云架构可能也无济于事。瞄准你的目标，以匹配现在和不久的将来的预期负荷。没有必要让投票系统与 10000 个并发用户一起工作。议会不会(希望！)长到那个尺寸。事实上，将目标设定为 200 分是可以的，也许可以多加 20 分来弥补误差。

负载通常不是可预测的和静态的。Reddit 首页用户的数量有增有减，令人惊讶。但是，仍然要了解你的领域，并接受不值得马上做好准备的事实。如果你把你的 Android 应用程序的性能目标设定在最慢的手机上，你将永远不会成功。相信我，它比那只树懒还慢。

如果你有一百个用户，并希望达到一千个，你现在应该采取的措施与从一千个到一百万个是不同的。后者可能需要像使用微服务这样的技术，它们会给系统增加巨大的复杂性，并带来额外的风险。达到 1000 可能是优化数据库查询的问题。

# 第三步:决定行动方案

所以应用程序很慢，你已经诊断出了问题。它是从远程数据库装载数据的函数。那么你应该如何着手呢？

这里有一份领域不可知的问卷，可以缩小您的选择范围:

## 我能完全跳过这个吗？

认真想想。就算你超优化的算法也比我删的代码慢。许多最棒的性能技巧，如[自适应磁贴刷新](https://en.wikipedia.org/wiki/Adaptive_tile_refresh)，本质上都是避免做事的方法。想想用例，如果它不重要，也许你可以不要它，

也许一些轻量级版本就足够了？你真的真的需要 7MB 的 js 库来加载角落里 10 像素宽的 10MB SVG 公司徽标吗？

## 我能把它移到不太贵的地方吗？

也许你在首页有一个计算量很大的列表。大家都用吗？如果没有，也许把它转移到某个地方，这样只有真正需要它的人才会受到伤害。它还可以节省后端的周期。

## 我只能做一次吗？

也称为缓存。一件事只做一次然后利用结果是有效的，但也是[难](https://martinfowler.com/bliki/TwoHardThings.html)。尤其是如果你发明了自己的缓存方案，你将会面临一个巨大的麻烦。当调用突然返回过时的数据时，您现有的测试套件也可能不足以处理它。警惕退步。小心行事，更喜欢任何现有的技术，如 [ehcache](http://www.ehcache.org/) 。

如果您的应用程序有很长的计算链，也要考虑缓存中间结果。如果你有记忆，那就利用它。

## 我能部分地做它吗？

这可以像分页一样简单，也可以是限制显示给用户的数据量，如果用户需要，就请求更多的数据。另请参见 JIT。

## 我能索引它吗？

索引是一种简化的附加数据结构，可以加速数据检索。如果您的数据库查询很慢，SQL 查询优化通常涉及添加索引。但是它可以是代码中添加的字典，用于存储加快结果速度的键。例如，如果您在地图上有一个城市图，那么可以有一个额外的城市名称字典(索引)用于检索节点。

成本是维护索引，这通常意味着增加存储需求和降低写入速度。

## 我能 JIT 吗？

JIT (just in time)意味着将数据的加载延迟到真正需要的时候。这可以是代码中某种形式的延迟加载(对象在实际使用时被初始化)，也可以是当用户向下滚动到时加载更多元素的滚动列表，如[*recycle view*](https://developer.android.com/guide/topics/ui/layout/recyclerview)*。*几乎所有的现代语言和框架都有一个延迟加载的变种，所以要深入研究一下。

## 我能预装吗？

与 JIT 相反的是预先加载一个块数据。与这里或那里的小口吃相比，长时间的停顿是否更容易忍受？例如，如果硬件是有限的，持续的加载是不可能的，如果 UI 是不可用的垃圾，那么一次长时间的等待可能是值得的。

## 我可以偷偷做吗？

闪屏。每个人都喜欢闪屏，对吗？这不是什么秘密，但是当用户做其他事情的时候在后台做一些事情可以掩盖问题。像[*背景工*](https://docs.microsoft.com/en-us/dotnet/api/system.componentmodel.backgroundworker?view=netframework-4.7.2) 之类的东西，对这个有好处。

缺点是同步——其他人需要计算的结果吗？这将不可避免地增加复杂性，并引入死锁等有趣的风险。

## 我可以同时做吗？

这个野兽也叫多线程。我可以把问题分成几个部分，这样你就可以并行解决它们，然后收集结果吗？这可能非常有效，但也很难。非常辛苦。

死锁、竞争条件、海森堡、同步问题、线程安全、测试挑战..有趣的时光。如果你还不熟悉这个，回头看看。

## 我可以增加内存/cpu 吗？

有时候应用本身并没有问题，只是耗尽了资源。如果操作系统耗尽内存并进行交换，这将是有害的。CPU 周期也是如此。如果应用程序不泄漏内存，添加内存可能是修复您的问题的最便宜的选择。如果你知道问题出在哪里，那么优化你的操作系统还有很多工作要做。

以 web 应用程序为例，您还可以将负载分散到多台计算机上，并使用负载平衡器。在云计算时代，这也可以像魔法一样扩展，你基本上什么都不用做(除了付费)。

## 我能提前猜一下吗？

减轻..视频是一个明显的例子，或者说..我指的是 CPU 架构中的分支预测。偷偷摸摸做事和试图猜测用户下一步要做什么的组合。

如果你猜错了，你就浪费了周期(或者制造了安全漏洞)。

## 我能容忍错误吗？

任何 NP 难问题的可行解决方案。如果[足够好](https://en.wikipedia.org/wiki/Travelling_salesman_problem#Computing_a_solution)的话，试图完美地解决它可能是一件愚蠢的差事，但是更快的解决方案会让你达到最优值的 2%。

对于真正的大数据集，NoSQL 数据库的最终一致性也是一个例子。保持乐观并在以后修复错误可以显著提升性能。

## 我可以优化算法吗？

在算法层面上永远不会缺少事情可做。比如看看 Java 中 [*集合*](https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html) 接口的已知子类。你记得他们所有人并且知道什么时候使用他们吗？还是你的应用程序*中的所有东西都是*数组列表*？最重要的是，如果你真的需要推动它，还有像 fastutil 这样的东西。当一个*散列表*可以工作时，看到代码不必要地一遍又一遍地做同样的事情，并在一个长列表中循环，这种情况并不少见。*

在代码层面上有很多事情要做，如果你的单元测试是可靠的，它也应该是相对安全的。再次，YMMV。

## 我可以减少请求吗？

从远程服务器获取数据很慢，与你的电脑内存相比非常慢。到数据中心的往返比到 RAM 的往返慢 100 000 倍以上。例如，如果您需要多次往返，您能否提出一个更大的批量请求？

批处理的缺点是，如果批处理模块等待更多的数据或请求大小因素，单个请求的往返时间可能会增加。YMMV。

## 我可以使用专门的文本搜索服务吗？

你的应用程序内部的文本搜索很慢吗？如果你有多余的内存，像 Lucene 这样的东西会感觉像是魔法。如果您有多余的内存，请使用它们。

## 我能把数据库分成更易管理的块吗？

又称[分片](https://en.wikipedia.org/wiki/Shard_(database_architecture))。如果您的数据库已经增长到一个巨大的规模，也许这是一个选择。它伴随着额外复杂性的警告。

## 我能压缩它吗？

我可以使用类似 [webpack](https://webpack.js.org/) 的东西来最小化我的 web 应用程序中的请求负载吗？或者在大型网络传输中使用 zip 压缩？如果你确定剩余的 JSON 开销太大，你也可以研究一下像[协议缓冲区](https://developers.google.com/protocol-buffers/)这样的东西。

## 我可以改变框架或编程语言吗？

我不知道，你能吗？会有帮助吗？除非你在 Pi 或类似的有限硬件上，否则这应该是你列表的底部。

## 我可以运行无服务器吗？

它解决了所有这些问题，所有酷孩子都这么做，所以我们也应该这么做，对吗？嗯，也许吧。我没有这方面的经验，告诉我如果你这样做它会怎么样！

# 还有什么？

有时问题更加棘手——它只在更重的负载下持续存在，更难重现，或者只在看起来与其他机器一样的被感染的机器上持续存在。或者你只是用完了显而易见的东西来优化。这种类型的东西可以变得非常专业，你可以通过聘请专家来解决这个问题来节省时间。做类似于[火焰图](http://www.brendangregg.com/flamegraphs.html)的事情可以帮助可视化疼痛区域。

无论您决定做什么，请确保您有适当的测试，您可以验证这些更改是否有效，并且不会导致倒退。这些技术中的许多真的可以极大地改变内部，即使外部没有任何变化。逐渐改变，如果可能的话，一次一个优化。

祝你好运！

![](img/8a7174442bff57ce793b546d881d3bd3.png)

(Not) My App