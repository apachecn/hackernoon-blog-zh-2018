# 与 API 优先提供商的程序化电子邮件

> 原文：<https://medium.com/hackernoon/programmatic-emails-with-api-first-providers-c8671c91fd72>

每个电子商务企业都会发送大量电子邮件。无论是营销活动的一部分，还是支付处理的一部分，几乎每一项操作或流程都是通过电子邮件完成的。然而，电子邮件服务器的配置和维护是复杂的；它实际上是一个独立的研究领域。当事情发展到紧要关头，第一批用户来到平台时，你真的不想弄清楚如何保持你的电子邮件基础设施正常运行。你显然也不想担心电子邮件的可送达性。那么，我们能做些什么呢？

![](img/051c10a53e74537c5592bf8cd67abfc9.png)

‍Photo 由[马萨耶斯·库尔曼](https://unsplash.com/photos/fb7yNPbT0l8?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)于 [Unsplash](https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)

*这是系列“* [*从零开始构建在线市场*](https://hackernoon.com/building-an-online-marketplace-from-scratch-introduction-738839e4e76) *”的第 5 部分。在本系列的这一部分中，我们将学习如何让您的平台通过 API 优先的电子邮件提供商来推送电子邮件。以及如何让您的非技术同事创建和修改电子邮件模板而不占用开发人员的时间。*

# 两种电子邮件

我们正在建立的在线市场，以及几乎所有的在线公司，都需要两种类型的电子邮件来与用户和其他利益相关者沟通:

*   营销

-内容推广和优惠

-销售电子邮件和沟通

*   事务性的

-商业收据和装运通知

-帐户更新

-密码更改

-订单状态更新

对于像 [Manufaktura](https://hackernoon.com/building-an-online-marketplace-from-scratch-introduction-738839e4e76) 这样的早期业务，第一类电子邮件适合由 [MailChimp](https://mailchimp.com/) 或 [GetResponse](https://www.getresponse.com/) 这样的产品提供的解决方案。它们提供了一种简单的方式来推广和监控通过电子邮件渠道开展的营销活动。营销电子邮件的机制对于早期阶段的创业公司来说很常见，因此，使用上面提到的产品就可以了。然而，在本文中，我们想把重点放在[事务性电子邮件](https://blog.mailchimp.com/what-is-transactional-email/)上。

交易电子邮件的类型和频率因公司和流程而异。这就是为什么我们首先需要找到一种方法来发送高度可定制的消息。此外，你很快就会知道，你还应该弄清楚如何让电子邮件模板和内容修改对营销人员和客户服务团队来说更容易理解。

这些问题的答案来自程序化的电子邮件服务提供商。让我们一步一步地探索这种方法。

# API-第一电子邮件提供商

电子邮件服务提供商(ESP)如 SendGrid、Mandrill 或 SparkPost 为您抽象出电子邮件服务器配置的魔力。它们揭示了简单 REST API 背后的电子邮件功能。您所要做的就是验证并使用调用对应的端点，如下面的代码片段所示:

使用这个工具，你可以忘记或至少推迟对相关问题的担心，例如:

*   送达率—esp 有专门的团队专门负责此事
*   报告—开箱即可获得跳出率、打开率、点击率摘要
*   批量发送—每月发送数十亿个代码，请放心，他们知道如何处理您的批量电子邮件
*   电子邮件过滤—esp 会自动停止向退回邮件、被阻止的邮箱、垃圾邮件举报人或拼写错误的电子邮件发送电子邮件
*   退订列表管理
*   自定义域设置

但是使用 ESP 的最大好处，尤其是在早期阶段，是它很便宜。你可以通过[Zapier](https://zapier.com/learn/email-marketing/best-transactional-email-sending-services/)整理的[定价摘要](https://zapier.com/learn/email-marketing/best-transactional-email-sending-services/)来了解每月不到 100 美元的情况，通常在此基础上还会提供大量免费配额。

每一个 ESP 都有它的优点和缺点，但它们通常提供相同的服务。在选择提供商时，除了免费配额，你还应该看看 SDKs 的质量、其他营销功能、UI——所有影响入职速度的因素。在平台的早期阶段，你可以很容易地更换提供商。

*在* [*优惠券*](https://www.voucherify.io/) *中，我们使用 SES 发送内部邮件，但是我们的客户可以连接他们的 Mandrill 或 SendGrid 帐户来代表他们发送优惠券邮件。*

在本教程中，我们将尝试一下 [SendGrid](https://sendgrid.com/) 。

# 发送电子邮件时要注意什么

发送电子邮件是一件简单的事情。正如你在上面看到的，它可以归结为几行代码。但是，有一些好的做法，同时也有唾手可得的成果；你可以引入一个电子邮件引擎来减少你将来的麻烦。

# 撤退

每个 SaaS/IaaS 提供商总有一天会面临问题(甚至是 AWS)。因此，连接某种形式的后备提供者是明智的。这并不难——只需观察您从主 ESP 得到的响应，如果有错误，就调用另一个 ESP。

尽管这种解决方案可以保护您免受小故障的影响，但有时您的提供商会遭遇大规模停机。在这种情况下，以一种允许快速改变 ESP 的方式来配置您的电子邮件服务是合理的。

同样值得注意的是，来自 ESP 的随机错误的后果也可以通过实现一个简单的重试策略来减少。

# 秘送

在你的电子邮件的最初几天，当流量很低，但每条信息都增加了整体客户体验时，确保电子邮件按预期发送是有意义的。将您或您的团队添加到密件抄送，以获得 99.9%的确认，所有电子邮件都顺利通过。

# 测试模式

出于测试目的，您可能不想利用您的自由配额。考虑为测试/开发模式设置不同的帐户，甚至可以是 Gmail 帐户。或者，也许你想完全跳过这封邮件。

看看这个电子邮件服务的例子。该代码是为介绍我们刚刚提到的最佳实践(回退、密件抄送、测试模式)而准备的

# 内容修改

当你刚开始时，需求还没有确定下来，假设邮件的设计和文本会被修改很多。你最好为此做好准备。

处理频繁变化的内容的第一步是开箱即用的——您只需将模板保存在单独的 HTML 文件中，并更改“options.html”参数以指向各自的路径。然后由 SendGrid 呈现 HTML 电子邮件，发送出去的代码保持不变。但是让我们向前迈进一步。

就目前而言，当营销部门想要修改一份拷贝时，他们必须征求您的意见。你不想让他们自己改，因为他们会破坏 HTML 模板。如何绕过这个问题，让营销人员或客户服务人员可以管理内容——就像他们在 MailChimp 中所做的那样？

幸运的是，我们有一个便宜且易于使用的解决方案。在 Contentful(另一个 API 优先的工具，它是一个无头的 CMS)和我们的开源[应用](https://github.com/bandraszyk/contentful-emails)的帮助下，你可以让电子邮件模板版本对撰稿人可用。它是这样工作的:

*   撰稿人在内容丰富的编辑器中创建/编辑电子邮件副本。他们以所谓的“草稿模式”完成这项工作。这只是关于文本—他们不能以任何方式修改 HTML 模板。
*   在他们实际将消息发布到产品之前，他们可以预览电子邮件的最终版本。这是通过访问 [Contentful-emails](https://github.com/bandraszyk/contentful-emails) web 应用程序实现的，该应用程序基于当前的 HTML 模板呈现 Contentful 的副本。
*   如果一切正常，副本将投入生产。
*   如果他们想更新任何副本，他们只需将状态更改为草稿并再次进行试验，同时旧版本在生产中仍然工作正常。

你可以在[这篇文章中找到这个工具的完整描述。](https://www.voucherify.io/blog/coding-free-iterating-on-email-content)

# 何时发送电子邮件

说到在线市场，有很多情况下你必须或者应该发送电子邮件。我们不能在这里列出它们，因为它太具体业务了。但是，您可以假设当订单更改状态时，一些电子邮件将 100%发送。正如您在我们之前的文章中所记得的，在 Manufaktura，订单由 Salesforce 管理。现在，在我们的[上一篇文章](https://hackernoon.com/building-an-online-marketplace-from-scratch-the-dark-side-of-salesforce-limits-6834c2d5d71e#d0e0)中，我们已经展示了每次订单状态改变时，我们都会通知(HTTP 请求)我们的外部应用程序这个事实。然后，应用程序处理此标注，这是放置电子邮件发送功能的好地方，请参见待定-开始状态更新的示例:

这种结构很容易扩展，您只需要为应用程序中的每个状态添加另一个 callout 处理程序。

# 额外收获——解决了送达率问题

我们有一个故事要分享。在我们的一个项目中，电子邮件的可送达性是重中之重。如果用户没有正确加入，业务将受到严重损害。我们用 Mandrill 写邮件。虽然它从一开始就被正确地配置了(通过 Mandrill 支持得到了确认)，但是有些用户并没有收到邀请。其实也不是他们没收到。它们落在垃圾邮件中，根本没有被投递。更糟糕的是，对于这种事件没有任何规定。时间和受影响的区域都是随机的。

我们怀疑问题的发生是因为我们使用了 Mandrill 共享邮件服务器(多个用户使用一个 IP ),这种配置可能会降低我们对垃圾邮件的评级。但这是一个非常早期的阶段，我们没有垃圾邮件。

我们决定切换到 SendGrid，但这没有帮助。作为最后的手段，我们决定在 Mandrill 中购买一个专用 IP，它非常有效。但有趣的是，Mandrill 支持团队并不鼓励这样做，因为在他们看来，这会降低我们对小批量用户的交付能力，就像我们一样。

此外，这个问题很难在第一时间发现，因为 Mandrill deliverability report 并不显示邮件是否已送达，而只显示邮件已成功发送。我们不得不在 UI 中更深入地挖掘，以找到 SMTP 事件的列表，并遍历详细信息的森林，以确定消息是否达到了目标。

# 摘要

我们的在线市场——Manufaktura——配备了强大的沟通渠道。我们根据我们在第一篇文章中提出的规则来处理这个特性——通过关注速度和可维护性。我们的软件在频繁变化的商业环境中需要的东西。

API 优先的电子邮件服务提供商允许我们只用几行代码就构建了一台电子邮件机器，Contentful-emails 应用程序帮助营销和客户服务团队在不打扰开发人员的情况下迭代内容。

现在，当我们有电子邮件工作，我们可以去付款！

*原载于*[*www . voucherify . io*](https://www.voucherify.io/blog/programmatic-emails-with-api-first-providers)*。*