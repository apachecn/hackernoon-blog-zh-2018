# 迁移到 Python 3

> 原文：<https://medium.com/hackernoon/python-3-retrospective-fa7d404ee3cd>

年初，我介绍了 [Pebble 的长期运行项目](/@scott_walton/upgrading-to-python-3-cd23b21ecea5)将我们的系统迁移到 [Python](https://hackernoon.com/tagged/python) 3。2017 年底，我们做的怎么样？

![](img/d63cb633f8f2053824a78b286fcf9aef.png)

# 背景

在 Pebble，我们基于 Python 和 [Django](https://hackernoon.com/tagged/django) 构建了我们的产品线。随着 Django 2.0 的即将发布和最大的框架取消了对 Python 2 的支持，我们决定现在是时候开始认真迁移到 Python 3 了。

为了进行迁移，我们知道我们需要一种方法来让我们自己对我们的最终目标负责。我们首先在开发团队内部召开月度会议，回顾我们上个月的行动，并制定下个月要完成的行动。

由于我们作为一个企业和开发团队的规模，我们知道我们不能停止产品[开发](https://hackernoon.com/tagged/development)只是更新我们的系统到 [Python](https://hackernoon.com/tagged/python) 3。这导致我们以更零碎的方式更新我们的系统。

# 回顾

和任何项目一样，我们经历了起起落落。有些事情进行得非常顺利，有些事情进行得不太顺利，有些事情我们根本就没有实现。

## 好人

我们最大的胜利之一是跟踪和改进我们整个系统的代码覆盖率和 lint 分数。这样做的一个主要好处是，我们现在能够将这些度量作为 KPI 来跟踪，以测量我们开发过程的整体健康状况。

![](img/62cc126a19ff4db9d677c9bbb1a42170.png)

将我们的代码库分离出来，特别是我们的[基金经理](https://www.mypebble.co.uk/software/fm/)和 [Arro](https://www.mypebble.co.uk/software/arro/) 产品，使得单独更新系统变得更加容易。我们能够在一个周末执行这种拆分，在这个周末，宕机不会影响我们的用户，对用户几乎没有任何影响。

我们的大多数系统要么现在运行 Python 3，要么将在 2018 年第一季度内更新到 Python 3。这一年中的持续工作确保了，到 2017 年 12 月底，我们只需要花几天时间完成剩余的代码库，就可以在 Python 3 中通过测试。我们的系统覆盖率达到 90%,我们对下一阶段的迁移充满信心。

我们跟踪了迁移到 Python 3 所需完成的动作列表，并在可能的情况下，将它与我们的产品路线图结合起来。这样做让我们很好地了解了什么时候事情可以完成，甚至允许我们删除那些我们预计不再需要的棘手的依赖项(即 *suds* )。我们把清单上的每一项都分配给一个人，由他来完成或监督完成。

## 坏事

我们把我们的代码库分割得比我们可能应该的要多。虽然这使得更新单个系统变得更加容易，但也使得保持每个项目的库版本更新更加耗费人力。

![](img/a33502ca20ffc8da229e6c7896c5c563.png)

我们的月度会议很好地记录了我们承诺要做的事情，但是太多的项目在太长的时间里都没有完成。我相信部分原因是因为这个列表与我们通常的产品开发路线图分开维护。

## 丑陋的

我们的一个系统仍然基于 Python 2.7，这在不久的将来不太可能改变。在接下来的 6-12 个月里，我们将在整个企业中开展工作，找出我们需要从这个系统中得到什么。使用这个，我们将能够决定我们是否维护和升级系统，或者我们是否废弃和重写代码库。

# 经验教训

这个项目非常有趣，虽然在技术上没有挑战性，但提供了一些有趣的业务关注点，新手项目经理或首席开发人员可能会被绊倒。这是一个没有直接面向客户利益的项目，但是会在将来改进你的产品开发过程。

## 高层沟通

在开始这样的项目之前，确保可能受到影响的团队大致了解你在做什么以及为什么。保持高水平，用你的听众能理解的语言。

因此，在向您的支持团队解释这一举措的好处时，以下内容不会有所帮助:

> Python 3 中出色的异常处理将使追踪 bug 变得更加容易。

相反，将这些好处更进一步，并将其与您的支持团队的目标联系起来:

> 我们将能够更快地解决客户问题，并有更大的信心。

还有，*对潜在的影响要诚实！* 更广泛的业务是为了帮助你向客户提供优秀的产品，但如果你不预先知道你认为可能会出错的事情，就无法做到这一点。根据你的公司文化，他们甚至可以提供帮助测试，他们可以提前与客户沟通，并帮助保持压力。

## 保持和维护一个列表

减缓我们开发的一个主要因素是我们单独维护这个列表。我坚信保留一份工作清单作为会议记录和成果是正确的做法。我认为我们犯的错误是没有将这些行为添加到我们的产品 backlog 中。这意味着产品经理和我之间的讨论没有在计划阶段包含这些必要的工作。

我应该做的是将所有的任务转移到我们的常规产品 backlog 中，并维护受托人。然后，我们可以在会议记录的结果部分记下票号。这样做意味着开发团队工作的常规工作列表包括了一致同意的任务，我们将有一个明确的完成迁移的终点。

这并不意味着我们抛弃会议记录结构——远非如此！为会议记录分配票据参考会使在接下来的会议上达成一致变得更加容易！

## 使用状态更新会议

当像这样做长期运行的项目时，*安排具体的状态更新会议*。将此会议放在每周或每月定期的日历事件中，并为此腾出时间。如果你试图把它推进公司的一般会议或其他会议，你会发现这个项目永远不会获得动力。

## 定期测试 Python 3

![](img/6eed5a32acf5bbeefcd6ea0c25776fd5.png)

What your system will look like the first time you test Python 3

虽然大部分语法变化都很简单，但是最大的挑战是如何处理 Python 对字符串的处理。您将会发现，只有当您开始尝试用输入测试代码路径时，它们才会失效。花时间在与更广阔的世界互动的领域上运行您的测试套件。确保您在这里运行一些集成测试！

## 将它包含在代码评审中

根据代码库的大小，这将需要一些时间。业务的其余部分可能不同意在开发团队工作时停止特性开发，所以您需要达成妥协。

在我们这边，我们将 Python 3 项目整合到我们的产品开发中。为了保持两者一致，我们同意强制使用 Python 3 的习惯用法，`six`等。作为我们代码审查过程的一部分。简而言之，审查者会查看每一个编辑过的文件，寻找`__future__`导入、`str`和`unicode`被`six.binary_type`和`six.text_type`替换，以及一系列其他更改。

事实是，当你编码时，你关注的是解决手头的任务，而不是 Python 3。通过给予审查者查看 Python 3 兼容性的许可，我们能够非常快速地升级我们最常用的代码，并更新一些我们原本不会想到要查看的区域！

# 摘要

我们表现如何？我们仍然有一个优秀的代码库，将无法达到 Python 3 的目标，但是我们的关键产品线将在二月底之前上线 Python 3。我认为我们的方法非常有效。

如果你正在升级你的代码库到 Python 3，让我知道这是否有帮助！如果你有什么自己的小技巧，请在下面分享。