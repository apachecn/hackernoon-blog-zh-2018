# 突袭:生命、死亡和复活

> 原文：<https://medium.com/hackernoon/raid-life-death-and-resurrection-bd55dfdcd321>

![](img/8f33acc04b573d13234a93941f42d7f9.png)

RAID4 array as seen by the author

这是 2010/2011 年左右发生在我身上的真实故事。

我与[网络](https://hackernoon.com/tagged/network)连接存储(NAS)的问题很早就开始了。我认为这个艰难的童年与其说是由硬件的脆弱造成的，不如说是由我的虐待狂倾向造成的。我承认，我有点乖张，绝对是个黑客。这意味着我倾向于以生产商无法预测的方式使用每一件落入我手中的设备。

开始的时候，在尝试像我一样的麻烦制造者创造的各种添加时，我射掉了我的脚。或者说是我的脸。当我卸载 system-suuplied BitTorrent 客户端时，Web 界面拒绝工作(顺便说一下，这相当卑鄙)。这实际上是制片人的错。制作人没有想到用户可能不一定需要他们无限的善良，可能会试图以自己的方式满足自己(如传输 BitTorrent 客户端)。因为我以前没有激活 SSH 访问(寓意:为了你自己好，在购买 NAS 后立即激活 SSH！)，从那时起，我与 [NAS](https://hackernoon.com/tagged/nas) 的唯一联系是通过 NFS 和使用传输(它不与网络接口集成，在不同的端口上工作)。

因为它对于听音乐来说已经足够了(UPnP 服务器工作得很好，没有大惊小怪)，所以我没有费心去修复它。“会有时间的”，我想。

# 保护好你自己，我的孩子

值得一提的是，我拥有的 NAS 在备份解决方案方面非常丰富。从最简单的(当你按下“备份”按钮时，复制到任何连接到插座的 USB 设备)到更邪恶的(由`cron`控制的`rsync`)。

令我苦恼的是，时间的缺乏(这将在本笔记中再次提到)是我在破坏网络界面之前没有设法激活这些解决方案的原因。

**真正的问题**开始的比较晚，和停电有关。我的阵列中有 4x500GB 的驱动器，生产商称之为 X-RAID，它或多或少相当于 [RAID 4](https://en.wikipedia.org/wiki/Standard_RAID_levels#RAID_4) 。前提是一个驱动器的故障不会导致数据丢失，也不会干扰系统的工作。因此，根据[墨菲定律](https://en.wikipedia.org/wiki/Murphy%27s_law)，其中两个驱动器出现故障。经历了这样的打击后，NAS 无法回心转意。我试图启动它，结果是“引导”信息在苍白的显示屏上永远持续着。坦率地说，展示是绿色的，但绿色无法展现出场景的全部悲怆。

# 报数

我没有想太多(有时我觉得自己根本没想太多)，就决定检查驱动器。第一个观察结果:

*   HD1: `fdisk`显示分区表，ext2 分区正在安装
*   HD2: `fdisk`保持沉默
*   HD3:与 HD1 相同
*   HD4:燃烧的地狱

当我把 HD4 连接到我的电脑上进行检查时，BIOS 开始对我大喊大叫。 [S.M.A.R.T](https://en.wikipedia.org/wiki/S.M.A.R.T.) 有些类似。HD4 真的很生气。最终，我诊断为电子故障，并将其放在旁边标有“以后/可能”标签的盒子里。

在任何恢复数据的尝试中，拥有两个正常工作和两个故障驱动器都不是一个好的起点。

我挠了挠头。我还记得，当时我连续几个月挠头。最后，我得出结论，也许 HD2 并不像看上去那么糟糕。也许这只是模拟疾病来逃避工作？

![](img/3e8358c8b16124664ba2e92e76f510f4.png)

“bunch of fruits in buckets on black wheelbarrow” by [Kelly Neil](https://unsplash.com/@baconandbaileys?utm_source=medium&utm_medium=referral) on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)

# 用独轮车移动钻头

为了避免事情变得更加复杂，我决定购买一个额外的驱动器，并对图像进行所有操作。对于我的数据来说，硬盘上的任何错误都将是永久的死亡。我买了 2TB 的硬盘，把我最喜欢的工具之一拿在手里(`dd`)，然后开始铲土。我的工作假设是 HD2 的分区表被破坏了。

因为出现故障的 NAS 以相同的方式格式化了每个驱动器(系统分区、交换分区，然后是 [LVM](https://en.wikipedia.org/wiki/Logical_Volume_Manager_(Linux)) )，所以我比较了 HD1 和 HD3 的分区表，然后将其中一个复制到了 HD2。使用`losetup`，我用 HD2 安装了系统分区——一切看起来都绝对一流。我的心里充满了喜悦！我不耐烦地等待着能够激活 LVM 音量并重新获得数据。

# (非)预期的图扭曲

然而，命运可能是邪恶的，结果发现其中一卷物理卷找不到了。我注意到了它的 UUID，沮丧地思考着下一步该怎么办。由于缺乏更好的想法，我开始看我认为是一个单独的 PV。

在 HD1 上，一切看起来像一个经典的 LVM 磨合，同样在 HD3 上。但是 HD2 呈现了预期数据和一些随机混乱的怪异混搭(乍一看)。UUID 的领域特别奇怪。这是否意味着不仅仅是分区表受到了影响？

尽管遇到了挫折，我还是继续深入调查。为什么有些数据是正确的，而有些看起来是伪造的？启蒙运动来得很突然，我现在记不起是什么导致了它。当我回头看的时候，我发现我是多么的愚蠢。那时我认为我是地球上最聪明的人！

# 来吧，我的孩子，我来教你！

我检查了整个情况。我在思想上回到了从一开始就是我行为的催化剂这一点:RAID 4 通过记录[异或](https://en.wikipedia.org/wiki/Exclusive_or)运算的数据来保护其中一个驱动器免于故障，从而允许重建原始数据。这不是很明显吗？

没有太多思考(你打赌！)我用 c 写了一个概念验证，它所做的只是从三个映像中的每一个读取前 4kB，并在屏幕上显示异或数据。这样我找到了失踪的 UUID。还有，安心！现在，所有需要做的就是使程序更加通用。这样我就可以把结果写到第四张图片上，然后继续处理`losetup`、`vgchange -ay`，我们又可以回家了！

# 没那么快！

因为我的数学一直很差，所以我没想到把 4 张 500GB 的图片放在一张总容量为 2TB 的格式化光盘上会有问题。尤其是已经有一些其他数据的情况下。我最初的热情下降了，我开始考虑就地解决方案(与此同时，驱动器价格飙升，因此购买另一个是不可能的)。

第一个绝妙的想法是编写一个内核驱动程序，它将呈现一个块设备，返回 XOR 格式提供的文件。我甚至开始阅读 [Linux 驱动程序 HOWTO](https://www.linuxjournal.com/article/4786) ，尽管这看起来像是用大炮打一只苍蝇。最终，使用 [FUSE](https://en.wikipedia.org/wiki/Filesystem_in_Userspace) 用 Python 编写文件系统的想法获得了胜利。这相对容易，几分钟后我就检查了它是如何工作的。当`losetup`哭诉它没有权限把我的假文件呈现为屏蔽设备时，我的心又沉了下去。

在这种情况下，我倾向于向朋友寻求建议。幸运的是，其中一个名为 [strace](https://en.wikipedia.org/wiki/Strace) 的人给我指出了问题所在。FUSE 不允许一个用户访问另一个用户挂载的文件系统。因为`losetup`需要超级用户权限，而我是以普通用户的身份挂载我的文件系统，这变成了一个障碍。

# 哦，快乐的一天！卡洛奥。Callay！

`losetup`、`vgchange`、`fuseext2`还有……我的全部音乐收藏(几个月的翻录 CD)安然无恙，欢快地向我招手。有很多欢乐！

# 验尸

我相信你可能不会发现自己处于和我相似的位置。这是一个特别糟糕的巧合，电源故障、硬盘损坏和高昂的替换价格。但是，从这次经历中可以吸取一些教训。

即使您在相对较高的级别上操作(如文件系统和 FUSE ),了解抽象级别之外的情况也是很好的。对我来说，是`hexdump`和`strace`帮助我在形势严峻时重获宪法。

无论你做什么，类似的问题都可能出现，大约在我为我的 NAS 苦苦挣扎的同时，Twitter 也面临着与扩展相关的问题。尽管他们的软件是用 Ruby 编写的，他们还是求助于使用 DTrace 的[来超越表象。所有这些花哨的框架确实节省了开发时间，但是当事情变得糟糕时，你可能会弄脏自己。](http://dtrace.org/resources/ahl/dtrace_ruby_oscon_2007.pdf)