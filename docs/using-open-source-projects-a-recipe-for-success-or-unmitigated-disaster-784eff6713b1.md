# 使用开源项目:成功的秘诀，还是彻底的灾难

> 原文：<https://medium.com/hackernoon/using-open-source-projects-a-recipe-for-success-or-unmitigated-disaster-784eff6713b1>

选择正确的开源项目就像玩扫雷游戏一样——走错一步，就会爆炸！你的系统失灵了。

![](img/ab65cefa9467349b8fd9612a7e848c12.png)

在软件开发领域有一个流行的原则——DRY，也就是不要重复自己。开源项目的主要目的是共享，以避免每个人在可以制造引擎的时候制造轮子。对于一个像互联网和信息技术这样快节奏的行业来说，速度就是一切。开源资源节省了人力和时间，同时加快了业务发展的步伐。有什么不喜欢的？

然而，现实并不总是那么美好。基于开源的项目会带来一系列问题，比如停机或数据丢失。在某些情况下，各种各样的开源项目真的让人头疼。应该选择 MySQL 还是 PostgreSQL？Memcached 还是 Redis？有棱角还是有反应？

以下是我根据与 UC 浏览器团队合作和开发开源项目的经验得出的一些想法、观察和个人经验。

# **选拔阶段**

## **根据业务需求选择项目**

因为许多开源选项往往是相似的(但同时又如此不同！)，我们在做选择时总是面临两难的境地。为了简化流程并确保选择适合最终目的，我们选择更加关注它如何满足平台需求，而不是什么是最好的。

在开发一个社交平台的过程中，我们发现了一个名为 TT (Tokyo 暴君)的开源解决方案，它是带有缓存的 Memcache 和带有持久存储的 MySQL 的完美替代品。我们认为这是一个很棒的解决方案，并广泛使用它——后来才意识到它不能完全取代 MySQL，而且它看似神奇的功能有很多缺陷，需要很长时间才能熟悉。

如果业务需要 1,000 TPS，那么 20,000 TPS 的解决方案和 50000 TPS 的解决方案实际上没有什么区别。系统架构可以在未来重新构建，以获得更高的 TPS 数，但是 UNIX 编程哲学规定，过早的优化是万恶之源。

## **评估项目成熟度**

新的开源项目通常会声称在性能、功能和新特性方面比以前的项目好得多。尽管它们很诱人，但它们都会携带病毒。编程天赋并不能保证一个项目的第一个版本是完美的。从事 Windows、Linux 和 MySQL 工作的开发人员是业内最优秀的，但他们仍然为他们的项目发布更新和错误修复。年轻的开源项目在应用于生产环境时会引入新的风险，其中最不严重的是系统停机(已经相当严重了)，最坏的情况是不可逆的数据丢失(完全是一场噩梦)。

当我们使用 TT 时，发生了电源故障，导致文件损坏，无法通过重新启动系统来恢复。幸运的是，我们的日常备份实践挽救了这一天，但我们仍然丢失了停电当天的数据。紧接着，我们花了很多时间检查源代码，并通过自己编写新工具来恢复数据。谢天谢地，这些数据本质上不是金融数据；否则我们就有大麻烦了。

那么，如何检验开源项目是否成熟呢？查找以下内容:

1.**版本号**

除非完全必要，否则尽量避免使用版本 0 的项目。取而代之的是一个至少有 1。x 版出。更高的数字总是更安全的赌注。

2.**使用该项目的公司数量**

开源项目通常会在项目主页上列出使用它们的公司。寻找任何使用该项目的大公司，以及总数。

3.**社区参与度**

查看使用该项目的社区是否活跃、帖子数量、回复、问题回复时间。

## **别忘了操作和维护能力**

当我们选择一个开源项目时，我们通常更关注性能和可靠性等技术指标，而不是它促进操作和维护的能力。然而，操作和维护是将任何解决方案应用到在线生产环境中不可或缺的一部分。如果没有这一点，任何涉及故障排除的实例都可能陷入孤注一掷的境地。

您可以通过研究以下方面来检查项目的运营和维护能力:

1.**开源解决方案的日志是否完整**:一些开源解决方案的日志文件非常简短，只有几行开始和停止的内容。这使得在出现问题时很难调查和解决问题。

2.**开源解决方案是否有维护工具**:命令行和管理控制台帮助查看系统运行情况

3.**开源解决方案是否具有实时检测能力**:这包括故障检测和恢复、告警、切换等。

![](img/601b791ceea663934ac53d9a175c07b1.png)

# **活跃使用阶段**

## **深入学习，精心测试**

许多人在观看了一些演示后，简单地复制和粘贴开放源代码，并将其部署到在线应用程序中。这肯定会危及主系统的健康及其可靠性，就像翻阅完驾驶手册后开车一样。

我想起了一些轶事。有一次，团队中的一个人突发奇想决定使用 elasticsearch，而没有完全弄清楚倒排索引并保留默认配置值。他们在第一次运行时就将其投入使用，并意识到节点 ping 时间太长，异常节点的消除太慢。结果呢？整个网站瘫痪了。

还有一次，很多团队没有充分研究就开始使用 MySQL。业务部门最终抱怨 MySQL 运行太慢。罪魁祸首？最关键的参数(如 innodb_buffer_pool_size、sync_binlog、innodb_log_file_size)要么配置错误，要么根本没有配置，从而导致性能低下。

研究和测试项目时:

1.通过通读设计文档和可用的白皮书，旨在充分理解项目的原则

2.检查每个配置的作用和影响，并确定关键的配置项目

3.针对多个场景进行性能测试

4.在您连续运行项目几天的情况下进行压力测试。观察 CPU、内存、磁盘 IO 和其他指示器的波动。

5.进行故障测试:关机、断电、重启、切换等。

## **小心涂抹，分阶段释放**

一旦研究和测试的第一阶段过去，所有的问题都解决了，我们能简单地向前推进吗？没那么快，海岸还没有清理。即使进行深入研究和多重测试，人们也必须保持谨慎，因为这些只能降低风险，而不能消除风险。

当我们使用 TT 时，我们实际上安排了一位专家来查看代码，并在执行之前进行一些测试。尽管这花了整整一个月的时间，我们在上线后仍然经历了许多问题。在线生产环境是一头复杂的野兽，最好谨慎对待。根据我们的经验，最好的方法是将项目用于次要业务，而不是核心业务，然后逐步推广到更重要的部分。

## 期待最好的结果，做最坏的打算

即使一切似乎进展顺利，也还不到高枕无忧的时候，尤其是在开始使用一个新的开源项目之后。如果运气必须把它的脸转过去，一个人可能会遇到一个无法修复的错误，或者更糟，一个世界上任何人都没有遇到过的错误。这种情况会对业务造成致命的打击，尤其是在涉及存储故障的情况下。

一些同事认识的一家企业有过使用 MongoDB 的惨痛经历。当机器停机时，他们丢失了一部分关键数据，他们试图恢复这些数据，但无济于事。更糟糕的是，他们没有后援。这个故事在我们自己的办公室里传播得很快，从那以后，O&M 团队反对使用 MongoDB 的每一个提议，即使是用于试验。

虽然仅仅因为这一点而完全反对一个项目可能有点极端，但这个故事仍然是一个警钟:当对重要的业务或数据使用开源项目时，明智的做法是保留一个更成熟的解决方案作为备份，而不是在出现问题时手足无措。例如，如果主要使用 Redis，他们可以使用 MySQL 进行存储备份。尽管这会增加成本和复杂性，但这是防范失败风险的必要手段。

# **修改和二次开发阶段**

## **尽可能保持纯净**

当我们发现一个开源项目的某些方面不能满足我们的需求时，我们很自然地会感到必须做出改变。如何着手进行这些变革是主要的挑战。

一种方法是分配几个人以适合特定业务需求的方式彻底改造项目，但是这并不理想，原因有两个。首先，这样的投资成本太高。与 Redis 同等规模的开源解决方案至少需要两个人花四周的时间才能完全修改。其次，做太多的修改会抹杀跟随和合并开源项目的进化版本的能力。

这使得开发监控和负载平衡等辅助系统更加可行。例如，如果我们想在 Redis 中添加一个集群函数，不需要改变它的实现。相反，增加一个代理层可以帮助达到同样的目的(Twitter 的 [Twemproxy](http://www.cnblogs.com/gomysql/p/4413922.html) 遵循同样的原则)。自从 Redis 开始用 3.0 版提供集群，我们所要做的就是从最初的解决方案切换到 Redis 3.0。

但是如果你真的想改变开源系统呢？你可以直接向开发人员提出一个需求或者报告一个 bug，但是他们不能保证快速的响应时间。所采用的方法确实取决于手头事情的紧急程度；对于不太紧急的情况，最好安排备份和应急措施。

## **把一切都扔出窗外，创造你想要的轮子**

不管我们是否选择开源项目，成本和收益之间的主要权衡仍然存在。有时候使用开源项目可能不是最好的方法。

软件和硬件领域之间最显著的区别是，当涉及到软件时，绝对没有结论性的行业标准——每个人都喜欢以自己喜欢的方式创建软件的过程。在硬件上，制造一个无法应用于车辆的独特尺寸的车轮，无论技术或产品质量有多好，都是一种资源浪费；这不是软件的限制，在软件中，任何创造出来的东西都仍然有用，组合也没有严格的定义。此外，对于大规模的应用程序，开源项目通常采用通用的处理解决方案。

然而，由于业务类型的差异，通用解决方案可能不适合一刀切的应用。例如，Memcached 通过一致性哈希提供集群，但是对于我们的一些业务来说，缓存崩溃会减慢整个业务的速度。这需要一个 Memcached 中没有的缓存备份功能。与此同时，当 Redis 没有集群时，我们指派了一个由大约两到四个人组成的团队，花了两个多月的时间来开发一套支持存储、备份和集群的缓存框架。基于这个框架，我们增加了跨数据中心同步，极大地提高了我们平台的可用性。

使用开源解决方案并依赖它们来实现特定的需求可能会非常耗时或者完全没有用。因此，如果现金流、人才库和时间允许，投资创建完全适合您的平台或服务的解决方案并不是一个糟糕的选择。毕竟，所有称职的科技公司都是这样做的——如果没有他们，我们一开始就不会有这么多好的开源项目。

(Original article by Li Yunhua 李运华)

# 阿里巴巴科技

关于阿里巴巴最新技术的第一手深度资讯→搜索 [**【阿里巴巴科技】**](http://www.facebook.com/AlibabaTechnology) 上**脸书**